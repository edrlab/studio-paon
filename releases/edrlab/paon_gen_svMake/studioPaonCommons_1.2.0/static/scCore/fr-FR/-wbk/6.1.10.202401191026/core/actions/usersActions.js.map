{"version":3,"sources":["/@back@/core/actions/usersActions.tsx"],"names":["EUserAspects","EUserType","USER","Action","POPUP","ERROR","MsgOver","USERSELF","UsersAction","[object Object]","this","mode","ctx","reg","users","find","user","isReadOnly","length","super","isVisible","CreateUserAction","userType","id","_icon","_label","_description","_enablePerms","_group","ev","UserCreate","GroupCreate","import","showDialog","initialize","env","uiRoot","titleBar","barLabel","label","fixSize","resizer","onNextClose","uiAnchor","SINGLETON_user","SINGLETON_group","group","DeleteUsersAction","setIcon","requireEnabledPerm","_a","account","universe","auth","currentUser","isEnabled","adminUsersSrv","adminUsers","msg","userName","getPrimaryName","usersCount","confirm","okLbl","cancelLbl","errorsArray","Map","accounts","forEach","set","push","dropUsers","dropGroups","size","errorsCount","usersList","Array","from","keys","join","show","Error","values","e","report","DisableUsersAction","userAction","isDisabled","undefined","hasAspect","updatable","userSelf","setCustomMsg","showMsgOver","window","document","body","waitFor","Promise","async","resolve","refuse","params","countUsers","ii","posUser","userParams","Object","assign","resp","updateUser","updateGroup","errorStr","tcheckUserSelfRespError","savedProps","getUser","SINGLETON_user_enable","SINGLETON_user_disable","SINGLETON_group_enable","SINGLETON_group_disable"],"mappings":"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","sourcesContent":["import {IRegPointer, IUiEnv} from \"lib/commons/registry\";\nimport {JSX} from \"lib/commons/xml/dom\";\nimport \"back/core/dialogs/dialogs_Perms\";\nimport {ICoreUniverseEnv} from \"lib/core/universe\";\nimport {EUserAspects, EUserType, JUser, USER} from \"lib/core/user\";\nimport {Action} from \"lib/commons/actions\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport \"back/core/actions/actions_Perms\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {MsgOver} from \"back/commons/basis\";\nimport {USERSELF} from \"lib/core/userSelf\";\n\n\n/**\n * Contexte des actions associées à un user / plusieurs\n */\nexport interface IUsersActionCtx extends IRegPointer<ICoreUniverseEnv> {\n\tusers?: JUser[],\n}\n\nexport interface IUsersActionUiCtx {\n\tuiAnchor?: Element\n}\n\n\nexport abstract class UsersAction<E extends IUsersActionCtx = IUsersActionCtx> extends Action<E> {\n\tprotected mode: 'mono' | 'multi' = 'multi';\n\n\tsetMode(mode: 'mono' | 'multi') {\n\t\tthis.mode = mode;\n\t}\n\n\tisVisible(ctx: E): boolean {\n\t\tif (!ctx.reg) return false;\n\t\tif (!ctx.users) return false;\n\t\tif (this.mode === \"multi\" && !ctx.users.find(user => !user.isReadOnly)) return false;\n\t\tif (this.mode === \"mono\" && ctx.users.length !== 1) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n}\n\n/** Création d'un utilisateur / groupe */\nexport class CreateUserAction<E extends IRegPointer<ICoreUniverseEnv & IUiEnv> & IUsersActionUiCtx> extends Action<E> {\n\tstatic SINGLETON_user = new CreateUserAction(EUserType.user);\n\tstatic SINGLETON_group = new CreateUserAction(EUserType.group);\n\n\tconstructor(public userType: EUserType, id?: string) {\n\t\tsuper(id || \"createUserAction\" + userType);\n\t\tif (this.userType === EUserType.user) {\n\t\t\tthis._icon = \"/@skin@/core/actions/users/add-user.svg\";\n\t\t\tthis._label = \"Ajouter un utilisateur\";\n\t\t\tthis._description = \"Ajout d'un utilisateur\";\n\t\t\tthis._enablePerms = \"action.users#create.user\";\n\t\t} else {\n\t\t\tthis._icon = \"/@skin@/core/actions/users/add-user-group.svg\";\n\t\t\tthis._label = \"Ajouter un groupe\";\n\t\t\tthis._description = \"Ajout d'un groupe\";\n\t\t\tthis._enablePerms = \"action.users#create.group\";\n\t\t}\n\t\tthis._group = \"addRemove\";\n\t}\n\n\tasync execute(ctx: E, ev?: Event): Promise<JUser | null> {\n\t\tconst {UserCreate, GroupCreate} = await import(\"back/core/dialogs/userCreate.js\");\n\t\treturn (this.userType === EUserType.user) ?\n\t\t\tPOPUP.showDialog(new UserCreate().initialize(ctx), ctx.reg.env.uiRoot, {titleBar: {barLabel: {label: \"Nouvel utilisateur\"}}, fixSize: false, resizer: {}}).onNextClose() :\n\t\t\tPOPUP.showDialog(new GroupCreate().initialize(ctx), ctx.uiAnchor || ctx.reg.env.uiRoot, {titleBar: {barLabel: {label: \"Nouveau groupe\"}}, fixSize: false, resizer: {}}).onNextClose();\n\t}\n}\n\n\n/** Suppression d'un / plusieurs utilisateurs/groupes */\nexport class DeleteUsersAction<E extends IUsersActionCtx> extends UsersAction<E> {\n\tstatic SINGLETON_user = new DeleteUsersAction(EUserType.user);\n\tstatic SINGLETON_group = new DeleteUsersAction(EUserType.group);\n\n\tconstructor(public userType: EUserType, id?: string) {\n\t\tsuper(id || \"deleteUsersAction\" + userType);\n\t\tthis._label = (ctx) => {\n\t\t\tif (ctx.users && ctx.users.length > 1) return this.userType === EUserType.group ? \"Supprimer les groupes\" : \"Supprimer les utilisateurs\";\n\t\t\telse return this.userType === EUserType.group ? \"Supprimer le groupe\" : \"Supprimer l'utilisateur\";\n\t\t};\n\t\tthis._description = (ctx) => {\n\t\t\tif (ctx.users && ctx.users.length > 1) return this.userType === EUserType.group ? \"Suppression des groupes\" : \"Suppression des utilisateurs\";\n\t\t\telse return this.userType === EUserType.group ? \"Suppression de groupe\" : \"Suppression d'utilisateur\";\n\t\t};\n\t\tthis._group = \"addRemove\";\n\t\tthis.setIcon(\"/@skin@/commons/icons/delete.svg\");\n\t\tthis.requireEnabledPerm(this.userType === EUserType.user ? \"action.users#drop.user\" : \"action.users#drop.group\");\n\t}\n\n\tisEnabled(ctx: E): boolean {\n\t\t// pas de supp du user courant\n\t\tif (ctx.users?.find(user => user.account === ctx.reg.env.universe.auth.currentUser.account)) return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\tasync execute(ctx: E, ev?: Event): Promise<boolean> {\n\t\tconst reg = ctx.reg;\n\t\tconst adminUsersSrv = ctx.reg.env.universe.adminUsers;\n\n\t\tlet msg;\n\t\tif (ctx.users.length === 1 && ctx.users[0].userType === EUserType.user) {\n\t\t\tconst userName = USER.getPrimaryName(ctx.users[0]);\n\t\t\tmsg = `Voulez-vous vraiment supprimer le compte de l'utilisateur '${userName}' ?`;\n\t\t} else if (ctx.users.length === 1 && ctx.users[0].userType === EUserType.group) {\n\t\t\tconst userName = USER.getPrimaryName(ctx.users[0]);\n\t\t\tmsg = `Voulez-vous vraiment supprimer le groupe '${userName}' ?`;\n\t\t} else if (this.userType === EUserType.group) {\n\t\t\tconst usersCount = ctx.users.length;\n\t\t\tmsg = `Voulez-vous vraiment supprimer les '${usersCount}' groupes ?`;\n\t\t} else {\n\t\t\tconst usersCount = ctx.users.length;\n\t\t\tmsg = `Voulez-vous vraiment supprimer les comptes des '${usersCount}' utilisateurs ?`;\n\t\t}\n\n\t\tif (await POPUP.confirm(msg, null, {okLbl: \"Supprimer\", cancelLbl: \"Annuler\"})) {\n\t\t\ttry {\n\t\t\t\tlet errorsArray: Map<String, String> = new Map();\n\t\t\t\tlet accounts: string[] = [];\n\t\t\t\tctx.users.forEach((user) => {\n\t\t\t\t\tif (user.account == ctx.reg.env.universe.auth.currentUser.account)\n\t\t\t\t\t\terrorsArray.set(user.account, \"Suppression interdite du compte courant.\")\n\t\t\t\t\telse\n\t\t\t\t\t\taccounts.push(user.account)\n\t\t\t\t});\n\t\t\t\tif (this.userType === EUserType.user)\n\t\t\t\t\tawait adminUsersSrv.dropUsers(accounts);\n\t\t\t\telse\n\t\t\t\t\tawait adminUsersSrv.dropGroups(accounts);\n\t\t\t\tif (errorsArray.size > 0) {\n\t\t\t\t\tlet errorsCount = errorsArray.size;\n\t\t\t\t\tlet usersList = Array.from(errorsArray.keys()).join(\", \");\n\t\t\t\t\tawait ERROR.show(errorsCount == 1 ? `Un compte n'a pas pu être supprimé : ${usersList}.` : `${errorsCount} comptes n'ont pas pu être supprimés : ${usersList}.`, new Error(Array.from(errorsArray.values()).join(\"\\n\\n\")));\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t} catch (e) {\n\t\t\t\tawait ERROR.report(`La suppression des comptes n'a pas pu aboutir. Veuillez réessayer ultérieurement.`, e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n}\n\n/** Désactivation d'un / plusieurs utilisateurs/groupes */\nexport class DisableUsersAction<E extends IUsersActionCtx> extends UsersAction<E> {\n\tstatic SINGLETON_user_enable = new DisableUsersAction(EUserType.user, \"enable\");\n\tstatic SINGLETON_user_disable = new DisableUsersAction(EUserType.user, \"disable\");\n\tstatic SINGLETON_group_enable = new DisableUsersAction(EUserType.group, \"enable\");\n\tstatic SINGLETON_group_disable = new DisableUsersAction(EUserType.group, \"disable\");\n\n\tconstructor(public userType: EUserType, public userAction: \"enable\" | \"disable\", id?: string) {\n\t\tsuper(id || \"disableUsersAction_\" + userType + \"_\" + userAction);\n\t\tthis._label = (ctx) => {\n\t\t\tif (this.userAction == \"disable\") {\n\t\t\t\tif (ctx.users && ctx.users.length > 1) return this.userType === EUserType.group ? \"Désactiver les groupes\" : \"Désactiver les utilisateurs\";\n\t\t\t\telse return this.userType === EUserType.group ? \"Désactiver le groupe\" : \"Désactiver l'utilisateur\";\n\t\t\t} else {\n\t\t\t\tif (ctx.users && ctx.users.length > 1) return this.userType === EUserType.group ? \"Réactiver les groupes\" : \"Réactiver les utilisateurs\";\n\t\t\t\telse return this.userType === EUserType.group ? \"Réactiver le groupe\" : \"Réactiver l'utilisateur\";\n\t\t\t}\n\t\t};\n\t\tthis._description = (ctx) => {\n\t\t\tif (this.userAction == \"disable\") {\n\t\t\t\tif (ctx.users && ctx.users.length > 1) return this.userType === EUserType.group ? \"Désactivation des groupes\" : \"Désactivation des utilisateurs\";\n\t\t\t\telse return this.userType === EUserType.group ? \"Désactivation de groupe\" : \"Désactivation d'utilisateur\";\n\t\t\t} else {\n\t\t\t\tif (ctx.users && ctx.users.length > 1) return this.userType === EUserType.group ? \"Réactivation des groupes\" : \"Réactivation des utilisateurs\";\n\t\t\t\telse return this.userType === EUserType.group ? \"Réactivation de groupe\" : \"Réactivation d'utilisateur\";\n\t\t\t}\n\t\t};\n\t\tthis._group = \"props\";\n\t\tthis.setIcon(this.userAction == \"disable\" ? \"/@skin@/core/objects/user/disabled.svg\" : \"/@skin@/core/objects/user/enabled.svg\");\n\t\tthis.requireEnabledPerm(this.userType === EUserType.user ? \"action.users#update.user\" : \"action.users#update.group\");\n\t}\n\n\tisVisible(ctx: E): boolean {\n\t\tconst adminUsersSrv = ctx.reg.env.universe.adminUsers;\n\t\tif (ctx.users && !ctx.users.find((user) => user.isDisabled == (this.userAction === \"enable\" ? true : undefined))) return false;\n\t\tif (!adminUsersSrv.hasAspect(EUserAspects.updatable)) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tisEnabled(ctx: E): boolean {\n\t\tif (ctx.users && ctx.users.length == 1 && ctx.users[0].account == ctx.reg.env.universe.auth.currentUser.account) return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\tasync execute(ctx: E, ev?: Event): Promise<boolean> {\n\t\tconst reg = ctx.reg;\n\t\tconst adminUsersSrv = ctx.reg.env.universe.adminUsers;\n\t\tconst userSelf = ctx.reg.env.universe.userSelf;\n\t\tlet msg;\n\t\tif (ctx.users.length === 1 && ctx.users[0].userType === EUserType.user) {\n\t\t\tconst userName = USER.getPrimaryName(ctx.users[0]);\n\t\t\tmsg = this.userAction == \"disable\" ?\n\t\t\t\t`Voulez-vous vraiment désactiver l'utilisateur '${userName}' ?` :\n\t\t\t\t`Voulez-vous vraiment réactiver l'utilisateur '${userName} ?`;\n\t\t} else if (ctx.users.length === 1 && ctx.users[0].userType === EUserType.group) {\n\t\t\tconst userName = USER.getPrimaryName(ctx.users[0]);\n\t\t\tmsg = this.userAction == \"disable\" ?\n\t\t\t\t`Voulez-vous vraiment désactiver le groupe '${userName}' ?` :\n\t\t\t\t`Voulez-vous vraiment réactiver le groupe '${userName}' ?`;\n\t\t} else if (this.userType === EUserType.group) {\n\t\t\tconst usersCount = ctx.users.length;\n\t\t\tmsg = this.userAction == \"disable\" ?\n\t\t\t\t`Voulez-vous vraiment désactiver les '${usersCount}' groupes ?` :\n\t\t\t\t`Voulez-vous vraiment réactiver les '${usersCount}' groupes ?`;\n\t\t} else {\n\t\t\tconst usersCount = ctx.users.length;\n\t\t\tmsg = this.userAction == \"disable\" ?\n\t\t\t\t`Voulez-vous vraiment désactiver les comptes des '${usersCount}' utilisateurs ?` :\n\t\t\t\t`Voulez-vous vraiment réactiver les comptes des '${usersCount}' utilisateurs ?`;\n\t\t}\n\n\t\tif (await POPUP.confirm(msg, null, {okLbl: this.userAction == \"disable\" ? \"Désactiver\" : \"Réactiver\", cancelLbl: \"Annuler\"})) {\n\t\t\ttry {\n\t\t\t\t//ctx.users\n\t\t\t\tlet msg = new MsgOver();\n\t\t\t\treturn msg.setCustomMsg(\"Veuillez patienter...\", \"info\").showMsgOver(window.document.body).waitFor(\n\t\t\t\t\tnew Promise(async (resolve, refuse) => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst params = {isDisabled: this.userAction == \"disable\" ? true : false};\n\t\t\t\t\t\t\tif (ctx.users && ctx.users.length > 0) {\n\t\t\t\t\t\t\t\tlet countUsers = ctx.users.length;\n\t\t\t\t\t\t\t\tlet errorsArray: Map<String, String> = new Map();\n\t\t\t\t\t\t\t\tfor (let ii = 0; ii < countUsers; ii++) {\n\t\t\t\t\t\t\t\t\tlet user = ctx.users[ii];\n\t\t\t\t\t\t\t\t\tlet posUser = ii + 1;\n\t\t\t\t\t\t\t\t\tif (ctx.users.length > 1)\n\t\t\t\t\t\t\t\t\t\tmsg.setCustomMsg(`Enregistrements en cours. Utilisateur ${posUser} sur ${countUsers}...`);\n\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\tmsg.setCustomMsg(`Enregistrements en cours...`);\n\n\t\t\t\t\t\t\t\t\tif (user.account == ctx.reg.env.universe.auth.currentUser.account) {\n\t\t\t\t\t\t\t\t\t\terrorsArray.set(user.account, \"Activation/désactivation du compte courant interdite.\");\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tlet userParams: JUser = Object.assign({}, params);\n\t\t\t\t\t\t\t\t\t\tuserParams.account = user.account;\n\t\t\t\t\t\t\t\t\t\tconst resp = this.userType === EUserType.user ?\n\t\t\t\t\t\t\t\t\t\t\tawait userSelf.updateUser(userParams) :\n\t\t\t\t\t\t\t\t\t\t\tawait userSelf.updateGroup(userParams);\n\t\t\t\t\t\t\t\t\t\tlet errorStr = USERSELF.tcheckUserSelfRespError(resp, \"\");\n\t\t\t\t\t\t\t\t\t\tif (errorStr === null) {\n\t\t\t\t\t\t\t\t\t\t\tlet savedProps = await adminUsersSrv.getUser(user.account);\n\t\t\t\t\t\t\t\t\t\t} else\n\t\t\t\t\t\t\t\t\t\t\terrorsArray.set(user.account, errorStr);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (errorsArray.size == 0) {\n\t\t\t\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tlet errorsCount = errorsArray.size;\n\t\t\t\t\t\t\t\t\tlet usersList = Array.from(errorsArray.keys()).join(\", \");\n\t\t\t\t\t\t\t\t\trefuse(ERROR.show(errorsCount == 1 ? `Un utilisateur n'a pas pu être actualisé : ${usersList}.` : `${errorsCount} utilisateurs n'ont pas pu être actualisés : ${usersList}.`, new Error(Array.from(errorsArray.values()).join(\"\\n\\n\"))));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\trefuse(ERROR.report(`L'enregistrement a échoué. Veuillez réessayer ultérieurement.`, e));\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t)\n\t\t\t} catch (e) {\n\t\t\t\tawait ERROR.report(`La modification des utilisateurs/groupes n'a pas pu aboutir. Veuillez réessayer ultérieurement.`, e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n}"]}