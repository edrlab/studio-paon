{"version":3,"sources":["/@back@/wsp/views/itemMain.tsx"],"names":["BaseElement","BaseElementAsync","BASIS","isEltInitableAsyncPending","Tabs","ItemXmlEd","InfoBrokerBasic","REG","SEC","VIEWS","DOM","JSX","DOMSH","SRC","WSP","loadFreeLib","Area","isArea","SimpleTagArea","InfoFocusItem","InfoFocusNodeInItem","ITEM","XA","WEDLET","EventMgr","ACTION","Action","ActionMenu","ActionBtn","Button","ExportScar","MoveToSrc","PasteContent","ReloadSrc","RenameSrc","ERROR","ItemMsgSs","Resizer","TASK","isApp","InfoChangeTask","InfoReqStateTask","POPUP","EWspChangesEvts","Desk","IO","isItemUiEnv","env","longDesc","SrcMain","[object Object]","this","shortDescs","init","wsp","areaContext","reg","infoBroker","addConsumer","createSubReg","place","newPlaceWsp","isNewSrcUri","shortDesc","srcUri","srcRoles","securityCtx","fetchLongDesc","srcRef","srcView","longDescChange","createSub","srcRi","itemType","configRegForMainView","eventsMgr","on","onWspUriChange","bind","isExtItem","getWsp","extractWspCdFromWspRef","itFullUriInOwnerWsp","_buildContent","attachShadow","SHADOWDOM_INIT","installSkin","shadowRoot","_initAndInstallSkin","localName","mainView","getDataSrcMainView","ribRoot","appendChild","createElement","id","ribClasses","getList","ribbons","i","length","rib","areaCtx","isAvailable","needAsync","loadBody","lastDatas","buildBody","push","subViews","converters","getConvertersForMainView","addToList","ItemMainConverters","burgerActions","mergeLists","injectSepByGroup","insertBefore","ui-context","î","action","setActions","setIcon","setLabel","actionContext","firstChild","showSsErrors","initialize","errors","tabs","_a","subTabs","datasTabs","ItemHomeArea","mainTabLabel","mainTabIcon","d","ItemSubTabArea","classList","add","areasContext","areas","lastDatasKey","skinOver","tabSkinOver","initializedAsync","selectTab","async","tab","findReg","universe","wspServer","wspsLive","saveAllHouses","prototype","call","body","_buildHome","viewShown","v","onViewShown","onContainerShown","closed","closePlace","removeConsumer","onViewHidden","onContainerHidden","visitor","options","r","undefined","visitViews","visitViewsAsync","info","newSrcView","msg","from","wspCd","code","type","perm","isSubUriOrEqual","ldNew","isConnected","waitForAvailable","refresh","emit","ed","wedMgr","view","docHolder","xpath","node","house","findNodeByXpath","drawn","highlightWedletFromLink","listeners","once","emitter","registerSkin","super","ctx","mainTab","Object","create","datas","itemMain","tag","_label","label","_description","description","_icon","icon","_visPerms","showPerms","freeLib","resolvePath","wspMetaUi","standardSrcViewsLibs","resolver","importJs","loadLibs","lib","customElements","get","elt","newElt","atts","att","setAttribute","newInit","module","newFreeSrcViewInit","document","wsp-item-img","wsp-item-video","wsp-item-audio","wsp-item-iframe","wsp-item-pdf","wsp-item-dyngen","wsp-item-remote","wsp-item-remote-res","wsp-item-folder-tree","wsp-item-msg-ss","wsp-item-txt","wsp-item-code-ed","wsp-task-dyngen","wsp-task-ct-edit","wsp-task-ct-dyngen","wsp-task-layout","wsp-task-field","wsp-task-field-input","wsp-task-field-lc","wsp-task-xmlfield","wsp-task-exec-trans","ItemMainXml","parentElt","xmlEditor","mainXmlEd","editorKey","writePerms","desc","srcId","currView","selectedTab","getTabByCode","focusNodeInEditor","define","ItemMainRes","resView","buildSrcView","style","flex","editor","c-orient","metaXmlEd","c-resizable","metasSrcFields","srcFields","srcSt","srcDt","setReadOnly","meatBar","uiContext","disabled","hasPermission","onclick","ev","srcRestore","remove","saveDoc","newDomDoc","getModel","ItemMainFolder","msgSs","ctnH","treeView","editors","keys","ctnV","TaskMain","resetMainView","config","startRedraw","nextElementSibling","initStates","setNeedValid","taskEditBroker","removeAllConsumers","needValid","_needValid","dispatchEvent","CustomEvent","bubbles","detail","connectedCallback","lastElementChild","fetchContent","redrawMainView","tkSt","taskContent","parseDomValid","fetchStreamText","uiRoot","dataViews","taskViews","userNames","findView","ifLifeCycleState","test","lcSt","ifPerm","hasPerm","ifInvolvement","rspUsrs","auth","fetchFlattenedGroups","found","indexOf","usr","findInvolvementForResps","resp","ifInApp","app","findLogicalFlatParentOrSelf","customSelector","viewOptions","Error","widget","viewDef","dispatchInfo","fieldName","close","editBroker","st","isDirty","confirm","okLbl","parentLastDatas","states","ItemMainRename","newUris","execute","setTimeout","ItemMainMove","_group","_actions","convertBySwitchTag","props","getHouse","isHouseUpdatable","doc","getDocumentForSave","oldElt","documentElement","firstElementChild","createElementNS","tagNs","tagName","hasChildNodes","replaceWith","cleanupSchemaItModel","convertByXsl","xsl","XSLTProcessor","dom","parseDom","xslPath","fetchDom","nodeName","setAttr","importStylesheet","xslParams","forEach","entry","setParameter","name","value","getItemType","getTagRoot","cleanupDom","transformToDocument","lockedBy","showNotifForbidden","resRef","wasDirty","setDirty","targetSchema","getSchema","bindToDom","correctDocument","autoMutate","autoComplete","autoCleanup","autoNormXml","autoNormChars","fixDocForExport","qs","wspSrcUrl","fetchVoid","method","ser","addToBurger","sortKey","getId","electron","openWidthLOAction","setVisible","matchType","setExecute","url","wspDavUrl","getMainStreamSrcUri","replace","openReply","sendMessage","encodeURI","log","showNotifInfo","installSrcViewFileDrop","callback","dropLayer","class","addEventListener","item","dataTransfer","items","kind","preventDefault","stopPropagation","removeChild","progress","showProgress","update","getAsFile","progressCallback","e","report"],"mappings":"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","sourcesContent":["import {BaseElement, BaseElementAsync, BASIS, isEltInitableAsyncPending} from \"back/commons/basis\";\nimport {Tab, Tabs} from \"back/commons/widgets/tabs\";\nimport {ItemXmlEd, OItemXmlEdInit} from \"back/wsp/views/item/itemXmlEd\";\nimport {IInfo, IInfoBroker, IInfoConsumer, InfoBrokerBasic} from \"lib/commons/infos\";\nimport {IReg, IRegPointer, REG} from 'lib/commons/registry';\nimport {SEC} from 'lib/commons/security';\nimport {IView, IViewApi, IViewsContainer, OBaseAreaViewInit, OViewVisitOptions, VIEWS} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {JSrcFields, SRC, srcRef, srcUri} from \"lib/wsp/src\";\nimport {IWspUiEnv, JWspUriChangeMsg, WSP, Wsp} from \"lib/wsp/wsp\";\nimport {IDatasItemTab, IDatasSrcView, IDatasTaskItemType, IDatasTaskView, IItemTypeUiEnv, ItemType, ItemTypeTask, loadFreeLib} from \"lib/wsp/wspMetaUi\";\nimport {Area, AreaAsync, IArea, isArea, SimpleTagArea} from \"lib/commons/areas\";\nimport {JLastDatas} from \"lib/commons/lastDatas\";\nimport {InfoFocusItem, InfoFocusNodeInItem, IShortDescCtx, ITEM} from \"lib/wsp/item\";\nimport {IXAddr, XA} from \"lib/commons/xml/xAddr\";\nimport {WEDLET} from \"back/edit/wed/wedlets/wedlet\";\nimport {IRibbonAreaContext, RibbonBase} from \"back/wsp/widgets/ribbon/ribbon\";\n//Force le chargement des ribons.\nimport \"back/wsp/widgets/ribbon/ribbon\";\nimport {EventMgr} from \"lib/commons/events\";\nimport {ACTION, Action, ActionMenu, IAction} from \"lib/commons/actions\";\nimport {ActionBtn, Button, OActionBtnInit, OButtonInit} from \"back/commons/widgets/buttons\";\nimport {ExportScar, MoveToSrc, PasteContent, ReloadSrc, RenameSrc} from \"back/wsp/actions/srcActions\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {ItemMsgSs} from \"back/wsp/views/item/itemMsgSs\";\nimport {Resizer} from \"back/commons/widgets/resizer\";\nimport {JTaskStates, TASK} from \"lib/wsp/lcTask\";\nimport {isApp} from \"back/core/appFrame\";\nimport {InfoChangeTask, InfoReqStateTask} from \"back/wsp/views/task/taskFields\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {EWspChangesEvts, IWspXmlHouse, WspsLivePlace} from \"lib/wsp/wspsLive\";\nimport {Desk} from \"lib/commons/desk\";\nimport {IO} from \"lib/commons/io/io\";\nimport \"back/core/zones/webZones\";\n\n/**\n * Contexte pour l'initialisation d'une view Main d'une source.\n */\nexport interface ISrcMainCtx extends IRegPointer<IItemTypeUiEnv> {\n\n\tshortDesc: JSrcFields\n\n\t/** Optimisation : à renseigner si disponible et que l'appelant le sait à jour. */\n\tlongDesc?: JSrcFields\n\n\t/** Code spécial de la mainView à utiliser. */\n\tmainViewCode?: string\n\n\t/** Customisation du registre associé à cette mainView. */\n\t//configReg?: (reg: IReg<IItemUiEnv>) => void\n}\n\n\n/** Un environnement d'item est issu d'un env d'itemType, avec le securityCtx dédié, une place enregistrée et le longDesc de l'item. */\nexport type IItemUiEnv = IItemTypeUiEnv & {\n\tsrcView?: IView\n\tlongDesc?: JSrcFields\n\tlongDescChange?: EventMgr<(ldNew: JSrcFields, ldOld: JSrcFields) => void>\n}\n\nexport function isItemUiEnv(env: any): env is IItemUiEnv {return env && env.longDesc != null}\n\nexport type ITaskUiEnv = IItemUiEnv & {\n\tsrcView: TaskMain\n\titemType: ItemTypeTask\n\ttaskEditBroker?: IInfoBroker\n\t/** Contenu de la task */\n\ttaskContent?: Document\n\t/** Etat des champs de la tâche à son chargement (création de task avec pre-init ou reload de page). */\n\tinitStates?: JTaskStates\n}\n\n/**\n * Composant de base pour les mainViews des items.\n */\nexport interface SrcMain {\n\tinitialize(init: OSrcMainInit): this;\n}\n\nexport interface OSrcMainInit extends OBaseAreaViewInit<ISrcMainCtx> {}\n\nexport abstract class SrcMain extends BaseElementAsync implements IInfoConsumer, IView, IViewsContainer, IShortDescCtx {\n\n\treg: IReg<IItemUiEnv>;\n\twsp: Wsp;\n\tinfoBroker: IInfoBroker;\n\n\t/** views affichés dans cette page principale (hors tabs) */\n\tsubViews?: IView[];\n\t/** Onglets de la view. */\n\ttabs?: Tabs<SrcMain>;\n\n\tasync _initialize(init: OSrcMainInit) {\n\t\tthis.wsp = init.areaContext.reg.env.wsp;\n\t\tthis.infoBroker = init.areaContext.reg.env.infoBroker;\n\t\tif (this.infoBroker) this.infoBroker.addConsumer(this); //on s'abonne de suite pour ne pas louper des demandes de type serchText/searchItemRef, etc.\n\t\tthis.reg = REG.createSubReg(init.areaContext.reg);\n\t\tthis.reg.env.place = this.wsp.newPlaceWsp();\n\n\t\tlet longDesc = init.areaContext.longDesc;\n\t\tif (!longDesc) {\n\t\t\tif (SRC.isNewSrcUri(init.areaContext.shortDesc.srcUri)) {\n\t\t\t\tlongDesc = init.areaContext.shortDesc;\n\t\t\t\tlongDesc.srcRoles = this.reg.env.securityCtx.srcRoles; //objet en création, on récupère les roles de l'atelier.\n\t\t\t} else {\n\t\t\t\tlongDesc = await this.wsp.fetchLongDesc(SRC.srcRef(init.areaContext.shortDesc));\n\t\t\t}\n\t\t}\n\t\t//console.log(\"longDesc:::\", longDesc);\n\t\tthis.reg.env.longDesc = longDesc;\n\t\tthis.shortDescs[0] = longDesc;\n\t\tthis.reg.env.srcView = this;\n\t\tthis.reg.env.longDescChange = new EventMgr();\n\t\tthis.reg.env.securityCtx = SEC.createSub(this.reg.env.securityCtx, longDesc.srcRoles, longDesc.srcRi, longDesc);\n\n\t\tthis.reg.env.itemType.configRegForMainView(init.areaContext, this.reg);\n\t\t//if (init.areaContext.configReg) init.areaContext.configReg(this.reg);\n\n\t\tthis.reg.env.place.eventsMgr.on(\"wspUriChange\", this.onWspUriChange.bind(this));\n\n\t\tif (ITEM.isExtItem(longDesc.srcUri)) {\n\t\t\t//On écoute les modifs de cet atelier étranger public.\n\t\t\tthis.reg.env.place.getWsp(WSP.extractWspCdFromWspRef(longDesc.itFullUriInOwnerWsp));\n\t\t}\n\n\t\treturn this._buildContent(init);\n\t}\n\n\tprotected async _buildContent(init: OSrcMainInit): Promise<void> {\n\t\tthis.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"webzone:page\", this.shadowRoot);\n\t\tthis.reg.installSkin(\"wsp-itemmain\", this.shadowRoot);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tconst itemType = this.reg.env.itemType;\n\t\tconst mainView = itemType.getDataSrcMainView(init.areaContext);\n\t\tconst ribRoot = this.shadowRoot.appendChild<HTMLElement>(<header id=\"ribbons\"/>);\n\t\tconst ribClasses = this.reg.getList<typeof RibbonBase | IArea<IRibbonAreaContext>>(\"ribbon:item\");\n\t\tif (ribClasses) {\n\t\t\tconst ribbons: RibbonBase[] = [];\n\t\t\t//let resizable = 0;\n\t\t\tfor (let i = 0; i < ribClasses.length; i++) {\n\t\t\t\t//if (i > 0) ribRoot.appendChild(<c-resizer class=\"ribSep\" c-orient=\"row\"/>);\n\n\t\t\t\tlet rib: RibbonBase;\n\t\t\t\tif (isArea(ribClasses[i])) {\n\t\t\t\t\tconst areaCtx: IRibbonAreaContext = {\n\t\t\t\t\t\treg: this.reg\n\t\t\t\t\t};\n\t\t\t\t\tif ((ribClasses[i] as IArea).isAvailable(areaCtx)) {\n\t\t\t\t\t\tif ((ribClasses[i] as IArea).needAsync(areaCtx)) {\n\t\t\t\t\t\t\trib = ribRoot.appendChild(await (ribClasses[i] as AreaAsync).loadBody(areaCtx, init.lastDatas)) as RibbonBase;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\trib = ribRoot.appendChild((ribClasses[i] as IArea).buildBody(areaCtx, init.lastDatas)) as RibbonBase;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else\n\t\t\t\t\trib = ribRoot.appendChild(new (ribClasses[i] as typeof RibbonBase)());\n\t\t\t\tif (rib) {\n\t\t\t\t\tribbons.push(rib);\n\t\t\t\t\t//if (rib.hasAttribute(\"c-resizable\")) resizable++;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// //Au moins 2 ribons resizables pour activer les resizers.\n\t\t\t// if (resizable <= 1) ribRoot.querySelectorAll('c-resizer').forEach((r: Resizer) => r.disabled = true);\n\t\t\tthis.subViews = ribbons;\n\t\t}\n\n\t\tconst converters = itemType.getConvertersForMainView(init.areaContext);\n\t\tif (converters) this.reg.addToList(\"actions:item:burger\", \"converters\", 1, new ItemMainConverters(converters), 100);\n\n\t\tlet burgerActions = this.reg.mergeLists<IAction<SrcMain>>(\"actions:item:burger\", \"actions:wsp:shortDesc\");\n\t\tif (burgerActions) {\n\t\t\tburgerActions = ACTION.injectSepByGroup<SrcMain>(burgerActions, \"\", this);\n\t\t\tribRoot.insertBefore(<ActionBtn ui-context=\"bar\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\taction: new ActionMenu<SrcMain>().setActions(burgerActions).setIcon(\"/@skin@/commons/icons/actions.svg\").setLabel(\"Actions générales sur l'item\"),\n\t\t\t\tactionContext: this\n\t\t\t} as OActionBtnInit<SrcMain>}/> as ActionBtn<SrcMain>, ribRoot.firstChild);\n\t\t}\n\n\t\tif (mainView && mainView.showSsErrors) {\n\t\t\tthis.shadowRoot.appendChild<HTMLElement>(new ItemMsgSs().initialize({\n\t\t\t\treg: this.reg,\n\t\t\t\terrors: mainView.showSsErrors.errors\n\t\t\t}));\n\t\t}\n\n\t\tlet tabs: Area<SrcMain>[];\n\t\tif (mainView?.subTabs?.length > 0) {\n\t\t\tconst datasTabs = mainView.subTabs; //.filter((tab) => tab.showPerms ? this.reg.hasPerm(tab.showPerms) : true); NON, perms peuvent évoluer, donc affichage en mode tabs\n\t\t\ttabs = [new ItemHomeArea(init).setLabel(mainView.mainTabLabel || \"Édition\").setIcon(mainView.mainTabIcon || \"/@skin@/wsp/views/itemMain/penInk.svg\")];\n\t\t\tfor (const d of datasTabs) tabs.push(new ItemSubTabArea(d, this));\n\t\t}\n\t\tif (tabs) {\n\t\t\tthis.tabs = new Tabs<SrcMain>();\n\t\t\tthis.tabs.classList.add(\"noBorder\");\n\t\t\tthis.shadowRoot.appendChild(this.tabs.initialize({\n\t\t\t\treg: this.reg,\n\t\t\t\tareasContext: this,\n\t\t\t\tareas: tabs,\n\t\t\t\tlastDatasKey: \"vtabs\",\n\t\t\t\tlastDatas: init.lastDatas ? init.lastDatas[\"vtabs\"] : null,\n\t\t\t\tskinOver: \"itemMain/c-tabs\",\n\t\t\t\ttabSkinOver: \"itemMain/c-tab\"\n\t\t\t}));\n\t\t\tawait this.tabs.initializedAsync;\n\t\t\t//après init, on injecte l'enregistrement des houses avant tout changement de tab (pour Màj avant init des dynGen en particulier)\n\t\t\tthis.tabs.selectTab = async function (this: Tabs<SrcMain>, tab: Tab<SrcMain>, lastDatas?: JLastDatas): Promise<boolean> {\n\t\t\t\tawait REG.findReg<IWspUiEnv>(this).env.universe.wspServer.wspsLive.saveAllHouses();\n\t\t\t\treturn Tabs.prototype.selectTab.call(this, tab, lastDatas);\n\t\t\t};\n\t\t} else {\n\t\t\tconst body = this.shadowRoot.appendChild(<div id=\"noTabs\"/>);\n\t\t\tif (!this.subViews) this.subViews = [];\n\t\t\treturn this._buildHome(init, itemType, body);\n\t\t}\n\t}\n\n\tabstract _buildHome(init: OSrcMainInit, itemType: ItemType, parentElt: Node): Promise<void>;\n\n\tviewShown: boolean;\n\n\tonViewShown() {\n\t\tthis.viewShown = true;\n\t\tif (this.subViews) for (const v of this.subViews) VIEWS.onViewShown(v);\n\t\tif (this.tabs) VIEWS.onContainerShown(this.tabs);\n\t}\n\n\tonViewHidden(closed: boolean) {\n\t\tthis.viewShown = false;\n\t\tif (closed) {\n\t\t\tthis.reg.env.place.closePlace();\n\t\t\tif (this.infoBroker) this.infoBroker.removeConsumer(this);\n\t\t}\n\t\tif (this.subViews) for (const v of this.subViews) VIEWS.onViewHidden(v, closed);\n\t\tif (this.tabs) VIEWS.onContainerHidden(this.tabs, closed);\n\t}\n\n\tvisitViews(visitor: (view: IView) => any, options?: OViewVisitOptions): any {\n\t\tif (this.subViews) for (const v of this.subViews) {\n\t\t\tconst r = visitor(v);\n\t\t\tif (r !== undefined) return r;\n\t\t}\n\t\tif (this.tabs) return this.tabs.visitViews(visitor, options);\n\t}\n\n\tasync visitViewsAsync(visitor: (view: IView) => Promise<any>, options?: OViewVisitOptions): Promise<any> {\n\t\tif (this.subViews) for (const v of this.subViews) {\n\t\t\tconst r = await visitor(v);\n\t\t\tif (r !== undefined) return r;\n\t\t}\n\t\tif (this.tabs) return this.tabs.visitViewsAsync(visitor, options);\n\t}\n\n\tonInfo(info: IInfo): void {}\n\n\t/** Construit une view de l'item (editor, dynGen , ...) */\n\tbuildSrcView(v: IDatasSrcView): Promise<IView | null> {\n\t\treturn v ? newSrcView(v, this.reg) : null;\n\t}\n\n\tasync onWspUriChange(msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') {\n\t\tif (msg.wspCd !== this.reg.env.wsp.code) return;\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\tif (SRC.srcRef(longDesc) === SRC.srcRef(msg) || (msg.type === EWspChangesEvts.perm && SRC.isSubUriOrEqual(msg.srcUri, longDesc.srcUri))) {\n\t\t\tconst ldNew = await this.reg.env.wsp.fetchLongDesc(SRC.srcRef(longDesc), this);\n\t\t\tif (!this.isConnected) return;\n\t\t\tif (!this.wsp.isAvailable) await this.wsp.waitForAvailable(this);\n\t\t\tthis.reg.env.longDesc = ldNew;\n\t\t\tthis.shortDescs[0] = ldNew;\n\t\t\t//console.log(\"longDesc new:::\", ldNew);\n\t\t\tthis.reg.env.securityCtx = SEC.createSub(this.reg.env.securityCtx, ldNew.srcRoles, ldNew.srcRi, ldNew);\n\t\t\tthis.tabs?.refresh(); //si perms sur tabs\n\t\t\tthis.reg.env.longDescChange.emit(ldNew, longDesc);\n\t\t}\n\t}\n\n\tprotected async focusNodeInEditor(ed: ItemXmlEd, info: InfoFocusNodeInItem) {\n\t\tawait ed.initializedAsync;\n\t\tconst wedMgr = ed.view.wedMgr;\n\t\tconst docHolder = wedMgr.docHolder;\n\t\tif (!docHolder) return; //TODO si wedMgr.docHolderAsync uniquement.\n\t\tif (typeof info.xpath === \"string\") {\n\t\t\tconst node = docHolder.house.findNodeByXpath(info.xpath);\n\t\t\tif (node) {\n\t\t\t\tif (wedMgr.drawn) {\n\t\t\t\t\tWEDLET.highlightWedletFromLink(XA.from(node), ed.view.wedMgr, 'nearest');\n\t\t\t\t} else {\n\t\t\t\t\twedMgr.listeners.once(\"redrawAtEnd\", () => {\n\t\t\t\t\t\tWEDLET.highlightWedletFromLink(XA.from(node), ed.view.wedMgr, 'nearest');\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tif (wedMgr.drawn) {\n\t\t\t\tWEDLET.highlightWedletFromLink(info.xpath, ed.view.wedMgr, 'nearest');\n\t\t\t} else {\n\t\t\t\twedMgr.listeners.once(\"redrawAtEnd\", () => {\n\t\t\t\t\tWEDLET.highlightWedletFromLink(info.xpath as IXAddr, ed.view.wedMgr, 'nearest');\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t//*** Apis IShortDescCtx ***\n\tshortDescs: JSrcFields[] = [];\n\n\tget emitter() {return this;}\n}\n\nREG.reg.registerSkin('wsp-itemmain', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\tbackground-color: var(--bgcolor);\n\t\tcolor: var(--color);\n\t}\n\n\t[hidden] {\n\t\tdisplay: none !important;\n\t}\n\n\t#ribbons {\n\t\tdisplay: flex;\n\t\tmin-height: 2.8em;\n\t\tmin-width: 0;\n\t}\n\n\t#noTabs {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\tborder-top: 1px solid var(--border-color);\n\t}\n\n\tc-tabs {\n\t\tflex: 1;\n\t}\n\n\t#mainTab {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\tc-resizer[c-orient=\"row\"] {\n\t\twidth: 1px;\n\t}\n\n\tc-resizer[c-orient=\"column\"] {\n\t\theight: 1px;\n\t}\n\n\t#ribbons > c-resizer {\n\t\twidth: 0;\n\t}\n\n\t#ribbons > [hidden] + c-resizer {\n\t\tdisplay: none;\n\t}\n`);\n\n/** Area représentation la home de l'itemMain. */\nclass ItemHomeArea extends Area<SrcMain> {\n\n\tconstructor(public init: OSrcMainInit) {\n\t\tsuper('');\n\t}\n\n\tneedAsync(ctx: SrcMain): boolean {return true}\n\n\tasync loadBody(ctx: SrcMain, lastDatas?: JLastDatas): Promise<HTMLElement> {\n\t\tconst mainTab = <div id=\"mainTab\"/>;\n\t\tconst init = Object.create(this.init) as OSrcMainInit;\n\t\tinit.lastDatas = lastDatas;\n\t\tawait ctx._buildHome(init, ctx.reg.env.itemType, mainTab);\n\t\treturn mainTab;\n\t}\n}\n\n/** Area de construction des vues secondaires de l'itemMain. */\nclass ItemSubTabArea extends SimpleTagArea<SrcMain, IView> {\n\tdatas: IDatasItemTab;\n\titemMain: SrcMain;\n\n\tconstructor(datas: IDatasItemTab, itemMain: SrcMain) {\n\t\tsuper(datas.view.tag, null, datas.code);\n\t\tthis.datas = datas;\n\t\tthis.itemMain = itemMain;\n\t\tthis._label = datas.label;\n\t\tthis._description = datas.description;\n\t\tthis._icon = datas.icon;\n\t\tthis._visPerms = datas.showPerms;\n\t}\n\n\tasync loadLibs(ctx: SrcMain): Promise<void> {\n\t\tconst v = this.datas.view;\n\t\tif (v.freeLib) await loadFreeLib(ctx.reg.env.itemType.resolvePath(v.freeLib), ctx.reg.env.wsp.wspMetaUi.reg);\n\t\telse if (standardSrcViewsLibs[v.tag]) await ctx.reg.env.resolver.importJs(standardSrcViewsLibs[v.tag]);\n\t\treturn super.loadLibs(ctx);\n\t}\n\n\tneedAsync(ctx: SrcMain): boolean {\n\t\tif (super.needAsync(ctx)) return true;\n\t\tconst v = this.datas.view;\n\t\tconst lib = v.freeLib || standardSrcViewsLibs[v.tag];\n\t\treturn lib && !customElements.get(v.tag);\n\t}\n\n\tprotected newElt(ctx: SrcMain, lastDatas?: JLastDatas): IView {\n\t\tconst elt = super.newElt(ctx);\n\t\tconst atts = this.datas.view.atts;\n\t\tif (atts) for (const att in atts) elt.setAttribute(att, atts[att]);\n\t\tif (elt instanceof BaseElement) {\n\t\t\tconst init = BASIS.newInit(this.datas.view.init, this.itemMain.reg);\n\t\t\tinit.lastDatas = lastDatas;\n\t\t\telt.initialize(init);\n\t\t}\n\t\treturn elt;\n\t}\n}\n\n\nexport async function newSrcView(v: IDatasSrcView, reg: IReg<IItemUiEnv>): Promise<HTMLElement> {\n\t//if (v.showPerm && !reg.hasPerm(v.showPerm)) return null;\n\tlet init = v.init;\n\tif (v.freeLib) {\n\t\tconst module = await loadFreeLib(reg.env.itemType.resolvePath(v.freeLib), reg.env.wsp.wspMetaUi.reg);\n\t\tif (module.newFreeSrcViewInit) init = module.newFreeSrcViewInit(v, reg);\n\t}\n\tif (!customElements.get(v.tag)) {\n\t\tconst lib = standardSrcViewsLibs[v.tag];\n\t\tif (lib) await reg.env.resolver.importJs(lib);\n\t}\n\tconst view = document.createElement(v.tag) as HTMLElement;\n\tview.setAttribute(\"c-resizable\", \"\");\n\tconst atts = v.atts;\n\tif (atts) for (const att in atts) view.setAttribute(att, atts[att]);\n\tif (view instanceof BaseElement) {\n\t\tview.initialize(BASIS.newInit(init, reg));\n\t\tif (isEltInitableAsyncPending(view)) await view.initializedAsync;\n\t}\n\treturn view;\n}\n\n\nexport const standardSrcViewsLibs: Dict<string> = {\n\t//ATTENTION laisser \":back:\" et PAS \"/@back@/\" pour résoudre le bon credentials \"omit\"/\"include\" si les dev-core sont sur un autre domaine.\n\t\"wsp-item-img\": \":back:wsp/views/item/itemImg.js\",\n\t\"wsp-item-video\": \":back:wsp/views/item/itemVideo.js\",\n\t\"wsp-item-audio\": \":back:wsp/views/item/itemAudio.js\",\n\t\"wsp-item-iframe\": \":back:wsp/views/item/itemIframe.js\",\n\t\"wsp-item-pdf\": \":back:wsp/views/item/itemPdf.js\",\n\t\"wsp-item-dyngen\": \":back:wsp/views/item/itemDynGen.js\",\n\t\"wsp-item-remote\": \":back:wsp/views/item/itemRemote.js\",//TODOsc7 : supprimer\n\t\"wsp-item-remote-res\": \":back:wsp/views/item/itemRemoteRes.js\",\n\t\"wsp-item-folder-tree\": \":back:wsp/views/item/itemFolderTree.js\",\n\t\"wsp-item-msg-ss\": \":back:wsp/views/item/itemMsgSs.js\",\n\t\"wsp-item-txt\": \":back:wsp/views/item/itemTxt.js\",\n\t\"wsp-item-code-ed\": \":back:wsp/views/item/itemCodeEd.js\",\n\t//\"wsp-item-xmled\": \":back:wsp/views/item/itemXmlEd.js\", toujours préchargé.\n\t\"wsp-task-dyngen\": \":back:wsp/views/task/taskDynGen.js\",\n\t\"wsp-task-ct-edit\": \":back:wsp/views/task/taskContent.js\",\n\t\"wsp-task-ct-dyngen\": \":back:wsp/views/task/taskContent.js\",\n\t\"wsp-task-layout\": \":back:wsp/views/task/taskLayout.js\",\n\t\"wsp-task-field\": \":back:wsp/views/task/taskFields.js\",\n\t\"wsp-task-field-input\": \":back:wsp/views/task/taskFields.js\",\n\t\"wsp-task-field-lc\": \":back:wsp/views/task/taskFields.js\",\n\t\"wsp-task-xmlfield\": \":back:wsp/views/task/taskFields.js\",\n\t\"wsp-task-exec-trans\": \":back:wsp/views/task/taskFields.js\",\n};\n\n\n/**\n * ItemMain pour les itemTypes de la famille \"xml\".\n */\nexport class ItemMainXml extends SrcMain {\n\n\tmainXmlEd: ItemXmlEd;\n\n\tasync _buildHome(init: OSrcMainInit, itemType: ItemType, parentElt: Node): Promise<void> {\n\t\tconst mainView = itemType.getDataSrcMainView(init.areaContext);\n\t\tif (mainView && mainView.xmlEditor) {\n\t\t\tthis.mainXmlEd = parentElt.appendChild(new ItemXmlEd().initialize({\n\t\t\t\treg: this.reg,\n\t\t\t\teditorKey: mainView.xmlEditor,\n\t\t\t\twritePerms: \"action.itemMainView#edit.content\",\n\t\t\t\tlastDatas: init.lastDatas\n\t\t\t}));\n\t\t\tif (this.subViews) this.subViews.push(this.mainXmlEd);\n\t\t\treturn this.mainXmlEd.initializedAsync as unknown as Promise<void>;\n\t\t}\n\t}\n\n\tonInfo(info: IInfo): void {\n\t\tif (info instanceof InfoFocusNodeInItem) {\n\t\t\tconst desc = this.reg.env.longDesc;\n\t\t\tif (desc.srcUri === info.srcRef || desc.srcId === info.srcRef) {\n\t\t\t\tlet ed = this.mainXmlEd;\n\t\t\t\tif (this.tabs) {\n\t\t\t\t\tconst currView = this.tabs.selectedTab.view;\n\t\t\t\t\tif (currView instanceof ItemXmlEd) {\n\t\t\t\t\t\ted = currView;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.tabs.selectTab(this.tabs.getTabByCode(\"\"));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (ed) this.focusNodeInEditor(ed, info);\n\t\t\t}\n\t\t}\n\t}\n}\n\n//REG.reg.registerSkin('wsp-itemmain-xml', 1, /* language=CSS */ `\t`);\ncustomElements.define('wsp-itemmain-xml', ItemMainXml);\n\n\n/**\n * ItemMain pour les itemTypes de la famille \"res\".\n */\nexport class ItemMainRes extends SrcMain {\n\n\tmetaXmlEd?: ItemXmlEd;\n\n\tprotected async _buildContent(init: OSrcMainInit): Promise<void> {\n\t\tthis.reg.addToList(\"actions:item:burger\", \"pasteStream\", 1, new PasteContent());\n\t\treturn super._buildContent(init);\n\t}\n\n\tasync _buildHome(init: OSrcMainInit, itemType: ItemType, parentElt: Node): Promise<void> {\n\t\tconst mainView = itemType.getDataSrcMainView(init.areaContext);\n\t\tconst resView = await this.buildSrcView(mainView?.resView);\n\t\tif (resView) {\n\t\t\tresView.style.flex = \"1\";\n\t\t\tparentElt.appendChild(resView);\n\t\t\tif (this.subViews) this.subViews.push(resView);\n\t\t}\n\t\tconst editor = mainView?.xmlEditor;\n\t\tif (editor) {\n\t\t\tif (resView) parentElt.appendChild(<Resizer c-orient=\"column\"/>);\n\t\t\tconst ed = this.metaXmlEd = parentElt.appendChild(<ItemXmlEd id=\"metaEd\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\teditorKey: editor,\n\t\t\t\twritePerms: \"action.itemMainView#edit.content\",\n\t\t\t\tlastDatas: init.lastDatas\n\t\t\t} as OItemXmlEdInit} c-resizable=\"\" style=\"display: flex;\"/>) as ItemXmlEd; //pour contrer display:contents par défaut du ItemXmlEd, incompatible avec Resizer.\n\t\t\tif (this.subViews) this.subViews.push(ed);\n\t\t\tawait ed.initializedAsync;\n\t\t\tconst house = ed.view.wedMgr.docHolder.house as IWspXmlHouse;\n\t\t\tconst metasSrcFields = house.srcFields;\n\t\t\tif (metasSrcFields && metasSrcFields.srcSt < 0 && metasSrcFields.srcDt > 0) {\n\t\t\t\t//Méta en corbeille à restaurer\n\t\t\t\ted.view.wedMgr.setReadOnly(\"inTrash\", true);\n\t\t\t\tconst meatBar = parentElt.insertBefore(<div id=\"metaInTrashBar\">\n\t\t\t\t\t<span>Ces métadonnées sont actuellement en corbeille</span>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<Button î={{reg: this.reg, label: \"Restaurer\", uiContext: \"dialog\"} as OButtonInit} disabled={this.reg.hasPermission(\"restore.history\", metasSrcFields.srcRoles, undefined, metasSrcFields.srcRi) ? undefined : \"\"}\n\t\t\t\t\t\t\t\t\t\tonclick={async (ev: MouseEvent) => {\n\t\t\t\t\t\t\t\t\t\t\tawait WSP.srcRestore(this.wsp, this, [SRC.srcRef(metasSrcFields)]);\n\t\t\t\t\t\t\t\t\t\t\ted.view.wedMgr.setReadOnly(\"inTrash\", false);\n\t\t\t\t\t\t\t\t\t\t\tmeatBar.remove();\n\t\t\t\t\t\t\t\t\t\t}}/>\n\t\t\t\t\t\t<Button î={{reg: this.reg, label: \"Réinitialiser\", uiContext: \"dialog\"} as OButtonInit}\n\t\t\t\t\t\t\t\t\t\tdisabled={this.reg.hasPermission(\"action.itemMainView#edit.content\", metasSrcFields.srcRoles, undefined, metasSrcFields.srcRi) ? undefined : \"\"}\n\t\t\t\t\t\t\t\t\t\tonclick={async (ev: MouseEvent) => {\n\t\t\t\t\t\t\t\t\t\t\tawait saveDoc(this, house, DOM.newDomDoc(), house.itemType.getModel(), SRC.srcRef(metasSrcFields));\n\t\t\t\t\t\t\t\t\t\t\ted.view.wedMgr.setReadOnly(\"inTrash\", false);\n\t\t\t\t\t\t\t\t\t\t\tmeatBar.remove();\n\t\t\t\t\t\t\t\t\t\t}}/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>, ed);\n\t\t\t}\n\t\t}\n\t}\n\n\tonInfo(info: IInfo): void {\n\t\tif (info instanceof InfoFocusNodeInItem) {\n\t\t\tconst desc = this.reg.env.longDesc;\n\t\t\tif (desc.srcUri === info.srcRef || desc.srcId === info.srcRef) {\n\t\t\t\tif (this.metaXmlEd) this.focusNodeInEditor(this.metaXmlEd, info);\n\t\t\t}\n\t\t}\n\t}\n\n}\n\nREG.reg.registerSkin('wsp-itemmain-res', 1, /* language=CSS */ `\n\twsp-item-xmled {\n\t\tflex-direction: column;\n\t\tflex: 1;\n\t\tmin-height: 7em;\n\t}\n\n\t#metaInTrashBar {\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\ttext-align: center;\n\t\tpadding: .5em;\n\t\tbackground-color: var(--alt1-bgcolor);\n\t}\n\n\t#metaInTrashBar > span {\n\t\tcolor: var(--warning-color);\n\t\tfont-weight: bold;\n\t}\n\n\t#metaInTrashBar > div {\n\t\tdisplay: flex;\n\t  justify-content: center;\n\t}\n`);\ncustomElements.define('wsp-itemmain-res', ItemMainRes);\n\n\n/**\n * ItemMain pour les itemTypes de la famille \"folder\".\n */\nexport class ItemMainFolder extends SrcMain {\n\n\tasync _buildHome(init: OSrcMainInit, itemType: ItemType, parentElt: Node): Promise<void> {\n\t\tconst mainView = itemType.getDataSrcMainView(init.areaContext);\n\n\t\tconst msgSs = await this.buildSrcView({tag: \"wsp-item-msg-ss\"});\n\t\tparentElt.appendChild(msgSs);\n\n\t\tconst ctnH = parentElt.appendChild(<div id=\"ctnH\"/>);\n\n\t\t//resTree. TODO passer en view configurable : mainView.treeView ?\n\t\tconst treeView = await this.buildSrcView({tag: \"wsp-item-folder-tree\"});\n\t\tif (this.subViews) this.subViews.push(treeView);\n\t\tctnH.appendChild(treeView);\n\n\t\t//resView et editor de metas.\n\t\tconst resView = await this.buildSrcView(mainView && mainView.resView);\n\t\tif (resView && this.subViews) this.subViews.push(resView);\n\t\tconst editor = mainView && mainView.xmlEditor ? mainView.xmlEditor : itemType.datas.editors ? Object.keys(itemType.datas.editors)[0] : null;\n\t\tif (resView && editor) {\n\t\t\tctnH.appendChild(<Resizer c-orient=\"row\"/>);\n\t\t\tconst ctnV = ctnH.appendChild(<div id=\"ctnV\" c-resizable=\"\"/>);\n\t\t\tctnV.appendChild(resView);\n\t\t\tctnV.appendChild(<Resizer c-orient=\"column\"/>);\n\t\t\tconst ed = ctnV.appendChild(<ItemXmlEd î={{\n\t\t\t\treg: this.reg,\n\t\t\t\teditorKey: editor,\n\t\t\t\twritePerms: \"action.itemMainView#edit.content\",\n\t\t\t\tlastDatas: init.lastDatas\n\t\t\t} as OItemXmlEdInit} c-resizable=\"\" style=\"display: flex;\"/>); //pour contrer display:contents par défaut du ItemXmlEd, incompatible avec Resizer.\n\t\t\tif (this.subViews) this.subViews.push(ed);\n\t\t} else if (resView) {\n\t\t\tctnH.appendChild(<Resizer c-orient=\"row\"/>);\n\t\t\tctnH.appendChild(resView);\n\t\t} else if (editor) {\n\t\t\tctnH.appendChild(<Resizer c-orient=\"row\"/>);\n\t\t\tconst ed = ctnH.appendChild(<ItemXmlEd î={{\n\t\t\t\treg: this.reg,\n\t\t\t\teditorKey: editor,\n\t\t\t\twritePerms: \"action.itemMainView#edit.content\",\n\t\t\t\tlastDatas: init.lastDatas\n\t\t\t} as OItemXmlEdInit} c-resizable=\"\" style=\"display: flex;\"/>); //pour contrer display:contents par défaut du ItemXmlEd, incompatible avec Resizer.\n\t\t\tif (this.subViews) this.subViews.push(ed);\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-itemmain-folder', 1, /* language=CSS */ `\n\t#ctnH {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\n\t#ctnV {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\twsp-item-xmled {\n\t\tflex-direction: column;\n\t\tflex: 1;\n\t}\n`);\n\ncustomElements.define('wsp-itemmain-folder', ItemMainFolder);\n\n\nexport interface OTaskMainInit extends OSrcMainInit {\n\tviewOptions?: any\n\tlastDatas?: JTaskStates\n}\n\n\n/**\n * ItemMain pour les itemTypes de la famille \"task\".\n */\nexport class TaskMain extends SrcMain {\n\n\treg: IReg<ITaskUiEnv>;\n\n\tprotected startRedraw: Element;\n\tprotected config: OTaskMainInit;\n\n\tasync redrawMainView(): Promise<void> {\n\t\t//cleanup\n\t\tthis.resetMainView();\n\t\t//reconstruction\n\t\tawait this._buildHome(this.config, this.reg.env.itemType, this.shadowRoot);\n\t\tif (this.viewShown) for (const v of this.subViews) VIEWS.onViewShown(v);\n\t}\n\n\t/** Utilisé après enregistrement d'une tâche en création pour permettre son remplacement par la tache créée*/\n\tresetMainView() {\n\t\tfor (const v of this.subViews) VIEWS.onViewHidden(v, true);\n\t\twhile (this.startRedraw.nextElementSibling) this.startRedraw.nextElementSibling.remove();\n\t\tthis.subViews.length = 0;\n\t\tthis.reg.env.initStates = null; // plus d'init avec un état issu des lastDatas.\n\t\tthis.setNeedValid(false);\n\t\t(this.reg.env.taskEditBroker as InfoBrokerBasic).removeAllConsumers();\n\t}\n\n\tsetNeedValid(needValid: boolean) {\n\t\tif (this._needValid !== needValid) {\n\t\t\tthis._needValid = needValid;\n\t\t\tif (this.isConnected) this.dispatchEvent(new CustomEvent(\"wsp-need-valid\", {bubbles: true, detail: needValid}));\n\t\t}\n\t}\n\n\tprotected _needValid: boolean;\n\n\tconnectedCallback() {\n\t\tsuper.connectedCallback();\n\t\tif (this._needValid) this.dispatchEvent(new CustomEvent(\"wsp-need-valid\", {bubbles: true, detail: true}));\n\t}\n\n\t//Pas de tabs secondaires sur les tasks.\n\tprotected async _buildContent(init: OTaskMainInit): Promise<void> {\n\t\tthis.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"webzone:page\", this.shadowRoot);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tthis.config = init;\n\t\tthis.startRedraw = this.shadowRoot.lastElementChild;\n\t\tthis.reg.env.longDescChange.add(async () => {\n\t\t\t//On récupère le contenu\n\t\t\tawait this.fetchContent();\n\t\t\treturn this.redrawMainView();\n\t\t});\n\t\t//console.log(\"_buildContent init.lastDatas:::\", init.lastDatas);\n\t\tif (init.lastDatas && (init.lastDatas as JLDTaskMain).tkSt) this.reg.env.initStates = (init.lastDatas as JLDTaskMain).tkSt;\n\t\tif (!SRC.isNewSrcUri(this.reg.env.longDesc.srcUri)) {\n\t\t\tawait this.fetchContent();\n\t\t}\n\t\treturn this._buildHome(init, this.reg.env.itemType, this.shadowRoot);\n\t}\n\n\tprivate async fetchContent() {\n\t\tif (!this.reg.env.taskContent) this.reg.env.taskContent = DOM.parseDomValid(await WSP.fetchStreamText(this.wsp, this.reg.env.uiRoot, SRC.srcRef(this.reg.env.longDesc)));\n\t}\n\n\tasync _buildHome(init: OTaskMainInit, itemType: ItemTypeTask, parentElt: Node) {\n\t\tconst dataViews = (itemType.datas as IDatasTaskItemType).taskViews;\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\tthis.reg.env.taskEditBroker = new InfoBrokerBasic();\n\t\tlet userNames: string[];\n\t\tlet view: IDatasTaskView;\n\t\tfindView: for (const v of dataViews) {\n\t\t\t//Restriction sur l'état de la tâche\n\t\t\tif (v.ifLifeCycleState && !v.ifLifeCycleState.test(longDesc.lcSt)) continue findView;\n\t\t\t//Perm\n\t\t\tif (v.ifPerm && !this.reg.hasPerm(v.ifPerm)) continue findView;\n\t\t\t//Restictions sur l'implication du user dans la tâche\n\t\t\tif (v.ifInvolvement > 0) {\n\t\t\t\tif (!longDesc.rspUsrs) continue findView;\n\t\t\t\tif (!userNames) userNames = await this.reg.env.universe.auth.fetchFlattenedGroups();\n\t\t\t\tlet found: boolean;\n\t\t\t\tfor (const r of longDesc.rspUsrs) {\n\t\t\t\t\tif (userNames.indexOf(r.usr) >= 0 && (TASK.findInvolvementForResps(itemType, r.resp, longDesc) & v.ifInvolvement) > 0) {\n\t\t\t\t\t\tfound = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!found) continue findView; //Involvement pas trouvé\n\t\t\t}\n\t\t\t//Restictions sur l'app courante\n\t\t\tif (v.ifInApp) {\n\t\t\t\tconst app = DOMSH.findLogicalFlatParentOrSelf(this.reg.env.uiRoot, null, isApp);\n\t\t\t\tif (!app || !v.ifInApp.test(app.localName)) continue findView; //App pas trouvé\n\t\t\t}\n\t\t\t//Restriction Custom\n\t\t\tif (v.customSelector && !v.customSelector(this.reg, init.viewOptions)) continue findView;\n\t\t\t//Toutes les restrictions sont validées, on sélectionne cette view\n\t\t\tview = v;\n\t\t\tbreak findView;\n\t\t}\n\t\tif (!view) throw Error(\"No view found for task: \" + longDesc.srcUri);\n\t\t//console.log(\"view::::\", view, longDesc);\n\t\tconst widget = await this.buildSrcView(view.viewDef);\n\t\tif (!this.subViews) this.subViews = [widget];\n\t\telse this.subViews.push(widget);\n\t\tparentElt.appendChild(widget);\n\t\tif (this.reg.env.initStates) {\n\t\t\tthis.reg.env.taskEditBroker.dispatchInfo(new InfoChangeTask({reg: this.reg, fieldName: 'init'}), this);\n\t\t}\n\t}\n\n\tasync onWspUriChange(msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') {\n\t\tif (msg.type === EWspChangesEvts.lcSt) return; //un autre event de type update suis derrière... XXX suppr ce double event coté serveur ?\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\tif (SRC.srcRef(longDesc) === SRC.srcRef(msg)) {\n\t\t\tconst ldNew = await this.reg.env.wsp.fetchLongDesc(SRC.srcRef(msg), this);\n\t\t\tif (!this.isConnected) return;\n\t\t\tthis.reg.env.longDesc = ldNew;\n\t\t\tthis.reg.env.taskContent = null;\n\t\t\tthis.shortDescs[0] = ldNew;\n\t\t\tthis.reg.env.longDescChange.emit(ldNew, longDesc);\n\t\t}\n\t}\n\n\n\tonViewBeforeHide(close?: boolean): boolean {\n\t\tif (close) {\n\t\t\tconst editBroker = this.reg.env.taskEditBroker;\n\t\t\tif (editBroker) {\n\t\t\t\tconst st = new InfoReqStateTask();\n\t\t\t\teditBroker.dispatchInfo(st, this);\n\t\t\t\treturn !st.isDirty;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tasync onViewWaitForHide(close?: boolean): Promise<boolean> {\n\t\tif (close) {\n\t\t\tconst editBroker = this.reg.env.taskEditBroker;\n\t\t\tif (editBroker) {\n\t\t\t\tconst st = new InfoReqStateTask();\n\t\t\t\teditBroker.dispatchInfo(st, this);\n\t\t\t\tif (st.isDirty) {\n\t\t\t\t\tif (SRC.isNewSrcUri(this.reg.env.longDesc.srcUri)) {\n\t\t\t\t\t\treturn await POPUP.confirm(\"Voulez-vous vraiment abandonner cette tâche en création ?\", this, {okLbl: \"Abandonner la création\"});\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn await POPUP.confirm(\"Cette tâche est en cours d'édition, voulez-vous vraiment abandonner vos modifications ?\", this, {okLbl: \"Abandonner les modifications\"});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\n\tbuildLastDatas?(parentLastDatas: JLDTaskMain): void {\n\t\tconst editBroker = this.reg.env.taskEditBroker;\n\t\tif (editBroker) {\n\t\t\tconst st = new InfoReqStateTask();\n\t\t\tst.states = {};\n\t\t\teditBroker.dispatchInfo(st, this);\n\t\t\tif (st.isDirty) parentLastDatas.tkSt = st.states;\n\t\t}\n\t\t//console.log(\"TaskMain.buildLastDatas:::\", JSON.stringify(parentLastDatas));\n\t}\n\n}\n\nexport interface JLDTaskMain extends JLastDatas {\n\ttkSt: JTaskStates\n}\n\nREG.reg.registerSkin('wsp-taskmain', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n`);\n\ncustomElements.define('wsp-taskmain', TaskMain);\n\n\n/** Stylage des SubTabs dans l'itemMain. */\nREG.reg.registerSkin('itemMain/c-tabs', 1, /* language=CSS */ `\n\t[hidden] {\n\t\tdisplay: none !important;\n\t}\n\n\t#tabs {\n\t\tjustify-content: center;\n\t\tpadding-top: .5em;\n\t}\n\n\tc-tab {\n\t\tfont-size: var(--label-size);\n\t}\n`);\n\n/** Stylage de chaque Tab des SubTabs dans l'itemMain. */\nREG.reg.registerSkin('itemMain/c-tab', 1, /* language=CSS */ `\n\t.label {\n\t\tflex: 0 1 auto;\n\t}\n`);\n\n/** Interface commune aux containers des ItemMain. */\nexport interface IItemViewer extends IViewApi, IInfoConsumer, IRegPointer<IWspUiEnv> {\n\n\t/**\n\t * Initialisation de l'itemViewer.\n\t * Ne doit être appelé qu'une fois !\n\t *\n\t * @param select srcRef de l'item à sélectionner issu des JWspAppDef (queryString de l'URL). Surcharge les lastDatas.\n\t */\n\tinitViewer(reg: IReg<IWspUiEnv>, mainViewParent: HTMLElement, lastDatas: JLastDatas, select: srcRef): Promise<any>;\n\n\t/**\n\t * Ouvre une source.\n\t * @param silent si false/null et si fallbackOpenSrcRef est null, une notif. sera affichée au user en cas d'erreur (srcRef non trouvé...)\n\t * @return true: ouvert, false: abandon user, null: srcRef non ouvrable.\n\t */\n\topenSrcRef(srcRef: srcRef, silent?: boolean): Promise<boolean | null>\n\n\t/**\n\t *\n\t * @param silent si false/null, une notif. sera affichée au user en cas d'erreur (srcRef non trouvé...)\n\t * @return true: ouvert, null: srcRef pas trouvé.\n\t */\n\tfallbackOpenSrcRef?: (srcRef: srcRef, longdesc: JSrcFields, silent?: boolean) => Promise<true | null>\n}\n\nclass ItemMainRename extends RenameSrc<SrcMain> {\n\n\tasync execute(ctx: SrcMain, ev?: Event): Promise<srcUri[]> {\n\t\tconst newUris = await super.execute(ctx, ev);\n\t\tif (newUris && newUris.length > 0 && ctx.infoBroker) {\n\t\t\t//Pas de possibilité actuellement coté java d'exclure notre clId de la remontée des wspChanges events sur un rename.\n\t\t\t//Donc pas d'autre solution qu'un timeout pour re-sélectionner la cible du renommage.\n\t\t\tsetTimeout(() => {\n\t\t\t\tctx.infoBroker.dispatchInfo(new InfoFocusItem(newUris[0]), ctx);\n\t\t\t}, 300);\n\t\t}\n\t\treturn newUris;\n\t}\n}\n\nclass ItemMainMove extends MoveToSrc<SrcMain> {\n\n\tasync execute(ctx: SrcMain, ev?: Event): Promise<srcUri[]> {\n\t\tconst newUris = await super.execute(ctx, ev);\n\t\tif (newUris && ctx.infoBroker) {\n\t\t\t//Pas de possibilité actuellement coté java d'exclure notre clId de la remontée des wspChanges events sur un moveTo.\n\t\t\t//Donc pas d'autre solution qu'un timeout pour re-sélectionner la cible du renommage.\n\t\t\tsetTimeout(() => {\n\t\t\t\tctx.infoBroker.dispatchInfo(new InfoFocusItem(newUris[0]), ctx);\n\t\t\t}, 300);\n\t\t}\n\t\treturn newUris;\n\t}\n}\n\n\nclass ItemMainConverters extends ActionMenu<SrcMain> {\n\tconstructor(converters: IAction<SrcMain>[]) {\n\t\tsuper(\"converters\");\n\t\tthis._label = \"Convertir...\";\n\t\tthis._group = \"edit\";\n\t\tthis._actions = converters;\n\t\tthis._visPerms = \"write.node.convert\";\n\t}\n}\n\nexport async function convertBySwitchTag(ctx: IRegPointer<IItemUiEnv>, props: { tagName: string, tagNs: string, cleanupSchemaItModel?: string }) {\n\tconst env = ctx.reg.env;\n\tconst house = await env.place.getHouse(env.wsp, SRC.srcRef(env.longDesc));\n\tif (house && isHouseUpdatable(ctx, house)) {\n\t\tconst doc = house.getDocumentForSave();\n\t\tconst oldElt = doc.documentElement.firstElementChild;\n\t\tconst newElt = doc.createElementNS(props.tagNs, props.tagName);\n\t\twhile (oldElt.hasChildNodes()) newElt.appendChild(oldElt.firstChild);\n\t\toldElt.replaceWith(newElt);\n\t\treturn saveDoc(ctx, house, doc, props.cleanupSchemaItModel);\n\t}\n}\n\nexport async function convertByXsl(ctx: IRegPointer<IItemUiEnv>, props: { xslPath?: string, xsl: string | XSLTProcessor, cleanupSchemaItModel?: string, xslParams: { name: string, value: string }[] }) {\n\tconst env = ctx.reg.env;\n\tif (!(props.xsl instanceof XSLTProcessor)) {\n\t\tconst dom = props.xsl ? DOM.parseDom(props.xsl, env.resolver) : await ctx.reg.env.itemType.resolvePath(props.xslPath).fetchDom()\n\t\tif (dom.documentElement.firstElementChild.nodeName === \"xsl:output\") {\n\t\t\t// Les noeuds texte peuvent perturber la normalisation wed du flux XML transformé\n\t\t\t// Cas problématique : set d'#element avec des #text entre deux => seul le premier est préservé\n\t\t\tDOM.setAttr(dom.documentElement.firstElementChild, \"indent\", \"no\");\n\t\t}\n\n\t\tprops.xsl = new XSLTProcessor();\n\t\tprops.xsl.importStylesheet(dom);\n\t}\n\tif (props.xsl instanceof XSLTProcessor)\n\t\tprops.xslParams?.forEach((entry) => (props.xsl as XSLTProcessor).setParameter(\"\", entry.name, entry.value));\n\tconst house = await env.place.getHouse(env.wsp, SRC.srcRef(env.longDesc));\n\tif (house && isHouseUpdatable(ctx, house)) {\n\t\tif (props.cleanupSchemaItModel) {\n\t\t\tconst itemType = env.wsp.wspMetaUi.getItemType(props.cleanupSchemaItModel);\n\t\t\tif (itemType) props.xsl.setParameter(\"\", \"targetTagName\", itemType.getTagRoot());\n\t\t}\n\t\treturn saveDoc(ctx, house, DOM.cleanupDom(props.xsl.transformToDocument(house.getDocumentForSave()), true, false, false), props.cleanupSchemaItModel);\n\t}\n}\n\nfunction isHouseUpdatable(ctx: IRegPointer<IItemUiEnv>, house: IWspXmlHouse) {\n\tif (house.lockedBy) {\n\t\tPOPUP.showNotifForbidden(\"Cet item est en cours d'édition, conversion impossible.\", ctx.reg.env.uiRoot);\n\t\treturn false;\n\t}\n\treturn true;\n}\n\nasync function saveDoc(ctx: IRegPointer<IItemUiEnv>, house: IWspXmlHouse, doc: Document, cleanupSchemaItModel?: string, resRef?: srcRef) {\n\tconst wasDirty = house.isDirty;\n\ttry {\n\t\thouse.setDirty(false); //bloque tout save\n\t\tconst env = ctx.reg.env;\n\t\tif (cleanupSchemaItModel) {\n\t\t\tconst targetSchema = await env.wsp.wspMetaUi.getItemType(cleanupSchemaItModel)?.getSchema();\n\t\t\tif (targetSchema) {\n\t\t\t\ttargetSchema.bindToDom(doc).correctDocument({autoMutate: true, autoComplete: true, autoCleanup: true, autoNormXml: true, autoNormChars: true})\n\t\t\t\ttargetSchema.fixDocForExport(doc);\n\t\t\t}\n\t\t}\n\t\tconst qs = IO.qs(\"cdaction\", \"PutSrc\", \"param\", env.wsp.code, \"refUri\", resRef || SRC.srcRef(env.longDesc));\n\t\tawait env.wsp.wspServer.config.wspSrcUrl.fetchVoid(qs, {method: \"PUT\", body: DOM.ser(doc, true)});\n\t} finally {\n\t\tif (wasDirty) house.setDirty(true);\n\t}\n}\n\n\nfunction addToBurger(action: IAction<SrcMain>, sortKey?: number) {\n\tREG.reg.addToList(\"actions:item:burger\", action.getId(), 1, action, sortKey);\n}\n\naddToBurger(new ItemMainRename(), 10);\naddToBurger(new ItemMainMove(), 20);\naddToBurger(new ReloadSrc());\naddToBurger(new ExportScar(), 1010);// Après les import/export des resources.\n\n//kill l'action de focus dans le menu hamburger de l'itemMain\nREG.reg.addToList(\"actions:item:burger\", \"focusItem\", 1, null);\n\nif (Desk.electron) {\n\tconst openWidthLOAction = new Action<IRegPointer<IItemUiEnv>>()\n\t\t.setLabel(\"Ouvrir avec LibreOffice\")\n\t\t.setVisible((ctx) => {\n\t\t\tconst {env} = ctx.reg;\n\t\t\treturn env.itemType.matchType(\"application/vnd.oasis.opendocument.text\") === 100\n\t\t\t\t|| env.itemType.matchType(\"application/vnd.oasis.opendocument.spreadsheet\") === 100\n\t\t\t\t|| env.itemType.matchType(\"application/vnd.oasis.opendocument.graphics\") === 100\n\t\t\t\t|| env.itemType.matchType(\"application/vnd.oasis.opendocument.presentation\") === 100\n\t\t\t\t|| env.itemType.matchType(\"application/vnd.oasis.opendocument.formula\") === 100;\n\t\t})\n\t\t.setExecute(async (ctx) => {\n\t\t\tconst {env} = ctx.reg;\n\t\t\tconst url = `${env.wsp.wspServer.config.wspDavUrl}${env.wsp.code}${env.itemType.getMainStreamSrcUri(env.longDesc)}`.replace(\"/web/\", \"/api/\");\n\t\t\tconst openReply = await IO.sendMessage({type: \"client:modules:odEditor:open\", url: encodeURI(url)});\n\t\t\tif (openReply.type == 'error') ERROR.log(openReply.msg);\n\t\t\telse if (openReply.type === \"notFound\") POPUP.showNotifInfo(\"L'éditeur de document 'OpenDocument' (LibreOffice, ...) n'a pu être trouvé.\", env.uiRoot);\n\t\t});\n\n\taddToBurger(openWidthLOAction);\n}\n\n/**\n * Ajoute les listeners pour autoriser le drag et le drop d'un fichier sur une srcView\n *\n * Remarque : le plugin PDF natif de Chrome intercepte les évènements de drag\n *\n * @param reg\n * @param srcView Le widget à augmenté avec le drop, doit avoir un shadow attaché\n * @param callback Fonction a appelé sur le drop, remplace le flux principal si non précisé\n *\n */\nexport function installSrcViewFileDrop(reg: IReg<IItemUiEnv>, srcView: BaseElement, callback?: (entry: DataTransferItem) => void) {\n\treg.installSkin(\"srcview/filedrop\", srcView.shadowRoot);\n\n\tconst {env} = reg;\n\n\tconst dropLayer = <div class=\"fileDropLayer\">Importez le fichier en le déposant ici.</div>;\n\n\tsrcView.addEventListener('dragenter', function (ev: DragEvent) {\n\t\tconst item = ev.dataTransfer.items[0];\n\t\tif (item && item.kind == 'file' && env.itemType.matchType(item.type) > 1) {\n\t\t\tthis.shadowRoot.appendChild(dropLayer);\n\t\t}\n\t});\n\n\tsrcView.addEventListener('dragover', function (ev: DragEvent) {\n\t\tif (dropLayer.isConnected) {\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\t\t}\n\t});\n\n\tsrcView.addEventListener('dragleave', function () {\n\t\tif (dropLayer.isConnected) this.shadowRoot.removeChild(dropLayer);\n\t});\n\n\tsrcView.addEventListener('drop', async function (ev: DragEvent) {\n\t\tthis.shadowRoot.removeChild(dropLayer);\n\t\tconst item = ev.dataTransfer.items[0];\n\t\tif (callback) {\n\t\t\tcallback(item);\n\t\t} else {\n\t\t\tconst progress = POPUP.showProgress(srcView, \"Import en cours...\");\n\t\t\ttry {\n\t\t\t\tawait ITEM.update(env.wsp, env.uiRoot, SRC.srcRef(env.longDesc), item.getAsFile(), progress.progressCallback);\n\t\t\t\tprogress.close();\n\t\t\t} catch (e) {\n\t\t\t\tprogress.close();\n\t\t\t\tawait ERROR.report(\"Une erreur est survenue lors de l'import de la ressource.\", e, reg);\n\t\t\t}\n\t\t}\n\t});\n}\n\n\nREG.reg.registerSkin('srcview/filedrop', 1, /* language=CSS */ `\n\t:host {\n\t\tposition: relative;\n\t}\n\n\t.fileDropLayer {\n\t\tposition: absolute;\n\t\tdisplay: flex;\n\t\tjustify-content: center;\n\t\talign-items: center;\n\t\tfont-size: 2em;\n\t\ttop: 0;\n\t\tbottom: 0;\n\t\tleft: 0;\n\t\tright: 0;\n\t\tbackground-color: rgba(255, 255, 255, 0.6);\n\t}\n`);\n\n"]}