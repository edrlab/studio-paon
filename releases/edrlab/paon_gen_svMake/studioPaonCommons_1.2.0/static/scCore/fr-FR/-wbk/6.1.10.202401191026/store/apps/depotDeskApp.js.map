{"version":3,"sources":["/@back@/store/apps/depotDeskApp.tsx"],"names":["BaseElementAsync","MsgLabel","REG","DOMSH","InfoBrokerBasic","InfoCurrentRes","InfoFocusRes","VIEWS","Tabs","EWsState","DepotDeskApp","[object Object]","init","this","appDef","universe","reg","env","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","setAttribute","getName","auth","currentUser","appendChild","setStandardMsg","newDepotUiReg","infoBroker","addConsumer","_a","wsFrames","ws","wsState","wsOpened","_b","startWs","boards","length","dptPath","v","view","initialize","areas","areasContext","skinOver","lastDatas","_c","board","lastDatasKey","initializedAsync","loadBody","onViewShown","onAppDefChange","def","initialized","then","closed","onContainerHidden","close","dispatchInfo","info","resPath","dispatchEvent","CustomEvent","bubbles","detail","revertable","onInfo","visitor","options","Promise","resolve","undefined","registerSkin","customElements","define"],"mappings":"OAAQA,iBAAkBC,aAAwB;OAGvBC,QAAI;OACvBC,UAAM;OAGgBC,oBAAgB;OACtCC,eAAgBC,iBAAa;OAEaC,UAAM;OACvCC,SAAK;;OAGdC,aAAS;OAmBX,MAAOC,qBAAqBV,iBAQvBW,kBAAkBC;AAC3BC,KAAKC,OAASF,KAAKE;AACnB,MAAMC,SAAWH,KAAKI,IAAIC,IAAIF;AAC9B,MAAMG,GAAKL,KAAKM,aAAahB,MAAMiB;AACnCP,KAAKQ,oBAAoBR,KAAKS,UAAWV;AAEzCC,KAAKU,aAAa,QAASR,SAASS;AAEpC,IAAKT,SAASU,KAAKC,YAAa,CAC/BR,GAAGS,aAAY,IAAI1B,UAAW2B,eAAe;AAC7C,OAEDf,KAAKG,IAAMD,SAASc,cAAchB;AAClCA,KAAKG,IAAIC,IAAIa,WAAa,IAAI1B;AAC9BS,KAAKG,IAAIC,IAAIa,WAAWC,YAAYlB;AAQpC,KAAImB,GAAAjB,SAASkB,YAAQ,MAAAD,UAAA,OAAA,EAAAA,GAAEE,GAAGC,WAAY1B,SAAS2B,gBAAgBC,GAAAtB,SAASkB,YAAQ,MAAAI,UAAA,OAAA,EAAAA,GAAEH,GAAGI;AAErF,GAAI1B,KAAK2B,OAAOC,OAAS,EAAG,CAC3B,GAAI3B,KAAKC,OAAO2B,SAAW,KAAM,EAGjC,MAAMC,EAAI7B,KAAK8B,MAAO,IAAInC,MAAiCoC,WAAW,CACrE5B,IAAKH,KAAKG,IACV6B,MAAOjC,KAAK2B,OACZO,aAAcjC,KACdkC,SAAU,2BACVC,WAAWC,GAAArC,KAAKoC,aAAS,MAAAC,UAAA,OAAA,EAAAA,GAAEC,MAC3BC,aAAc;MAETT,EAAEU;AACRlC,GAAGS,YAAYe,OACT,CACN7B,KAAK8B,KAAOzB,GAAGS,kBAAkBf,KAAK2B,OAAO,GAAGc,SAASxC,KAAMD,KAAKoC,YAErEzC,MAAM+C,YAAYzC,KAAK8B;AACvB9B,KAAK0C,iBAGN5C,aAAa6C,KACZ,GAAI3C,KAAKC,SAAW0C,IAAK,OAAO;AAChC3C,KAAKC,OAAS0C;AACd,GAAI3C,KAAK4C,YAAa,CACrB5C,KAAK0C,qBACC,CACN1C,KAAKuC,iBAAiBM,KAAK,IAAM7C,KAAK0C,kBAEvC,OAAO,KAGR5C,aAAagD;AACZ,IACCpD,MAAMqD,kBAAkB/C,KAAM8C,gBAE9B,GAAIA,QAAQ3B,GAAAnB,KAAKG,OAAG,MAAAgB,UAAA,OAAA,EAAAA,GAAE6B,SAIdlD,iBAETE,KAAKG,IAAIC,IAAIa,WAAWgC,aAAa,IAAIxD,aAAaO,KAAKC,OAAO2B,SAAU5B,MAG7EF,OAAOoD,MACN,GAAIlD,KAAK4C,YAAa,CACrB,GAAIM,gBAAgB1D,eAAgB,CACnC,GAAI0D,KAAKC,SAAWnD,KAAKC,OAAO2B,QAAS,CACxC5B,KAAKC,OAAO2B,QAAUsB,KAAKC;AAC3BnD,KAAKoD,cAAc,IAAIC,YAAY,kBAAmB,CAACC,QAAS,KAAMC,OAAQ,CAACC,WAAY,eAIvF,CACNxD,KAAKuC,iBAAiBM,KAAK,IAAM7C,KAAKyD,OAAOP,QAI/CpD,WAAW4D,SACV,GAAI1D,KAAK8B,KAAM,OAAO4B,QAAQ1D,KAAK8B,MAGpChC,gBAAgB4D,QAAwCC,SACvD,OAAO3D,KAAK8B,KAAO4B,QAAQ1D,KAAK8B,MAAQ8B,QAAQC,QAAQC,YAS1DzE,IAAIc,IAAI4D,aAAa,sBAAuB,EAAsB;AAclE1E,IAAIc,IAAI4D,aAAa,2BAA4B,EAAsB;AAUvEC,eAAeC,OAAO,sBAAuBpE","sourcesContent":["import {BaseElementAsync, MsgLabel, OSkinableInit} from \"back/commons/basis\";\nimport {IApp, IAppCtx} from \"back/core/appFrame\";\nimport {JSX} from \"lib/commons/xml/dom\";\nimport {IReg, IRegPointer, REG} from \"lib/commons/registry\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IDepotEnv, IDepotUiEnv} from \"lib/store/depot\";\nimport {JDepotDeskAppDef} from \"back/store/plugins/depotPlg\";\nimport {IInfo, IInfoConsumer, InfoBrokerBasic} from \"lib/commons/infos\";\nimport {InfoCurrentRes, InfoFocusRes} from \"lib/store/res\";\nimport {IArea} from \"lib/commons/areas\";\nimport {IView, IViewContainer, OViewVisitOptions, VIEWS} from \"lib/commons/views\";\nimport {JLDTabs, Tabs} from \"back/commons/widgets/tabs\";\nimport {JLastDatas} from \"lib/commons/lastDatas\";\nimport \"back/core/zones/webZones\";\nimport {EWsState} from \"lib/core/universe\";\n\n/**\n * App de dépot de type Desk.\n *\n */\nexport interface DepotDeskApp extends BaseElementAsync {\n\tinitialize(init: ODepotDeskAppInit): this;\n}\n\nexport interface ODepotDeskAppInit extends IAppCtx<IDepotUiEnv>, OSkinableInit {\n\treg?: IReg<IDepotEnv>\n\n\t/** Onglets à afficher. */\n\tboards: IArea<IRegPointer<IDepotUiEnv>>[]\n\n\tlastDatas: JLDDepotDeskApp\n}\n\nexport class DepotDeskApp extends BaseElementAsync implements IApp<IDepotUiEnv>, IInfoConsumer, IViewContainer {\n\n\tappDef: JDepotDeskAppDef;\n\n\treg: IReg<IDepotUiEnv>;\n\n\tview: IView;\n\n\tprotected async _initialize(init: ODepotDeskAppInit) {\n\t\tthis.appDef = init.appDef as JDepotDeskAppDef;\n\t\tconst universe = init.reg.env.universe;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tthis.setAttribute(\"label\", universe.getName());\n\n\t\tif (!universe.auth.currentUser) {\n\t\t\tsr.appendChild(new MsgLabel().setStandardMsg('needAuth'));\n\t\t\treturn; //throw Error(\"Auth required\");\n\t\t}\n\t\tthis.reg = universe.newDepotUiReg(this);\n\t\tthis.reg.env.infoBroker = new InfoBrokerBasic();\n\t\tthis.reg.env.infoBroker.addConsumer(this);\n\n\t\t//TODO Check perm pour cette ihm.\n\t\t// if (!this.reg.hasPerm(\"ui.depotDeskApp\")) {\n\t\t// \tsr.appendChild(new MsgLabel().setStandardMsg('accessDenied'));\n\t\t// \treturn;\n\t\t// }\n\n\t\tif (universe.wsFrames?.ws.wsState !== EWsState.wsOpened) await universe.wsFrames?.ws.startWs();\n\n\t\tif (init.boards.length > 1) {\n\t\t\tif (this.appDef.dptPath != null) {\n\t\t\t\t//TODO trouver le 1er board qui peut afficher une ressource : impl IResViewable ?\n\t\t\t}\n\t\t\tconst v = this.view = new Tabs<IRegPointer<IDepotUiEnv>>().initialize({\n\t\t\t\treg: this.reg,\n\t\t\t\tareas: init.boards,\n\t\t\t\tareasContext: this,\n\t\t\t\tskinOver: 'store-depotdesk-app/tabs',\n\t\t\t\tlastDatas: init.lastDatas?.board,\n\t\t\t\tlastDatasKey: \"board\"\n\t\t\t});\n\t\t\tawait v.initializedAsync;\n\t\t\tsr.appendChild(v);\n\t\t} else {\n\t\t\tthis.view = sr.appendChild(await init.boards[0].loadBody(this, init.lastDatas));\n\t\t}\n\t\tVIEWS.onViewShown(this.view); //FIXME est onViewShown() appelé par le Desk. Revoir logique d'init et synchro de l'appDef entre les != boards.\n\t\tthis.onAppDefChange();\n\t}\n\n\tupdateAppDef(def: JDepotDeskAppDef): boolean {\n\t\tif (this.appDef === def) return true; //chgt issu d'ici\n\t\tthis.appDef = def;\n\t\tif (this.initialized) {\n\t\t\tthis.onAppDefChange();\n\t\t} else {\n\t\t\tthis.initializedAsync.then(() => this.onAppDefChange());\n\t\t}\n\t\treturn true;\n\t}\n\n\tonViewHidden(closed?: boolean) {\n\t\ttry {\n\t\t\tVIEWS.onContainerHidden(this, closed);\n\t\t} finally {\n\t\t\tif (closed) this.reg?.close();\n\t\t}\n\t}\n\n\tprotected onAppDefChange() {\n\t\t//TODO switch board (browse/search...)\n\t\tthis.reg.env.infoBroker.dispatchInfo(new InfoFocusRes(this.appDef.dptPath), this);\n\t}\n\n\tonInfo(info: IInfo): void {\n\t\tif (this.initialized) {\n\t\t\tif (info instanceof InfoCurrentRes) {\n\t\t\t\tif (info.resPath != this.appDef.dptPath) {\n\t\t\t\t\tthis.appDef.dptPath = info.resPath;\n\t\t\t\t\tthis.dispatchEvent(new CustomEvent('c-appdef-change', {bubbles: true, detail: {revertable: true}}));\n\t\t\t\t}\n\t\t\t\t//this._refreshTitle(shortDesc ? ITEM.getSrcMainName(this.reg, shortDesc, this.wsp.wspMetaUi) : null);\n\t\t\t}\n\t\t} else {\n\t\t\tthis.initializedAsync.then(() => this.onInfo(info));\n\t\t}\n\t}\n\n\tvisitViews(visitor: (view: IView) => any): any {\n\t\tif (this.view) return visitor(this.view);\n\t}\n\n\tvisitViewsAsync(visitor: (view: IView) => Promise<any>, options?: OViewVisitOptions): Promise<any> {\n\t\treturn this.view ? visitor(this.view) : Promise.resolve(undefined);\n\t}\n}\n\n\nexport interface JLDDepotDeskApp extends JLastDatas {\n\tboard?: JLDTabs\n}\n\nREG.reg.registerSkin('store-depotdesk-app', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: row;\n\t}\n\n\tc-tabs {\n\t\tflex: 1;\n\t}\n`);\n\nREG.reg.registerSkin('store-depotdesk-app/tabs', 1, /* language=CSS */ `\n\tc-tab {\n\t\tpadding: .7em !important;\n\t}\n\n\t#panels {\n\t\tborder: none;\n\t\tborder-top: solid 1px var(--border-color);\n\t}\n`);\ncustomElements.define('store-depotdesk-app', DepotDeskApp);\n"]}