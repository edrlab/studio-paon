{"version":3,"sources":["/@back@/wsp/actions/versActions.tsx"],"names":["POPUP","IO","SrcAction","REG","ERROR","CreateVersion","[object Object]","id","super","this","_label","_group","_enableSrcPerms","isBackendDb","exactOne","ctx","item","shortDescs","srcLiveUri","isVisible","ev","comment","prompt","emitter","undefined","wsp","universe","reg","env","wspServer","config","versionUrl","fetchVoid","qs","code","srcUri","versions","fetchJson","lastVersLabel","vers","srcVersLabel","showNotifInfo","e","report","SINGLETON","registerSvc"],"mappings":"OACQA,UAAM;OACNC,OAAG;OACHC,cAAU;OACVC,QAAI;OACJC,UAAM;OAWR,MAAOC,sBAA+CH,UAG3DI,YAAYC,IACXC,MAAMD,IAAM;AACZE,KAAKC,OAAS;AACdD,KAAKE,OAAS;AACdF,KAAKG,gBAAkB,CAAC;AACxBH,KAAKI,YAAc;AACnBJ,KAAKK,SAAW,KAGjBR,UAAUS,KACT,MAAMC,KAAOD,IAAIE,WAAW;AAC5B,GAAID,KAAKE,WAAY,OAAO;AAC5B,OAAOV,MAAMW,UAAUJ,KAGxBT,cAAcS,IAAQK,IACrB,MAAMC,cAAgBrB,MAAMsB,OAAO,+CAAgDP,IAAIQ;AACvF,GAAIF,UAAYG,UAAW,CAC1B,MAAMC,IAAEA,IAAGC,SAAEA,UAAaX,IAAIY,IAAIC;AAClC,MAAMZ,KAAOD,IAAIE,WAAW;AAC5B,UACOS,SAASG,UAAUC,OAAOC,WAAWC,UAAU/B,GAAGgC,GACvD,WACA,SACA,QACAR,IAAIS,KACJ,SACAlB,KAAKmB,OACL,UACAd;AAGD,MAAMe,eAAiBV,SAASG,UAAUC,OAAOC,WAAWM,UAAoCpC,GAAGgC,GAClG,WACA,OACA,QACAR,IAAIS,KACJ,SACAlB,KAAKmB,OACL,SACA;AAED,MAAMG,cAAgBF,SAASG,KAAK,GAAGC;AACvCxC,MAAMyC,cAAc,eAAeH,6BAA8BvB,IAAIQ,SACpE,MAAOmB,SACFtC,MAAMuC,OAAO,+DAAgED,EAAG3B,QA/ClFV,cAAAuC,UAAY,IAAIvC;AAqDxBF,IAAIwB,IAAIkB,YAAY,2BAA4B,EAAGxC,cAAcuC","sourcesContent":["import {IShortDescCtx} from \"lib/wsp/item\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {IO} from \"lib/commons/io/io\";\nimport {SrcAction} from \"back/wsp/actions/srcActions\";\nimport {REG} from \"lib/commons/registry\";\nimport {ERROR} from \"lib/core/errorReport\";\n\ninterface JVersionData {\n\tsrcUri?: string;\n\tsrcDt?: string;\n\tsrcVersLabel?: string;\n\tsrcVersBy?: string;\n\tsrcVersComment?: string;\n}\n\n/** Crée une version */\nexport class CreateVersion<C extends IShortDescCtx> extends SrcAction<C> {\n\tstatic SINGLETON = new CreateVersion();\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"createVersion\");\n\t\tthis._label = \"Créer une version...\";\n\t\tthis._group = \"versions\";\n\t\tthis._enableSrcPerms = [\"action.vers#create.version\"];\n\t\tthis.isBackendDb = true;\n\t\tthis.exactOne = true;\n\t}\n\n\tisVisible(ctx: C): boolean {\n\t\tconst item = ctx.shortDescs[0];//mode exactOne\n\t\tif (item.srcLiveUri) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tasync execute(ctx: C, ev?: Event) {\n\t\tconst comment = await POPUP.prompt(\"Entrez un commentaire pour cette version :\", ctx.emitter);\n\t\tif (comment !== undefined) {\n\t\t\tconst { wsp, universe } = ctx.reg.env;\n\t\t\tconst item = ctx.shortDescs[0];//mode exactOne\n\t\t\ttry {\n\t\t\t\tawait universe.wspServer.config.versionUrl.fetchVoid(IO.qs(\n\t\t\t\t\t\"cdaction\",\n\t\t\t\t\t\"Create\",\n\t\t\t\t\t\"param\",\n\t\t\t\t\twsp.code,\n\t\t\t\t\t\"refUri\",\n\t\t\t\t\titem.srcUri,\n\t\t\t\t\t\"comment\",\n\t\t\t\t\tcomment\n\t\t\t\t));\n\n\t\t\t\tconst versions = await universe.wspServer.config.versionUrl.fetchJson<{ vers: JVersionData[] }>(IO.qs(\n\t\t\t\t\t\"cdaction\",\n\t\t\t\t\t\"List\",\n\t\t\t\t\t\"param\",\n\t\t\t\t\twsp.code,\n\t\t\t\t\t\"refUri\",\n\t\t\t\t\titem.srcUri,\n\t\t\t\t\t\"fields\",\n\t\t\t\t\t\"srcVersLabel\"\n\t\t\t\t));\n\t\t\t\tconst lastVersLabel = versions.vers[0].srcVersLabel;\n\t\t\t\tPOPUP.showNotifInfo(`La version ${lastVersLabel} a été crée.`, ctx.emitter);\n\t\t\t} catch (e) {\n\t\t\t\tawait ERROR.report(\"Une erreur est survenue lors de la création de la version.\", e, ctx);\n\t\t\t}\n\t\t}\n\t}\n}\n\nREG.reg.registerSvc('vers/createVersionAction', 1, CreateVersion.SINGLETON);"]}