{"version":3,"sources":["/@back@/styler/widgets/wed/decor/decorPreviewStyle.tsx"],"names":["findElementWedlet","ENodeType","REG","XA","WSP","DecorPreviewIFrame","DecorPreviewIframeWedlet","isWedletSingleElt","DOMSH","isEltBoxSelection","DecorPreviewStyle","[object Object]","this","global","tpl","wedlet","super","configWedletElt","hasAttribute","wedMgr","rootWedlet","_onFocus","onFocus","bind","listeners","on","sr","shadowRoot","reg","installSkin","removeListener","key","returnDefault","fromRoot","docHolder","propsWdl","findPropertyWdlNode","isVirtual","node","findDomLast","wedAnchor","getDocument","nodeType","element","getItemStreamUrl","getAttribute","textContent","focusElt","elt","findFlatParentEltOrSelf","wedEditor","rootNode","n","stopBoxSelection","isConnected","win","previewFrame","contentWindow","focusOnProperty","focus","refUri","transform","sd","env","wsp","fetchShortDesc","itemType","wspMetaUi","getItemType","itModel","getStreamUrl","getMainStreamSrcUri","url","querySelector","selectedNode","_a","wedParent","_b","registerSkin","window","customElements","define"],"mappings":"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","sourcesContent":["import {findElementWedlet, IElementWedlet, IWedlet} from \"back/edit/wed/wedlets/wedlet\";\nimport {ENodeType, JSX} from \"lib/commons/xml/dom\";\nimport {IReg, IUiEnv, REG} from \"lib/commons/registry\";\nimport {XA} from \"lib/commons/xml/xAddr\";\nimport {srcRef} from \"lib/wsp/src\";\nimport {WSP} from \"lib/wsp/wsp\";\nimport {IItemUiEnv} from \"back/wsp/views/itemMain\";\nimport {DecorPreviewIFrame, DecorPreviewIframeWedlet, IDecorPreviewFragParentFrame, IWindowPreviewFrag} from \"back/edit/wed/wedlets/decor/decorPreviewIFrame\";\nimport {isWedletSingleElt} from \"back/edit/wed/wedlets/wedletSingleElt\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {WedMgr} from \"back/edit/wed/wedEditor\";\nimport {IBoxStopSelection, isEltBoxSelection} from \"back/edit/wed/features/boxSel\";\n\n/**\n * Edition de skin : widget d'affichage d'une zone de previsualisation de styles\n *\n * Attributs :\n * \thref=\"xxx.xhtml\"\n * \tglobal?=\"true\"\n */\nclass DecorPreviewStyle extends DecorPreviewIFrame implements IElementWedlet, IDecorPreviewStyleParentFrame {\n\n\tprotected reg: IReg<IUiEnv & IItemUiEnv>;\n\n\tprotected global = false;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet): void {\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t\tthis.global = this.hasAttribute(\"global\");\n\t\tthis.wedlet = new DecorPreviewIframeWedlet(this, this.global ? wedlet.wedMgr.rootWedlet : wedlet);\n\n\t\tthis._onFocus = this.onFocus.bind(this);\n\t\twedlet.wedMgr.listeners.on(\"getFocus\", this._onFocus);\n\n\n\t\tconst sr = this.shadowRoot;\n\t\tREG.reg.installSkin(\"decor-preview-iframe\", sr);\n\t}\n\n\tdisconnectedCallback(): void {\n\t\tthis.wedlet.wedMgr.listeners.removeListener(\"getFocus\", this._onFocus);\n\t}\n\n\tasync getPropertyValue(key: string, returnDefault = true, fromRoot?: boolean): Promise<any> {\n\t\tconst wedMgr = this.wedlet.wedMgr;\n\t\tconst docHolder = wedMgr.docHolder;\n\t\tif (fromRoot == null) fromRoot = this.global;\n\t\tconst propsWdl = this.findPropertyWdlNode(key, fromRoot);\n\t\tif (propsWdl) {\n\t\t\tif (!propsWdl.wedlet.isVirtual() && isWedletSingleElt(propsWdl.wedlet)) {\n\t\t\t\tconst node: Node = XA.findDomLast(propsWdl.wedlet.wedAnchor, docHolder.getDocument());\n\t\t\t\tif (node?.nodeType === ENodeType.element) {\n\t\t\t\t\tif ((node as Element).hasAttribute(\"sc:refUri\"))\n\t\t\t\t\t\treturn await this.getItemStreamUrl((node as Element).getAttribute(\"sc:refUri\"));\n\t\t\t\t\telse return (node as Element).textContent;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Valeur par défaut\n\t\t\treturn propsWdl.getAttribute(\"styler-default-value\");\n\t\t}\n\t}\n\n\tonFocus(this: DecorPreviewIFrame, wedMgr: WedMgr, focusElt: Element) {\n\t\tconst elt = DOMSH.findFlatParentEltOrSelf(focusElt, wedMgr.wedEditor.rootNode, (n: Node): n is Element => isEltBoxSelection(n) || (n as IBoxStopSelection).stopBoxSelection);\n\t\tif (elt?.isConnected) {\n\t\t\tconst win = this.previewFrame.contentWindow as IWindowPreviewStyleFrag;\n\t\t\tif (win?.focusOnProperty) win.focusOnProperty(elt.getAttribute(\"styler-property-key\"));\n\t\t}\n\n\t}\n\n\tprivate _onFocus: any\n\n\tfocusOnProperty(key: string, fromRoot = false) {\n\t\tconst propsWdl = this.findPropertyWdlNode(key, fromRoot);\n\t\tif (propsWdl) propsWdl.focus();\n\t}\n\n\tprivate async getItemStreamUrl(refUri: srcRef, transform?: string): Promise<string | null> {\n\t\tif (!refUri) return;\n\t\tconst sd = await this.reg.env.wsp.fetchShortDesc(refUri);\n\t\tif (!sd) return;\n\t\tconst itemType = this.reg.env.wsp.wspMetaUi.getItemType(sd.itModel);\n\t\treturn itemType ? WSP.getStreamUrl(this.reg.env.wsp, itemType.getMainStreamSrcUri(sd)).url : null;\n\t}\n\n\tprivate findPropertyWdlNode(key: string, fromRoot = false): IElementWedlet {\n\t\tconst wedMgr = this.wedlet.wedMgr;\n\t\tconst querySelector = `*[styler-property-key=\"${key}\"]`;\n\t\tif (!key) return;\n\t\tif (fromRoot) {\n\t\t\tconst rootWedlet = wedMgr.rootWedlet;\n\t\t\tif (isWedletSingleElt(rootWedlet)) {\n\t\t\t\tlet selectedNode: Node = rootWedlet.element.querySelector(querySelector);\n\t\t\t\tif (!selectedNode)\n\t\t\t\t\tselectedNode = rootWedlet.element.shadowRoot?.querySelector(querySelector);\n\t\t\t\treturn selectedNode ? findElementWedlet(selectedNode, false) : null;\n\t\t\t}\n\t\t} else {\n\t\t\tlet wedlet: IWedlet = this.wedlet;\n\t\t\twhile (wedlet && !isWedletSingleElt(wedlet)) wedlet = wedlet.wedParent;\n\t\t\tif (isWedletSingleElt(wedlet)) {\n\t\t\t\tlet selectedNode: Node = wedlet.element?.querySelector(querySelector);\n\t\t\t\treturn findElementWedlet(selectedNode, false);\n\t\t\t}\n\t\t}\n\t}\n\n}\n\nREG.reg.registerSkin('decor-styler-preview-styles', 1, /* language=CSS */ `\n\n`);\n\nwindow.customElements.define(\"decor-styler-preview-styles\", DecorPreviewStyle);\n\n\n/**\n * Contexte parent des pages du dynGen, fournit à la page du dynGen\n * via IWindowDynGen.initParentFrame(parentFrame: IDynGenParentFrame)\n */\ninterface IDecorPreviewStyleParentFrame extends IDecorPreviewFragParentFrame {\n\n\t/** Déplace le focus sur une propriété donnée */\n\tfocusOnProperty(key: string, fromRoot?: boolean): void\n\n\t/** Retourne la valeur d'une propriété donnée */\n\tgetPropertyValue(key: string, returnDefault?: boolean, fromRoot?: boolean): Promise<any>\n\n\t/** Retourne une URL en fonction d'une refUri passée en paramètre */\n\t//getItemStreamUrl(refUri: srcRef, transform?: string): Promise<string | null>\n\n}\n\n/**\n * API à implémenter par les pages fournies par le decorPreviewIFrame.\n */\nexport interface IWindowPreviewStyleFrag extends IWindowPreviewFrag {\n\n\t/** Appelé lors d'un changement de focus */\n\tfocusOnProperty?(propertyKey?: String | null): void\n\n}\n\n"]}