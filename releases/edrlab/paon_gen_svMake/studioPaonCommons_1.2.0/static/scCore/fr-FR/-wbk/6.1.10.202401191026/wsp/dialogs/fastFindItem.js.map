{"version":3,"sources":["/@back@/wsp/dialogs/fastFindItem.tsx"],"names":["BaseElement","BASIS","Grid","POPUP","GridColTreeDef","SpaceTreeDataSearch","LANG","REG","DOM","JSX","DOMSH","ITEM","SRC","CellBuilderSrcIconCodeTitle","SearchItems","SubItemsTree","FastFindItem","[object Object]","this","subItemsFirstShown","init","uiContext","ev","ct","initialize","popup","subItemsFind","MouseEvent","showMenuFromEvent","initMaxHeight","initWidth","showMenu","viewPortY","wsp","reg","env","uriFilter","search","value","findReg","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","title","appendChild","createElement","id","head","type","spellCheck","onchange","onSearchChange","oninput","onkeydown","onKeydown","itemCreator","ui-context","icon","onclick","createItem","datasSearch","srcFilter","request","ReqFastFind","initReq","getShortDescDef","restrictions","initSpTrDataSearch","callbackSearching","hideItemFolderContent","colDefs","setFlex","setCellBuilder","wspMetaUi","srcUriItemsSortFn","grid","selType","columnDefs","dataHolder","hideHeaders","emptyBody","isAvailable","waitForAvailable","EMPTY_LOADING","cloneNode","EMPTY_FILTERED","EMPTY_NORESULT","skinScroll","uiEvents","on","row","onSelect","rowDatas","addEventListener","me","findHost","key","getRow","getSelectedRow","_a","focus","subItInit","Object","create","textFilter","assign","subItTree","onSelectSubItem","item","srcUri","showSubItemsTree","hidden","updateParams","fetchSearchStart","h","clientHeight","style","flexBasis","Math","max","setHidden","findPopupableParent","eltForMove","height","updatePosition","offsetHeight","setSubItems","ensureRowVisible","src","getSrcUriType","findRowKeyBySrcUri","toggleFolder","srcRef","fetchShortDescSubItems","then","srcSubIt","subModelPattern","test","itSgn","close","subIt","mo","result","itSubItem","ti","state","internalResizeFreeze","undefined","firstItem","findVisibleData","itModel","setSelectedRows","getOffset","countRows","toSel","currSel","preventDefault","stopImmediatePropagation","self","ItemCreator","import","conf","newInit","nameBuilder","nameInput","filterPartUri","shortDesc","openCreateItem","onNextClose","registerSkin","customElements","define","_stamp","fields","uriRoot","mainCrit","excludeTildeRoot","excludeAirItems","includeDrfErased","wspDefProps","drfRefWsp","_req","asXml","Array","isArray","map","f","dataKey","dataKeys","toDom","_itemsExp","querySelector","setAttribute","_restrictionExp","nextElementSibling","_selectReq","firstElementChild","params","newTxt","toLowerCase","_textToSearch","toString","removeAttribute","next","remove","crit","parseTextToSearch","after","appendExp","text","texts","escape4RegexpFuzzy","sp","spaces","ser","afterSrcUri","folderUri","path","stamp","t","findAfter","exec","days","Number","parseInt","d","Date","setTime","getTime","setHours","substring","index","length","replace","fragments","split","i","frag","findSlash","push","atts","exp","ownerDocument","parentElement","insertBefore"],"mappings":"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","sourcesContent":["import {BaseElement, BASIS, OSkinableInit, PickInit} from \"back/commons/basis\";\nimport {Button} from \"back/commons/widgets/buttons\";\nimport {GridDataRowJson} from \"back/commons/widgets/grid-libs\";\nimport {Grid} from \"back/commons/widgets/grid-tags\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {GridColTreeDef} from \"back/commons/widgets/tree\";\nimport {ItemCreator, OItemCreatorInit} from \"back/wsp/dialogs/itemCreator\";\nimport {ISpaceTreeReq, SpaceTreeDataSearch} from \"back/wsp/views/spaceTree\";\nimport {LANG} from \"lib/commons/lang\";\nimport {IReg, REG} from \"lib/commons/registry\";\nimport {IView} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {ITEM} from \"lib/wsp/item\";\nimport {ESrcField, JSrcFields, JSrcFieldsTree, SRC, srcUri} from \"lib/wsp/src\";\nimport {IWspUiEnv, Wsp} from \"lib/wsp/wsp\";\nimport {CellBuilderSrcIconCodeTitle} from \"back/wsp/widgets/srcGridColumns\";\nimport {ISearchCrit, SearchItems} from \"lib/wsp/search\";\nimport {ISubItemTree, OSubItemsTreeInit, SubItemsTree} from \"back/wsp/widgets/subItemsTree\";\nimport {IPopupable} from \"back/commons/widgets/popupable\";\n\n/**\n *\n */\nexport interface FastFindItem extends BaseElement, IView {\n\tinitialize(init: OFastFindItemsInit): this\n}\n\nexport interface OFastFindItemsInit extends OSkinableInit, PickInit<FastFindItem, 'itemCreator'> {\n\treg?: IReg<IWspUiEnv>\n\n\ttitle?: string\n\n\t/**\n\t * Restrictions intégrées dans la requete.\n\t */\n\trestrictions?: ISearchCrit\n\n\t/** Restreint l'affichage aux noeuds respectant ce filtre. */\n\tsrcFilter?: (data: JSrcFields) => boolean\n\n\t/** Contenu de la zone principale lorsque la liste est vide. */\n\temptyBody?: Node | (() => Node)\n\n\t/** Config de la recherche de subItems. */\n\tsubItemsFind?: OSubItemsTreeInit\n}\n\nexport class FastFindItem extends BaseElement implements IView {\n\n\t/** Gestion de l'ouverture de la popup en fonction de la présence de subItems. */\n\tstatic openFastFind(init: OFastFindItemsInit, uiContext: HTMLElement, ev?: Event): IPopupable<JSrcFields | null> {\n\t\tconst ct = new FastFindItem().initialize(init);\n\t\tlet popup: IPopupable<JSrcFields | null>;\n\t\tif (init.subItemsFind) {\n\t\t\tif (ev instanceof MouseEvent) {\n\t\t\t\tpopup = POPUP.showMenuFromEvent(ct, ev, uiContext, null, {initMaxHeight: '75vh', initWidth: 'min(50em,75vw)'});\n\t\t\t} else {\n\t\t\t\tpopup = POPUP.showMenu(ct, {viewPortY: 'top', initMaxHeight: '75vh', initWidth: 'min(50em,75vw)'}, uiContext);\n\t\t\t}\n\t\t} else {\n\t\t\tif (ev instanceof MouseEvent) {\n\t\t\t\tpopup = POPUP.showMenuFromEvent(ct, ev, uiContext, null, {initMaxHeight: '50vh', initWidth: 'min(40em,50vw)'});\n\t\t\t} else {\n\t\t\t\tpopup = POPUP.showMenu(ct, {viewPortY: 'top', initMaxHeight: '50vh', initWidth: 'min(40em,50vw)'}, uiContext);\n\t\t\t}\n\t\t}\n\t\treturn popup;\n\t}\n\n\t/** Contexte */\n\treg: IReg<IWspUiEnv>;\n\n\t/** Config de l'action de création d'item dans le fastFind. */\n\titemCreator: OItemCreatorInit;\n\n\tget wsp(): Wsp {return this.reg.env.wsp};\n\n\t/** Eléments UI */\n\tgrid: Grid;\n\tsearch: HTMLInputElement;\n\n\trequest: ReqFastFind;\n\tdatasSearch: SpaceTreeDataSearch;\n\n\tsubItTree: SubItemsTree;\n\n\tget uriFilter(): string {return this.search.value}\n\n\tprotected _initialize(init: OFastFindItemsInit) {\n\t\tthis.reg = this.findReg(init);\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tif (init.title) sr.appendChild(<div id=\"title\">{init.title}</div>);\n\t\tconst head = sr.appendChild(<div id=\"head\"/>);\n\t\tthis.search = head.appendChild(<input type=\"search\" spellCheck=\"false\" onchange={this.onSearchChange} oninput={this.onSearchChange} onkeydown={this.onKeydown}/>) as HTMLInputElement;\n\t\tif (init.itemCreator) {\n\t\t\t// NOTE : pas d'évaluation de la perm 'create.item' car la création peut avoir lieu ailleurs que dans le contexte courant\n\t\t\tthis.itemCreator = init.itemCreator;\n\t\t\thead.appendChild(<c-button ui-context=\"bar\" icon=\"/@skin@/wsp/actions/createItem.svg\" title=\"Créer un item...\" onclick={this.createItem}/>);\n\t\t}\n\t\tthis.datasSearch = new SpaceTreeDataSearch(this.reg, '', false, init.srcFilter, null /* les /~ sont gérés par initReq(), dans fastFind, pas de refresh dyn qui exige cohérence avec filter JS */);\n\t\tthis.request = new ReqFastFind(this.wsp).initReq(this.wsp.getShortDescDef(), '', init.restrictions);\n\t\tthis.datasSearch.initSpTrDataSearch(this.request, 20, 30);\n\t\tthis.datasSearch.callbackSearching = this;\n\t\tthis.datasSearch.hideItemFolderContent = true;\n\n\t\tconst colDefs = [new GridColTreeDef('srcTree')\n\t\t\t//.setSortable(true).setDefaultSort(1, 'ascendant') //Incompatible avec fetchSearchNext(). Si besoin, envisager un mode 'noNext' ou tri coté serveur.\n\t\t\t.setFlex('1rem', 1, 1)\n\t\t\t.setCellBuilder(new CellBuilderSrcIconCodeTitle(this.reg, this.wsp.wspMetaUi, false, this.wsp.srcUriItemsSortFn))];\n\n\t\tthis.grid = new Grid().initialize({\n\t\t\tselType: \"monoClick\",\n\t\t\tcolumnDefs: colDefs,\n\t\t\tdataHolder: this.datasSearch,\n\t\t\thideHeaders: true,\n\t\t\temptyBody: init.emptyBody || (() => {\n\t\t\t\tif (!this.wsp.isAvailable) {\n\t\t\t\t\tthis.wsp.waitForAvailable(this);\n\t\t\t\t\treturn EMPTY_LOADING.cloneNode(true);\n\t\t\t\t}\n\t\t\t\treturn this.search.value ? EMPTY_FILTERED.cloneNode(true) : EMPTY_NORESULT.cloneNode(true);\n\t\t\t}),\n\t\t\tskinScroll: \"scroll/small\"\n\t\t});\n\t\tsr.appendChild(this.grid);\n\t\tthis.grid.uiEvents.on('rowClick', (row: GridDataRowJson<JSrcFieldsTree> | null, ev: MouseEvent) => {\n\t\t\tif (row) this.onSelect(row.rowDatas);\n\t\t});\n\n\t\tthis.grid.addEventListener('keypress', function (this: Grid, ev: KeyboardEvent) {\n\t\t\tconst me = DOMSH.findHost<FastFindItem>(this);\n\t\t\tif (ev.key === ' ' || ev.key === 'Enter') {\n\t\t\t\tconst row = this.dataHolder.getRow(this.getSelectedRow()) as GridDataRowJson<JSrcFieldsTree>;\n\t\t\t\tif (row) me.onSelect(row.rowDatas);\n\t\t\t} else me.search?.focus();\n\t\t});\n\n\t\tif (init.subItemsFind) {\n\t\t\tconst subItInit = Object.create(init.subItemsFind) as OSubItemsTreeInit;\n\t\t\tsubItInit.reg = this.reg;\n\t\t\tsubItInit.textFilter = \"\";\n\t\t\tsubItInit.grid = Object.assign(subItInit.grid || {}, {\n\t\t\t\t//selType: \"monoOver\"\n\t\t\t});\n\t\t\tthis.subItTree = new SubItemsTree().initialize(subItInit);\n\t\t\tsr.appendChild(this.subItTree);\n\t\t\tthis.subItTree.grid.uiEvents.on('rowClick', (row: GridDataRowJson<ISubItemTree> | null, ev: MouseEvent) => {\n\t\t\t\tif (row) this.onSelectSubItem(this.subItTree.item, row.rowDatas);\n\t\t\t});\n\t\t\tthis.subItTree.grid.addEventListener('keypress', function (this: Grid, ev: KeyboardEvent) {\n\t\t\t\tconst me = DOMSH.findHost<SubItemsTree>(this);\n\t\t\t\tif (ev.key === ' ' || ev.key === 'Enter') {\n\t\t\t\t\tconst row = this.dataHolder.getRow(this.getSelectedRow()) as GridDataRowJson<ISubItemTree>;\n\t\t\t\t\tif (row) DOMSH.findHost<FastFindItem>(me).onSelectSubItem(me.item, row.rowDatas);\n\t\t\t\t} else me.search.focus();\n\t\t\t});\n\t\t\tthis.grid.addEventListener(\"grid-select\", function (this: Grid) {\n\t\t\t\tconst me = DOMSH.findHost<FastFindItem>(this);\n\t\t\t\tif (!me.subItTree.item) return;\n\t\t\t\t//Des subItems sont affichés.\n\t\t\t\tconst row = this.dataHolder.getRow(this.getSelectedRow()) as GridDataRowJson<JSrcFieldsTree>;\n\t\t\t\tif (row && row.rowDatas.srcUri === me.subItTree.item.srcUri) return;\n\t\t\t\t//Sel modifiée, reset sel fragments.\n\t\t\t\tme.showSubItemsTree(null);\n\t\t\t});\n\t\t\tthis.subItTree.hidden = true;\n\t\t}\n\n\t\tthis.request.updateParams(this);\n\t\tthis.datasSearch.fetchSearchStart();\n\t}\n\n\trefetch() {\n\t\tthis.datasSearch.fetchSearchStart();\n\t}\n\tsubItemsFirstShown=false\n\tshowSubItemsTree(item: JSrcFields | null) {\n\t\tif (item) {\n\t\t\tif(!this.subItemsFirstShown) {\n\t\t\t\tconst h = this.grid.clientHeight;\n\t\t\t\tthis.grid.style.flexBasis = h + \"px\";\n\t\t\t\tthis.subItTree.style.flexBasis = Math.max(250, h) + \"px\";\n\t\t\t\tDOM.setHidden(this.subItTree, false);\n\t\t\t\tconst popup = POPUP.findPopupableParent(this);\n\t\t\t\tif (popup && popup.eltForMove.style.height) {\n\t\t\t\t\tpopup.updatePosition();\n\t\t\t\t\tpopup.eltForMove.style.height = popup.eltForMove.offsetHeight + \"px\";\n\t\t\t\t}\n\t\t\t\tthis.subItemsFirstShown = true;\n\t\t\t} else {\n\t\t\t\tDOM.setHidden(this.subItTree, false);\n\t\t\t}\n\t\t\tthis.subItTree.setSubItems(item);\n\t\t\tthis.subItTree.search.focus();\n\t\t\tthis.grid.ensureRowVisible(this.grid.getSelectedRow());\n\t\t} else {\n\t\t\tDOM.setHidden(this.subItTree, true);\n\t\t\tthis.grid.style.flexBasis = \"auto\";\n\t\t}\n\t}\n\n\tonSelect(src: JSrcFieldsTree) {\n\t\tif (!src) return;\n\t\tif (ITEM.getSrcUriType(src.srcUri) === \"space\") {\n\t\t\tconst row = this.datasSearch.findRowKeyBySrcUri(src.srcUri);\n\t\t\tif (row) this.datasSearch.toggleFolder(row);\n\t\t\treturn;\n\t\t}\n\t\tif (this.subItTree && (!this.subItTree.item || SRC.srcRef(this.subItTree.item) != SRC.srcRef(src))) {\n\t\t\t//En cas de resélection de l'item sélectionné, pas de rafraichissement de la liste des subItems\n\t\t\tthis.wsp.fetchShortDescSubItems(SRC.srcRef(src)).then((srcSubIt: JSrcFields) => {\n\t\t\t\tthis.showSubItemsTree(srcSubIt);\n\t\t\t})\n\t\t} else if (!this.subItTree || !this.subItTree.subModelPattern || this.subItTree.subModelPattern.test(src.itSgn)) {\n\t\t\t//Si le subModelPattern match l'item courant, on retoure l'item courant\n\t\t\tPOPUP.findPopupableParent(this).close(src);\n\t\t}\n\t}\n\n\tonSelectSubItem(item: JSrcFields, subIt: ISubItemTree) {\n\t\tif (!item || !subIt) return;\n\t\tif (!this.subItTree.subModelPattern.test(subIt.mo)) return;\n\t\tif (subIt.id) {\n\t\t\tconst result = Object.create(item) as JSrcFields;\n\t\t\tresult.itSubItem = {id: subIt.id, ti: subIt.ti, mo: subIt.mo};\n\t\t\tPOPUP.findPopupableParent(this).close(result);\n\t\t} else {\n\t\t\tPOPUP.findPopupableParent(this).close(item);\n\t\t}\n\t}\n\n\tprotected onSearchChange(this: HTMLInputElement, ev: Event) {\n\t\tconst me = DOMSH.findHost<FastFindItem>(this);\n\t\tif (me.request.updateParams(me)) me.datasSearch.fetchSearchStart();\n\t}\n\n\tonSearching(state: 'searchInit' | 'searchNext' | 'searchInside' | 'searchEnd') {\n\t\tif (state === \"searchEnd\") {\n\t\t\t//On freeze la taille du fastFind après le 1er affichage.\n\t\t\tconst popup = POPUP.findPopupableParent(this);\n\t\t\tif (popup && !popup.eltForMove.style.height) {\n\t\t\t\tpopup.updatePosition();\n\t\t\t\t//1er affichage, on freeze\n\t\t\t\tpopup.eltForMove.style.height = popup.eltForMove.offsetHeight + \"px\";\n\t\t\t\tpopup.internalResizeFreeze(1);\n\t\t\t}\n\t\t\tif (this.grid.getSelectedRow() === undefined) {\n\t\t\t\t//On sel le 1èr item dès qu'on a un résultat non null.\n\t\t\t\tconst firstItem = this.datasSearch.findVisibleData((src) => src.itModel != null);\n\t\t\t\tif (firstItem) this.grid.setSelectedRows(this.datasSearch.getOffset(firstItem));\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected onKeydown(this: HTMLInputElement, ev: KeyboardEvent) {\n\t\tif (ev.key === \"ArrowDown\") {\n\t\t\tconst grid = DOMSH.findHost<FastFindItem>(this).grid;\n\t\t\tconst countRows = grid.dataHolder.countRows();\n\t\t\tif (countRows > 0) {\n\t\t\t\t//grid.focus();\n\t\t\t\tlet toSel: number;\n\t\t\t\tconst currSel = grid.getSelectedRow();\n\t\t\t\tif (currSel === undefined) toSel = 0;\n\t\t\t\telse if (currSel < countRows - 1) toSel = currSel + 1;\n\t\t\t\tif (toSel !== undefined) {\n\t\t\t\t\tgrid.setSelectedRows(toSel);\n\t\t\t\t\tgrid.ensureRowVisible(toSel);\n\t\t\t\t}\n\t\t\t}\n\t\t\tev.preventDefault();\n\t\t\tev.stopImmediatePropagation();\n\t\t} else if (ev.key === \"ArrowUp\") {\n\t\t\tconst grid = DOMSH.findHost<FastFindItem>(this).grid;\n\t\t\tconst countRows = grid.dataHolder.countRows();\n\t\t\tif (countRows > 0) {\n\t\t\t\tlet toSel: number;\n\t\t\t\tconst currSel = grid.getSelectedRow();\n\t\t\t\tif (currSel > 0) toSel = currSel - 1;\n\t\t\t\tif (toSel !== undefined) {\n\t\t\t\t\tgrid.setSelectedRows(toSel);\n\t\t\t\t\tgrid.ensureRowVisible(toSel);\n\t\t\t\t}\n\t\t\t}\n\t\t\tev.preventDefault();\n\t\t\tev.stopImmediatePropagation();\n\t\t} else if (ev.key === \"Enter\") {\n\t\t\tconst grid = DOMSH.findHost<FastFindItem>(this).grid;\n\t\t\tconst currSel = grid.getSelectedRow();\n\t\t\tif (currSel != undefined) {\n\t\t\t\tconst row = grid.dataHolder.getRow(currSel) as GridDataRowJson<JSrcFieldsTree>;\n\t\t\t\tif (row) DOMSH.findHost<FastFindItem>(this).onSelect(row.rowDatas);\n\t\t\t}\n\t\t\tev.preventDefault();\n\t\t\tev.stopImmediatePropagation();\n\t\t}\n\t}\n\n\tprotected async createItem(this: Button) {\n\t\tconst self = DOMSH.findHost(this) as FastFindItem;\n\t\tconst {ItemCreator} = await import(\"back/wsp/dialogs/itemCreator.js\");\n\t\tconst conf = BASIS.newInit(self.itemCreator, self.reg);\n\t\tif (self.search.value) conf.nameBuilder = function (this: ItemCreator) {\n\t\t\t//Retourne la valeur du champ du fastFind sauf si le name de l'item a été personnalisé par l'utilisateur\n\t\t\treturn this.nameInput.value || SRC.filterPartUri(self.search.value);\n\t\t};\n\t\tconst shortDesc = await ItemCreator.openCreateItem(conf, \"Créer un item...\", this).onNextClose();\n\t\tself.onSelect(shortDesc);\n\t}\n\n}\n\nREG.reg.registerSkin('wsp-fastfind-item', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\t/*width: 90vw;*/\n\t\t/*max-width: 50em;*/\n\t\t/*--row-inSel-unfocus-bgcolor: var(--row-inSel-bgcolor);*/\n\t}\n\n\t[hidden] {\n\t\tdisplay: none;\n\t}\n\n\t#title {\n\t\tbackground-color: var(--dialog-bgcolor);\n\t\tcolor: var(--dialog-color);\n\t\tpadding: .1em;\n\t}\n\n\t#head {\n\t\tdisplay: flex;\n\t\tflex-direction: row-reverse;\n\t\tmin-height: fit-content;\n\t\tmin-width: 0;\n\t}\n\n\tinput {\n\t\tbackground: .1em / 1em no-repeat url(/@skin@/wsp/dialogs/fastFindItems/fastFind_filter.svg) var(--form-search-bgcolor);\n\t\tbackground-position: left;\n\t\tcolor: var(--form-color);\n\t\tborder: none;\n\t\tpadding-block: 2px;\n\t\tpadding-inline: 1.2em 2px;\n\t\twidth: 100%;\n\t\tborder-inline-start: 1px solid var(--border-color);\n\t\tfont-size: inherit;\n\t}\n\n\tinput:focus {\n\t\toutline: var(--focus-outline);\n\t\toutline-offset: -2px;\n\t}\n\n\tc-grid,\n\twsp-subitems-tree {\n\t\tflex: 1;\n\t\tmin-height: 10em;\n\t}\n\n`);\n\ncustomElements.define(\"wsp-fastfind-item\", FastFindItem);\n\n//\nconst EMPTY_LOADING = <section>Chargement en cours...</section>;\nconst EMPTY_FILTERED = <section>\n\t<div>Aucun item trouvé</div>\n\t<hr/>\n\t<section style=\"text-align:start;\">\n\t\t<h4 style=\"margin:.5em\">Syntaxe de recherche :</h4>\n\t\t<ul>\n\t\t\t<li><b>X</b> : le code l&apos;item ou le titre contient la chaine \&quot;X\&quot;</li>\n\t\t\t<li><b>S/</b> : un espace ancêtre contient la chaine \&quot;S\&quot;</li>\n\t\t\t<li><b>&lt;</b> : l&apos;item a été modifié aujourd&apos;hui</li>\n\t\t\t<li><b>&lt;N</b> : l&apos;item a été modifié il y a moins de N jours inclus</li>\n\t\t\t<li><b>&lt;7 sp/item titre</b> : combinaison des critères...</li>\n\t\t</ul>\n\t</section>\n</section>;\nconst EMPTY_NORESULT = <section>\n\t<div>Aucun item</div>\n</section>;\n\n//\n\nexport class ReqFastFind implements ISpaceTreeReq {\n\turiRoot: string;\n\n\tprotected _stamp = 0;\n\tprotected _textToSearch: string;\n\n\tprotected _req: Element;\n\tprotected _itemsExp: Element;\n\tprotected _restrictionExp: Element;\n\tprotected _selectReq: Element;\n\n\tconstructor(protected wsp: Wsp) {}\n\n\tinitReq(fields: string | ESrcField[], uriRoot: string, restrictions: ISearchCrit): this {\n\t\tthis.uriRoot = uriRoot;\n\t\t//TODO exclude /~ configurable.\n\t\tconst mainCrit = new SearchItems().excludeTildeRoot().excludeAirItems(false).includeDrfErased(this.wsp.wspDefProps.drfRefWsp != null);\n\t\t//mainCrit.excludeExtItems(false) coûteux (un gc forcé à chaque requete),\n\t\t// et pas indispensable, il est logique d'aller chercher les ext explicitement.\n\t\t// plus pertinent : envisager un sélecteur d'ateliers publics ?\n\t\tthis._req = JSX.asXml(() => <request>\n\t\t\t<select>{Array.isArray(fields) ? fields.map((f) => JSX.asXml(() => <column dataKey={f}/>)) : <columns dataKeys={fields}/>}</select>\n\t\t\t<where>\n\t\t\t\t{mainCrit.toDom()}\n\t\t\t\t{restrictions ? restrictions.toDom() : undefined}\n\t\t\t</where>\n\t\t</request>);\n\t\tthis._itemsExp = this._req.querySelector('exp[type=Items]');\n\t\tif (uriRoot) this._itemsExp.setAttribute('beforeEndFolder', uriRoot + \"/\");\n\t\tthis._restrictionExp = this._itemsExp.nextElementSibling;\n\t\tthis._selectReq = this._req.firstElementChild;\n\t\treturn this;\n\t}\n\n\t/**\n\t * Met à jour les paramètres de la requete et retourne true s'ils ont effectivement été modifiés\n\t */\n\tupdateParams(params: FastFindItem): boolean {\n\t\tconst newTxt = params.uriFilter.toLowerCase();\n\t\tif (this._textToSearch === newTxt) return false;\n\t\tthis._stamp++;\n\t\tthis._textToSearch = newTxt;\n\t\treturn true;\n\t}\n\n\tgetStartReq(max: number): string {\n\t\tthis._selectReq.setAttribute(\"max\", max.toString());\n\t\tif (this.uriRoot) this._itemsExp.setAttribute('afterUri', this.uriRoot + \"/\");\n\t\telse this._itemsExp.removeAttribute('afterUri');\n\t\t//cleanup précdente requête.\n\t\tlet next = this._itemsExp.nextElementSibling;\n\t\twhile (next !== this._restrictionExp) {\n\t\t\tnext.remove();\n\t\t\tnext = this._itemsExp.nextElementSibling;\n\t\t}\n\t\tconst crit = this.parseTextToSearch(this._textToSearch);\n\t\t//console.log(\"parseTextToSearch::::\", crit);\n\t\tif (crit.after) this.appendExp('LastModif', 'op', '>=', 'value', crit.after.toString());\n\t\tfor (const text of crit.texts) {\n\t\t\tif (text) this.appendExp('ItemCodeOrTitle', 'regexp', `(?i).*${LANG.escape4RegexpFuzzy(text)}.*`);\n\t\t}\n\t\tfor (const sp of crit.spaces) {\n\t\t\tif (sp) this.appendExp('RegexpUri', 'regexp', `(?i).*${LANG.escape4RegexpFuzzy(sp)}.*/.*`);\n\t\t}\n\t\tthis._itemsExp.removeAttribute('beforeEndFolder');\n\t\t//console.log(\"parseTextToSearch:::Xml:::\", this._req);\n\t\treturn DOM.ser(this._req);\n\t}\n\n\tgetNextReq(afterSrcUri: srcUri, max: number): string {\n\t\tthis._selectReq.setAttribute(\"max\", max.toString());\n\t\tthis._itemsExp.setAttribute('afterUri', afterSrcUri);\n\t\tthis._itemsExp.removeAttribute('beforeEndFolder');\n\t\treturn DOM.ser(this._req);\n\t}\n\n\tgetReplaceFolderReq(folderUri: srcUri, max: number): string {\n\t\tthis._selectReq.setAttribute(\"max\", max.toString());\n\t\tconst path = folderUri + '/';\n\t\tthis._itemsExp.setAttribute('afterUri', path);\n\t\tthis._itemsExp.setAttribute('beforeEndFolder', path);\n\t\treturn DOM.ser(this._req);\n\t}\n\n\tgetStamp(): any {return this._stamp}\n\n\tisSameStamp(stamp: any): boolean { return stamp === this._stamp}\n\n\tprotected parseTextToSearch(t: string): { after: number | undefined, spaces: string[], texts: string[] } {\n\t\tlet after: number;\n\t\tconst spaces: string[] = [];\n\t\tconst texts: string[] = [];\n\t\tconst findAfter = /(^|[^\\\\])<(\\d*)/.exec(t);\n\t\tif (findAfter) {\n\t\t\tconst days = findAfter[2] ? Number.parseInt(findAfter[2]) : 0;\n\t\t\tconst d = new Date();\n\t\t\td.setTime(d.getTime() - 86400000 * days);\n\t\t\td.setHours(0, 0, 0, 0);\n\t\t\tafter = d.getTime();\n\t\t\tt = t.substring(0, findAfter.index + findAfter[1].length) + \" \" + t.substring(findAfter.index + findAfter[0].length);\n\t\t}\n\t\tt = t.replace(/\\\\ /, '\\xA0'); //on remplace les espaces échappés par des espaces insécables\n\t\tconst fragments = t.split(/ +/);\n\t\tlet i = fragments.length - 1;\n\t\tfor (; i >= 0; i--) {\n\t\t\t//On remonte jusqu'au 1er espace\n\t\t\tconst frag = fragments[i];\n\t\t\tconst findSlash = /(^|[^\\\\])\\/((?:[^\\/]|\\\\\\/)*)$/.exec(frag);\n\t\t\tif (findSlash) {\n\t\t\t\tspaces.push(frag.substring(0, findSlash.index + findSlash[1].length));\n\t\t\t\ttexts.push(findSlash[2].replace(/\\\\\\//, '/'));\n\t\t\t\tfor (i--; i >= 0; i--) {\n\t\t\t\t\t//Les autres fragments sont des espaces\n\t\t\t\t\tspaces.push(fragments[i]);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\ttexts.push(frag.replace(/\\\\\\//, '/'));\n\t\t}\n\t\treturn {after, spaces, texts}\n\t}\n\n\tprotected appendExp(type: string, ...atts: string[]): Element {\n\t\tconst exp = this._itemsExp.ownerDocument.createElement(\"exp\");\n\t\texp.setAttribute(\"type\", type);\n\t\tfor (let i = 0; i < atts.length; i++) exp.setAttribute(atts[i], atts[++i]);\n\t\tthis._itemsExp.parentElement.insertBefore(exp, this._restrictionExp);\n\t\treturn exp;\n\t}\n}\n"]}