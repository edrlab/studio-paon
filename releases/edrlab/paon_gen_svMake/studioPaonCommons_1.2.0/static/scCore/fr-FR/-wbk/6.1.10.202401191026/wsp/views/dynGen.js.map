{"version":3,"sources":["/@back@/wsp/views/dynGen.tsx"],"names":["BaseElement","BASIS","POPUP","ItemXmlEd","Desk","UserActiveDeskFeat","REG","CDM","DOM","JSX","DOMSH","DYNGEN","SRC","WSP","EventMgr","EventsMgrProxy","Resizer","FontSizeDeskFeat","UiThemeDeskFeat","captureScenariProtocol","EWspChangesEvts","EWspWorkingSt","ERROR","REMOTE","DynGen","[object Object]","this","srcRefs","Map","wspRefsLockedBy","srcRefsLockedByGen","Set","onError","_onError","init","reg","findReg","configs","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","genFrame","appendChild","createElement","setAttribute","addEventListener","onLoadedPage","super","buildInitFromAtts","hasAttribute","autoResize","extractAttr","place","universe","env","wspCd","w","wspOrigin","wsp","code","wspServer","wspsLive","newPlace","getWsp","isAvailable","waitForAvailable","wspReg","createSubRegMixed","uiRoot","_eventsMgr","eventsMgr","on","msg","from","isConnected","type","u","srcRef","DEBUG_DYNGEN","console","log","has","win","contentWindow","reloadPage","location","reload","closeEditor","wspRef","st","account","clId","itemLocked","set","get","delete","srcIdent","dirty","srcId","srcUri","onConnection","async","size","Array","keys","ts","fetchSrcs","i","length","srcTreeDt","push","initLocks","add","desk","onInactiveUser","_onInactiveUser","bind","userActiveLstn","onActiveUser","_onActiveUser","src","getDynGenUrl","url","onViewShown","data","params","Object","create","gp","refUri","r","path","encodeURIComponent","c","encodeUrl2","stringify","pp","qs","config","itemDynGenUrl","resolve","closed","close","removeAllListeners","closePlace","removeListener","h","getHouseIfFetched","buildWspRef","hasPermission","PERM_EDIT","srcFields","srcRoles","srcRi","sd","fetchShortDesc","e","editableNode","checkCompat","showNotifForbidden","knownNavCompat","map","n","href","target","name","origin","getOriginFrom","editorConf","editorConfig","editEntryPoint","handleOrigin","openEditor","initialize","writePerms","wedMgrConfig","xaRoot","xaRootFromOrigin","editorKey","datasEditor","editor","saveOnClose","initItemReg","addToList","editMode","lockExternal","unlockExternal","isIn","injectThemeInSubFrame","injectFontSizeInSubFrame","perm","libPath","findScPermLibPath","resolver","import","resolvePath","hasPerm","dynGen","findHost","winLoc","onUnloadPage","body","document","hasChildNodes","emit","ResizeObserver","onBodyResize","observe","documentElement","initParentFrame","_initAfterLoad","afterReloadPageLstn","updates","entries","style","height","contentRect","initUrlCheck","oldSrcRefs","findSrcRefs","rootEditableContents","elt","lastModif","editorConfigs","conf","enableEditors","currentOrigin","markAsEditing","newSrcRef","setState","l","srcRefToRem","none","clear","wspSt","isHouseDirty","getStates","find","state","_killEditor","initializedAsync","currentEditor","showNotifError","panel","shadowRoot","resizer","c-orient","class","c-resizable","setHidden","display","minHeight","minWidth","flex","modalPopup","showDialog","titleBar","barLabel","label","closeButton","uiContext","title","initWidth","initHeight","onNextClose","then","isDirty","remove","locksByGenDisabled","htmlElem","getAttribute","checkUrlItems","querySelectorAll","param","paramStr","JSON","parse","maxConcurrentCheckUrl","checkUrls","items","globalParam","itemsByUrl","requests","item","assign","request","headerList","extractHeaders","split","method","batch","splice","reports","dispatchEvent","CustomEvent","bubbles","cancelable","registerSkin","customElements","define","frags","oriPath","xa","parseInt"],"mappings":"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","sourcesContent":["import {BaseElement, BASIS, OSkinableInit} from \"back/commons/basis\";\nimport {IPopupable} from \"back/commons/widgets/popupable\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {ItemXmlEd} from \"back/wsp/views/item/itemXmlEd\";\nimport {Desk, UserActiveDeskFeat} from \"lib/commons/desk\";\nimport {IReg, IUiEnv, REG} from 'lib/commons/registry';\nimport {CDM} from \"lib/commons/utils/cdm\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IXAddr} from \"lib/commons/xml/xAddr\";\nimport {IChainEnv} from \"lib/wsp/chain\";\nimport {DYNGEN, JOrigin} from \"lib/wsp/dyngen\";\nimport {JSrcIdent, SRC, srcRef} from \"lib/wsp/src\";\nimport {IWspEnv, IWspUiEnv, JWspUriChangeMsg, JWspWorkingState, WSP, Wsp, wspCd, wspRef} from \"lib/wsp/wsp\";\nimport {IDatasEditor} from \"lib/wsp/wspMetaUi\";\nimport {IView} from \"lib/commons/views\";\nimport \"back/wsp/views/views_Perms\";\nimport {EventMgr, EventsMgrProxy} from \"lib/commons/events\";\nimport {JDynGenDatas} from \"back/wsp/plugins/dynGenPlg\";\nimport {IEndPoint, IUrlCheckRequest} from \"lib/commons/io/io\";\nimport {Resizer} from \"back/commons/widgets/resizer\";\nimport {FontSizeDeskFeat, UiThemeDeskFeat} from \"back/core/plugins/optionsPlg\";\nimport {captureScenariProtocol} from \"lib/core/scenariProtocol\";\nimport {EWspChangesEvts, EWspWorkingSt, IWspLivePlaceEvents, IWspsLivePlacePointer, WspsLivePlace} from \"lib/wsp/wspsLive\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {REMOTE} from \"lib/core/remote\";\n\n/**\n * API à implémenter par les pages fournies par le dynGen.\n */\nexport interface IWindowDynGen extends Window {\n\n\t/** Appelé sur le onLoad de la page web du dynGen. */\n\tinitParentFrame?(parentFrame: IDynGenParentFrame): void\n\n\t/** Appelé lors d'une détection d'un changement d'un item impliqué dans la construction de cette page. */\n\treloadPage?(srcRefs?: srcRef[]): void\n\n\t/** Listeners appelés par reloadPage(). */\n\tbeforeReloadPageLstn?: Array<(srcRef: srcRef | null) => void | 'stop'>\n\tafterReloadPageLstn?: Array<(srcRef: srcRef | null, updates?: { container: Element, oldNodes: Node[] }[]) => void>\n\n\t/** Config des éditeurs qui sera analysé par DynGenApp. */\n\teditorConfigs?: OEditorConfig[]\n\n\t/**\n\t * Si editorConfigs est spécifié, DynGenApp peut appeler enableEditors() pour chacune de ces config\n\t * (après avoir controlé les permissions).\n\t * Cette méthode doit identifier toutes les racines éditables et les faire adhérer à IEditableNode.\n\t */\n\tenableEditors?(conf: OEditorConfig): void\n\n\t/**\n\t * Notifie le dynGen que cette origine est en cours d'édition par le DynGenApp.\n\t */\n\tmarkAsEditing?(origin: JOrigin): void\n\n\t/**\n\t * Notifie la page du générateur des items actuellement verrouilés en écriture :\n\t * - au chargement de la page pour chaque item de la page si l'item est actuellement verrouilé (locked=true)\n\t * - ou au changement d'état de lock d'un des items exploités dans la page.\n\t *\n\t * Cette méthode est obligatoire si IDynGenParentFrame.lockItem() est utilisé par le générateur (commentaires...).\n\t * Si une édition a démarré sur l'item srcRef mais que la page reçoit un évènement itemLocked(srcRef, true), alors la page\n\t * DOIT abandonner l'édition.\n\t */\n\titemLocked?(srcRef: srcRef, locked: boolean): void\n\n\t/**\n\t * Notifie qu'un lock préalablement posé via sc-lockItem a été perdu suite à un timeout.\n\t * XXX utilité ?\n\t */\n\n\t//lockLoosed?(srcRef: srcRef): void\n\n\t/**\n\t * Notifie d'une perte - ou d'une récupération - de la connexion.\n\t */\n\tonConnection(ok: boolean): void\n\n\trootEditableContents? : HTMLElement\n}\n\n/**\n * Contexte parent des pages du dynGen, fournit à la page du dynGen\n * via IWindowDynGen.initParentFrame(parentFrame: IDynGenParentFrame)\n */\ninterface IDynGenParentFrame {\n\n\t/** Controle du droit en écriture */\n\tcanEdit(srcRef: srcRef): Promise<boolean>\n\n\t/**\n\t * Permet de démarrer une édition d'un fragment d'un item.\n\t * @param webNode Noeud de la page du dynGen. Ce noeud doit avoir dans son contexte\n\t *    ancêtre la définition d'une source à éditer via les atrributs data-origin.\n\t */\n\teditFragment(webNode: IEditableNode, oripathHandler: IEntryOriginHandler): void\n\n\t/**\n\t * Demande de poser un lock en édition sur un item (Pour l'édition directe des commentaires notamment).\n\t * - Gestion \"optimiste\" des race-conditions : une fois l'event dispatché, la page peut considérer le verrou acquis,\n\t *   mais il est théoriquement possible qu'une notification contraire intervienne dans les millisecondes qui\n\t *   suivent exigeant l'abandon de l'édition via IWindowDynGen.itemLocked(srcRef, true);\n\t * - Si l'utilisatur n'est plus actif, ou si la connection est instable, le verrou peut être perdu\n\t *   et une notification IWindowDynGen.itemLocked(srcRef, true) peut toujours intervenir à tout moment.\n\t * - Malgré le verrou posé, un reloadPage() peut toujours avoir lieu pour diverses raisons (perte de verrou,\n\t *   suppression ou import massif, mise à jour du modèle documentaire, changement de droits...).\n\t *\n\t * @return false si un lock est déjà en cours.\n\t */\n\tlockItem(srcRef: srcRef): boolean\n\n\t/**\n\t * Elimine le verrou précédemment posé via IDynGenParentFrame.lockItem(srcRef)\n\t */\n\tunlockItem(srcRef: srcRef): void\n\n\t/** Injecte le thème courant dans la page du dynGen. */\n\tinjectTheme(): void\n\n\t/** Evalue une permission donnée sur le repo courant */\n\thasPerm(perm: string): Promise<boolean>\n\n\t/** Evalue une permission donnée sur un item de l'atelier courant */\n\thasPermOnSrcRef(perm: string, srcRef?: string): Promise<boolean>\n}\n\n/**\n * CustomElement d'affichage d'un dynGen.\n * Attributs :\n * - Init config atts : auto-resize=\"true\"|\"false\"\n */\nexport interface DynGen extends BaseElement, IDynGenParentFrame {\n\tinitialize(init: ODynGenInit): this;\n}\n\nexport interface ODynGenInit extends OSkinableInit, JDynGenDatas {\n\treg?: IReg<IChainEnv & IUiEnv>\n\n\tautoResize?: boolean\n}\n\nexport class DynGen extends BaseElement implements IDynGenParentFrame, IView {\n\n\tconfigs: ODynGenInit;\n\n\treg: IReg<IChainEnv & IUiEnv>;\n\n\t/** SubReg de this.reg enrichi du wsp. */\n\twspReg: IReg<IWspUiEnv>;\n\n\tplace: WspsLivePlace;\n\n\twsp: Wsp;\n\n\tgenFrame: HTMLIFrameElement;\n\n\t/**\n\t * empty : dynGen vide, correspond à un 404, gen non trouvé pour ce type d'item.\n\t * message : stackTrace publiée dans la page. (TODO)\n\t */\n\tget onError(): EventMgr<(err: 'empty' | 'message', msg: Element, dynGen: DynGen) => void> {return this._onError || (this._onError = new EventMgr())}\n\n\tprotected _onError: EventMgr<(err: 'empty' | 'message', msg: Element, dynGen: DynGen) => void>;\n\n\t/**\n\t * Srcs impliqués dans la page courante du dynGen.\n\t * En value : Date du srcRef issu du data-origin trouvé dans la page = field srcTreeDt de l'item.\n\t */\n\tsrcRefs: Map<srcRef, number> = new Map();\n\n\t/** Verrou en cours des autres devices. */\n\twspRefsLockedBy: Map<wspRef, string/*clId du device détenant le lock*/> = new Map();\n\n\t/** Panel d'édition. */\n\tresizer: Resizer;\n\tpanel: HTMLElement;\n\tmodalPopup: IPopupable;\n\n\t/** Locks actuellement détenus par le générateur (édition comments). */\n\tsrcRefsLockedByGen: Set<srcRef> = new Set();\n\tlocksByGenDisabled: boolean;\n\n\t/** Origin en cours d'édition. */\n\tcurrentOrigin: JOrigin;\n\n\t/** Editeur en cours. */\n\tcurrentEditor: ItemXmlEd;\n\n\t/** Mémoire des listeners pour remove. */\n\tprotected onInactiveUser: (since: number) => void;\n\tprotected onActiveUser: () => void;\n\n\tprotected _initialize(init: ODynGenInit) {\n\t\tthis.reg = this.findReg(init);\n\t\tthis.configs = init;\n\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tthis.genFrame = sr.appendChild(<iframe/>) as HTMLIFrameElement;\n\t\tthis.genFrame.setAttribute(\"sandbox\", \"allow-downloads allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts\");\n\t\tthis.genFrame.addEventListener(\"load\", this.onLoadedPage);\n\t}\n\n\tbuildInitFromAtts(init?: ODynGenInit): any {\n\t\tinit = super.buildInitFromAtts(init);\n\t\tif (this.hasAttribute(\"auto-resize\")) init.autoResize = BASIS.extractAttr(this, \"auto-resize\") !== \"false\";\n\t\treturn init;\n\t}\n\n\tasync onViewShown() {\n\t\tif (this.place) return;\n\t\t//Pas encore init.\n\t\tconst universe = this.reg.env.universe;\n\t\tconst wspCd = this.configs.w;\n\t\tconst wspOrigin = (this.reg.env as IWspEnv).wsp;\n\t\tif (!wspOrigin || wspOrigin.code !== wspCd) {\n\t\t\tthis.place = universe.wspServer.wspsLive.newPlace();\n\t\t\tthis.wsp = this.place.getWsp(this.configs.w); //écoute les events pour ce wsp.\n\t\t\tif (!this.wsp.isAvailable) await this.wsp.waitForAvailable(this);\n\t\t\tthis.wspReg = REG.createSubRegMixed(this.reg, this.wsp.reg); //on doit attendre le chargement du wsp pour que this.wsp.reg soit complet (roles...)\n\t\t\tthis.wspReg.env.uiRoot = this;\n\t\t\tthis.wspReg.env.place = this.place;\n\t\t} else {\n\t\t\tthis.wsp = wspOrigin;\n\t\t\tthis.wspReg = this.reg;\n\t\t\tthis.place = (this.reg.env as IWspsLivePlacePointer).place;\n\t\t}\n\n\t\tif (!this.place) this.place = universe.wspServer.wspsLive.newPlace();\n\t\telse this._eventsMgr = new EventsMgrProxy(this.place.eventsMgr);\n\n\t\t//this.wspReg.env.infoBroker = ... //pas utile pour le moment.\n\t\t(this._eventsMgr || this.place.eventsMgr)\n\t\t\t.on(\"wspUriChange\", (msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') => {\n\t\t\t\tif (!this.isConnected) return;\n\t\t\t\tif (msg.type === EWspChangesEvts.u && msg.wspCd === this.configs.w) {\n\t\t\t\t\tconst srcRef = SRC.srcRef(msg);\n\t\t\t\t\tif (DEBUG_DYNGEN) console.log(\"DYNGEN - wspUriChange:::::\", srcRef, this.srcRefs.has(srcRef));\n\t\t\t\t\tif (this.srcRefs.has(srcRef)) {\n\t\t\t\t\t\tconst win = this.genFrame.contentWindow as IWindowDynGen;\n\t\t\t\t\t\tif (win.reloadPage) win.reloadPage([srcRef]);\n\t\t\t\t\t\telse win.location.reload();\n\t\t\t\t\t\tif (from === 'server') this.closeEditor();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t\t.on('newWspWorkingState', (wspRef: wspRef, wspCd: wspCd, srcRef: srcRef, st: EWspWorkingSt, account: string, clId: string) => {\n\t\t\t\tif (!this.isConnected) return;\n\t\t\t\tconst win = this.genFrame.contentWindow as IWindowDynGen;\n\t\t\t\tif (!win.itemLocked) return;\n\t\t\t\tif (st === EWspWorkingSt.w) {\n\t\t\t\t\tthis.wspRefsLockedBy.set(wspRef, clId);\n\t\t\t\t\twin.itemLocked(srcRef, true);\n\t\t\t\t} else if (this.wspRefsLockedBy.get(wspRef) === clId) {\n\t\t\t\t\tthis.wspRefsLockedBy.delete(wspRef);\n\t\t\t\t\twin.itemLocked(srcRef, false);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.on('houseDirtyChange', (wspRef: wspRef, wsp: Wsp, srcIdent: JSrcIdent, dirty: boolean) => {\n\t\t\t\tif (!this.isConnected) return;\n\t\t\t\tconst win = this.genFrame.contentWindow as IWindowDynGen;\n\t\t\t\tif (!win.itemLocked) return;\n\t\t\t\tconst srcRef = srcIdent.srcId || srcIdent.srcUri;\n\t\t\t\tif (this.srcRefs.has(srcRef)) win.itemLocked(srcRef, dirty);\n\t\t\t})\n\t\t\t.on(\"onConnectionLost\", () => {\n\t\t\t\tif (!this.isConnected) return;\n\t\t\t\tconst win = this.genFrame.contentWindow as IWindowDynGen;\n\t\t\t\tif (DEBUG_DYNGEN) console.log(\"DYNGEN - onConnectionLost::::\");\n\t\t\t\tif (win && win.onConnection) win.onConnection(false);\n\t\t\t})\n\t\t\t.on(\"onConnectionRenewed\", async () => {\n\t\t\t\tif (!this.isConnected) return;\n\t\t\t\tconst win = this.genFrame.contentWindow as IWindowDynGen;\n\t\t\t\tif (this.srcRefs.size > 0) {\n\t\t\t\t\t//Une page est initialisée\n\t\t\t\t\tconst srcRefs = Array.from(this.srcRefs.keys());\n\t\t\t\t\tconst ts = await WSP.fetchSrcs(this.wsp, this, srcRefs, [\"srcTreeDt\"]);\n\t\t\t\t\tlet reload: srcRef[];\n\t\t\t\t\tfor (let i = 0; i < srcRefs.length; i++) {\n\t\t\t\t\t\tif (this.srcRefs.get(srcRefs[i]) !== ts[i].srcTreeDt) {\n\t\t\t\t\t\t\tif (!reload) reload = [];\n\t\t\t\t\t\t\treload.push(srcRefs[i]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (reload) {\n\t\t\t\t\t\tif (DEBUG_DYNGEN) console.log(\"DYNGEN - onConnectionRenewed::::reloadPage\", reload);\n\t\t\t\t\t\tif (win.reloadPage) win.reloadPage(reload);\n\t\t\t\t\t\telse win.location.reload();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (DEBUG_DYNGEN) console.log(\"DYNGEN - onConnectionRenewed::::ok\");\n\t\t\t\t\tif (win && win.onConnection) win.onConnection(true);\n\t\t\t\t\tthis.initLocks(win);\n\t\t\t\t}\n\t\t\t});\n\n\t\tUserActiveDeskFeat.add(desk);\n\t\tthis.onInactiveUser = this._onInactiveUser.bind(this);\n\t\t(desk as UserActiveDeskFeat).userActiveLstn.on(\"inactive\", this.onInactiveUser);\n\t\tthis.onActiveUser = this._onActiveUser.bind(this);\n\t\t(desk as UserActiveDeskFeat).userActiveLstn.on(\"active\", this.onActiveUser);\n\n\t\tthis.reload();\n\t}\n\n\t/** rechargement complet de la frame */\n\treload(): void {\n\t\tthis.genFrame.src = this.getDynGenUrl(this.configs).url;\n\t}\n\n\t/** (re)chargement complet de la frame */\n\tload(): void {\n\t\tif (this.place)\n\t\t\tthis.reload()\n\t\telse\n\t\t\tthis.onViewShown();\n\t}\n\n\n\tgetDynGenUrl(data: JDynGenDatas): IEndPoint {\n\t\tconst params = Object.create(data.gp || null);\n\t\tparams.refUri = data.r;\n\t\tconst path = encodeURIComponent(data.w) + \"/\" + data.c + \"/\" + DYNGEN.encodeUrl2(CDM.stringify(params)) + \"/\" + (data.pp == null ? \"co/\" : data.pp) + (data.qs ? \"?\" + data.qs : \"\");\n\t\treturn this.reg.env.universe.wspServer.config.itemDynGenUrl.resolve(path);\n\t}\n\n\t/** Proxy vers l'eventsMgr de la place existante. */\n\tprotected _eventsMgr: EventsMgrProxy<IWspLivePlaceEvents>;\n\n\tonViewHidden(closed?: boolean) {\n\t\tthis.closeEditor();\n\t\tif (closed) {\n\t\t\tthis.wsp = null;\n\t\t\tif (this.wspReg && this.wspReg !== this.reg) {\n\t\t\t\tthis.wspReg.close();\n\t\t\t\tthis.wspReg = null;\n\t\t\t}\n\t\t\tif (this.place) {\n\t\t\t\tif (this._eventsMgr) this._eventsMgr.removeAllListeners(); //place parente utilisée\n\t\t\t\telse this.place.closePlace(); //place dédiée\n\t\t\t\tthis.place = null;\n\t\t\t\tthis._eventsMgr = null;\n\t\t\t}\n\t\t\tif (this.onInactiveUser) {\n\t\t\t\t(desk as UserActiveDeskFeat).userActiveLstn.removeListener(\"inactive\", this.onInactiveUser);\n\t\t\t\tthis.onInactiveUser = null;\n\t\t\t}\n\t\t\tif (this.onActiveUser) {\n\t\t\t\t(desk as UserActiveDeskFeat).userActiveLstn.removeListener(\"active\", this.onActiveUser);\n\t\t\t\tthis.onActiveUser = null;\n\t\t\t}\n\t\t}\n\t}\n\n\tasync canEdit(srcRef: srcRef): Promise<boolean> {\n\t\tif (!srcRef) return false;\n\t\tconst h = this.place.wspsLive.getHouseIfFetched(WSP.buildWspRef(this.wsp.code, srcRef));\n\t\tif (h) return this.wsp.reg.hasPermission(PERM_EDIT, h.srcFields.srcRoles, null, h.srcFields.srcRi);\n\t\t//Besoin de charger l'item\n\t\ttry {\n\t\t\tconst sd = await this.wsp.fetchShortDesc(srcRef, this);\n\t\t\treturn this.wsp.reg.hasPermission(PERM_EDIT, sd.srcRoles, null, sd.srcRi);\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/** Demande d'édition d'un noeud. */\n\teditFragment(editableNode: IEditableNode): void {\n\t\tif (!Desk.checkCompat('edit')) {\n\t\t\tPOPUP.showNotifForbidden(<div>\n\t\t\t\t<p>Ce navigateur n'est pas compatible avec l'édition de texte riche.</p>\n\t\t\t\t<p>Vous pouvez utiliser un des navigateurs à jour suivants :</p>\n\t\t\t\t<ul>\n\t\t\t\t\t{Desk.knownNavCompat.map((n) => n.url ? <li><a href={n.url} target=\"_blank\">{n.name}</a></li> : <li>{n.name}</li>)}\n\t\t\t\t</ul>\n\t\t\t</div>, this);\n\t\t\treturn;\n\t\t}\n\t\tlet origin = DYNGEN.getOriginFrom(editableNode);\n\t\tconst editorConf = editableNode.editorConfig;\n\t\tif (editorConf.editEntryPoint) origin = editorConf.editEntryPoint.handleOrigin(origin);\n\t\tif (!origin.srcRef) return;\n\t\tthis.openEditor(origin, new ItemXmlEd().initialize({\n\t\t\treg: this.wspReg,\n\t\t\tsrcRef: origin.srcRef,\n\t\t\twritePerms: PERM_EDIT,\n\t\t\twedMgrConfig: {\n\t\t\t\txaRoot: xaRootFromOrigin(origin)\n\t\t\t},\n\t\t\teditorKey: editorConf.editorKey,\n\t\t\tdatasEditor: editorConf.editor,\n\t\t\tsaveOnClose: true,\n\t\t\tinitItemReg: (reg) => {\n\t\t\t\t//Diff avec un autre item lors de l'édition d'un framgent dans le contexte d'un dynGen est douteux/compliqué... on masque.\n\t\t\t\treg.addToList(\"wed.diffBar.actions\", \"otherItem\", 2, null);\n\t\t\t}\n\t\t}), editorConf.editMode || 'modal');\n\t}\n\n\tlockItem(srcRef: srcRef): boolean {\n\t\tif (this.place.lockExternal(WSP.buildWspRef(this.wsp.code, srcRef))) {\n\t\t\tthis.srcRefsLockedByGen.add(srcRef);\n\t\t\tthis.closeEditor();\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tunlockItem(srcRef: srcRef) {\n\t\tif (this.srcRefsLockedByGen.has(srcRef)) {\n\t\t\tthis.srcRefsLockedByGen.delete(srcRef);\n\t\t\tthis.place.unlockExternal(WSP.buildWspRef(this.wsp.code, srcRef));\n\t\t}\n\t}\n\n\tinjectTheme() {\n\t\tif (UiThemeDeskFeat.isIn(desk)) desk.injectThemeInSubFrame(this.genFrame);\n\t\tif (FontSizeDeskFeat.isIn(desk)) desk.injectFontSizeInSubFrame(this.genFrame);\n\t}\n\n\tasync hasPerm(perm: string): Promise<boolean> {\n\t\tconst libPath = await REG.findScPermLibPath(perm);\n\t\tif (this.reg.env.resolver && libPath)\n\t\t\tawait import(this.reg.env.resolver.resolvePath(libPath));\n\t\treturn this.reg.hasPerm(perm);\n\t}\n\n\tasync hasPermOnSrcRef(perm: string, srcRef?: string): Promise<boolean> {\n\t\tif (!this.wsp) return null;\n\t\tconst libPath = await REG.findScPermLibPath(perm);\n\t\tif (this.reg.env.resolver && libPath)\n\t\t\tawait import(this.reg.env.resolver.resolvePath(libPath));\n\t\tif (srcRef) {\n\t\t\tconst sd = await this.wsp.fetchShortDesc(srcRef, this);\n\t\t\treturn this.wsp.reg.hasPermission(perm, sd.srcRoles, null, sd.srcRi);\n\t\t} else {\n\t\t\treturn this.wsp.reg.hasPerm(perm);\n\t\t}\n\t}\n\n\tprotected _randomId: string;\n\n\t/** Chargement d'une nouvelle page du dynGen. */\n\tprotected async onLoadedPage(this: HTMLIFrameElement) {\n\t\tconst dynGen = DOMSH.findHost(this) as DynGen;\n\t\tconst win = this.contentWindow as IWindowDynGen;\n\t\tlet winLoc;\n\t\ttry {\n\t\t\t// Une exception est lancé si bloqué par la sécurité\n\t\t\twinLoc = win.location.href;\n\t\t} catch (e) {}\n\t\tif (!winLoc || winLoc === \"about:blank\") {\n\t\t\t//chargement intial de l'iframe ou reset de la page.\n\t\t\tdynGen.onUnloadPage();\n\t\t\treturn;\n\t\t}\n\n\t\tif (dynGen._onError) {\n\t\t\tconst body = win.document.body;\n\t\t\tif (!body || !body.hasChildNodes()) {\n\t\t\t\tdynGen._onError.emit('empty', null, dynGen);\n\t\t\t\tdynGen.onUnloadPage();\n\t\t\t\treturn; //on sort\n\t\t\t} else {\n\t\t\t\t//TODO eval si message / stackTrace...\n\t\t\t\t//dynGen._onError.emit('message', body...., dynGen);\n\t\t\t\t//return; //on sort\n\t\t\t}\n\t\t}\n\n\t\tif (dynGen.configs.autoResize) new ResizeObserver(dynGen.onBodyResize.bind(dynGen)).observe(win.document.documentElement);\n\n\t\t//déclaration du contexte parent.\n\t\t//try {\n\t\tif (win.initParentFrame) win.initParentFrame(dynGen);\n\n\t\tawait dynGen._initAfterLoad(win);\n\n\t\t//On s'abonne aux mises à jour des reloadPages()\n\t\tif (win.afterReloadPageLstn) win.afterReloadPageLstn.push((srcRef: srcRef | null, updates?: { container: Element, oldNodes: Node[] }[]) => {\n\t\t\tdynGen._initAfterLoad(win);\n\t\t});\n\t\t// } catch (e) {\n\t\t// \tPOPUP.showNotif(\"Impossible d'afficher cette vue\", this);\n\t\t// \ttry {\n\t\t// \t\twin.document.documentElement.textContent = null; //On efface la page.\n\t\t// \t} catch (e) {console.log(e)}\n\t\t// \tthrow e;\n\t\t// }\n\t\tcaptureScenariProtocol(this, dynGen.wspReg);\n\t}\n\n\tonBodyResize(entries: ResizeObserverEntry[]) {\n\t\tthis.genFrame.style.height = entries[entries.length - 1].contentRect.height + 'px';\n\t}\n\n\tasync _initAfterLoad(win: IWindowDynGen) {\n\t\tif (!win.document.body) {\n\t\t\t//document killé entre temps.\n\t\t\tthis.onUnloadPage();\n\t\t\treturn;\n\t\t}\n\n\t\t// Initialisation de la vérification des URLs\n\t\tthis.initUrlCheck(win);\n\n\t\t//Mise à jour de la map des srcRefs de cette page.\n\t\tconst oldSrcRefs = this.srcRefs;\n\t\tthis.srcRefs = new Map();\n\t\tDYNGEN.findSrcRefs(win.rootEditableContents || win.document.body, (elt, srcRef, lastModif) => {\n\t\t\tthis.srcRefs.set(srcRef, lastModif);\n\t\t});\n\t\tif (DEBUG_DYNGEN) console.log(\"DYNGEN - new map srcRefs::::\", Array.from(this.srcRefs));\n\n\t\t//Config des éditeurs\n\t\tconst editorConfigs = win.editorConfigs;\n\t\tif (editorConfigs) {\n\t\t\tfor (const conf of editorConfigs) {\n\t\t\t\t//FIXME check Perms\n\t\t\t\twin.enableEditors(conf);\n\t\t\t}\n\t\t\tif (this.currentOrigin && win.markAsEditing) win.markAsEditing(this.currentOrigin);\n\t\t}\n\n\t\tawait this.initLocks(win);\n\t\tif (!this.wsp) return; //racecond\n\n\t\t//Mise à jour des srcRefs dont écouter les locks.\n\t\tconst wspCd = this.wsp.code;\n\t\tfor (const newSrcRef of this.srcRefs.keys()) {\n\t\t\tif (oldSrcRefs.has(newSrcRef)) {\n\t\t\t\toldSrcRefs.delete(newSrcRef);\n\t\t\t} else {\n\t\t\t\tthis.place.setState(WSP.buildWspRef(wspCd, newSrcRef), EWspWorkingSt.l); //TODO 'l' ou 'r' configurable ?\n\t\t\t}\n\t\t}\n\t\tfor (const srcRefToRem of oldSrcRefs.keys()) {\n\t\t\tthis.place.setState(WSP.buildWspRef(wspCd, srcRefToRem), EWspWorkingSt.none);\n\t\t}\n\t}\n\n\tprotected onUnloadPage() {\n\t\tif (this.srcRefs.size > 0) {\n\t\t\tconst wspCd = this.wsp.code;\n\t\t\tfor (const srcRef of this.srcRefsLockedByGen) {\n\t\t\t\tthis.place.unlockExternal(WSP.buildWspRef(wspCd, srcRef));\n\t\t\t}\n\t\t\tthis.srcRefsLockedByGen.clear();\n\t\t\tfor (const srcRef of this.srcRefs.keys()) {\n\t\t\t\tthis.place.setState(WSP.buildWspRef(wspCd, srcRef), EWspWorkingSt.none);\n\t\t\t}\n\t\t\tthis.srcRefs.clear();\n\t\t}\n\t}\n\n\tprotected async initLocks(win: IWindowDynGen) {\n\t\tthis.wspRefsLockedBy.clear();\n\t\tif (win.itemLocked) {\n\t\t\t//Le gen implémente l'écoute des items lockés, on l'initialise.\n\t\t\ttry {\n\t\t\t\tfor (const srcRef of this.srcRefs.keys()) {\n\t\t\t\t\tconst wspRef = WSP.buildWspRef(this.wsp.code, srcRef);\n\t\t\t\t\tlet wspSt: JWspWorkingState;\n\t\t\t\t\tif (this.place.isHouseDirty(wspRef) || (wspSt = (await this.place.getStates(wspRef)).find((st) => st.state === EWspWorkingSt.w))) {\n\t\t\t\t\t\t//dynGen.wspRefsLockedBy.set(wspRef, wspSt ? wspSt.clId : '.'/* '.' = notre house est dirty. */);\n\t\t\t\t\t\tif (wspSt) this.wspRefsLockedBy.set(wspRef, wspSt.clId);\n\t\t\t\t\t\tif (DEBUG_DYNGEN) console.log(\"DYNGEN - lock::::\", srcRef);\n\t\t\t\t\t\twin.itemLocked(srcRef, true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tif (win.onConnection) win.onConnection(false);\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected async openEditor(origin: JOrigin, editor: ItemXmlEd, editMode: 'modal' | 'panel'): Promise<void> {\n\t\tawait this._killEditor();\n\t\ttry {\n\t\t\tawait editor.initializedAsync;\n\t\t\tthis.currentEditor = editor;\n\t\t\tthis.currentOrigin = origin;\n\t\t} catch (e) {\n\t\t\tPOPUP.showNotifError(\"Impossible d'éditer ce fragment.\", this);\n\t\t\tthrow e;\n\t\t}\n\t\tif (editMode === 'panel') {\n\t\t\tif (!this.panel) {\n\t\t\t\tconst sr = this.shadowRoot;\n\t\t\t\tthis.genFrame.setAttribute(\"c-resizable\", \"\");\n\t\t\t\tthis.resizer = sr.appendChild(<Resizer c-orient=\"row\"/>) as Resizer;\n\t\t\t\tthis.panel = sr.appendChild(<div class=\"panel\" c-resizable=\"\"/>);\n\t\t\t}\n\t\t\tDOM.setHidden(this.panel, false);\n\t\t\tDOM.setHidden(this.resizer, false);\n\t\t\tthis.panel.appendChild(editor);\n\t\t\tconst markAsEditing = (this.genFrame.contentWindow as IWindowDynGen).markAsEditing;\n\t\t\tif (markAsEditing) markAsEditing(origin);\n\t\t} else {\n\t\t\tconst st = editor.style;\n\t\t\tst.display = 'flex';\n\t\t\tst.minHeight = '0';\n\t\t\tst.minWidth = '0';\n\t\t\tst.flex = '1';\n\t\t\tthis.modalPopup = POPUP.showDialog(editor, this, {\n\t\t\t\ttitleBar: {\n\t\t\t\t\tbarLabel: {label: \"Édition du bloc\"},\n\t\t\t\t\tcloseButton: {uiContext: 'dialog', label: \"Fermer\", title: \"Fermer l'édition du bloc\"}\n\t\t\t\t},\n\t\t\t\tresizer: {},\n\t\t\t\tinitWidth: '80vw',\n\t\t\t\tinitHeight: '60vh'\n\t\t\t});\n\t\t\tthis.modalPopup.onNextClose().then(() => {\n\t\t\t\tthis.modalPopup = null;\n\t\t\t\tthis.closeEditor();\n\t\t\t})\n\t\t}\n\t}\n\n\tonViewBeforeHide(closed?: boolean): boolean {\n\t\treturn !closed || !this.currentEditor || !this.currentEditor.isDirty();\n\t}\n\n\tasync onViewWaitForHide(closed?: boolean): Promise<boolean> {\n\t\tif (!closed) return true;\n\t\ttry {\n\t\t\tawait this.closeEditor();\n\t\t\treturn true;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tasync closeEditor(): Promise<void> {\n\t\tawait this._killEditor();\n\t\tif (this.modalPopup) {\n\t\t\tthis.modalPopup.close();\n\t\t\tthis.modalPopup = null;\n\t\t} else if (this.panel) {\n\t\t\tDOM.setHidden(this.panel, true);\n\t\t\tDOM.setHidden(this.resizer, true);\n\t\t}\n\t}\n\n\tprotected async _killEditor(): Promise<void> {\n\t\tif (this.currentEditor) {\n\t\t\tthis.currentEditor.closeEditor();\n\t\t\tthis.currentEditor.remove();\n\t\t\tthis.currentEditor = null;\n\t\t\tthis.currentOrigin = null;\n\t\t}\n\t}\n\n\tprotected _onInactiveUser() {\n\t\tthis.locksByGenDisabled = true;\n\t\tfor (const srcRef of this.srcRefsLockedByGen) {\n\t\t\tthis.place.unlockExternal(WSP.buildWspRef(this.wsp.code, srcRef));\n\t\t}\n\t}\n\n\tprotected _onActiveUser() {\n\t\tthis.locksByGenDisabled = false;\n\t\tfor (const srcRef of this.srcRefsLockedByGen) {\n\t\t\tthis.place.lockExternal(WSP.buildWspRef(this.wsp.code, srcRef));\n\t\t}\n\t}\n\n\tprotected initUrlCheck(win: Window) {\n\t\tconst htmlElem = win.document.documentElement;\n\t\tif (htmlElem && htmlElem.getAttribute(\"data-checkUrl-active\") == \"true\") {\n\t\t\tconst checkUrlItems = htmlElem.querySelectorAll(\"*[data-checkUrl]\");\n\t\t\tif (checkUrlItems.length) {\n\t\t\t\tlet param: ICheckUrlGlobalParam = {};\n\t\t\t\tconst paramStr = htmlElem.getAttribute(\"data-checkUrl-param\");\n\t\t\t\tif (paramStr) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tparam = JSON.parse(paramStr);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tERROR.log(\"Error parsing global checkUrl param\", e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!param.maxConcurrentCheckUrl) param.maxConcurrentCheckUrl = 5;\n\t\t\t\t// Pas d'attente du retour, les items sont notifiés par event\n\t\t\t\tthis.checkUrls(checkUrlItems, param);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync checkUrls(items: NodeListOf<Element>, globalParam: ICheckUrlGlobalParam) {\n\t\tconst itemsByUrl: Dict<Element> = {};\n\t\tconst requests: IUrlCheckRequest[] = [];\n\n\t\t// Construction de l'ensemble des requêtes\n\t\tfor (const item of items) {\n\t\t\tconst url = item.getAttribute(\"data-checkUrl\");\n\t\t\ttry {\n\t\t\t\titem.setAttribute(\"data-checkUrl-status\", \"pending\");\n\t\t\t\titemsByUrl[url] = item;\n\t\t\t\tlet param: ICheckUrlParam = globalParam;\n\t\t\t\tconst paramStr = item.getAttribute(\"data-checkUrl-param\");\n\t\t\t\tif (paramStr) param = Object.assign(Object.create(globalParam), JSON.parse(paramStr));\n\t\t\t\tconst request: IUrlCheckRequest = {url};\n\t\t\t\tif (typeof param.headerList === \"string\") request.extractHeaders = param.headerList.split(',');\n\t\t\t\tif (typeof param.method === \"string\") request.method = param.method.split(',');\n\t\t\t\trequests.push(request);\n\t\t\t} catch (e) {\n\t\t\t\tERROR.log(`Error while preparing the checkUrl request: ${url}`, e);\n\t\t\t}\n\t\t}\n\n\t\t// Appels du contrôle d'URL\n\t\twhile (requests.length) {\n\t\t\tconst batch = requests.splice(0, globalParam.maxConcurrentCheckUrl);\n\t\t\tconst reports = await REMOTE.checkUrls(batch, globalParam.maxConcurrentCheckUrl, this.reg);\n\n\t\t\tfor (const url in reports) {\n\t\t\t\tconst item = itemsByUrl[url];\n\t\t\t\titem.setAttribute(\"data-checkUrl-report\", JSON.stringify(reports[url]));\n\t\t\t\titem.dispatchEvent(new CustomEvent(\"checkUrlResponse\", {bubbles: true, cancelable: true}));\n\t\t\t\titem.setAttribute(\"data-checkUrl-status\", \"done\");\n\t\t\t}\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-dyngen', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\n\tiframe {\n\t\tflex: 1 1 15em;\n\t\tborder: none;\n\t\twidth: 0; /* sinon bloqué à 300px mini via un c-resizer */\n\t\tuser-select: none;\n\t}\n\n\t.panel {\n\t\tflex: 0 0 20%;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\n\twsp-item-xmled {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\n\t[hidden] {\n\t\tdisplay: none;\n\t}\n`);\n\ncustomElements.define('wsp-dyngen', DynGen);\n\ninterface ICheckUrlParam {\n\tmethod?: string;\n\theaderList?: string;\n}\n\ninterface ICheckUrlGlobalParam extends ICheckUrlParam {\n\tmaxConcurrentCheckUrl?: number;\n}\n\n/** Config des éditeurs dans la page. */\ntype OEditorConfig = {\n\n\t/** Permissions restreignant les éditeurs accessibls à l'utilisateur, quelquesoit l'item. Donc évaluée a niveaude l'atelier. */\n\tperms?: string | string[]\n\n\teditMode?: 'modal' | 'panel'\n\teditorKey: string\n\teditEntryPoint?: IEntryOriginHandler\n\t/* Si editorKey non utilisé : config cutsom de l'editor, non déclarée dans l'itemType. */\n\teditor?: IDatasEditor\n\n\t//interne au dynGen.\n\t//rootsSelector: string //\"div.text,.infoblock_ti>span\"\n}\n\n/** function de modification de l'oripath avant édition. */\ntype IEntryOriginHandler = {\n\thandleOrigin(oripath: JOrigin): JOrigin\n}\n\n/** Noeud susceptible d'être édité dans une page du dynGen. */\ninterface IEditableNode extends Element {\n\teditorConfig: OEditorConfig\n}\n\n\nconst PERM_EDIT = \"action.dynGen#edit.node\";\n\n\nfunction xaRootFromOrigin(origin: JOrigin): IXAddr {\n\tconst frags = origin.oriPath.split(\"/\");\n\tconst xa: IXAddr = [];\n\tfor (let i = 0; i < frags.length; i++) xa.push(parseInt(frags[i], 10));\n\treturn xa;\n}\n\nconst DEBUG_DYNGEN = false;\n\n// Impl exemple de reloadPage() dans IWindowDynGen\n// // let tplNode:HTMLTemplateElement;\n// async function reloadPage(srcRef?: srcRef): Promise<void> {\n// \tfor (let lstn of (window as IWindowDynGen).beforeReloadPageLstn) if (lstn(srcRef) === 'stop') return;\n// \tlet resp = await fetch(location.href, {redirect: 'manual'});\n// \tif (resp.status === 301 /*resp.redirected*/) {\n// \t\t//Redirect\n//\n// \t} else if (resp.ok) {\n// \t\t//refresh\n// \t\tlet xmlText = await resp.text();\n// \t\t// if(!tplNode) tplNode = document.head.appendChild(document.createElement(\"template\")) as HTMLTemplateElement;\n// \t\t// tplNode.content.innerHTML = xmlText;\n// \t\tlet dom = new DOMParser().parseFromString(xmlText, (document as any).contentType === \"text/html\" ? \"text/html\" : \"text/xml\"); //resp.headers.get(\"content-type\") === \"http://www.w3.org/1999/xhtml\"\n// \t\tlet updates = [{\n// \t\t\tcontainer: document.body,\n// \t\t\toldNodes: Array.from(document.body.childNodes)\n// \t\t}];\n// \t\tdocument.title = dom.title;\n// \t\tdocument.body.textContent = null;\n// \t\tlet newBody = dom.documentElement.querySelector('body');\n// \t\twhile (newBody.firstChild) document.body.appendChild(document.adoptNode(newBody.firstChild));\n// \t\tfor (let lstn of (window as IWindowDynGen).afterReloadPageLstn) lstn(srcRef, updates);\n// \t} else {\n// \t\t//failed.\n// \t\t//TODO notif('');\n// \t\tconsole.log(\"Refresh failed.\");\n// \t\tPromise.reject(\"Refresh failed: \" + resp.status);\n// \t}\n// }\n"]}