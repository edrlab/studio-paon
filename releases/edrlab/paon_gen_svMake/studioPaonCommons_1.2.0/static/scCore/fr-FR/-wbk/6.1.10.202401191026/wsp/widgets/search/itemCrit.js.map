{"version":3,"sources":["/@back@/wsp/widgets/search/itemCrit.tsx"],"names":["DOM","JSX","REG","SearchFullText","SearchItemCodeOrTitle","SearchItemComment","SearchItemLinks","SearchItems","SearchItemSgnRegexp","SearchItemTitleRegexp","SearchLastModif","SearchLastModifIn","SearchLastUser","SearchLifeCycleStates","SearchOrphan","SearchRegexpUri","SearchResponsibilities","SearchStatus","UiCritArea","UiCritBase","UiCritBool","UiCritFree","UiCritSrcUri","UiCritSubRequest","UiCritUnknown","UiCritXpath","SrcPointerFastSelect","SrcPointerInline","DOMSH","POPUP","SRC","Button","ITEM","ItemTypesTree","EUserAspects","EUserType","USER","LANG","InputUserPanel","InputPeriod","LC_STATE_DEFAULT_KEY","LC_STATE_DEFAULT_NAME","UserRef","reg","registerSvc","AREA_AND","addSvcToList","AREA_OR","AREA_AND_ROOT","AREA_OR_ROOT","AREA","AREA_PARENTS","AREA_CHILDREN","AREA_ASC","AREA_DESC","ItemCritFullWsp","withAirItems","this","_airItems","checked","withForeignItems","_foreignItems","[object Object]","init","super","_initialize","wsp","env","sr","shadowRoot","appendChild","createElement","class","insertAlternativesBtn","optsRoot","isAirItem","isExtItem","type","onclick","onChange","firstElementChild","xml","getAttribute","crit","excludeAirItems","excludeExtItems","includeDrfErased","wspDefProps","drfRefWsp","fixExclude","getPref","excludeSpaces","split","buildCrit","toDom","setAttribute","getUiCritXmlAtt","setLabel","setCritSgn","setReplacePattern","setBuildAbstract","ctx","air","foreign","getLabel","customElements","define","UiCritLinksArea","linkAxis","abstractStrPrefix","traitsCodeList","setGroup","options","path","result","buildAbstract","srcPointer","î","Promise","resolve","setSrcRef","then","innerText","linkTraitFilter","traits","getListAsMap","ItemCritLinks","critArea","axis","itemPtr","defaultAction","SINGLETON","trFilter","onchange","value","selected","tr","onSrcRefChange","add","shortDesc","getSrcUriType","srcUri","openFastSelect","srcRef","setPath","setLinkTraitFilter","_a","setBuildWedSearch","criterions","searchId","findRef","registerSkin","ItemCritInSpace","spaceUri","_spaceUri","uri","extractSpaceUri","_spaceBtn","label","id","icon","wspMetaUi","getSpaceIcon","onChooseSpace","title","isSrcId","call","undefined","inSpace","buildUiXmlCrit","ev","me","findHost","SpaceSelector","import","ct","initialize","startSel","selOnDblClick","space","showMenuFromEvent","onNextClose","dispatchChangeEvent","ItemCritFullText","_text","oninput","placeholder","querySelector","_ignoreCase","_wholeWord","opts","indexOf","v","txt","text","wholeWord","matchCase","ItemCritSrcCode","_textElt","regexp","RegExp","replace","escapeChar4Regexp","searchTxt","ItemCritTitleRegExp","isRegExp","_regExpElt","hasAttribute","ItemCritCodeOrTitleFilter","ItemCritOrphan","ItemCritForeign","escape4Regexp","EXT_PREFIX","setDescription","setVisible","ItemCritAir","AIR_PREFIX","ItemCritStatus","_withWarning","_statusElt","STATUS","itemStatusMin","Number","parseInt","itemStatusMax","3-3","2-2","1-1","2-3","1-2","ItemCritLastModif","critHead","_opElt","OPERATORS","_dateElt","valueAsDate","Date","operator","vStart","vEnd","getFullYear","getMonth","getDate","lt","gt=","lt=.lt","year","month","day","op","date","dateObj","operatorTxt","dateTxt","toLocaleDateString","ItemCritLastUser","selectedUsers","_selectedUsers","users","refreshUi","_userBtn","onChooseUser","universe","useUsers","getUserSet","initFromInsAction","length","UserSelector","userSelector","userGrid","usersSrv","grid","selType","filterTypeInputVisibility","filterType","user","preserveSelectionOnFilter","selectAndCloseOnDblClick","initWidth","lastChild","removeChild","forEach","src","getIconUrl","getPrimaryName","accounts","usersListVal","join","resulElt","names","push","getLongName","textContent","auth","config","noAuthentication","ItemCritType","itemTypeReducer","_itemTypesPopup","attachShadow","SHADOWDOM_INIT","installSkin","getSvc","_itemTypesTree","textFilter","forbidHideSelectedRow","footer","ui-context","chooseItems_onSelectBtn","bind","chooseItems_onCancelBtn","_itemsBtn","onChooseItems","redraw","itTypes","_selectedItModels","map","entry","itModels","firstChild","itModel","itemType","getItemType","getIcon","getTitle","clearSearch","selectByItModels","skinOver","findPopupableParent","close","getSelectedItemsTypes","getModel","itLabels","itTypesArray","itLabel","itCount","ItemCritComment","withOpenComments","opened","withClosedComments","closed","onClick","msg","ItemCritLifeCycle","_lcElt","multiple","getLcStates","opt","code","name","style","color","iconUrl","backgroundImage","setAttrBool","addEventListener","_userElt","emptySelectionMsg","userCard","usersGridInit","getLcName","selectedIndex","lcStates","lcStatesArr","Array","from","includes","reset","lcBys","isSpecified","buildFromInputPeriod","selectedOptions","currentMode","getId","date1","valueAsNumber","toString","date2","hasFeature","lcStatesLabels","stateCode","state","getLcState","strCplts","lcName","document","createTextNode","elt","pos","ItemCritRespsonsabilities","target","tag","hasResps","modelResps","listResps","resps","respsArr","respsLabels","resp","currentResp","find","usersObj","account","nickOrAccount","withIcon","withGroups","hasAspect","groupable","_respElt","desc","critGroups","_toGroupsElt","_toMembersElt","expandUsers","_b","AREA_item","makeArea","AREA_task","ItemCritRespsonsabilities_item"],"mappings":"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","sourcesContent":["import {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {REG} from \"lib/commons/registry\";\nimport {\n\tEOperatorsIn,\n\tEOperatorsSimple,\n\tISearchCrit,\n\tSearchFullText,\n\tSearchItemCodeOrTitle,\n\tSearchItemComment,\n\tSearchItemLinks,\n\tSearchItems,\n\tSearchItemSgnRegexp,\n\tSearchItemTitleRegexp,\n\tSearchLastModif,\n\tSearchLastModifIn,\n\tSearchLastUser,\n\tSearchLifeCycleStates,\n\tSearchOrphan,\n\tSearchRegexpUri,\n\tSearchResponsibilities,\n\tSearchStatus\n} from \"lib/wsp/search\";\nimport {IUiCritArea, OUiCritInit, OUiCritWithInputInit, UiCritArea, UiCritBase, UiCritBool, UiCritFree, UiCritSrcUri, UiCritSubRequest, UiCritUnknown, UiCritXpath} from \"back/wsp/widgets/search/uiCrit\";\nimport {OItemPointerInit, SrcPointerFastSelect, SrcPointerInline} from \"back/wsp/widgets/srcDrawer\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {SpaceSelector} from \"back/wsp/dialogs/spaceSelector\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {JSrcFields, SRC, srcUri} from \"lib/wsp/src\";\nimport {Button} from \"back/commons/widgets/buttons\";\nimport {ITEM} from \"lib/wsp/item\";\nimport {ItemTypesTree} from \"back/wsp/widgets/itemTypesTree\";\nimport {UserSelector} from \"back/core/dialogs/userSelector\";\nimport {EUserAspects, EUserType, JUser, USER} from \"lib/core/user\";\nimport {LANG} from \"lib/commons/lang\";\nimport {JTextWedSearchBarParams} from \"back/edit/wed/features/searchBar\";\nimport {JCommentWedSearchBarParams, JItemWedSearchBarParams} from \"back/wsp/widgets/wed/wspSearchBar\";\nimport {InputUserPanel, OInputUserInit} from \"back/core/widgets/inputs\";\nimport {InputPeriod} from \"back/core/widgets/inputPeriod\";\nimport {ItemType, LC_STATE_DEFAULT_KEY, LC_STATE_DEFAULT_NAME} from \"lib/wsp/wspMetaUi\";\nimport {OUserRefInit, UserRef} from \"back/core/widgets/userRef\";\n\n\n// Déclaration des criterions génériques pour la recherche d'items 'wsp.crit.items'.\nREG.reg.registerSvc(\"wsp-uicrit-bool:and\", 1, UiCritBool.AREA_AND);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-bool:and\", 1, \"wsp-uicrit-bool:and\");\nREG.reg.registerSvc(\"wsp-uicrit-bool:or\", 1, UiCritBool.AREA_OR);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-bool:or\", 1, \"wsp-uicrit-bool:or\");\nREG.reg.registerSvc(\"and\", 1, UiCritBool.AREA_AND_ROOT);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"and\", 1, \"and\");\nREG.reg.registerSvc(\"or\", 1, UiCritBool.AREA_OR_ROOT);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"or\", 1, \"or\");\nREG.reg.registerSvc(\"wsp-uicrit-free\", 1, UiCritFree.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-free\", 1, \"wsp-uicrit-free\");\nREG.reg.registerSvc(\"wsp-uicrit-srcuri-regexp\", 1, UiCritSrcUri.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-srcuri-regexp\", 1, \"wsp-uicrit-srcuri-regexp\");\nREG.reg.registerSvc(\"wsp-uicrit-xpath\", 1, UiCritXpath.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-xpath\", 1, \"wsp-uicrit-xpath\");\n\nREG.reg.registerSvc(\"wsp-uicrit-subrequest:parents\", 1, UiCritSubRequest.AREA_PARENTS);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-subrequest:parents\", 1, \"wsp-uicrit-subrequest:parents\");\nREG.reg.registerSvc(\"wsp-uicrit-subrequest:children\", 1, UiCritSubRequest.AREA_CHILDREN);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-subrequest:children\", 1, \"wsp-uicrit-subrequest:children\");\nREG.reg.registerSvc(\"wsp-uicrit-subrequest:asc\", 1, UiCritSubRequest.AREA_ASC);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-subrequest:asc\", 1, \"wsp-uicrit-subrequest:asc\");\nREG.reg.registerSvc(\"wsp-uicrit-subrequest:desc\", 1, UiCritSubRequest.AREA_DESC);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-uicrit-subrequest:desc\", 1, \"wsp-uicrit-subrequest:desc\");\n\nREG.reg.registerSvc(\"exp\", 1, UiCritUnknown.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"exp\", 1, \"exp\");\n\n/**\n * Scope de recherche par défaut sur tout l'atelier.\n *\n * NOTE : exclusion cachée d'espaces via une pref : ItemCritFullWsp.excludeSpaces\n * Valeur : \"/~hidden\" ou \"/~hidden;/~params\"\n */\nexport class ItemCritFullWsp extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-fullwsp\")\n\t\t.setLabel(\"Tout l'atelier\")\n\t\t.setCritSgn(\"scope\").setReplacePattern(/\\bscope\\b/) //.setGroup(\"scope\") pas un critère/filtre\n\t\t.setBuildAbstract(function (this: UiCritArea, xml: Element, ctx: OUiCritInit) {\n\t\t\tconst air = xml.getAttribute(\"uiAir\") === 'true';\n\t\t\tconst foreign = xml.getAttribute(\"uiForeign\") === 'true';\n\t\t\treturn <span class=\"crit\">{this.getLabel(ctx) + (air ? foreign ? \", items flottants et étrangers inclus\" : \", items flottants inclus\" : foreign ? \", items étrangers inclus\" : \"\")}</span>;\n\t\t});\n\n\tprotected _airItems: HTMLInputElement;\n\tprotected _foreignItems: HTMLInputElement;\n\n\tget withAirItems(): boolean {return this._airItems ? this._airItems.checked : false}\n\n\tget withForeignItems(): boolean {return this._foreignItems ? this._foreignItems.checked : false}\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst wsp = this.reg.env.wsp;\n\t\tconst sr = this.shadowRoot;\n\t\tsr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Tout l'atelier</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\t\tlet optsRoot = sr as Node;\n\t\tif (wsp.isAirItem && wsp.isExtItem) optsRoot = sr.appendChild(<div class=\"h\"/>);\n\t\tif (wsp.isAirItem) this._airItems = optsRoot.appendChild(<label class=\"opt\"><input type=\"checkbox\" checked=\"\" onclick={this.onChange}/>Items flottants inclus</label>).firstElementChild as HTMLInputElement;\n\t\tif (wsp.isExtItem) this._foreignItems = optsRoot.appendChild(<label class=\"opt\"><input type=\"checkbox\" onclick={this.onChange}/>Items étrangers inclus</label>).firstElementChild as HTMLInputElement;\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tif (this._airItems) this._airItems.checked = xml.getAttribute(\"uiAir\") === 'true';\n\t\tif (this._foreignItems) this._foreignItems.checked = xml.getAttribute(\"uiForeign\") === 'true';\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tconst crit = new SearchItems().excludeAirItems(!this.withAirItems).excludeExtItems(!this.withForeignItems).includeDrfErased(this.reg.env.wsp.wspDefProps.drfRefWsp != null);\n\t\tconst fixExclude = this.reg.getPref<string>(\"ItemCritFullWsp.excludeSpaces\"); //Valeur : \"/~hidden\" ou \"/~hidden;/~params\"\n\n\t\tif (fixExclude) crit.excludeSpaces(...fixExclude.split(';'));\n\t\treturn crit;\n\t}\n\n\tbuildUiXmlCrit(): Element | undefined {\n\t\tconst crit = this.buildCrit().toDom();\n\t\tcrit.setAttribute(\"uiCrit\", this.getUiCritXmlAtt());\n\t\tif (this.withAirItems) crit.setAttribute(\"uiAir\", \"true\");\n\t\tif (this.withForeignItems) crit.setAttribute(\"uiForeign\", \"true\");\n\t\treturn crit;\n\t}\n}\n\n// REG.reg.registerSkin('wsp-itemcrit-fullWsp', 1, /* language=CSS */ `\n// `);\n\ncustomElements.define(\"wsp-itemcrit-fullwsp\", ItemCritFullWsp);\n\nREG.reg.registerSvc(\"wsp-itemcrit-fullwsp\", 1, ItemCritFullWsp.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-fullwsp\", 1, \"wsp-itemcrit-fullwsp\");\n\n\n/**\n *\n */\nclass UiCritLinksArea extends UiCritArea {\n\n\tconstructor(public linkAxis: 'LinkAsc' | 'LinkDesc' | 'LinkChildren' | 'LinkParents', protected abstractStrPrefix?: string, public traitsCodeList: string|null = \"linktraits:search:defaultList\") {\n\t\tsuper(\"wsp-itemcrit-links\");\n\t\tthis.setReplacePattern(/\\bscope\\b/);\n\t\tthis.setCritSgn(\"scope\");\n\t\tthis.setGroup(\"scope\");\n\t}\n\n\tbuildAbstract(xml: Element, ctx: OUiCritInit, options?: any): HTMLElement | undefined {\n\t\tif (this.abstractStrPrefix) {\n\t\t\tconst path = xml.getAttribute('path') || \"\";\n\t\t\tlet result = super.buildAbstract(xml, ctx, options);\n\t\t\tif (path) {\n\t\t\t\tlet srcPointer: SrcPointerInline = <SrcPointerInline î={{\n\t\t\t\t\treg: ctx.reg,\n\t\t\t\t} as OItemPointerInit}/> as SrcPointerInline;\n\t\t\t\tPromise.resolve(srcPointer.setSrcRef(path)).then(() => {\n\t\t\t\t\tresult.innerText = this.abstractStrPrefix;\n\t\t\t\t\tresult.appendChild(<span class=\"critVal\"/>).appendChild(srcPointer);\n\t\t\t\t\tconst linkTraitFilter = xml.getAttribute('linkTraitFilter') || \"\";\n\t\t\t\t\tif(linkTraitFilter){\n\t\t\t\t\t\tconst traits = ctx.reg.getListAsMap(this.traitsCodeList) as Dict<string> || {};\n\t\t\t\t\t\tresult.appendChild(<span>(filtre '{traits[linkTraitFilter] || linkTraitFilter}')</span>)\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn result;\n\t\t} else\n\t\t\treturn super.buildAbstract(xml, ctx, options);\n\t}\n\n\tsetLinkAxis(linkAxis: 'LinkAsc' | 'LinkDesc' | 'LinkChildren' | 'LinkParents'): this {\n\t\tthis.linkAxis = linkAxis;\n\t\treturn this;\n\t}\n}\n\n/**\n * Scope de recherche parcourant les liens à partir d'un item.\n */\nexport class ItemCritLinks extends UiCritBase {\n\n\tstatic AREA_DESC = new UiCritLinksArea(\"LinkDesc\", \"Dans le réseau descendant de l'item\").setLabel(\"Réseau descendant d'un item\");\n\n\tstatic AREA_ASC = new UiCritLinksArea(\"LinkAsc\", \"Dans le réseau ascendant de l'item\").setLabel(\"Réseau ascendant d'un item\");\n\n\tstatic AREA_CHILDREN = new UiCritLinksArea(\"LinkChildren\", \"Dans les items liés de l'item\").setLabel(\"Items liés par un item\");\n\n\tstatic AREA_PARENTS = new UiCritLinksArea(\"LinkParents\", \"Dans les items liants l'item\").setLabel(\"Items liant un item\")\n\t\t.setBuildWedSearch((xml: Element, criterions: Dict<IUiCritArea>): JItemWedSearchBarParams => {\n\t\t\treturn {\n\t\t\t\tsearchId: \"item\",\n\t\t\t\tfindRef: xml.getAttribute('path')\n\t\t\t}\n\t\t});\n\n\tcritArea: UiCritLinksArea;\n\n\tget linkAxis(): 'LinkAsc' | 'LinkDesc' | 'LinkChildren' | 'LinkParents' {return this.critArea.linkAxis}\n\n\tget traitsCodeList():string|null{return this.critArea.traitsCodeList}\n\n\titemPtr: SrcPointerInline;\n\n\ttrFilter : HTMLSelectElement|null;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tconst axis = this.linkAxis;\n\t\tthis.itemPtr = <SrcPointerInline î={{\n\t\t\treg: this.reg,\n\t\t\tdefaultAction: SrcPointerFastSelect.SINGLETON\n\t\t} as OItemPointerInit}/> as SrcPointerInline;\n\n\t\tsr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">{axis === 'LinkDesc' ? \"Descendants de\" : axis === 'LinkAsc' ? \"Ascendants de\" : axis === 'LinkChildren' ? \"Items liés par\" : \"Items liants\"}</span>\n\t\t\t{this.itemPtr}\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\n\t\tif(this.traitsCodeList){\n\t\t\tconst traits = this.reg.getListAsMap(this.traitsCodeList) as Dict<string>;\n\t\t\tif(traits){\n\t\t\t\tthis.trFilter = <select onchange={this.onChange}>\n\t\t\t\t\t<option value=\"\" selected>Aucun filtre</option>\n\t\t\t\t</select> as HTMLSelectElement;\n\t\t\t\tfor (const tr in traits)\n\t\t\t\t\tthis.trFilter.appendChild(<option value={tr}>{traits[tr]}</option>);\n\t\t\t\tsr.appendChild(<div class=\"h\">\n\t\t\t\t\t{this.trFilter}\n\t\t\t\t</div>)\n\t\t\t}\n\t\t}\n\n\t\tthis.itemPtr.onSrcRefChange.add(this.onChange);\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tconst path = xml.getAttribute('path');\n\t\tif (path) {\n\t\t\tawait this.itemPtr.setSrcRef(path);\n\t\t\tif (!this.itemPtr.shortDesc || ITEM.getSrcUriType(this.itemPtr.shortDesc.srcUri) != \"item\")\n\t\t\t\tthis.itemPtr.setSrcRef(null);\n\t\t}\n\t\tconst linkTraitFilter = xml.getAttribute('linkTraitFilter');\n\t\tif(linkTraitFilter && this.trFilter)\n\t\t\tthis.trFilter.value =linkTraitFilter\n\n\t\treturn this;\n\t}\n\n\tasync initFromInsAction(xml?: Element): Promise<this> {\n\t\tconst path = xml ? xml.getAttribute('path') : null;\n\t\tif (path) {\n\t\t\tawait this.itemPtr.setSrcRef(path);\n\t\t\tif (!this.itemPtr.shortDesc || ITEM.getSrcUriType(this.itemPtr.shortDesc.srcUri) != \"item\") {\n\t\t\t\tthis.itemPtr.setSrcRef(null);\n\t\t\t\tawait this.itemPtr.openFastSelect();\n\t\t\t}\n\t\t} else if (!this.itemPtr.srcRef) {\n\t\t\tawait this.itemPtr.openFastSelect();\n\t\t}\n\n\t\tconst linkTraitFilter = xml ? xml.getAttribute('linkTraitFilter') : null;\n\t\tif(linkTraitFilter && this.trFilter)\n\t\t\tthis.trFilter.value =linkTraitFilter\n\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\treturn new SearchItemLinks(this.linkAxis).setPath(this.itemPtr.srcRef).setLinkTraitFilter(this.trFilter?.value);\n\t}\n\n\tprotected getUiCritXmlAtt(): string {\n\t\treturn this.linkAxis;\n\t}\n\n}\n\nREG.reg.registerSkin('wsp-itemcrit-links', 1, /* language=CSS */ `\n\twsp-src-pointer-inline {\n\t\tflex: 1;\n\t}\n`);\n\ncustomElements.define(\"wsp-itemcrit-links\", ItemCritLinks);\n\nREG.reg.registerSvc(\"LinkDesc\", 1, ItemCritLinks.AREA_DESC);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"LinkDesc\", 1, \"LinkDesc\");\nREG.reg.registerSvc(\"LinkAsc\", 1, ItemCritLinks.AREA_ASC);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"LinkAsc\", 1, \"LinkAsc\");\nREG.reg.registerSvc(\"LinkChildren\", 1, ItemCritLinks.AREA_CHILDREN);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"LinkChildren\", 1, \"LinkChildren\");\nREG.reg.registerSvc(\"LinkParents\", 1, ItemCritLinks.AREA_PARENTS);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"LinkParents\", 1, \"LinkParents\");\n\n\n/**\n * Scope de recherche à partir d'un espace.\n */\nexport class ItemCritInSpace extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-inspace\").setLabel(\"Dans un espace\").setCritSgn(\"scope\").setGroup(\"scope\").setReplacePattern(/\\bscope\\b/).setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\tconst path = xml.getAttribute('uiPath') || \"\";\n\t\treturn path ? <span class=\"crit\">Dans l'espace '<span class=\"critVal\">{path}</span>'</span> : <span class=\"crit\">Dans un espace</span>;\n\t});\n\t//this.setCritSgn(\"scope\");\n\t//this.setGroup(\"scope\");\n\t_spaceUri: srcUri;\n\n\tget spaceUri(): srcUri {return this._spaceUri};\n\n\tset spaceUri(uri: srcUri) {\n\t\tthis._spaceUri = ITEM.extractSpaceUri(uri);\n\t\tthis._spaceBtn.label = this.spaceUri || \" \";\n\t}\n\n\tprotected _spaceBtn: Button;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tsr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Dans l'espace</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\t\tthis._spaceBtn = sr.appendChild(<Button id=\"space\" icon={this.reg.env.wsp.wspMetaUi.getSpaceIcon()} onclick={this.onChooseSpace} title=\"Sélectionner un espace...\"/>) as Button;\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tconst path = xml.getAttribute('uiPath');\n\t\tif (path != null && !SRC.isSrcId(path)) this.spaceUri = path;\n\t\treturn this;\n\t}\n\n\tasync initFromInsAction(xml?: Element): Promise<this> {\n\t\tconst path = xml ? xml.getAttribute('uiPath') : null;\n\t\tif (path != null && !SRC.isSrcId(path)) {\n\t\t\tthis.spaceUri = path;\n\t\t} else if (!this.spaceUri) {\n\t\t\tawait this.onChooseSpace.call(this._spaceBtn);\n\t\t}\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tif (this.spaceUri == null) return undefined;\n\t\treturn new SearchItems().inSpace(this.spaceUri);\n\t}\n\n\tbuildUiXmlCrit(): Element | undefined {\n\t\tconst crit: Element = super.buildUiXmlCrit();\n\t\tif (crit && this.spaceUri) crit.setAttribute(\"uiPath\", this.spaceUri);\n\t\treturn crit;\n\t}\n\n\tasync onChooseSpace(this: Button, ev?: Event) {\n\t\tconst me = DOMSH.findHost(this) as ItemCritInSpace;\n\t\tconst {SpaceSelector} = await import(\"back/wsp/dialogs/spaceSelector.js\");\n\t\tconst ct = new SpaceSelector().initialize({\n\t\t\treg: me.reg,\n\t\t\tstartSel: me.spaceUri,\n\t\t\tselOnDblClick: true\n\t\t});\n\t\tconst space = await POPUP.showMenuFromEvent<JSrcFields | null>(ct, ev || me, me).onNextClose();\n\t\tif (space) {\n\t\t\tme.spaceUri = space.srcUri;\n\t\t\tme._spaceBtn.label = me.spaceUri;\n\t\t\tme.dispatchChangeEvent();\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-itemcrit-inspace', 1, /* language=CSS */ `\n\t#space {\n\t\tjustify-content: start;\n\t\tfont-size: 1em;\n\t\t/*background-color: var(--form-bgcolor);\n\t\tcolor: var(--form-color);*/\n\t}\n`);\n\ncustomElements.define(\"wsp-itemcrit-inspace\", ItemCritInSpace);\n\nREG.reg.registerSvc(\"wsp-itemcrit-inspace\", 1, ItemCritInSpace.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-inspace\", 1, \"wsp-itemcrit-inspace\");\n\n\n/**\n * Recherche full text\n */\nexport class ItemCritFullText extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-fulltext\").setLabel(\"Texte\")\n\t\t.setCritSgn(\"string\").setReplacePattern(/\\bstring\\b/).setGroup(\"props\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tconst txt = xml.getAttribute(\"textSearch\") || \"\";\n\t\t\tconst opts = xml.getAttribute(\"options\") || \"\";\n\t\t\treturn <span class=\"crit\">Texte contient '<span class=\"critVal\">{txt}</span>'{opts.indexOf(';w;') >= 0 ? ', mot entier' : undefined}{opts.indexOf(';c;') >= 0 ? ', casse respectée' : undefined}</span>;\n\t\t}).setBuildWedSearch((xml: Element, criterions: Dict<IUiCritArea>): JTextWedSearchBarParams => {\n\t\t\tconst opts = xml.getAttribute(\"options\") || \"\";\n\t\t\treturn {\n\t\t\t\tsearchId: \"text\",\n\t\t\t\ttext: xml.getAttribute(\"textSearch\") || \"\",\n\t\t\t\twholeWord: opts.indexOf(';w;') >= 0,\n\t\t\t\tmatchCase: opts.indexOf(';c;') >= 0\n\t\t\t}\n\t\t});\n\n\tprotected _text: HTMLInputElement;\n\tprotected _ignoreCase: HTMLInputElement;\n\tprotected _wholeWord: HTMLInputElement;\n\n\tprotected _initialize(init: OUiCritInit & OUiCritWithInputInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tthis._text = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Texte</span>\n\t\t\t<input type=\"search\" oninput={this.onChange} placeholder={init.placeholder}/>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>).querySelector(\"input\");\n\t\tconst optsRoot = sr.appendChild(<div class=\"h\"/>);\n\t\tthis._ignoreCase = optsRoot.appendChild(<label class=\"opt\"><input type=\"checkbox\" onclick={this.onChange}/>Respect de la casse</label>).firstElementChild as HTMLInputElement;\n\t\tthis._wholeWord = optsRoot.appendChild(<label class=\"opt\"><input type=\"checkbox\" onclick={this.onChange}/>Mot entier</label>).firstElementChild as HTMLInputElement;\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tthis._text.value = xml.getAttribute('textSearch') || \"\";\n\t\tconst opts = xml.getAttribute('options') || \"\";\n\t\tthis._ignoreCase.checked = opts.indexOf(';c;') >= 0;\n\t\tthis._wholeWord.checked = opts.indexOf(';w;') >= 0;\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tconst v = this._text.value;\n\t\treturn v ? new SearchFullText(v, this._ignoreCase.checked, this._wholeWord.checked) : undefined;\n\t}\n\n}\n\ncustomElements.define(\"wsp-itemcrit-fulltext\", ItemCritFullText);\n\nREG.reg.registerSvc(\"wsp-itemcrit-fulltext\", 1, ItemCritFullText.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-fulltext\", 1, \"wsp-itemcrit-fulltext\");\n\n/**\n * Code de l'item\n */\nexport class ItemCritSrcCode extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-srccode\").setLabel(\"Code de l'item\")\n\t\t.setCritSgn(\"string\").setReplacePattern(/\\bstring\\b/).setGroup(\"props\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tconst searchTxt = <span class=\"critVal\">{xml.getAttribute(\"uiTextSearch\") || \"\"}</span>;\n\t\t\treturn <span class=\"crit\">Code de l'item contient '{searchTxt}'</span>;\n\t\t});\n\n\tprotected _textElt: HTMLInputElement;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tthis._textElt = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Code de l'item</span>\n\t\t\t<input type=\"search\" oninput={this.onChange}/>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>).querySelector(\"input\");\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tthis._textElt.value = xml.getAttribute('uiTextSearch') || \"\";\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tconst v = this._textElt.value;\n\t\tif (v) {\n\t\t\tconst regexp = new RegExp(\".*\" + v.replace(/\\W/g, LANG.escapeChar4Regexp) + \"[^\\/]*\", \"i\");\n\t\t\treturn new SearchRegexpUri(regexp);\n\t\t} else\n\t\t\treturn undefined;\n\t}\n\n\t/**\n\t * Critères UI :\n\t *  - uiTextSearch\n\t */\n\tbuildUiXmlCrit(): Element | undefined {\n\t\tconst crit: Element = super.buildUiXmlCrit();\n\t\tif (crit) crit.setAttribute(\"uiTextSearch\", this._textElt.value);\n\t\treturn crit;\n\t}\n\n}\n\ncustomElements.define(\"wsp-itemcrit-srccode\", ItemCritSrcCode);\n\nREG.reg.registerSvc(\"wsp-itemcrit-srccode\", 1, ItemCritSrcCode.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-srccode\", 1, \"wsp-itemcrit-srccode\");\n\n/**\n * Recherche dans le titre\n */\nexport class ItemCritTitleRegExp extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-title\").setLabel(\"Titre\")\n\t\t.setCritSgn(\"string\").setReplacePattern(/\\bstring\\b/).setGroup(\"props\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tconst searchTxt = <span class=\"critVal\">{xml.getAttribute(\"uiTextSearch\") || xml.getAttribute(\"regexp\")}</span>;\n\t\t\treturn <span class=\"crit\">Titre contient '{searchTxt}'</span>;\n\t\t});\n\n\tprotected _textElt: HTMLInputElement;\n\tprotected _regExpElt: HTMLInputElement;\n\n\tget isRegExp(): boolean {return this._regExpElt ? this._regExpElt.checked : false}\n\n\tprotected _initialize(init: OUiCritInit & OUiCritWithInputInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tthis._textElt = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Titre</span>\n\t\t\t<input type=\"search\" oninput={this.onChange} placeholder={init.placeholder}/>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>).querySelector(\"input\");\n\t\tconst optsRoot = sr.appendChild(<div class=\"h\"/>);\n\t\tthis._regExpElt = optsRoot.appendChild(<label class=\"opt\"><input type=\"checkbox\" onclick={this.onChange}/>Expression régulière</label>).firstElementChild as HTMLInputElement;\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tif (xml.hasAttribute('uiTextSearch')) {\n\t\t\t// texte\n\t\t\tthis._textElt.value = xml.getAttribute('uiTextSearch') || \"\";\n\t\t\tthis._regExpElt.checked = false;\n\t\t} else {\n\t\t\t// regExp\n\t\t\tthis._textElt.value = xml.getAttribute('regexp') || \"\";\n\t\t\tthis._regExpElt.checked = true;\n\t\t}\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tconst v = this._textElt.value;\n\t\tif (v && this.isRegExp) {\n\t\t\treturn new SearchItemTitleRegexp(new RegExp(v));\n\t\t} else if (v) {\n\t\t\tconst regexp = new RegExp(\".*\" + v.replace(/\\W/g, LANG.escapeChar4Regexp) + \".*\", \"i\");\n\t\t\treturn new SearchItemTitleRegexp(regexp);\n\t\t} else\n\t\t\treturn undefined;\n\t}\n\n\tbuildUiXmlCrit(): Element | undefined {\n\t\tconst crit: Element = super.buildUiXmlCrit();\n\t\tif (crit && !this.isRegExp) crit.setAttribute(\"uiTextSearch\", this._textElt.value);\n\t\treturn crit;\n\t}\n\n}\n\ncustomElements.define(\"wsp-itemcrit-title\", ItemCritTitleRegExp);\n\nREG.reg.registerSvc(\"wsp-itemcrit-title\", 1, ItemCritTitleRegExp.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-title\", 1, \"wsp-itemcrit-title\");\n\n\n\n/**\n * Filtre pour rechercher dans le code ou le titre\n * Le critère n'a pas de libellé ni d'options, en vue d'une utilisation dans un panneau de navigation\n */\nexport class ItemCritCodeOrTitleFilter extends UiCritBase {\n\tprotected _textElt: HTMLInputElement;\n\n\tprotected _initialize(init: OUiCritInit & OUiCritWithInputInit): void {\n\t\tsuper._initialize(init);\n\t\tconst placeholder = \"placeholder\" in init ? init.placeholder : \"Filtrer...\";\n\t\tthis._textElt = this.shadowRoot.appendChild(<label id=\"search\">\n\t\t\t<input type=\"search\" oninput={this.onChange} placeholder={placeholder}/>\n\t\t</label>).querySelector(\"input\");\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tconst v = this._textElt.value;\n\t\tconst regexp = new RegExp(\".*\" + v.replace(/\\W/g, LANG.escapeChar4Regexp) + \".*\", \"i\");\n\t\tif (v) return new SearchItemCodeOrTitle(regexp);\n\t\treturn undefined;\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tthis._textElt.value = xml.getAttribute('regexp') || \"\";\n\t\treturn this;\n\t}\n}\n\n\nREG.reg.registerSkin('wsp-itemcrit-codeortitlefilter', 1, /* language=CSS */ `\n\t:host {\n\t\tpadding: 0px;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\t\n\t#search {\n\t\tbackground: 0.1em / 1em no-repeat url(/@skin@/commons/icons/filter.svg) var(--form-search-bgcolor);\n\t\tpadding-inline-start: 1.2em;\n\t\tflex: 1;\n\t}\n\n\tinput:focus {\n\t\toutline: var(--focus-outline);\n\t\toutline-offset: -1px;\n\t}\n\t\n\tinput {\n\t\tmargin: 0;\n\t\tpadding: 2px;\n\t\tborder: none;\n\t\twidth: 100%;\n\t\tfont-size: inherit;\n\t}\n\t\n\tinput::placeholder {\n\t\tcolor: var(--fade-color);\n\t\tletter-spacing: 2px;\n\t\tfont-size: var(--label-size);\n\t\tfont-style: italic;\n\t}\n\n\tinput:focus::placeholder {\n\t\tcolor: transparent;\n\t}\n`);\ncustomElements.define(\"wsp-itemcrit-codeortitlefilter\", ItemCritCodeOrTitleFilter);\n\n\n/**\n * Items orphelins\n */\nexport class ItemCritOrphan extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-orphan\").setLabel(\"Items orphelins\").setGroup(\"item\").setCritSgn(\"noProps\").setReplacePattern(/\\bnoProps\\b/);\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tthis.shadowRoot.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Items orphelins (référencés par aucun autre item)</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>).querySelector(\"input\");\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\treturn new SearchOrphan();\n\t}\n\n}\n\ncustomElements.define(\"wsp-itemcrit-orphan\", ItemCritOrphan);\nREG.reg.registerSvc(\"wsp-itemcrit-orphan\", 1, ItemCritOrphan.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-orphan\", 1, \"wsp-itemcrit-orphan\");\n\n\n/**\n * Items étrangers\n */\nexport class ItemCritForeign extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-foreign\").setLabel(\"Items étrangers\").setDescription(\"Items appartenant à un autre atelier\")\n\t\t.setGroup(\"item\").setCritSgn(\"noProps\").setReplacePattern(/\\bnoProps\\b/)\n\t\t.setVisible((ctx) => ctx.reg.env.wsp.isExtItem);\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tthis.shadowRoot.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Items étrangers</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>).querySelector(\"input\");\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\treturn new SearchRegexpUri(new RegExp(\"^\" + LANG.escape4Regexp(ITEM.EXT_PREFIX) + \".*\"))\n\t}\n}\n\ncustomElements.define(\"wsp-itemcrit-foreign\", ItemCritForeign);\nREG.reg.registerSvc(\"wsp-itemcrit-foreign\", 1, ItemCritForeign.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-foreign\", 1, \"wsp-itemcrit-foreign\");\n\n\n/**\n * Items flottants\n */\nexport class ItemCritAir extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-air\").setLabel(\"Items flottants\")\n\t\t.setGroup(\"item\").setCritSgn(\"noProps\").setReplacePattern(/\\bnoProps\\b/)\n\t\t.setVisible((ctx) => ctx.reg.env.wsp.isAirItem);\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tthis.shadowRoot.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Items flottants</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>).querySelector(\"input\");\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\treturn new SearchRegexpUri(new RegExp(\"^\" + LANG.escape4Regexp(ITEM.AIR_PREFIX) + \".*\"))\n\t}\n}\n\ncustomElements.define(\"wsp-itemcrit-air\", ItemCritAir);\nREG.reg.registerSvc(\"wsp-itemcrit-air\", 1, ItemCritAir.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-air\", 1, \"wsp-itemcrit-air\");\n\n\n/**\n * Statut de l'item\n *    <wsp-itemcrit-status withWarning=\"false\"/>\n */\nexport class ItemCritStatus extends UiCritBase {\n\n\tstatic STATUS: { [index: string]: any } = {\n\t\t//\"min-max\" : [longLabel, shortLabel]\n\t\t\"3-3\": [\"Items en erreur\", \"en erreur\"],\n\t\t\"2-2\": [\"Items en alerte\", \"en alerte\"],\n\t\t\"1-1\": [\"Items valides\", \"valides\"],\n\t\t\"2-3\": [\"Items en erreur ou en alerte\", \"en erreur ou en alerte\"],\n\t\t\"1-2\": [\"Items valides ou en alerte\", \"valides ou en alerte\"],\n\t};\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-status\").setLabel(\"Statut de l'item\")\n\t\t.setCritSgn(\"noProps\").setReplacePattern(/\\bnoProps\\b/).setGroup(\"item\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tconst itemStatusMin = xml.getAttribute(\"itemStatusMin\") || \"\";\n\t\t\tconst itemStatusMax = xml.getAttribute(\"itemStatusMax\") || \"\";\n\t\t\treturn <span class=\"crit\">Statut <span class=\"critVal\">{ItemCritStatus.STATUS[itemStatusMin + \"-\" + itemStatusMax][1]}</span></span>;\n\t\t});\n\n\tprotected _statusElt: HTMLSelectElement;\n\n\tprotected _withWarning: Boolean = false;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\n\t\tthis._withWarning = this.hasAttribute(\"withWarning\") ? this.getAttribute(\"withWarning\") == \"true\" : this.reg.getPref(\"itemCritStatus.withWarning\", false);\n\n\t\tconst sr = this.shadowRoot;\n\t\tthis._statusElt = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Statut</span>\n\t\t\t<select onchange={this.onChange}/>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>).querySelector(\"select\");\n\t\tthis._statusElt.appendChild(<option value=\"3-3\" selected>{ItemCritStatus.STATUS[\"3-3\"][0]}</option>);\n\t\tif (this._withWarning) this._statusElt.appendChild(<option value=\"2-2\">{ItemCritStatus.STATUS[\"2-2\"][0]}</option>);\n\t\tthis._statusElt.appendChild(<option value=\"1-1\">{ItemCritStatus.STATUS[\"1-1\"][0]}</option>);\n\t\tif (this._withWarning) this._statusElt.appendChild(<option value=\"2-3\">{ItemCritStatus.STATUS[\"2-3\"][0]}</option>);\n\t\tif (this._withWarning) this._statusElt.appendChild(<option value=\"1-2\">{ItemCritStatus.STATUS[\"1-2\"][0]}</option>);\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tconst itemStatusMin: number = Number.parseInt(xml.getAttribute(\"itemStatusMin\")) || 3;\n\t\tconst itemStatusMax: number = Number.parseInt(xml.getAttribute(\"itemStatusMax\")) || 3;\n\t\tthis._statusElt.value = itemStatusMin + \"-\" + itemStatusMax\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tconst v = this._statusElt.value.split(\"-\");\n\t\treturn v ? new SearchStatus(Number.parseInt(v[0]), Number.parseInt(v[1])) : undefined;\n\t}\n}\n\ncustomElements.define(\"wsp-itemcrit-status\", ItemCritStatus);\n\nREG.reg.registerSvc(\"wsp-itemcrit-status\", 1, ItemCritStatus.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-status\", 1, \"wsp-itemcrit-status\");\n\n/**\n * Date de modification\n *    <wsp-itemcrit-lastmodif/>\n */\nexport class ItemCritLastModif extends UiCritBase {\n\n\tstatic OPERATORS: { [index: string]: string } = {\n\t\t//\"op\" : [shortLabel]\n\t\t\"lt\": \"avant le\",\n\t\t\"gt=\": \"à partir du\",\n\t\t\"lt=.lt\": \"le\"\n\t};\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-lastmodif\").setLabel(\"Date de modification\").setDescription(\"Date de dernière modification\")\n\t\t.setCritSgn(\"dateProps\").setReplacePattern(/\\bdateProps\\b/).setGroup(\"item\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tconst options: Intl.DateTimeFormatOptions = {year: 'numeric', month: 'numeric', day: 'numeric'};\n\t\t\tconst op = xml.getAttribute(\"op\") || \"\";\n\t\t\tconst date = xml.getAttribute(\"value\") || \"\";\n\t\t\tconst dateObj: Date = new Date(Number.parseInt(date.split(\",\")[0]))\n\t\t\tconst operatorTxt = ItemCritLastModif.OPERATORS[op];\n\t\t\tconst dateTxt = <span class=\"critVal\">{dateObj.toLocaleDateString(\"fr\", options)}</span>;\n\t\t\treturn <span class=\"crit\">Modifiés {operatorTxt} {dateTxt}</span>;\n\t\t});\n\n\tprotected _opElt: HTMLSelectElement;\n\n\tprotected _dateElt: HTMLInputElement;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\n\t\tconst critHead = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Date de modification</span>\n\t\t\t<select onchange={this.onChange}/>\n\t\t\t<input type=\"date\" onchange={this.onChange}/>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\n\t\tthis._opElt = critHead.querySelector(\"select\");\n\t\tthis._opElt.appendChild(<option value=\"lt\" selected>{ItemCritLastModif.OPERATORS[\"lt\"]}</option>);\n\t\tthis._opElt.appendChild(<option value=\"gt=\" selected>{ItemCritLastModif.OPERATORS[\"gt=\"]}</option>);\n\t\tthis._opElt.appendChild(<option value=\"lt=.lt\" selected>{ItemCritLastModif.OPERATORS[\"lt=.lt\"]}</option>);\n\n\t\tthis._dateElt = critHead.querySelector(\"input\");\n\t\tthis._dateElt.valueAsDate = new Date();\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tconst operator = xml.getAttribute(\"op\");\n\t\tconst value = xml.getAttribute(\"value\");\n\t\tthis._opElt.value = operator;\n\t\tthis._dateElt.valueAsDate = new Date(Number.parseInt(value.split(\",\")[0]));\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tif (this._dateElt.value) {\n\t\t\tif (this._opElt.value == \"lt=.lt\") {\n\t\t\t\tconst vStart = this._dateElt.valueAsDate;\n\t\t\t\tconst vEnd = new Date(vStart.getFullYear(), vStart.getMonth(), vStart.getDate() + 1);\n\t\t\t\treturn new SearchLastModifIn(this._opElt.value as EOperatorsIn, vStart, vEnd);\n\t\t\t} else\n\t\t\t\treturn new SearchLastModif(this._opElt.value as EOperatorsSimple, this._dateElt.valueAsDate);\n\t\t}\n\t\treturn undefined;\n\t}\n}\n\ncustomElements.define(\"wsp-itemcrit-lastmodif\", ItemCritLastModif);\n\nREG.reg.registerSvc(\"wsp-itemcrit-lastmodif\", 1, ItemCritLastModif.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-lastmodif\", 1, \"wsp-itemcrit-lastmodif\");\n\n/**\n * Dernier utilisateur à avoir modifié l'item\n *    <wsp-itemcrit-lastuser/>\n */\nexport class ItemCritLastUser extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-lastuser\").setLabel(\"Dernière personne à avoir modifié l'item\")\n\t\t.setCritSgn(\"userProps\").setReplacePattern(/\\buserProps\\b/).setGroup(\"item\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tconst users = xml.getAttribute('users');\n\t\t\tif (users) {\n\t\t\t\tlet accounts = users.split(\" \");\n\t\t\t\tconst usersListVal = <span class=\"critVal\">{accounts.join(\", \")}</span>;\n\t\t\t\tconst resulElt = <span class=\"crit\">Modifié par {usersListVal}</span>;\n\t\t\t\tctx.reg.env.universe.useUsers.getUserSet(accounts).then(users => {\n\t\t\t\t\tif (users) {\n\t\t\t\t\t\taccounts = [];\n\t\t\t\t\t\tconst names: string[] = [];\n\t\t\t\t\t\tusers.forEach(user => {\n\t\t\t\t\t\t\taccounts.push(USER.getPrimaryName(user));\n\t\t\t\t\t\t\tnames.push(USER.getLongName(user));\n\t\t\t\t\t\t});\n\t\t\t\t\t\tusersListVal.textContent = accounts.join(\", \");\n\t\t\t\t\t\tusersListVal.setAttribute(\"title\", names.join(\", \"));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn resulElt;\n\t\t\t}\n\t\t}).setVisible((ctx) => {\n\t\t\treturn !ctx.reg.env.universe.auth.config.noAuthentication;\n\t\t});\n\n\t_selectedUsers: JUser[];\n\n\tget selectedUsers(): JUser[] {return this._selectedUsers};\n\n\tset selectedUsers(users: JUser[]) {\n\t\tthis._selectedUsers = users;\n\t\tthis.refreshUi();\n\t}\n\n\tprotected _userBtn: Button;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tconst critHead = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Dernière personne à avoir modifié l'item</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\t\tthis._userBtn = sr.appendChild(<Button id=\"users\" onclick={this.onChooseUser} title=\"Sélectionner un utilisateur...\"/>) as Button;\n\t\tthis.refreshUi();\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tconst users = xml.getAttribute('users');\n\t\tif (users)\n\t\t\tthis.selectedUsers = await this.reg.env.universe.useUsers.getUserSet(users.split(\" \"));\n\t\treturn this;\n\t}\n\n\tasync initFromInsAction(xml?: Element): Promise<this> {\n\t\tawait super.initFromInsAction(xml);\n\t\tif (!this.selectedUsers || this.selectedUsers.length == 0)\n\t\t\tawait this.onChooseUser.call(this._userBtn);\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tif (this.selectedUsers == null) return undefined;\n\t\treturn new SearchLastUser(this.selectedUsers);\n\t}\n\n\tasync onChooseUser(this: Button, ev?: Event) {\n\t\tconst me = DOMSH.findHost(this) as ItemCritLastUser;\n\t\tconst {UserSelector} = await import(\"back/core/dialogs/userSelector.js\");\n\t\tconst userSelector = new UserSelector().initialize({\n\t\t\treg: me.reg,\n\t\t\tstartSel: me.selectedUsers,\n\t\t\tuserGrid: {\n\t\t\t\tusersSrv: me.reg.env.universe.useUsers,\n\t\t\t\tgrid: {\n\t\t\t\t\tselType: \"multi\"\n\t\t\t\t},\n\t\t\t\tfilterTypeInputVisibility: true,\n\t\t\t\tfilterType: EUserType.user,\n\t\t\t\tpreserveSelectionOnFilter: true,\n\t\t\t},\n\t\t\tselectAndCloseOnDblClick: true\n\t\t});\n\t\tconst user = await POPUP.showMenuFromEvent<JUser[] | null>(userSelector, ev || me, me, null, { initWidth: '20em'}).onNextClose();\n\t\tif (user) {\n\t\t\tme.selectedUsers = user;\n\t\t\tme.dispatchChangeEvent();\n\t\t}\n\t}\n\n\tprivate refreshUi(): void {\n\t\twhile (this._userBtn.lastChild) this._userBtn.removeChild(this._userBtn.lastChild);\n\t\tif (this.selectedUsers && this.selectedUsers.length > 0) {\n\t\t\tthis.selectedUsers.forEach((user) => {\n\t\t\t\tthis._userBtn.appendChild(<div class=\"userEntry\">\n\t\t\t\t\t<img src={USER.getIconUrl(user)}/>\n\t\t\t\t\t{USER.getPrimaryName(user)}\n\t\t\t\t</div>);\n\t\t\t});\n\t\t} else\n\t\t\tthis._userBtn.appendChild(<div class=\"noEntry\">Veuillez sélectionner des utilisateurs...</div>);\n\t}\n}\n\nREG.reg.registerSkin('wsp-itemcrit-lastuser', 1, /* language=CSS */ `\n\tc-button {\n\t\talign-items: start;\n\t\tflex-direction: column;\n\t}\n\n\t#users {\n\t\tjustify-content: start;\n\t\tfont-size: 1em;\n\t}\n\n\t.noEntry {\n\t\tfont-style: italic;\n\t\tcolor: var(--fade-color);\n\t}\n\n\t.userEntry {\n\t\tlist-style: none;\n\t\tdisplay: list-item;\n\t\tmargin-inline-start: 1em;\n\t}\n\n\t.userEntry > img {\n\t\theight: 1em;\n\t\tmargin-inline-end: .5em;\n\t}\n`);\n\ncustomElements.define(\"wsp-itemcrit-lastuser\", ItemCritLastUser);\n\nREG.reg.registerSvc(\"wsp-itemcrit-lastuser\", 1, ItemCritLastUser.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-lastuser\", 1, \"wsp-itemcrit-lastuser\");\n\n\n/**\n * Type de l'item (class)\n *    <wsp-itemcrit-type/>\n *    Possibilité de filter la liste des itemTypes proposés via\n *    \t- la propriété 'itemTypeReducer'\n *    \t- ou, à défaut, le svc du registre `itemCritType.itemTypeReducer`\n */\nexport class ItemCritType extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-type\").setLabel(\"Type de l'item\")\n\t\t.setGroup(\"item\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tconst itModels = xml ? xml.getAttribute('uiItModels') : null;\n\t\t\tconst itLabels: string[] = [];\n\t\t\tif (itModels != null) {\n\t\t\t\tconst itTypesArray = itModels.split(\"|\");\n\t\t\t\titTypesArray.forEach(itModel => {\n\t\t\t\t\titLabels.push(ctx.reg.env.wsp.wspMetaUi.getItemType(itModel).getTitle());\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (itLabels.length == 1) {\n\t\t\t\tconst itLabel = <span class=\"critVal\">{itLabels[0]}</span>;\n\t\t\t\treturn <span class=\"crit\">Type '{itLabel}'</span>;\n\t\t\t} else {\n\t\t\t\tconst itCount = <span class=\"critVal\">{itLabels.length}</span>;\n\t\t\t\treturn <span class=\"crit\" title={itLabels.join(\", \")}>{itCount} types</span>;\n\t\t\t}\n\t\t});\n\n\t/** Reducer des itemType proposés*/\n\tpublic itemTypeReducer : (acc: ItemType[], cur: ItemType, idx?: number, src?: ItemType[]) => ItemType[] = null;\n\n\t/** Contient la sélection courante */\n\tprotected _selectedItModels: string[];\n\n\tprotected _itemTypesPopup: HTMLElement;\n\n\t/** Utilisé uniquement pour l'affichage  */\n\tprotected _itemTypesTree: ItemTypesTree;\n\n\tprotected _itemsBtn: Button;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\n\t\tsr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Type(s) :</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\n\t\t// Popup de sélection\n\t\t//let template = sr.appendChild(<template/>);\n\t\tthis._itemTypesPopup = <div id=\"root\"/>;\n\t\tthis._itemTypesPopup.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"wsp-itemcrit-type/selector\", this._itemTypesPopup.shadowRoot);\n\n\t\tconst itemTypeReducer = this.itemTypeReducer || this.reg.getSvc(\"itemCritType.itemTypeReducer\");\n\n\t\tthis._itemTypesTree = this._itemTypesPopup.shadowRoot.appendChild(new ItemTypesTree().initialize({\n\t\t\treg: this.reg,\n\t\t\ttextFilter: \"\",\n\t\t\titemTypeReducer,\n\t\t\tforbidHideSelectedRow: true,\n\t\t\tgrid: {\n\t\t\t\tselType: \"multi\"\n\t\t\t}\n\t\t}));\n\t\tthis._itemTypesTree.setAttribute(\"style\", \"max-height: 20em;\");\n\t\tconst footer = this._itemTypesPopup.shadowRoot.appendChild(<div id=\"footer\">\n\t\t\t<div id=\"msg\"/>\n\t\t</div>);\n\t\tfooter.appendChild(<Button id=\"select\" label=\"Sélectionner\" ui-context=\"dialog\" onclick={this.chooseItems_onSelectBtn.bind(this)}/>);\n\t\tfooter.appendChild(<Button id=\"cancel\" label=\"Annuler\" ui-context=\"dialog\" onclick={this.chooseItems_onCancelBtn.bind(this)}/>);\n\n\t\t// Btn\n\t\tthis._itemsBtn = sr.appendChild(<Button id=\"itemsTypes\" label=\" \" onclick={this.onChooseItems} title=\"Sélectionner des types d'item...\"/>) as Button;\n\n\t\tthis.redraw();\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tconst itTypes = xml ? xml.getAttribute('uiItModels') : null;\n\t\tthis._selectedItModels = itTypes?.split(\"|\");\n\t\tthis.redraw();\n\t\treturn this;\n\t}\n\n\tasync initFromInsAction(xml?: Element): Promise<this> {\n\t\tawait super.initFromInsAction(xml);\n\t\t// Affichage auto du popup sur la création\n\t\tif (!this._selectedItModels || this._selectedItModels.length == 0)\n\t\t\tawait this.onChooseItems.call(this._itemsBtn);\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tif (!this._selectedItModels || this._selectedItModels.length == 0) return undefined;\n\t\t// @see morphologie signature Wui_Modeling\\doc\\class\\signature.md\n\t\treturn new SearchItemSgnRegexp(this._selectedItModels?.map(entry => '.*@' + LANG.escape4Regexp(entry) + \"\\\\b.*\"));\n\t}\n\n\t/**\n\t *  Critères UI :\n\t *    uiItModels : liste des itModels sélectionnés, sépapés par un |\n\t */\n\tbuildUiXmlCrit(): Element | undefined {\n\t\tconst itModels: string[] = [];\n\t\tconst crit: Element = super.buildUiXmlCrit();\n\t\tif (crit && this._selectedItModels) crit.setAttribute(\"uiItModels\", this._selectedItModels.join(\"|\"));\n\t\treturn crit;\n\t}\n\n\t/**\n\t * Redraw UI\n\t *    Mémorisation des sélctions dans \"_itemTypesTree\"\n\t */\n\tprivate redraw(): void {\n\t\twhile (this._itemsBtn.firstChild) this._itemsBtn.removeChild(this._itemsBtn.firstChild);\n\t\tif (this._selectedItModels && this._selectedItModels.length > 0) {\n\t\t\tthis._selectedItModels.forEach(itModel => {\n\t\t\t\tconst itemType = this.reg.env.wsp.wspMetaUi.getItemType(itModel);\n\t\t\t\tif (itemType) {\n\t\t\t\t\tthis._itemsBtn.appendChild(<div class=\"modelEntry\">\n\t\t\t\t\t\t<img src={itemType.getIcon()}/>\n\t\t\t\t\t\t{itemType.getTitle()}\n\t\t\t\t\t</div>);\n\t\t\t\t}\n\t\t\t});\n\t\t} else\n\t\t\tthis._itemsBtn.appendChild(<div class=\"noEntry\">Veuillez sélectionner des types d'item...</div>);\n\t}\n\n\tasync onChooseItems(this: Button, ev?: Event) {\n\t\tconst me = DOMSH.findHost(this) as ItemCritType;\n\t\tme._itemTypesTree.clearSearch();\n\t\tme._itemTypesTree.selectByItModels(me._selectedItModels);\n\t\tawait POPUP.showMenuFromEvent(me._itemTypesPopup, ev || me, me, {skinOver: \"wsp-itemcrit-type-popup\"}).onNextClose();\n\t}\n\n\tchooseItems_onCancelBtn(this: ItemCritType) {\n\t\tPOPUP.findPopupableParent(this._itemTypesPopup).close();\n\t}\n\n\tchooseItems_onSelectBtn(this: ItemCritType) {\n\t\tthis._selectedItModels = [];\n\t\tthis._itemTypesTree.getSelectedItemsTypes().forEach(itemType => {\n\t\t\tthis._selectedItModels.push(itemType.getModel());\n\t\t});\n\t\tthis.dispatchChangeEvent();\n\t\tthis.redraw();\n\t\tPOPUP.findPopupableParent(this._itemTypesPopup).close();\n\t}\n\n}\n\ncustomElements.define(\"wsp-itemcrit-type\", ItemCritType);\nREG.reg.registerSkin('wsp-itemcrit-type', 1, /* language=CSS */ `\n\tc-button {\n\t\talign-items: start;\n\t\tflex-direction: column;\n\t}\n\n\t.noEntry {\n\t\tfont-style: italic;\n\t\tcolor: var(--fade-color);\n\t}\n\n\t.modelEntry {\n\t\tlist-style: none;\n\t\tdisplay: list-item;\n\t\tmargin-inline-start: 1em;\n\t}\n`);\nREG.reg.registerSkin('wsp-itemcrit-type/selector', 1, /* language=CSS */ `\n\twsp-itemtypes-tree {\n\t\tmax-height: 20em;\n\t}\n\n\t#footer {\n\t\tborder-top: 1px solid var(--border-color);\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\talign-items: center;\n\t}\n\n\t#msg {\n\t\tflex: 1;\n\t}\n`);\n\nREG.reg.registerSvc(\"wsp-itemcrit-type\", 1, ItemCritType.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-type\", 1, \"wsp-itemcrit-type\");\n\n\n/**\n * Item commenté\n *    <wsp-itemcrit-comment/>\n */\nexport class ItemCritComment extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-comment\").setLabel(\"Item commenté\")\n\t\t.setGroup(\"props\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\t\t\tlet msg = \"\";\n\t\t\tif (xml.hasAttribute(\"uiIncludeClosed\") && (xml.hasAttribute(\"uiIncludeOpen\")))\n\t\t\t\tmsg = \"Commentaires ouverts ou clos\";\n\t\t\telse if (xml.hasAttribute(\"uiIncludeClosed\"))\n\t\t\t\tmsg = \"Commentaires clos\";\n\t\t\telse\n\t\t\t\tmsg = \"Commentaires ouverts\";\n\t\t\treturn <span class=\"crit\" title={msg}>Item commenté</span>;\n\t\t}).setBuildWedSearch((xml: Element, criterions: Dict<IUiCritArea>): JCommentWedSearchBarParams => {\n\t\t\treturn {\n\t\t\t\tsearchId: \"comment\",\n\t\t\t\topened: xml.hasAttribute(\"uiIncludeOpen\"),\n\t\t\t\tclosed: xml.hasAttribute(\"uiIncludeClosed\")\n\t\t\t}\n\t\t});\n\n\tprotected opened: HTMLInputElement;\n\n\tprotected closed: HTMLInputElement;\n\n\tget withOpenComments(): boolean {return this.opened ? this.opened.checked : false}\n\n\tget withClosedComments(): boolean {return this.closed ? this.closed.checked : false}\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\n\t\tconst critHead = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Item commenté</span>\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\n\t\tthis.opened = critHead.appendChild(<label class=\"opt\"><input type=\"checkbox\" checked=\"\" onclick={this.onClick}/>ouverts</label>).firstElementChild as HTMLInputElement;\n\t\tthis.closed = critHead.appendChild(<label class=\"opt\"><input type=\"checkbox\" onclick={this.onClick}/>clos</label>).firstElementChild as HTMLInputElement;\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\tif (xml.hasAttribute(\"uiIncludeOpen\"))\n\t\t\tthis.opened.checked = true;\n\t\tif (xml.hasAttribute(\"uiIncludeClosed\"))\n\t\t\tthis.closed.checked = true;\n\t\treturn this;\n\t}\n\n\tprotected onClick(this: HTMLInputElement): void {\n\t\tconst me = DOMSH.findHost<ItemCritComment>(this);\n\t\tif (!me.opened.checked && !me.closed.checked) {\n\t\t\t//Les deux ne peuvent être décochés à la fois, on récative celui qui a été décoché.\n\t\t\tif (this === me.opened) {\n\t\t\t\tme.closed.checked = true;\n\t\t\t} else {\n\t\t\t\tme.opened.checked = true;\n\t\t\t}\n\t\t}\n\t\tme.onChange();\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\treturn new SearchItemComment(this.withOpenComments, this.withClosedComments);\n\t}\n\n\t/**\n\t * Critères UI :\n\t *  - uiIncludeOpen\n\t *  - uiIncludeClosed\n\t */\n\tbuildUiXmlCrit(): Element | undefined {\n\t\tconst crit: Element = super.buildUiXmlCrit();\n\t\tif (crit && this.withOpenComments) crit.setAttribute(\"uiIncludeOpen\", null);\n\t\tif (crit && this.withClosedComments) crit.setAttribute(\"uiIncludeClosed\", null);\n\t\treturn crit;\n\t}\n}\n\n\ncustomElements.define(\"wsp-itemcrit-comment\", ItemCritComment);\n\nREG.reg.registerSvc(\"wsp-itemcrit-comment\", 1, ItemCritComment.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-comment\", 1, \"wsp-itemcrit-comment\");\n\n\n/**\n * Cycle de vie de l'item\n *    <wsp-itemcrit-lifecycle/>\n */\nexport class ItemCritLifeCycle extends UiCritBase {\n\n\tstatic AREA = new UiCritArea(\"wsp-itemcrit-lifecycle\")\n\t\t.setLabel((ctx) => ctx.reg.env.wsp.wspMetaUi.getLcName())\n\t\t.setVisible((ctx) => (ctx.reg.env.wsp.hasFeature(\"liveCycle\") && ctx.reg.env.wsp.wspMetaUi.getLcStates() !== null) ? true : false)\n\t\t.setCritSgn(\"lifecycle\").setGroup(\"item\").setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\n\t\t\t// Cycles de vie\n\t\t\tconst lcStates = xml.getAttribute(\"lcStates\") || \"\";\n\t\t\tconst lcStatesArr = lcStates.split(\" \");\n\t\t\tconst lcStatesLabels: string[] = [];\n\t\t\tlcStatesArr.forEach((stateCode) => {\n\t\t\t\tconst state = ctx.reg.env.wsp.wspMetaUi.getLcState(stateCode != LC_STATE_DEFAULT_KEY ? stateCode : \"\");\n\t\t\t\tif (state && state.name)\n\t\t\t\t\tlcStatesLabels.push(state.name)\n\t\t\t\telse if (state && state.code == \"\")\n\t\t\t\t\tlcStatesLabels.push(LC_STATE_DEFAULT_NAME)\n\t\t\t\telse\n\t\t\t\t\tlcStatesLabels.push(stateCode);//LC state inconnu\n\t\t\t})\n\t\t\tlet strCplts = [];\n\t\t\tif (xml.getAttribute(\"uiCurrentMode\"))\n\t\t\t\tstrCplts.push(<span>période donnée</span>)\n\t\t\tconst lcBys = xml.getAttribute(\"lcBys\");\n\t\t\tif (lcBys) {\n\t\t\t\tlet accounts = lcBys.split(\" \");\n\t\t\t\tconst usersListVal = <span>affecté par '{accounts.join(\", \")}'</span>;\n\t\t\t\tstrCplts.push(usersListVal)\n\t\t\t\tctx.reg.env.universe.useUsers.getUserSet(accounts).then(users => {\n\t\t\t\t\tif (users) {\n\t\t\t\t\t\taccounts = [];\n\t\t\t\t\t\tconst names: string[] = [];\n\t\t\t\t\t\tusers.forEach(user => {\n\t\t\t\t\t\t\taccounts.push(USER.getPrimaryName(user));\n\t\t\t\t\t\t\tnames.push(USER.getLongName(user));\n\t\t\t\t\t\t});\n\t\t\t\t\t\tusersListVal.textContent = \"affecté par '\" + accounts.join(\", \") + \"'\";//FIXME L10n\n\t\t\t\t\t\tusersListVal.setAttribute(\"title\", names.join(\", \"));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst lcName = ctx.reg.env.wsp.wspMetaUi.getLcName();\n\t\t\tconst label = lcStatesLabels.length > 1 ? `États du ${lcName} :` : `État du ${lcName} :`;\n\t\t\tconst result: HTMLSpanElement = <span class=\"crit\">{label} <span class=\"critVal\">{lcStatesLabels.join(\", \")}</span></span>;\n\n\t\t\tif (strCplts.length > 0) {\n\t\t\t\tresult.appendChild(document.createTextNode(\" (\"));\n\t\t\t\tstrCplts.forEach(((elt, pos) => {\n\t\t\t\t\tif (pos > 0 && pos < strCplts.length) result.appendChild(document.createTextNode(\", \"));\n\t\t\t\t\tresult.appendChild(elt)\n\t\t\t\t}));\n\t\t\t\tresult.appendChild(document.createTextNode(\")\"));\n\t\t\t}\n\t\t\treturn result;\n\t\t});\n\n\tprotected _lcElt: HTMLSelectElement;\n\n\tprotected _dateElt: InputPeriod;\n\n\tprotected _userElt: InputUserPanel<any>;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tthis.reg.installSkin(\"wsp-itemcrit-lifecycle\", sr);\n\n\t\tthis._lcElt = <select onchange={this.onChange} class=\"lcSelect\" multiple=\"true\"/> as HTMLSelectElement;\n\t\tthis.reg.env.wsp.wspMetaUi.getLcStates().forEach((tr) => {\n\t\t\tlet opt = this._lcElt.appendChild(<option value={tr.code || LC_STATE_DEFAULT_KEY}>{tr.name || LC_STATE_DEFAULT_NAME}</option>);\n\t\t\topt.style.color = tr.color || \"var(--color)\";\n\t\t\tif (tr.iconUrl) opt.style.backgroundImage = `url(\"${tr.iconUrl}\")`;\n\t\t\tif (tr.code == \"\") DOM.setAttrBool(opt, \"selected\", true);\n\t\t});\n\n\t\tthis._dateElt = new InputPeriod().initialize();\n\t\tthis._dateElt.title = \"Période pendant laquelle l'état du cycle de vie a été affecté\";\n\t\tthis._dateElt.addEventListener(\"change\", this.onChange);\n\t\tthis._dateElt.addEventListener(\"input\", this.onChange);\n\n\t\tthis._userElt = new InputUserPanel().initialize({\n\t\t\tname: \"choiceUser\",\n\t\t\treg: this.reg,\n\t\t\temptySelectionMsg: \"Sélectionner un utilisateur...\",\n\t\t\tuserCard: \"multi\",\n\t\t\tusersGridInit: {\n\t\t\t\tusersSrv: this.reg.env.universe.useUsers,\n\t\t\t\tgrid: {selType: \"mono\"},\n\t\t\t\tfilterType: EUserType.user,\n\t\t\t\tfilterTypeInputVisibility: false,\n\t\t\t},\n\t\t} as OInputUserInit<any>) as InputUserPanel<any>;\n\t\tthis._userElt.addEventListener(\"change\", this.onChange);\n\t\tthis._userElt.title = \"État affecté par l'un des utilisateurs\";\n\n\t\tsr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">{this.reg.env.wsp.wspMetaUi.getLcName()}</span>\n\t\t\t{this._lcElt}\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\t\tsr.appendChild(<div class=\"h\">\n\t\t\t<span>défini</span>\n\t\t\t{this._dateElt}\n\t\t\t<span>par</span>\n\t\t\t{this._userElt}\n\t\t</div>);\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\t// LC\n\t\tthis._lcElt.selectedIndex = -1;\n\t\tconst lcStates = xml.getAttribute(\"lcStates\") || \"\";\n\t\tconst lcStatesArr = lcStates.split(\" \");\n\t\tArray.from(this._lcElt.options).forEach(opt => {\n\t\t\topt.selected = lcStatesArr.includes(opt.value)\n\t\t})\n\t\t// date\n\t\tthis._dateElt.reset(xml.getAttribute(\"uiCurrentMode\"), xml.hasAttribute(\"uiCurrentLess\") ? Number.parseInt(xml.getAttribute(\"uiCurrentLess\")) : null, xml.hasAttribute(\"uiCurrentMore\") ? Number.parseInt(xml.getAttribute(\"uiCurrentMore\")) : null);\n\t\t// by\n\t\tconst lcBys = xml.getAttribute(\"lcBys\");\n\t\tif (lcBys)\n\t\t\tthis._userElt.value = lcBys.split(\" \")\n\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tlet crit = this._dateElt.isSpecified() ? SearchLifeCycleStates.buildFromInputPeriod(this._dateElt) : new SearchLifeCycleStates();\n\t\tcrit.lcStates = [];\n\t\tArray.from(this._lcElt.selectedOptions).forEach(opt => crit.lcStates.push(opt.value))\n\t\tcrit.lcBys = this._userElt.value;\n\t\treturn crit;\n\t}\n\n\tbuildUiXmlCrit(): Element | undefined {\n\t\tconst crit: Element = super.buildUiXmlCrit();\n\t\tif (crit && this._dateElt.isSpecified()) {\n\t\t\tcrit.setAttribute(\"uiCurrentMode\", this._dateElt.currentMode.getId());\n\t\t\t// Valeurs brutes (sans les regles d'exclusion/noemalisation qui sont fournies par le \"currentMode\")\n\t\t\tif (this._dateElt.date1.valueAsNumber) crit.setAttribute(\"uiCurrentLess\", this._dateElt.date1.valueAsNumber.toString());\n\t\t\tif (this._dateElt.date2.valueAsNumber) crit.setAttribute(\"uiCurrentMore\", this._dateElt.date2.valueAsNumber.toString());\n\t\t}\n\t\treturn crit;\n\t}\n\n}\n\ncustomElements.define(\"wsp-itemcrit-lifecycle\", ItemCritLifeCycle);\nREG.reg.registerSkin('wsp-itemcrit-lifecycle', 1, /* language=CSS */ `\n\n\tc-input-period {\n\t\tmargin-inline-start: 1em;\n\t\tmargin-inline-end: 1em;\n\t}\n\n\tc-input-users-panel {\n\t\tmargin-inline-start: 1em;\n\t\tmin-height: 1.5rem;\n\t}\n\n\t.h {\n\t\tmargin-top: .5em;\n\t}\n\n\t.lcSelect {\n\t\tflex: 1;\n\t\tresize: vertical;\n\t\theight: 10rem;\n\t}\n\n\t.lcSelect > option {\n\t\t/*background-image: url(\"affecteeDynamiquement\");*/\n\t\tbackground-repeat: no-repeat;\n\t\tbackground-size: 1rem auto;\n\t\tbackground-position-y: center;\n\t\tbackground-position-x: 1px;\n\t\tmin-width: 3rem;\n\t\tpadding-inline-start: 1.3rem;\n\t}\n`);\n\nREG.reg.registerSvc(\"wsp-itemcrit-lifecycle\", 1, ItemCritLifeCycle.AREA);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-lifecycle\", 1, \"wsp-itemcrit-lifecycle\");\n\n/**\n * Responsabilités de l'item\n *    <wsp-itemcrit-respsonsabilities/>\n */\nexport abstract class ItemCritRespsonsabilities extends UiCritBase {\n\n\tstatic AREA_item = ItemCritRespsonsabilities.makeArea('item', 'wsp-itemcrit-respsonsabilities');\n\tstatic AREA_task = ItemCritRespsonsabilities.makeArea('task', 'wsp-taskcrit-respsonsabilities');\n\n\tstatic makeArea(target: 'task' | 'item', tag: string): UiCritArea {\n\t\treturn new UiCritArea(tag).setLabel(\"Responsabilités\")\n\t\t\t.setVisible((ctx) => (ctx.reg.env.wsp.hasFeature(\"resp\") && ctx.reg.env.wsp.wspMetaUi.hasResps) ? true : false)\n\t\t\t.setCritSgn(\"respsonsabilities\").setGroup(target).setBuildAbstract((xml: Element, ctx: OUiCritInit): HTMLElement => {\n\n\t\t\t\t// Resps\n\t\t\t\tconst modelResps = ctx.reg.env.wsp.wspMetaUi.listResps(target);\n\t\t\t\tconst resps = xml.getAttribute(\"responsibilities\") || \"\";\n\t\t\t\tconst respsArr = resps.split(\" \");\n\t\t\t\tconst respsLabels: string[] = [];\n\t\t\t\trespsArr.forEach((resp) => {\n\t\t\t\t\tconst currentResp = modelResps.find((entry) => entry.code === resp);\n\t\t\t\t\trespsLabels.push(currentResp ? currentResp.name : resp);\n\t\t\t\t})\n\n\t\t\t\t// users\n\t\t\t\tlet usersListVal: HTMLElement;\n\t\t\t\tconst users = xml.getAttribute(\"users\");\n\t\t\t\tif (users) {\n\t\t\t\t\tconst accounts = users.split(\" \");\n\t\t\t\t\tconst usersObj = <span/>;\n\t\t\t\t\taccounts.forEach((account, pos) => {\n\t\t\t\t\t\tif (pos > 0)\n\t\t\t\t\t\t\tusersObj.appendChild(<span> ou </span>);\n\t\t\t\t\t\tusersObj.appendChild(<UserRef class=\"inline list\" î={{reg: ctx.reg, nickOrAccount: account, withIcon: false} as OUserRefInit}/>)\n\t\t\t\t\t});\n\t\t\t\t\tusersListVal = respsLabels.length > 1 ?\n\t\t\t\t\t\t<span>attribuées à '{usersObj}'</span> :\n\t\t\t\t\t\t<span>attribuée à '{usersObj}'</span>;//FIXME L10n\n\t\t\t\t\tif (xml.getAttribute(\"expandUsers\"))\n\t\t\t\t\t\tusersListVal.appendChild(<span> (étendu aux membres/groupes)</span>);\n\t\t\t\t}\n\n\t\t\t\tif (respsLabels.length > 1)\n\t\t\t\t\treturn <span class=\"crit\">Responsabilités '<span class=\"critVal\">{respsLabels.join(\" ou \")}</span>' {usersListVal}</span>;\n\t\t\t\telse\n\t\t\t\t\treturn <span class=\"crit\">Responsabilité '<span class=\"critVal\">{respsLabels}</span>' {usersListVal}</span>;\n\t\t\t});\n\t}\n\n\tprotected target: 'task' | 'item';\n\n\tprotected _respElt: HTMLSelectElement;\n\n\tprotected _userElt: InputUserPanel<any>;\n\n\tprotected _toGroupsElt: HTMLInputElement;\n\n\tprotected _toMembersElt: HTMLInputElement;\n\n\tprotected _initialize(init: OUiCritInit): void {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.shadowRoot;\n\t\tthis.reg.installSkin(\"wsp-crit-respsonsabilities\", sr);\n\n\t\tconst withGroups = this.reg.env.universe.useUsers.hasAspect(EUserAspects.groupable);\n\n\t\tthis._respElt = <select onchange={this.onChange} class=\"respSelect\" multiple=\"true\"/> as HTMLSelectElement;\n\t\tthis.reg.env.wsp.wspMetaUi.listResps(this.target).forEach((resp) => {\n\t\t\tlet opt = this._respElt.appendChild(<option value={resp.code}>{resp.name}</option>);\n\t\t\tif (resp.desc) opt.title = resp.desc;\n\t\t});\n\n\t\tthis._userElt = new InputUserPanel().initialize({\n\t\t\tname: \"choiceUser\",\n\t\t\treg: this.reg,\n\t\t\temptySelectionMsg: withGroups ? \"Utilisateurs/groupes...\" : \"Utilisateurs...\",\n\t\t\tuserCard: \"multi\",\n\t\t\tusersGridInit: {\n\t\t\t\tusersSrv: this.reg.env.universe.useUsers,\n\t\t\t\tfilterTypeInputVisibility: true,\n\t\t\t\tfilterType: null,\n\t\t\t},\n\t\t} as OInputUserInit<any>) as InputUserPanel<any>;\n\t\tthis._userElt.addEventListener(\"change\", this.onChange);\n\t\tthis._userElt.title = withGroups ?\n\t\t\t\"Au mois un utilisateur / groupe est concerné par au moins une responsabilité sélectionnée.\" :\n\t\t\t\"Au mois un utilisateur est concerné par au moins une responsabilité sélectionnée.\";\n\n\t\tlet critGroups;\n\t\tif (withGroups) {\n\t\t\tthis._toGroupsElt = <input type=\"checkbox\" onclick={this.onChange}/> as HTMLInputElement;\n\t\t\tthis._toMembersElt = <input type=\"checkbox\" onclick={this.onChange}/> as HTMLInputElement;\n\t\t\tcritGroups = <div class=\"h\">\n\t\t\t\t<label class=\"opt\"\n\t\t\t\t\t\t\t title={this.target == \"item\" ? \"Inclure les items associés aux groupes auxquels les utilisateurs sélectionnés appartiennent\" : \"Inclure les tâches associées aux groupes auxquels les utilisateurs sélectionnés appartiennent\"}>{this._toGroupsElt}+ groupes</label>\n\t\t\t\t<label class=\"opt\" title={this.target == \"item\" ? \"Inclure les items associés aux membres des groupes sélectionnés\" : \"Inclure les tâches associées aux membres des groupes sélectionnés\"}>{this._toMembersElt}+ membres</label>\n\t\t\t</div>;\n\t\t}\n\n\t\tconst critHead = sr.appendChild(<div class=\"critHead\">\n\t\t\t<span class=\"critTitle\">Responsabilités</span>\n\t\t\t{this._respElt}\n\t\t\t{this.insertAlternativesBtn(init)}\n\t\t</div>);\n\t\tsr.appendChild(\n\t\t\t<div class=\"h\">\n\t\t\t\t<span>attribuées à</span>\n\t\t\t\t<div class=\"v usersBox\">\n\t\t\t\t\t{this._userElt}\n\t\t\t\t\t{critGroups}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tasync initFromXmlCrit(xml: Element): Promise<this> {\n\t\t// - resp\n\t\tthis._respElt.selectedIndex = -1;\n\t\tconst resps = xml.getAttribute(\"responsibilities\") || \"\";\n\t\tconst respsArr = resps.split(\" \");\n\t\tfor (const opt of this._respElt.options) {\n\t\t\topt.selected = respsArr.includes(opt.value)\n\t\t}\n\t\t// - users\n\t\tconst users = xml.getAttribute(\"users\");\n\t\tif (users)\n\t\t\tthis._userElt.value = users.split(\" \")\n\t\t// - options\n\t\tconst expandUsers = xml.getAttribute(\"expandUsers\");\n\t\tif (this._toGroupsElt)\n\t\t\tthis._toGroupsElt.checked = expandUsers?.includes('toGroups');\n\t\tif (this._toMembersElt)\n\t\t\tthis._toMembersElt.checked = expandUsers?.includes('toMembers');\n\t\treturn this;\n\t}\n\n\tbuildCrit(): ISearchCrit | undefined {\n\t\tconst resps = [];\n\t\tfor (const opt of this._respElt.selectedOptions) {\n\t\t\tresps.push(opt.value)\n\t\t}\n\t\tlet crit = new SearchResponsibilities(resps, this._userElt.value, this._toMembersElt?.checked, this._toGroupsElt?.checked);\n\t\treturn crit;\n\t}\n\n}\n\nexport class ItemCritRespsonsabilities_item extends ItemCritRespsonsabilities {\n\tprotected target: 'task' | 'item' = \"item\";\n}\n\ncustomElements.define(\"wsp-itemcrit-respsonsabilities\", ItemCritRespsonsabilities_item);\nREG.reg.registerSkin('wsp-crit-respsonsabilities', 1, /* language=CSS */ `\n\t.respSelect {\n\t\tflex: 1;\n\t}\n\n\t.h {\n\t\tmargin-top: .5em;\n\t}\n\n\t.usersBox {\n\t\tflex: 1\n\t}\n\n\tc-input-users-panel {\n\t\tmargin-inline-start: 1em;\n\t\tflex: 1\n\t}\n`);\n\nREG.reg.registerSvc(\"wsp-itemcrit-respsonsabilities\", 1, ItemCritRespsonsabilities.AREA_item);\nREG.reg.addSvcToList(\"wsp.crit.items\", \"wsp-itemcrit-respsonsabilities\", 1, \"wsp-itemcrit-respsonsabilities\");"]}