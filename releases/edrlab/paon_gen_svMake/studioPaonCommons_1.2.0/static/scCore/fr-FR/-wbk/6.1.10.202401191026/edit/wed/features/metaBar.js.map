{"version":3,"sources":["/@back@/edit/wed/features/metaBar.tsx"],"names":["POPUP","Tabs","AgBoxSelEditor","AgCommonBarEditor","AgTxtSelEditor","WedEditorBase","WedEditorBox","WEDLET","Action","Area","VIEWS","DOM","AgMetaBarEditor","cls","proto","prototype","superInit","initialize","init","call","this","metaBarMode","showMetaBar","show","metaBar","Object","create","config","commonBar","hideCommonBar","lastDatasKey","lastDatas","MetaBar","initMetaBar","hidden","barLayout","showBar","setHidden","onHideBar","[object Object]","super","id","setAttribute","mainEditor","mainWedMgr","wedMgr","clear","clearEditor","hookFct","listeners","on","detach","detachDocHolder","addEventListener","style","flex","backgroundColor","color","metaDefs","currentMetaDefs","from","Array","isArray","length","firstDef","label","dispatchViewChange","setWedModel","wedModel","newDocHolder","docHolderAsync","cloneDocHolder","wedMgrConfig","readOnlyCauses","xaRoot","wedAnchor","rootModel","model","isWritableWedlet","initFromDocHolder","customElements","define","ShowMetaBarAction","_label","ctx","api","ev","METAS","showMeta","fromWedMgr","fromEditor","wedEditor","isAlreadyEditing","editMeta","openMeta","popup","tabs","areas","map","m","MetaEditorTab","areasContext","skinOver","margin","showDialog","rootNode","titleBar","barLabel","closeButton","dialogMetasCloseBtn","resizer","initWidth","initHeight","closeOnCtrlEnter","editor","buildBody","reg","installSkin","shadowRoot","once","boxSelMgr","focusFirst","rootWedlet","showNotifInfo","close","onNextClose","async","openMetaNew","docHolder","metaModel","title","parent","editorConfig","hideDiffBar","newEditor","uiContext","metaDef","disableVirtuals","getPref","undoRedoFilter","isMsgFromUs","bind","searchP","_a","searchBar","getSearchParams","_b","setSearch","diffP","_c","diffBar","getDiffParams","getDiffBar","then","bar","setDiffParams","closed","killEditor"],"mappings":"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","sourcesContent":["import {IPopupable} from \"back/commons/widgets/popupable\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {Tabs} from \"back/commons/widgets/tabs\";\nimport {AgBoxSelEditor, IWedEditorBoxSel} from \"back/edit/wed/features/boxSel\";\nimport {AgCommonBarEditor, IWedEditorCommonBar, OWedEditorCommonBarConfig} from \"back/edit/wed/features/commonBar\";\nimport {AgTxtSelEditor} from \"back/edit/wed/features/txtSel\";\nimport {IWedletModel} from \"back/edit/wed/wedCore\";\nimport {IWedEdBar, IWedEditor, IWedEditorMain, OWedEditorConfig, OWedEditorMainConfig, OWedManagerConfig, WedEditorBase, WedMgr} from \"back/edit/wed/wedEditor\";\nimport {OWedEditorBoxConfig, WedEditorBox} from \"back/edit/wed/wedEditorBox\";\nimport {IWedlet, WEDLET} from \"back/edit/wed/wedlets/wedlet\";\nimport {Action, IActionToggle} from \"lib/commons/actions\";\nimport {Area} from \"lib/commons/areas\";\nimport {VIEWS} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {IDocHolderSync} from \"lib/edit/docHolder\";\nimport {OButtonInit} from \"back/commons/widgets/buttons\";\nimport {IWedEditorSearchBar} from \"back/edit/wed/features/searchBar\";\nimport {IWedEditorDiffBar, OWedEditorDiffBarConfig} from \"back/edit/wed/features/diffBar\";\n\n/** Config de l'edditor dédié à la gestion des metas. */\nexport interface OWedEditorMetaConfig extends OWedEditorMainConfig {\n\t/**\n\t * Affichage de la barre des métas :\n\t * - none : pas de barre de metas disponible.\n\t * - available : barre de métas dispo mais masquée à l'init, affichable à la demande.\n\t * - fixed : barre de métas dispo et affichée en permanence.\n\t */\n\tmetaBarMode?: 'none' | 'shown' | 'available'\n}\n\n/** Enrichissements de l'éditor principal pour gérer l'editor de metas. */\nexport interface IWedEditorMetaBar extends IWedEditorMain {\n\tmetaBar?: MetaBar\n\tmetaBarMode?: 'none' | 'shown' | 'available'\n\n\tshowMetaBar?(show: boolean): MetaBar\n}\n\nexport function AgMetaBarEditor(cls: any): any {\n\tconst proto = cls.prototype as IWedEditorMetaBar;\n\n\tconst superInit = proto.initialize;\n\tproto.initialize = function (this: IWedEditorMetaBar, init: OWedEditorMetaConfig) {\n\t\tsuperInit.call(this, init);\n\t\tthis.metaBarMode = init.metaBarMode || 'none';\n\t\tif (this.metaBarMode === 'shown') this.showMetaBar(true);\n\t\treturn this;\n\t};\n\n\tproto.showMetaBar = function (this: IWedEditorMetaBar & IWedEditorCommonBar, show: boolean): MetaBar {\n\t\tif (this.metaBarMode === 'none') return null;\n\t\tif (show) {\n\t\t\tif (!this.metaBar) {\n\t\t\t\tconst init = Object.create(this.config) as OWedEditorCommonBarConfig;\n\t\t\t\tif (this.commonBar) {\n\t\t\t\t\tinit.commonBar = this.commonBar;\n\t\t\t\t} else {\n\t\t\t\t\tinit.hideCommonBar = true;\n\t\t\t\t}\n\t\t\t\tinit.lastDatasKey = null;\n\t\t\t\tinit.lastDatas = null; // à creuser : mémoire de la meta en cours d'édition ?\n\t\t\t\tthis.metaBar = new MetaBar().initialize(init).initMetaBar(this);\n\t\t\t} else this.metaBar.hidden = false;\n\t\t\tthis.barLayout.showBar(this.metaBar)\n\t\t} else if (this.metaBar) {\n\t\t\tif (DOM.setHidden(this.metaBar, true)) this.barLayout.onHideBar(this.metaBar);\n\t\t}\n\t\treturn this.metaBar;\n\t};\n\n\treturn cls;\n}\n\n/** FIXME wed-meta-bar doit être un customElement parent de WedEditorBase pour injecter des onglets contenant un WedEditorBase en cas de multi-metas. */\nclass MetaBar extends WedEditorBase implements CustomElement, IWedEdBar {\n\tmainEditor: IWedEditorMetaBar;\n\n\t/** Références des métas en cours d'édition. */\n\tcurrentMetaDefs: IMetaDef[];\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.id = \"metaBar\";\n\t\tthis.setAttribute(\"label\", \"Propriétés\");\n\t}\n\n\tinitMetaBar(mainEditor: IWedEditorMetaBar): this {\n\t\tthis.mainEditor = mainEditor;\n\t\tconst mainWedMgr = this.mainEditor.wedMgr;\n\t\tconst clear = () => {this.wedMgr.clearEditor()};\n\t\tmainWedMgr.hookFct(\"clearEditor\", clear);\n\t\tmainWedMgr.listeners.on(\"redrawAtEnd\", clear);\n\t\tconst detach = () => {this.wedMgr.detachDocHolder()};\n\t\tmainWedMgr.hookFct(\"detachDocHolder\", detach);\n\t\tthis.addEventListener(\"wed-editor-root-deleted\", detach);\n\t\tthis.style.flex = \"1\";\n\t\tthis.style.backgroundColor = \"var(--edit-bgcolor)\";\n\t\tthis.style.color = \"var(--edit-color)\";\n\t\treturn this;\n\t}\n\n\tisAlreadyEditing(metaDefs: IMetaDef | IMetaDef[]): boolean {\n\t\tif (!this.currentMetaDefs) return false;\n\t\treturn this.currentMetaDefs[0].from === (Array.isArray(metaDefs) ? metaDefs[0] : metaDefs).from;\n\t}\n\n\teditMeta(metaDefs: IMetaDef | IMetaDef[]) {\n\t\tif (Array.isArray(metaDefs) && metaDefs.length > 0) {\n\t\t\tthrow \"TODO edit metas multi\";\n\t\t}\n\t\tconst firstDef = Array.isArray(metaDefs) ? metaDefs[0] : metaDefs;\n\t\tthis.setAttribute(\"label\", \"Propriétés de : \" + firstDef.label);\n\t\tVIEWS.dispatchViewChange(this);\n\t\tconst mainWedMgr = this.mainEditor.wedMgr;\n\t\tthis.wedMgr.detachDocHolder();\n\t\tthis.setWedModel(mainWedMgr.wedModel);\n\t\tconst newDocHolder = mainWedMgr.docHolderAsync.cloneDocHolder();\n\t\tconst wedMgrConfig = Object.create(mainWedMgr.config) as OWedManagerConfig;\n\t\twedMgrConfig.readOnlyCauses = Array.from(mainWedMgr.readOnlyCauses);\n\t\twedMgrConfig.xaRoot = firstDef.from.wedAnchor;\n\t\twedMgrConfig.rootModel = firstDef.model;\n\t\tif (!WEDLET.isWritableWedlet(firstDef.from)) wedMgrConfig.readOnlyCauses = [\"wedletOwner\"];\n\t\t//wedMgrConfig.undoRedoFilter = newDocHolder.isMsgFromUs.bind(newDocHolder);\n\t\tthis.initFromDocHolder(newDocHolder, wedMgrConfig);\n\t}\n\n}\n\nAgBoxSelEditor(AgTxtSelEditor(AgCommonBarEditor(MetaBar)));\n\n\ncustomElements.define(\"wed-meta-bar\", MetaBar);\n\n/** Activation de la panel/bar des metas*/\nexport class ShowMetaBarAction extends Action<IWedEditor & IWedEditorMetaBar> implements IActionToggle<IWedEditor & IWedEditorMetaBar> {\n\n\tconstructor() {\n\t\tsuper(\"metaBar\");\n\t\tthis._label = \"Propriétés\";\n\t}\n\n\tisVisible(ctx: IWedEditor & IWedEditorMetaBar) {\n\t\treturn ctx.metaBarMode && ctx.metaBarMode !== 'none';\n\t}\n\n\tisToggle(): this is IActionToggle<IWedEditor & IWedEditorMetaBar> {return true}\n\n\tgetDatas(api: 'toggle', ctx: IWedEditor & IWedEditorMetaBar): boolean | null {\n\t\treturn ctx.metaBar != null && !ctx.metaBar.hidden;\n\t}\n\n\texecute(ctx: IWedEditor & IWedEditorMetaBar, ev?: Event): any | 'noPreventDefault' {\n\t\tctx.showMetaBar(!ctx.metaBar || ctx.metaBar.hidden);\n\t}\n}\n\nexport interface IMetaDef {\n\tlabel: string\n\t//TODO icon?: string\n\t//TODO desc?:string\n\tfrom: IWedlet,\n\tmodel: IWedletModel\n}\n\nexport namespace METAS {\n\n\t/**\n\t * Affiche les metas dans un panelBar de l'editeur, ou à défaut en popupDialog.\n\t * Retourne une Promise si ouverture d'un dialogue, null si affichage dans un panel.\n\t * TODO pour ce mode avec la barre affichée en permanence, implémenter la synchro avec la sel courante à partir de txtSel\n\t */\n\texport function showMeta(metaDefs: IMetaDef | IMetaDef[]): Promise<void> | null {\n\t\tconst firstDef = Array.isArray(metaDefs) ? metaDefs[0] : metaDefs;\n\t\tconst fromWedMgr = firstDef.from.wedMgr;\n\t\tconst fromEditor = fromWedMgr.wedEditor as IWedEditorMetaBar;\n\t\tif (fromEditor.metaBarMode && fromEditor.metaBarMode !== \"none\") {\n\t\t\tlet metaBar = fromEditor.metaBar;\n\t\t\tif (metaBar && metaBar.isAlreadyEditing(metaDefs)) return null; //déjà en cours\n\t\t\tmetaBar = fromEditor.showMetaBar(true);\n\t\t\tmetaBar.editMeta(metaDefs);\n\t\t\treturn null;\n\t\t}\n\t\t//Ouverture en popup dialog...\n\t\treturn openMeta(metaDefs);\n\t}\n\n\t/**\n\t * Affiche les metas dans un popup dialog.\n\t * Retourne une Promise à la fermeture du dialogue.\n\t */\n\texport function openMeta(metaDefs: IMetaDef | IMetaDef[]): Promise<void> {\n\t\tconst firstDef = Array.isArray(metaDefs) ? metaDefs[0] : metaDefs;\n\t\tconst fromWedMgr = firstDef.from.wedMgr;\n\t\tlet popup: IPopupable<void>;\n\t\tif (Array.isArray(metaDefs) && metaDefs.length > 0) {\n\t\t\tconst tabs = new Tabs().initialize({\n\t\t\t\tareas: metaDefs.map((m: IMetaDef) => new MetaEditorTab(m)),\n\t\t\t\tareasContext: null,\n\t\t\t\tskinOver: \"webzone:panel\"\n\t\t\t});\n\t\t\ttabs.style.margin = \".5em\";\n\t\t\ttabs.style.flex = \"1\";\n\t\t\tpopup = POPUP.showDialog(tabs, fromWedMgr.wedEditor.rootNode, {\n\t\t\t\ttitleBar: {barLabel: {label: \"Propriétés\"}, closeButton: dialogMetasCloseBtn},\n\t\t\t\tresizer: {},\n\t\t\t\tinitWidth: '80vw',\n\t\t\t\tinitHeight: '60vh',\n\t\t\t\tcloseOnCtrlEnter: true\n\t\t\t});\n\t\t} else {\n\t\t\tconst editor = new MetaEditorTab(firstDef).buildBody();\n\t\t\teditor.reg.installSkin(\"webzone:panel\", editor.shadowRoot);\n\t\t\t//Focus le 1er wed focusable\n\t\t\teditor.wedMgr.listeners.once(\"redrawAtEnd\", (wedMgr: WedMgr) => {\n\t\t\t\t(wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.focusFirst(wedMgr.rootWedlet);\n\t\t\t});\n\t\t\tpopup = POPUP.showDialog(editor, fromWedMgr.wedEditor.rootNode, {\n\t\t\t\ttitleBar: {barLabel: {label: \"Propriétés : \" + firstDef.label}, closeButton: dialogMetasCloseBtn},\n\t\t\t\tresizer: {},\n\t\t\t\tinitWidth: '80vw',\n\t\t\t\tinitHeight: '60vh',\n\t\t\t\tcloseOnCtrlEnter: true\n\t\t\t});\n\t\t}\n\t\tpopup.addEventListener('wed-editor-root-deleted', () => {\n\t\t\tPOPUP.showNotifInfo(\"L'élément portant ces propriétés a été supprimé.\", fromWedMgr.wedEditor.rootNode);\n\t\t\tpopup.close();\n\t\t});\n\t\treturn popup.onNextClose();\n\t}\n\n\t/** Edite des métas dans une house locale avant insertion dans le l'item lors de la création d'une balise. */\n\texport async function openMetaNew(wedMgr: WedMgr, docHolder: IDocHolderSync, metaModel: IWedletModel, title: string, parent: IWedlet): Promise<void> {\n\t\tconst wedMgrConfig = Object.create(wedMgr.config) as OWedManagerConfig;\n\t\twedMgrConfig.readOnlyCauses = Array.from(wedMgr.readOnlyCauses);\n\t\twedMgrConfig.xaRoot = [0];\n\t\twedMgrConfig.rootModel = metaModel;\n\t\tif (parent && !WEDLET.isWritableWedlet(parent)) wedMgrConfig.readOnlyCauses = [\"wedletOwner\"];\n\t\tconst editorConfig = Object.create(wedMgr.wedEditor.config) as OWedEditorConfig & OWedEditorDiffBarConfig;\n\t\teditorConfig.hideDiffBar = true; //pas de diff pour metas en création\n\t\tconst newEditor = new WedEditorBox().initialize(editorConfig) as WedEditorBox;\n\t\tnewEditor.reg.installSkin(\"webzone:panel\", newEditor.shadowRoot);\n\t\tnewEditor.wedModel = wedMgr.wedModel;\n\t\tnewEditor.initFromDocHolder(docHolder, wedMgrConfig);\n\t\t//Focus le 1er wed focusable\n\t\tnewEditor.wedMgr.listeners.once(\"redrawAtEnd\", (wedMgr: WedMgr) => {\n\t\t\t(wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.focusFirst(wedMgr.rootWedlet);\n\t\t});\n\t\tawait POPUP.showDialog(newEditor, wedMgr.wedEditor.rootNode, {\n\t\t\ttitleBar: {barLabel: {label: title}, closeButton: dialogMetasCloseBtn},\n\t\t\tresizer: {},\n\t\t\tinitWidth: '80vw',\n\t\t\tinitHeight: '60vh',\n\t\t\tcloseOnCtrlEnter: true\n\t\t}).onNextClose();\n\t}\n\n\tconst dialogMetasCloseBtn: OButtonInit = {uiContext: 'dialog', label: \"Fermer\", title: \"Fermer l'édition de ces propriétés (vos modifications sont préservées)\"};\n}\n\n/** Area construisant l'editor d'un meta. */\nclass MetaEditorTab extends Area<null, WedEditorBox> {\n\n\tconstructor(public metaDef: IMetaDef) {\n\t\tsuper();\n\t}\n\n\tgetLabel() {return this.metaDef.label}\n\n\tbuildBody(): WedEditorBox {\n\t\tconst fromWedMgr = this.metaDef.from.wedMgr;\n\t\tconst editorConfig = Object.create(fromWedMgr.wedEditor.config) as OWedEditorBoxConfig;\n\t\teditorConfig.disableVirtuals = fromWedMgr.reg.getPref(\"wed.metaBar.disableVirtuals\", false);\n\t\tconst editor = new WedEditorBox().initialize(editorConfig) as WedEditorBox & IWedEditorSearchBar & IWedEditorDiffBar;\n\t\teditor.wedModel = fromWedMgr.wedModel;\n\t\tconst newDocHolder = fromWedMgr.docHolderAsync.cloneDocHolder();\n\t\tconst wedMgrConfig = Object.create(fromWedMgr.config) as OWedManagerConfig;\n\t\twedMgrConfig.readOnlyCauses = Array.from(fromWedMgr.readOnlyCauses);\n\t\twedMgrConfig.xaRoot = this.metaDef.from.wedAnchor;\n\t\twedMgrConfig.rootModel = this.metaDef.model;\n\t\tif (!WEDLET.isWritableWedlet(this.metaDef.from)) wedMgrConfig.readOnlyCauses = [\"wedletOwner\"];\n\t\twedMgrConfig.undoRedoFilter = newDocHolder.isMsgFromUs.bind(newDocHolder);\n\t\teditor.initFromDocHolder(newDocHolder, wedMgrConfig);\n\t\t//transfert searchBar.\n\t\tconst searchP = (fromWedMgr.wedEditor as IWedEditorSearchBar).searchBar?.getSearchParams();\n\t\tif (searchP) editor.searchBar?.setSearch(searchP);\n\t\t//transfert diffBar\n\t\tconst diffP = (fromWedMgr.wedEditor as IWedEditorDiffBar).diffBar?.getDiffParams();\n\t\tif (diffP) editor.getDiffBar().then((bar) => {bar.setDiffParams(diffP)});\n\t\teditor.wedMgr.listeners.on(\"hidden\", (wedMgr, closed) => {\n\t\t\tif (closed) wedMgr.killEditor();\n\t\t});\n\t\treturn editor;\n\t}\n}\n"]}