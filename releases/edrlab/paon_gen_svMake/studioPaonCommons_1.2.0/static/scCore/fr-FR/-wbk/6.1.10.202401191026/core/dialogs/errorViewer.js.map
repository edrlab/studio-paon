{"version":3,"sources":["/@back@/core/dialogs/errorViewer.tsx"],"names":["POPUP","REG","Action","BaseElement","DOM","JSX","DOMSH","ActionBtn","Button","ButtonToggle","ERROR","ErrorViewer","[object Object]","init","sr","this","attachShadow","SHADOWDOM_INIT","reg","findReg","installSkin","_initAndInstallSkin","appendChild","createElement","id","error","msg","main","details","addClass","technicalDetails","_showTechnicalBtn","initialize","uiContext","label","_technicalCo","hidden","onclick","self","findHost","toggleOn","_reportCo","_showReportBtn","removeClass","getReport","footer","actionContext","emitter","action","getList","closeBtn","findPopupableParent","close","registerSkin","customElements","define","copyReportAction","setLabel","setExecute","async","ctx","navigator","clipboard","writeText","showNotifInfo","e","showNotifError","addToList"],"mappings":"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","sourcesContent":["import {POPUP} from \"back/commons/widgets/popups\";\nimport {REG} from \"lib/commons/registry\";\nimport {Action, IAction} from \"lib/commons/actions\";\nimport {BaseElement, OSkinableInit} from \"back/commons/basis\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {ActionBtn, Button, ButtonToggle} from \"back/commons/widgets/buttons\";\nimport {IError} from \"lib/commons/errorLog\";\nimport {ERROR} from \"lib/core/errorReport\";\n\n/**\n *\n */\nexport interface ErrorViewer extends BaseElement {\n\tinitialize(init?: OErrorViewerInit): this\n}\n\nexport interface OErrorViewerInit extends OSkinableInit {\n\terror: IError;\n}\n\nexport class ErrorViewer extends BaseElement {\n\tprotected _reportCo: HTMLElement;\n\tprotected _showReportBtn: ButtonToggle;\n\tprotected _technicalCo: HTMLElement;\n\tprotected _showTechnicalBtn: ButtonToggle;\n\n\tprotected _initialize(init: OErrorViewerInit) {\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tconst reg = this.findReg(init);\n\t\treg.installSkin(\"webzone:panel\", sr);\n\t\treg.installSkin(\"standard-dialog\", sr);\n\t\treg.installSkin(\"scroll/small\", sr);\n\t\tthis._initAndInstallSkin('c-error-viewer', init);\n\t\tsr.appendChild(<div id=\"message\">{init.error.msg}</div>);\n\n\t\tconst main = sr.appendChild(<div id=\"main\"/>);\n\t\tif (init.error.details) {\n\t\t\tmain.appendChild(<div id=\"details\">{init.error.details}</div>);\n\t\t\tDOM.addClass(this, 'details');\n\t\t}\n\n\t\tif (init.error.technicalDetails) {\n\t\t\tthis._showTechnicalBtn = main.appendChild(new ButtonToggle().initialize({uiContext: \"dialog\", label: \"Afficher le détail technique\"}));\n\t\t\tthis._technicalCo = main.appendChild(<div id=\"technicalCo\" hidden=\"\">{init.error.technicalDetails}</div>);\n\t\t\tthis._showTechnicalBtn.onclick = function (this: ButtonToggle) {\n\t\t\t\tconst self = DOMSH.findHost<ErrorViewer>(this);\n\t\t\t\tif (!this.toggleOn) {\n\t\t\t\t\tthis.toggleOn = true;\n\t\t\t\t\tself._technicalCo.hidden = false;\n\t\t\t\t\tself._reportCo.hidden = true;\n\t\t\t\t\tself._showReportBtn.toggleOn = false;\n\t\t\t\t\tDOM.addClass(self, 'report');\n\t\t\t\t} else {\n\t\t\t\t\tthis.toggleOn = false;\n\t\t\t\t\tself._technicalCo.hidden = true;\n\t\t\t\t\tDOM.removeClass(self, 'report');\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\tthis._showReportBtn = main.appendChild(new ButtonToggle().initialize({uiContext: \"dialog\", label: \"Afficher le rapport complet\"}));\n\t\tthis._reportCo = main.appendChild(<div id=\"reportCo\" hidden=\"\">{ERROR.getReport(init.error)}</div>);\n\t\tthis._showReportBtn.onclick = function (this: ButtonToggle) {\n\t\t\tconst self = DOMSH.findHost<ErrorViewer>(this);\n\t\t\tif (!this.toggleOn) {\n\t\t\t\tthis.toggleOn = true;\n\t\t\t\tself._reportCo.hidden = false;\n\t\t\t\tif (self._technicalCo) {\n\t\t\t\t\tself._technicalCo.hidden = true;\n\t\t\t\t\tself._showTechnicalBtn.toggleOn = false;\n\t\t\t\t}\n\t\t\t\tDOM.addClass(self, 'report');\n\t\t\t} else {\n\t\t\t\tthis.toggleOn = false;\n\t\t\t\tself._reportCo.hidden = true;\n\t\t\t\tDOM.removeClass(self, 'report');\n\t\t\t}\n\t\t};\n\n\n\t\tconst footer = sr.appendChild(<div id=\"footer\"/>);\n\t\tconst actionContext = {error: init.error, emitter: this};\n\t\tfor (const action of REG.reg.getList<IAction<IErrorActionCtx>>('actions:error')) {\n\t\t\tfooter.appendChild(new ActionBtn<IErrorActionCtx>().initialize({action, actionContext, uiContext: 'dialog'}));\n\t\t}\n\t\tconst closeBtn = footer.appendChild(new Button().initialize({uiContext: \"dialog\", label: \"Fermer\"}));\n\t\tcloseBtn.onclick = function (this: Button) {\n\t\t\tPOPUP.findPopupableParent(this).close();\n\t\t};\n\t}\n}\n\nREG.reg.registerSkin('c-error-viewer', 1, /* language=CSS */ `\n\t:host(.report) {\n\t\theight: 80vh;\n\t}\n\n\t#message {\n\t\tfont-weight: 1.5em;\n\t\tfont-weight: bold;\n\t\ttext-align: center;\n\t\tmargin: 1em;\n\t}\n\n\t#main {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\tflex: 1;\n\t\tmargin: 1em;\n\t}\n\n\t:host(.report) #main {\n\t\tmin-height: 10em;\n\t}\n\n\t#details {\n\t\twhite-space: pre;\n\t\tpadding: 1em;\n\t}\n\n\tc-button-toggle {\n\t\tfont-size: 0.9em;\n\t\tmargin: 0.3em 0.5em;\n\t}\n\n\t#reportCo, #technicalCo {\n\t\tflex: 1;\n\t\toverflow: auto;\n\t\tbackground-color: var(--edit-bgcolor);\n\t\twhite-space: pre;\n\t\tpadding: 1em;\n\t}\n\n\t.msgList {\n\t\tpadding-inline-start: 1em;\n\t\tmargin: 0;\n\t}\n\n\t.error {\n\t\tcolor: var(--error-color);\n\t}\n\n\t.warn {\n\t\tcolor: var(--warning-color);\n\t}\n`);\n\ncustomElements.define('c-error-viewer', ErrorViewer);\n\n/**\n *\n */\nexport interface IErrorActionCtx {\n\terror: IError,\n\temitter: HTMLElement\n}\n\nexport let copyReportAction = new Action<IErrorActionCtx>()\n\t.setLabel(\"Copier le rapport\")\n\t.setExecute(async function (ctx) {\n\t\ttry {\n\t\t\tawait navigator.clipboard.writeText(ERROR.getReport(ctx.error));\n\t\t\tPOPUP.showNotifInfo(\"Le rapport a été copié dans le presse-papier.\", ctx.emitter);\n\t\t} catch (e) {\n\t\t\tPOPUP.showNotifError(\"Le rapport n'a pas pu être copié dans le presse-papier. Vérifiez dans votre navigateur que vous avez autorisé ce site à accéder au presse-papier.\", ctx.emitter);\n\t\t}\n\t});\nREG.reg.addToList(\"actions:error\", \"copyReport\", 1, copyReportAction, 0);\n\n"]}