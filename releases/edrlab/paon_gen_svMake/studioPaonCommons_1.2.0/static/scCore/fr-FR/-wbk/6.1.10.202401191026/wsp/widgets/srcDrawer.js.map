{"version":3,"sources":["/@back@/wsp/widgets/srcDrawer.tsx"],"names":["BaseElement","ActionBtn","PopupTooltip","ItemCreator","Action","ACTION","EventMgr","REG","renderAppend","xhtml","JSX","DOMSH","InfoHighlighItemSgn","ITEM","SRC","ItemType","UTILS","FocusItem","SrcAction","SearchItemSgnRegexp","isEltBoxSelection","EWspChangesEvts","WspsLivePlace","LOCALE","SrcDrawer","[object Object]","this","_fields","reg","env","wsp","wspMetaUi","getItemType","itModel","itemTypeNull","e","init","config","findReg","place","tplSvc","tpl","getSvc","tplOverSvc","tplOver","SRCDRAWER","itemCodeTpl","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","nodeName","addEventListener","ev","tt","initialize","tooltipOf","skinOver","hoverAllowed","drawer","itemType","_getItemType","contentRoot","close","forwardPointerEnter","once","_srcRefSub","srcRef","shortDesc","redraw","fetchSrc","super","buildInitFromAtts","hasAttribute","getAttribute","showStatus","connectedCallback","_refreshFreeze","_lstn","onWspUriChange","bind","eventsMgr","on","removeListener","extractSrcRef","srcRefSub","fields","undefined","initialized","onSrcRefChange","_onSrcRefChange","fetchPending","fetchShortDesc","shortDescs","length","classList","toggle","lastCh","shadowRoot","lastElementChild","localName","appendChild","createElement","emit","msg","from","wspCd","code","type","r","isSubUriOrEqual","srcUri","u","s","itSt","infoBroker","emitter","registerSkin","customElements","define","SrcDrawerInline","SrcPointer","actionContext","SrcPointerFastSelect","SINGLETON","execute","focusActionables","mergeActionablesForBar","getPref","actionsLists","ctxMenuActions","actions","mergeLists","injectSepByGroup","sgnPattern","_sgnPattern","subSgnPattern","_subSgnPattern","tabIndex","skin","_initialize","defaultAction","onDblClick","readOnly","ACTIONS","accelKeyMgr","mergeAccelKeyMgr","accelKeysLists","ACCELKEYS","handleKeyboardEvent","draggable","setAttribute","setShortDescTransferToDragSession","resetShortDescTransferToDragSession","dropable","transferCtx","targetSrcType","canCreate","srcCreatable","preventDefault","stopImmediatePropagation","getShortDescsTransferFromDragSession","dataTransfer","dropEffect","srcRefs","isImport","setSrcRef","_initDispatchHighlight","dispatchHighlight","onFocus","onBlur","matches","dispatchInfo","act","executeIfAvailable","parent","root","propName","SrcPointerInline","SrcBtn","SrcPointerSetterAction","ctx","uiContext","action","role","SrcPointerWriteAction","isEnabled","SrcPointerPaste","setLabel","setGroup","getShortDescsTransferFromClipboard","Array","isArray","SrcPointerCreateItem","_icon","isVisible","regexp","itemCtx","longDesc","newItem","openCreateItem","setDefaultConfigFromReg","itemTypesTree","itemTypeReducer","acc","cur","test","getSgn","push","textFilter","spaceUri","extractSpaceUri","onNextClose","id","_label","_group","crit","customCrit","FastFindItem","import","currentSrc","sd","openFastFind","restrictions","getRestrictions","srcFilter","getSrcFilter","itemCreator","subItemsFind","subItemSgnPattern","focus","source","SrcPointerErase","SrcPointerDblClick","gotoItem","addAction","accel","order","addToList","getId","srcDrawer","getIcon","getSrcMainName","wspMeta","itemCodeAloneTpl","itemTitleTpl","getTitle","itemIconTitleTpl","itemTitleOrCodeTpl","itemCodeAndTitleTpl","getSrcSecondName","itemUriTpl","extractItemUri","previewTpl","itSubItem","subTitemType","mo","getPreview","previewOrItemCodeTpl","previewOrItemTitleOrCodeTpl","previewAndItemCodeTpl","previewAndItemCodeAndTitleTpl","detailsTpl","getItemUriLabel","srcDate","detailsItemIconPreviewTpl","detailsPreviewTpl","srcDt","formatDateDigitsToSec","format","Date","srcUser","nickOrAccount","typesAllowedTpl","datas","getItemTypesTree","curr","draw","data","label","children","map","title","createSkin","wedBarActions","bar","focusBar","filter","a","detailsOrTypesTpl","detailsPreviewOrTypesTpl","spaceTpl","getSpaceIcon"],"mappings":"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","sourcesContent":["import {IActionable, IContextMenuActions, IContextMenuActionsPointer, IFocusActionables, OActionableListInit} from \"back/commons/actionables\";\nimport {BaseElement, OSkinableInit} from \"back/commons/basis\";\nimport {ActionBtn, OActionBtnInit} from \"back/commons/widgets/buttons\";\nimport {PopupTooltip} from \"back/commons/widgets/popups\";\nimport {FastFindItem} from \"back/wsp/dialogs/fastFindItem\";\nimport {ItemCreator} from \"back/wsp/dialogs/itemCreator\";\nimport {IItemUiEnv} from \"back/wsp/views/itemMain\";\nimport {AccelKeyMgr, Action, ACTION, EButtonUiContext, IAccelKeyMgrPointer, IAction} from \"lib/commons/actions\";\nimport {EventMgr} from \"lib/commons/events\";\nimport {IInfoBroker, IInfoBrokerPointer} from \"lib/commons/infos\";\nimport {IReg, REG} from 'lib/commons/registry';\nimport {renderAppend, TemplateResult, xhtml} from \"lib/commons/utils/htmlLit\";\nimport {JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {InfoHighlighItemSgn, IShortDescCtx, ITEM, OTransferSrcContext, srcRefSub} from \"lib/wsp/item\";\nimport {JSrcFields, SRC, srcRef} from \"lib/wsp/src\";\nimport {IWspEnv, IWspUiEnv, JWspUriChangeMsg} from \"lib/wsp/wsp\";\nimport {IDirItemType, ItemType, UTILS} from \"lib/wsp/wspMetaUi\";\nimport {FocusItem, SrcAction} from \"back/wsp/actions/srcActions\";\nimport {ISearchCrit, SearchItemSgnRegexp} from \"lib/wsp/search\";\nimport {IWedletActionCtx} from \"back/edit/wed/wedlets/wedlet\";\nimport {isEltBoxSelection} from \"back/edit/wed/features/boxSel\";\nimport {EWspChangesEvts, WspsLivePlace} from \"lib/wsp/wspsLive\";\nimport {IFormJsonisable} from \"lib/commons/forms\";\nimport {OUserRefInit} from \"back/core/widgets/userRef\";\nimport {LOCALE} from \"lib/commons/lang\";\n\n/**\n * Dessine une ref à un item (voir un espace) selon un template HTML et optionnellement un template d'un tooltip.\n *\n * Si aucune référence n'est renseignée (srcRef=\"\"), une classe \"empty\" est ajoutée au widget: utile pour la notion\n * de champ obligatoire.\n *\n * Attributs:\n * Config init : tpl, tpl-over, show-status\n * States : srcRef\n */\nexport interface SrcDrawer {\n\tinitialize(init: OSrcDrawerInit): this\n}\n\nexport interface OSrcDrawerInit extends OSkinableInit {\n\treg?: IReg<IWspEnv>\n\n\tshowStatus?: boolean\n\n\ttplSvc?: string\n\ttpl?: (itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer) => TemplateResult\n\n\ttplOverSvc?: string\n\ttplOver?: (itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer) => TemplateResult\n\n\t/**\n\t * Si renseigné, le widget s'abonnera à cette place pour le refresh auto, sinon tentera this.reg.env.place.\n\t * Si \"none\", le widget ne s'abonnera pas (affichages éphémères ou en masse, gestion du refresh géré par l'appelant).\n\t */\n\tplace?: WspsLivePlace | \"none\"\n\n\t/** Si le srcRef est connu à l'init, mais pas les shortDesc. */\n\tsrcRef?: srcRefSub\n\n\t/** Si on dispose du shortDesc à afficher, srcRef est inutile. */\n\tshortDesc?: JSrcFields\n}\n\nexport class SrcDrawer extends BaseElement implements IShortDescCtx {\n\n\treg: IReg<IWspUiEnv & IInfoBrokerPointer>;\n\n\tconfig: OSrcDrawerInit;\n\n\t/** API IShortDescCtx */\n\tshortDescs: JSrcFields[];\n\n\t/** Non null si chargement en cours. */\n\tfetchPending: Promise<JSrcFields>;\n\n\tprotected _srcRefSub: srcRefSub | null;\n\n\tprotected _fields: JSrcFields;\n\n\t/** Mémoire du listener des WspChanges pour delete. */\n\tprotected _lstn: (msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') => void;\n\n\t/**\n\t * Si space, retourne l'itemType NotFound.\n\t * Si wspMetaUi indispo, retourne null.\n\t */\n\tprotected _getItemType(): ItemType | null {\n\t\ttry {\n\t\t\treturn this._fields ? this.reg.env.wsp.wspMetaUi.getItemType(this._fields.itModel) : this.reg.env.wsp.wspMetaUi.itemTypeNull;\n\t\t} catch (e) {\n\t\t\t//En cas de déchargement ou invalidité du wsp, la chaine this.reg.env.wsp.wspMetaUi... peut produire un NPE.\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t/** Listeners sur chgt de la source. */\n\tprotected _onSrcRefChange: EventMgr<(drawer: SrcDrawer) => void>;\n\n\tprotected _initialize(init: OSrcDrawerInit) {\n\t\tthis.config = init || {};\n\t\tif (!this.reg) this.reg = this.findReg(init);\n\t\tif (!this.config.place) this.config.place = this.reg.env.place; //set default place si this.config.place != \"none\"\n\t\tif (this.config.tplSvc) this.config.tpl = this.reg.getSvc(this.config.tplSvc);\n\t\tif (this.config.tplOverSvc) this.config.tplOver = this.reg.getSvc(this.config.tplOverSvc);\n\t\tif (!this.config.tpl) this.config.tpl = SRCDRAWER.itemCodeTpl;\n\t\tthis.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.nodeName, init);\n\t\tif (init.tplOver) {\n\t\t\tthis.addEventListener('pointerenter', function (this: SrcDrawer, ev) {\n\t\t\t\tconst tt = new PopupTooltip().initialize({\n\t\t\t\t\ttooltipOf: this,\n\t\t\t\t\tskinOver: 'wsp-src-drawer/tooltip',\n\t\t\t\t\thoverAllowed: true\n\t\t\t\t});\n\t\t\t\ttt.addEventListener('c-show', function (this: PopupTooltip, ev) {\n\t\t\t\t\tconst drawer = this.tooltipOf as SrcDrawer;\n\t\t\t\t\tconst itemType = drawer._getItemType();\n\t\t\t\t\tconst tpl = itemType ? drawer.config.tplOver(itemType, drawer._fields, drawer) : null;\n\t\t\t\t\tif (tpl) renderAppend(tpl, this.contentRoot);\n\t\t\t\t\telse this.close();\n\t\t\t\t});\n\t\t\t\ttt.forwardPointerEnter(ev);\n\t\t\t}, {once: true});\n\t\t}\n\t\tif (!this._srcRefSub) this._srcRefSub = init.srcRef || null;\n\t\tif (init.shortDesc) {\n\t\t\tthis.redraw(init.shortDesc);\n\t\t} else this.fetchSrc();\n\t}\n\n\tbuildInitFromAtts(init?: OSrcDrawerInit): OSrcDrawerInit {\n\t\tinit = super.buildInitFromAtts(init);\n\t\tif (this.hasAttribute(\"srcRef\")) init.srcRef = this.getAttribute(\"srcRef\");\n\t\tif (this.hasAttribute(\"tpl\")) init.tplSvc = this.getAttribute(\"tpl\");\n\t\tif (this.hasAttribute(\"tpl-over\")) init.tplSvc = this.getAttribute(\"tpl-over\");\n\t\tif (this.hasAttribute(\"show-status\")) init.showStatus = this.getAttribute(\"show-status\") === \"true\";\n\t\treturn init;\n\t}\n\n\tconnectedCallback() {\n\t\tsuper.connectedCallback();\n\t\tif (this.config.place instanceof WspsLivePlace && this._refreshFreeze === 0) {\n\t\t\tthis._lstn = this.onWspUriChange.bind(this);\n\t\t\tthis.config.place.eventsMgr.on('wspUriChange', this._lstn);\n\t\t}\n\t}\n\n\tdisconnectedCallback() {\n\t\tif (this.config.place instanceof WspsLivePlace && this._refreshFreeze === 0) this.config.place.eventsMgr.removeListener('wspUriChange', this._lstn);\n\t}\n\n\t/** Si le srcRef est connu à l'init, mais pas les shortDesc. */\n\tget srcRef(): srcRef {return ITEM.extractSrcRef(this._srcRefSub)}\n\n\tget srcRefSub(): srcRefSub {return this._srcRefSub}\n\n\t/**\n\t *\n\t * @param srcRefSub\n\t * @param fields\n\t *  Si renseigné, pris tel quel.\n\t *  Si null, force un chargement du shortDesc\n\t *  Si undefined, charge le shortDesc si srcRef a changé\n\t */\n\tsetSrcRef(srcRefSub: srcRefSub, fields?: JSrcFields): void | Promise<void> {\n\t\tif (fields) srcRefSub = ITEM.srcRefSub(fields); //on normalise srcRef\n\t\tif (this._srcRefSub === srcRefSub && fields === undefined) return; //même src, pas de chgt explicite des fields.\n\t\tthis._srcRefSub = srcRefSub;\n\t\tif (this.initialized) {\n\t\t\tif (fields) this.redraw(fields);\n\t\t\telse return this.fetchSrc();\n\t\t}\n\t}\n\n\t/** ShortDesc actuellement chargé. Voir .fetchPending pour détecter un autre chargement est en cours. */\n\tget shortDesc() {return this._fields}\n\n\tget onSrcRefChange(): EventMgr<(drawer: SrcDrawer) => void> {return this._onSrcRefChange || (this._onSrcRefChange = new EventMgr())}\n\n\tasync fetchSrc() {\n\t\tconst srcRef = this._srcRefSub;\n\t\tif (srcRef) {\n\t\t\tthis.fetchPending = this.reg.env.wsp.fetchShortDesc(srcRef, this);\n\t\t\ttry {\n\t\t\t\tconst fields = await this.fetchPending;\n\t\t\t\tif (srcRef === this._srcRefSub) this.redraw(fields); //check raceCond\n\t\t\t} catch (e) {\n\t\t\t\tthis.redraw(null); //FIXME créer shortDesc en erreur\n\t\t\t} finally {\n\t\t\t\tthis.fetchPending = null;\n\t\t\t}\n\t\t} else this.redraw(null);\n\t}\n\n\tprotected redraw(fields: JSrcFields | null) {\n\t\tthis._srcRefSub = fields ? ITEM.srcRefSub(fields) : null;// (ré)affecte, normalise le srcRef\n\t\tthis._fields = fields; //Mémoire utile notamment pour le tooltip : redraw async.\n\t\tif (this.shortDescs) {\n\t\t\t//API IShortDescCtx\n\t\t\tif (fields) this.shortDescs[0] = fields;\n\t\t\telse this.shortDescs.length = 0;\n\t\t}\n\t\tthis.classList.toggle(\"empty\", fields == null);\n\t\tconst lastCh = this.shadowRoot.lastElementChild;\n\t\tconst itemType = this._getItemType(); //Si null wspMetaUi HS\n\t\trenderAppend(itemType ? this.config.tpl(itemType, fields, this) : xhtml`<span/>`, this.shadowRoot);\n\t\tif (lastCh.localName !== \"slot\") this.shadowRoot.appendChild(<slot/>);\n\t\tif (this._onSrcRefChange) this._onSrcRefChange.emit(this);\n\t}\n\n\tprotected onWspUriChange(msg: JWspUriChangeMsg, from: WspsLivePlace | 'house' | 'server') {\n\t\tif (msg.wspCd !== this.reg.env.wsp.code) return;\n\t\tif (msg.type === EWspChangesEvts.r) {\n\t\t\tif (this._fields && SRC.isSubUriOrEqual(msg.srcUri, this._fields.srcUri)) this.fetchSrc();\n\t\t} else if (this.srcRef === SRC.srcRef(msg)) {\n\t\t\tif (msg.type === EWspChangesEvts.u) this.fetchSrc();\n\t\t\telse if (this.config.showStatus && msg.type === EWspChangesEvts.s) {\n\t\t\t\tif (this._fields) {\n\t\t\t\t\tthis._fields['itSt'] = msg.itSt;\n\t\t\t\t\tthis.redraw(this._fields);\n\t\t\t\t} else this.fetchSrc();\n\t\t\t}\n\t\t}\n\t}\n\n\t//*** API IShortDescCtx ***\n\n\tget infoBroker(): IInfoBroker {return this.reg.env.infoBroker}\n\n\tget emitter(): HTMLElement {return this}\n}\n\nREG.reg.registerSkin('wsp-src-drawer', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\tpadding: 2px;\n\t\tmargin: 0 .5em;\n\t}\n\n\t.code {\n\t\tcolor: var(--fade-color);\n\t\tfont-size: var(--label-size);\n\t}\n\n\t.icon {\n\t\tfilter: var(--filter);\n\t\tvertical-align: text-bottom;\n\t\tuser-select: none;\n\t}\n\n\t.itTi {\n\t\tcolor: var(--alt1-color);\n\t\tfont-size: var(--label-size);\n\t}\n\n\t.imgView, .videoView, .audioView, .iframeView, .dynGenView {\n\t\tmax-height: 10em;\n\t\tobject-fit: scale-down;\n\t\tmax-width: 100%;\n\t}\n\n\t.audioView {\n\t\tmax-height: 2em;\n\t}\n\n\t.iframeView, .dynGenView {\n\t\tborder: 1px solid var(--border-color);\n\t\twidth: 100%;\n\t}\n`);\n\ncustomElements.define('wsp-src-drawer', SrcDrawer);\n\n\nexport class SrcDrawerInline extends SrcDrawer {\n}\n\nREG.reg.registerSkin('wsp-src-drawer-inline', 1, /* language=CSS */ `\n\t:host {\n\t\twhite-space: nowrap;\n\t\tuser-select: none;\n\t}\n\n\t.imgView, .videoView, .audioView, .iframeView, .dynGenView {\n\t\tmax-height: 5em;\n\t\tvertical-align: bottom;\n\t}\n\n\t.audioView {\n\t\tmax-height: 2em;\n\t}\n\n\t:host(.fixedIconSize) .icon {\n\t\tmax-height: var(--icon-size);\n\t\twidth: var(--icon-size);\n\t}\n\n\t.code,\n\t.itTi {\n\t\tcolor: var(--fade-color);\n\t\tfont-size: var(--label-size);\n\t}\n\n\t.icon {\n\t\tfilter: var(--filter);\n\t\tvertical-align: text-bottom;\n\t\tmax-height: 1 lh;\n\t\tmax-height: 1.4em;\n\t}\n`);\n\ncustomElements.define('wsp-src-drawer-inline', SrcDrawerInline);\n\n/** Skin pour SrcDrawer affiché en tooltip. */\nREG.reg.registerSkin('wsp-src-drawer/tooltip', 1, /* language=CSS */ `\n\t#content {\n\t\tflex: 1 1 auto;\n\t\toverflow: hidden;\n\t\ttext-overflow: ellipsis;\n\t}\n\n\t.details {\n\t\tfont-size: var(--label-size);\n\t\tpadding: 0;\n\t\tmargin: .5em;\n\t}\n\n\t.details > li {\n\t\tdisplay: block;\n\t\tmax-width: 40vw;\n\t}\n\n\t.itTi {\n\t\tfont-weight: bold;\n\t}\n\n\t.val {\n\t\tuser-select: all;\n\t}\n\n\t.itemPreview {\n\t\tborder: 1px solid var(--border-color);\n\t\tmax-height: 40vh;\n\t\tmax-width: 40vw;\n\t}\n\n\t.imgView, .videoView, .audioView, .iframeView, .dynGenView {\n\t\tmax-width: 40vw;\n\t\tmax-height: 40vh;\n\t}\n\n\t.audioView {\n\t\tmax-height: 2em;\n\t}\n`);\n\n/**\n * Objet focusable\n * Implémentation copier/coller, drag-drop, lien à un itemSelector,\n * Interaction avec une focusToolbar lorsqu'on a le focus.\n */\n\nexport interface SrcPointer extends SrcDrawer, IFocusActionables<IShortDescCtx> {\n\tinitialize(init?: OItemPointerInit): this\n}\n\nexport interface OItemPointerInit extends OSrcDrawerInit {\n\n\t/** Signatures d'items autorisées (exploité par les actions d'édition). */\n\tsgnPattern?: RegExp\n\n\t/** Signatures des subItems autorisées (exploité par les actions d'édition). */\n\tsubSgnPattern?: RegExp\n\n\t/** Active le dispatch d'un IInfoHighlighItemSgn auprès de l'infoBroker lorsque ce ptrItem détient le focus. */\n\tdispatchHighlight?: boolean\n\n\treadOnly?: boolean;\n\n\t/**\n\t * Surcharge des listes d'actions (listes de Action<IShortDescCtx>).\n\t * Valeur par défaut : [\"actions:wsp:src-pointer\", \"actions:wsp:shortDesc\"]\n\t *\n\t * Note : pour obtenir un widget sans action visible en écriture, supprimer ou remplacer \"actions:wsp:src-pointer\".\n\t */\n\tactionsLists?: string[]\n\n\t/** Action au double-click. */\n\tdefaultAction?: IAction<IShortDescCtx>\n\n\t/**\n\t * Surcharge des racourcis claviers (listes de Action<IShortDescCtx>).\n\t * Valeur par défaut : \"accelkeys:wsp:src-pointer\", \"accelkeys:wsp:shortDesc\"\n\t */\n\taccelKeysLists?: string[]\n\n\tdraggable?: boolean\n\tdropable?: boolean\n\n\t/** Sur drop en particulier, permet-on la création de contenu à partir d'une source externe (File, blob, url...) ? */\n\tsrcCreatable?: boolean\n}\n\nexport class SrcPointer extends SrcDrawer implements IFocusActionables<IShortDescCtx>, IContextMenuActionsPointer<IShortDescCtx>, IAccelKeyMgrPointer<IShortDescCtx>, IFormJsonisable {\n\n\tactionsLists: string[];\n\n\taccelKeyMgr: AccelKeyMgr<IShortDescCtx>;\n\n\treadOnly: boolean;\n\n\tconfig: OItemPointerInit;\n\n\t/** nom de la propriété JSON à renseigner si utilisation de IFormJsonisable **/\n\tpropName?: string;\n\n\tget actionContext(): IShortDescCtx {return this}\n\n\tprotected _sgnPattern: RegExp;\n\n\tprotected _subSgnPattern: RegExp;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.shortDescs = [];\n\t}\n\n\topenFastSelect(): Promise<void> {\n\t\treturn SrcPointerFastSelect.SINGLETON.execute(this);\n\t}\n\n\tget focusActionables(): IActionable<IShortDescCtx>[] {\n\t\treturn ActionBtn.mergeActionablesForBar<IShortDescCtx>(this.reg, this.reg.getPref(\"groupOrder.wsp.shortDesc\", \"\"), this, ...this.actionsLists);\n\t}\n\n\tget ctxMenuActions(): IContextMenuActions<IShortDescCtx> {\n\t\tlet actions = this.reg.mergeLists<IAction<IShortDescCtx>>(...this.actionsLists);\n\t\tactions = ACTION.injectSepByGroup(actions, this.reg.getPref(\"groupOrder.wsp.shortDesc\", \"\"), this);\n\t\treturn actions && actions.length > 0 ? {actions, actionContext: this.actionContext} : null;\n\t}\n\n\tget sgnPattern(): RegExp {return this._sgnPattern}\n\n\tget subSgnPattern(): RegExp {return this._subSgnPattern}\n\n\tprotected _initialize(init: OItemPointerInit) {\n\t\tthis.tabIndex = 0;\n\t\tif (!init.skin) init.skin = 'wsp-src-drawer';\n\t\tif (!init.skinOver) init.skinOver = 'wsp-src-pointer';\n\t\tsuper._initialize(init);\n\n\t\tif (init.defaultAction) this.addEventListener('dblclick', this.onDblClick);\n\n\t\tif (init.readOnly) this.readOnly = init.readOnly;\n\t\tif (init.sgnPattern) this._sgnPattern = init.sgnPattern;\n\t\tif (init.subSgnPattern) this._subSgnPattern = init.subSgnPattern;\n\t\tthis.actionsLists = init.actionsLists || ACTIONS;\n\t\tthis.accelKeyMgr = ACTION.mergeAccelKeyMgr<IShortDescCtx>(this.reg, ...(init.accelKeysLists || ACCELKEYS));\n\t\tif (this.accelKeyMgr) this.addEventListener('keydown', function (this: SrcPointer, ev: KeyboardEvent) {\n\t\t\tthis.accelKeyMgr.handleKeyboardEvent(ev, this.actionContext);\n\t\t});\n\t\tif (init.draggable) {\n\t\t\tthis.setAttribute(\"draggable\", \"true\");\n\t\t\tthis.addEventListener('dragstart', function (this: SrcPointer, ev: DragEvent) {\n\t\t\t\tif (this.shortDescs[0]) ITEM.setShortDescTransferToDragSession(this, ev, 'native');\n\t\t\t});\n\t\t\tthis.addEventListener('dragend', ITEM.resetShortDescTransferToDragSession);\n\t\t}\n\t\tif (init.dropable) {\n\t\t\tconst transferCtx: OTransferSrcContext = {targetSrcType: \"item\", canCreate: init.srcCreatable};\n\t\t\tthis.addEventListener('dragover', function (this: SrcPointer, ev: DragEvent) {\n\t\t\t\tev.preventDefault();\n\t\t\t\tev.stopImmediatePropagation();\n\t\t\t\tconst shortDescs = ITEM.getShortDescsTransferFromDragSession(this.reg, ev.dataTransfer, transferCtx, this);\n\t\t\t\tev.dataTransfer.dropEffect = !shortDescs || shortDescs.srcRefs.length < 1 || shortDescs.wspCd !== this.reg.env.wsp.code ? \"none\" : \"copy\"; //on autorise le drop\n\t\t\t});\n\t\t\tthis.addEventListener('drop', function (this: SrcPointer, ev: DragEvent) {\n\t\t\t\tev.preventDefault();\n\t\t\t\tev.stopImmediatePropagation();\n\t\t\t\tconst shortDescs = ITEM.getShortDescsTransferFromDragSession(this.reg, ev.dataTransfer, transferCtx, this);\n\t\t\t\tif (!shortDescs || shortDescs.isImport || shortDescs.srcRefs.length < 1 || shortDescs.wspCd !== this.reg.env.wsp.code) return;\n\t\t\t\tthis.setSrcRef(shortDescs.srcRefs[0], shortDescs.shortDescs[0]);\n\t\t\t});\n\t\t}\n\n\t\tthis._initDispatchHighlight(init);\n\t}\n\n\tprotected _initDispatchHighlight(init: OItemPointerInit) {\n\t\tif (init.dispatchHighlight && this.reg.env.infoBroker) {\n\t\t\tthis.addEventListener('focus', this.onFocus);\n\t\t\tthis.addEventListener('blur', this.onBlur);\n\t\t}\n\t}\n\n\tprotected redraw(fields: JSrcFields | null) {\n\t\tsuper.redraw(fields);\n\t\tif (this.config.dispatchHighlight && this.matches(\":focus\")) {\n\t\t\tconst infoBroker = this.reg.env.infoBroker;\n\t\t\tif (infoBroker) infoBroker.dispatchInfo(new InfoHighlighItemSgn(this.sgnPattern, this.srcRef), this);\n\t\t}\n\t}\n\n\tonFocus(ev: FocusEvent) {\n\t\tconst infoBroker = this.reg.env.infoBroker;\n\t\tif (infoBroker) infoBroker.dispatchInfo(new InfoHighlighItemSgn(this.sgnPattern, this.srcRef), this);\n\t}\n\n\tonBlur(ev: FocusEvent) {\n\t\tconst infoBroker = this.reg.env.infoBroker;\n\t\tif (infoBroker) infoBroker.dispatchInfo(new InfoHighlighItemSgn(null), this);\n\t}\n\n\tonDblClick(ev: MouseEvent) {\n\t\tconst act = this.config.defaultAction;\n\t\tif (act) act.executeIfAvailable(this, ev);\n\t}\n\n\tfillJson(parent: any, root: any): void {\n\t\tif (this.propName)\n\t\t\tparent[this.propName] = this.srcRef;\n\t}\n\n\textractJson(parent: Dict<any>): boolean {\n\t\tif (this.propName && this.propName in parent) {\n\t\t\tthis.setSrcRef(parent[this.propName]);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n}\n\ncustomElements.define('wsp-src-pointer', SrcPointer);\n\n/** Surcharges du skin wsp-src-drawer */\nREG.reg.registerSkin('wsp-src-pointer', 1, /* language=CSS */ `\n\t:host {\n\t\tcursor: pointer;\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--focus-outline);\n\t\toutline-offset: -2px;\n\t}\n`);\n\n\nexport class SrcPointerInline extends SrcPointer {\n\n\tprotected _initialize(init: OItemPointerInit) {\n\t\tif (!init.skin) init.skin = 'wsp-src-drawer-inline';\n\t\tif (!init.skinOver) init.skinOver = 'wsp-src-pointer-inline';\n\t\tsuper._initialize(init);\n\t}\n\n}\n\ncustomElements.define('wsp-src-pointer-inline', SrcPointerInline);\n\n/** Surcharges du skin wsp-src-drawer-inline */\nREG.reg.registerSkin('wsp-src-pointer-inline', 1, /* language=CSS */ `\n\t:host {\n\t\tcursor: pointer;\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--focus-outline);\n\t\toutline-offset: -2px;\n\t}\n`);\n\nexport type OSrcBtnInit<C> = OActionBtnInit<C> & OSrcDrawerInit;\n\n/**\n * Principalement pour affichage de liste de src en menu...\n */\nexport interface SrcBtn<C> extends ActionBtn<C> {\n\tinitialize(init?: OSrcBtnInit<C>): this\n}\n\nexport class SrcBtn<C> extends ActionBtn<C> {\n\n\tprotected _initialize(init: OSrcBtnInit<C>) {\n\t\tinit.skin = \"wsp-src-btn\";\n\t\tsuper._initialize(init);\n\t\tinit.skin = 'wsp-src-drawer-inline';\n\t\tif (!init.place) init.place = \"none\";\n\t\tthis.shadowRoot.appendChild(new SrcDrawer().initialize(init));\n\t}\n\n\tprotected _refresh() {\n\t}\n}\n\n//TODO gestion checked\nREG.reg.registerSkin('wsp-src-btn', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t}\n\n\t:host(:focus) {\n\t\tbackground-color: var(--row-inSel-bgcolor);\n\t\toutline: none;\n\t}\n`);\n\ncustomElements.define('wsp-src-btn', SrcBtn);\n\n\n/**\n * Action construisant un SrcBtn pour affecter une srcRef à un SrcPointer.\n * Utilisé dans les l'affichage de listes d'items : historiques...\n */\nexport class SrcPointerSetterAction extends Action<SrcPointer> {\n\n\tconstructor(public shortDesc: JSrcFields) {\n\t\tsuper();\n\t}\n\n\tbuildCustomButton(ctx: SrcPointer, uiContext: EButtonUiContext, parent?: Element): Element | null | undefined {\n\t\treturn new SrcBtn<SrcPointer>().initialize({\n\t\t\treg: ctx.reg,\n\t\t\taction: this,\n\t\t\tactionContext: ctx,\n\t\t\tshortDesc: this.shortDesc,\n\t\t\tuiContext: uiContext,\n\t\t\trole: uiContext === 'menu' ? 'menuitem' : 'button'\n\t\t});\n\t}\n\n\texecute(ctx: SrcPointer, ev?: Event): any | \"noPreventDefault\" {\n\t\tctx.setSrcRef(SRC.srcRef(this.shortDesc), this.shortDesc);\n\t}\n}\n\n\nconst ACTIONS = [\"actions:wsp:src-pointer\", \"actions:wsp:shortDesc\"];\nconst ACCELKEYS = [\"accelkeys:wsp:src-pointer\", \"accelkeys:wsp:shortDesc\"];\n\n\nexport class SrcPointerWriteAction extends Action<SrcPointer> {\n\tisEnabled(ctx: SrcPointer) {\n\t\tif (ctx.readOnly) return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n}\n\n\nexport class SrcPointerPaste extends SrcPointerWriteAction {\n\tstatic SINGLETON = new SrcPointerPaste();\n\n\tconstructor() {\n\t\tsuper('paste');\n\t\tthis.setLabel(\"Coller\");\n\t\tthis.setGroup(\"clipboard\");\n\t}\n\n\tasync execute(ctx: SrcPointer, ev?: Event) {\n\t\tconst wsp = ctx.reg.env.wsp;\n\t\tconst shortDescs = await ITEM.getShortDescsTransferFromClipboard(wsp, ctx.emitter);\n\t\tif (!shortDescs || Array.isArray(shortDescs)) return;\n\t\tif (shortDescs.isImport || shortDescs.srcRefs.length < 1 || shortDescs.wspCd !== wsp.code) return;\n\t\tctx.setSrcRef(shortDescs.srcRefs[0], shortDescs.shortDescs[0]);\n\t}\n}\n\nexport class SrcPointerCreateItem extends SrcPointerWriteAction {\n\tconstructor() {\n\t\tsuper('create');\n\t\tthis.setLabel(\"Créer un item...\");\n\t\tthis._icon = \"/@skin@/wsp/actions/createItem.svg\";\n\t\tthis.setGroup(\"edit\");\n\t\t// NOTE : pas d'évaluation de la perm 'create.item' car la création peut avoir lieu ailleurs que dans le contexte courant\n\t}\n\n\tisVisible(ctx: SrcPointer): boolean {\n\t\tif (!ctx.reg.getPref(\"wsp.createItem\", true)) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tasync execute(ctx: SrcPointer, ev?: Event) {\n\t\tconst regexp = ctx.sgnPattern;\n\t\tconst itemCtx = (ctx.reg.env as IItemUiEnv).longDesc;\n\t\tconst newItem = await ItemCreator.openCreateItem(ItemCreator.setDefaultConfigFromReg(ctx.reg, {\n\t\t\titemTypesTree: {\n\t\t\t\titemTypeReducer: regexp ? (acc: ItemType[], cur: ItemType) => {\n\t\t\t\t\tif (regexp.test(cur.getSgn())) acc.push(cur);\n\t\t\t\t\treturn acc;\n\t\t\t\t} : null,\n\t\t\t\ttextFilter: \"\"\n\t\t\t},\n\t\t\tspaceUri: itemCtx ? ITEM.extractSpaceUri(itemCtx.srcUri) : \"\"\n\t\t}), \"Créer un item...\", ctx,).onNextClose();\n\t\tif (newItem) ctx.setSrcRef(SRC.srcRef(newItem), newItem);\n\t}\n}\n\n/**\n * Action d'affichage du FastFind à partir d'un SrcPointer.\n */\nexport class SrcPointerFastSelect extends SrcPointerWriteAction {\n\n\tstatic SINGLETON = new SrcPointerFastSelect();\n\n\tcustomCrit?: ISearchCrit;\n\n\tconstructor(id?:string) {\n\t\tsuper(id || \"fastSelect\");\n\t\tthis._label = \"Sélection rapide...\";\n\t\tthis._icon = \"/@skin@/wsp/actions/fastFind.svg\";\n\t\tthis._group = 'ptrEdit';\n\t}\n\n\tsetCustomCrit(crit: ISearchCrit): this {\n\t\tthis.customCrit = crit;\n\t\treturn this;\n\t}\n\n\tasync execute(ctx: SrcPointer, ev?: Event) {\n\t\t//Chargement asynch du fastFind\n\t\tconst {FastFindItem} = await import(\"back/wsp/dialogs/fastFindItem.js\");\n\t\tconst currentSrc = (ctx.reg.env as IItemUiEnv).longDesc;\n\t\tconst sgnPattern = ctx.sgnPattern;\n\t\tconst sd = await FastFindItem.openFastFind({\n\t\t\treg: ctx.reg,\n\t\t\trestrictions: this.getRestrictions(ctx, ev),\n\t\t\tsrcFilter: this.getSrcFilter(ctx, ev),\n\t\t\titemCreator: ctx.reg.getPref(\"wsp.createItem\", true) ? ItemCreator.setDefaultConfigFromReg(ctx.reg, {\n\t\t\t\tspaceUri: currentSrc ? ITEM.extractSpaceUri(currentSrc.srcUri) : \"\",\n\t\t\t\titemTypesTree: {\n\t\t\t\t\titemTypeReducer: sgnPattern ? (acc: ItemType[], cur: ItemType) => {\n\t\t\t\t\t\tif (sgnPattern.test(cur.getSgn())) acc.push(cur);\n\t\t\t\t\t\treturn acc;\n\t\t\t\t\t} : null\n\t\t\t\t}\n\t\t\t}) : undefined,\n\t\t\tsubItemsFind: ctx.subSgnPattern ? {subItemSgnPattern: ctx.subSgnPattern} : undefined\n\t\t}, ctx, ev).onNextClose();\n\t\t//console.log('SrcPointerFastSelect', sd);\n\t\tctx.focus();\n\t\tif (sd) ctx.setSrcRef(ITEM.srcRefSub(sd), sd);\n\t}\n\n\tprotected getRestrictions(ctx: SrcPointer, ev?: Event): ISearchCrit {\n\t\tif (this.customCrit) return this.customCrit;\n\t\tconst sgnPattern = ctx.sgnPattern;\n\t\treturn sgnPattern ? new SearchItemSgnRegexp(sgnPattern.source) : null\n\t}\n\n\tprotected getSrcFilter(ctx: SrcPointer, ev?: Event): (data: JSrcFields) => boolean {\n\t\treturn null;\n\t}\n}\n\nexport class SrcPointerErase extends SrcPointerWriteAction {\n\tconstructor() {\n\t\tsuper('erase');\n\t\tthis.setLabel(\"Effacer\");\n\t\tthis.setGroup(\"ptrEdit\");\n\t}\n\n\tisVisible(ctx: SrcPointer): boolean {\n\t\tif (ctx.srcRef == null) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tasync execute(ctx: SrcPointer, ev?: Event) {\n\t\tctx.setSrcRef(null);\n\t}\n}\n\n/** Action dédié au double-click : focus l'item si défini et infoBroker présent, sinon ouvre le fastSelect pour remplacer si contexte editable. */\nexport class SrcPointerDblClick extends SrcAction<SrcPointer> {\n\n\tstatic SINGLETON = new SrcPointerDblClick();\n\n\tconstructor() {\n\t\tsuper('focusItemOrSelect');\n\t}\n\n\tisEnabled() {return true}\n\n\texecute(ctx: SrcPointer, ev?: Event) {\n\t\tconst sd = ctx.shortDescs[0];\n\t\tif (ctx.infoBroker && sd?.srcUri != null) {\n\t\t\tFocusItem.gotoItem(ctx.infoBroker, sd, ctx.emitter);\n\t\t\tev?.preventDefault();\n\t\t\tev?.stopImmediatePropagation();\n\t\t}\telse if (!(ctx.emitter as SrcPointer).readOnly) {\n\t\t\tSrcPointerFastSelect.SINGLETON.executeIfAvailable(ctx, ev);\n\t\t\tev?.preventDefault();\n\t\t\tev?.stopImmediatePropagation();\n\t\t}\n\t}\n}\n\n\nfunction addAction(action: Action<IShortDescCtx>, accel?: string, order?: number) {\n\tREG.reg.addToList(\"actions:wsp:src-pointer\", action.getId(), 1, action, order);\n\tif (accel) REG.reg.addToList(\"accelkeys:wsp:src-pointer\", accel, 1, action);\n}\n\naddAction(SrcPointerFastSelect.SINGLETON, \"F4\");\naddAction(new SrcPointerCreateItem());\naddAction(SrcPointerPaste.SINGLETON, \"v-accel\", 10);\naddAction(new SrcPointerErase, \"Delete\", 15);\n\nexport namespace SRCDRAWER {\n\n\texport function itemCodeTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`<span class=\"itemCode\"><img class=\"icon\" src=\"${itemType.getIcon(srcDrawer.config.showStatus ? fields : null)}\" draggable=\"false\"/><span class=\"code\">${fields ? ITEM.getSrcMainName(srcDrawer.reg, fields, itemType.wspMeta) : \"\"}</span></span>`;\n\t}\n\n\t/** Code seul, suppr de la class .code pour stylage normal, sans privilégier le title, etc */\n\texport function itemCodeAloneTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`<span class=\"itemCode\"><img class=\"icon\" src=\"${itemType.getIcon(srcDrawer.config.showStatus ? fields : null)}\" draggable=\"false\"/><span>${fields ? ITEM.getSrcMainName(srcDrawer.reg, fields, itemType.wspMeta) : \"\"}</span></span>`;\n\t}\n\n\texport function itemTitleTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`<span class=\"itTi\">${fields ? ITEM.getTitle(fields) : \"\"}</span>`;\n\t}\n\n\texport function itemIconTitleTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`<span class=\"itTi\"><img class=\"icon\" src=\"${itemType.getIcon(srcDrawer.config.showStatus ? fields : null)}\" draggable=\"false\"/>${fields ? ITEM.getTitle(fields) : \"\"}</span>`;\n\t}\n\n\texport function itemTitleOrCodeTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn (fields && ITEM.getTitle(fields)) ? itemIconTitleTpl(itemType, fields, srcDrawer) : itemCodeTpl(itemType, fields, srcDrawer);\n\t}\n\n\texport function itemCodeAndTitleTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`${itemCodeTpl(itemType, fields, srcDrawer)}<span class=\"itTi\">${fields ? ITEM.getSrcSecondName(srcDrawer.reg, fields, itemType.wspMeta) : null}</span>`;\n\t}\n\n\texport function itemUriTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`<span part=\"itemUri\"><img class=\"icon\" part=\"icon\" src=\"${itemType.getIcon(srcDrawer.config.showStatus ? fields : null)}\" draggable=\"false\"/><span part=\"uri\">${fields ? ITEM.extractItemUri(fields.srcUri) : \"\"}</span></span>`;\n\t}\n\n\texport function previewTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\tif (!fields || !itemType) return undefined;\n\t\tconst wsp = srcDrawer.reg.env.wsp;\n\t\tif (fields.itSubItem) {\n\t\t\tconst subTitemType = wsp.wspMetaUi.getItemType(fields.itSubItem.mo);\n\t\t\treturn subTitemType?.getPreview(wsp, fields, srcDrawer.reg, UTILS);\n\t\t}\n\t\treturn itemType.getPreview(wsp, fields, srcDrawer.reg, UTILS);\n\t}\n\n\texport function previewOrItemCodeTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn previewTpl(itemType, fields, srcDrawer) || itemCodeTpl(itemType, fields, srcDrawer);\n\t}\n\n\texport function previewOrItemTitleOrCodeTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn previewTpl(itemType, fields, srcDrawer) || itemTitleOrCodeTpl(itemType, fields, srcDrawer);\n\t}\n\n\texport function previewAndItemCodeTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`${previewTpl(itemType, fields, srcDrawer)}${itemCodeTpl(itemType, fields, srcDrawer)}`;\n\t}\n\n\texport function previewAndItemCodeAndTitleTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`${previewTpl(itemType, fields, srcDrawer)}${itemCodeTpl(itemType, fields, srcDrawer)}<span class=\"itTi\">${fields ? ITEM.getSrcSecondName(srcDrawer.reg, fields, itemType.wspMeta) : null}</span>`;\n\t}\n\n\texport function detailsTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\tif (!fields) return xhtml``;\n\t\t//let odb = srcDrawer.reg.env.wsp.backEnd === 'odb';\n\t\t//Space\n\t\tif (fields.itModel == null) return xhtml`<ul class=\"details\">\n<li><span class=\"val srcUri\" title=\"Chemin complet\">${ITEM.getItemUriLabel(fields.srcUri, fields)}</span></li>\n<li><span class=\"val itModel\">Espace</span></li>\n${srcDate(itemType, fields, srcDrawer)}\n</ul>`;\n\t\t//Item\n\t\treturn xhtml`<ul class=\"details\">\n<li><span class=\"val itTi\" title=\"Titre\">${ITEM.getTitle(fields)}</span></li>\n<li><span class=\"val itModel\" title=\"Modèle d'item\">${itemType ? itemType.getTitle(fields) : undefined}</span></li>\n${srcDate(itemType, fields, srcDrawer)}\n<li><span class=\"val srcUri\" title=\"Chemin complet\">${ITEM.getItemUriLabel(fields.srcUri, fields)}</span></li>\n</ul>`;\n\t}\n\n\texport function detailsItemIconPreviewTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\tif (!fields) return xhtml``;\n\t\t//Item\n\t\treturn xhtml`<ul class=\"details\">\n<li><span class=\"val itTi\" title=\"Titre\">${ITEM.getTitle(fields)}</span></li>\n<li><span class=\"val itModel\" title=\"Modèle d'item\"><img class=\"icon\" src=\"${itemType.getIcon(srcDrawer.config.showStatus ? fields : null)}\" draggable=\"false\"/>${itemType ? itemType.getTitle(fields) : undefined}</span></li>\n${srcDate(itemType, fields, srcDrawer)}\n<li><span class=\"val srcUri\" title=\"Chemin complet\">${ITEM.getItemUriLabel(fields.srcUri, fields)}</span></li>\n</ul>${previewTpl(itemType, fields, srcDrawer)}`;\n\t}\n\n\texport function detailsPreviewTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`${detailsTpl(itemType, fields, srcDrawer)}${previewTpl(itemType, fields, srcDrawer)}`;\n\t}\n\n\texport function srcDate(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\t//Formatage de la date + du user.\n\t\treturn !fields || !fields.srcDt ? null : xhtml`<li><span class=\"val srcDt\" title=\"Dernière modification\">\n\t\t\t${fields ? LOCALE.formatDateDigitsToSec.format(new Date(fields.srcDt)) : undefined}\n\t\t\t${fields && fields.srcUser ? xhtml`<span> par <c-userref class=\"inline\" i.=\"${{reg: srcDrawer.reg, nickOrAccount: fields.srcUser} as OUserRefInit}\"/></span>` : undefined}\n\t\t\t</span></li>`;\n\t}\n\n\texport function typesAllowedTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcPointer): TemplateResult {\n\t\tconst regexp = srcDrawer.sgnPattern;\n\t\tif (!regexp) return null;\n\t\tconst datas = itemType.wspMeta.getItemTypesTree((acc, curr) => {\n\t\t\tif (regexp.test(curr.getSgn())) acc.push(curr);\n\t\t\treturn acc;\n\t\t});\n\n\t\tfunction draw(data: IDirItemType | ItemType): TemplateResult {\n\t\t\tif (data instanceof ItemType) {\n\t\t\t\treturn xhtml`<li><img src=\"${data.getIcon()}\"/>${data.getTitle()}</li>`\n\t\t\t} else {\n\t\t\t\treturn xhtml`<li><h6>${data.label}</h6><ul>${data.children.map(draw)}</ul></li>`\n\t\t\t}\n\t\t}\n\t\tconst title = \"Types d'items autorisés\";\n\t\treturn xhtml`${srcDrawer.reg.createSkin(\"src-drawer/itemTypes\")}${SRCDRAWER.wedBarActions(itemType, fields, srcDrawer)}<div><h5>${title}</h5><ul>${datas.map(draw)}</ul></div>`;\n\t}\n\n\tREG.reg.registerSkin(\"src-drawer/itemTypes\", 1, /* language=CSS */ `\n\t  div {\n\t\t  padding: 2px;\n\t  }\n\n\t  h5, h6 {\n\t\t  font-size: 1em;\n\t\t  margin: 0;\n\t\t  padding: .2em;\n\t  }\n\n\t  h5 {\n\t\t  border-top: 1px solid var(--border-color);\n\t\t  border-bottom: 1px dotted var(--border-color);\n\t\t  font-style: italic;\n\t\t  color: var(--alt1-color);\n\t\t  text-align: center;\n\t  }\n\n\t  ul {\n\t\t  margin: 0;\n\t\t  padding: 0;\n\t  }\n\n\t  ul > li > ul {\n\t\t  padding-inline-start: 1em;\n\t  }\n\n\t  li {\n\t\t  list-style-type: none;\n\t  }\n\n\t  img {\n\t\t  vertical-align: middle;\n\t  }\n\t`);\n\n\t/** Injection des boutons de sélection et de création dans le tooltip. */\n\texport function wedBarActions(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcPointer): TemplateResult | null {\n\t\tif (isEltBoxSelection(srcDrawer)) {\n\t\t\tconst bar = srcDrawer.focusBar;\n\t\t\tif (bar) return xhtml`<c-bar-actions i.=\"${{\n\t\t\t\tactions: bar.actions.filter((a) => a.getId() === \"focusItem\" || a.getId() === \"fastSelect\" || a.getId() === \"create\"),\n\t\t\t\tactionContext: bar.actionContext\n\t\t\t} as OActionableListInit<IWedletActionCtx>}\"/>`;\n\t\t}\n\t\treturn null;\n\t}\n\n\texport function detailsOrTypesTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcPointer): TemplateResult {\n\t\tif (!fields || fields.srcUri == null) return typesAllowedTpl(itemType, fields, srcDrawer);\n\t\treturn xhtml`${SRCDRAWER.wedBarActions(itemType, fields, srcDrawer)}${SRCDRAWER.detailsTpl(itemType, fields, srcDrawer)}`;\n\t}\n\n\texport function detailsPreviewOrTypesTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcPointer): TemplateResult {\n\t\tif (!fields || fields.srcUri == null) return typesAllowedTpl(itemType, fields, srcDrawer);\n\t\treturn xhtml`${SRCDRAWER.wedBarActions(itemType, fields, srcDrawer)}${SRCDRAWER.detailsPreviewTpl(itemType, fields, srcDrawer)}`;\n\t}\n\n\t/** SrcDrawer / SrcPointer dédié à pointer un espace d'un wsp. */\n\texport function spaceTpl(this: void, itemType: ItemType, fields: JSrcFields | null, srcDrawer: SrcDrawer): TemplateResult {\n\t\treturn xhtml`<span class=\"spaceCode\"><img class=\"icon\" src=\"${itemType.wspMeta.getSpaceIcon()}\" draggable=\"false\"/><span class=\"code\">${fields ? fields.srcUri || \"Racine de l'atelier\" : \"\"}</span></span>`;\n\t}\n}\n"]}