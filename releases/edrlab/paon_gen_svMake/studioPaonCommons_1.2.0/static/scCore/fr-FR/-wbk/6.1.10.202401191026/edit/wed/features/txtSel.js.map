{"version":3,"sources":["/@back@/edit/wed/features/txtSel.ts"],"names":["BaseElement","BASIS","POPUP","PopupActions","WedEditorMiniview","TXTTABLE","InlObject","TxtCell","TxtCol","TxtElement","TxtObject","TxtRow","TxtStr","TxtTable","buildXa","buildXaInVirtual","findTxtEltFirstChild","findTxtEltLastChild","findTxtEltNextSibling","findTxtEltOrRootParent","findTxtEltParent","findTxtEltPreviousSibling","findTxtStrFirstChild","findTxtStrLastChild","findTxtStrNext","findTxtStrParent","findTxtStrPrevious","getTextFirstOffset","getTextLength","IS_TxtBlock","IS_TxtElement","IS_TxtRoot","IS_TxtStr","webRange2XaRange","WEDLET","Action","REG","DOM","ENodeType","DOMSH","XA","isXmlMsg","XmlBatch","XmlDeleteMsg","XmlInsertMsg","GFX","HistoEditPoint","IS_text","AgTxtSelEditor","cls","proto","prototype","initFromDocHolder","docHolder","config","result","call","this","wedMgr","listeners","on","hookMsgForNextSel","selectionChange","getCurrentSel","getFocus","ev","focused","txtRoot","findFlatParentElt","wedEditor","rootNode","type","onCopy","onCut","onPaste","showTxtStackBar","barLayout","hideStackBar","_txtStackBar","TxtStackBar","setHidden","showBar","eltFocus","findDeepActiveElement","refreshBar","hideTxtStackBar","onHideBar","transac","msg","getMeta","done","docHolderAsync","isMsgFromUs","selAfter","find","lastAncestorIfNone","wedletNotFoundDepth","wedlet","findWedlet","rootWedlet","addr","TxtSelMgr","MSGMETA_tblLayout","txtTable","findParent","IS_TxtTable","focusWedlet","end","focusCell","tableLayout","drawTableLayout","firstCell","findFirstChild","IS_TxtCell","findLastChild","logicTable","endWedlet","getTxtCellAt","getLogicOffset","logicRows","length","countCols","_a","histoEditPointsMgr","addEditEntry","wedAnchor","house","histoEditHolder","subPathFrom","slice","wedletEnd","subPathEnd","isUndoRedoPending","selMgrAsIs","setSelection","select","xa","depth","p","parentNode","selMgr","webUpdateDone","tailXa","incrAtDepth","concat","len","ensureSelVisible","setCaretBefore","wedParent","findWedletChild","last","focusObject","setCaretAtStart","setCaretAtEnd","_b","focusNode","focusOffset","sel","wedletWithRendering","n","parentElement","name","localName","model","renderingModel","onSelChange","buildRendering","renderingEd","_renderingEd","findPopupableParent","close","focus","lastFocus","undefined","txtElt","getXaRange","startInText","endInText","stackBar","xaRoot","isEquals","initialize","reg","setWedModel","wedModel","onViewHidden","detachDocHolder","Object","create","rootModel","cloneDocHolder","then","from","findParentOrSelf","showFloating","fixSize","initMaxHeight","posFrom","targetX","notAvailableSpace","fromX","fromY","targetY","titleBar","closeButton","resizer","[object Object]","root","_oldSel","Range","_updtFromUs","_root","_shadowRoot","findDocumentOrShadowRoot","_sel","getSelection","_lastObject","isConnected","commonAncestor","range","commonAncestorContainer","commonTxtElement","rg","parentAnc","startTxtStr","startContainer","targetReg","isXmlEndOffset","startOffset","next","cloneRange","setStart","endTxtStr","endContainer","isXmlStartOffset","endOffset","prev","setEnd","anchorNode","anchorOffset","getRangeAt","selAround","_around","inVirtual","newRangeAround","start","elt","freeze","cb","ancestor","node","nodeType","element","childNodes","item","sib","nextSibling","endNode","endChain","push","i","stop","firstChild","ensureVisible","IS_element","scrollContainer","unfreezeSel","_oldFocusIsStart","setBaseAndExtent","fixupSel","offset","collapse","collapseToStart","collapseToEnd","alter","direction","granularity","modify","text","test","nodeValue","charAt","Text","startO","memSel","removeAllRanges","findOrCreateTxtStrOrObject","startNode","getWebOffset","getXmlTextLength","first","str","to","subPathTo","setCaretIn","offs","findPreviousIn","extend","_selFixing","around","updated","parent","getFlatParentElt","oldFocus","oldFocusOffs","fixupCaret","fixupSelection","target","preventDefault","empty","TxtSelMgrFrozen","restoreSel","HTMLElement","super","id","redrawCb","_redrawCb","bind","shadowRoot","sr","attachShadow","SHADOWDOM_INIT","findReg","installSkin","ctn","appendChild","document","createElement","lastTxtRoot","hidden","lastCb","window","requestIdleCallback","deadline","entry","lastElementChild","anc","insertBefore","TxtStackEntry","setNode","previousElementSibling","registerSkin","customElements","define","onclick","onClick","onpointerdown","onPointerdown","nodeLabel","textContent","nodeName","stopImmediatePropagation","selectAround","TableLayout","table","idleCb","_idle","anchorCell","enabled","tblEditNode","ensureFocused","refreshCellSel","getBoundingClientRect","tabIndex","style","position","minWidth","padding","anchor","findNext","adjustTableLayout","show","locked","relatedTarget","isLogicalFlatAncestor","focusBar","blur","removeEventListener","onBlur","addEventListener","hide","getFirstCellSelected","closeTableLayout","force","col","IS_TxtCol","row","findNextSibling","IS_TxtRow","dir","getComputedStyle","txtTableRect","tableRect","tableLeft","left","yRows","offsetTop","clientHeight","wCols","wColTotal","w","computedStyleMap","get","value","rowW","clientWidth","xCol","width","xDelta","xCols","Math","round","wC","arrayEquals","attributeStyleMap","set","CSS","px","btn","isWritableWedlet","xPosLeft","xPosRight","xPosStart","xPosEnd","y","getBtn","st","yPos","x","buildCellSelector","checkSel","cellSelector","c1Rect","x1","x2","y1","y2","c2Rect","min","max","right","top","bottom","commonBars","commonBar","planChangeFocusBar","extendSel","scrollIntoView","behavior","block","inline","LogicTable","writeNodesToClipboard","getSelRect","clipboardData","writeNodesToClipboardAsXml","cutOrDelete","cut","data","selRect","execute","action","batch","newBatch","setMeta","startRow","startCol","endRow","endCol","deleteRows","doBatch","deleteCols","deleteSequence","allCols","actions","setLabel","popup","actionContext","headTitle","restoreFocus","detail","returnValue","getId","showNotifInfo","append","cellInsertPoint","tableEd","findHost","classList","contains","colModels","insertCols","logicalOffset","rowModels","insertRows","label","title","curr","nextElementSibling","remove","add","onClickBtn","timeRemaining","onTxtTblEdBlur","TxtTblEditor","onTblEdPointerDown","onTblEdKeyDown","_onTblEdPointerCancel","onTblEdPointerCancel","init","_initAndInstallSkin","activeElement","rect","button","toggle","cell","cellFromPoint","shiftKey","onTblEdPointerMove","createTreeWalker","NodeFilter","SHOW_ELEMENT","isPointIn","FILTER_ACCEPT","FILTER_REJECT","FILTER_SKIP","nextNode","key","moveCellSel","findPreviousSibling","offsRow","offsCol","getLogicOffsets","onTxtTableFlexPointerDown","a1","a2"],"mappings":"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","sourcesContent":["import {BaseElement, BASIS, OSkinableInit} from \"back/commons/basis\";\nimport {BarActions} from \"back/commons/widgets/bars\";\nimport {POPUP, PopupActions} from \"back/commons/widgets/popups\";\nimport {IWedEditorCommonBar, IWedFocusBarPointer} from \"back/edit/wed/features/commonBar\";\nimport {IWedEditor, IWedEditorMain, OWedEditorMainConfig, OWedManagerConfig, WedEditorMiniview, WedMgr} from \"back/edit/wed/wedEditor\";\nimport {ITxtElement, TxtRoot} from \"back/edit/wed/wedlets/txt/txt\";\nimport {TXTTABLE} from \"back/edit/wed/wedlets/txt/txtTable\";\nimport {InlObject, TxtCell, TxtCol, TxtElement, TxtObject, TxtRow, TxtStr, TxtTable} from \"back/edit/wed/wedlets/txt/txtTags\";\nimport {\n\tbuildXa,\n\tbuildXaInVirtual,\n\tfindTxtEltFirstChild,\n\tfindTxtEltLastChild,\n\tfindTxtEltNextSibling,\n\tfindTxtEltOrRootParent,\n\tfindTxtEltParent,\n\tfindTxtEltPreviousSibling,\n\tfindTxtStrFirstChild,\n\tfindTxtStrLastChild,\n\tfindTxtStrNext,\n\tfindTxtStrParent,\n\tfindTxtStrPrevious,\n\tgetTextFirstOffset,\n\tgetTextLength,\n\tIFixCaret,\n\tIFixSelection,\n\tIS_TxtBlock,\n\tIS_TxtElement,\n\tIS_TxtRoot,\n\tIS_TxtStr,\n\twebRange2XaRange\n} from \"back/edit/wed/wedlets/txt/txtUtils\";\nimport {IWedletActionCtx, WEDLET} from \"back/edit/wed/wedlets/wedlet\";\nimport {Action} from \"lib/commons/actions\";\nimport {REG} from 'lib/commons/registry';\nimport {DOM, ENodeType} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IXAddr, IXAddrRange, IXAddrRangeSel, XA} from \"lib/commons/xml/xAddr\";\nimport {IDocHolder} from \"lib/edit/docHolder\";\nimport {Msg} from \"lib/edit/ot/urban\";\nimport {isXmlMsg, XmlBatch, XmlDeleteMsg, XmlInsertMsg} from \"lib/edit/ot/xmlHouse\";\nimport {OSkTableImportContext} from \"lib/edit/schema/schemaMetaTxt\";\nimport {IPopupCloseEvent} from \"back/commons/widgets/popupable\";\nimport {IView} from \"lib/commons/views\";\nimport {GFX} from \"lib/commons/utils/gfx\";\nimport {HistoEditPoint} from \"lib/edit/histoEditPoints\";\nimport LogicTable = TXTTABLE.LogicTable;\nimport IS_text = DOM.IS_text;\n\n\nexport interface OWedEditorTxtConfig extends OWedEditorMainConfig {\n\thideStackBar?: boolean;\n}\n\nexport interface IWedEditorTxtSel extends IWedEditorMain {\n\tshowTxtStackBar(): TxtStackBar\n\n\thideTxtStackBar(): void\n\n\t_txtStackBar?: TxtStackBar\n\n\t/** Mini rendering en popup d'un fragment du contenu (preview latex...). */\n\t_renderingEd?: WedEditorMiniview;\n}\n\nexport function AgTxtSelEditor(cls: any): any {\n\tconst proto = cls.prototype as IWedEditorTxtSel;\n\tconst initFromDocHolder = proto.initFromDocHolder;\n\tproto.initFromDocHolder = function (this: IWedEditor, docHolder: IDocHolder, config?: OWedManagerConfig): Promise<boolean> {\n\t\tconst result = initFromDocHolder.call(this, docHolder, config);\n\t\tthis.wedMgr.listeners.on(\"hookMsgForNextSel\", hookMsgForNextSel);\n\t\tthis.wedMgr.listeners.on(\"selection\", selectionChange);\n\t\tthis.wedMgr.listeners.on(\"getCurrentSel\", getCurrentSel, -10);\n\t\tthis.wedMgr.listeners.on(\"getFocus\", getFocus);\n\t\tthis.wedMgr.listeners.on(\"clipboard\", function (wedMgr: WedMgr, ev: ClipboardEvent, focused: Element): void | true {\n\t\t\t//Cas où un TxtObject a le focus ou un tableLayout (si on a une sel du contentEditable, ce sont les handlers du txt-root qui sont activés).\n\t\t\tconst txtRoot = DOMSH.findFlatParentElt(focused, wedMgr.wedEditor.rootNode, IS_TxtRoot);\n\t\t\tif (txtRoot) {\n\t\t\t\tswitch (ev.type) {\n\t\t\t\tcase 'copy':\n\t\t\t\t\ttxtRoot.onCopy(ev);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'cut':\n\t\t\t\t\ttxtRoot.onCut(ev);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'paste':\n\t\t\t\t\ttxtRoot.onPaste(ev);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn result;\n\t};\n\n\tproto.showTxtStackBar = function (): TxtStackBar {\n\t\tif (!this.barLayout) return null; //Editor sans gestion de bars.\n\t\tif ((this.config as OWedEditorTxtConfig).hideStackBar) return null;\n\t\tif (!this._txtStackBar) {\n\t\t\tthis._txtStackBar = new TxtStackBar();\n\t\t} else if (!DOM.setHidden(this._txtStackBar, false)) return this._txtStackBar; //déjà affichée\n\t\t//Affichage\n\t\tif (!this.barLayout.showBar(this._txtStackBar)) return null; //injecte la barre par le layout ou informe de son (ré-affichage).\n\t\tconst eltFocus = findTxtEltOrRootParent(DOMSH.findDeepActiveElement(), true);\n\t\tthis._txtStackBar.refreshBar(this.wedMgr, eltFocus ? eltFocus.txtRoot : null);\n\t\treturn this._txtStackBar;\n\t};\n\n\tproto.hideTxtStackBar = function () {\n\t\tif (this._txtStackBar) {\n\t\t\tif (DOM.setHidden(this._txtStackBar, true)) {\n\t\t\t\tthis._txtStackBar.refreshBar(this.wedMgr); //clear\n\t\t\t\tthis.barLayout.onHideBar(this._txtStackBar); //informe le layout\n\t\t\t}\n\t\t}\n\t};\n\treturn cls;\n}\n\nfunction hookMsgForNextSel(wedMgr: WedMgr, transac: Msg, msg: Msg): void | true {\n\tif (transac.getMeta('noFocus') === true) return;\n\tlet done: void | true;\n\t//Ce msg devrait provoquer le focus.\n\tif (wedMgr.docHolderAsync.isMsgFromUs(transac)) {\n\t\t//On est à l'origine de ce msg, on prend le Focus.\n\t\tif (msg instanceof XmlBatch && msg.selAfter) {\n\t\t\t//batch avec selAfter renseigné.\n\t\t\tconst find = {lastAncestorIfNone: true, wedletNotFoundDepth: -1};\n\t\t\tconst wedlet = WEDLET.findWedlet(wedMgr.rootWedlet, msg.selAfter.addr, find);\n\t\t\tif (msg.getMeta(TxtSelMgr.MSGMETA_tblLayout)) {\n\t\t\t\tif (wedlet instanceof TxtCell) {\n\t\t\t\t\tconst txtTable = DOM.findParent(wedlet, wedMgr.wedEditor.rootNode, TXTTABLE.IS_TxtTable);\n\t\t\t\t\tconst focusWedlet = msg.selAfter.end ? WEDLET.findWedlet(wedMgr.rootWedlet, msg.selAfter.end, find) : null;\n\t\t\t\t\tconst focusCell = focusWedlet instanceof TxtCell ? focusWedlet : wedlet;\n\t\t\t\t\ttxtTable.tableLayout.drawTableLayout(focusCell, wedlet);\n\t\t\t\t} else if (wedlet instanceof TxtRow) {\n\t\t\t\t\tconst txtTable = DOM.findParent(wedlet, wedMgr.wedEditor.rootNode, TXTTABLE.IS_TxtTable);\n\t\t\t\t\tconst firstCell = DOM.findFirstChild(wedlet, TXTTABLE.IS_TxtCell);\n\t\t\t\t\tconst focusWedlet = msg.selAfter.end ? WEDLET.findWedlet(wedMgr.rootWedlet, msg.selAfter.end, find) : null;\n\t\t\t\t\tconst focusCell = focusWedlet instanceof TxtRow ? DOM.findLastChild(focusWedlet, TXTTABLE.IS_TxtCell) : DOM.findLastChild(wedlet, TXTTABLE.IS_TxtCell);\n\t\t\t\t\ttxtTable.tableLayout.drawTableLayout(focusCell, firstCell);\n\t\t\t\t} else if (wedlet instanceof TxtCol) {\n\t\t\t\t\tconst txtTable = DOM.findParent(wedlet, wedMgr.wedEditor.rootNode, TXTTABLE.IS_TxtTable);\n\t\t\t\t\tconst logicTable = txtTable.tableLayout.logicTable;\n\t\t\t\t\tlet endWedlet = msg.selAfter.end ? WEDLET.findWedlet(wedMgr.rootWedlet, msg.selAfter.end, find) : null;\n\t\t\t\t\tif (!(endWedlet instanceof TxtCol)) endWedlet = wedlet;\n\t\t\t\t\ttxtTable.tableLayout.drawTableLayout(logicTable.getTxtCellAt(0, wedlet.getLogicOffset()), logicTable.getTxtCellAt(logicTable.logicRows.length - 1, (endWedlet as TxtCol).getLogicOffset()));\n\t\t\t\t} else if (wedlet instanceof TxtTable) {\n\t\t\t\t\tconst logicTable = wedlet.tableLayout.logicTable;\n\t\t\t\t\twedlet.tableLayout.drawTableLayout(logicTable.getTxtCellAt(0, 0), logicTable.getTxtCellAt(logicTable.logicRows.length - 1, wedlet.countCols() - 1));\n\t\t\t\t}\n\t\t\t\twedMgr.config.histoEditPointsMgr?.addEditEntry(new HistoEditPoint(wedlet.wedAnchor, wedMgr.docHolder.house), null, wedMgr.config.histoEditHolder);\n\t\t\t\tdone = true;\n\t\t\t} else {\n\t\t\t\tif (IS_TxtElement(wedlet)) {\n\t\t\t\t\tdone = true;\n\t\t\t\t\tconst txtRoot = wedlet.txtRoot;\n\t\t\t\t\tconst subPathFrom = find.wedletNotFoundDepth > 0 ? msg.selAfter.addr.slice(find.wedletNotFoundDepth) : null;\n\t\t\t\t\tif (msg.selAfter.end != null) {\n\t\t\t\t\t\tlet wedletEnd: TxtElement | TxtRoot;\n\t\t\t\t\t\tlet subPathEnd: IXAddr;\n\t\t\t\t\t\tfind.wedletNotFoundDepth = -1;\n\t\t\t\t\t\tconst end = WEDLET.findWedlet(wedMgr.rootWedlet, msg.selAfter.end, find);\n\t\t\t\t\t\tif (IS_TxtElement(end) && txtRoot === end.txtRoot) {\n\t\t\t\t\t\t\twedletEnd = end;\n\t\t\t\t\t\t\tsubPathEnd = find.wedletNotFoundDepth > 0 ? msg.selAfter.end.slice(find.wedletNotFoundDepth) : null;\n\t\t\t\t\t\t} else if (end === txtRoot.wedlet) {\n\t\t\t\t\t\t\twedletEnd = txtRoot;\n\t\t\t\t\t\t\tsubPathEnd = find.wedletNotFoundDepth > 0 ? msg.selAfter.end.slice(find.wedletNotFoundDepth) : null;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// exemple: selAfter = fin d'un field TxtRootStr\n\t\t\t\t\t\t\twedletEnd = wedlet;\n\t\t\t\t\t\t\tsubPathEnd = subPathFrom;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (wedMgr.isUndoRedoPending(transac)) {\n\t\t\t\t\t\t\ttxtRoot.selMgrAsIs.setSelection(wedlet, subPathFrom, wedletEnd, subPathEnd);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\ttxtRoot.selMgrAsIs.setSelection(wedletEnd, subPathEnd);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (wedlet instanceof InlObject || wedlet instanceof TxtObject) {\n\t\t\t\t\t\ttxtRoot.selMgrAsIs.select(wedlet);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttxtRoot.selMgrAsIs.setSelection(wedlet, subPathFrom);\n\t\t\t\t\t}\n\t\t\t\t\tif (wedMgr.config.histoEditPointsMgr) {\n\t\t\t\t\t\tconst xa = wedlet.wedAnchor;\n\t\t\t\t\t\tlet depth = xa.length;\n\t\t\t\t\t\tfor (let p: Node = wedlet; p !== txtRoot; p = p.parentNode) depth--;\n\t\t\t\t\t\twedMgr.config.histoEditPointsMgr.addEditEntry(new HistoEditPoint(xa, wedMgr.docHolder.house), depth, wedMgr.config.histoEditHolder);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (isXmlMsg(msg)) {\n\t\t\tconst find = {lastAncestorIfNone: true, wedletNotFoundDepth: -1};\n\t\t\tconst wedlet = WEDLET.findWedlet(wedMgr.rootWedlet, msg.xa, find);\n\t\t\tif (IS_TxtElement(wedlet)) {\n\t\t\t\tdone = true;\n\t\t\t\tconst txtRoot = wedlet.txtRoot;\n\t\t\t\tconst selMgr = txtRoot.selMgrAsIs;\n\t\t\t\ttry {\n\t\t\t\t\tif (txtRoot.webUpdateDone) return;\n\t\t\t\t\tlet tailXa;\n\t\t\t\t\tif (find.wedletNotFoundDepth > 0) {\n\t\t\t\t\t\t//on n'a pas trouvé le XA complet du msg (suppr ou modif dans metas)\n\t\t\t\t\t\ttailXa = msg.xa.slice(find.wedletNotFoundDepth);\n\t\t\t\t\t\tif (msg instanceof XmlInsertMsg && tailXa.length === 1) {\n\t\t\t\t\t\t\t//Si insertion en fils direct du wedlet\n\t\t\t\t\t\t\t//TODO différencier le comportement si insertion des metas : tailXa[0]===0 et wedlet.hasMetas() ?\n\t\t\t\t\t\t\tif (wedMgr.isUndoRedoPending(transac)) {\n\t\t\t\t\t\t\t\t//sel de l'insertion en cas de undo/redo\n\t\t\t\t\t\t\t\tselMgr.setSelection(wedlet, tailXa, wedlet, XA.incrAtDepth(tailXa.concat(), -1, msg.len));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t//sinon on se place après l'insertion.\n\t\t\t\t\t\t\t\tselMgr.setSelection(wedlet, XA.incrAtDepth(tailXa, -1, msg.len));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tselMgr.ensureSelVisible();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tselMgr.setSelection(wedlet, tailXa);\n\t\t\t\t\t\tselMgr.ensureSelVisible();\n\t\t\t\t\t} else {\n\t\t\t\t\t\t//on a trouvé le wedlet\n\t\t\t\t\t\tif (msg instanceof XmlDeleteMsg) {\n\t\t\t\t\t\t\t//suppr=> wedlet est le frère suivant\n\t\t\t\t\t\t\tselMgr.setCaretBefore(wedlet);\n\t\t\t\t\t\t} else if (msg instanceof XmlInsertMsg && msg.len > 1) {\n\t\t\t\t\t\t\tconst end = wedlet.wedParent.findWedletChild(XA.last(msg.xa) as number + msg.len - 1) as any as TxtElement;\n\t\t\t\t\t\t\tif (wedMgr.isUndoRedoPending(transac)) {\n\t\t\t\t\t\t\t\tselMgr.setSelection(wedlet, null, end);\n\t\t\t\t\t\t\t} else if (selMgr.focusObject instanceof TxtTable) {\n\t\t\t\t\t\t\t\t//no-op, on garde le tableLayout actif.\n\t\t\t\t\t\t\t} else if (transac.getMeta(\"caretAtStart\")) {\n\t\t\t\t\t\t\t\tselMgr.setCaretAtStart(wedlet);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tselMgr.setCaretAtEnd(end);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (wedMgr.isUndoRedoPending(transac)) {\n\t\t\t\t\t\t\t\tselMgr.select(wedlet);\n\t\t\t\t\t\t\t} else if (selMgr.focusObject instanceof TxtTable) {\n\t\t\t\t\t\t\t\t//no-op, on garde le tableLayout actif.\n\t\t\t\t\t\t\t} else if (transac.getMeta(\"caretAtStart\")) {\n\t\t\t\t\t\t\t\tselMgr.setCaretAtStart(wedlet);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tselMgr.setCaretAtEnd(wedlet);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tselMgr.ensureSelVisible();\n\t\t\t\t\t}\n\t\t\t\t} finally {\n\t\t\t\t\twedMgr.config.histoEditPointsMgr?.addEditEntry(new HistoEditPoint(buildXa(selMgr.focusNode, selMgr.focusOffset), wedMgr.docHolder.house), txtRoot.wedlet.wedAnchor.length, wedMgr.config.histoEditHolder);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\t//todo montrer les modifs issues des autres houses?\n\t}\n\treturn done;\n}\n\nfunction selectionChange(wedMgr: WedMgr, sel: Selection | null): void | true {\n\tlet txtRoot: TxtRoot;\n\tlet wedletWithRendering: TxtElement | TxtCell;\n\tif (sel) {\n\t\tlet n = sel.focusNode;\n\t\tif (n && IS_text(n)) n = n.parentElement;\n\t\twhile (n) {\n\t\t\tif (IS_TxtRoot(n)) {\n\t\t\t\ttxtRoot = n;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst name = n.localName;\n\t\t\tif (name !== \"table\" && name !== \"mark\") {\n\t\t\t\tif (!IS_TxtElement(n)) break;\n\t\t\t\tif (n.model.renderingModel && !wedletWithRendering) wedletWithRendering = n;\n\t\t\t}\n\t\t\tn = n.parentElement;\n\t\t}\n\t\tif (txtRoot) {\n\t\t\ttxtRoot.selMgrAsIs.onSelChange();\n\t\t\t//StackBar\n\t\t\t(wedMgr.wedEditor as IWedEditorTxtSel)._txtStackBar?.refreshBar(wedMgr, txtRoot);\n\t\t}\n\t}\n\n\t//Rendering\n\tif (wedletWithRendering) {\n\t\tbuildRendering(txtRoot, wedletWithRendering);\n\t} else {\n\t\tconst renderingEd = (wedMgr.wedEditor as IWedEditorTxtSel)._renderingEd;\n\t\tif (renderingEd) POPUP.findPopupableParent(renderingEd).close();\n\t}\n}\n\nfunction getCurrentSel(wedMgr: WedMgr): IXAddrRangeSel | undefined {\n\tconst focus = wedMgr.lastFocus;\n\tif (!focus) return undefined;\n\tconst txtElt = findTxtEltOrRootParent(focus, true);\n\tif (!txtElt) return undefined;\n\tconst sel = txtElt.txtRoot.selMgr.getXaRange(false) as IXAddrRangeSel;\n\tif (!sel) return undefined;\n\tsel.startInText = true;\n\tsel.endInText = true;\n\treturn sel;\n}\n\nfunction getFocus(wedMgr: WedMgr, focused: HTMLElement) {\n\t//StackBar\n\tconst stackBar = (wedMgr.wedEditor as IWedEditorTxtSel)._txtStackBar;\n\tif (stackBar) {\n\t\tif (focused instanceof TxtElement) {\n\t\t\tstackBar.refreshBar(wedMgr, focused.txtRoot);\n\t\t} else {\n\t\t\tstackBar.refreshBar(wedMgr);\n\t\t}\n\t}\n\n\t//Rendering\n\tif (IS_TxtElement(focused) && focused.model.renderingModel) {\n\t\tbuildRendering(DOM.findParent(focused, null, IS_TxtRoot), focused);\n\t} else {\n\t\tconst renderingEd = (wedMgr.wedEditor as IWedEditorTxtSel)._renderingEd;\n\t\tif (renderingEd) POPUP.findPopupableParent(renderingEd).close();\n\t}\n}\n\nfunction buildRendering(txtRoot: TxtRoot, wedletWithRendering: TxtElement | TxtCell) {\n\tlet renderingEd = (txtRoot.wedMgr.wedEditor as IWedEditorTxtSel)._renderingEd;\n\tconst wedMgr = txtRoot.wedMgr;\n\tconst xaRoot = wedletWithRendering.wedAnchor;\n\tif (renderingEd) {\n\t\tif (XA.isEquals(renderingEd.wedMgr.rootWedlet.wedAnchor, xaRoot)) return;\n\t\tPOPUP.findPopupableParent(renderingEd).close(); //Autre point d'ancrage, on va ouvrir une nouvelle popup\n\t}\n\trenderingEd = (wedMgr.wedEditor as IWedEditorTxtSel)._renderingEd = new WedEditorMiniview().initialize({reg: wedMgr.reg});\n\trenderingEd.setWedModel(wedMgr.wedModel);\n\t(renderingEd as IView).onViewHidden = function () {\n\t\trenderingEd.wedMgr.detachDocHolder();\n\t\t(wedMgr.wedEditor as IWedEditorTxtSel)._renderingEd = null;\n\t};\n\tconst config = Object.create(wedMgr.config) as OWedManagerConfig;\n\tconfig.xaRoot = xaRoot;\n\tconfig.rootModel = wedletWithRendering.model.renderingModel;\n\n\trenderingEd.initFromDocHolder(wedMgr.docHolderAsync.cloneDocHolder(), config).then(() => {\n\t\tconst from = DOM.findParentOrSelf(wedletWithRendering, txtRoot, IS_TxtBlock);\n\t\tPOPUP.showFloating(renderingEd, {\n\t\t\tfixSize: false,\n\t\t\tinitMaxHeight: '10vh',\n\t\t\tposFrom: from,\n\t\t\ttargetX: 'end',\n\t\t\tnotAvailableSpace: {\n\t\t\t\tposFrom: from,\n\t\t\t\tfromX: 'end',\n\t\t\t\tnotAvailableSpace: {\n\t\t\t\t\tposFrom: from,\n\t\t\t\t\tfromY: 'bottom',\n\t\t\t\t\tnotAvailableSpace: {\n\t\t\t\t\t\tposFrom: from,\n\t\t\t\t\t\ttargetY: 'top'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}, txtRoot, {titleBar: {closeButton: {}}, resizer: {}});\n\t});\n}\n\nexport class TxtSelMgr {\n\n\t/**\n\t * Key de la meta booléenne d'un batch pour indiquer qu'on devrait afficher la table en mode \"layout\"\n\t * et que les ranges selBefore et selAfter du batch devraient être interprétés comme une sélection\n\t * rectangulaire de cellules (ou de lignes ou de colonnes).\n\t * Commence par un $ pour indiquer que cette propriété est \"stable\" (doit être copiée pour les msg undo/redo).\n\t */\n\tstatic MSGMETA_tblLayout = \"$tblLayout\";\n\n\tprotected _root: TxtRoot;\n\tprotected _shadowRoot: ShadowRoot | Document;\n\t_sel: Selection;\n\n\n\t/** TableLayout actuellment actif.  */\n\ttableLayout: TableLayout;\n\n\t/**\n\t * Mémoire du dennier objet focusé dans le content de l'éditeur.\n\t * Permet de s'affranchir de la perte de focus lié à l'activation des boutons d'actions et menus.\n\t */\n\tprotected _lastObject: HTMLElement;\n\n\t/**\n\t * Mémoire de la précédente sélection(stocké dans un range pour bénéficier\n\t * de l'ajustement automatique de l'offset en cas de modif du dom).\n\t */\n\tprotected _oldSel = new Range();\n\tprotected _oldFocusIsStart: boolean;\n\n\t/**\n\t * Mémoire que la sel courante est issue d'un selectAround() et qu'il faut considérer ce noeud\n\t * sélectionné dans son intégralité et non son contenu pour les actions de copier/couper/suppr...\n\t */\n\tprotected _around: TxtElement;\n\n\tprotected _updtFromUs: number = 0;\n\n\t// get _around() {return this.__around};\n\t//\n\t// set _around(elt: TxtElement) {\n\t// \tif (this.__around !== elt) {\n\t// \t\tconsole.trace(\"set _around:::\", this.__around, elt);\n\t// \t\tthis.__around = elt;\n\t// \t}\n\t// }\n\n\tconstructor(root: TxtRoot) {\n\t\tthis._root = root;\n\t\tthis._shadowRoot = DOMSH.findDocumentOrShadowRoot(root);\n\t\tthis._sel = this._shadowRoot.getSelection();\n\t}\n\n\tget type(): 'None' | 'Caret' | 'Range' | 'Object' {\n\t\tconst type = this._sel.type as 'None' | 'Caret' | 'Range';\n\t\treturn type === 'None' && this._lastObject != null && this._lastObject.isConnected ? 'Object' : type;\n\t}\n\n\t/** Utilisable quelquesoit le type (null si type == 'None'). */\n\tget focusNode(): HTMLElement | Text | null {return (this._sel.focusNode as HTMLElement | Text) || this._lastObject}\n\n\t/** Utilisable quelquesoit le type, mais est != null que si type == 'Object'. */\n\tget focusObject(): HTMLElement {return this._sel.focusNode !== null ? null : this._lastObject}\n\n\t/** Utilisable quelquesoit le type (null si type == 'None'). */\n\tget commonAncestor(): HTMLElement | Text | null {\n\t\tif (this._sel.type === 'Range') return this.range.commonAncestorContainer as HTMLElement | Text;\n\t\treturn this.focusNode;\n\t}\n\n\t/**\n\t * Version plus élaborée que commonAncestor qui retourne le TxtElement si la sel n'enveloppe QUE cet élement,\n\t * ie que la sel est en bordure d'un tag inline. Très pratique sur une sélection par drag en partant de l'exétrieur du §.\n\t * Utilisable quelquesoit le type (null si type == 'None').\n\t * @return null si type == 'None' ou si aucun TxtElement fils de la textPrim n'inclut la sél\n\t */\n\tget commonTxtElement(): TxtElement | null {\n\t\tif (this._sel.type !== 'Range') return findTxtEltParent(this.focusNode, true);\n\t\tconst rg = this.range;\n\t\tconst parentAnc = this.range.commonAncestorContainer as HTMLElement | Text;\n\t\tconst startTxtStr = findTxtStrParent(rg.startContainer);\n\t\tlet targetReg: Range = null;\n\t\tif (startTxtStr && parentAnc === startTxtStr.parentElement && startTxtStr.isXmlEndOffset(rg.startContainer, rg.startOffset)) {\n\t\t\tconst next = findTxtEltNextSibling(startTxtStr);\n\t\t\tif (next) {\n\t\t\t\ttargetReg = rg.cloneRange();\n\t\t\t\ttargetReg.setStart(next, 0);\n\t\t\t}\n\t\t}\n\t\tconst endTxtStr = findTxtStrParent(rg.endContainer);\n\t\tif (endTxtStr && parentAnc === endTxtStr.parentElement && endTxtStr.isXmlStartOffset(rg.endContainer, rg.endOffset)) {\n\t\t\tconst prev = findTxtEltPreviousSibling(endTxtStr);\n\t\t\tif (prev) {\n\t\t\t\tif (!targetReg) targetReg = rg.cloneRange();\n\t\t\t\ttargetReg.setEnd(prev, 0);\n\t\t\t}\n\t\t}\n\t\treturn findTxtEltParent(targetReg ? targetReg.commonAncestorContainer : parentAnc, true);\n\t}\n\n\n\t/** Utilisable si la sel est Range. */\n\tget focusOffset(): number {return this._sel.focusOffset}\n\n\t/** Utilisable si la sel est Range. */\n\tget anchorNode(): HTMLElement | Text {return this._sel.anchorNode as HTMLElement | Text}\n\n\t/** Utilisable si la sel est Range. */\n\tget anchorOffset(): number {return this._sel.anchorOffset}\n\n\t/** Utilisable si la sel est Range. */\n\tget range(): Range {return this._sel.getRangeAt(0)}\n\n\t/** Retourne non null uniquement si la dernière de sel est issu d'un selectAround(). */\n\tget selAround(): TxtElement {return this._around}\n\n\t/** Retourne un IXAddrRange de la source éditée correspondant à la sel courante.  */\n\tgetXaRange(inVirtual?: boolean): IXAddrRange | null {\n\t\tswitch (this.type) {\n\t\tcase 'Range':\n\t\t\tif (this._around) return XA.newRangeAround(this._around.wedAnchor);\n\t\t\treturn webRange2XaRange(this.range);\n\t\tcase 'Caret':\n\t\t\treturn {start: inVirtual ? buildXaInVirtual(this.focusNode, this.focusOffset) : buildXa(this.focusNode, this.focusOffset)};\n\t\tcase 'Object':\n\t\t\tconst elt = findTxtEltParent(this._lastObject, true);\n\t\t\treturn elt ? XA.newRangeAround(elt.wedAnchor) : null;\n\t\t}\n\t\treturn null;\n\t}\n\n\t/** Retourne un IXAddrRange dont les extrémitrés sont dans les blocs (donc range de la sel, pas de _around).  */\n\tgetXaRangeInBlock(inVirtual?: boolean): IXAddrRange {\n\t\tswitch (this.type) {\n\t\tcase 'Range':\n\t\t\treturn webRange2XaRange(this.range);\n\t\tcase 'Caret':\n\t\t\treturn {start: inVirtual ? buildXaInVirtual(this.focusNode, this.focusOffset) : buildXa(this.focusNode, this.focusOffset)};\n\t\tcase 'Object':\n\t\t\tconst elt = findTxtEltParent(this._lastObject, true);\n\t\t\tif (!elt) return null;\n\t\t\tconst xa = XA.freeze(elt.wedAnchor);\n\t\t\treturn {start: xa, end: XA.incrAtDepth(xa, -1, 1)};\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Parcours dans l'ordre naturel des noeuds tous les noeuds intégralement contenus dans la sélection.\n\t * Attention : pour le 1er et le dernier noeud, si c'est un noeud texte, il est retourné même si tout le texte n'est pas sélectionné.\n\t * Deux noeuds ancêtres l'un de l'autre ne sont jamais retournés, c'est toujours le noeud le plus 'haut' intégralement inclus\n\t * dans la sel qui est retourné.\n\t */\n\titerateNodesInSel(cb: (node: Node) => void) {\n\t\tif (this._around) {\n\t\t\tcb(this._around);\n\t\t\treturn;\n\t\t}\n\t\tconst range = this.range;\n\t\tconst ancestor = range.commonAncestorContainer;\n\t\tlet node = range.startContainer;\n\t\tif (node.nodeType === ENodeType.element) node = node.childNodes.item(range.startOffset) || node;\n\t\tcb(node);\n\t\tif (node === ancestor) return;\n\t\twhile (node.parentNode !== ancestor) {\n\t\t\tlet sib = node.nextSibling;\n\t\t\twhile (sib) {\n\t\t\t\tcb(sib);\n\t\t\t\tsib = sib.nextSibling;\n\t\t\t}\n\t\t\tnode = node.parentNode;\n\t\t}\n\t\t//à ce stade : node.parentNode === ancestor\n\t\tlet endNode = range.endContainer;\n\t\tif (endNode.nodeType === ENodeType.element) endNode = endNode.childNodes.item(range.endOffset) || endNode;\n\t\tlet endChain;\n\t\twhile (endNode.parentNode !== ancestor) {\n\t\t\tif (!endChain) endChain = [endNode];\n\t\t\telse endChain.push(endNode);\n\t\t\tendNode = endNode.parentNode;\n\t\t}\n\t\t//à ce stade : endNode.parentNode === ancestor\n\t\tnode = node.nextSibling;\n\t\twhile (node !== endNode) {\n\t\t\tcb(node);\n\t\t\tnode = node.nextSibling;\n\t\t}\n\t\tif (endChain) {\n\t\t\tfor (let i = endChain.length - 1; i >= 0; i--) {\n\t\t\t\tconst stop = endChain[i];\n\t\t\t\tlet sib = stop.parentNode.firstChild;\n\t\t\t\twhile (sib !== stop) {\n\t\t\t\t\tcb(sib);\n\t\t\t\t\tsib = sib.nextSibling;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcb(endChain ? endChain[0] : endNode);\n\t}\n\n\tensureSelVisible() {\n\t\tconst node = this.focusNode;\n\t\tif (node) BASIS.ensureVisible(DOM.findParentOrSelf(node, null, DOM.IS_element) as HTMLElement, this._root.wedMgr.wedEditor.scrollContainer, \"nearest\");\n\t}\n\n\t/** A appeler par les actions et affichages de menus pour restaurer la sélection initiale. */\n\trestoreSel(): TxtSelMgr {\n\t\tthis._root.unfreezeSel();\n\t\t//on a la mémoire d'un dernier focus et pas de sel courante.\n\t\tif (this._lastObject != null && !this._sel.focusNode) this._lastObject.focus();\n\t\telse {\n\t\t\tthis._root.focus();\n\t\t\tif (this._oldSel.startContainer) {\n\t\t\t\tif (this._oldFocusIsStart) {\n\t\t\t\t\tthis._sel.setBaseAndExtent(this._oldSel.endContainer, this._oldSel.endOffset, this._oldSel.startContainer, this._oldSel.startOffset);\n\t\t\t\t} else {\n\t\t\t\t\tthis._sel.setBaseAndExtent(this._oldSel.startContainer, this._oldSel.startOffset, this._oldSel.endContainer, this._oldSel.endOffset);\n\t\t\t\t}\n\t\t\t\tthis.fixupSel(); //le _oldSel est parfois mém\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n\n\tcollapse(parentNode: Node, offset: number) {\n\t\tthis._updtFromUs++;\n\t\tthis._sel.collapse(parentNode, offset);\n\t\tthis.fixupSel();\n\t}\n\n\tcollapseToStart() {\n\t\tthis._updtFromUs++;\n\t\tif (this._sel.focusNode) this._sel.collapseToStart();\n\t\tthis.fixupSel(); //si la sel est hors des noeuds textes (ctrl+A)...\n\t}\n\n\tcollapseToEnd() {\n\t\tthis._updtFromUs++;\n\t\tif (this._sel.focusNode) this._sel.collapseToEnd();\n\t\tthis.fixupSel(); //si la sel est hors des noeuds textes (ctrl+A)...\n\t}\n\n\tmodify(alter: 'move' | 'extend', direction: 'forward' | 'backward', granularity: 'character' | 'word') {\n\t\tthis._updtFromUs++;\n\t\t//FIXME non standard (impl firefox & chrome) mais permet de gérer les caracères codePoints...\n\t\t(this._sel as any).modify(alter, direction, granularity);\n\t}\n\n\ttrim() {\n\t\tif (this._sel.type === 'Range') {\n\t\t\tthis.fixupSel();\n\t\t\tconst rg = this.range;\n\t\t\tconst start = rg.startContainer;\n\t\t\tlet startOffset = rg.startOffset;\n\t\t\tconst end = rg.endContainer;\n\t\t\tlet endOffset = rg.endOffset;\n\t\t\tif (start === end) {\n\t\t\t\tif (start.nodeType === ENodeType.text) {\n\t\t\t\t\twhile (startOffset < endOffset && /\\s/.test(start.nodeValue.charAt(startOffset))) startOffset++;\n\t\t\t\t\twhile (startOffset < endOffset && /\\s/.test(end.nodeValue.charAt(endOffset - 1))) endOffset--;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (start instanceof Text) {\n\t\t\t\t\tconst len = getTextLength(start);\n\t\t\t\t\twhile (startOffset < len && /\\s/.test(start.nodeValue.charAt(startOffset))) startOffset++;\n\t\t\t\t}\n\t\t\t\tif (end instanceof Text) {\n\t\t\t\t\tconst startO = getTextFirstOffset(end);\n\t\t\t\t\twhile (endOffset > startO && /\\s/.test(end.nodeValue.charAt(endOffset - 1))) endOffset--;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (startOffset !== rg.startOffset || endOffset !== rg.endOffset) {\n\t\t\t\tif (start === this._sel.focusNode && rg.startOffset === this._sel.focusOffset) {\n\t\t\t\t\tthis._sel.setBaseAndExtent(end, endOffset, start, startOffset);\n\t\t\t\t} else {\n\t\t\t\t\tthis._sel.setBaseAndExtent(start, startOffset, end, endOffset);\n\t\t\t\t}\n\t\t\t\tthis.memSel(this.range);\n\t\t\t}\n\t\t}\n\t}\n\n\tresetSel() {\n\t\tthis._sel.removeAllRanges();\n\t}\n\n\tselect(elt: TxtElement) {\n\t\tthis._updtFromUs++;\n\t\tlet start = elt.findOrCreateTxtStrOrObject(false);\n\t\tlet end = elt.findOrCreateTxtStrOrObject(true);\n\t\tif (start === end) {\n\t\t\tif (start instanceof TxtStr) {\n\t\t\t\tconst [startNode, startOffset] = start.getWebOffset(0);\n\t\t\t\tconst [endNode, endOffset] = start.getWebOffset(start.getXmlTextLength());\n\t\t\t\tthis._sel.setBaseAndExtent(startNode, startOffset, endNode, endOffset);\n\t\t\t} else {\n\t\t\t\tstart.focus(); // sel d'objet.\n\t\t\t}\n\t\t} else {\n\t\t\tif (!(start instanceof TxtStr)) start = findTxtStrPrevious(elt);\n\t\t\tif (!(end instanceof TxtStr)) end = findTxtStrNext(elt);\n\t\t\tconst [startNode, startOffset] = (start as TxtStr).getWebOffset(0);\n\t\t\tconst [endNode, endOffset] = (end as TxtStr).getWebOffset((end as TxtStr).getXmlTextLength());\n\t\t\tthis._sel.setBaseAndExtent(startNode, startOffset, endNode, endOffset);\n\t\t}\n\t}\n\n\tselectAround(elt: TxtElement) {\n\t\tthis.select(elt);\n\t\tthis._around = elt;\n\t}\n\n\tselectAll() {\n\t\tthis._updtFromUs++;\n\t\tconst start = findTxtStrFirstChild(this._root);\n\t\tconst end = findTxtStrLastChild(this._root);\n\t\tconst [startNode, startOffset] = (start as TxtStr).getWebOffset(0);\n\t\tconst [endNode, endOffset] = (end as TxtStr).getWebOffset((end as TxtStr).getXmlTextLength());\n\t\tthis._sel.setBaseAndExtent(startNode, startOffset, endNode, endOffset);\n\t}\n\n\tsetCaretAtEnd(elt: TxtElement) {\n\t\tthis._updtFromUs++;\n\t\tlet end = elt.findOrCreateTxtStrOrObject(true);\n\t\tif (!(end instanceof TxtStr)) end = findTxtStrNext(elt);\n\t\tconst [endNode, endOffset] = (end as TxtStr).getWebOffset((end as TxtStr).getXmlTextLength());\n\t\tthis._sel.collapse(endNode, endOffset);\n\t}\n\n\tsetCaretAtStart(elt: TxtElement) {\n\t\tthis._updtFromUs++;\n\t\tconst first = elt instanceof TxtStr ? elt : findTxtStrNext(elt);\n\t\tif (!first) return;\n\t\tconst [endNode, endOffset] = first.getWebOffset(0);\n\t\tthis._sel.collapse(endNode, endOffset);\n\t}\n\n\tsetCaretBefore(elt: TxtElement) {\n\t\tthis._updtFromUs++;\n\t\tconst str = findTxtStrPrevious(elt);\n\t\tif (str) {\n\t\t\tconst [startNode, startOffset] = str.getWebOffset(str.getXmlTextLength());\n\t\t\tthis._sel.collapse(startNode, startOffset);\n\t\t} else {\n\t\t\tthis.setCaretAtStart(elt);\n\t\t}\n\t}\n\n\n\tsetSelection(from: ITxtElement, subPathFrom?: IXAddr, to?: ITxtElement, subPathTo?: IXAddr) {\n\t\tthis._updtFromUs++;\n\t\t//console.log(\"setSelection::::\", from, subPathFrom, to, subPathTo);\n\t\tif (!to) {\n\t\t\t//caret\n\t\t\tif (subPathFrom != null) {\n\t\t\t\tif (from instanceof TxtStr) {\n\t\t\t\t\tconst [node, offset] = from.getWebOffset(subPathFrom[0] as number);\n\t\t\t\t\tthis.collapse(node, offset);\n\t\t\t\t\treturn;\n\t\t\t\t} else {\n\t\t\t\t\t//édition dans des metas ou point après le dernier élément, donc sel par la fin.\n\t\t\t\t\tif (IS_TxtElement(from)) from.setCaretIn(this, false);\n\t\t\t\t\telse {\n\t\t\t\t\t\t//on est sur txtRoot.\n\t\t\t\t\t\tconst last = findTxtEltLastChild(from);\n\t\t\t\t\t\tif (last) last.setCaretIn(this, false);\n\t\t\t\t\t\telse from.focus();\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (IS_TxtElement(from)) from.setCaretIn(this, true);\n\t\t\telse if (from) from.focus(); //on est sur TxtRoot.\n\t\t} else {\n\t\t\t//sélection\n\t\t\tlet startNode = from as Node;\n\t\t\tlet startOffset = 0;\n\t\t\tlet endNode = to as Node;\n\t\t\tlet endOffset = 0;\n\t\t\tif (subPathFrom != null) {\n\t\t\t\tconst offs = subPathFrom[0];\n\t\t\t\tif (typeof offs === 'number') {\n\t\t\t\t\tif (from instanceof TxtStr) {\n\t\t\t\t\t\t[startNode, startOffset] = from.getWebOffset(offs);\n\t\t\t\t\t} else if (offs > 0) {\n\t\t\t\t\t\t//start après le denier fils\n\t\t\t\t\t\tconst str = DOM.findPreviousIn(from, IS_TxtStr) || findTxtStrPrevious(from);\n\t\t\t\t\t\t[startNode, startOffset] = str.getWebOffset(str.getXmlTextLength());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (subPathTo != null) {\n\t\t\t\tconst offs = subPathTo[0];\n\t\t\t\tif (typeof offs === 'number') {\n\t\t\t\t\tif (to instanceof TxtStr) {\n\t\t\t\t\t\t[endNode, endOffset] = to.getWebOffset(offs);\n\t\t\t\t\t} else if (offs > 0) {\n\t\t\t\t\t\t//end après le denier fils\n\t\t\t\t\t\tconst str = DOM.findPreviousIn(to, IS_TxtStr) || findTxtStrNext(to);\n\t\t\t\t\t\t[endNode, endOffset] = str.getWebOffset(str.getXmlTextLength());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._sel.setBaseAndExtent(startNode, startOffset, endNode, endOffset);\n\t\t\tthis.fixupSel();\n\t\t}\n\t}\n\n\tsetSelFocus(focusNode: Text, offset: number) {\n\t\tthis._updtFromUs++;\n\t\tif (this._sel.anchorNode) this._sel.extend(focusNode, offset);\n\t\telse this._sel.setBaseAndExtent(focusNode, offset, focusNode, offset);\n\t}\n\n\tsetSelAnchor(anchorNode: Text, offset: number) {\n\t\tthis._updtFromUs++;\n\t\tthis._sel.setBaseAndExtent(anchorNode, offset, this._sel.focusNode, this._sel.focusOffset);\n\t}\n\n\tsetSelCaret(node: Text, anchorOffset: number) {\n\t\tthis._updtFromUs++;\n\t\tthis._sel.setBaseAndExtent(node, anchorOffset, node, anchorOffset);\n\t}\n\n\tsetSelBounds(anchorNode: Text, anchorOffset: number, focusNode: Text, focusOffset: number) {\n\t\tthis._updtFromUs++;\n\t\tthis._sel.setBaseAndExtent(anchorNode, anchorOffset, focusNode, focusOffset);\n\t}\n\n\tprotected _selFixing: boolean;\n\n\tfixupSel(): boolean {\n\t\tif (this._selFixing) return false;\n\t\tthis._selFixing = true;\n\t\ttry {\n\t\t\tconst focusNode = this._sel.focusNode;\n\t\t\tif (!focusNode) return;\n\t\t\tconst around = this._around;\n\t\t\tconst anchorNode = this._sel.anchorNode;\n\t\t\t//console.log(\"Before fixupSel::\", this._sel.type, this._sel.focusNode, this._sel.focusOffset, this._sel.anchorNode, this._sel.anchorOffset);\n\t\t\tlet updated = false;\n\t\t\tconst parent = DOMSH.getFlatParentElt(this._root);\n\t\t\tconst oldFocus = this._oldFocusIsStart ? this._oldSel.startContainer : this._oldSel.endContainer;\n\t\t\tconst oldFocusOffs = this._oldFocusIsStart ? this._oldSel.startOffset : this._oldSel.endOffset;\n\t\t\tif (focusNode === anchorNode) {\n\t\t\t\t//console.log(\"selcollpased!!!\", sel.anchorNode, sel.anchorOffset, sel.focusNode, sel.focusOffset);\n\t\t\t\tif (this._sel.anchorOffset === this._sel.focusOffset) {\n\t\t\t\t\tDOMSH.findFlatParentElt(focusNode, parent, (n): n is Element => {\n\t\t\t\t\t\tif (\"fixupCaret\" in n) {\n\t\t\t\t\t\t\tupdated = (n as IFixCaret).fixupCaret(this, oldFocus, oldFocusOffs);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tDOMSH.findFlatParentElt(focusNode, parent, (n): n is Element => {\n\t\t\t\t\t\tif (\"fixupSelection\" in n) {\n\t\t\t\t\t\t\tupdated = (n as IFixSelection).fixupSelection(this, 3, oldFocus, oldFocusOffs) || updated;\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tDOMSH.findFlatParentElt(focusNode, parent, (n): n is Element => {\n\t\t\t\t\tif (\"fixupSelection\" in n) {\n\t\t\t\t\t\tupdated = (n as IFixSelection).fixupSelection(this, 2, oldFocus, oldFocusOffs) || updated;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tDOMSH.findFlatParentElt(anchorNode, parent, (n): n is Element => {\n\t\t\t\t\tif (\"fixupSelection\" in n) {\n\t\t\t\t\t\tupdated = (n as IFixSelection).fixupSelection(this, 1, oldFocus, oldFocusOffs) || updated;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis._around = around;\n\t\t\t//console.log(\"After fixupSel::\", this._sel.type, this._sel.focusNode, this._sel.focusOffset, this._sel.anchorNode, this._sel.anchorOffset);\n\t\t\treturn updated;\n\t\t} finally {\n\t\t\tthis._selFixing = false;\n\t\t}\n\t}\n\n\t//protected _selFixed = false; optimisation abandonnée car cas rares de sel non fixed à l'exécution d'actions.\n\n\tonSelChange() {\n\t\tif (this._updtFromUs > 0) {\n\t\t\tthis._updtFromUs--;\n\t\t} else {\n\t\t\tthis._around = null;\n\t\t}\n\t\tif (this._sel.focusNode) {\n\t\t\tconst rg = this._sel.getRangeAt(0);\n\t\t\tthis.memSel(rg);\n\t\t\tthis.ensureSelVisible();\n\t\t}\n\t\t//console.log(\"onSelChangeTxtSel::\", this._sel.type, this._sel.focusNode, this._sel.focusOffset, this._sel.anchorNode, this._sel.anchorOffset);\n\t}\n\n\tprotected memSel(rg: Range) {\n\t\tthis._oldSel.setStart(rg.startContainer, rg.startOffset);\n\t\tthis._oldSel.setEnd(rg.endContainer, rg.endOffset);\n\t\tthis._oldFocusIsStart = this._sel.focusNode === rg.startContainer && this._sel.focusOffset === rg.startOffset;\n\t}\n\n\tonFocus(ev: FocusEvent) {\n\t\tif (ev.target === this._root) {\n\t\t\tthis._lastObject = null;\n\t\t\tif (this.type === 'None') {\n\t\t\t\t//pas de sel actuellement, on se place au début\n\t\t\t\tthis.setCaretAtStart(findTxtEltFirstChild(this._root));\n\t\t\t\tev.preventDefault();\n\t\t\t}\n\t\t} else {\n\t\t\tthis._lastObject = ev.target as HTMLElement;\n\t\t\t//if (this._lastObject.tabIndex >= 0) {\n\t\t\t//on est un Object\n\t\t\tthis._sel.empty();\n\t\t\t//}\n\t\t}\n\t}\n\n\tonBlur(ev: FocusEvent) {\n\t}\n}\n\n/**\n * Cache pour le redraw des actions.\n * Met en cache des données pour éviter des recalculs internes et du layout de la page lors du redraw de chaque action.\n * En particulier l'état de la selection doit être cachée pouré viter le relayout.\n */\nexport class TxtSelMgrFrozen {\n\ttype: 'None' | 'Caret' | 'Range' | 'Object';\n\trange: Range;\n\tfocusNode: HTMLElement | Text;\n\tanchorNode: HTMLElement | Text;\n\tcommonAncestor: HTMLElement | Text;\n\ttableLayout: TableLayout;\n\tselMgr: TxtSelMgr;\n\n\tconstructor(selMgr: TxtSelMgr) {\n\t\tthis.selMgr = selMgr;\n\t\tthis.type = selMgr.type;\n\t\tthis.focusNode = selMgr.focusNode;\n\t\tthis.anchorNode = selMgr.anchorNode;\n\t\tthis.commonAncestor = selMgr.commonAncestor;\n\t\tthis.range = this.type === 'Range' ? selMgr.range : null;\n\t\tthis.tableLayout = selMgr.tableLayout;\n\t}\n\n\trestoreSel(): TxtSelMgr {\n\t\treturn this.selMgr.restoreSel();\n\t}\n}\n\n/**\n * On fake l'implémentation de TxtSelMgr : si une méthode de TxtSelMgr est appelée\n * pendant un cycle de refresh, on aura une exception.\n */\nexport interface TxtSelMgrFrozen extends TxtSelMgr {}\n\n/**\n *\n */\nclass TxtStackBar extends HTMLElement {\n\n\tctn: HTMLElement;\n\n\tprotected lastTxtRoot: TxtRoot;\n\tprotected lastCb: number;\n\tprotected redrawCb: (deadline: RequestIdleDeadline) => void;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.id = \"txtStackBar\";\n\t\tthis.redrawCb = this._redrawCb.bind(this);\n\t}\n\n\tconnectedCallback() {\n\t\tif (!this.shadowRoot) {\n\t\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\t\tconst reg = REG.findReg(this);\n\t\t\treg.installSkin(\"txt-stackbar\", sr);\n\t\t\tthis.ctn = sr.appendChild(document.createElement(\"div\"));\n\t\t}\n\t}\n\n\trefreshBar(wedMgr: WedMgr, txtRoot?: TxtRoot) {\n\t\tif (txtRoot === undefined && this.lastTxtRoot === undefined) return;\n\t\tif (this.hidden) return;\n\t\tthis.lastTxtRoot = txtRoot;\n\t\tif (!this.lastCb) this.lastCb = window.requestIdleCallback(this.redrawCb);\n\t}\n\n\t_redrawCb(deadline: RequestIdleDeadline) {\n\t\tthis.lastCb = 0;\n\t\tif (!this.isConnected) return;\n\t\tlet entry = this.ctn.lastElementChild as TxtStackEntry;\n\t\tif (this.lastTxtRoot) {\n\t\t\tlet anc = findTxtEltParent(this.lastTxtRoot.selMgrAsIs.commonAncestor, true);\n\t\t\tif (anc instanceof TxtStr) anc = findTxtEltParent(anc);\n\t\t\twhile (anc) {\n\t\t\t\tif (!entry) entry = this.ctn.insertBefore(new TxtStackEntry(), this.ctn.firstChild);\n\t\t\t\tentry.setNode(anc);\n\t\t\t\tanc = findTxtEltParent(anc);\n\t\t\t\tentry = entry.previousElementSibling as TxtStackEntry;\n\t\t\t}\n\t\t}\n\t\twhile (entry) {\n\t\t\tentry.setNode(null);\n\t\t\tentry = entry.previousElementSibling as TxtStackEntry;\n\t\t}\n\t}\n\n}\n\nREG.reg.registerSkin(\"txt-stackbar\", 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: 1.5em;\n\t\tmin-width: 0;\n\t\tbackground-color: var(--bgcolor);\n\t\tfont-size: var(--label-size);\n\t\tuser-select: none;\n\t}\n\n\ttxt-stackentry {\n\t\tcursor: pointer;\n\t\tcolor: var(--fade-color);\n\t}\n`);\ncustomElements.define(\"txt-stackbar\", TxtStackBar);\n\n\nclass TxtStackEntry extends HTMLElement {\n\n\ttxtElt: TxtElement;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.onclick = this.onClick;\n\t\tthis.onpointerdown = this.onPointerdown;\n\t}\n\n\tsetNode(elt: TxtElement) {\n\t\tif (this.txtElt === elt) return;\n\t\tthis.txtElt = elt;\n\t\tif (!elt || !elt.model.nodeLabel || elt instanceof TxtRow || elt instanceof TxtCell) {\n\t\t\tDOM.setHidden(this, true);\n\t\t} else {\n\t\t\tDOM.setHidden(this, false);\n\t\t\tthis.textContent = \" > \" + (elt.model.nodeLabel || elt.model.nodeName);\n\t\t}\n\t}\n\n\tonClick(ev: MouseEvent) {\n\t\tev.preventDefault();\n\t\tev.stopImmediatePropagation();\n\t\tif (!this.txtElt || !this.txtElt.isConnected) return;\n\t\tthis.txtElt.txtRoot.selMgr.selectAround(this.txtElt);\n\t}\n\n\tonPointerdown(ev: MouseEvent) {\n\t\tev.preventDefault();\n\t\tev.stopImmediatePropagation();\n\t}\n}\n\ncustomElements.define(\"txt-stackentry\", TxtStackEntry);\n\n//************************** Table *********************\nexport class TableLayout {\n\ttxtTable: TxtTable;\n\n\tenabled: boolean;\n\tlocked: boolean;\n\n\tanchorCell: TxtCell;\n\tfocusCell: TxtCell;\n\n\ttblEditNode: TxtTblEditor;\n\n\tcellSelector: HTMLSpanElement;\n\n\tyRows: number[];\n\txCols: number[];\n\n\tprotected idleCb: (deadline: RequestIdleDeadline) => void;\n\n\tconstructor(table: TxtTable) {\n\t\tthis.txtTable = table;\n\t\tthis.idleCb = this._idle.bind(this);\n\t}\n\n\tdrawTableLayout(focusCell?: TxtCell, anchorCell?: TxtCell) {\n\t\tif (this.enabled) {\n\t\t\tthis.tblEditNode.ensureFocused();\n\t\t\tif (focusCell) {\n\t\t\t\tthis.focusCell = focusCell;\n\t\t\t\tthis.anchorCell = anchorCell || focusCell;\n\t\t\t\tthis.refreshCellSel(this.txtTable.getBoundingClientRect());\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tthis.enabled = true;\n\t\tif (!this.tblEditNode) {\n\t\t\tthis.tblEditNode = document.createElement(\"txt-tbl-editor\") as TxtTblEditor;\n\t\t\tthis.tblEditNode.tabIndex = 0;\n\t\t\tthis.tblEditNode.tableLayout = this;\n\t\t\tthis.txtTable.style.position = \"relative\";\n\t\t\tthis.txtTable.shadowRoot.appendChild(this.tblEditNode);\n\t\t}\n\t\tthis.txtTable.table.style.minWidth = \"max-content\";\n\t\tthis.txtTable.style.padding = \"0 1em\";\n\t\tconst txtRoot = this.txtTable.txtRoot;\n\t\tlet focus = focusCell || DOM.findParent(txtRoot.selMgr.focusNode, txtRoot, TXTTABLE.IS_TxtCell);\n\t\tif (focus && focus.parentNode.parentNode.parentNode !== this.txtTable) focus = null;\n\t\tlet anchor = focusCell ? anchorCell : txtRoot.selMgr.type === 'Range' ? DOM.findParent(txtRoot.selMgr.anchorNode, txtRoot, TXTTABLE.IS_TxtCell) : null;\n\t\tif (anchor && anchor.parentNode.parentNode.parentNode !== this.txtTable) anchor = null;\n\t\tif (!focus && !anchor) focus = DOM.findNext(this.txtTable, this.txtTable, TXTTABLE.IS_TxtCell);\n\t\tthis.focusCell = focus || anchor;\n\t\tthis.anchorCell = anchor || focus;\n\t\tthis.adjustTableLayout(true);\n\t\tthis.txtTable.txtRoot.selMgrAsIs.tableLayout = this;\n\t\tthis.tblEditNode.show();\n\t\twindow.requestIdleCallback(this.idleCb);\n\n\t}\n\n\t/** */\n\tonBlur(ev: FocusEvent) {\n\t\tif (!this.enabled || this.locked) return;\n\n\t\tif (ev.relatedTarget && DOMSH.isLogicalFlatAncestor(this.txtTable.focusBar, ev.relatedTarget as Node)) {\n\t\t\t//Focus sur une action de notre tableLayout\n\t\t\t//on ne masque pas, on reporte la fermeture du tableLayout sur le blur de cette action.\n\t\t\tconst blur = (ev: FocusEvent) => {\n\t\t\t\tev.target.removeEventListener('blur', blur);\n\t\t\t\tthis.onBlur(ev);\n\t\t\t};\n\t\t\tev.relatedTarget.addEventListener('blur', blur);\n\t\t\treturn;\n\t\t}\n\t\tthis.txtTable.txtRoot.selMgrAsIs.tableLayout = null;\n\t\tthis.enabled = false;\n\t\tthis.txtTable.table.style.minWidth = null;\n\t\tthis.txtTable.style.padding = null;\n\t\t// if (DOMSH.findDocumentOrShadowRoot(this.tblEditNode).activeElement === this.tblEditNode) {\n\t\t// \tthis.txtTable.txtRoot.focus();\n\t\t// }\n\t\tthis.tblEditNode.hide();\n\t}\n\n\tcloseTableLayout() {\n\t\t//if (!this.enabled) return; NON : avec le btn en toolbar, le blur a déjà eu lieu, donc déjà disabled.\n\t\tthis.txtTable.txtRoot.selMgr.select(this.getFirstCellSelected() as any as TxtElement);\n\t}\n\n\ttoggle() {\n\t\tif (this.enabled) {\n\t\t\tthis.closeTableLayout();\n\t\t} else {\n\t\t\tthis.drawTableLayout();\n\t\t}\n\t}\n\n\t/** Réévalue/repositionne ce tableLayout en état actif. */\n\tadjustTableLayout(force?: boolean) {\n\t\tif (!this.enabled) return;\n\t\tlet col = DOM.findFirstChild(this.txtTable.table, TXTTABLE.IS_TxtCol);\n\t\tif (!col) return;\n\t\tlet row = DOM.findNextSibling(col, TXTTABLE.IS_TxtRow);\n\t\tif (!row) return;\n\n\t\tconst dir = window.getComputedStyle(this.txtTable).direction as \"ltr\" | \"rtl\" || 'ltr';\n\t\tconst txtTableRect = this.txtTable.getBoundingClientRect();\n\t\tconst tableRect = this.txtTable.table.getBoundingClientRect();\n\t\tconst tableLeft = tableRect.left - txtTableRect.left;\n\t\tconst yRows: number[] = [];\n\t\twhile (row) {\n\t\t\tyRows.push(row.offsetTop);\n\t\t\trow = DOM.findNextSibling(row, TXTTABLE.IS_TxtRow);\n\t\t}\n\t\trow = DOM.findLastChild(this.txtTable.table, TXTTABLE.IS_TxtRow);\n\t\tyRows.push(row.offsetTop + row.clientHeight);\n\n\t\tconst wCols: number[] = [];\n\t\tlet wColTotal = 0;\n\t\twhile (col) {\n\t\t\tconst w = (col as any /*XXX CSStypedOM */).computedStyleMap().get('width').value as number; //XXX computedStyleMap couteux\n\t\t\twColTotal += w;\n\t\t\twCols.push(w);\n\t\t\tcol = DOM.findNextSibling(col, TXTTABLE.IS_TxtCol);\n\t\t}\n\n\t\tconst rowW = this.txtTable.table.clientWidth;\n\t\tlet xCol = dir === \"ltr\" ? tableLeft + (tableRect.width - rowW) / 2 : tableLeft + rowW - (tableRect.width - rowW) / 2;\n\t\tconst xDelta = (rowW - wColTotal) / wCols.length;\n\t\tconst xCols: number[] = [Math.round(xCol)];\n\t\tif (dir === \"ltr\") {\n\t\t\tfor (const wC of wCols) {\n\t\t\t\txCol += wC + xDelta;\n\t\t\t\txCols.push(Math.round(xCol));\n\t\t\t}\n\t\t} else {\n\t\t\tfor (const wC of wCols) {\n\t\t\t\txCol -= wC + xDelta;\n\t\t\t\txCols.push(Math.round(xCol));\n\t\t\t}\n\t\t}\n\n\t\t//diffs yRows et xCols avec les précedents, si égal, on sort.\n\t\tif (!force && this.yRows && arrayEquals(this.yRows, yRows) && arrayEquals(this.xCols, xCols)) return;\n\t\tthis.yRows = yRows;\n\t\tthis.xCols = xCols;\n\n\t\t//Etend la zone de fond au delà du 100% du container si nécessaire\n\t\t(this.tblEditNode as any /*XXX CSStypedOM */).attributeStyleMap.set('width', (CSS as any /*XXX CSStypedOM */).px(tableRect.width + (tableRect.left - txtTableRect.left) * 2));\n\n\t\tlet btn;\n\t\tif (WEDLET.isWritableWedlet(this.txtTable)) {\n\t\t\tconst xPosLeft = (CSS as any /*XXX CSStypedOM */).px(tableLeft);\n\t\t\tconst xPosRight = (CSS as any /*XXX CSStypedOM */).px(tableLeft + tableRect.width);\n\t\t\tconst xPosStart = dir === 'ltr' ? xPosLeft : xPosRight;\n\t\t\tconst xPosEnd = dir === 'ltr' ? xPosRight : xPosLeft;\n\t\t\tfor (const y of yRows) {\n\t\t\t\tbtn = this.getBtn(btn, 'insRow', '+', \"Insérer une ligne\");\n\t\t\t\tconst st = (btn as any /*XXX CSStypedOM */).attributeStyleMap;\n\t\t\t\tst.set('top', (CSS as any /*XXX CSStypedOM */).px(y));\n\t\t\t\tst.set('left', xPosStart);\n\t\t\t}\n\t\t\tconst yPos = (CSS as any /*XXX CSStypedOM */).px(yRows[0]);\n\t\t\tfor (const x of xCols) {\n\t\t\t\tbtn = this.getBtn(btn, 'insCol', '+', \"Insérer une colonne\");\n\t\t\t\tconst st = (btn as any /*XXX CSStypedOM */).attributeStyleMap;\n\t\t\t\tst.set('left', (CSS as any /*XXX CSStypedOM */).px(x));\n\t\t\t\tst.set('top', yPos);\n\t\t\t}\n\t\t\tif (yRows.length > 2) for (let i = 1; i < yRows.length; i++) {\n\t\t\t\tbtn = this.getBtn(btn, 'delRow', '-', \"Supprimer cette ligne\");\n\t\t\t\tconst st = (btn as any /*XXX CSStypedOM */).attributeStyleMap;\n\t\t\t\tst.set('top', (CSS as any /*XXX CSStypedOM */).px((yRows[i - 1] + yRows[i]) / 2));\n\t\t\t\tst.set('left', xPosEnd);\n\t\t\t}\n\t\t\tif (xCols.length > 2) for (let i = 1; i < xCols.length; i++) {\n\t\t\t\tbtn = this.getBtn(btn, 'delCol', '-', \"Supprimer cette colonne\");\n\t\t\t\tconst st = (btn as any /*XXX CSStypedOM */).attributeStyleMap;\n\t\t\t\tst.set('left', (CSS as any /*XXX CSStypedOM */).px((xCols[i - 1] + xCols[i]) / 2));\n\t\t\t\tst.set('top', yPos);\n\t\t\t}\n\t\t}\n\t\tthis.buildCellSelector(btn);\n\t\tthis.refreshCellSel(txtTableRect);\n\t}\n\n\t/** Controle de la sel en cas de modifs conurrentes. */\n\tcheckSel() {\n\t\tif (!this.anchorCell.isConnected) this.anchorCell = this.focusCell;\n\t\tif (!this.focusCell.isConnected) {\n\t\t\tif (this.focusCell === this.anchorCell) {\n\t\t\t\t//Sel supprimée : cas très rares, on sel arbitrairement la 1ère cell du tableau\n\t\t\t\tthis.focusCell = this.anchorCell = DOM.findNext(this.txtTable.table, this.txtTable.table, TXTTABLE.IS_TxtCell);\n\t\t\t} else {\n\t\t\t\tthis.focusCell = this.anchorCell;\n\t\t\t}\n\t\t}\n\t}\n\n\t/** Redessine la zone sélectionnée. */\n\trefreshCellSel(txtTableRect: DOMRect | ClientRect) {\n\t\tthis.checkSel();\n\t\tconst st = (this.cellSelector as any /*XXX CSStypedOM */).attributeStyleMap;\n\t\tconst c1Rect = this.anchorCell.getBoundingClientRect();\n\t\tlet x1, x2, y1, y2: number;\n\t\tif (this.anchorCell !== this.focusCell) {\n\t\t\tconst c2Rect = this.focusCell.getBoundingClientRect();\n\t\t\tx1 = Math.min(c1Rect.left, c2Rect.left);\n\t\t\tx2 = Math.max(c1Rect.right, c2Rect.right);\n\t\t\ty1 = Math.min(c1Rect.top, c2Rect.top);\n\t\t\ty2 = Math.max(c1Rect.bottom, c2Rect.bottom);\n\t\t} else {\n\t\t\tx1 = c1Rect.left;\n\t\t\tx2 = c1Rect.right;\n\t\t\ty1 = c1Rect.top;\n\t\t\ty2 = c1Rect.bottom;\n\t\t}\n\t\tst.set('top', (CSS as any /*XXX CSStypedOM */).px(y1 - txtTableRect.top));\n\t\tst.set('left', (CSS as any /*XXX CSStypedOM */).px(x1 - txtTableRect.left));\n\t\tst.set('width', (CSS as any /*XXX CSStypedOM */).px(x2 - x1));\n\t\tst.set('height', (CSS as any /*XXX CSStypedOM */).px(y2 - y1));\n\t\t//\n\t\tconst commonBars = (this.txtTable.wedMgr.wedEditor as IWedEditorCommonBar).commonBar;\n\t\tif (commonBars) commonBars.planChangeFocusBar(this.txtTable.focusBar);\n\t}\n\n\tgetFirstCellSelected(): TxtCell {\n\t\treturn this.focusCell;\n\t}\n\n\tmoveCellSel(target: TxtCell, extendSel?: boolean) {\n\t\tif (!target) return;\n\t\tif (extendSel) {\n\t\t\tthis.focusCell = target;\n\t\t} else {\n\t\t\tthis.anchorCell = this.focusCell = target;\n\t\t}\n\t\tthis.refreshCellSel(this.txtTable.getBoundingClientRect());\n\t\ttarget.scrollIntoView({behavior: \"smooth\", block: \"nearest\", inline: \"nearest\"});\n\t}\n\n\tget logicTable(): LogicTable {return new TXTTABLE.LogicTable(this.txtTable)}\n\n\n\tonCopy(ev?: ClipboardEvent) {\n\t\tthis.txtTable.wedMgr.writeNodesToClipboard([this.txtTable.wedAnchor], [{tableRect: this.logicTable.getSelRect()}], ev?.clipboardData);\n\t}\n\n\tonCopyXml() {\n\t\tthis.txtTable.wedMgr.writeNodesToClipboardAsXml([this.txtTable.wedAnchor], [{tableRect: this.logicTable.getSelRect()}]);\n\t}\n\n\tonCut(ev: ClipboardEvent) {\n\t\tthis.cutOrDelete(true, ev.clipboardData);\n\t}\n\n\tcutOrDelete(cut: boolean, data?: DataTransfer) {\n\t\tlet logicTable = this.logicTable;\n\t\tlet selRect = logicTable.getSelRect();\n\n\t\tconst execute = (action: 'delRows' | 'delCols' | 'delTable', data?: DataTransfer) => {\n\t\t\tconst batch = this.txtTable.wedMgr.docHolder.newBatch();\n\t\t\tswitch (action) {\n\t\t\tcase 'delRows':\n\t\t\t\tbatch.setMeta(TxtSelMgr.MSGMETA_tblLayout, true);\n\t\t\t\tif (cut) this.txtTable.wedMgr.writeNodesToClipboard([this.txtTable.wedAnchor], [{tableRect: {startRow: selRect.startRow, startCol: 0, endRow: selRect.endRow, endCol: this.txtTable.countCols()}}], data);\n\t\t\t\tlogicTable.deleteRows(batch, selRect.startRow, selRect.endRow - selRect.startRow);\n\t\t\t\tbatch.doBatch();\n\t\t\t\tbreak;\n\t\t\tcase 'delCols':\n\t\t\t\tbatch.setMeta(TxtSelMgr.MSGMETA_tblLayout, true);\n\t\t\t\tif (cut) this.txtTable.wedMgr.writeNodesToClipboard([this.txtTable.wedAnchor], [{tableRect: {startRow: 0, startCol: selRect.startCol, endRow: logicTable.logicRows.length, endCol: selRect.endCol}}], data);\n\t\t\t\tlogicTable.deleteCols(batch, selRect.startCol, selRect.endCol - selRect.startCol);\n\t\t\t\tbatch.doBatch();\n\t\t\t\tbreak;\n\t\t\tcase 'delTable':\n\t\t\t\tif (cut) this.txtTable.wedMgr.writeNodesToClipboard([this.txtTable.wedAnchor], [], data);\n\t\t\t\tbatch.deleteSequence(this.txtTable.wedAnchor, 1);\n\t\t\t\tbatch.doBatch();\n\t\t\t}\n\t\t};\n\t\tconst allCols = selRect.startCol === 0 && selRect.endCol === this.txtTable.countCols();\n\t\tif (selRect.startRow === 0 && selRect.endRow === logicTable.logicRows.length) {\n\t\t\t//cut colonnes or table\n\t\t\texecute(allCols ? 'delTable' : 'delCols', data);\n\t\t} else if (allCols) {\n\t\t\t//cut rows\n\t\t\texecute('delRows', data);\n\t\t} else {\n\t\t\tconst actions = [];\n\t\t\tactions.push(new Action<TableLayout>('delRows').setLabel(\"ligne(s)\"));\n\t\t\tactions.push(new Action<TableLayout>('delCols').setLabel(\"colonne(s)\"));\n\t\t\tactions.push(new Action<TableLayout>('delTable').setLabel(\"tableau entier\"));\n\t\t\tthis.locked = true;\n\t\t\ttry {\n\t\t\t\tconst popup = new PopupActions<TableLayout>().initialize({\n\t\t\t\t\tactionContext: this,\n\t\t\t\t\tactions,\n\t\t\t\t\theadTitle: cut ? \"Couper...\" : \"Supprimer...\",\n\t\t\t\t\trestoreFocus: this.tblEditNode\n\t\t\t\t});\n\t\t\t\tpopup.addEventListener('c-close', (ev: IPopupCloseEvent) => {\n\t\t\t\t\tif (ev.detail.returnValue) {\n\t\t\t\t\t\tlogicTable = this.logicTable; //refresh en cas d'édition concurrente\n\t\t\t\t\t\tselRect = logicTable.getSelRect();\n\t\t\t\t\t\texecute(ev.detail.returnValue.getId() as any);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tpopup.show(this.txtTable.table, this.txtTable, this.txtTable);\n\t\t\t} finally {\n\t\t\t\tthis.locked = false;\n\t\t\t}\n\t\t}\n\t}\n\n\n\tbuildImportContext(): OSkTableImportContext {\n\t\tif (!this.focusCell || this.focusCell !== this.anchorCell) {\n\t\t\tPOPUP.showNotifInfo(\"Sélectionnez une seule cellule pour le point de départ du collage.\", this.txtTable);\n\t\t\treturn null;\n\t\t}\n\t\treturn {sel: {start: XA.append(this.txtTable.wedAnchor, 0)}, cellInsertPoint: this.focusCell.wedAnchor};\n\t}\n\n\tprotected onClickBtn(this: ITableLayoutBtn, ev: MouseEvent) {\n\t\tconst tableEd = DOMSH.findHost(this) as TxtTblEditor;\n\t\tconst txtTable = tableEd.tableLayout.txtTable;\n\t\tev.stopImmediatePropagation();\n\t\tif (this.classList.contains('insCol')) {\n\t\t\tconst colModels = txtTable.model.colModels;\n\t\t\tconst batch = txtTable.wedMgr.docHolder.newBatch();\n\t\t\tbatch.setMeta(TxtSelMgr.MSGMETA_tblLayout, true);\n\t\t\ttableEd.tableLayout.logicTable.insertCols(batch, this.logicalOffset, colModels[0]);\n\t\t\tbatch.doBatch();\n\t\t} else if (this.classList.contains('insRow')) {\n\t\t\tconst rowModels = txtTable.model.rowModels;\n\t\t\tconst batch = txtTable.wedMgr.docHolder.newBatch();\n\t\t\tbatch.setMeta(TxtSelMgr.MSGMETA_tblLayout, true);\n\t\t\ttableEd.tableLayout.logicTable.insertRows(batch, this.logicalOffset, rowModels[0]);\n\t\t\tbatch.doBatch();\n\t\t} else if (this.classList.contains('delRow')) {\n\t\t\tconst batch = txtTable.wedMgr.docHolder.newBatch();\n\t\t\tbatch.setMeta(TxtSelMgr.MSGMETA_tblLayout, true);\n\t\t\ttableEd.tableLayout.logicTable.deleteRows(batch, this.logicalOffset, 1);\n\t\t\tbatch.doBatch();\n\t\t} else if (this.classList.contains('delCol')) {\n\t\t\tconst batch = txtTable.wedMgr.docHolder.newBatch();\n\t\t\tbatch.setMeta(TxtSelMgr.MSGMETA_tblLayout, true);\n\t\t\ttableEd.tableLayout.logicTable.deleteCols(batch, this.logicalOffset, 1);\n\t\t\tbatch.doBatch();\n\t\t}\n\t}\n\n\tprotected getBtn(prev: ITableLayoutBtn, cls: string, label: string, title: string): ITableLayoutBtn {\n\t\tlet curr = prev ? prev.nextElementSibling : DOM.findFirstChild(this.tblEditNode.shadowRoot, (n: Node): n is HTMLElement => n instanceof HTMLElement && n.classList.contains(cls));\n\t\tif (prev && !prev.classList.contains(cls)) {\n\t\t\t//cleanup des btns en trop du type précédent.\n\t\t\twhile (curr && curr.localName === 'button' && !curr.classList.contains(cls)) {\n\t\t\t\tprev = curr as ITableLayoutBtn;\n\t\t\t\tcurr = curr.nextElementSibling;\n\t\t\t\tprev.remove();\n\t\t\t}\n\t\t\tprev = null;\n\t\t}\n\t\tif (curr instanceof HTMLElement && curr.classList.contains(cls)) return curr;\n\t\tconst btn = document.createElement(\"button\") as ITableLayoutBtn;\n\t\tbtn.logicalOffset = prev ? prev.logicalOffset + 1 : 0;\n\t\tbtn.tabIndex = -1;\n\t\tbtn.classList.add(cls);\n\t\tbtn.appendChild(document.createElement('span')).textContent = label;\n\t\tbtn.title = title;\n\t\tbtn.onclick = this.onClickBtn;\n\t\tbtn.onpointerdown = (ev: MouseEvent) => {ev.stopImmediatePropagation();}; //bloque pour les div autour de la table masquant le tableLayout.\n\t\tthis.tblEditNode.shadowRoot.insertBefore(btn, curr);\n\t\treturn btn;\n\t}\n\n\tprotected buildCellSelector(prev: Element): HTMLElement {\n\t\tprev = prev ? prev.nextElementSibling : null;\n\t\twhile (prev && prev.localName === 'button') {\n\t\t\t//cleanup des buttons en trop.\n\t\t\tconst next = prev.nextElementSibling;\n\t\t\tprev.remove();\n\t\t\tprev = next;\n\t\t}\n\t\tif (!this.cellSelector) {\n\t\t\tthis.cellSelector = document.createElement(\"div\");\n\t\t\tthis.cellSelector.classList.add('cellSelect');\n\t\t\tthis.tblEditNode.shadowRoot.appendChild(this.cellSelector);\n\t\t}\n\t\treturn this.cellSelector;\n\t}\n\n\tprotected _idle(deadline: RequestIdleDeadline) {\n\t\tif (!this.enabled || !this.tblEditNode.isConnected) return;\n\t\tif (deadline.timeRemaining() > 20) this.adjustTableLayout();\n\t\twindow.requestIdleCallback(this.idleCb);\n\t}\n}\n\n\nexport function onTxtTblEdBlur(this: TxtTblEditor, ev: FocusEvent) {\n\tthis.tableLayout.onBlur(ev);\n}\n\ninterface ITableLayoutBtn extends HTMLElement {\n\tlogicalOffset?: number\n}\n\nclass TxtTblEditor extends BaseElement implements IWedFocusBarPointer {\n\ttableLayout: TableLayout;\n\n\t_onTblEdPointerCancel: (this: TxtTblEditor, ev: PointerEvent) => void;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.addEventListener(\"blur\", onTxtTblEdBlur);\n\t\tthis.addEventListener(\"pointerdown\", onTblEdPointerDown);\n\t\tthis.addEventListener(\"keydown\", onTblEdKeyDown);\n\t\tthis._onTblEdPointerCancel = onTblEdPointerCancel.bind(this);\n\t}\n\n\t_initialize(init: OSkinableInit) {\n\t\tthis.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t}\n\n\tshow() {\n\t\tthis.hidden = false;\n\t\tthis.focus();\n\t}\n\n\thide() {\n\t\tthis.hidden = true;\n\t}\n\n\tensureFocused() {\n\t\tif (DOMSH.findDocumentOrShadowRoot(this).activeElement !== this) {\n\t\t\t//on récupère le focus au besoin : le focus peut être dans la focusBar.\n\t\t\tthis.tableLayout.locked = true; //pour que le suivi du blur (cf TableLayout.onBlur()) ne provoque pas la désactivation du tableLayout.\n\t\t\ttry {\n\t\t\t\tthis.focus();\n\t\t\t} finally {\n\t\t\t\tthis.tableLayout.locked = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tfocus() {\n\t\tsuper.focus();\n\t\tif (!this.tableLayout.enabled) this.tableLayout.drawTableLayout(this.tableLayout.focusCell, this.tableLayout.anchorCell);\n\t}\n\n\tget focusBar(): BarActions<IWedletActionCtx> {return this.tableLayout.txtTable.focusBar}\n}\n\nwindow.customElements.define(\"txt-tbl-editor\", TxtTblEditor);\n\nREG.reg.registerSkin('txt-tbl-editor', 1, /* language=CSS */ `\n\t:host {\n\t\tposition: absolute;\n\t\ttop: 0;\n\t\tleft: 0;\n\t\twidth: 100%;\n\t\theight: 100%;\n\t\topacity: .8;\n\t\tbox-sizing: border-box;\n\t}\n\n\t:host(:focus) {\n\t\toutline: none;\n\t}\n\n\t:host([hidden]) {\n\t\tdisplay: none;\n\t}\n\n\tbutton {\n\t\t-webkit-appearance: none;\n\t\tposition: absolute;\n\t\tdisplay: block;\n\t\twidth: 1em;\n\t\theight: 1em;\n\t\tborder: none;\n\t\tborder-radius: .5em;\n\t\tpadding: 0;\n\t\tfont-weight: bold;\n\t\tcolor: var(--insbtn-color);\n\t\tbackground-color: var(--insbtn-bg);\n\t}\n\n\tbutton:active {\n\t\tfilter: brightness(1.1);\n\t}\n\n\tbutton:hover {\n\t\tbackground-color: var(--insbtn-hover-bg);\n\t}\n\n\t.insCol,\n\t.delCol {\n\t\tmargin-top: -1.2em;\n\t\tmargin-left: -.5em;\n\t}\n\n\t.insRow {\n\t\tmargin-top: -.5em;\n\t\tmargin-left: -1.2em;\n\t}\n\n\t.delRow {\n\t\tmargin-top: -.5em;\n\t\tmargin-left: -.5em;\n\t}\n\n\t.delCol > span,\n\t.delRow > span {\n\t\tdisplay: block;\n\t\tmargin-top: -.2em;\n\t}\n\n\n\t.cellSelect {\n\t\tposition: absolute;\n\t\toutline: var(--edit-box-focus);\n\t\tbackground-color: var(--edit-select-bgcolor);\n\t}\n`);\n\nfunction onTblEdPointerDown(this: TxtTblEditor, ev: PointerEvent) {\n\tev.stopImmediatePropagation();\n\tev.preventDefault(); //Obligatoire sinon un evt selectionchange est propagé et reset la commonBar.\n\tthis.ensureFocused();\n\tconst rect = this.getBoundingClientRect();\n\tif (ev.x < rect.left + this.tableLayout.xCols[0] || ev.x > rect.left + this.tableLayout.xCols[this.tableLayout.xCols.length - 1]) {\n\t\t//hors tableau (en marge à droite ou à gauche), on sort\n\t\t//sauf si click droit, en prévision du TODO menu contextuel propre au TblEditor reprenant sa toolbar.\n\t\tif (ev.button !== 2) this.tableLayout.toggle();\n\t} else {\n\t\tconst cell = cellFromPoint(this.tableLayout.txtTable, ev.x, ev.y);\n\t\tif (cell) {\n\t\t\tif (!ev.shiftKey) this.tableLayout.anchorCell = cell;\n\t\t\tthis.tableLayout.focusCell = cell;\n\t\t\tthis.tableLayout.refreshCellSel(this.tableLayout.txtTable.getBoundingClientRect());\n\t\t\tthis.addEventListener(\"pointermove\", onTblEdPointerMove);\n\t\t\tdocument.addEventListener(\"pointerup\", this._onTblEdPointerCancel);\n\t\t\tdocument.addEventListener(\"pointercancel\", this._onTblEdPointerCancel);\n\t\t}\n\t}\n}\n\nfunction cellFromPoint(txtTable: TxtTable, x: number, y: number): TxtCell | null {\n\treturn document.createTreeWalker(txtTable.table, NodeFilter.SHOW_ELEMENT, {\n\t\tacceptNode(node: HTMLElement): number {\n\t\t\tif (node instanceof TxtCell) {\n\t\t\t\tif (GFX.isPointIn(node.getBoundingClientRect(), x, y)) return NodeFilter.FILTER_ACCEPT;\n\t\t\t\treturn NodeFilter.FILTER_REJECT;\n\t\t\t}\n\t\t\treturn NodeFilter.FILTER_SKIP;\n\t\t}\n\t}).nextNode() as TxtCell;\n}\n\nfunction onTblEdKeyDown(this: TxtTblEditor, ev: KeyboardEvent) {\n\t//console.log(\"onTblEdKeyDown:::\", ev.key);\n\tswitch (ev.key) {\n\tcase 'ArrowLeft':\n\t\tthis.tableLayout.moveCellSel(DOM.findPreviousSibling(this.tableLayout.focusCell, TXTTABLE.IS_TxtCell), ev.shiftKey);\n\t\tbreak;\n\tcase 'ArrowRight':\n\t\tthis.tableLayout.moveCellSel(DOM.findNextSibling(this.tableLayout.focusCell, TXTTABLE.IS_TxtCell), ev.shiftKey);\n\t\tbreak;\n\tcase 'ArrowUp': {\n\t\tconst logicTable = this.tableLayout.logicTable;\n\t\tconst {offsRow, offsCol} = logicTable.getLogicOffsets(this.tableLayout.focusCell);\n\t\tthis.tableLayout.moveCellSel(logicTable.getTxtCellAt(offsRow - 1, offsCol), ev.shiftKey);\n\t\tbreak;\n\t}\n\tcase 'ArrowDown': {\n\t\tconst logicTable = this.tableLayout.logicTable;\n\t\tconst {offsRow, offsCol} = logicTable.getLogicOffsets(this.tableLayout.focusCell);\n\t\tthis.tableLayout.moveCellSel(logicTable.getTxtCellAt(offsRow + 1, offsCol), ev.shiftKey);\n\t\tbreak;\n\t}\n\tcase 'Insert':\n\tcase 'Escape':\n\t\tthis.tableLayout.toggle();\n\t\tbreak;\n\tcase 'Delete':\n\tcase 'Backspace':\n\t\tthis.tableLayout.cutOrDelete(false);\n\t\tbreak;\n\tdefault:\n\t\treturn; //autre touche, on ne stoppe pas l'event.\n\t}\n\tev.stopImmediatePropagation();\n\tev.preventDefault();\n}\n\n/** Utilisé pour drag&drop sel du TableLayout. */\nfunction onTblEdPointerMove(this: TxtTblEditor, ev: PointerEvent) {\n\tconst cell = cellFromPoint(this.tableLayout.txtTable, ev.x, ev.y);\n\tif (cell && this.tableLayout.focusCell !== cell) {\n\t\tthis.tableLayout.focusCell = cell;\n\t\tthis.tableLayout.refreshCellSel(this.tableLayout.txtTable.getBoundingClientRect());\n\t\t//FIXME ajouter des margin à scrollIntoView pour (cf https://github.com/stipsan/scroll-into-view-if-needed ?)\n\t\tcell.scrollIntoView({behavior: \"smooth\", block: \"nearest\", inline: \"nearest\"});\n\t}\n}\n\nexport function onTxtTableFlexPointerDown(this: HTMLElement, ev: PointerEvent) {\n\t(DOMSH.findHost(this) as TxtTable).tableLayout.drawTableLayout();\n\tev.stopImmediatePropagation();\n\tev.preventDefault();\n}\n\nfunction onTblEdPointerCancel(this: TxtTblEditor, ev: PointerEvent) {\n\tdocument.removeEventListener(\"pointerup\", onTblEdPointerCancel);\n\tdocument.removeEventListener(\"pointercancel\", onTblEdPointerCancel);\n\tthis.removeEventListener(\"pointermove\", onTblEdPointerMove);\n}\n\nfunction arrayEquals(a1: any[], a2: any[]) {\n\tif (a1.length != a2.length) return false;\n\tfor (let i = 0; i < a1.length; i++) if (a1[i] !== a2[i]) return false;\n\treturn true;\n}\n"]}