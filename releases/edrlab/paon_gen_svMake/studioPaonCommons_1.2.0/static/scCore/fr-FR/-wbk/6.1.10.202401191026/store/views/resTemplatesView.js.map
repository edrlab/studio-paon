{"version":3,"sources":["/@back@/store/views/resTemplatesView.tsx"],"names":["BaseAreaViewAsync","REG","DOMSH","JSX","BarActions","RES","AddByImport","ImportRes","ResEditAction","URLTREE","InfoBrokerBasic","POPUP","ResTemplatesView","[object Object]","init","this","reg","areaContext","findReg","super","_initialize","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","fetchChildrenQuery","actionContext","infoBroker","emitter","bars","homePrc","bar","createElement","id","î","actions","getHomeActions","uiContext","disableFullOverlay","appendChild","homeTitle","homeDetails","push","notFoundPrc","getNotFoundActions","notFoundTitle","notFoundDetails","authPrc","getAuthActions","authTitle","authDetails","env","nodeInfosChange","on","async","m","isQueryPath","path","forEach","refreshContent","ImportHiddenRes","setLabel","DeleteHiddenRes","childrenQueryNodes","universe","adminUrlTree","listChildren","NODEPROPS_short","subPath","prc","ctx","prototype","isVisible","call","ev","uiCtx","getUiCtx","files","pickFiles","doImport","appendToPath","nodeInfos","permaPath","processing","olderResId","_description","_icon","_group","_enablePerms","_a","ch","find","n","confirm","okLbl","sendCidUpdate","action","registerSkin","customElements","define"],"mappings":"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","sourcesContent":["import {BaseAreaViewAsync, OBaseAreaViewInit} from \"lib/commons/views\";\nimport {IDepotResUiEnv, IDepotUiEnv} from \"lib/store/depot\";\nimport {IReg, IRegPointer, REG} from \"lib/commons/registry\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {JSX} from \"lib/commons/xml/dom\";\nimport {BarActions, OBarActionsInit} from \"back/commons/widgets/bars\";\nimport {IDepotResCtx, RES} from \"lib/store/res\";\nimport {AddByImport, ImportRes, RemoveRes, ResEditAction} from \"back/store/actions/resActions\";\nimport {JNodeInfos, URLTREE} from \"lib/store/urlTree\";\nimport {InfoBrokerBasic} from \"lib/commons/infos\";\nimport {POPUP} from \"back/commons/widgets/popups\";\n\n\nexport interface ResTemplatesView extends BaseAreaViewAsync<IRegPointer<IDepotResUiEnv>> {\n\tinitialize(init: OResTemplatesViewInit): this\n}\n\nexport interface OResTemplatesViewInit extends OBaseAreaViewInit<IRegPointer<IDepotResUiEnv>> {\n\t/** si homePrc non renseigné, pas de gestion d'un gabarit d'accueil de dossier. */\n\thomePrc?: string\n\thomeTitle?: string\n\thomeDetails?: HTMLElement\n\n\t/** si notFoundPrc non renseigné, pas de gestion d'un gabarit de page 404 not found. */\n\tnotFoundPrc?: string\n\tnotFoundTitle?: string\n\tnotFoundDetails?: HTMLElement\n\n\t/** si authPrc non renseigné, pas de gestion d'un gabarit d'accueil. */\n\tauthPrc?: string\n\tauthTitle?: string\n\tauthDetails?: HTMLElement\n}\n\nexport class ResTemplatesView extends BaseAreaViewAsync<IRegPointer<IDepotResUiEnv>> {\n\treg: IReg<IDepotResUiEnv & IDepotUiEnv>;\n\n\tchildrenQueryNodes: JNodeInfos;\n\n\tprotected async _initialize(init: OResTemplatesViewInit) {\n\t\tthis.reg = init.areaContext.reg || this.findReg(init);\n\t\tsuper._initialize(init); //init this.area, this.areaContext\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tawait this.fetchChildrenQuery();\n\t\tconst actionContext = {\n\t\t\treg: this.reg,\n\t\t\tinfoBroker: new InfoBrokerBasic(),\n\t\t\temitter: this\n\t\t};\n\t\tconst bars: BarActions<IDepotResCtx>[] = [];\n\t\tif (init.homePrc) {\n\t\t\tconst bar = <BarActions id=\"homeTplActions\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\tactions: this.getHomeActions(init),\n\t\t\t\tactionContext,\n\t\t\t\tuiContext: \"dialog\",\n\t\t\t\tdisableFullOverlay: true\n\t\t\t} as OBarActionsInit<IDepotResCtx>}/> as BarActions<IDepotResCtx>;\n\t\t\tsr.appendChild(<section id=\"homeTpl\">\n\t\t\t\t<h3>{init.homeTitle || \"Accueil dynamique des dossiers\"}</h3>\n\t\t\t\t{init.homeDetails ||\n\t\t<div>\n\t\t\t<p>Cette page gabarit est appliquée sur ce dossier et ses sous-dossiers sauf si un accueil personnalisé du dossier a été importé.</p>\n\t\t\t<p>Elle inclut généralement du code (javascript) permettant de lister le contenu du dossier.</p>\n\t\t</div>\n\t\t\t\t}\n\t\t\t\t{bar}\n\t\t\t</section>);\n\t\t\tbars.push(bar);\n\t\t}\n\n\t\tif (init.notFoundPrc) {\n\t\t\tconst bar = <BarActions id=\"homeTplActions\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\tactions: this.getNotFoundActions(init),\n\t\t\t\tactionContext,\n\t\t\t\tuiContext: \"dialog\",\n\t\t\t\tdisableFullOverlay: true\n\t\t\t} as OBarActionsInit<IDepotResCtx>}/> as BarActions<IDepotResCtx>;\n\t\t\tsr.appendChild(<section id=\"homeTpl\">\n\t\t\t\t<h3>{init.notFoundTitle || \"Page « non trouvée » (404)\"}</h3>\n\t\t\t\t{init.notFoundDetails ||\n\t\t<div>\n\t\t\t<p>Cette page est affichée lorsqu'un utilisateur demande un dossier ou une ressource (dans ce dossier ou ses sous-dossiers) qui n'existe pas ou est en état supprimé (erreur 404).</p>\n\t\t</div>\n\t\t\t\t}\n\t\t\t\t{bar}\n\t\t\t</section>);\n\t\t\tbars.push(bar);\n\t\t}\n\n\t\tif (init.authPrc) {\n\t\t\tconst bar = <BarActions id=\"authTplActions\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\tactions: this.getAuthActions(init),\n\t\t\t\tactionContext,\n\t\t\t\tuiContext: \"dialog\",\n\t\t\t\tdisableFullOverlay: true\n\t\t\t} as OBarActionsInit<IDepotResCtx>}/> as BarActions<IDepotResCtx>;\n\t\t\tsr.appendChild(<section id=\"authTpl\">\n\t\t\t\t<h3>{init.authTitle || \"Page d'authentification\"}</h3>\n\t\t\t\t{init.authDetails ||\n\t\t<div>\n\t\t\t<p>Cette page est affichée lorsqu'un utilisateur demande une ressource (dans ce dossier ou ses sous-dossiers) sans avoir des droits suffisants (erreur 401 ou 403). Elle permet de gérer la connexion ou les changements de comptes.</p>\n\t\t</div>\n\t\t\t\t}\n\t\t\t\t{bar}\n\t\t\t</section>);\n\t\t\tbars.push(bar);\n\t\t}\n\n\t\t//Refresh\n\t\tthis.reg.env.nodeInfosChange.on(\"childChange\", async (m) => {\n\t\t\tif (URLTREE.isQueryPath(m.path)) {\n\t\t\t\tawait this.fetchChildrenQuery();\n\t\t\t\tbars.forEach((bar) => bar.refreshContent());\n\t\t\t}\n\t\t});\n\n\t}\n\n\tgetHomeActions(init: OResTemplatesViewInit) {\n\t\treturn [\n\t\t\tnew ImportHiddenRes('homeImport', \"?home\", init.homePrc).setLabel(\"Importer un accueil dynamique des dossiers\"),\n\t\t\tnew DeleteHiddenRes('homeDelete', \"?home\").setLabel(\"Supprimer l'accueil dynamique personnalisé\")\n\t\t]\n\t}\n\n\tgetNotFoundActions(init: OResTemplatesViewInit) {\n\t\treturn [\n\t\t\tnew ImportHiddenRes('notFoundImport', \"?notFound\", init.notFoundPrc).setLabel(\"Importer une page 404 personnalisée\"),\n\t\t\tnew DeleteHiddenRes('notFoundDelete', \"?notFound\").setLabel(\"Supprimer la page 404 personnalisée\")\n\t\t]\n\t}\n\n\tgetAuthActions(init: OResTemplatesViewInit) {\n\t\treturn [\n\t\t\tnew ImportHiddenRes('authImport', \"?authPage\", init.authPrc).setLabel(\"Importer une page d'authentification personnalisée\"),\n\t\t\tnew DeleteHiddenRes('authDelete', \"?authPage\").setLabel(\"Supprimer la page d'authentification personnalisée\")\n\t\t]\n\t}\n\n\tasync fetchChildrenQuery() {\n\t\tthis.childrenQueryNodes = await this.reg.env.universe.adminUrlTree.listChildren(this.reg.env.path, `&excludeAll&childrenProps=${RES.NODEPROPS_short}&childrenFilter=isQuery`);\n\t}\n\n}\n\nexport class ImportHiddenRes extends ImportRes<IDepotResCtx> {\n\n\tconstructor(id: string, public subPath: string, public prc: string) {\n\t\tsuper(id);\n\t}\n\n\tisVisible(ctx: IDepotResCtx): boolean {\n\t\treturn ResEditAction.prototype.isVisible.call(this, ctx);\n\t}\n\n\tasync execute(ctx: IDepotResCtx, ev?: Event) {\n\t\tconst uiCtx = AddByImport.getUiCtx(ctx, ev);\n\t\tconst files = await AddByImport.pickFiles(false);\n\t\tif (files) return ImportRes.doImport(files[0], {\n\t\t\tpath: URLTREE.appendToPath(ctx.reg.env.nodeInfos.permaPath, this.subPath),\n\t\t\tprocessing: this.prc,\n\t\t\tolderResId: \"\" //pas de check d'update conurrent\n\t\t}, ctx, uiCtx);\n\t}\n}\n\n\nexport class DeleteHiddenRes extends ResEditAction<IDepotResCtx> {\n\n\tconstructor(id: string, public subPath: string) {\n\t\tsuper(id);\n\t\tthis._description = \"Supprimer définitivement ce gabarit (restauration impossible)\";\n\t\tthis._icon = \"/@skin@/store/actions/removeRes.svg\";\n\t\tthis._group = \"edit\";\n\t\t//fixme remplacer la permission (pour en avoir une pour chacune des 3 actions)\n\t\tthis._enablePerms = \"action.store#remove.res\";\n\t}\n\n\tisVisible(ctx: IDepotResCtx): boolean {\n\t\tif (!(ctx.emitter as ResTemplatesView).childrenQueryNodes.ch?.find((n: JNodeInfos) => n.n == this.subPath)) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tasync execute(ctx: IDepotResCtx, ev?: Event) {\n\t\tconst uiCtx = ResEditAction.getUiCtx(ctx, ev);\n\t\tif (await POPUP.confirm(\"Supprimer définitivement cette page ?\", uiCtx, {okLbl: \"Supprimer définitivement\"})) {\n\t\t\treturn ResEditAction.sendCidUpdate({\n\t\t\t\tpath: URLTREE.appendToPath(ctx.reg.env.nodeInfos.permaPath, this.subPath),\n\t\t\t\taction: \"removeAll\"\n\t\t\t}, ctx, uiCtx);\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('store-res-templates', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\n\th3 {\n\t\tcolor: var(--alt1-color);\n\t}\n`);\n\ncustomElements.define('store-res-templates', ResTemplatesView);"]}