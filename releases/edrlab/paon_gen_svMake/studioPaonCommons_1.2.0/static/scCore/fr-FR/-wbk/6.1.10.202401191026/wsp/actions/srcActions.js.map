{"version":3,"sources":["/@back@/wsp/actions/srcActions.tsx"],"names":["POPUP","PopupConfirm","SrcNewCode","AccelKeyMgr","Action","DOM","JSX","FolderEntries","InfoFocusItem","InfoFocusNodeInItem","InfoRefreshItemDisplays","InfoSelectUris","ITEM","ESrcSt","SRC","WSP","REG","ItemCreator","ERROR","EItemTypeFamily","IO","ExportWspAction","ActionBtn","SEC","isFolder","DOMSH","Workbench","REMOTE","SrcAction","[object Object]","this","isNotRemoved","ctx","isBackendDb","reg","env","wsp","backEnd","atLeastOne","shortDescs","length","exactOne","zeroOrOne","families","noFamilies","wspMetaUi","shortDesc","getSrcUriType","srcUri","getItemType","itModel","isFamily","super","isVisible","checkSrcPermsForAll","_visSrcPerms","isEnabled","findIndex","src","srcSt","isMove","wspDefProps","some","sd","isExtItem","isSrcLayered","drvState","hasPermission","srcRoles","srcRi","_enableSrcPerms","drfRefWsp","drfState","drvAxis","startsWith","drvAxisDefCo","perms","getReg","hasPerm","Array","isArray","i","requireSrcVisiblePerm","indexOf","push","requireSrcEnabledPerm","ShortDescCopy","id","_label","_group","_icon","ev","setShortDescTransferToClipboard","SINGLETON","FocusItem","infoBroker","from","itSubItem","dispatchInfo","srcRef","getFirstSrcUri","gotoItem","emitter","FocusItemSelRef","_a","wedSearchCoord","setParamsOnce","searchId","findRef","longDesc","execute","FocusItemOrSpace","isVisibleSuper","isEnabledSuper","OpenFastFindItem","target","FastFindItem","import","openFastFind","itemCreator","getPref","setDefaultConfigFromReg","undefined","uiRoot","onNextClose","doWithResult","fastFind","OpenSearchItems","kind","SearchItems","TaskCritForMe","ItemCritTitleRegExp","UiCritBool","TplRequestsMenu","addToList","makeFromSearchPersistLists","ct","initialize","showMainView","fromSrcUri","fullTextByDefault","criterions","getListAsMap","buildCrit","searchItems","critRoot","appendChild","createElement","AREA","buildBody","and","AREA_AND_ROOT","insertCrit","srcGrid","defaultAction","SearchItemsSelItem","actions","mergeLists","accelKeyMgr","initFromMapActions","mergeListsAsMap","appHeader","mainActions","APPBAR_MAIN_ACTIONS","searchStore","getSvc","msgs","resultsMore","max","resultsEmpty","resultsOne","resultsCount","count","showDialog","titleBar","barLabel","label","closeButton","resizer","viewPortX","viewPortY","initWidth","initHeight","parentCtx","findPopupableParent","me","close","ShowNetItems","workbenchView","task","workbench","findWorkbench","getTab","findFlatParentElt","n","view","showView","setRootSrcRef","srcRefSub","ReloadSrc","wspServer","wspsLive","reloadHouse","buildWspRef","code","info","CreateItem","openCreateItem","itemTypesTree","textFilter","spaceUri","extractSpaceUri","spaceUi","CreateSpace","parentSrcUri","getParentSpace","parentShortDesc","fetchShortDesc","universe","auth","currentUser","isSuperAdmin","show","name","extractSpaceLabel","ti","parentFolder","targetSrcUriType","newCode","createSpaceOrFolder","addLeafToUri","DeleteSrc","ok","uri","leafName","extractLeafFromUri","confirm","itemName","extractItemCode","srcDelete","map","e","report","MoveToSrc","_titlePopup","_moveButtonLabel","srcs","folderEntries","Set","folders","add","extractUriParent","folder","has","isSubUriOrEqual","canChooseTarget","targetFolder","space","targetSpaceUi","targetFolderUi","concat","targetUriFilter","makeTargetFilter","saving","saveAllHouses","targetSrcUri","SpaceSelector","spaceSelector","startSel","buttonLabel","spaceTree","showRoot","onSelChange","spSel","setMsg","evalPerm","grid","lineDrawer","row","line","setStyle","rowKey","doSelect","async","spSrc","checkForConflicts","constructor","prototype","call","srcMoveTo","s","notifError","extractDescError","cancelLbl","response","status","alwaysConfirm","spEntries","setFolderUri","conflicts","filter","getChildStateNow","conflictFiles","file","itemList","join","extractSrcLabel","okLbl","numItems","CopyToSrc","group","srcCopyTo","console","error","ImportItemsToSrc","transfer","isImport","Error","imports","options","targetSrcType","defaultUriParent","allowReplace","repeatedImports","datas","createSrc","RenameSrc","results","isAirItem","currentCode","doBtnLabel","srcRename","DuplicateSrc","getLabel","newCodeUi","srcDuplicate","ImportFiles","input","document","type","multiple","click","files","Promise","resolve","onchange","svc","item","importSrc","entry","ImportScar","uiContext","refUri","content","replaceIfExist","progress","showProgress","resp","importScar","progressCallback","reportError","msg","webkitRelativePath","details","asText","showNotifWarning","style","autoHide","URI_ROOT","accept","replace","node","fetchSrcTree","ch","form","value","checked","choice","elements","namedItem","idx","substring","defaultCode","doImportScar","WriteMainStreamToSrc","blob","cbItems","itemType","bestType","score","t","types","matchType","itemLabel","update","getShortDescDef","PasteContent","navigator","clipboard","read","parent","buttonNode","disabled","findBestType","permissions","query","state","getType","ExportScar","popup","includeNet","keepSpaces","isSingleItem","setContent","scope","mode","wspTitle","leaf","getValidFileName","url","config","wsps","exportUrl","qs","hidden","method","action","body","append","submit","remove","ExportScwsp","SetPermsSpace","_description","ObjRolesMapEdit","itemReg","createSubReg","securityCtx","createSub","rolesUiLayerSng","preSelectAccounts","objThis","objEditRolesMap","rolesMap","srcSetRoles","objEditRolesMapPerms","objFetchRolesMap","srcGetRoles","objFetchRolesMapForAccounts","pAccounts","srcGetRolesForAccounts","OpenWspTrash","init","WspTrash","openTrashDialog","WspImportSrc","parentUri","uiCtx","isValidPartUri","newParent","empty","entries","File","pushResFolder","importItem","importSpace","trace","isValidCodeItem","importRes","doImportAllowReplace","mimeType","itemTypeReducer","acc","cur","minMatchScore","sgnPattern","test","getSgn","prevIt","prevMatchScore","currMatchScore","pop","getFamily","xml","codeItem","log","isValidCode","buildName","replaceAll","none","_b","replaceNothing","Blob","getItemTypes","find","it","res","showNotifError","freeStates","doBtnReplaceLabel","doAllBtnLabel","doAllSelected","registerSvc","WspImportInterWspLazy","lib","wspFrom","srcFrom","impl","resolver","importJs","WspImportInterWsp","WspImportFromUrlWsp","patternItemSgn","data","urls","getData","split","u","charAt","trim","aliasUrls","ShortDescToImportFromUrl","path","URL","pathname","nmIdx","lastIndexOf","uriParentFrozen","newContentOptions","remoteUrl"],"mappings":"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","sourcesContent":["import {IGridDataRow} from \"back/commons/widgets/grid-core\";\nimport {POPUP, PopupConfirm} from \"back/commons/widgets/popups\";\nimport {SpaceSelector} from \"back/wsp/dialogs/spaceSelector\";\nimport {SrcNewCode} from \"back/wsp/dialogs/srcNewCode\";\nimport {AccelKeyMgr, Action, EButtonUiContext} from \"lib/commons/actions\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {\n\tFolderEntries,\n\tIImportFromUrlSvc,\n\tIImportInterWspSvc,\n\tIImportInWspSvc,\n\tInfoFocusItem,\n\tInfoFocusNodeInItem,\n\tInfoRefreshItemDisplays,\n\tInfoSelectUris,\n\tIShortDescCtx,\n\tIShortDescsTransfer,\n\tIShortDescUrlTransfer,\n\tITEM,\n\tOImportInterWspOptions,\n\tOImportRepeatStates,\n\tOImportSrcOptions\n} from \"lib/wsp/item\";\nimport {ESrcSt, JSrcFields, JSrcFieldsTree, SRC, srcRef, srcUri} from \"lib/wsp/src\";\nimport {IWspUiEnv, JWspDefProps, Wsp, WSP} from \"lib/wsp/wsp\";\nimport {IReg, IRegPointer, REG} from \"lib/commons/registry\";\nimport {ItemCreator} from \"back/wsp/dialogs/itemCreator\";\nimport {IItemUiEnv} from \"back/wsp/views/itemMain\";\nimport {FastFindItem} from \"back/wsp/dialogs/fastFindItem\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {OSearchItemsInit, SearchItems} from \"back/wsp/dialogs/searchItems\";\nimport {ISrcGridCtx} from \"back/wsp/widgets/srcGrid\";\nimport {ISearchStore} from \"lib/wsp/search\";\nimport {EItemTypeFamily, ItemType} from \"lib/wsp/wspMetaUi\";\nimport {IO} from \"lib/commons/io/io\";\nimport {OWspTrashInit} from \"back/wsp/dialogs/wspTrash\";\nimport {OObjRolesMapInit} from \"back/core/dialogs/objRolesMap\";\nimport {ExportWspAction, IWspActionCtx} from \"back/wsp/actions/wspActions\";\nimport {ActionBtn} from \"back/commons/widgets/buttons\";\nimport {IInfoBroker, IInfoBrokerPointer, IInfoProducer} from \"lib/commons/infos\";\nimport {SEC} from \"lib/commons/security\";\nimport {IFolder, isFolder} from \"lib/commons/io/files\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {Workbench} from \"back/core/widgets/workbench\";\nimport {NetItems} from \"back/wsp/views/netItems\";\nimport {OAppHeaderInit} from \"back/core/widgets/appHeader\";\nimport {TplRequestsMenu} from \"back/wsp/actions/searchesActions\";\nimport {TaskCritForMe} from \"back/wsp/widgets/search/taskCrit\";\nimport {ItemCritTitleRegExp} from \"back/wsp/widgets/search/itemCrit\";\nimport {UiCritBool} from \"back/wsp/widgets/search/uiCrit\";\nimport {IWedSearchCoordinatorPointer} from \"back/edit/wed/features/searchBar\";\nimport {JItemWedSearchBarParams} from \"back/wsp/widgets/wed/wspSearchBar\";\nimport {REMOTE} from \"lib/core/remote\";\n\n/**\n *\n */\nexport class SrcAction<C extends IShortDescCtx> extends Action<C> {\n\tatLeastOne: boolean;\n\texactOne: boolean;\n\tzeroOrOne: boolean;\n\t/** liste blanche de certaines familles d'items/res. */\n\tfamilies: EItemTypeFamily[];\n\t/** limite aux items (espaces exclus) avec liste noire de certaines familles d'items/res. */\n\tnoFamilies: EItemTypeFamily[];\n\tisBackendDb: boolean;\n\tisNotRemoved: boolean = true; //par défaut action désactivée sur une entrée est en état supprimée\n\n\t/* Perms appliquées sur chaque src (avec ses srcRoles et srcRi) pour évaluer la visibilité de l'action. */\n\tprotected _visSrcPerms: string[];\n\n\t/* Perms appliquées sur chaque src (avec ses srcRoles et srcRi) pour évaluer l'activation de l'action. */\n\tprotected _enableSrcPerms: string[];\n\n\tisVisible(ctx: C): boolean {\n\t\tif (this.isBackendDb && ctx.reg.env.wsp.backEnd === \"fs\") return false;\n\t\tif (this.atLeastOne && ctx.shortDescs.length < 1) return false;\n\t\tif (this.exactOne && ctx.shortDescs.length !== 1) return false;\n\t\tif (this.zeroOrOne && ctx.shortDescs.length > 1) return false;\n\t\tif (this.families || this.noFamilies) {\n\t\t\tconst wspMetaUi = ctx.reg.env.wsp.wspMetaUi;\n\t\t\tfor (const shortDesc of ctx.shortDescs) {\n\t\t\t\tif (ITEM.getSrcUriType(shortDesc.srcUri) === \"space\") return false;\n\t\t\t\tif (this.families && !wspMetaUi.getItemType(shortDesc.itModel).isFamily(...this.families)) return false;\n\t\t\t\tif (this.noFamilies && wspMetaUi.getItemType(shortDesc.itModel).isFamily(...this.noFamilies)) return false;\n\t\t\t}\n\t\t}\n\t\tif (!super.isVisible(ctx)) return false;\n\t\treturn this.checkSrcPermsForAll(this._visSrcPerms, ctx);\n\t}\n\n\tisEnabled(ctx: C): boolean {\n\t\tif (!super.isEnabled(ctx)) return false;\n\t\tif (this.isNotRemoved && ctx.shortDescs.findIndex((src) => src.srcSt < 0) >= 0) return false;\n\t\tif ((this as IMoveAction).isMove) {\n\t\t\t//On est une action de déplacement d'un noeud.\n\t\t\tconst wspDefProps = ctx.reg.env.wsp.wspDefProps;\n\t\t\tif (ctx.shortDescs.some((sd) => {\n\t\t\t\t//Pas de move sur une uri externe\n\t\t\t\tif (ITEM.isExtItem(sd.srcUri)) return true;\n\t\t\t\tif (this.isSrcLayered(wspDefProps, sd)) {\n\t\t\t\t\tif (sd.drvState) return true; //drv: jamais déplacable.\n\t\t\t\t\t//drf: check perm spéciale pour changer l'arbo de la ref.\n\t\t\t\t\tif (!ctx.reg.hasPermission(\"action.src#update.outsideLayer\", sd.srcRoles, null, sd.srcRi)) return true;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t})) return false;\n\n\t\t}\n\t\treturn this.checkSrcPermsForAll(this._enableSrcPerms, ctx)\n\t}\n\n\t/** Ce noeud est-il une surcouche d'un layer inférieur ? */\n\tprotected isSrcLayered(wspDefProps: JWspDefProps, sd: JSrcFields): boolean {\n\t\tif (wspDefProps.drfRefWsp) {\n\t\t\treturn sd.drfState !== \"created\" && sd.drfState !== \"createdDeleted\";\n\t\t} else if (wspDefProps.drvAxis) {\n\t\t\tif (sd.drvState.startsWith(\"created\")) return false; //contenu propre à l'atelier\n\t\t\tif (sd.drvState === \"erased\" && sd.drvAxisDefCo === null) return false; //contenu supprimé mais aucun axis dans la chaine défini ce contenu et master phantom => propre à l'atelier\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tgetFirstSrcUri(ctx: IShortDescCtx): srcUri {return ctx.shortDescs.length >= 1 ? ctx.shortDescs[0].srcUri : null}\n\n\tcheckSrcPermsForAll(perms: string | string[], ctx: IShortDescCtx): boolean {\n\t\tif (perms) {\n\t\t\tconst reg = REG.getReg(ctx);\n\t\t\tif (ctx.shortDescs.length === 0) {\n\t\t\t\t//Aucun src listé => perm sur l'atelier\n\t\t\t\tif (!reg.hasPerm(perms)) return false;\n\t\t\t} else {\n\t\t\t\tfor (const sd of ctx.shortDescs) if (!reg.hasPermission(perms, sd.srcRoles, null, sd.srcRi)) return false;\n\t\t\t}\n\t\t}\n\t\treturn true\n\t}\n\n\trequireSrcVisiblePerm(perms: string | string[]): this {\n\t\tif (perms) {\n\t\t\tif (Array.isArray(perms)) {\n\t\t\t\tfor (let i = 0; i < perms.length; i++) this.requireSrcVisiblePerm(perms[i]);\n\t\t\t} else {\n\t\t\t\tif (!this._visSrcPerms) this._visSrcPerms = [];\n\t\t\t\tif (this._visSrcPerms.indexOf(perms) == -1) this._visSrcPerms.push(perms);\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n\n\t/**\n\t * @param perms logique \"or\" (cf {@link IReg.hasPermission})\n\t */\n\trequireSrcEnabledPerm(perms: string | string[]): this {\n\t\tif (perms) {\n\t\t\tif (Array.isArray(perms)) {\n\t\t\t\tfor (let i = 0; i < perms.length; i++) this.requireSrcEnabledPerm(perms[i]);\n\t\t\t} else {\n\t\t\t\tif (!this._enableSrcPerms) this._enableSrcPerms = [];\n\t\t\t\tif (this._enableSrcPerms.indexOf(perms) == -1) this._enableSrcPerms.push(perms);\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n}\n\nexport class ShortDescCopy extends SrcAction<IShortDescCtx> {\n\tconstructor(id?: string) {\n\t\tsuper(id || 'copy');\n\t\tthis._label = \"Copier\";\n\t\tthis._group = \"clipboard\";\n\t\tthis._icon = \"/@skin@/wsp/actions/copyItem.svg\";\n\t\tthis.atLeastOne = true;\n\t}\n\n\texecute(ctx: IShortDescCtx, ev?: Event): Promise<void> {\n\t\treturn ITEM.setShortDescTransferToClipboard(ctx);\n\t}\n\n\tstatic SINGLETON = new ShortDescCopy();\n}\n\n/** Action qui affiche et focus un seul item. */\nexport class FocusItem extends SrcAction<IShortDescCtx> {\n\n\tstatic gotoItem(infoBroker: IInfoBroker, sd: JSrcFields, from: IInfoProducer) {\n\t\tif (infoBroker && sd) {\n\t\t\tif (sd.itSubItem) {\n\t\t\t\tinfoBroker.dispatchInfo(new InfoFocusNodeInItem(`//*[@xml:id='${sd.itSubItem.id}']`, SRC.srcRef(sd), sd), from);\n\t\t\t} else {\n\t\t\t\tinfoBroker.dispatchInfo(new InfoFocusItem(SRC.srcRef(sd), sd), from);\n\t\t\t}\n\t\t}\n\t}\n\n\tconstructor(id?: string) {\n\t\tsuper(id || 'focusItem');\n\t\tthis._label = \"Afficher cet item\";\n\t\tthis._icon = \"/@skin@/wsp/actions/showItem.svg\";\n\t\tthis._group = \"open\";\n\t\tthis.exactOne = true;\n\t\tthis.isNotRemoved = false;\n\t}\n\n\tisVisible(ctx: IShortDescCtx): boolean {\n\t\tif (!ctx.infoBroker) return false;\n\t\tif (ITEM.getSrcUriType(this.getFirstSrcUri(ctx) || '') === \"space\") return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tprotected isVisibleSuper(ctx: IShortDescCtx) {\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tisEnabled(ctx: IShortDescCtx) {\n\t\tif (ITEM.getSrcUriType(this.getFirstSrcUri(ctx) || '') !== \"item\") return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\tprotected isEnabledSuper(ctx: IShortDescCtx) {\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\texecute(ctx: IShortDescCtx, ev?: Event) {\n\t\tFocusItem.gotoItem(ctx.infoBroker, ctx.shortDescs[0], ctx.emitter);\n\t}\n}\n\n/**\n * Focus un item et y recherche une référence d'item donnée\n */\nexport class FocusItemSelRef extends FocusItem {\n\n\tstatic SINGLETON = new FocusItemSelRef();\n\n\texecute(ctx: IShortDescCtx, ev?: Event) {\n\t\t(ctx.reg.env as IWedSearchCoordinatorPointer).wedSearchCoord?.setParamsOnce({\n\t\t\tsearchId: 'item',\n\t\t\tfindRef: SRC.srcRef((ctx.reg.env as IItemUiEnv).longDesc)\n\t\t} as JItemWedSearchBarParams);\n\t\tsuper.execute(ctx, ev);\n\t}\n}\n\nexport class FocusItemOrSpace extends FocusItem {\n\n\tgetLabel(ctx: IShortDescCtx): string {\n\t\treturn ITEM.getSrcUriType(this.getFirstSrcUri(ctx) || '') === \"space\" ? \"Explorer cet espace\" : \"Afficher cet item\";\n\t}\n\n\tisVisible(ctx: IShortDescCtx): boolean {\n\t\tif (!ctx.infoBroker) return false;\n\t\treturn super.isVisibleSuper(ctx);\n\t}\n\n\tisEnabled(ctx: IShortDescCtx) {\n\t\t//res assimilé à un item ?\n\t\tif (!this.getFirstSrcUri(ctx)) return false;\n\t\treturn super.isEnabledSuper(ctx);\n\t}\n}\n\n/**\n *\n */\nexport class OpenFastFindItem extends Action<IRegPointer<IWspUiEnv>> {\n\n\tstatic async fastFind(reg: IReg<IWspUiEnv>, ev?: Event): Promise<JSrcFields | null> {\n\t\t//Chargement asynch de FastFindItem\n\t\tconst target = ev?.target as HTMLElement; //avant async\n\t\tconst {FastFindItem} = await import(\"back/wsp/dialogs/fastFindItem.js\");\n\t\treturn await FastFindItem.openFastFind({\n\t\t\treg,\n\t\t\titemCreator: reg.getPref(\"wsp.createItem\", true) ? ItemCreator.setDefaultConfigFromReg(reg) : undefined\n\t\t}, target || reg.env.uiRoot, ev).onNextClose();\n\t}\n\n\tconstructor() {\n\t\tsuper(\"fastFindItem\");\n\t\tthis._label = \"Recherche rapide\";\n\t\tthis._icon = \"/@skin@/wsp/actions/fastFind.svg\";\n\t\tthis._group = 'search';\n\t}\n\n\tasync execute(ctx: IRegPointer<IWspUiEnv>, ev?: Event) {\n\t\tthis.doWithResult(ctx, await OpenFastFindItem.fastFind(ctx.reg, ev));\n\t}\n\n\tdoWithResult(ctx: IRegPointer<IWspUiEnv>, sd: JSrcFields) {\n\t\tif (sd && ctx.reg.env.infoBroker) {\n\t\t\tctx.reg.env.infoBroker.dispatchInfo(new InfoFocusItem(SRC.srcRef(sd), sd), ctx.reg.env.uiRoot);\n\t\t}\n\t}\n}\n\n/**\n * Ouverture de l'écran de recherche d'item, ou de taches\n */\nexport class OpenSearchItems extends Action<IRegPointer<IWspUiEnv> | IShortDescCtx> {\n\n\tconstructor(protected kind: 'item' | 'task' = 'item') {\n\t\tsuper(\"searchItems\");\n\t\tthis._label = kind === 'item' ? \"Recherche d'items...\" : \"Recherche de tâches...\";\n\t\tthis._icon = \"/@skin@/wsp/actions/search.svg\";\n\t\tthis._group = 'tools';\n\t}\n\n\tasync execute(ctx: IRegPointer<IWspUiEnv> | IShortDescCtx, ev?: Event) {\n\t\t//Chargement asynch d'itemCreator\n\t\tconst {SearchItems} = await import(\"back/wsp/dialogs/searchItems.js\");\n\t\tconst {TaskCritForMe} = await import(\"back/wsp/widgets/search/taskCrit.js\");\n\t\tconst {ItemCritTitleRegExp} = await import(\"back/wsp/widgets/search/itemCrit.js\");\n\t\tconst {UiCritBool} = await import(\"back/wsp/widgets/search/uiCrit.js\");\n\t\tconst {TplRequestsMenu} = await import(\"back/wsp/actions/searchesActions.js\");\n\n\t\tif (this.kind === 'item')\n\t\t\tctx.reg.addToList(\"actions:searchItems:bar:item\", \"tplRequestsMenu\", 1, TplRequestsMenu.makeFromSearchPersistLists(ctx, \"requests:item\", \"requests:item:searchItems:item\"));\n\t\telse\n\t\t\tctx.reg.addToList(\"actions:searchItems:bar:task\", \"tplRequestsMenu\", 1, TplRequestsMenu.makeFromSearchPersistLists(ctx, \"requests:task\", \"requests:item:searchItems:task\"));\n\n\t\tconst sd = (ctx as IShortDescCtx).shortDescs;\n\t\tconst ct = new SearchItems().initialize({\n\t\t\treg: ctx.reg,\n\t\t\tshowMainView: true,\n\t\t\tfromSrcUri: sd && sd[0] && sd[0].srcSt > 0 ? sd[0].srcUri : null,\n\t\t\tfullTextByDefault: true,\n\t\t\tcriterions: ctx.reg.getListAsMap(this.kind === 'item' ? \"wsp.crit.items\" : \"wsp.crit.tasks\"),\n\t\t\tbuildCrit: this.kind === 'task' ? (searchItems) => {\n\t\t\t\tsearchItems.critRoot.appendChild(<h3>Portée</h3>);\n\t\t\t\tsearchItems.critRoot.appendChild(TaskCritForMe.AREA.buildBody(searchItems));\n\t\t\t\tsearchItems.critRoot.appendChild(<h3>Critères</h3>);\n\t\t\t\tconst and = searchItems.critRoot.appendChild(UiCritBool.AREA_AND_ROOT.buildBody(searchItems)) as UiCritBool;\n\t\t\t\tand.insertCrit(ItemCritTitleRegExp.AREA.buildBody(searchItems));\n\t\t\t} : undefined,\n\t\t\tsrcGrid: {\n\t\t\t\tdefaultAction: new SearchItemsSelItem(ctx),\n\t\t\t\tactions: this.kind === 'item' ?\n\t\t\t\t\tctx.reg.mergeLists(\"actions:wsp:shortDesc\", \"actions:searchItem:shortDesc:item\")\n\t\t\t\t\t: ctx.reg.mergeLists(\"actions:wsp:shortDesc:task\", \"actions:searchItem:shortDesc:task\"),\n\t\t\t\taccelKeyMgr: new AccelKeyMgr().initFromMapActions(this.kind === 'item' ?\n\t\t\t\t\tctx.reg.mergeListsAsMap(\"accelkeys:searchItem:shortDesc\", \"accelkeys:wsp:shortDesc:item\")\n\t\t\t\t\t: ctx.reg.mergeListsAsMap(\"accelkeys:wsp:shortDesc:task\", \"accelkeys:wsp:shortDesc:task\"))\n\t\t\t},\n\t\t\tappHeader: {\n\t\t\t\tmainActions: ctx.reg.mergeLists(SearchItems.APPBAR_MAIN_ACTIONS, this.kind === 'item' ? \"actions:searchItems:bar:item\" : \"actions:searchItems:bar:task\"),\n\t\t\t} as OAppHeaderInit<any>,\n\t\t\tsearchStore: ctx.reg.getSvc(this.kind === 'item' ? 'searchStore.item' : 'searchStore.task') as ISearchStore,\n\t\t\tmsgs: this.kind === 'item' ? undefined : {\n\t\t\t\tresultsMore: max => `Plus de ${max} tâches trouvées`,\n\t\t\t\tresultsEmpty: 'Aucune tâche trouvée',\n\t\t\t\tresultsOne: '1 tâche trouvée',\n\t\t\t\tresultsCount: count => `${count} tâches trouvées`,\n\t\t\t},\n\t\t} as OSearchItemsInit);\n\t\tawait POPUP.showDialog(ct, ctx.reg.env.uiRoot, {\n\t\t\ttitleBar: {barLabel: {label: this.kind === 'item' ? \"Recherche d'items\" : \"Recherche de tâches\"}, closeButton: {}},\n\t\t\tresizer: {},\n\t\t\tviewPortX: \"middle\",\n\t\t\tviewPortY: \"middle\",\n\t\t\tinitWidth: \"90vw\",\n\t\t\tinitHeight: \"90vh\"\n\t\t}).onNextClose();\n\t}\n}\n\nclass SearchItemsSelItem extends SrcAction<ISrcGridCtx> {\n\n\tconstructor(public parentCtx: IRegPointer<IWspUiEnv>) {\n\t\tsuper(\"selItem\");\n\t\tthis.exactOne = true;\n\t}\n\n\texecute(ctx: ISrcGridCtx, ev?: Event) {\n\t\tconst sd = ctx.shortDescs[0];\n\t\tif (sd && this.parentCtx.reg.env.infoBroker) {\n\t\t\tPOPUP.findPopupableParent(ctx.me).close();\n\t\t\tthis.parentCtx.reg.env.infoBroker.dispatchInfo(new InfoFocusItem(SRC.srcRef(sd), sd), this.parentCtx.reg.env.uiRoot);\n\t\t}\n\t}\n}\n\n\n/**\n *\n */\nexport class ShowNetItems extends SrcAction<IShortDescCtx> {\n\n\tworkbenchView = \"netItems\";\n\n\tconstructor() {\n\t\tsuper(\"showNetItems\");\n\t\tthis._label = \"Afficher le réseau d'items...\";\n\t\tthis._icon = \"/@skin@/wsp/views/netItems/netItems.svg\";\n\t\tthis._group = 'tools';\n\t\tthis.exactOne = true;\n\t\tthis.noFamilies = [EItemTypeFamily.task];\n\t}\n\n\tisVisible(ctx: IShortDescCtx): boolean {\n\t\tconst workbench = this.findWorkbench(ctx.emitter);\n\t\tif (!workbench) return false;\n\t\tif (!workbench.getTab(this.workbenchView)) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tfindWorkbench(from: Node) {\n\t\treturn DOMSH.findFlatParentElt(from, null, (n): n is Workbench<any> => n instanceof Workbench);\n\t}\n\n\tasync execute(ctx: IShortDescCtx, ev?: Event) {\n\t\t//Chargement asynch d'itemCreator\n\t\tconst workbench = this.findWorkbench(ctx.emitter);\n\t\tif (!workbench) return;\n\t\tconst view = await workbench.showView(this.workbenchView) as NetItems;\n\t\tif (!view) return;\n\t\tconst sd = (ctx as IShortDescCtx).shortDescs;\n\t\tif (sd && sd[0]) view.setRootSrcRef(ITEM.srcRefSub(sd[0]));\n\t}\n}\n\n/**\n *\n */\nexport class ReloadSrc extends SrcAction<IShortDescCtx> {\n\n\tconstructor() {\n\t\tsuper('reloadSrc');\n\t\tthis._label = \"Recharger\";\n\t\tthis._group = \"other\";\n\t\tthis.exactOne = true;\n\t}\n\n\tisVisible(ctx: IShortDescCtx): boolean {\n\t\tif (ITEM.getSrcUriType(this.getFirstSrcUri(ctx) || '') !== \"item\") return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tasync execute(ctx: IShortDescCtx, ev?: Event) {\n\t\tconst wsp = ctx.reg.env.wsp;\n\t\tawait wsp.wspServer.wspsLive.reloadHouse(WSP.buildWspRef(wsp.code, ctx.shortDescs[0]));\n\t\tconst info = new InfoRefreshItemDisplays(SRC.srcRef(ctx.shortDescs[0]));\n\t\t(ctx.reg.env as IInfoBrokerPointer).infoBroker?.dispatchInfo(info, this);\n\t}\n}\n\n\n/**\n * Création d'un item.\n */\nexport class CreateItem<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tconstructor() {\n\t\tsuper('createItem');\n\t\tthis._label = \"Créer un item...\";\n\t\tthis._group = \"create\";\n\t\tthis.zeroOrOne = true;\n\t\t// Perm évaluée dans le contexte src courant. Acceptable si conf ItemCreator sans changement d'espace (spaceUi:\"readOnly)\n\t\tthis._enableSrcPerms = [\"action.src#create.item\"];\n\t}\n\n\tasync execute(ctx: C, ev?: Event): Promise<JSrcFields | null> {\n\t\t//Chargement asynch d'itemCreator\n\t\tconst {ItemCreator} = await import(\"back/wsp/dialogs/itemCreator.js\");\n\t\treturn ItemCreator.openCreateItem(ItemCreator.setDefaultConfigFromReg(ctx.reg, {\n\t\t\titemTypesTree: {textFilter: ''},\n\t\t\tspaceUri: ctx.shortDescs.length > 0 ? ITEM.extractSpaceUri(ctx.shortDescs[0].srcUri) : \"\",\n\t\t\tspaceUi: \"readOnly\",\n\t\t}), \"Créer un item...\", ctx.emitter, ev).onNextClose();\n\t}\n}\n\n/**\n * Création d'un espace.\n */\nexport class CreateSpace<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tconstructor() {\n\t\tsuper('createSpace');\n\t\tthis._label = \"Créer un espace...\";\n\t\tthis._group = \"create\";\n\t\tthis.zeroOrOne = true;\n\t\t// FIXME : en l'état, cette perm est évaluée sur le noeud courant, et non pas sur l'espace parent (si on est dans le contexte d'un item)\n\t\t//\t\t=> potentiellement faux\n\t\t//\t\tcontournement partiel en ajoutant un contrôle dans le execute\n\t\tthis._enableSrcPerms = [\"action.src#create.space\"];\n\t}\n\n\tasync execute(ctx: C, ev?: Event): Promise<JSrcFields> {\n\t\tconst reg: IReg<IWspUiEnv> = REG.getReg(ctx);\n\t\t//Chargement asynch\n\t\tconst {SrcNewCode} = await import(\"back/wsp/dialogs/srcNewCode.js\");\n\n\t\tconst parentSrcUri = this.getParentSpace(ctx, ev);\n\n\t\t// Evaluation des perms sur l'espace parent effectif (cf FIXME ci dessus)\n\t\tif (ctx.shortDescs && parentSrcUri !== ctx.shortDescs[0]?.srcUri) {\n\t\t\tconst parentShortDesc = await WSP.fetchShortDesc(reg.env.wsp, ctx.emitter, parentSrcUri);\n\t\t\tif (!reg.hasPermission(this._enableSrcPerms, parentShortDesc.srcRoles, reg.env.universe.auth.currentUser.isSuperAdmin, parentShortDesc.srcRi)) {\n\t\t\t\tERROR.show(\"Vous ne disposez pas des autorisations nécessaires pour effectuer cette création d'espace.\", null, ctx);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tconst name = ITEM.extractSpaceLabel(parentSrcUri);\n\t\tconst ti = parentSrcUri ? `Créer un espace en fils de \"${name}\"` : \"Créer un espace à la racine de l'atelier...\";\n\t\tconst ct = new SrcNewCode().initialize({\n\t\t\treg: ctx.reg,\n\t\t\tparentFolder: parentSrcUri,\n\t\t\ttargetSrcUriType: \"space\"\n\t\t});\n\t\tconst newCode = await POPUP.showDialog<string>(ct, ctx.emitter, {titleBar: {barLabel: {label: ti}}}).onNextClose();\n\t\treturn newCode ? WSP.createSpaceOrFolder(ctx.reg.env.wsp, null, ctx.emitter, SRC.addLeafToUri(parentSrcUri, newCode)) : null;\n\t}\n\n\tprotected getParentSpace(ctx: C, ev?: Event) {\n\t\treturn ctx.shortDescs.length > 0 ? ITEM.extractSpaceUri(ctx.shortDescs[0].srcUri) : \"\";\n\t}\n}\n\n/**\n * Suppression d'une source.\n */\nexport class DeleteSrc extends SrcAction<IShortDescCtx> {\n\n\tconstructor() {\n\t\tsuper('delSrc');\n\t\tthis._label = \"Supprimer\";\n\t\tthis._group = \"edit\";\n\t\tthis.atLeastOne = true;\n\t\tthis._enableSrcPerms = [\"write.node.delete\"];\n\t}\n\n\tasync execute(ctx: IShortDescCtx, ev?: Event) {\n\t\tlet ok: boolean;\n\t\tif (ctx.shortDescs.length === 1) {\n\t\t\tconst uri = ctx.shortDescs[0].srcUri;\n\t\t\tconst leafName = SRC.extractLeafFromUri(uri);\n\t\t\tswitch (ITEM.getSrcUriType(uri)) {\n\t\t\tcase 'item':\n\t\t\t\tok = await POPUP.confirm(`Supprimer cet item \"${leafName}\" de l'atelier ?`, ctx.emitter);\n\t\t\t\tbreak;\n\t\t\tcase 'space':\n\t\t\t\tok = await POPUP.confirm(`Supprimer cet espace \"${leafName}\" de l'atelier ?`, ctx.emitter);\n\t\t\t\tbreak;\n\t\t\tcase 'res':\n\t\t\t\tconst itemName = ITEM.extractItemCode(uri);\n\t\t\t\tok = await POPUP.confirm(`Supprimer cette ressource \"${leafName}\" de l'item \"${itemName}\" ?`, ctx.emitter);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\tconst length = ctx.shortDescs.length;\n\t\t\tok = await POPUP.confirm(`Supprimer ces ${length} éléments de l'atelier ?`, ctx.emitter);\n\t\t}\n\t\tif (ok) {\n\t\t\ttry {\n\t\t\t\tawait WSP.srcDelete(ctx.reg.env.wsp, ctx.emitter, ctx.shortDescs.map(SRC.srcRef));\n\t\t\t} catch (e) {\n\t\t\t\tERROR.report(\"Une erreur est survenue lors de la suppression.\", e, ctx);\n\t\t\t}\n\t\t}\n\t}\n}\n\n/** Flag indiquant qu'on est sur une action de déplacement d'une source (rename, move...) */\nexport interface IMoveAction {\n\tisMove?: boolean\n}\n\nexport class MoveToSrc<C extends IShortDescCtx> extends SrcAction<C> implements IMoveAction {\n\n\t/** Filtre indiquant les noeuds susceptibles d'être des cible du déplacement acceptables en fonction des sources. */\n\tstatic makeTargetFilter(srcs: JSrcFields[]): (srcUri: srcUri) => boolean {\n\t\t//dossiers des fichiers sources sélectionnés\n\t\tconst folderEntries = new Set<srcUri>();\n\t\t//sources sélectionnés de type dossier\n\t\tconst folders = [] as srcUri[];\n\t\tfor (const src of srcs) {\n\t\t\tfolderEntries.add(SRC.extractUriParent(src.srcUri));\n\t\t\tif (src.srcSt === ESrcSt.folder) folders.push(src.srcUri);\n\t\t}\n\t\treturn (srcUri: srcUri): boolean => {\n\t\t\t//on ne peut sélectionner le dossier d'un des fichiers sélectionnés\n\t\t\tif (folderEntries.has(srcUri)) return false;\n\t\t\t//ni toute la descendance des dossiers sélectionnés.\n\t\t\tfor (const folder of folders) if (SRC.isSubUriOrEqual(folder, srcUri)) return false;\n\t\t\treturn true;\n\t\t};\n\t}\n\n\ttargetFolder?: srcUri | JSrcFields;\n\ttargetFolderUi?: 'choose' | 'hide';\n\n\t//TODO airItem?: 'never' | 'forced' | 'prefered' | 'allowed';\n\n\t_titlePopup = \"Déplacer vers...\";\n\t_moveButtonLabel = \"Déplacer\";\n\n\tconstructor(id?: string) {\n\t\t// FIXME : contrôle perms sur la dst\n\t\t// @see eu.scenari.wsp.service.wspsrc.SvcWspSrcDialog.checkPermForCopy\n\t\t// @see  eu.scenari.wsp.service.wspsrc.SvcWspSrcDialog.checkPermForMove\n\t\tsuper(id || 'moveSrc');\n\t\tthis._label = \"Déplacer...\";\n\t\tthis._group = \"edit\";\n\t\tthis.atLeastOne = true;\n\t\t// Contrôle de perm sur la dst dans `isEnabled` quand l'information de target est disponible,\n\t\t// ou dans execute quand elle n'est pas disponible\n\t\tthis._enableSrcPerms = [\"write.node.moveFrom\"];\n\t}\n\n\tisVisible(ctx: C): boolean {\n\t\tif (!super.isVisible(ctx)) return false;\n\t\tif (ctx.reg.getPref(\"wsp.hideWspStruct\")) return false;\n\t\treturn true;\n\t}\n\n\tisEnabled(ctx: C): boolean {\n\t\t// Si la cible est connue, on peut vérifier dessus la perm\n\t\tif (!this.canChooseTarget && typeof this.targetFolder === 'object')\n\t\t\tif (!REG.getReg(ctx).hasPermission(\"action.src#moveTo\", this.targetFolder.srcRoles, null, this.targetFolder.srcRi)) return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\tget isMove(): boolean {return true}\n\n\tsetTarget(space: srcUri | JSrcFields, targetSpaceUi: 'choose' | 'hide', /*airItem?: 'never' | 'forced' | 'prefered' | 'allowed'*/): this {\n\t\tthis.targetFolder = space;\n\t\tthis.targetFolderUi = targetSpaceUi || 'choose';\n\t\t//this.airItem = airItem || 'never';\n\t\treturn this;\n\t}\n\n\tget canChooseTarget(): boolean {return this.targetFolderUi == null || this.targetFolderUi === 'choose'}\n\n\t/** Retourne les uris déplaceées. */\n\tasync execute(ctx: C, ev?: Event): Promise<srcUri[]> {\n\t\tconst srcs = ctx.shortDescs.concat(); //raceCond stabilisation de la liste (traitements async).\n\t\tconst targetUriFilter = MoveToSrc.makeTargetFilter(srcs);\n\n\t\t//0 - save all en //\n\t\tconst saving = ctx.reg.env.wsp.wspServer.wspsLive.saveAllHouses();\n\n\t\t//1 - espace cible\n\t\tlet targetFolder = this.targetFolder;\n\n\t\tfunction targetSrcUri(target: srcUri | JSrcFields) {\n\t\t\treturn target != null ? (typeof target === 'object' ? target.srcUri : target) : null;\n\t\t}\n\n\t\tif (this.canChooseTarget) {\n\t\t\t//Chargement asynch\n\t\t\tconst {SpaceSelector} = await import(\"back/wsp/dialogs/spaceSelector.js\");\n\t\t\tconst spaceSelector = new SpaceSelector().initialize({\n\t\t\t\treg: ctx.reg,\n\t\t\t\tstartSel: targetSrcUri(this.targetFolder) != null ? targetSrcUri(this.targetFolder) : ITEM.extractSpaceUri(this.getFirstSrcUri(ctx)),\n\t\t\t\tbuttonLabel: this._moveButtonLabel,\n\t\t\t\tspaceTree: {\n\t\t\t\t\tshowRoot: true\n\t\t\t\t},\n\t\t\t\tonSelChange: (src: JSrcFieldsTree, spSel: SpaceSelector) => {\n\t\t\t\t\tif (!src) spSel.setMsg(\"Sélectionnez l'espace cible du déplacement.\", false);\n\t\t\t\t\telse if (spSel.evalPerm(\"action.src#moveTo\", src, \"Vous ne disposez pas des droits pour déplacer vers cet espace.\", \"Il est impossible de déplacer un contenu vers cet espace.\")) {\n\t\t\t\t\t\tif (targetUriFilter(src.srcUri)) spSel.setMsg(null, true);\n\t\t\t\t\t\telse spSel.setMsg(\"Cet espace ne peut pas être la cible du déplacement.\", false);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tspaceSelector.spaceTree.grid.lineDrawer = {\n\t\t\t\tredrawLine(row: IGridDataRow, line: HTMLElement): void {\n\t\t\t\t\tDOM.setStyle(line, \"color\", targetUriFilter((row.rowKey as JSrcFieldsTree).srcUri) ? \"\" : \"gray\");\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tspaceSelector.doSelect = async function (this: SpaceSelector) {\n\t\t\t\tconst spSrc = this.spaceTree.shortDescs[0];\n\t\t\t\tif (!spSrc) return;\n\t\t\t\tif (!await checkForConflicts(ctx, srcs, spSrc.srcUri)) return;\n\t\t\t\tthis.constructor.prototype.doSelect.call(this);\n\t\t\t};\n\n\t\t\tconst spSel = await POPUP.showDialog<JSrcFields>(spaceSelector, ctx.emitter, {titleBar: {barLabel: {label: this._titlePopup}}, resizer: {}}).onNextClose();\n\t\t\ttargetFolder = spSel ? spSel.srcUri : null;\n\t\t} else {\n\t\t\tif (targetFolder == null) return null;\n\t\t\tif (!await checkForConflicts(ctx, srcs, targetSrcUri(targetFolder), 'move')) return null;\n\t\t}\n\n\t\t//2 - déplacement\n\t\tif (targetFolder != null && targetUriFilter(targetSrcUri(targetFolder))) {\n\t\t\ttry {\n\t\t\t\tawait saving;\n\t\t\t} catch (e) {\n\t\t\t\tERROR.report(\"Une erreur est survenue durant l'enregistrement préalable de vos éditions en cours. Le déplacement a été annulé.\", e, ctx);\n\t\t\t}\n\t\t\ttry {\n\t\t\t\treturn await WSP.srcMoveTo(ctx.reg.env.wsp, ctx.emitter, srcs.map((s) => s.srcUri), targetSrcUri(targetFolder));\n\t\t\t} catch (e) {\n\t\t\t\tMoveToSrc.notifError(ctx, e);\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tstatic async notifError(ctx: IShortDescCtx, e: any) {\n\t\tswitch (await ERROR.extractDescError(e)) {\n\t\tcase \"sourceNotFound\":\n\t\t\treturn POPUP.confirm(\"La source du déplacement n'existe plus.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"sourceUriAlreadyUsedInMasterOrOtherLayer\" :\n\t\t\treturn POPUP.confirm(\"Le même chemin source est utilisé par l'atelier principal ou un autre atelier calque, le déplacement est impossible.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"targetUriAlreadyUsedInMasterOrOtherLayer\" :\n\t\t\treturn POPUP.confirm(\"Le chemin cible de ce déplacement est utilisé par l'atelier principal ou un autre atelier calque, le déplacement est impossible.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"sourceUsedWhereFolderTargetIsNot\" :\n\t\t\treturn POPUP.confirm(\"Une ressource à déplacer est déjà exploitée dans l'atelier principal ou un autre atelier calque. Elle ne peut être déplacée dans un espace local à un calque.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"conflictUri\" :\n\t\t\treturn POPUP.confirm(\"Le chemin cible de ce déplacement est en conflit avec un autre contenu car une simple différence de casse (minuscule/majuscule) est interdite, le déplacement est impossible.\", ctx.emitter, {cancelLbl: null});\n\t\tdefault:\n\t\t\tif (e.response?.status === 403) {\n\t\t\t\treturn ERROR.show(\"Vous ne disposez pas des autorisations nécessaires pour effectuer ce déplacement.\", null, ctx);\n\t\t\t} else {\n\t\t\t\treturn ERROR.report(\"Une erreur est survenue lors du déplacement.\", e, ctx);\n\t\t\t}\n\t\t}\n\t}\n\n}\n\n/** Demandes de confirmations en cas d'écrasement / fusion de contenu pour les actions de MoveTo / CopyTo. */\nasync function checkForConflicts(ctx: IShortDescCtx, srcs: JSrcFields[], targetFolder: srcUri, alwaysConfirm?: 'move'): Promise<boolean> {\n\tconst spEntries = await new FolderEntries(ctx.reg.env.wsp, ctx.emitter).setFolderUri(targetFolder);\n\tconst conflicts = srcs.filter((s) => spEntries.getChildStateNow(SRC.extractLeafFromUri(s.srcUri)) === 'used');\n\tif (conflicts.length > 0) {\n\t\tconst conflictFiles = conflicts.filter((s) => s.srcSt === ESrcSt.file);\n\t\t//FIXME personnaliser message si espaces ou dossier de ressources...\n\t\tconst itemList = conflictFiles.map((s) => SRC.extractLeafFromUri(s.srcUri)).join(', ');\n\t\tconst space = ITEM.extractSrcLabel(targetFolder, \"[Racine de l'atelier]\");\n\t\tif (conflictFiles.length > 0 && conflictFiles.length < conflicts.length) {\n\t\t\treturn await POPUP.confirm(`Attention, les contenus [${itemList}] dans '${space}' vont être écrasés et les espaces fusionnés.`, ctx.emitter, {okLbl: \"Écraser et fusionner\", kind: \"warning\"});\n\t\t} else if (conflictFiles.length > 0) {\n\t\t\treturn await POPUP.confirm(`Attention, les contenus [${itemList}] dans '${space}' vont être écrasés.`, ctx.emitter, {okLbl: \"Écraser\", kind: \"warning\"});\n\t\t} else {\n\t\t\treturn await POPUP.confirm(`Attention, des espaces dans '${space}' vont être fusionnés (et leurs contenus potentiellement écrasés).`, ctx.emitter, {okLbl: \"Fusionner\", kind: \"warning\"});\n\t\t}\n\t} else if (alwaysConfirm === 'move') {\n\t\tconst space = ITEM.extractSrcLabel(targetFolder, \"[Racine de l'atelier]\");\n\t\tconst numItems = srcs.length;\n\t\treturn await POPUP.confirm(`Confirmez le déplacement de ${numItems} contenu(s) vers '${space}'.`, ctx.emitter, {okLbl: \"Déplacer\"});\n\t}\n\treturn true;\n}\n\n\n/**\n * Copie un ensemble de sources vers une cible donnée *du même* atelier.\n * Si certaines sources sont déjà dans la cible, elles restent inchangées.\n * Il est impossible de définir une cible dans uri descendante d'une des sources.\n */\nexport class CopyToSrc<C extends IShortDescCtx> extends SrcAction<C> {\n\n\t/** Filtre indiquant les noeuds susceptibles d'être des cibles de la copie acceptables en fonction des sources. */\n\tstatic makeTargetFilter(srcs: JSrcFields[]): (srcUri: srcUri) => boolean {\n\t\t//sources sélectionnés de type dossier\n\t\tconst folders = [] as srcUri[];\n\t\tfor (const src of srcs) {\n\t\t\tif (src.srcSt === ESrcSt.folder) folders.push(src.srcUri);\n\t\t}\n\t\treturn (srcUri: srcUri): boolean => {\n\t\t\t//on ne peut sélectionner toute la descendance des dossiers sélectionnés.\n\t\t\tfor (const folder of folders) if (SRC.isSubUriOrEqual(folder, srcUri)) return false;\n\t\t\treturn true;\n\t\t};\n\t}\n\n\ttargetFolder?: srcUri | JSrcFields;\n\ttargetFolderUi?: 'choose' | 'hide';\n\n\t//TODO airItem?: 'never' | 'forced' | 'prefered' | 'allowed';\n\n\tconstructor(id?: string, label?: string, group?: string) {\n\t\tsuper(id || \"copyToSrc\");\n\t\tthis._label = label || \"Dupliquer vers...\";\n\t\tthis._group = group || \"clone\";\n\t\tthis.atLeastOne = true;\n\t\t// Contrôle de perm sur la dst dans `isEnabled` quand l'information de target est disponible,\n\t\t// ou dans execute quand elle n'est pas disponible\n\t\tthis._enableSrcPerms = [\"read.node.copyFrom\"];\n\t}\n\n\tsetTarget(space: srcUri | JSrcFields, targetSpaceUi: 'choose' | 'hide', /*airItem?: 'never' | 'forced' | 'prefered' | 'allowed'*/): this {\n\t\tthis.targetFolder = space;\n\t\tthis.targetFolderUi = targetSpaceUi || 'choose';\n\t\t//this.airItem = airItem || 'never';\n\t\treturn this;\n\t}\n\n\tget canChooseTarget(): boolean {return this.targetFolderUi == null || this.targetFolderUi === 'choose'}\n\n\tisEnabled(ctx: C): boolean {\n\t\t// Si la cible est connue, on peut vérifier dessus la perm\n\t\tif (!this.canChooseTarget && typeof this.targetFolder === 'object')\n\t\t\tif (!REG.getReg(ctx).hasPermission(\"action.src#copyTo\", this.targetFolder.srcRoles, null, this.targetFolder.srcRi)) return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\n\t/** Retourne les uri dupliqués. */\n\tasync execute(ctx: IShortDescCtx, ev?: Event): Promise<srcUri[]> {\n\t\tconst srcs = ctx.shortDescs.concat(); //raceCond stabilisation de la liste (traitements async).\n\t\t//0 - Filtre des cibles possibles\n\t\tconst targetUriFilter = CopyToSrc.makeTargetFilter(srcs);\n\n\t\t//1 - espace cible\n\t\tlet targetFolder = this.targetFolder;\n\n\t\tfunction targetSrcUri(target: srcUri | JSrcFields) {\n\t\t\treturn target != null ? (typeof target === 'object' ? target.srcUri : target) : null;\n\t\t}\n\n\t\tif (this.canChooseTarget) {\n\t\t\t//Chargement asynch\n\t\t\tconst {SpaceSelector} = await import(\"back/wsp/dialogs/spaceSelector.js\");\n\t\t\tconst spaceSelector = new SpaceSelector().initialize({\n\t\t\t\treg: ctx.reg,\n\t\t\t\tstartSel: targetSrcUri(this.targetFolder) != null ? targetSrcUri(this.targetFolder) : ITEM.extractSpaceUri(this.getFirstSrcUri(ctx)),\n\t\t\t\tbuttonLabel: \"Dupliquer vers...\",\n\t\t\t\tspaceTree: {\n\t\t\t\t\tshowRoot: true\n\t\t\t\t},\n\t\t\t\tonSelChange: (src: JSrcFieldsTree, spSel: SpaceSelector) => {\n\t\t\t\t\tif (!src) spSel.setMsg(\"Sélectionnez l'espace cible de la copie.\", false);\n\t\t\t\t\telse if (spSel.evalPerm(\"action.src#copyTo\", src, \"Vous ne disposez pas des droits de copie dans cet espace.\", \"Impossible de copier dans cet espace.\")) {\n\t\t\t\t\t\tif (targetUriFilter(src.srcUri)) spSel.setMsg(null, true);\n\t\t\t\t\t\telse spSel.setMsg(\"Cet espace, contenu dans une source à copier, ne peut pas être la cible de la copie.\", false);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tspaceSelector.spaceTree.grid.lineDrawer = {\n\t\t\t\tredrawLine(row: IGridDataRow, line: HTMLElement): void {\n\t\t\t\t\tDOM.setStyle(line, \"color\", targetUriFilter((row.rowKey as JSrcFieldsTree).srcUri) ? \"\" : \"gray\");\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tspaceSelector.doSelect = async function (this: SpaceSelector) {\n\t\t\t\tconst spSrc = this.spaceTree.shortDescs[0];\n\t\t\t\tif (!spSrc) return;\n\t\t\t\tif (!await checkForConflicts(ctx, srcs, spSrc.srcUri)) return;\n\t\t\t\tthis.constructor.prototype.doSelect.call(this);\n\t\t\t};\n\n\t\t\tconst spSel = await POPUP.showDialog<JSrcFields | null>(spaceSelector, ctx.emitter, {titleBar: {barLabel: {label: \"Dupliquer vers...\"}}}).onNextClose();\n\t\t\ttargetFolder = spSel ? spSel.srcUri : null;\n\t\t} else {\n\t\t\tif (targetFolder == null) return null;\n\t\t\tif (!await checkForConflicts(ctx, srcs, targetSrcUri(targetFolder))) return null;\n\t\t}\n\n\t\t//2 - copie\n\t\tif (targetFolder != null && targetUriFilter(targetSrcUri(targetFolder))) {\n\t\t\ttry {\n\t\t\t\treturn await WSP.srcCopyTo(ctx.reg.env.wsp, ctx.emitter, srcs.map((s) => s.srcUri), targetSrcUri(targetFolder));\n\t\t\t} catch (e) {\n\t\t\t\tif (e.response?.status === 403) {\n\t\t\t\t\tERROR.show(\"Vous ne disposez pas des autorisations nécessaires pour effectuer cette copie.\", null, ctx);\n\t\t\t\t} else {\n\t\t\t\t\tERROR.report(\"Une erreur est survenue lors de la copie.\", e, ctx);\n\t\t\t\t}\n\t\t\t\tconsole.error(e);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n}\n\n\n/**\n * Import à partir d'une source externe (IShortDescsTransfer.isImport === true).\n */\nexport class ImportItemsToSrc<C extends IShortDescCtx> extends SrcAction<C> {\n\n\ttransfer: IShortDescsTransfer;\n\n\ttargetFolder?: srcUri;\n\ttargetFolderUi?: 'choose' | 'hide';\n\n\t//TODO airItem?: 'never' | 'forced' | 'prefered' | 'allowed';\n\n\tconstructor(transfer: IShortDescsTransfer, id?: string, label?: string, group?: string) {\n\t\tsuper(id || \"importToSrc\");\n\t\tif (!transfer.isImport) throw Error(\"ShortDescsTransfer.isImport is false!!\");\n\t\tthis.transfer = transfer;\n\t\tthis._label = label || \"Importer...\";\n\t\tthis._group = group || \"clone\";\n\t\t//this.atLeastOne = true; pas compat avec ShortDescsFromUriList qui ne connait pas encore sa liste de shortDescs sur le dragover\n\t}\n\n\tsetTarget(space: srcUri, targetSpaceUi: 'choose' | 'hide', /*airItem?: 'never' | 'forced' | 'prefered' | 'allowed'*/): this {\n\t\tthis.targetFolder = space;\n\t\tthis.targetFolderUi = targetSpaceUi || 'choose';\n\t\t//this.airItem = airItem || 'never';\n\t\treturn this;\n\t}\n\n\t/** Retourne les uri dupliqués. */\n\tasync execute(ctx: IShortDescCtx, ev?: Event): Promise<JSrcFields[]> {\n\t\t//1 - choix espace cible\n\t\tlet targetFolder = this.targetFolder;\n\t\tif (this.targetFolderUi == null || this.targetFolderUi === 'choose') {\n\t\t\t//Chargement asynch\n\t\t\tconst {SpaceSelector} = await import(\"back/wsp/dialogs/spaceSelector.js\");\n\t\t\tconst spaceSelector = new SpaceSelector().initialize({\n\t\t\t\treg: ctx.reg,\n\t\t\t\tstartSel: this.targetFolder != null ? this.targetFolder : ITEM.extractSpaceUri(this.getFirstSrcUri(ctx)),\n\t\t\t\tbuttonLabel: \"Importer\",\n\t\t\t\tspaceTree: {\n\t\t\t\t\tshowRoot: true\n\t\t\t\t},\n\t\t\t\tonSelChange: (src: JSrcFieldsTree, spSel: SpaceSelector) => {\n\t\t\t\t\tif (!src) spSel.setMsg(\"Sélectionnez l'espace cible de la copie\", false);\n\t\t\t\t\telse if (spSel.evalPerm(\"action.src#importTo\", src, \"Vous ne disposez pas des droits pour importer dans cet espace\", \"Impossible d'importer dans cet espace\")) {\n\t\t\t\t\t\tspSel.setMsg(null, true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst spSel = await POPUP.showDialog<JSrcFields>(spaceSelector, ctx.emitter, {titleBar: {barLabel: {label: \"Importer vers...\"}}}).onNextClose();\n\t\t\ttargetFolder = spSel ? spSel.srcUri : null;\n\t\t}\n\n\t\t//2 - import\n\t\tif (targetFolder != null) {\n\t\t\ttry {\n\t\t\t\tconst imports = [] as JSrcFields[];\n\t\t\t\tconst options = {\n\t\t\t\t\ttargetSrcType: ITEM.getSrcUriType(targetFolder) === 'space' ? 'itemOrSpace' : 'res',\n\t\t\t\t\tdefaultUriParent: targetFolder,\n\t\t\t\t\tallowReplace: true,\n\t\t\t\t\trepeatedImports: this.transfer.shortDescs.length > 1 ? {} : undefined\n\t\t\t\t} as OImportSrcOptions;\n\t\t\t\tfor (const datas of this.transfer.shortDescs) {\n\t\t\t\t\tif (datas.createSrc) {\n\t\t\t\t\t\tconst src = await datas.createSrc(options);\n\t\t\t\t\t\tif (src) imports.push(src);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn imports.length > 0 ? imports : null;\n\t\t\t} catch (e) {\n\t\t\t\tawait ERROR.report(\"Une erreur est survenue lors de l'import.\", e, ctx);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n}\n\n\n/**\n * Renomme une source sans déplacement.\n */\n\nexport class RenameSrc<C extends IShortDescCtx> extends SrcAction<C> implements IMoveAction {\n\n\tconstructor() {\n\t\tsuper('renameSrc');\n\t\tthis._label = \"Renommer...\";\n\t\tthis._group = \"edit\";\n\t\tthis.atLeastOne = true;\n\t\t// Perm \"enabled\" dans {@link RenameSrc.isEnabled} car dépendante de la nature de la src (space, item)\n\t}\n\n\tisEnabled(ctx: IShortDescCtx): boolean {\n\t\tconst reg = REG.getReg(ctx);\n\t\tfor (const sd of ctx.shortDescs)\n\t\t\tif (!reg.hasPermission(ITEM.getSrcUriType(sd.srcUri) === \"space\" ? \"rename.space\" : \"rename.item\", sd.srcRoles, null, sd.srcRi)) return false;\n\t\t//Pas de renommage possible si on pointe au moins un item externe\n\t\treturn super.isEnabled(ctx as C) && ctx.shortDescs.findIndex((src) => ITEM.isExtItem(src.srcUri)) < 0;\n\t}\n\n\tget isMove(): boolean {return true}\n\n\tasync execute(ctx: IShortDescCtx, ev?: Event): Promise<srcUri[]> {\n\t\tconst srcs = ctx.shortDescs.concat(); //raceCond stabilisation de la liste (traitements async).\n\t\tconst results: srcUri[] = [];\n\t\t//0 - save all en //\n\t\tconst saving = ctx.reg.env.wsp.wspServer.wspsLive.saveAllHouses();\n\t\t//Chargement asynch\n\t\tconst {SrcNewCode} = await import(\"back/wsp/dialogs/srcNewCode.js\");\n\t\tfor (let i = 0; i < srcs.length; i++) {\n\t\t\tconst src = srcs[i];\n\t\t\tconst ct = new SrcNewCode().initialize({\n\t\t\t\treg: ctx.reg,\n\t\t\t\tparentFolder: ITEM.isAirItem(src.srcUri) ? null : SRC.extractUriParent(src.srcUri),\n\t\t\t\tcurrentCode: SRC.extractLeafFromUri(src.srcUri),\n\t\t\t\ttargetSrcUriType: ITEM.getSrcUriType(src.srcUri),\n\t\t\t\tdoBtnLabel: \"Renommer\"\n\t\t\t});\n\t\t\tconst newCode = await POPUP.showDialog<string>(ct, ctx.emitter, {titleBar: {barLabel: {label: \"Renommer...\"}}}).onNextClose();\n\t\t\tif (newCode) {\n\t\t\t\ttry {\n\t\t\t\t\tawait saving;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tawait ERROR.report(\"Une erreur est survenue durant l'enregistrement préalable de vos modifications en cours. Le renommage a été annulé.\", e, ctx);\n\t\t\t\t}\n\t\t\t\ttry {\n\t\t\t\t\tresults.push(await WSP.srcRename(ctx.reg.env.wsp, ctx.emitter, src, newCode));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tRenameSrc.notifError(ctx, e);\n\t\t\t\t}\n\t\t\t} else if (i < srcs.length - 1) {\n\t\t\t\tconst count = srcs.length - i - 1;\n\t\t\t\tif (!await POPUP.confirm(`Il reste ${count} à renommer dans votre sélection initiale.`, ctx.emitter, {okLbl: \"Poursuivre le renommage\", cancelLbl: \"Abandonner\"})) break;\n\t\t\t}\n\t\t}\n\t\treturn results\n\t}\n\n\tstatic async notifError(ctx: IShortDescCtx, e: any) {\n\t\tswitch (await ERROR.extractDescError(e)) {\n\t\tcase \"sourceNotFound\":\n\t\t\treturn POPUP.confirm(\"La source du renommage n'existe plus.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"sourceUriAlreadyUsedInMasterOrOtherLayer\" :\n\t\t\treturn POPUP.confirm(\"Le même chemin source est utilisé par l'atelier principal ou un autre atelier calque, le renommage est impossible.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"targetUriAlreadyUsedInMasterOrOtherLayer\" :\n\t\t\treturn POPUP.confirm(\"Le chemin cible de ce renommage est utilisé par l'atelier principal ou un autre atelier calque, le déplacement est impossible.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"conflictUri\" :\n\t\t\treturn POPUP.confirm(\"Un renommage avec un simple changement de casse (minuscule/majuscule) est interdit.\", ctx.emitter, {cancelLbl: null});\n\t\tdefault:\n\t\t\treturn ERROR.report(\"Une erreur est survenue lors du renommage.\", e, ctx);\n\t\t}\n\t}\n}\n\n\n/**\n * Duplique unitairement chaque ressource **dans son propre espace** (ou en airItem si la source est en airItem).\n * Attention, même en sélection multiple, les actions sont unitaires : 2 items dupliqués qui se référencent mutuellement\n * garderont leur référence vers l'item d'origine et non vers l'autre item dupliqué.\n */\nexport class DuplicateSrc<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"duplicateSrc\");\n\t\tthis._group = \"clone\";\n\t\tthis.atLeastOne = true;\n\t\tthis._enableSrcPerms = [\"write.node.duplicate\"];\n\t}\n\n\tgetLabel(ctx: C) {\n\t\tif (this._label) return super.getLabel(ctx);\n\t\t// Si plusieurs sources : \"un à un\" pour exprimer l'idée que les refs des items dupliqués continueront à pointer\n\t\t// les items sources et non les autres items dupliqués.\n\t\treturn ctx.shortDescs.length > 1 ? \"Dupliquer un à un...\" : \"Dupliquer...\";\n\t}\n\n\t/** Retourne le ou les srcUris dupliqués. */\n\tasync execute(ctx: IShortDescCtx, ev?: Event): Promise<srcUri[]> {\n\t\tconst srcs = ctx.shortDescs.concat(); //raceCond stabilisation de la liste (traitements async).\n\t\tconst results: srcUri[] = [];\n\t\t//Chargement asynch\n\t\tconst {SrcNewCode} = await import(\"back/wsp/dialogs/srcNewCode.js\");\n\t\tfor (let i = 0; i < srcs.length; i++) {\n\t\t\tconst src = srcs[i];\n\t\t\tconst newCodeUi = new SrcNewCode().initialize({\n\t\t\t\treg: ctx.reg,\n\t\t\t\tparentFolder: ITEM.isAirItem(src.srcUri) ? null : SRC.extractUriParent(src.srcUri),\n\t\t\t\tcurrentCode: SRC.extractLeafFromUri(src.srcUri),\n\t\t\t\ttargetSrcUriType: ITEM.getSrcUriType(src.srcUri),\n\t\t\t\tdoBtnLabel: \"Dupliquer\"\n\t\t\t});\n\t\t\tconst newCode = await POPUP.showDialog<string>(newCodeUi, ctx.emitter, {titleBar: {barLabel: {label: \"Dupliquer...\"}}}).onNextClose();\n\t\t\tif (newCode) {\n\t\t\t\ttry {\n\t\t\t\t\tresults.push(await WSP.srcDuplicate(ctx.reg.env.wsp, ctx.emitter, src, newCode));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tDuplicateSrc.notifError(ctx, e);\n\t\t\t\t}\n\t\t\t} else if (i < srcs.length - 1) {\n\t\t\t\tconst count = srcs.length - i - 1;\n\t\t\t\tif (!await POPUP.confirm(`Il reste ${count} contenus à dupliquer dans votre sélection initiale.`, ctx.emitter, {okLbl: \"Poursuivre la duplication\", cancelLbl: \"Abandonner\"})) break;\n\t\t\t}\n\t\t}\n\t\treturn results;\n\t}\n\n\tstatic async notifError(ctx: IShortDescCtx, e: any) {\n\t\tswitch (await ERROR.extractDescError(e)) {\n\t\tcase \"sourceNotFound\":\n\t\t\treturn POPUP.confirm(\"La source de la duplication n'existe plus.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"targetUriAlreadyUsedInMasterOrOtherLayer\" :\n\t\t\treturn POPUP.confirm(\"Le chemin cible de cette duplication est utilisé par l'atelier principal ou un autre atelier calque, la duplication est impossible.\", ctx.emitter, {cancelLbl: null});\n\t\tcase \"conflictUri\" :\n\t\t\treturn POPUP.confirm(\"Le chemin cible de cette duplication est en conflit avec un autre contenu car une simple différence de casse (minuscule/majuscule) est interdite, la duplication est impossible.\", ctx.emitter, {cancelLbl: null});\n\t\tdefault:\n\t\t\treturn ERROR.report(\"Une erreur est survenue lors de la duplication.\", e, ctx);\n\t\t}\n\t}\n}\n\n/**\n * Importe des fichiers externes dans le contexte shortDesc courant.\n * Impl limitée à l'import d'items, à revoir pour l'import de res dans un item folder.\n */\nexport class ImportFiles<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tconstructor(id?: string) {\n\t\tsuper(id || 'importFile');\n\t\tthis._label = \"Importer un fichier...\";\n\t\tthis._group = \"importExport\";\n\t\tthis.zeroOrOne = true;\n\t\tthis._enableSrcPerms = [\"write.node.import\"];\n\t}\n\n\tasync execute(ctx: C, ev?: Event): Promise<JSrcFields[] | null> {\n\t\t//FIXME utiliser https://wicg.github.io/file-system-access/#api-showopenfilepicker (en attente impl par Firefox).\n\t\tconst input = document.createElement('input');\n\t\tinput.type = \"file\";\n\t\tinput.multiple = true;\n\t\tinput.click();\n\t\tconst files = await new Promise<FileList>((resolve) => {\n\t\t\tinput.onchange = function (this: HTMLInputElement) {\n\t\t\t\tresolve(this.files.length > 0 ? this.files : null);\n\t\t\t}\n\t\t});\n\t\tif (files) {\n\t\t\tconst svc = ctx.reg.getSvc<IImportInWspSvc>(\"wspImportInWsp\");\n\t\t\tif (!svc) return null;\n\t\t\tconst from = ctx.shortDescs[0];\n\t\t\tconst defaultUriParent = from ? ITEM.extractSpaceUri(from.srcUri) : \"\"; //TODO cas où from est airItem, donc airItem ?\n\n\t\t\tconst options = {\n\t\t\t\ttargetSrcType: \"item\",\n\t\t\t\tdefaultUriParent: defaultUriParent,\n\t\t\t\tallowReplace: true,\n\t\t\t\trepeatedImports: files.length > 1 ? {} : undefined\n\t\t\t} as OImportSrcOptions;\n\n\t\t\tconst shortDescs: JSrcFields[] = [];\n\t\t\tfor (let i = 0; i < files.length; i++) {\n\t\t\t\tconst file = files.item(i);\n\t\t\t\tconst shortDesc = await svc.importSrc(file, options, ctx.reg, ctx.emitter);\n\t\t\t\tif (shortDesc) {\n\t\t\t\t\tshortDescs.push(shortDesc);\n\t\t\t\t} else {\n\t\t\t\t\tif (i < files.length - 1 && !await POPUP.confirm(\"Voulez-vous poursuivre l'import des fichiers suivants ?\", ctx.emitter, {okLbl: \"Poursuivre\"})) return;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (ctx.infoBroker) {\n\t\t\t\tif (shortDescs.length === 1)\n\t\t\t\t\tctx.infoBroker.dispatchInfo(new InfoFocusItem(SRC.srcRef(shortDescs[0]), shortDescs[0]), ctx.emitter);\n\t\t\t\telse\n\t\t\t\t\tctx.infoBroker.dispatchInfo(new InfoSelectUris(shortDescs.map((entry) => entry.srcUri)), ctx.emitter);\n\t\t\t}\n\t\t\t//const shortDesc = await svc.importItem(file, options, ctx.reg, ctx.emitter);\n\n\t\t\t//InfoSelectUris\n\t\t\t//if (ctx.infoBroker && shortDesc) ctx.infoBroker.dispatchInfo(new InfoFocusItem(SRC.srcRef(shortDesc), shortDesc), ctx.emitter);\n\t\t\treturn shortDescs;\n\t\t}\n\t\treturn null;\n\t}\n}\n\n/**\n * Importe une archive Scar (ou ScWsp).\n *\n * FIXME notif avancement UPLOAD + cancel...\n */\nexport class ImportScar<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tstatic async doImportScar(wsp: Wsp, uiContext: HTMLElement, refUri: srcRef, content: File, replaceIfExist: boolean): Promise<boolean> {\n\t\tconst progress = POPUP.showProgress(uiContext, \"Import de l'archive en cours...\");\n\t\ttry {\n\t\t\tlet resp = await ITEM.importScar(wsp, uiContext, refUri, content, replaceIfExist, progress.progressCallback);\n\t\t\tprogress.close();\n\t\t\tif (resp.error) throw resp.error;\n\t\t\tif (resp.status != 200 && resp.status != 204) {\n\t\t\t\tif (resp.status !== 420) {\n\t\t\t\t\tawait ERROR.reportError({\n\t\t\t\t\t\tmsg: \"Une erreur est survenue lors de l'import de l'archive : \" + content.webkitRelativePath || content.name,\n\t\t\t\t\t\tdetails: resp.asText\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst name = content.webkitRelativePath || content.name;\n\t\t\t\t\tPOPUP.showNotifWarning(<div style=\"padding:1em\">\n\t\t\t\t\t\t<p><b>{`L'import de '${name}' a abouti, mais les items suivants ont été rejetés (car non reconnus par ce modèle) :`}</b></p>\n\t\t\t\t\t\t<pre style=\"max-height:50vh; overflow:auto;\">{resp.asText}</pre>\n\t\t\t\t\t</div>, uiContext, {autoHide: 0});\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t} catch (e) {\n\t\t\tprogress.close();\n\t\t\tawait ERROR.report(\"Une erreur est survenue lors de l'import de l'archive : \" + content.webkitRelativePath || content.name, e);\n\t\t\treturn false\n\t\t}\n\t}\n\n\tconstructor(id?: string) {\n\t\tsuper(id || 'importScar');\n\t\tthis._label = \"Importer une archive...\";\n\t\tthis._group = \"importExport\";\n\t\tthis.zeroOrOne = true;\n\t\tthis._enableSrcPerms = [\"write.node.import\"];\n\t}\n\n\tisVisible(ctx: C): boolean {\n\t\tif (!super.isVisible(ctx)) return false;\n\t\tconst srcUri = this.getFirstSrcUri(ctx);\n\t\treturn !srcUri || ITEM.getSrcUriType(srcUri) === \"space\";\n\t}\n\n\tasync execute(ctx: C, ev?: Event) {\n\t\tconst {wsp} = ctx.reg.env;\n\t\tlet srcUri = this.getFirstSrcUri(ctx) || SRC.URI_ROOT;\n\t\tconst input = document.createElement('input');\n\t\tinput.type = \"file\";\n\t\tinput.accept = srcUri ? \".scar\" : \".scar,.scwsp\";\n\t\tinput.multiple = true;\n\t\tinput.click();\n\t\tconst files = await new Promise<FileList>((resolve) => {\n\t\t\tinput.onchange = function (this: HTMLInputElement) {\n\t\t\t\t//console.log(\"input.onchange:::\", this.files);\n\t\t\t\tresolve(this.files.length > 0 ? this.files : null);\n\t\t\t}\n\t\t});\n\t\tif (!files) return;\n\t\tlet replace = false;\n\t\tconst node = await WSP.fetchSrcTree(wsp, ctx.emitter, srcUri, 1, [\"srcNm\"]);\n\t\tif (node && node.ch && node.ch.length > 0) {\n\t\t\tconst space = ITEM.extractSpaceLabel(srcUri);\n\t\t\tconst form = <form>\n\t\t\t\t<p>{space ?\n\t\t\t\t\t`L'espace cible '${space}' n'est pas vide, l'import pourrait écraser vos contenus actuels.`\n\t\t\t\t\t: `L'atelier n'est pas vide, l'import pourrait écraser vos contenus actuels.`}</p>\n\t\t\t\t<p><label><input type=\"radio\" name=\"opt\" value=\"subSp\" checked/>Importer dans un nouveau sous-espace...</label></p>\n\t\t\t\t<p>\n\t\t\t\t\t<label>\n\t\t\t\t\t\t<input type=\"radio\" name=\"opt\" value=\"noReplace\"/>Importer dans cet espace sans remplacer les contenus portant le même nom.\n\t\t\t\t\t\t<span> Seuls les nouveaux contenus seront importés.</span>\n\t\t\t\t\t</label>\n\t\t\t\t</p>\n\t\t\t\t<p>\n\t\t\t\t\t<label>\n\t\t\t\t\t\t<input type=\"radio\" name=\"opt\" value=\"replace\"/>Importer dans cet espace en écrasant les contenus existants.\n\t\t\t\t\t\t<span style=\"color:var(--warning-color)\"> Attention, vos contenus portant les mêmes noms seront remplacés.</span>\n\t\t\t\t\t</label>\n\t\t\t\t</p>\n\t\t\t</form> as HTMLFormElement;\n\t\t\tif (!await POPUP.confirm(form, ctx.emitter)) return;\n\t\t\tconst choice = (form.elements.namedItem(\"opt\") as any /*RadioNodeList*/).value;\n\t\t\treplace = choice === \"replace\";\n\t\t\tif (choice === \"subSp\") {\n\t\t\t\t//On crée un space...\n\t\t\t\tlet newCode = files[0].name;\n\t\t\t\tconst idx = newCode.indexOf('.');\n\t\t\t\tif (idx >= 0) newCode = newCode.substring(0, idx);\n\t\t\t\tconst {SrcNewCode} = await import(\"back/wsp/dialogs/srcNewCode.js\");\n\t\t\t\tconst newCodeUi = new SrcNewCode().initialize({\n\t\t\t\t\treg: ctx.reg,\n\t\t\t\t\tparentFolder: srcUri,\n\t\t\t\t\tdefaultCode: newCode,\n\t\t\t\t\ttargetSrcUriType: \"space\",\n\t\t\t\t\tdoBtnLabel: \"Importer dans ce nouvel espace\"\n\t\t\t\t});\n\t\t\t\tnewCode = await POPUP.showDialog<string>(newCodeUi, ctx.emitter, {titleBar: {barLabel: {label: \"Créer un sous-espace...\"}}}).onNextClose();\n\t\t\t\tif (!newCode) return;\n\t\t\t\tsrcUri = SRC.addLeafToUri(srcUri, newCode);\n\t\t\t}\n\t\t}\n\n\t\tfor (let i = 0; i < files.length; i++) {\n\t\t\tconst file = files.item(i);\n\t\t\tif (!await ImportScar.doImportScar(wsp, ctx.emitter, srcUri, file, replace)) {\n\t\t\t\tif (i < files.length - 1 && !await POPUP.confirm(\"Voulez-vous poursuivre l'import des archives suivantes ?\", ctx.emitter, {okLbl: \"Poursuivre\"})) return;\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * Modifie le mainstream d'un item à partir d'un Blob.\n * A utiliser lorsque le Blob est connu.\n */\nexport class WriteMainStreamToSrc<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tblob: Blob | Promise<Blob>;\n\n\tstatic findBestType(ctx: IShortDescCtx, cbItems: ClipboardItem[]): string | undefined {\n\t\tif (!cbItems || cbItems.length !== 1 || ctx.shortDescs.length !== 1) return undefined;\n\t\tconst itemType = ctx.reg.env.wsp.wspMetaUi.getItemType(ctx.shortDescs[0].itModel);\n\t\tlet bestType: string;\n\t\tlet score = 0;\n\t\tfor (let t of cbItems[0].types) {\n\t\t\tlet s = itemType.matchType(t);\n\t\t\tif (s > score) {\n\t\t\t\tscore = s;\n\t\t\t\tbestType = t;\n\t\t\t}\n\t\t}\n\t\treturn bestType;\n\t}\n\n\tconstructor(blob: Blob | Promise<Blob>, id?: string, label?: string, group?: string) {\n\t\tsuper(id || \"writeStreamToSrc\");\n\t\tthis.blob = blob;\n\t\tthis._label = label || \"Coller le contenu\";\n\t\tthis._group = group || \"clipboard\";\n\t\tthis.exactOne = true;\n\t}\n\n\tasync execute(ctx: C, ev?: Event) {\n\t\tif (this.blob instanceof Promise) this.blob = await this.blob;\n\t\tif (!this.blob) return;\n\t\tconst itemLabel = ITEM.extractSrcLabel(ctx.shortDescs[0].srcUri, \"\");\n\t\tif (await POPUP.confirm(<div><p>{\"Remplacer le contenu de cet item par celui du presse-papier ?\"}</p><p>{itemLabel}</p></div>, ctx.emitter, {okLbl: \"Remplacer\"})) {\n\t\t\tconst sd = ctx.shortDescs[0];\n\t\t\tconst progress = POPUP.showProgress(ctx.emitter, \"Remplacement en cours...\");\n\t\t\ttry {\n\t\t\t\tconst shortDesc = await ITEM.update(ctx.reg.env.wsp, ctx.emitter, SRC.srcRef(sd), this.blob, progress.progressCallback, ctx.reg.env.wsp.getShortDescDef());\n\t\t\t\tprogress.close();\n\t\t\t\tif (ctx.infoBroker && shortDesc) ctx.infoBroker.dispatchInfo(new InfoFocusItem(SRC.srcRef(shortDesc), shortDesc), null); //utile si action lancée hors de la mainView\n\t\t\t} catch (e) {\n\t\t\t\tprogress.close();\n\t\t\t\tERROR.report(\"Échec au remplacement du contenu. Recommencez ultérieurement.\", e);\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * Action de coller dans le mainStream à partir du clipboard utilisable par racourci clavier ou en menu contextuel,\n * MAIS PAS en toolbar : pb eval async.\n */\nexport class PasteContent<C extends IShortDescCtx> extends WriteMainStreamToSrc<C> {\n\n\tconstructor(id?: string, label?: string, group?: string) {\n\t\tsuper(null, id, label, group);\n\t}\n\n\tisVisible(ctx: C): boolean {\n\t\tif (!navigator.clipboard || !navigator.clipboard.read) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\t/** On bloque dans les barres d'outils (pb clipboard asynchrone). */\n\tbuildCustomButton(ctx: C, uiContext: EButtonUiContext, parent?: Element): Element | null | undefined {return uiContext === 'bar' ? null : undefined}\n\n\tasync initButtonNode(buttonNode: Element, ctx: C) {\n\t\tif (buttonNode instanceof ActionBtn) {\n\t\t\ttry {\n\t\t\t\tconst cbItems = await navigator.clipboard.read();\n\t\t\t\tbuttonNode.disabled = WriteMainStreamToSrc.findBestType(ctx, cbItems) == null;\n\t\t\t} catch (e) {\n\t\t\t\tbuttonNode.disabled = true;\n\t\t\t\tif ((await navigator.permissions.query({name: 'clipboard-read' as any /*bug TS3.5*/})).state === 'denied') {\n\t\t\t\t\tPOPUP.showNotifWarning(\"L'accès au presse-papier n'est pas autorisé par votre navigateur. Modifiez les paramètres du site pour rendre opérationnelles les fonctions de copier/coller.\", buttonNode);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tasync execute(ctx: C, ev?: Event): Promise<void> {\n\t\ttry {\n\t\t\tconst cbItems = await navigator.clipboard.read();\n\t\t\tconst bestType = WriteMainStreamToSrc.findBestType(ctx, cbItems);\n\t\t\tif (bestType) {\n\t\t\t\tthis.blob = cbItems[0].getType(bestType);\n\t\t\t\treturn super.execute(ctx, ev);\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.blob = null;\n\t\t}\n\t}\n\n}\n\n/**\n * Export une archive Scar.\n */\nexport class ExportScar<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tconstructor(id?: string) {\n\t\tsuper(id || 'exportScar');\n\t\tthis._label = \"Exporter une archive...\";\n\t\tthis._group = \"importExport\";\n\t\tthis.atLeastOne = true;\n\t\tthis._enableSrcPerms = [\"read.node.export\"];\n\t}\n\n\tasync execute(ctx: C, ev?: Event) {\n\t\tconst popup = new PopupConfirm().initialize({titleBar: {barLabel: {label: \"Exporter une archive...\"}}, okLbl: \"Exporter\"});\n\t\tconst includeNet = <input type=\"checkbox\" checked=\"\"/> as HTMLInputElement;\n\t\tconst keepSpaces = <input type=\"checkbox\"/> as HTMLInputElement;\n\t\tconst isSingleItem = ctx.shortDescs.length === 1 && ITEM.getSrcUriType(this.getFirstSrcUri(ctx)) === \"item\";\n\n\t\tpopup.setContent(<section>\n\t\t\t<div><label>{includeNet}<span>{isSingleItem ? \"Inclure le réseau descendant complet de cet item\" : \"Inclure le réseau descendant complet des items sélectionnés\"}</span></label></div>\n\t\t\t<div><label>{keepSpaces}<span>Préserver les espaces de l'atelier</span></label></div>\n\t\t</section>);\n\n\t\tpopup.show({viewPortX: 'middle', viewPortY: 'middle'}, ctx.emitter);\n\n\t\tif (await popup.onNextClose()) {\n\t\t\tconst wsp = ctx.reg.env.wsp;\n\t\t\tconst scope = includeNet.checked ? \"net\" : \"node\";\n\t\t\tconst mode = keepSpaces.checked ? \"wspTree\" : scope == \"net\" ? \"rootAndRes\" : \"flat\";\n\n\t\t\tlet name = wsp.wspTitle;\n\t\t\tif (ctx.shortDescs.length === 1) {\n\t\t\t\tlet leaf = SRC.extractLeafFromUri(this.getFirstSrcUri(ctx));\n\t\t\t\tif (leaf) {\n\t\t\t\t\tconst idx = leaf.indexOf(\".\");\n\t\t\t\t\tif (idx >= 0) leaf = leaf.substring(0, idx);\n\t\t\t\t\tname = leaf;\n\t\t\t\t}\n\t\t\t}\n\t\t\tname = IO.getValidFileName(name, \".scar\", \"dateTime\");\n\n\t\t\tconst url = ctx.reg.env.universe.config.wsps.exportUrl.resolve(IO.qs(\"cdaction\", \"Export\", \"param\", wsp.code, \"format\", \"jar\", \"scope\", scope, \"mode\", mode, \"link\", \"relative\", \"downloadFileName\", name)).url;\n\t\t\tconst form = <form hidden accept=\"application/jar\"><input type=\"hidden\" name=\"refUris\" value={ctx.shortDescs.map((s) => SRC.srcRef(s)).join('\\t')}/></form> as HTMLFormElement;\n\t\t\tform.method = \"POST\";\n\t\t\tform.action = url;\n\t\t\tdocument.body.append(form);\n\t\t\tform.submit();\n\t\t\tform.remove();\n\t\t}\n\t}\n}\n\n/**\n * Export .scWsp dans l'explorateur si pas de src sélectionnée\n */\nexport class ExportScwsp<C extends IShortDescCtx> extends ExportWspAction<C> {\n\tisVisible(ctx: C): boolean {\n\t\tif (ctx.shortDescs.length > 0) return false;\n\t\t//aucune source sélectionnée\n\t\treturn super.isVisible(ctx);\n\t}\n}\n\n/**\n * Permissions affectées sur un espace\n */\nexport class SetPermsSpace<C extends ISetPermsSpaceCtx> extends SrcAction<C> {\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"openPermsWsp\");\n\t\tthis._label = \"Permissions sur l'espace...\";\n\t\tthis._description = \"Définir les permissions de cet espace\";\n\t\tthis._group = \"admin\";\n\t\tthis._icon = \"/@skin@/wsp/actions/spacePerms.svg\";\n\t\tthis.exactOne = this.isBackendDb = true;\n\t\tthis.requireSrcEnabledPerm([\"action.space#set.perms\", \"admin.node.configRoles.byAdmin\"]);\n\t}\n\n\tisVisible(ctx: C): boolean {\n\t\tif (ITEM.getSrcUriType(this.getFirstSrcUri(ctx) || '') !== \"space\") return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tasync execute(ctx: C, ev?: Event): Promise<void> {\n\t\t// Implémentation pour le mode exactOne uniquement\n\t\tconst reg = ctx.reg;\n\t\tconst {ObjRolesMapEdit} = await import(\"back/core/dialogs/objRolesMap.js\");\n\t\tconst item = ctx.shortDescs[0];//mode exactOne\n\t\tconst name = ITEM.extractSpaceLabel(item.srcUri);\n\t\tconst itemType = reg.env.wsp.wspMetaUi.getItemType(item.itModel);\n\t\tconst itemReg = ctx.reg = REG.createSubReg(reg, itemType);\n\t\titemReg.env.securityCtx = SEC.createSub(reg.env.securityCtx, item.srcRoles, item.srcRi);\n\t\tawait POPUP.showDialog(new ObjRolesMapEdit<IWspActionCtx, IWspUiEnv>().initialize({\n\t\t\treg: itemReg,\n\t\t\tuiContext: \"popup\",\n\t\t\trolesUiLayerSng: \"space\",\n\t\t\tpreSelectAccounts: ctx.preSelectAccounts,\n\t\t\tobjThis: ctx,\n\t\t\tobjEditRolesMap: (objThis, rolesMap) => {return WSP.srcSetRoles(ctx.reg.env.wsp, ctx.reg.env.uiRoot, item.srcUri, rolesMap)},\n\t\t\tobjEditRolesMapPerms: [\"action.space#set.perms\", \"admin.node.configRoles.byAdmin\"],\n\t\t\tobjFetchRolesMap: (objThis) => {return WSP.srcGetRoles(ctx.reg.env.wsp, ctx.reg.env.uiRoot, item.srcUri)},\n\t\t\tobjFetchRolesMapForAccounts: (objThis, pAccounts: string[]) => {return WSP.srcGetRolesForAccounts(ctx.reg.env.wsp, ctx.reg.env.uiRoot, item.srcUri, pAccounts)},\n\t\t} as OObjRolesMapInit<IWspActionCtx, IWspUiEnv>), ctx.reg.env.uiRoot, {\n\t\t\ttitleBar: {barLabel: {label: name ? `Permissions définies sur l'espace '${name}'` : `Permissions définies sur l'espace`}, closeButton: {}},\n\t\t\tresizer: {},\n\t\t\tinitWidth: \"40em\",\n\t\t\tinitHeight: \"40em\"\n\t\t}).onNextClose();\n\t}\n}\n\nexport interface ISetPermsSpaceCtx extends IShortDescCtx {\n\tpreSelectAccounts?: string[]\n}\n\n/**\n * Affiche la corbeille d'un atelier.\n */\nexport class OpenWspTrash<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tstatic async openTrashDialog(from: HTMLElement, init: OWspTrashInit) {\n\t\tconst reg = init.reg;\n\t\tconst {WspTrash} = await import(\"back/wsp/dialogs/wspTrash.js\");\n\t\tconst wspTitle = reg.env.wsp.wspTitle;\n\t\tawait POPUP.showDialog(new WspTrash().initialize(init), from, {\n\t\t\ttitleBar: {barLabel: {label: `Corbeille de l'atelier : ${wspTitle}`}, closeButton: {}},\n\t\t\tresizer: {},\n\t\t\tviewPortX: \"middle\",\n\t\t\tviewPortY: \"middle\",\n\t\t\tinitWidth: \"90vw\",\n\t\t\tinitHeight: \"90vh\"\n\t\t}).onNextClose();\n\t}\n\n\tconstructor(id?: string) {\n\t\tsuper(id || 'showWspTrash');\n\t\tthis._label = \"Corbeille...\";\n\t\tthis._group = \"wsp\";\n\t\tthis._enableSrcPerms = [\"read.trash\"];\n\t\tthis.isBackendDb = true;\n\t}\n\n\tasync execute(ctx: C, ev?: Event) {\n\t\treturn OpenWspTrash.openTrashDialog(ctx.emitter, {\n\t\t\treg: ctx.reg,\n\t\t\tshowMainView: true\n\t\t});\n\t}\n}\n\nexport class WspImportSrc implements IImportInWspSvc {\n\n\tstatic async pushResFolder(folder: IFolder, parentUri: srcUri, wsp: Wsp, uiCtx: HTMLElement) {\n\t\tif (SRC.isValidPartUri(folder.name) !== true) return; //On saute les noms de dossier non autorisés.\n\t\tconst newParent = SRC.addLeafToUri(parentUri, folder.name);\n\t\tlet empty = true;\n\t\tfor (let entry of folder.entries) {\n\t\t\tif (entry instanceof File) {\n\t\t\t\tif (SRC.isValidPartUri(entry.name) === true) {\n\t\t\t\t\tempty = false;\n\t\t\t\t\tawait ITEM.update(wsp, uiCtx, SRC.addLeafToUri(newParent, entry.name), entry);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tempty = false;\n\t\t\t\tawait WspImportSrc.pushResFolder(entry, newParent, wsp, uiCtx);\n\t\t\t}\n\t\t}\n\t\tif (empty) {\n\t\t\t//Aucun fils créé, on ajoute un dossier vide.\n\t\t\tawait ITEM.update(wsp, uiCtx, newParent, null);\n\t\t}\n\t}\n\n\timportSrc(body: File | Blob | IFolder, options: OImportSrcOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tswitch (options.targetSrcType) {\n\t\tcase \"item\":\n\t\t\treturn this.importItem(body, options, reg, uiCtx);\n\t\tcase \"space\":\n\t\t\tif (isFolder(body)) return this.importSpace(body, options, reg, uiCtx);\n\t\t\tconsole.trace(\"importSrc with targetSrcType='space' but body not a IFolder\");\n\t\t\treturn null;\n\t\tcase \"itemOrSpace\":\n\t\t\tif (isFolder(body) && ITEM.isValidCodeItem(body.name) !== true) return this.importSpace(body, options, reg, uiCtx);\n\t\t\treturn this.importItem(body, options, reg, uiCtx);\n\t\tcase \"res\":\n\t\t\treturn this.importRes(body, options, reg, uiCtx);\n\t\t}\n\t\tconsole.trace(\"importSrc with options.targetSrcType undefined\", options);\n\t\treturn null;\n\t}\n\n\tasync importItem(body: File | Blob | IFolder, options: OImportSrcOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tif (options.allowReplace) {\n\t\t\tconst item: JSrcFields | undefined = (reg.env as IItemUiEnv).longDesc;\n\t\t\tconst parentUri = options.defaultUriParent != null ? options.defaultUriParent : item ? ITEM.extractSpaceUri(item.srcUri) : \"\";\n\t\t\treturn this.doImportAllowReplace('item', body, parentUri, options, reg, uiCtx);\n\t\t} else {\n\t\t\t//Création uniquement...\n\t\t\tconst {ItemCreator} = await import(\"back/wsp/dialogs/itemCreator.js\");\n\t\t\tconst item = (reg.env as IItemUiEnv).longDesc;\n\t\t\tconst mimeType = 'type' in body ? body.type : null;\n\t\t\tconst name = 'name' in body ? body.name : null;\n\t\t\treturn ItemCreator.openCreateItem(ItemCreator.setDefaultConfigFromReg(reg, {\n\t\t\t\tbody,\n\t\t\t\titemTypesTree: {\n\t\t\t\t\titemTypeReducer: (acc: ItemType[], cur: ItemType) => {\n\t\t\t\t\t\t// On ne garde que les n ItemType de matchType le plus élevé\n\t\t\t\t\t\t// Cas particulier : les it de familly XML pour lesquels on ne garde qu'un it de façon arbitraire, les modalités\n\t\t\t\t\t\t// de filtre étant trop pauvres ici (pas d'accès au contenu de l'item) pour sélectionner le bon it\n\t\t\t\t\t\t// (nécessiterai de rentrer dans l'item, et de matcher le tag racine)\n\t\t\t\t\t\t// matchScore mini : 2\n\t\t\t\t\t\tconst minMatchScore = 2;\n\t\t\t\t\t\tif (options.sgnPattern && !options.sgnPattern.test(cur.getSgn())) return acc;\n\t\t\t\t\t\tlet prevIt = acc[acc.length - 1];\n\t\t\t\t\t\tlet prevMatchScore = prevIt ? prevIt.matchType(mimeType, name) : minMatchScore;\n\t\t\t\t\t\tlet currMatchScore = cur.matchType(mimeType, name);\n\t\t\t\t\t\tif (currMatchScore > prevMatchScore) {\n\t\t\t\t\t\t\t// On clean le tableau pour garder cette nouvelle valeur\n\t\t\t\t\t\t\twhile (acc.length) acc.pop();\n\t\t\t\t\t\t\tacc.push(cur);\n\t\t\t\t\t\t} else if (currMatchScore === prevMatchScore && (!prevIt || prevIt.getFamily() !== EItemTypeFamily.xml)) {\n\t\t\t\t\t\t\tacc.push(cur);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn acc;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tspaceUri: options.defaultUriParent != null ? options.defaultUriParent : item ? ITEM.extractSpaceUri(item.srcUri) : \"\",\n\t\t\t\tcodeItem: body instanceof File ? body.name : null\n\t\t\t}), \"Importer un item...\", uiCtx).onNextClose();\n\t\t}\n\t}\n\n\tasync importRes(body: File | Blob | IFolder, options: OImportSrcOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tif (!options.allowReplace) console.log(\":::TODO WspImportSrc.importRes() with options.allowReplace=false\", body);\n\t\tconst parentUri = options.defaultUriParent != null ? options.defaultUriParent : (reg.env as IItemUiEnv).longDesc?.srcUri || \"\";\n\t\treturn this.doImportAllowReplace('res', body, parentUri, options, reg, uiCtx);\n\t}\n\n\tasync importSpace(folder: IFolder, options: OImportSrcOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tif (!options.allowReplace) console.log(\":::TODO WspImportSrc.importRes() with options.allowReplace=false\", folder);\n\t\tlet parentUri = options.defaultUriParent;\n\t\tif (parentUri == null) {\n\t\t\tconst item: JSrcFields | undefined = (reg.env as IItemUiEnv).longDesc;\n\t\t\tparentUri = item ? ITEM.extractSpaceUri(item.srcUri) : \"\";\n\t\t}\n\t\treturn this.doImportAllowReplace('space', folder, parentUri, options, reg, uiCtx);\n\t}\n\n\tprotected async doImportAllowReplace(type: 'item' | 'space' | 'res', body: File | Blob | IFolder, parentUri: srcUri, options: OImportSrcOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\t//Check du nom...\n\t\tconst wsp = reg.env.wsp;\n\t\tlet name = 'name' in body ? body.name : null;\n\t\tif (ITEM.isValidCode(type, name) !== true) {\n\t\t\tname = await this.buildName(type, reg, uiCtx, parentUri, name);\n\t\t} else if (!options.repeatedImports?.replaceAll) {\n\t\t\tconst src = await WSP.fetchShortDesc(wsp, uiCtx, SRC.addLeafToUri(parentUri, name));\n\t\t\tif (src.srcSt !== ESrcSt.none) {\n\t\t\t\tif (options.repeatedImports?.replaceNothing) return;\n\t\t\t\tname = await this.buildName(type, reg, uiCtx, parentUri, name, options.repeatedImports);\n\t\t\t}\n\t\t}\n\t\tif (!name) return;\n\t\tconst progress = POPUP.showProgress(uiCtx, \"Import en cours...\");\n\t\ttry {\n\t\t\tif (body instanceof Blob) {\n\t\t\t\treturn await ITEM.update(wsp, uiCtx, SRC.addLeafToUri(parentUri, name), body, progress.progressCallback, wsp.getShortDescDef());\n\t\t\t} else {\n\t\t\t\t//IFolder\n\t\t\t\tif (type === \"item\" && body.name !== name) {\n\t\t\t\t\t//La source est un dossier, la cible est un item, et le dossier a été renommé.\n\t\t\t\t\tif (wsp.wspMetaUi.getItemTypes().find((it: ItemType) => it.matchType(null, name) > 1 && it.getFamily() === EItemTypeFamily.res)) {\n\t\t\t\t\t\t//L'item cible est une res, on tente le renommage aussi du mainStream de l'itemRes.\n\t\t\t\t\t\tfor (let i = 0; i < body.entries.length; i++) {\n\t\t\t\t\t\t\tconst entry = body.entries[i];\n\t\t\t\t\t\t\tif (entry.name === body.name && entry instanceof File) {\n\t\t\t\t\t\t\t\tbody.entries[i] = new File([entry], name);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbody.name = name;\n\t\t\t\tawait WspImportSrc.pushResFolder(body, parentUri, wsp, uiCtx);\n\t\t\t\treturn await wsp.fetchShortDesc(SRC.addLeafToUri(parentUri, name));\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tprogress.close();\n\t\t\tPOPUP.showNotifError(\"Une erreur est survenue durant l'envoi du contenu.\", uiCtx);\n\t\t\treturn null;\n\t\t} finally {\n\t\t\tprogress.close();\n\t\t}\n\t}\n\n\tprotected async buildName(type: 'item' | 'space' | 'res', reg: IReg<IWspUiEnv>, uiCtx: HTMLElement, parentUri: string | null, currentCode: string, freeStates?: OImportRepeatStates) {\n\t\tconst ct = new SrcNewCode().initialize({\n\t\t\treg: reg,\n\t\t\tparentFolder: parentUri,\n\t\t\tdefaultCode: currentCode,\n\t\t\ttargetSrcUriType: type,\n\t\t\tdoBtnLabel: \"Importer\",\n\t\t\tdoBtnReplaceLabel: \"Remplacer\",\n\t\t\tdoAllBtnLabel: freeStates ? \"Appliquer pour tout\" : undefined\n\t\t});\n\t\tconst name = await POPUP.showDialog<string | null>(ct, uiCtx, {titleBar: {barLabel: {label: \"Importer un item\"}}}).onNextClose();\n\t\tif (freeStates && ct.config.doAllSelected) {\n\t\t\tif (name) freeStates.replaceAll = true;\n\t\t\telse freeStates.replaceNothing = true;\n\t\t}\n\t\treturn name;\n\t}\n}\n\n/**\n * Svc d'import d'un item à partir d'une source externe (appelé sur session de drag, copier/coller et actions d'import).\n */\nREG.reg.registerSvc(\"wspImportInWsp\", 1, new WspImportSrc());\n\n\n/**\n * Svc d'import d'une source à partir d'un autre wsp du même entrepot.\n * Impl en lazyLoading du Svc.\n */\nexport class WspImportInterWspLazy implements IImportInterWspSvc {\n\n\timpl?: IImportInterWspSvc\n\n\tconstructor(public lib: string) {}\n\n\tasync importSrc(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tif (!this.impl) this.impl = await new (await reg.env.resolver.importJs(this.lib) as typeof import(\"back/wsp/actions/importInterWspSvc\")).WspImportInterWsp();\n\t\treturn this.impl.importSrc(wspFrom, srcFrom, options, reg, uiCtx);\n\t}\n}\n\nREG.reg.registerSvc(\"wspImportInterWsp\", 1, new WspImportInterWspLazy(\":back:wsp/actions/importInterWspSvc.js\"));\n\n\n/**\n * Import à partir d'une url : tentative de création d'un item Remote.\n */\nexport class WspImportFromUrlWsp implements IImportFromUrlSvc {\n\n\trejectSgnMatch(patternItemSgn: RegExp, reg: IReg<IWspUiEnv>): boolean {\n\t\treturn reg.env.wsp.wspMetaUi?.getItemTypes().find((it) => patternItemSgn.test(it.getSgn()) && /\\bRemoteBinary\\b/.test(it.getSgn())) == null;\n\t}\n\n\tasync extractShortDescs(data: DataTransfer, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<IShortDescUrlTransfer[]> {\n\t\t//cf https://www.rfc-editor.org/rfc/rfc2483#section-5\n\t\tconst urls = data.getData(data.types.indexOf(\"text/x-uri-list\") >= 0 ? \"text/x-uri-list\" : \"text/uri-list\") // \"text/x-uri-list\" : contournement bug https://bugs.chromium.org/p/chromium/issues/detail?id=239745\n\t\t\t.split(/\\r\\n/)\n\t\t\t.filter((u) => u && u.charAt(0) !== '#')\n\t\t\t.map((u) => u.trim());\n\t\treturn (await REMOTE.aliasUrls(urls, reg)).map((u) => new ShortDescToImportFromUrl(u, reg, uiCtx));\n\t}\n\n\tasync importSrc(url: string, options: OImportSrcOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tif (options.targetSrcType === \"space\" || options.targetSrcType === \"res\" || options.defaultUriParent == null) return null;\n\t\tconst path = new URL(url).pathname;\n\t\tconst nmIdx = path.lastIndexOf(\"/\");\n\t\treturn ItemCreator.openCreateItem(ItemCreator.setDefaultConfigFromReg(reg, {\n\t\t\titemTypesTree: {\n\t\t\t\titemTypeReducer: (acc: ItemType[], cur: ItemType) => {\n\t\t\t\t\tif (/\\bRemoteBinary\\b/.test(cur.getSgn()) && (!options.sgnPattern || options.sgnPattern.test(cur.getSgn()))) acc.push(cur);\n\t\t\t\t\treturn acc;\n\t\t\t\t}\n\t\t\t},\n\t\t\tspaceUri: options.defaultUriParent,\n\t\t\tspaceUi: options.uriParentFrozen ? \"readOnly\" : \"editable\",\n\t\t\tcodeItem: nmIdx >= 0 ? path.substring(nmIdx + 1) : null,\n\t\t\tnewContentOptions: {remoteUrl: url}\n\t\t}), \"Créer un item pour référencer une ressource distante...\", uiCtx).onNextClose();\n\t}\n}\n\n/** Import à partir d'une Uri. */\nclass ShortDescToImportFromUrl implements IShortDescUrlTransfer {\n\tconstructor(public url: string, public reg: IReg<IWspUiEnv>, public uiCtx: HTMLElement) {}\n\n\tcreateSrc(options: OImportSrcOptions): Promise<JSrcFields | null> {\n\t\tconst svc = this.reg.getSvc<IImportFromUrlSvc>(\"wspImportFromUrl\");\n\t\treturn svc?.importSrc(this.url, options, this.reg, this.uiCtx) || null;\n\t}\n}\n\nREG.reg.registerSvc(\"wspImportFromUrl\", 1, new WspImportFromUrlWsp());"]}