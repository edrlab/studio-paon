{"version":3,"sources":["/@back@/wsp/widgets/wed/wedlets/boxTransformer.tsx"],"names":["WEDLET","DOM","JSX","REG","removeAnnots","DOMSH","WSP","MsgLabel","BoxTransformer","HTMLElement","[object Object]","tpl","wedlet","this","wedMgr","reg","sr","attachShadow","SHADOWDOM_INIT","installSkins","localName","msgArea","appendChild","createElement","label","transform","getAttribute","hasAttribute","refreshLatencyInMs","Number","parseInt","previewElt","class","onload","setCustomMsg","onerror","setHidden","val","_timerRefresh","window","clearTimeout","setTimeout","executeTransformation","valStr","isVirtual","wsp","env","replace","encodeURIComponent","url","setStandardMsg","longDesc","getStreamStampedUrl","itemType","getMainStreamSrcUri","srcDt","setAttribute","registerSkin","customElements","define"],"mappings":"OAAiCA,WAAO;OAChCC,IAAKC,QAAI;OAETC,QAAI;OACJC,iBAAa;OACbC,UAAM;OACNC,QAAI;OACJC,aAAS;AAMjB,MAAMC,uBAAuBC,YAc5BC,gBAAgBC,IAAcC,QAC7BC,KAAKD,OAASA;AACd,MAAME,OAASF,OAAOE;AACtB,MAAMC,IAAMD,OAAOC;AACnB,MAAMC,GAAKH,KAAKI,aAAaZ,MAAMa;AACnClB,OAAOmB,aAAaR,IAAKK,GAAIJ,OAAQC,KAAKO;AAE1CP,KAAKQ,QAAUL,GAAGM,YAAYpB,IAAAqB,cAAChB,SAAQ,CAACiB,MAAM;AAC9CX,KAAKY,UAAYd,IAAIe,aAAa;AAClC,GAAIf,IAAIgB,aAAa,sBAAuBd,KAAKe,mBAAqBC,OAAOC,SAASnB,IAAIe,aAAa;AACvG,IAAKf,IAAIgB,aAAa,QAAUhB,IAAIe,aAAa,QAAU,MAAO,CACjEb,KAAKkB,WAAaf,GAAGM,YAAYpB,IAAAqB,cAAA,MAAA,CAAKS,MAAM,qBACtC,GAAIrB,IAAIe,aAAa,QAAU,SAAU,CAC/Cb,KAAKkB,WAAaf,GAAGM,YAAYpB,IAAAqB,cAAA,SAAA,CAAQS,MAAM,qBAE/C,KAAM,eAAiBrB,IAAIe,aAAa;AAEzCb,KAAKkB,WAAWE,OAAS,KACxBpB,KAAKQ,QAAQa,aAAa;AAE3BrB,KAAKkB,WAAWI,QAAU,KACzBtB,KAAKQ,QAAQa,aAAa,mBAAoB;AAC9CjC,IAAImC,UAAUvB,KAAKkB,WAAY,OAIjCrB,iBAAiB2B,KAChB,GAAIxB,KAAKe,mBAAoB,CAC5B,GAAIf,KAAKyB,cAAe,CACvBC,OAAOC,aAAa3B,KAAKyB;AACzBzB,KAAKyB,cAAgB,EAEtBzB,KAAKyB,cAAgBC,OAAOE,WAAW,KACtC5B,KAAKyB,cAAgB;AACrBzB,KAAK6B,sBAAsBL,MACzBxB,KAAKe,yBAERf,KAAK6B,sBAAsBL,KAGrB3B,sBAAsB2B,KAC7B,MAAMM,OAASN;AACf,GAAIxB,KAAKD,OAAOgC,YAAaxC,aAAaS;AAC1C,MAAMgC,IAAMhC,KAAKD,OAAOE,OAAOC,IAAI+B,IAAID;AACvC,IAAIpB,UAAYZ,KAAKY;AACrB,GAAIA,UACHA,UAAYA,UAAUsB,QAAQ,QAASC,mBAAmBL;AAC3D,IAAIM,IAAM;AACV,GAAIN,OAAQ,CACX9B,KAAKQ,QAAQ6B,eAAe;AAC5B,MAAMC,SAAWtC,KAAKD,OAAOE,OAAOC,IAAI+B,IAAIK;AAC5CF,IAAM3C,IAAI8C,oBAAoBP,IAAKhC,KAAKD,OAAOE,OAAOC,IAAI+B,IAAIO,SAASC,oBAAoBH,UAAWA,SAASI,MAAO9B;AACtHxB,IAAImC,UAAUvB,KAAKkB,WAAY;AAC/BlB,KAAKkB,WAAWyB,aAAa,MAAOP,SAC9B,CACNhD,IAAImC,UAAUvB,KAAKkB,WAAY,QASlC5B,IAAIY,IAAI0C,aAAa,kBAAmB,EAAsB;AAqB9DlB,OAAOmB,eAAeC,OAAO,kBAAmBnD","sourcesContent":["import {IElementWedlet, IWedlet, WEDLET} from \"back/edit/wed/wedlets/wedlet\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {IJmlNode} from \"lib/commons/xml/jml\";\nimport {REG} from \"lib/commons/registry\";\nimport {removeAnnots} from \"back/edit/wed/wedlets/box/boxTags\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {WSP} from \"lib/wsp/wsp\";\nimport {MsgLabel} from \"back/commons/basis\";\n\n/** box-transformer pour afficher le r√©sutat d'une transformation sur le content du noeud texte courant\n *  ex :\n *    <box-transformer transform=\"transform=latex2img&resolution=96&content={{0}}\" tag=\"img\" refreshLatencyInMs=\"0\"/>\n * */\nclass BoxTransformer extends HTMLElement implements IElementWedlet {\n\n\twedlet: IWedlet;\n\n\ttransform: string;\n\n\tmsgArea: MsgLabel;\n\n\tpreviewElt: HTMLElement;\n\n\trefreshLatencyInMs: number;\n\n\tprotected _timerRefresh: number;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet;\n\t\tconst wedMgr = wedlet.wedMgr;\n\t\tconst reg = wedMgr.reg;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tWEDLET.installSkins(tpl, sr, wedlet, this.localName);\n\n\t\tthis.msgArea = sr.appendChild(<MsgLabel label=\"Chargement en cours...\"/>) as MsgLabel;\n\t\tthis.transform = tpl.getAttribute('transform');\n\t\tif (tpl.hasAttribute('refreshLatencyInMs')) this.refreshLatencyInMs = Number.parseInt(tpl.getAttribute('refreshLatencyInMs'));\n\t\tif (!tpl.hasAttribute('tag') || tpl.getAttribute('tag') == 'img') {\n\t\t\tthis.previewElt = sr.appendChild(<img class=\"previewElt\"/>) as HTMLImageElement;\n\t\t} else if (tpl.getAttribute('tag') == 'iframe') {\n\t\t\tthis.previewElt = sr.appendChild(<iframe class=\"previewElt\"/>) as HTMLIFrameElement;\n\t\t} else\n\t\t\tthrow \"Unknown tag \" + tpl.getAttribute('tag');\n\n\t\tthis.previewElt.onload = () => {\n\t\t\tthis.msgArea.setCustomMsg(null);\n\t\t};\n\t\tthis.previewElt.onerror = () => {\n\t\t\tthis.msgArea.setCustomMsg(\"Non disponible\", \"error\");\n\t\t\tDOM.setHidden(this.previewElt, true);\n\t\t};\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tif (this.refreshLatencyInMs) {\n\t\t\tif (this._timerRefresh) {\n\t\t\t\twindow.clearTimeout(this._timerRefresh);\n\t\t\t\tthis._timerRefresh = 0;\n\t\t\t}\n\t\t\tthis._timerRefresh = window.setTimeout(() => {\n\t\t\t\tthis._timerRefresh = 0;\n\t\t\t\tthis.executeTransformation(val);\n\t\t\t}, this.refreshLatencyInMs);\n\t\t} else\n\t\t\tthis.executeTransformation(val);\n\t}\n\n\tprivate executeTransformation(val: IJmlNode) {\n\t\tconst valStr = val as string;\n\t\tif (this.wedlet.isVirtual()) removeAnnots(this);\n\t\tconst wsp = this.wedlet.wedMgr.reg.env.wsp;\n\t\tlet transform = this.transform;\n\t\tif (transform)\n\t\t\ttransform = transform.replace(\"{{0}}\", encodeURIComponent(valStr));\n\t\tlet url = null;\n\t\tif (valStr) {\n\t\t\tthis.msgArea.setStandardMsg(\"loading\");\n\t\t\tconst longDesc = this.wedlet.wedMgr.reg.env.longDesc;\n\t\t\turl = WSP.getStreamStampedUrl(wsp, this.wedlet.wedMgr.reg.env.itemType.getMainStreamSrcUri(longDesc), longDesc.srcDt, transform);\n\t\t\tDOM.setHidden(this.previewElt, false);\n\t\t\tthis.previewElt.setAttribute(\"src\", url);\n\t\t} else {\n\t\t\tDOM.setHidden(this.previewElt, true);\n\t\t\t//this.msgArea.setStandardMsg(null);\n\t\t}\n\t}\n\n\n\n}\n\nREG.reg.registerSkin('box-transformer', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: min-content;\n\t\tflex-direction: column;\n\t\talign-items: center;\n\t\tmargin: .5em;\n\t}\n\n\t.previewElt {\n\t\toverflow: visible;\n\t  /*width: 100%;\n\t  height: 100%;\n\t  max-width: fit-content;\n\t  max-height: fit-content;\n\t  object-fit: contain;\n\t  align-self: center;*/\n\t}\n\n`);\n\nwindow.customElements.define(\"box-transformer\", BoxTransformer);"]}