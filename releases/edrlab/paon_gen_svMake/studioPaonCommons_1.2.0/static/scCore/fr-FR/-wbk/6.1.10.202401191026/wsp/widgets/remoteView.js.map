{"version":3,"sources":["/@back@/wsp/widgets/remoteView.tsx"],"names":["BaseElement","WSP","SRC","DOMSH","DOM","JSX","REG","CDM","RemoteView","wsp","this","_wsp","findReg","config","env","v","_fields","refresh","fields","longDesc","location","_fixedLocation","[object Object]","init","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","tag","_mainDisplayTag","appendChild","createElement","class","hidden","controls","sandbox","onerror","ev","findHost","showMainDisplayTag","_pending","setCustomMsg","_tryIndex","setStandardMsg","error","resolveRemote","then","async","url","msg","setUrl","e","DEBUG","console","log","viewers","srcFields","srcSt","tryIndex","locationParam","encodeURIComponent","viewer","type","fetchStreamText","srcRef","code","isValidUrl","transform","_a","queryStringParams","forEach","param","keySvc","stringify","value","length","show","setHidden","noRemoteCheck","test","resp","fetch","method","credentials","ok","src","reg","registerSkin","customElements","define"],"mappings":"OAAQA,gBAAuD;OACvDC,QAAS;OACGC,QAAI;OAChBC,UAAM;OACNC,IAAKC,QAAI;OACTC,QAAI;OACJC,QAAI;OA0BN,MAAOC,mBAAmBR,YAe/BS,UAAgB,OAAOC,KAAKC,MAAQD,KAAKE,QAAQF,KAAKG,QAAQC,IAAIL,IAElEA,QAAQM,GACPL,KAAKC,KAAOI;AACZL,KAAKM,QAAU;AACfN,KAAKO,UAGNC,aAA0B,OAAOR,KAAKM,SAAWN,KAAKE,QAAQF,KAAKG,QAAQC,IAAIK,SAE/ED,WAAWH,GACVL,KAAKM,QAAUD;AACfL,KAAKO,UAGNG,eAAwB,OAAOV,KAAKW,eAEpCD,aAAaL,GACZL,KAAKW,eAAiBN;AACtBL,KAAKO,UAGIK,YAAYC,MACrBb,KAAKG,OAASU;AACd,MAAMC,GAAKd,KAAKe,aAAatB,MAAMuB;AACnChB,KAAKiB,oBAAoBjB,KAAKkB,UAAWL;AAEzC,OAAQb,KAAKG,OAAOgB,KACpB,IAAK,MACJnB,KAAKoB,gBAAkBN,GAAGO,YAAY1B,IAAA2B,cAAA,MAAA,CAAKC,MAAM,UAAUC,OAAO;AAClE;AACD,IAAK,QACJxB,KAAKoB,gBAAkBN,GAAGO,YAAY1B,IAAA2B,cAAA,QAAA,CAAOC,MAAM,YAAYE,SAAS,WAAWD,OAAO;AAC1F;AAED,IAAK,QACJxB,KAAKoB,gBAAkBN,GAAGO,YAAY1B,IAAA2B,cAAA,QAAA,CAAOC,MAAM,YAAYE,SAAS,WAAWD,OAAO;AAC1F;AACD,QAECxB,KAAKoB,gBAAkBN,GAAGO,YAAY1B,IAAA2B,cAAA,SAAA,CAAQC,MAAM,WAAWC,OAAO,GAAGE,QAAQ;AACjF,MAED1B,KAAKoB,gBAAgBO,QAAU,SAAmCC,IACjEnC,MAAMoC,SAAqB7B,MAAM8B,mBAAmB;AACpDrC,MAAMoC,SAAqB7B,MAAM+B,SAASC,aAAa,mBAAoB;AAE5EhC,KAAK+B,SAAWjB,GAAGO,YAAY1B,IAAA2B,cAAA,QAAA,OAGtBV,WACTZ,KAAKiC,WAAa;AAClBjC,KAAK8B,mBAAmB;AACxB9B,KAAK+B,SAASG,eAAe;AAC7B,MAAMC,MAAsC;AAC5CrC,WAAWsC,cAAcpC,KAAKD,IAAKC,KAAKG,OAAQH,KAAKQ,OAAQR,KAAKU,SAAUyB,OAAOE,KAAKC,MAAOC,MAC9F,GAAIJ,MAAMK,IAAK,CACdxC,KAAK8B,mBAAmB;AACxB9B,KAAK+B,SAASC,aAAaG,MAAMK,IAAK,aAChC,GAAID,IAAK,CACf,IACCvC,KAAKyC,OAAOF,KACX,MAAOG,GACR,GAAIC,MAAOC,QAAQC,IAAIH;AACvB1C,KAAK8B,mBAAmB;AACxB9B,KAAK+B,SAASC,aAAa,iCAAkC,aAExD,CACNhC,KAAK8B,mBAAmB;AACxB9B,KAAK+B,SAASC,aAAa,iCAAkC,WAKhEpB,2BAA2Bb,IAAU+C,QAAwBC,UAAuBrC,SAAmByB;AACtG,IAAKY,WAAaA,UAAUC,MAAQ,EAAG,CACtC,GAAIb,MAAOA,MAAMK,IAAM;AACvB,OAED,IAAIS,UAAY;AAChB,IAAIC,cAAgB;AACpB,GAAIxC,SAAUwC,eAAiB,aAAeC,mBAAmBzC;AACjE,EAAG,CACF,MAAM0C,OAASN,QAAQA,UAAUG;AACjC,IAAKG,OAAQ,CACZ,GAAIjB,MAAOA,MAAMK,IAAM;AACvB,YACM,GAAIY,OAAOC,OAAS,oBAAqB,CAC/CT,QAAQC,IAAI,+BACN,GAAIO,OAAOC,OAAS,cAAe,CACzC,IACC,MAAMd,UAAYhD,IAAI+D,gBAAgBvD,IAAK,KAAMP,IAAI+D,OAAOR,WAAY,oEAAsEI,mBAAmBC,OAAOI,MAAQN;AAChL,SAAUpD,WAAW2D,WAAWlB,KAAM,OAAOA,IAC5C,MAAOG,GACR,GAAIC,MAAOC,QAAQC,IAAIH,SAElB,GAAIU,OAAOC,OAAS,gBAAiB,CAC3C,IACC,IAAIK,UAAY,uDAAyDR,eACzES,GAAAP,OAAOQ,qBAAiB,MAAAD,UAAA,OAAA,EAAAA,GAAEE,QAASC,QAClCJ,WAAa;AACb,GAAII,MAAMC,OACTL,WAAaI,MAAMC,OAAS;AAC7BL,WAAa7D,IAAImE,UAAUF,MAAMG;AAElC,MAAM1B,UAAYhD,IAAI+D,gBAAgBvD,IAAK,KAAMP,IAAI+D,OAAOR,WAAYW;AACxE,SAAU5D,WAAW2D,WAAWlB,IAAKa,OAAOQ,mBAAqBR,OAAOQ,kBAAkBM,OAAS,MAAQ,MAAO,OAAO3B,IACxH,MAAOG,GACR,GAAIC,MAAOC,QAAQC,IAAIH,WAGjB,MAGA9B,mBAAmBuD,MAC5BzE,IAAI0E,UAAUpE,KAAK+B,SAAUoC;AAC7BzE,IAAI0E,UAAUpE,KAAKoB,iBAAkB+C,MAOtCvD,wBAAwB2B,IAAa8B,eACpC,GAAI9B,KAAO,iBAAiB+B,KAAK/B,KAAM,CACtC,GAAI8B,cAAe,OAAO;AAC1B,MAAME,WAAaC,MAAMjC,IAAK,CAACkC,OAAQ,OAAQC,YAAa;AAC5D,GAAIH,KAAKI,GAAI,OAAO,KAErB,OAAO,MAGE/D,OAAO2B,KAChBvC,KAAK8B,mBAAmB;AACxB9B,KAAKoB,gBAAgBwD,IAAMrC,KAI7B3C,IAAIiF,IAAIC,aAAa,kBAAmB,EAAsB;AAgD9DC,eAAeC,OAAO,kBAAmBlF;AAEzC,MAAM6C,MAAQ","sourcesContent":["import {BaseElement, BaseElementAsync, MsgLabel, OSkinableInit} from \"back/commons/basis\";\nimport {WSP, Wsp} from \"lib/wsp/wsp\";\nimport {JSrcFields, SRC} from \"lib/wsp/src\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {REG} from \"lib/commons/registry\";\nimport {CDM} from \"lib/commons/utils/cdm\";\nimport {REMOTE, RemoteRes} from \"lib/core/remote\";\nimport {Button, OButtonInit} from \"back/commons/widgets/buttons\";\n\n/** Widget RemoteView sans la nouvelle approche JRemoteResDesc à partir sc6.1 -  TODOsc7 à suppr ?*/\nexport interface RemoteView extends BaseElement {\n\tinitialize(init: ORemoteViewInit): this\n}\n\nexport interface ORemoteViewInit extends OSkinableInit, ORemoteviewer {\n\ttag?: 'img' | 'video' | 'audio' | 'iframe'\n}\n\n/**\n * Le premier viewer dont la requête HEAD est OK est utilisé\n * Exception : ce test validité n'est pas exécuté sur \"locationAsSrc\" SANS queryStringParams\n * qui doit donc logiquement être défini en dernière position (besoin authentificion)\n */\ninterface ORemoteviewer {\n\tviewers: (\n\t\t{ type: 'cidPreviewProcess', is: string, metasIn?: { string: { value: string, is?: string } } } /* TODO cidPreviewProcess */\n\t\t| { type: 'scDepotView', code: string }\n\t\t| { type: 'locationAsSrc', queryStringParams?: { keySvc?: 'scDepot' | string, value: any }[] }\n\t\t)[]\n}\n\nexport class RemoteView extends BaseElement {\n\n\tprotected config: ORemoteViewInit;\n\n\tprotected _wsp: Wsp;\n\n\tprotected _fields: JSrcFields;\n\n\tprotected _tryIndex: number;\n\n\tprotected _fixedLocation: string;\n\n\tprotected _mainDisplayTag: HTMLIFrameElement | HTMLImageElement | HTMLAudioElement | HTMLVideoElement;\n\tprotected _pending: MsgLabel;\n\n\tget wsp(): Wsp {return this._wsp || this.findReg(this.config).env.wsp}\n\n\tset wsp(v: Wsp) {\n\t\tthis._wsp = v;\n\t\tthis._fields = null;\n\t\tthis.refresh();\n\t}\n\n\tget fields(): JSrcFields {return this._fields || this.findReg(this.config).env.longDesc}\n\n\tset fields(v: JSrcFields) {\n\t\tthis._fields = v;\n\t\tthis.refresh();\n\t}\n\n\tget location(): string {return this._fixedLocation}\n\n\tset location(v: string) {\n\t\tthis._fixedLocation = v;\n\t\tthis.refresh();\n\t}\n\n\tprotected _initialize(init: ORemoteViewInit) {\n\t\tthis.config = init;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tswitch (this.config.tag) {\n\t\tcase 'img':\n\t\t\tthis._mainDisplayTag = sr.appendChild(<img class=\"imgView\" hidden=\"\"/>) as HTMLImageElement;\n\t\t\tbreak;\n\t\tcase 'video':\n\t\t\tthis._mainDisplayTag = sr.appendChild(<video class=\"videoView\" controls=\"controls\" hidden=\"\"/>) as HTMLVideoElement;\n\t\t\tbreak;\n\t\t\t// TODO : poster\n\t\tcase 'audio':\n\t\t\tthis._mainDisplayTag = sr.appendChild(<audio class=\"audioView\" controls=\"controls\" hidden=\"\"/>) as HTMLAudioElement;\n\t\t\tbreak;\n\t\tdefault :\n\t\t\t// iframe\n\t\t\tthis._mainDisplayTag = sr.appendChild(<iframe class=\"htmlView\" hidden=\"\" sandbox=\"allow-scripts allow-same-origin allow-forms\"/>) as HTMLIFrameElement;\n\t\t\tbreak;\n\t\t}\n\t\tthis._mainDisplayTag.onerror = function (this: HTMLIFrameElement, ev: Event) {\n\t\t\tDOMSH.findHost<RemoteView>(this).showMainDisplayTag(false);\n\t\t\tDOMSH.findHost<RemoteView>(this)._pending.setCustomMsg(\"Non disponible\", \"error\");\n\t\t};\n\t\tthis._pending = sr.appendChild(<c-msg/>) as MsgLabel;\n\t}\n\n\tprotected _refresh() {\n\t\tthis._tryIndex = -1;\n\t\tthis.showMainDisplayTag(false);\n\t\tthis._pending.setStandardMsg(\"loading\");\n\t\tconst error: { msg?: string | undefined } = {};\n\t\tRemoteView.resolveRemote(this.wsp, this.config, this.fields, this.location, error).then(async (url) => {\n\t\t\tif (error.msg) {\n\t\t\t\tthis.showMainDisplayTag(false);\n\t\t\t\tthis._pending.setCustomMsg(error.msg, \"info\");\n\t\t\t} else if (url) {\n\t\t\t\ttry {\n\t\t\t\t\tthis.setUrl(url);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (DEBUG) console.log(e);\n\t\t\t\t\tthis.showMainDisplayTag(false);\n\t\t\t\t\tthis._pending.setCustomMsg(\"Visualisation non disponible\", \"info\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.showMainDisplayTag(false);\n\t\t\t\tthis._pending.setCustomMsg(\"Visualisation non disponible\", \"info\");\n\t\t\t}\n\t\t});\n\t}\n\n\tstatic async resolveRemote(wsp: Wsp, viewers: ORemoteviewer, srcFields: JSrcFields, location?: string, error?: { msg?: string | undefined }): Promise<string | null> {\n\t\tif (!srcFields || srcFields.srcSt < 0) {\n\t\t\tif (error) error.msg = \"Source non spécifiée\";\n\t\t\treturn;\n\t\t}\n\t\tlet tryIndex = -1;\n\t\tlet locationParam = \"\";\n\t\tif (location) locationParam += \"&location=\" + encodeURIComponent(location);\n\t\tdo {\n\t\t\tconst viewer = viewers.viewers[++tryIndex];\n\t\t\tif (!viewer) {\n\t\t\t\tif (error) error.msg = \"Visualisation non disponible\";\n\t\t\t\treturn;\n\t\t\t} else if (viewer.type === \"cidPreviewProcess\") {\n\t\t\t\tconsole.log(\"TODO cidPreviewProcess\");\n\t\t\t} else if (viewer.type === \"scDepotView\") {\n\t\t\t\ttry {\n\t\t\t\t\tconst url = await WSP.fetchStreamText(wsp, null, SRC.srcRef(srcFields), \"transform=facet&facet=remoteContent&outType=LOCATION&scDepotView=\" + encodeURIComponent(viewer.code) + locationParam);\n\t\t\t\t\tif (await RemoteView.isValidUrl(url)) return url;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (DEBUG) console.log(e);\n\t\t\t\t}\n\t\t\t} else if (viewer.type === \"locationAsSrc\") {\n\t\t\t\ttry {\n\t\t\t\t\tlet transform = \"transform=facet&facet=remoteContent&outType=LOCATION\" + locationParam;\n\t\t\t\t\tviewer.queryStringParams?.forEach((param) => {\n\t\t\t\t\t\ttransform += \"&queryString=\";\n\t\t\t\t\t\tif (param.keySvc)\n\t\t\t\t\t\t\ttransform += param.keySvc + \":\";\n\t\t\t\t\t\ttransform += CDM.stringify(param.value);\n\t\t\t\t\t});\n\t\t\t\t\tconst url = await WSP.fetchStreamText(wsp, null, SRC.srcRef(srcFields), transform);\n\t\t\t\t\tif (await RemoteView.isValidUrl(url, viewer.queryStringParams && viewer.queryStringParams.length ? false : true)) return url;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (DEBUG) console.log(e);\n\t\t\t\t}\n\t\t\t}\n\t\t} while (true);\n\t}\n\n\tprotected showMainDisplayTag(show: boolean) {\n\t\tDOM.setHidden(this._pending, show);\n\t\tDOM.setHidden(this._mainDisplayTag, !show);\n\t}\n\n\t/**\n\t *\n\t * @param noRemoteCheck pour les resources publiques, permet l'affichage direct en iframe, sans les restrictions CORS.\n\t */\n\tstatic async isValidUrl(url: string, noRemoteCheck?: boolean): Promise<boolean> {\n\t\tif (url && /https?\\:\\/\\/.*/.test(url)) {\n\t\t\tif (noRemoteCheck) return true;\n\t\t\tconst resp = await fetch(url, {method: \"HEAD\", credentials: \"include\"});//mode:\"no-cors\", redirect:\"follow\"\n\t\t\tif (resp.ok) return true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tprotected setUrl(url: string) {\n\t\tthis.showMainDisplayTag(true);\n\t\tthis._mainDisplayTag.src = url;\n\t}\n}\n\nREG.reg.registerSkin('wsp-remote-view', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tflex-direction: column;\n\t\tjustify-content: center;\n\t\talign-items: center;\n\t\ttext-align: center;\n\t\tvertical-align: middle;\n\t\toverflow: auto;\n\t\tdisplay: flex;\n\t}\n\n\n\t:host > .imgView, :host > .videoView, :host > .audioView, :host > .iframeView, :host > .dynGenView {\n\t\tmax-height: 100%;\n\t\tobject-fit: scale-down;\n\t\tmax-width: 100%;\n\t}\n\n\t:host(.itemPreview) > .imgView, :host(.itemPreview) > .videoView, :host(.itemPreview) > .iframeView, :host(.itemPreview) > .dynGenView {\n\t\tmax-height: 10em;\n\t}\n\n\t:host > .audioView {\n\t\tmax-height: 2em;\n\t}\n\n\t:host > .iframeView, :host > .dynGenView {\n\t\tborder: 1px solid var(--border-color);\n\t\twidth: 100%;\n\t}\n\n\t[hidden] {\n\t\tdisplay: none;\n\t}\n\n\tiframe {\n\t\twidth: 100%;\n\t\theight: 100%;\n\t\tborder: none;\n\t}\n\n\tc-msg {\n\t\tmargin: .8em;\n\t\tfont-style: italic;\n\t}\n`);\n\ncustomElements.define('wsp-remote-view', RemoteView);\n\nconst DEBUG = false;\n"]}