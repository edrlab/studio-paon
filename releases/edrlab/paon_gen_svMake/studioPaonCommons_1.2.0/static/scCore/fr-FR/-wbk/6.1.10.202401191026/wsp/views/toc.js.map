{"version":3,"sources":["/@back@/wsp/views/toc.tsx"],"names":["REG","BaseAreaView","DOM","JSX","DOMSH","SRC","WSP","EWspChangesEvts","InfoCurrentItem","InfoFocusItem","InfoFocusNodeInItem","InfoReqCurrentItem","SRCDRAWER","SrcPointer","SrcPointerDblClick","render","xhtml","BASIS","ACTION","Action","BarActions","SrcHisto","Toc","[object Object]","this","_maxLevelOpenedIntended","srcRef","_rootSrc","setSrcRef","sd","shortDescs","srcUri","tocItem","depth","_srcMap","has","init","super","_initialize","wsp","reg","env","infoBroker","transformFacet","maxLevelOpenedIntended","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","installSkin","initialize","place","tpl","itemCodeAloneTpl","defaultAction","getSvc","SINGLETON","sgnPattern","draggable","dropable","dispatchHighlight","classList","add","hideHeader","_srcHisto","createElement","title","î","icon","srcPointer","history","_a","lastDatas","roots","appendChild","id","actions","setLabel","setIcon","setExecute","ctx","_render","disableFullOverlay","uiContext","actionContext","onSrcRefChange","rebuildFromRoot","_view","tocItemTpl","hideTitle","depthTitle","stackItems","srcSt","indexOf","srcId","extractLeafFromUri","push","tocNodeTpl","tocNode","defaultState","isLevelOpened","body","subTocItem","get","nodes","length","name","undefined","map","_currentSrcUri","_fetchToc","txt","fetchStreamText","doc","parseDom","Map","buildItemToc","documentElement","firstElementChild","e","console","log","item","getAttribute","old","delete","root","findFirstChild","n","nodeName","parseInt","itSgn","xpath","split","set","children","ch","nextElementSibling","buildNodeToc","node","itNode","lastElementChild","bodySet","hasChildNodes","rootSrcUri","getRootSrcUri","noRootTpl","noTocTpl","ensureRowVisible","parentLastDatas","ldKey","setHistory","info","_setCurrentItem","_onConnRenewed","onConnRenewed","bind","eventsMgr","on","_wspUriChange","onWspUriChange","addConsumer","req","dispatchInfo","shortDesc","closed","removeConsumer","removeListener","msg","from","type","u","tocIt","r","hidden","registerSkin","customElements","define","WspTocItem","HTMLElement","WspTocNode","p","parentElement","closest","buildXpath","WspTocTitle","makeClickable","onclick","onClick","onkeydown","onKeyDown","ev","xp","toc","findHost","join","twisty","querySelector","state","st","gotoCycle","scrollIntoView","block","inline","behavior","key","findNext","IS_WspTocTitle","focus","findPrevious","window","getComputedStyle","direction","openFolder","dispatchEvent","KeyboardEvent","closeFolder","ensureVisible","isAccelPressed","toggleFolderOrGotoCycle","stopImmediatePropagation","preventDefault","WspTocTwisty","onpointerdown","onPointerDown","chList","getChildrenList","setHidden","Error","setAttribute","parent","findParent","contains","findLastChild","WspTocSide"],"mappings":"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","sourcesContent":["import {IInfo, IInfoBroker, IInfoConsumer} from \"lib/commons/infos\";\nimport {ILastDatasBuilder, JLastDatas} from \"lib/commons/lastDatas\";\nimport {IReg, IRegPointer, REG} from 'lib/commons/registry';\nimport {BaseAreaView, OBaseAreaViewInit} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {SRC, srcId, srcRef, srcUri} from \"lib/wsp/src\";\nimport {IWspUiEnv, JWspUriChangeMsg, WSP, Wsp} from \"lib/wsp/wsp\";\nimport {EWspChangesEvts, WspsLivePlace} from \"lib/wsp/wspsLive\";\nimport {InfoCurrentItem, InfoFocusItem, InfoFocusNodeInItem, InfoReqCurrentItem} from \"lib/wsp/item\";\nimport {SRCDRAWER, SrcPointer, SrcPointerDblClick} from \"back/wsp/widgets/srcDrawer\";\nimport {TemplateResult} from \"res/litHtml/lib/template-result\";\nimport {render} from \"res/litHtml/lit-html\";\nimport {xhtml} from \"lib/commons/utils/htmlLit\";\nimport {BASIS, PickInit} from \"back/commons/basis\";\nimport {ACTION, Action} from \"lib/commons/actions\";\nimport {BarActions, OBarActionsInit} from \"back/commons/widgets/bars\";\nimport {OSrcHistoInit, SrcHisto} from \"back/wsp/widgets/srcHisto\";\n\n\n/**\n */\nexport interface Toc extends BaseAreaView<IRegPointer<IWspUiEnv>> {\n\tinitialize(init: OTocInit): this\n}\n\nexport interface OTocInit extends OBaseAreaViewInit<IRegPointer<IWspUiEnv>>,\n\tPickInit<Toc, 'infoBroker' | 'transformFacet' | 'tocItemTpl'> {\n\t/** Masque l'entête avec le ptrItem. */\n\thideHeader?: boolean\n\n\t/** nombre maximal de niveaux à déplier à l'init */\n\tmaxLevelOpenedIntended?: number\n\n\tlastDatas?: JLDToc\n}\n\ninterface JLDToc {\n\troots: srcRef[]\n}\n\nexport class Toc extends BaseAreaView<IRegPointer<IWspUiEnv>> implements IInfoConsumer, ILastDatasBuilder {\n\treg: IReg<IWspUiEnv>;\n\twsp: Wsp;\n\n\t/** Réagira aux infos issues de ce broker (item courant) et dispatchera les demandes de focus / sélection. */\n\tinfoBroker: IInfoBroker;\n\n\t/**\n\t * Paramètres de la facette de transformation pour obtenir la toc\n\t * Valeur par défaut : \"facet=outline\"\n\t * Intégré ainsi dans la requête: `transform=facet&${transformFacet}`\n\t */\n\ttransformFacet?: string;\n\n\t/** Personnalisation de la construction de la TOC. */\n\ttocItemTpl: (this: Toc, tocItem: ITocItem, hideTitle: boolean, depthTitle: number, stackItems: ITocItem[]) => TemplateResult;\n\n\t/* Map des Toc des items impliqués. Double indexation srcUri et srcId. */\n\tprotected _srcMap: Map<srcUri & srcId, ITocItem>;\n\n\tprotected _srcHisto?: SrcHisto;\n\n\t_rootSrc: SrcPointer;\n\tprotected _view: HTMLElement;\n\n\n\t/** SrcUri actuellement \"courrant\" (InfoCurrentItem) pour le repérer dans la TOC. */\n\tprotected _currentSrcUri: srcUri;\n\n\tsetRootSrcRef(srcRef: srcRef) {\n\t\tthis._rootSrc.setSrcRef(srcRef);\n\t}\n\n\tgetRootSrcRef(): srcRef {\n\t\treturn this._rootSrc.srcRef;\n\t}\n\n\tgetRootSrcUri(): srcUri {\n\t\tconst sd = this._rootSrc.shortDescs[0];\n\t\treturn sd ? sd.srcUri : null;\n\t}\n\n\t/** Retourne true si le noeud de l'arbre doit être ouvert */\n\tprotected isLevelOpened(tocItem: ITocItem, depth: Number): boolean {\n\t\treturn depth < this._maxLevelOpenedIntended;\n\t}\n\n\tprotected _maxLevelOpenedIntended: number = 5\n\n\tisInToc(srcRef: srcRef): boolean {\n\t\tif (!this._srcMap) return false;\n\t\treturn this._srcMap.has(srcRef);\n\t}\n\n\tasync ensureRowVisible(srcUri: srcUri) {\n\t\t//TODO ensureRowVisible\n\t}\n\n\tprotected _initialize(init: OTocInit) {\n\t\tsuper._initialize(init); //init this.reg, this.area, this.areaContext\n\t\tthis.wsp = this.reg.env.wsp;\n\t\tthis.infoBroker = init.infoBroker;\n\t\tthis.transformFacet = init.transformFacet ? `transform=facet&${init.transformFacet}` : \"transform=facet&facet=outline\";\n\n\t\tif (init.maxLevelOpenedIntended) this._maxLevelOpenedIntended = init.maxLevelOpenedIntended;\n\n\t\t//Construction Ui\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tthis.reg.installSkin('scroll/small', sr);\n\n\t\tthis._rootSrc = new SrcPointer().initialize({\n\t\t\treg: this.reg,\n\t\t\tplace: this.reg.env.place,\n\t\t\ttpl: SRCDRAWER.itemCodeAloneTpl,\n\t\t\tdefaultAction: this.reg.getSvc(\"ptrItemDblClick\", SrcPointerDblClick.SINGLETON),\n\t\t\tsgnPattern: /.*#Map\\b.*/,\n\t\t\tdraggable: true,\n\t\t\tdropable: true,\n\t\t\tdispatchHighlight: true,\n\t\t});\n\t\tthis._rootSrc.classList.add(\"fixedIconSize\");\n\n\t\tif (!init.hideHeader) {\n\t\t\t//const ld = init.lastDatas?[this.getAttribute('last-datas')];\n\t\t\tthis._srcHisto = <SrcHisto title=\"Historique des dernières racines sélectionnées\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\ticon: \"/@skin@/wsp/views/toc/histo.svg\",\n\t\t\t\tsrcPointer: this._rootSrc,\n\t\t\t\thistory: init.lastDatas?.roots\n\t\t\t} as OSrcHistoInit}/> as SrcHisto;\n\t\t\tsr.appendChild(<div id=\"headBar\">\n\t\t\t\t<div id=\"rootSel\">\n\t\t\t\t\t{this._rootSrc}\n\t\t\t\t\t{this._srcHisto}\n\t\t\t\t</div>\n\t\t\t\t<BarActions id=\"options\" î={{\n\t\t\t\t\tactions: [new Action<Toc>()\n\t\t\t\t\t\t.setLabel(\"Déplier d'un niveau supplémentaire\")\n\t\t\t\t\t\t.setIcon(\"/@skin@/commons/icons/expandMore.svg\")\n\t\t\t\t\t\t.setExecute((ctx) => {\n\t\t\t\t\t\t\tctx._maxLevelOpenedIntended++;\n\t\t\t\t\t\t\tctx._render();\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tnew Action<Toc>()\n\t\t\t\t\t\t\t.setLabel(\"Tout replier\")\n\t\t\t\t\t\t\t.setIcon(\"/@skin@/commons/icons/collaps.svg\").setExecute((ctx) => {\n\t\t\t\t\t\t\tctx._maxLevelOpenedIntended = 1;\n\t\t\t\t\t\t\tctx._render();\n\t\t\t\t\t\t})],\n\t\t\t\t\tdisableFullOverlay: true,\n\t\t\t\t\tuiContext: \"bar\",\n\t\t\t\t\tactionContext: this\n\t\t\t\t} as OBarActionsInit<Toc>}/>\n\t\t\t</div>);\n\t\t}\n\n\t\tthis._rootSrc.onSrcRefChange.add(() => {this.rebuildFromRoot()});\n\n\t\tthis._view = sr.appendChild(<div id=\"view\"/>);\n\n\t\t//Template de la toc\n\t\tthis.tocItemTpl = init.tocItemTpl || function (this: Toc, tocItem: ITocItem, hideTitle: boolean, depthTitle: number, stackItems: ITocItem[]): TemplateResult {\n\t\t\t//item en erreur\n\t\t\tif (tocItem.srcSt < 0) return xhtml`<div class=\"notFound\"><wsp-toc-twisty p.state=\"${'notFound'}\"/>Item non trouvé</div>`;\n\t\t\t//check cycles\n\t\t\tif (stackItems.indexOf(tocItem) >= 0) {\n\t\t\t\treturn xhtml`<wsp-toc-title depth=\"${depthTitle}\"><wsp-toc-twisty p.state=\"${'cycle'}\" srcRef=\"${tocItem.srcId || tocItem.srcUri}\"/>${tocItem.title || SRC.extractLeafFromUri(tocItem.srcUri)}</wsp-toc-title>`;\n\t\t\t}\n\t\t\tstackItems.push(tocItem);\n\t\t\t//Tpl des nodes\n\t\t\tconst tocNodeTpl = (tocNode: ITocNode): TemplateResult => {\n\t\t\t\ttry {\n\t\t\t\t\tdepthTitle++;\n\t\t\t\t\tconst defaultState = this.isLevelOpened(tocItem, depthTitle) ? \"opened\" : \"closed\";\n\t\t\t\t\tif (typeof tocNode.body === 'string') {\n\t\t\t\t\t\tconst subTocItem = this._srcMap.get(tocNode.body);\n\t\t\t\t\t\tif (subTocItem) {\n\t\t\t\t\t\t\treturn xhtml`<wsp-toc-node p.tocNode=\"${tocNode}\">\n\t\t\t\t\t\t\t${tocNode.title ? xhtml`<wsp-toc-title depth=\"${depthTitle}\"><wsp-toc-twisty p.state=\"${subTocItem.nodes.length ? defaultState : 'leaf'}\"/>${tocNode.title || tocNode.name}</wsp-toc-title>` : undefined}\n\t\t\t\t\t\t\t${this.tocItemTpl(subTocItem, tocNode.title != null, depthTitle, stackItems)}\n\t\t\t\t\t\t</wsp-toc-node>`\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t//TODO tocItem pas encore chargé ou chargement en echec ?\n\t\t\t\t\t\t\treturn xhtml`<div>...</div>`;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn xhtml`<wsp-toc-node p.tocNode=\"${tocNode}\">\n\t\t\t\t\t\t<wsp-toc-title depth=\"${depthTitle}\"><wsp-toc-twisty p.state=\"${tocNode.body && tocNode.body.length ? defaultState : 'leaf'}\"/>${tocNode.title || tocNode.name}</wsp-toc-title>\n\t\t\t\t\t\t<div class=\"children\">\n\t\t\t\t\t\t\t${tocNode.body ? tocNode.body.map(tocNodeTpl) : undefined}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</wsp-toc-node>`\n\t\t\t\t\t}\n\t\t\t\t} finally {\n\t\t\t\t\tdepthTitle--;\n\t\t\t\t}\n\t\t\t};\n\n\t\t\treturn xhtml`<wsp-toc-item p.tocItem=\"${tocItem}\" srcRef=\"${tocItem.srcId || tocItem.srcUri}\">\n\t\t\t\t<wsp-toc-side b.current=\"${this._currentSrcUri === tocItem.srcUri}\"/>\n\t\t\t\t<div class=\"itemBody\">\n\t\t\t\t\t${hideTitle ? undefined : xhtml`<wsp-toc-title depth=\"${depthTitle}\"><wsp-toc-twisty p.state=\"${tocItem.nodes.length ? (this.isLevelOpened(tocItem, depthTitle) ? \"opened\" : \"closed\") : 'leaf'}\"/>${tocItem.title || SRC.extractLeafFromUri(tocItem.srcUri)}</wsp-toc-title>`}\n\t\t\t\t\t<div class=\"children\">\n\t\t\t\t\t\t${tocItem.nodes.map(tocNodeTpl)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</wsp-toc-item>`;\n\t\t}\n\t}\n\n\t/** Appeplé à l'init, au chgt de src root et en cas de perte de connexion. */\n\tprotected async rebuildFromRoot() {\n\t\tthis._srcMap = null;\n\t\tthis._fetchToc(this._rootSrc.srcRef);\n\t}\n\n\tprotected async _fetchToc(srcRef: srcRef) {\n\t\tif (srcRef) {\n\t\t\ttry {\n\t\t\t\tconst txt = await WSP.fetchStreamText(this.wsp, this, srcRef, this._srcMap ? this.transformFacet + \"&depth=1\" : this.transformFacet);\n\t\t\t\t//console.log(\"_fetchToc::::\", txt);\n\t\t\t\tconst doc = DOM.parseDom(txt);\n\t\t\t\tif (!this._srcMap) this._srcMap = new Map();\n\t\t\t\tthis.buildItemToc(doc.documentElement.firstElementChild);\n\t\t\t} catch (e) {\n\t\t\t\tthis._srcMap = null;\n\t\t\t\tconsole.log(e);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._srcMap = null;\n\t\t}\n\t\tthis._render();\n\t}\n\n\t/** Analyse un element DOM \"item\" pour enrichir this._srcMap. */\n\tprotected buildItemToc(item: Element) {\n\t\tconst srcUri = item.getAttribute(\"uri\");\n\t\tconst srcId = item.getAttribute(\"id\");\n\n\t\t//cleanup\n\t\tlet old = this._srcMap.get(srcUri);\n\t\tif (old && old.srcId && old.srcId !== srcId) this._srcMap.delete(old.srcId);\n\t\told = this._srcMap.get(srcId);\n\t\tif (old && old.srcUri !== srcUri) this._srcMap.delete(old.srcUri);\n\n\t\tconst root = DOM.findFirstChild(item, (n: Node): n is Element => n.nodeName === 'itemRoot');\n\t\tif (!root) return; //pas de <itemRoot> == présence d'un <cycle/>, on sort.\n\t\tconst title = DOM.findFirstChild(root, (n: Node): n is Element => n.nodeName === 'titleNode');\n\t\tconst tocItem = {\n\t\t\tsrcUri: srcUri,\n\t\t\tsrcId: srcId,\n\t\t\tsrcSt: parseInt(item.getAttribute(\"st\")),\n\t\t\titSgn: item.getAttribute(\"sgn\"),\n\t\t\txpath: root ? root.getAttribute(\"xp\").split('/') : null,\n\t\t\ttitle: title ? title.getAttribute(\"title\") : null,\n\t\t\tnodes: []\n\t\t} as ITocItem;\n\t\tthis._srcMap.set(srcUri, tocItem);\n\t\tif (srcId) this._srcMap.set(srcId, tocItem);\n\t\tconst children = DOM.findFirstChild(root, (n: Node): n is Element => n.nodeName === 'children');\n\t\tif (!children) return;\n\t\tfor (let ch = children.firstElementChild; ch; ch = ch.nextElementSibling) {\n\t\t\tif (ch.nodeName === \"node\") tocItem.nodes.push(this.buildNodeToc(ch));\n\t\t}\n\t}\n\n\t/** Analyse un element DOM nommé \"node\" et retourne un ITocNode. */\n\tprotected buildNodeToc(node: Element): ITocNode {\n\t\tconst title = DOM.findFirstChild(node, (n: Node): n is Element => n.nodeName === 'titleNode');\n\t\tconst itNode = {\n\t\t\txpath: node.getAttribute(\"xp\").split('/'),\n\t\t\tname: node.getAttribute(\"name\"),\n\t\t\ttitle: title ? title.getAttribute(\"title\") : null\n\t\t} as ITocNode;\n\t\tconst body = node.lastElementChild;\n\t\tif (body) {\n\t\t\tif (body.nodeName === \"children\") {\n\t\t\t\tconst bodySet: ITocNode[] = itNode.body = [];\n\t\t\t\tfor (let ch = body.firstElementChild; ch; ch = ch.nextElementSibling) {\n\t\t\t\t\tif (ch.nodeName === \"node\") bodySet.push(this.buildNodeToc(ch));\n\t\t\t\t}\n\t\t\t} else if (body.nodeName === \"item\") {\n\t\t\t\tconst srcRef: srcRef = itNode.body = body.getAttribute(\"id\") || body.getAttribute(\"uri\");\n\t\t\t\tif (body.hasChildNodes() || body.getAttribute(\"st\") === \"-1\") {\n\t\t\t\t\t//définition de cet item dans le flux.\n\t\t\t\t\tthis.buildItemToc(body);\n\t\t\t\t} else {\n\t\t\t\t\t//Non présent dans le flux XML fetché\n\t\t\t\t\tif (!this._srcMap.has(srcRef)) {\n\t\t\t\t\t\t//srcUri non présente dans la map de cette toc, on doit charger la toc de cet item\n\t\t\t\t\t\tthis._fetchToc(srcRef);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn itNode;\n\t}\n\n\t_render() {\n\t\tconst rootSrcUri = this.getRootSrcUri();\n\t\tif (!rootSrcUri) {\n\t\t\trender(this.noRootTpl(), this._view);\n\t\t\treturn;\n\t\t}\n\t\tconst tocItem = this._srcMap?.get(rootSrcUri);\n\t\tif (!tocItem) {\n\t\t\trender(this.noTocTpl(), this._view);\n\t\t\treturn;\n\t\t}\n\t\trender(this.tocItemTpl(tocItem, false, 1, []), this._view);\n\t}\n\n\n\tnoRootTpl(): TemplateResult {\n\t\treturn xhtml`<c-msg level=\"info\">Renseignez un item racine</c-msg>`;\n\t}\n\n\tnoTocTpl(): TemplateResult {\n\t\treturn xhtml`<c-msg level=\"info\">Aucun plan pour cet item</c-msg>`;\n\t}\n\n\t/** Identifie l'item courant dans l'app. */\n\t_setCurrentItem(srcUri: srcUri | null) {\n\t\tthis._currentSrcUri = srcUri;\n\t\tthis._render();\n\t\tif (this._currentSrcUri) this.ensureRowVisible(this._currentSrcUri);\n\t}\n\n\tbuildLastDatas?(parentLastDatas: JLastDatas): void {\n\t\tconst ldKey = this.getAttribute('last-datas');\n\t\tif (ldKey) parentLastDatas[ldKey] = this._srcHisto?.setHistory<JLDToc>({} as JLDToc, \"roots\");\n\t}\n\n\tonInfo(info: IInfo): void {\n\t\tif (info instanceof InfoCurrentItem) {\n\t\t\tthis._setCurrentItem(info.srcUri);\n\t\t}\n\t}\n\n\tonViewShown() {\n\t\tif (!this._onConnRenewed) {\n\t\t\t//1er init\n\t\t\tthis._onConnRenewed = this.onConnRenewed.bind(this);\n\t\t\tthis.reg.env.place.eventsMgr.on(\"onConnectionRenewed\", this._onConnRenewed);\n\t\t\tthis._wspUriChange = this.onWspUriChange.bind(this);\n\t\t\tthis.reg.env.place.eventsMgr.on(\"wspUriChange\", this._wspUriChange);\n\t\t}\n\t\tif (this.infoBroker) {\n\t\t\tthis.infoBroker.addConsumer(this);\n\t\t\tconst req = new InfoReqCurrentItem();\n\t\t\tthis.infoBroker.dispatchInfo(req, this);\n\t\t\tthis._setCurrentItem(req.srcUri);\n\t\t\tif (this._srcMap == null) {\n\t\t\t\tif (!this._rootSrc.srcRef && req.srcUri) {\n\t\t\t\t\t//On prend l'item courant par défaut.\n\t\t\t\t\tthis._rootSrc.setSrcRef(req.srcUri, req.shortDesc);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tonViewHidden(closed?: boolean): void {\n\t\tif (this.infoBroker) this.infoBroker.removeConsumer(this);\n\t\tif (closed) {\n\t\t\tthis.reg.env.place.eventsMgr.removeListener(\"onConnectionRenewed\", this._onConnRenewed);\n\t\t\tthis.reg.env.place.eventsMgr.removeListener(\"wspUriChange\", this._wspUriChange);\n\t\t}\n\t}\n\n\tprotected _wspUriChange: (msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') => void;\n\n\tprotected onWspUriChange(msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') {\n\t\tif (!this._srcMap) return;\n\t\tif (msg.type === EWspChangesEvts.u) {\n\t\t\tconst tocIt = this._srcMap.get(SRC.srcRef(msg));\n\t\t\tif (tocIt) this._fetchToc(SRC.srcRef(msg));\n\t\t} else if (msg.type === EWspChangesEvts.r) {\n\t\t\tconst tocIt = this._srcMap.get(msg.srcUri);\n\t\t\tif (tocIt) {\n\t\t\t\ttocIt.srcSt = -1;\n\t\t\t\ttocIt.nodes = [];\n\t\t\t\tthis._render();\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected _onConnRenewed: () => void;\n\n\tprotected async onConnRenewed() {\n\t\tif (this.hidden) {\n\t\t\tif (this._srcMap) {\n\t\t\t\t//clear la view\n\t\t\t\tthis._srcMap = null;\n\t\t\t\tthis._render();\n\t\t\t}\n\t\t} else {\n\t\t\tthis.rebuildFromRoot();\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin(\"wsp-toc\", 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--focus-outline);\n\t}\n\n\t[hidden] {\n\t\tdisplay: none !important;\n\t}\n\n\t#headTi {\n\t\tpadding: 0 .3em;\n\t\tfont-size: 80%;\n\t\twhite-space: nowrap;\n\t\tcolor: var(--fade-color);\n\t}\n\n\t#headBar {\n\t\tdisplay: flex;\n\t\tflex-wrap: wrap;\n\t\tmin-height: 1.5em;\n\t\tmin-width: 0;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tpadding: .2em;\n\t}\n\n\t#rootSel {\n\t\tflex: 1 0 auto;\n\t\tdisplay: flex;\n\t\tmin-height: 1.5em;\n\t\tmin-width: 0;\n\t}\n\n\twsp-src-pointer {\n\t\tflex: 0 0 auto;\n\t\tmin-width: 0;\n\t\tmargin: 0;\n\t}\n\n\t#options {\n\t\tflex: 1 0 auto;\n\t\t/*background-color: var(--bgcolor);*/\n\t\tjustify-content: flex-end;\n\t}\n\n\t#view {\n\t\tflex: 1;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\toverflow: auto;\n\t\tpadding: 4px 2px;\n\t\tbackground-color: var(--row-bgcolor);;\n\t}\n\n\twsp-toc-item {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\n\twsp-toc-node {\n\t\tdisplay: block;\n\t}\n\n\twsp-toc-side {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\twidth: .7em;\n\t\tborder-inline-start: 1px solid #b89a62;\n\t\tborder-radius: .7em;\n\t}\n\n\twsp-toc-side[current] {\n\t\tbackground: linear-gradient(90deg, #b89a62, transparent .3em);\n\t}\n\n\twsp-toc-side:not([current]):hover {\n\t\t/*background: linear-gradient(90deg, #b89a62, transparent);*/\n\t\tfilter: var(--hover-filter);\n\t}\n\n\twsp-toc-node > wsp-toc-title,\n\twsp-toc-node > .children {\n\t\tpadding-inline-start: .7em; /* décalage en l'absence de wsp-toc-side */\n\t}\n\n\twsp-toc-title {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tcursor: pointer;\n\t\tuser-select: none;\n\t}\n\n\twsp-toc-title[depth='2'] {\n\t\tcolor: var(--alt1-color);\n\t}\n\n\twsp-toc-title[depth='3'] {\n\t\tcolor: var(--alt2-color);\n\t}\n\n\twsp-toc-title[depth='5'] {\n\t\tcolor: var(--alt1-color);\n\t}\n\n\twsp-toc-title[depth='6'] {\n\t\tcolor: var(--alt2-color);\n\t}\n\n\twsp-toc-twisty {\n\t\tpadding-inline-start: 1em;\n\t\tbackground: url(/@skin@/wsp/views/toc/opened.svg) no-repeat center / .9em;\n\t}\n\n\twsp-toc-twisty[state=closed] {\n\t\tbackground: url(/@skin@/wsp/views/toc/closed.svg) no-repeat center / .9em;\n\t}\n\n\twsp-toc-twisty[state=leaf] {\n\t\tbackground: url(/@skin@/wsp/views/toc/leaf.svg) no-repeat center / .9em;\n\t}\n\n\t.notFound {\n\t\tcolor: var(--error-color);\n\t\tfont-style: italic;\n\t}\n\n\twsp-toc-twisty[state=notFound] {\n\t\tbackground: url(/@skin@/wsp/views/toc/notFound.svg) no-repeat center / .9em;\n\t}\n\n\twsp-toc-twisty[state=cycle] {\n\t\tbackground: url(/@skin@/wsp/views/toc/cycle.svg) no-repeat center / .9em;\n\t}\n\n\twsp-toc-twisty:not([state=notFound]):hover {\n\t\tfilter: var(--hover-filter);\n\t\tcursor: auto;\n\t}\n`);\n\ncustomElements.define(\"wsp-toc\", Toc);\n\ninterface ITocItem {\n\tsrcUri: srcUri\n\tsrcId: srcId\n\titSgn: string\n\tsrcSt: number\n\n\t/**\n\t * Title associé à la racine de l'item. Soit c'est le titre de la racine de la TOC, soit\n\t * ce sera le titre des ITocNode dans les quels cet item est référencé (part/@sc:refUri avec des metas à la part).\n\t */\n\ttitle?: string\n\n\t/** Fragments du xpath pointant le noeud parent des ITocNode fils. */\n\txpath: string[]\n\n\tnodes: ITocNode[]\n}\n\ninterface ITocNode {\n\n\t/** XPath relatif à son contexte parent. */\n\txpath: string[]\n\n\t/** Nom du modèle du node : utilisé si pas de title.*/\n\tname: string\n\n\t/**\n\t * Titre du noeud. Si le contenu de ce noeud est externalisé (part/@sc:refUri), et que ce titre est renseigné,\n\t * il s'agit du titre issu des metas de la part qui doit donc surchargé le titre du ITocItem pointé.\n\t */\n\ttitle?: string\n\n\t/** Soit tout le body du node est porté par un autre item (part avec un ptrItem), soit il contient sa liste de fils. */\n\tbody?: srcUri | ITocNode[]\n}\n\n\nexport class WspTocItem extends HTMLElement {\n\ttocItem: ITocItem;\n\n\tbuildXpath(xpath: string[]): srcRef {\n\t\tif (this.tocItem.xpath) xpath.push(...this.tocItem.xpath);\n\t\treturn this.getAttribute(\"srcRef\");\n\t}\n}\n\ncustomElements.define(\"wsp-toc-item\", WspTocItem);\n\n\nexport class WspTocNode extends HTMLElement {\n\ttocNode: ITocNode;\n\n\tbuildXpath(xpath: string[]): srcRef {\n\t\tconst p = this.parentElement.closest(\"wsp-toc-node,wsp-toc-item\") as WspTocNode | WspTocItem;\n\t\tconst srcRef = p.buildXpath(xpath);\n\t\tif (this.tocNode.xpath) xpath.push(...this.tocNode.xpath);\n\t\treturn srcRef;\n\t}\n}\n\ncustomElements.define(\"wsp-toc-node\", WspTocNode);\n\n\nexport class WspTocTitle extends HTMLElement {\n\tconstructor() {\n\t\tsuper();\n\t\tBASIS.makeClickable(this);\n\t\tthis.onclick = this.onClick;\n\t\tthis.onkeydown = this.onKeyDown;\n\t}\n\n\tonClick(ev: MouseEvent) {\n\t\tconst p = this.parentElement.closest(\"wsp-toc-node,wsp-toc-item\") as WspTocNode | WspTocItem;\n\t\tconst xp = [] as string[];\n\t\tconst srcRef = p.buildXpath(xp);\n\t\tconst toc = DOMSH.findHost<Toc>(this);\n\t\ttoc.infoBroker.dispatchInfo(new InfoFocusNodeInItem(xp.join(\"/\"), srcRef), toc);\n\t}\n\n\topenFolder(): boolean {\n\t\tconst twisty = this.querySelector(\"wsp-toc-twisty\") as WspTocTwisty;\n\t\tif (twisty && twisty.state === \"closed\") {\n\t\t\ttwisty.state = \"opened\";\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tcloseFolder(): boolean {\n\t\tconst twisty = this.querySelector(\"wsp-toc-twisty\") as WspTocTwisty;\n\t\tif (twisty && twisty.state === \"opened\") {\n\t\t\ttwisty.state = \"closed\";\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\ttoggleFolderOrGotoCycle(): boolean {\n\t\tconst twisty = this.querySelector(\"wsp-toc-twisty\") as WspTocTwisty;\n\t\tif (twisty) {\n\t\t\tconst st = twisty.state;\n\t\t\tif (st === \"closed\") {\n\t\t\t\ttwisty.state = \"opened\";\n\t\t\t\treturn true;\n\t\t\t} else if (st === \"opened\") {\n\t\t\t\ttwisty.state = \"closed\";\n\t\t\t\treturn true;\n\t\t\t} else if (st === \"cycle\") {\n\t\t\t\ttwisty.gotoCycle();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tensureVisible() {\n\t\tthis.scrollIntoView({block: 'nearest', inline: 'nearest', behavior: 'smooth'});\n\t}\n\n\tonKeyDown(ev: KeyboardEvent) {\n\t\tlet n;\n\t\tswitch (ev.key) {\n\t\tcase 'ArrowDown' :\n\t\t\tn = DOM.findNext(this, null, IS_WspTocTitle);\n\t\t\tif (n) n.focus();\n\t\t\tbreak;\n\t\tcase 'ArrowUp' :\n\t\t\tn = DOM.findPrevious(this, null, IS_WspTocTitle);\n\t\t\tif (n) n.focus();\n\t\t\tbreak;\n\t\tcase 'ArrowLeft' :\n\t\t\tif (window.getComputedStyle(this).direction === 'rtl') {\n\t\t\t\tif (!this.openFolder()) {\n\t\t\t\t\tthis.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowDown'}));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (!this.closeFolder()) {\n\t\t\t\t\tthis.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowUp'}));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.ensureVisible();\n\t\t\tbreak;\n\t\tcase 'ArrowRight' :\n\t\t\tif (window.getComputedStyle(this).direction === 'rtl') {\n\t\t\t\tif (!this.closeFolder()) {\n\t\t\t\t\tthis.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowUp'}));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (!this.openFolder()) {\n\t\t\t\t\tthis.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowDown'}));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.ensureVisible();\n\t\t\tbreak;\n\t\tcase 'Enter' :\n\t\t\tif (ACTION.isAccelPressed(ev)) {\n\t\t\t\tif (!this.toggleFolderOrGotoCycle()) return;\n\t\t\t\tthis.ensureVisible();\n\t\t\t\tbreak;\n\t\t\t}\n\t\tdefault :\n\t\t\t//\tconsole.log(\"evt keydown:::\"+evt.keyCode);\n\t\t\treturn;\n\t\t}\n\t\tev.stopImmediatePropagation();\n\t\tev.preventDefault();\n\t}\n\n}\n\nfunction IS_WspTocTitle(n: Node): n is WspTocTitle {return n instanceof WspTocTitle}\n\ncustomElements.define(\"wsp-toc-title\", WspTocTitle);\n\nexport class WspTocTwisty extends HTMLElement {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.onpointerdown = this.onPointerDown;\n\t\tthis.onclick = this.onClick;\n\t}\n\n\tget state(): 'leaf' | 'opened' | 'closed' | 'notFound' | 'cycle' {return this.getAttribute('state') as any}\n\n\tset state(st: 'leaf' | 'opened' | 'closed' | 'notFound' | 'cycle') {\n\t\tswitch (st) {\n\t\tcase 'opened': {\n\t\t\tconst chList = this.getChildrenList();\n\t\t\tif (chList) DOM.setHidden(chList, false);\n\t\t\tbreak;\n\t\t}\n\t\tcase 'closed': {\n\t\t\tconst chList = this.getChildrenList();\n\t\t\tif (chList) DOM.setHidden(chList, true);\n\t\t\tbreak;\n\t\t}\n\t\tcase 'leaf' :\n\t\tcase 'notFound':\n\t\tcase 'cycle': {\n\t\t\tbreak;\n\t\t}\n\t\tdefault:\n\t\t\tthrow Error(\"State unknown: \" + st);\n\t\t}\n\t\tthis.setAttribute('state', st);\n\t}\n\n\tgotoCycle(): boolean {\n\t\tif (this.state === \"cycle\") {\n\t\t\tconst parent = DOM.findParent(this, null, (n): n is HTMLElement => n instanceof WspTocItem && n.getAttribute('srcRef') === this.getAttribute('srcRef'));\n\t\t\tif (parent) {\n\t\t\t\tconst title = parent.querySelector<HTMLElement>('wsp-toc-title');\n\t\t\t\tif (title) {\n\t\t\t\t\ttitle.focus();\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tgetChildrenList(): HTMLElement {\n\t\tconst parent = DOM.findParent(this, null, (n): n is HTMLElement => n instanceof WspTocNode || (n instanceof HTMLElement && n.classList.contains(\"itemBody\")));\n\t\treturn DOM.findLastChild(parent, (n): n is HTMLElement => n instanceof HTMLElement && n.classList.contains(\"children\"));\n\t}\n\n\tonPointerDown(ev: PointerEvent) {\n\t\tconst st = this.state;\n\t\tif (st === \"leaf\") return;\n\t\tif (st === \"cycle\") {\n\t\t\tif (this.gotoCycle()) {\n\t\t\t\tev.stopImmediatePropagation();\n\t\t\t\tev.preventDefault(); //bloque la prise de focus sur notre propre wsp-toc-title.\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tev.stopImmediatePropagation();\n\t\tthis.state = st === \"closed\" ? \"opened\" : \"closed\";\n\t}\n\n\tonClick(ev: PointerEvent) {\n\t\tev.stopImmediatePropagation(); //bloque le gotoFocus dans les wed.\n\t}\n}\n\ncustomElements.define(\"wsp-toc-twisty\", WspTocTwisty);\n\n/**\n * Barre latérale représentant un item.\n * Note accessibilité : pour une naviegation standard dans l'arbre des titres du plan, on a choisit de ne pas rendre focusbale les WspTocSide.\n */\nexport class WspTocSide extends HTMLElement {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.onclick = this.onClick;\n\t}\n\n\tonClick(ev: MouseEvent) {\n\t\tconst toc = DOMSH.findHost<Toc>(this);\n\t\ttoc.infoBroker.dispatchInfo(new InfoFocusItem(this.parentElement.getAttribute(\"srcRef\")), toc);\n\t}\n}\n\ncustomElements.define(\"wsp-toc-side\", WspTocSide);\n"]}