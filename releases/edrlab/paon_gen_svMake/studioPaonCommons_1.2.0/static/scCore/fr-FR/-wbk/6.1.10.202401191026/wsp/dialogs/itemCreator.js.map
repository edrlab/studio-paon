{"version":3,"sources":["/@back@/wsp/dialogs/itemCreator.tsx"],"names":["BaseElement","BASIS","Button","ButtonActions","POPUP","ItemTypesTree","Action","EHttpStatusCode","RespError","REG","DOM","JSX","DOMSH","FolderEntries","ITEM","SRC","EItemTypeFamily","isFolder","WspImportSrc","ItemCreator","[object Object]","init","titleDialog","uiContext","ev","ct","initialize","dialogInit","titleBar","resizer","viewPortY","initMaxHeight","initWidth","showDialog","reg","cnf","spaceUi","getPref","airItem","env","wsp","isAirItem","codeItemUi","nameBuilder","codeItemBuilderBeforeSave","this","spaceUri","space","srcUri","ext","extLabel","textContent","findReg","body","newContentOptions","Blob","contentType","type","sr","attachShadow","SHADOWDOM_INIT","installSkin","_initAndInstallSkin","localName","_a","startsWith","img","appendChild","createElement","id","src","URL","createObjectURL","classList","add","itemTypesTree","itemTypeReducerIni","itemTypeReducer","acc","cur","idx","datas","noCreator","permsCreator","hasPerm","call","push","newInit","addEventListener","onItemTypeSelected","bind","switchSpaceAir","ctn","spaceRadio","name","onchange","onSwitchAirItem","for","spaceLabel","onclick","onChooseSpace","title","role","ui-context","originalCode","codeItem","codeItemArea","nameInput","autocomplete","spellcheck","oninput","onCodeInput","readOnly","footer","msgArea","createBtn","label","class","onCreateBtn","cancelBtn","onCancelBtn","getElementById","checked","setSpace","onkeypress","onKeypress","selectFirst","Promise","resolve","then","countItemTypes","countItemTypesUntil","setCustomMsg","disabled","setHidden","focus","toFocus","findFlatNext","shadowRoot","IS_focusable","evalCreatable","bodyTpl","folder","itemType","getNewContent","srcFields","cancelLabel","setStandardMsg","undefined","createAirItem","srcNm","createItem","addLeafToUri","renameRes","wspMetaUi","getItemType","itModel","getFamily","res","entry","entries","File","isValidPartUri","update","pushResFolder","e","response","status","forbidden","showNotifForbidden","unauthorized","showNotifError","console","log","extPopup","setCreatableSt","toLowerCase","endsWith","substr","length","buildItemName","async","code","spaceEntries","getChildState","value","buildCodeItem","isSpecialUri","URI_ROOT","extractSpaceLabel","fetchShortDesc","sd","setFolderUri","msg","st","level","hasPermission","srcRoles","srcRi","hasSystemRights","r","isValidCodeItem","loading","getChildStateNow","stopImmediatePropagation","getSelectedItemType","style","visibility","getExtensions","Array","isArray","parentElement","Ã®","actionContext","actions","map","ExtAction","setExt","hidden","indexOf","substring","lastIndexOf","itemCreator","findHost","SpaceSelector","import","startSel","spaceTree","showRoot","selOnDblClick","onSelChange","spSel","setMsg","evalPerm","width","showMenuFromEvent","onNextClose","key","findPopupableParent","close","registerSkin","customElements","define","super","_label","ctx","_id"],"mappings":"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","sourcesContent":["import {BaseElement, BASIS, MsgLabel, OSkinableInit} from \"back/commons/basis\";\nimport {Button, ButtonActions} from \"back/commons/widgets/buttons\";\nimport {OPopupDialogInit, POPUP} from \"back/commons/widgets/popups\";\nimport {SpaceSelector} from \"back/wsp/dialogs/spaceSelector\";\nimport {ItemTypesTree, OItemTypesTreeInit} from \"back/wsp/widgets/itemTypesTree\";\nimport {Action} from \"lib/commons/actions\";\nimport {EHttpStatusCode, IBody, RespError} from \"lib/commons/io/io\";\nimport {IReg, REG} from \"lib/commons/registry\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {FolderEntries, ITEM} from \"lib/wsp/item\";\nimport {JSrcFields, JSrcFieldsTree, SRC, srcUri} from \"lib/wsp/src\";\nimport {IWspUiEnv, Wsp} from \"lib/wsp/wsp\";\nimport {EItemTypeFamily, ItemType, ONewContent} from \"lib/wsp/wspMetaUi\";\nimport {IFolder, isFolder} from \"lib/commons/io/files\";\nimport {WspImportSrc} from \"back/wsp/actions/srcActions\";\nimport {IPopupable} from \"back/commons/widgets/popupable\";\n\nexport interface OItemCreatorInit extends OSkinableInit {\n\n\treg?: IReg<IWspUiEnv>\n\n\t/**\n\t * editable : l'espace d'insertion peut Ãªtre modifiÃ©\n\t * readOnly : l'espace ne peut Ãªtre modifiÃ© mais est affichÃ© (space doit Ãªtre renseignÃ©)\n\t * hidden : l'espace n'est pas affichÃ©  (space doit Ãªtre renseignÃ©, sauf si airItem=forced)\n\t */\n\tspaceUi?: 'editable' | 'readOnly' | 'hidden'\n\tspaceUri?: srcUri | JSrcFields //JSrcFields si connu pour verif perms.\n\n\t/**\n\t * never : airItem non autorisÃ©s [par defaut]\n\t * forced : on crÃ©Ã© toujours un airItem, force spaceUi Ã  'hidden'\n\t * prefered : sÃ©lectionne par dÃ©faut le airItem, mais le user peut choisir le mode espace\n\t * allowed : privillÃ©gie la crÃ©ation dans un espace, mais autorise la crÃ©ation en airItem\n\t */\n\tairItem?: 'never' | 'forced' | 'prefered' | 'allowed'\n\n\t/**\n\t * editable : le code de l'item est modifiable\n\t * readOnly : le code de l'item est affichÃ© mais non Ã©ditable\n\t * hidden : le code de l'item est masquÃ©\n\t * function : Ã©tat dÃ©pendant de l'itemType courant sÃ©lectionnÃ©\n\t */\n\tcodeItemUi?: 'editable' | 'readOnly' | 'hidden' | ((itemType: ItemType | null) => 'editable' | 'readOnly' | 'hidden')\n\n\t/** Code de l'item Ã  utiliser avec son extension. Si l'extension ne matche pas le type d'item, cette valeur n'est pas utilisÃ©e. */\n\tcodeItem?: string\n\n\t/** Construction custom du nom de l'item (name de l'item sans son extension) proposÃ© cotÃ© UI\n\t * @return undefined : les comportements par dÃ©faut sont alors appliquÃ©s */\n\tnameBuilder?: (this: ItemCreator) => string | undefined\n\n\t/** Construction custom du code de l'item (code de l'item avec son extension), appelÃ©e juste avant l'ordre de crÃ©ation\n\t * La rÃ©solution Ã  ce niveau permet entre autre d'interroger des compteurs d'ID\n\t * @return undefined : les comportements par dÃ©faut sont alors appliquÃ©s (nameBuilder, ...) */\n\tcodeItemBuilderBeforeSave?: (this: ItemCreator) => Promise<string | undefined>\n\n\titemTypesTree?: OItemTypesTreeInit\n\n\tnewContentOptions?: ONewContent\n\n\t/**\n\t * Contenu prÃ©dÃ©fini (import externes...).\n\t * 1. Si function, Ã©value d'abord la function.\n\t * 2. Si null, interroge ItemType.getNewContent().\n\t * 3. Si le rÃ©sultat final est null, crÃ©Ã©e un dossier vide; retourner \"\" pour un fichier vide.\n\t */\n\tbody?: IBody | IFolder | null | ((wsp: Wsp, itemType: ItemType, space: null | string, codeItem: string, options?: ONewContent) => Promise<IBody | IFolder | null>);\n}\n\nexport interface ItemCreator extends BaseElement {\n\tinitialize(init: OItemCreatorInit): this\n}\n\nexport class ItemCreator extends BaseElement {\n\n\tstatic openCreateItem(init: OItemCreatorInit, titleDialog: string, uiContext: HTMLElement, ev?: Event): IPopupable<JSrcFields | null> {\n\t\tconst ct = new ItemCreator().initialize(init);\n\t\tconst dialogInit: OPopupDialogInit = {titleBar: titleDialog, resizer: {}, viewPortY: '1/3', initMaxHeight: '70vh', initWidth: 'min(60em, 80vw)'};\n\t\treturn POPUP.showDialog(ct, uiContext, dialogInit);\n\t}\n\n\t/** Configure l'itemCreator en fonction des prefs du registre. */\n\tstatic setDefaultConfigFromReg(reg: IReg<IWspUiEnv>, cnf?: OItemCreatorInit): OItemCreatorInit {\n\t\tif (!cnf) cnf = {};\n\t\tif (!(\"reg\" in cnf)) cnf.reg = reg;\n\t\tif (!(\"spaceUi\" in cnf)) cnf.spaceUi = reg.getPref(\"ItemCreator.spaceUi\");\n\t\tif (!(\"airItem\" in cnf)) cnf.airItem = reg.env.wsp.isAirItem ? reg.getPref(\"ItemCreator.airItem\", 'allowed') : 'never';\n\t\tif (!(\"codeItemUi\" in cnf)) cnf.codeItemUi = reg.getPref(\"ItemCreator.codeItemUi\");\n\t\tif (!(\"nameBuilder\" in cnf)) cnf.nameBuilder = reg.getPref(\"ItemCreator.nameBuilder\");\n\t\tif (!(\"codeItemBuilderBeforeSave\" in cnf)) cnf.codeItemBuilderBeforeSave = reg.getPref(\"ItemCreator.codeItemBuilderBeforeSave\");\n\t\treturn cnf;\n\t}\n\n\t/** Contexte */\n\treg: IReg<IWspUiEnv>;\n\n\tbody?: IBody | IFolder | null | ((wsp: Wsp, itemType: ItemType, space: null | string, codeItem: string, options?: ONewContent) => Promise<IBody | IFolder | null>);\n\tcontentType?: string;\n\toriginalCode: string;\n\tnameBuilder?: (this: ItemCreator) => string;\n\tcodeItemBuilderBeforeSave?: (this: ItemCreator) => Promise<string | undefined>;\n\tcodeItemUi?: 'editable' | 'readOnly' | 'hidden' | ((itemType: ItemType | null) => 'editable' | 'readOnly' | 'hidden')\n\tnewContentOptions?: ONewContent;\n\n\tget wsp(): Wsp {return this.reg.env.wsp};\n\n\t/** ElÃ©ments UI */\n\titemTypesTree: ItemTypesTree;\n\tspaceLabel: HTMLSpanElement;\n\tspaceRadio: HTMLInputElement;\n\tcodeItemArea: HTMLElement;\n\tnameInput: HTMLInputElement;\n\textLabel: HTMLSpanElement;\n\textPopup: ButtonActions<ItemCreator>;\n\tmsgArea: MsgLabel;\n\tcreateBtn: Button;\n\tcancelBtn: Button;\n\n\t/** Etats internes */\n\titemType: ItemType;\n\tspace: srcUri | JSrcFields;\n\n\tget spaceUri() {return typeof this.space === \"object\" ? this.space.srcUri : this.space}\n\n\tairItem: boolean;\n\tcodeItem: string;\n\n\tget ext(): string {return this.extLabel.textContent}\n\n\t/** Controle de l'existance des items. */\n\tspaceEntries: FolderEntries;\n\n\n\tprotected _initialize(init: OItemCreatorInit) {\n\t\tthis.reg = this.findReg(init);\n\t\tthis.body = init.body;\n\t\tthis.newContentOptions = init.newContentOptions;\n\t\tif (this.body instanceof Blob) this.contentType = this.body.type;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"webzone:panel\", sr);\n\t\tthis.reg.installSkin(\"standard-dialog\", sr);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tif (this.contentType?.startsWith(\"image/\")) {\n\t\t\tconst img = sr.appendChild(<img id=\"preview\"/>) as HTMLImageElement;\n\t\t\timg.src = URL.createObjectURL(this.body);\n\t\t\tthis.classList.add(\"preview\");\n\t\t}\n\n\t\t// wrapper de init.itemTypesTree.itemTypeReducer pour filtrer les itemType[noCreator]\n\t\tif (!init.itemTypesTree)\n\t\t\tinit.itemTypesTree = {};\n\t\tconst itemTypeReducerIni = init.itemTypesTree.itemTypeReducer;\n\t\tinit.itemTypesTree.itemTypeReducer = (acc: ItemType[], cur: ItemType, idx?: number, src?: ItemType[]): ItemType[] => {\n\t\t\tif (cur.datas.noCreator) return acc;\n\t\t\tif (cur.datas.permsCreator && !this.reg.hasPerm(cur.datas.permsCreator)) return acc;\n\t\t\tif (itemTypeReducerIni) return itemTypeReducerIni.call(this, acc, cur, idx, src);\n\t\t\telse {\n\t\t\t\tacc.push(cur);\n\t\t\t\treturn acc;\n\t\t\t}\n\t\t}\n\n\t\tthis.itemTypesTree = sr.appendChild(new ItemTypesTree().initialize(BASIS.newInit(init.itemTypesTree, this.reg)));\n\t\tthis.addEventListener('grid-select', this.onItemTypeSelected.bind(this));\n\t\tconst airItem = init.airItem || 'never';\n\t\tconst switchSpaceAir = airItem === 'prefered' || airItem === 'allowed';\n\t\tif (airItem !== 'forced' && init.spaceUi !== 'hidden') {\n\t\t\t//switchSpaceAir ? spaceRoot.appendChild(<input type=\"radio\" id=\"space\">Espace :</input>) :\n\t\t\tconst ctn = sr.appendChild(<div id=\"space\"/>);\n\t\t\tif (switchSpaceAir) this.spaceRadio = ctn.appendChild(<input type=\"radio\" name=\"spOrAir\" id=\"radioSpace\" onchange={this.onSwitchAirItem}/>) as HTMLInputElement;\n\t\t\tctn.appendChild(<label for=\"radioSpace\">Espace :</label>);\n\t\t\tif (init.spaceUi !== 'readOnly') {\n\t\t\t\tthis.spaceLabel = ctn.appendChild(<c-button id=\"spaceLabel\" onclick={this.onChooseSpace} title=\"SÃ©lectionner un espace...\" role=\"menu\" ui-context=\"dialog\">...</c-button>);\n\t\t\t} else {\n\t\t\t\tthis.spaceLabel = ctn.appendChild(<span id=\"spaceLabel\"/>);\n\t\t\t}\n\t\t}\n\t\tif (switchSpaceAir) {\n\t\t\tsr.appendChild(<div id=\"airItem\">\n\t\t\t\t<input type=\"radio\" name=\"spOrAir\" id=\"radioAir\" onchange={this.onSwitchAirItem}/>\n\t\t\t\t<label for=\"radioAir\">~Item flottant~</label>\n\t\t\t</div>);\n\t\t}\n\t\tif (init.nameBuilder) this.nameBuilder = init.nameBuilder;\n\t\tif (init.codeItemUi) this.codeItemUi = init.codeItemUi;\n\t\tif (init.codeItemBuilderBeforeSave) this.codeItemBuilderBeforeSave = init.codeItemBuilderBeforeSave;\n\n\t\tthis.originalCode = this.codeItem = init.codeItem;\n\t\tif (init.codeItemUi !== 'hidden') {\n\t\t\tthis.codeItemArea = sr.appendChild(<div id=\"codeItem\">Code :</div>);\n\t\t\tthis.nameInput = this.codeItemArea.appendChild(<input id=\"codeInput\" autocomplete=\"off\" spellcheck=\"false\" oninput={this.onCodeInput}/>) as HTMLInputElement;\n\t\t\tthis.nameInput.readOnly = init.codeItemUi === 'readOnly';\n\t\t\tthis.extLabel = this.codeItemArea.appendChild(<span id=\"extLabel\"/>) as HTMLInputElement;\n\t\t}\n\t\tconst footer = sr.appendChild(<div id=\"footer\"/>);\n\t\tthis.msgArea = footer.appendChild(<c-msg id=\"msg\"/>) as MsgLabel;\n\t\tthis.createBtn = footer.appendChild(<Button id=\"create\" label=\"CrÃ©er\" class=\"default\" ui-context=\"dialog\" onclick={this.onCreateBtn}/>) as Button;\n\t\tthis.cancelBtn = footer.appendChild(<Button id=\"cancel\" label=\"Annuler\" ui-context=\"dialog\" onclick={this.onCancelBtn}/>) as Button;\n\t\tif (airItem === 'forced') {\n\t\t\tthis.airItem = true;\n\t\t} else if (airItem === 'prefered') {\n\t\t\tthis.airItem = true;\n\t\t\t(sr.getElementById('radioAir') as HTMLInputElement).checked = true;\n\t\t} else {\n\t\t\tthis.setSpace(init.spaceUri || \"\");\n\t\t}\n\t\tthis.onkeypress = this.onKeypress;\n\t}\n\n\tprotected _refresh() {\n\t\t//appelÃ© une fois insÃ©rÃ© dans l'arbre.\n\t\tthis.itemTypesTree.selectFirst();\n\t\tPromise.resolve().then(() => {\n\t\t\t//En asynch car dialog.showModal() Ã©crase le focus.\n\t\t\tconst countItemTypes = this.itemTypesTree.countItemTypesUntil(2);\n\t\t\tif (countItemTypes === 0) {\n\t\t\t\t//POPUP.showNotifWarning(\"Aucun type d'item compatible\", this.reg.env.uiRoot);\n\t\t\t\tthis.msgArea.setCustomMsg(\"Aucun type d'item compatible\", \"warning\");\n\t\t\t\tthis.createBtn.disabled = true;\n\t\t\t\tthis.nameInput.disabled = true;\n\t\t\t} else if (countItemTypes === 1) {\n\t\t\t\t// On masque la zone de sÃ©lection d'IT. Raisons :\n\t\t\t\t// - zone peu utile car sans effet (juste informative)\n\t\t\t\t// - info **fausse** dans le cas des items XML (@see srcActions, wspImportItem)\n\t\t\t\tDOM.setHidden(this.itemTypesTree, true);\n\t\t\t\tif (this.nameInput) this.nameInput.focus();\n\t\t\t} else {\n\t\t\t\tconst toFocus = DOMSH.findFlatNext(this.shadowRoot, this.shadowRoot, DOM.IS_focusable);\n\t\t\t\tif (toFocus) toFocus.focus();\n\t\t\t}\n\t\t});\n\t}\n\n\tasync createItem(): Promise<JSrcFields | null> {\n\t\tswitch (this.evalCreatable()) {\n\t\tcase 'no':\n\t\tcase 'working':\n\t\t\treturn null;\n\t\tcase 'create':\n\t\t\tlet bodyTpl = this.body;\n\t\t\tlet body: IBody | null = null;\n\t\t\tlet folder: IFolder;\n\t\t\tif (typeof bodyTpl === \"function\") {\n\t\t\t\tbodyTpl = await bodyTpl(this.wsp, this.itemType, this.airItem ? null : this.spaceUri, this.codeItem, this.newContentOptions);\n\t\t\t}\n\t\t\tif (!bodyTpl) {\n\t\t\t\tbodyTpl = await this.itemType.getNewContent(this.reg, this.airItem ? null : this.spaceUri, this.codeItem, this.newContentOptions);\n\t\t\t\tif (bodyTpl == null) return null;\n\t\t\t}\n\t\t\tif (isFolder(bodyTpl)) {\n\t\t\t\tfolder = bodyTpl;\n\t\t\t} else {\n\t\t\t\tbody = bodyTpl;\n\t\t\t}\n\t\t\tlet srcFields: JSrcFields;\n\t\t\tconst cancelLabel = this.cancelBtn.label;\n\t\t\ttry {\n\t\t\t\tthis.msgArea.setStandardMsg(\"saving\");\n\t\t\t\tthis.createBtn.disabled = true;\n\t\t\t\tthis.cancelBtn.label = \"Fermer\";\n\t\t\t\tlet codeItem = this.codeItem;\n\t\t\t\tif (this.codeItemBuilderBeforeSave) {\n\t\t\t\t\tconst codeItemBuilderBeforeSave = await this.codeItemBuilderBeforeSave.call(this);\n\t\t\t\t\tif (codeItemBuilderBeforeSave !== undefined) codeItem = codeItemBuilderBeforeSave;\n\t\t\t\t}\n\t\t\t\tif (this.airItem) {\n\t\t\t\t\tsrcFields = await ITEM.createAirItem(this.wsp, null, this, body, {srcNm: codeItem});\n\t\t\t\t} else {\n\t\t\t\t\tsrcFields = await ITEM.createItem(this.wsp, null, this, body, SRC.addLeafToUri(this.spaceUri, codeItem));\n\t\t\t\t}\n\t\t\t\tif (folder) {\n\t\t\t\t\tconst renameRes = codeItem !== folder.name && this.wsp.wspMetaUi.getItemType(srcFields.itModel)?.getFamily() === EItemTypeFamily.res;\n\t\t\t\t\tfor (let entry of folder.entries) {\n\t\t\t\t\t\tif (entry instanceof File) {\n\t\t\t\t\t\t\tif (SRC.isValidPartUri(entry.name) === true) {\n\t\t\t\t\t\t\t\tawait ITEM.update(this.wsp, this, SRC.addLeafToUri(srcFields.srcUri, renameRes && entry.name === folder.name ? this.codeItem : entry.name), entry);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tawait WspImportSrc.pushResFolder(entry, srcFields.srcUri, this.wsp, this);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tif (e instanceof RespError) {\n\t\t\t\t\tswitch (e.response.status) {\n\t\t\t\t\tcase EHttpStatusCode.forbidden:\n\t\t\t\t\t\tPOPUP.showNotifForbidden(this.airItem ? \"Il est interdit de crÃ©er un item flottant.\" : \"Il est interdit de crÃ©er un item Ã  cet emplacement.\", this);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase EHttpStatusCode.unauthorized:\n\t\t\t\t\t\tPOPUP.showNotifForbidden(\"Vous ne disposez pas des droits pour crÃ©er cet item.\", this);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tPOPUP.showNotifError(`Une erreur est survenue durant la crÃ©ation de cet item : ${e.response.status}`, this);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tPOPUP.showNotifError(\"Une erreur est survenue durant la crÃ©ation de cet item.\", this);\n\t\t\t\t}\n\t\t\t\tconsole.log(e);\n\t\t\t} finally {\n\t\t\t\tthis.msgArea.setStandardMsg(null);\n\t\t\t\tthis.createBtn.disabled = false;\n\t\t\t\tthis.cancelBtn.label = cancelLabel;\n\t\t\t}\n\t\t\treturn srcFields;\n\t\t}\n\t}\n\n\tasync setExt(ext: string) {\n\t\tthis.extLabel.textContent = ext;\n\t\tif (this.extPopup) this.extPopup.label = ext;\n\t\tthis.setCreatableSt('working');\n\t\tlet name: string = undefined;\n\t\tif (this.nameBuilder)\n\t\t\tname = this.nameBuilder();\n\t\tif (name === undefined) {\n\t\t\tif (this.originalCode && this.originalCode.toLowerCase().endsWith(ext.toLowerCase())) {\n\t\t\t\tname = this.originalCode.substr(0, this.originalCode.length - ext.length);\n\t\t\t} else {\n\t\t\t\tname = await this.itemType.buildItemName(this.wsp, this.airItem ? null : this.spaceUri, ext,\n\t\t\t\t\tthis.airItem ? null : async (code) => await this.spaceEntries.getChildState(code) !== 'used');\n\t\t\t}\n\t\t}\n\t\tif (this.nameInput) this.nameInput.value = name;\n\t\tthis.buildCodeItem(name, ext);\n\t}\n\n\tsetSpace(space: srcUri | JSrcFields) {\n\t\tlet spaceUri = typeof space === \"object\" ? space.srcUri : space;\n\t\tif (ITEM.isSpecialUri(spaceUri)) space = spaceUri = SRC.URI_ROOT; //sÃ©curitÃ©, pas de crÃ©taion d'items dans des uri spÃ©ciales\n\t\tif (this.spaceRadio) this.spaceRadio.checked = true;\n\t\tif (this.spaceLabel) this.spaceLabel.textContent = ITEM.extractSpaceLabel(spaceUri);\n\t\tif (!this.spaceEntries) this.spaceEntries = new FolderEntries(this.wsp, this);\n\t\tthis.space = space;\n\t\tthis.airItem = false;\n\t\tif (typeof space === \"string\") {\n\t\t\tthis.wsp.fetchShortDesc(space).then((sd) => {\n\t\t\t\tif (space !== this.space) return; //racecond\n\t\t\t\tthis.space = sd;\n\t\t\t\tthis.evalCreatable();\n\t\t\t})\n\t\t}\n\t\tthis.spaceEntries.setFolderUri(spaceUri);\n\t}\n\n\tevalCreatable(): 'no' | 'create' | 'working' {\n\t\tlet msg: string = \"\";\n\t\tlet st: 'create' | 'working' = 'create';\n\t\tlet level: 'info' | 'error' = 'info';\n\t\tif (typeof this.space === \"object\" && !this.reg.hasPermission(\"create.item\", this.space.srcRoles, null, this.space.srcRi)) {\n\t\t\tmsg = this.reg.hasSystemRights(\"create.item\", this.space.srcRi) ? \"Vous ne disposez pas des droits pour ajouter un item dans cet espace.\" : \"Impossible d'ajouter un item dans cet espace.\";\n\t\t\tlevel = \"error\";\n\t\t} else if (!this.itemType) {\n\t\t\tmsg = \"SÃ©lectionnez un type d'item dans la liste\";\n\t\t} else if (!this.codeItem) {\n\t\t\tmsg = \"Renseignez le code de l'item\";\n\t\t} else {\n\t\t\tconst r = ITEM.isValidCodeItem(this.codeItem);\n\t\t\tif (r !== true) msg = r;\n\t\t\telse if (!this.airItem) {\n\t\t\t\tif (this.spaceEntries.loading) {\n\t\t\t\t\tst = 'working';\n\t\t\t\t\tthis.spaceEntries.loading.then(() => {this.evalCreatable()});\n\t\t\t\t} else {\n\t\t\t\t\tif (this.spaceEntries.getChildStateNow(this.codeItem) === \"used\") {\n\t\t\t\t\t\tmsg = \"Cet item existe dÃ©jÃ , changez de code\";\n\t\t\t\t\t\tlevel = \"error\";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.msgArea.setCustomMsg(msg, level);\n\t\tthis.setCreatableSt(msg ? 'no' : st);\n\t\treturn msg ? 'no' : st;\n\t}\n\n\tsetCreatableSt(st: 'create' | 'no' | 'working') {\n\t\tthis.createBtn.disabled = st !== 'create';\n\t}\n\n\tonItemTypeSelected(ev?: CustomEvent) {\n\t\tif (ev) ev.stopImmediatePropagation();\n\t\tconst itemType = this.itemTypesTree.getSelectedItemType();\n\t\tif (itemType === this.itemType) return;\n\t\tthis.itemType = itemType;\n\t\tif (itemType == null) {\n\t\t\tthis.codeItem = null;\n\t\t\tif (this.codeItemArea) this.codeItemArea.style.visibility = 'hidden';\n\t\t\tthis.evalCreatable();\n\t\t} else {\n\t\t\tif (typeof this.codeItemUi === \"function\" && this.codeItemArea) {\n\t\t\t\tconst codeItemUi = this.codeItemUi(itemType);\n\t\t\t\tif (codeItemUi === 'hidden') this.codeItemArea.style.visibility = 'hidden';\n\t\t\t\telse this.codeItemArea.style.visibility = '';\n\t\t\t\tif (this.nameInput) this.nameInput.readOnly = codeItemUi === 'readOnly';\n\t\t\t} else if (this.codeItemArea)\n\t\t\t\tthis.codeItemArea.style.visibility = '';\n\n\t\t\tconst ext = itemType.getExtensions(this.contentType);\n\t\t\tif (Array.isArray(ext)) {\n\t\t\t\tif (!this.extPopup) this.extPopup = this.extLabel.parentElement.appendChild(<ButtonActions id=\"extPopup\" Ã®={{\n\t\t\t\t\treg: this.reg,\n\t\t\t\t\tuiContext: 'dialog',\n\t\t\t\t\tactionContext: this\n\t\t\t\t}}/>) as ButtonActions<ItemCreator>;\n\t\t\t\tthis.extPopup.actions = ext.map((e) => new ExtAction(e));\n\t\t\t\tthis.setExt(ext[0]);\n\t\t\t\tDOM.setHidden(this.extLabel, true);\n\t\t\t\tthis.extPopup.hidden = false;\n\t\t\t} else {\n\t\t\t\tDOM.setHidden(this.extLabel, false);\n\t\t\t\tif (this.extPopup) this.extPopup.hidden = true;\n\t\t\t\tthis.setExt(ext || (this.originalCode && this.originalCode.indexOf(\".\") > -1 ? this.originalCode.substring(this.originalCode.lastIndexOf(\".\")) : null));\n\t\t\t}\n\t\t}\n\t}\n\n\tasync onChooseSpace(this: HTMLButtonElement, ev: Event) {\n\t\tconst itemCreator = DOMSH.findHost(this) as ItemCreator;\n\t\tconst {SpaceSelector} = await import(\"back/wsp/dialogs/spaceSelector.js\");\n\t\tconst ct = new SpaceSelector().initialize({\n\t\t\treg: itemCreator.reg,\n\t\t\tstartSel: itemCreator.spaceUri,\n\t\t\tspaceTree: {\n\t\t\t\tshowRoot: true\n\t\t\t},\n\t\t\tselOnDblClick: true,\n\t\t\tonSelChange: (src: JSrcFieldsTree, spSel: SpaceSelector) => {\n\t\t\t\tif (!src) spSel.setMsg(\"SÃ©lectionnez un espace.\", false);\n\t\t\t\telse if (spSel.evalPerm(\"action.src#create.item\", src, \"Vous ne disposez pas des droits pour crÃ©er un item dans cet espace.\", \"Il est impossible de crÃ©er un item dans cet espace.\")) {\n\t\t\t\t\tspSel.setMsg(null, true);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tct.style.width = \"35em\";\n\t\tconst space = await POPUP.showMenuFromEvent<JSrcFields | undefined>(ct, ev, itemCreator, {}).onNextClose();\n\t\tif (space) {\n\t\t\titemCreator.setSpace(space);\n\t\t\titemCreator.evalCreatable();\n\t\t}\n\t}\n\n\tonSwitchAirItem(this: HTMLInputElement) {\n\t\tconst itemCreator = DOMSH.findHost(this) as ItemCreator;\n\t\titemCreator.airItem = !itemCreator.spaceRadio.checked;\n\t\titemCreator.setExt(itemCreator.ext);\n\t}\n\n\tonCodeInput(this: HTMLInputElement, ev: Event) {\n\t\tconst itemCreator = DOMSH.findHost(this) as ItemCreator;\n\t\titemCreator.buildCodeItem(this.value, itemCreator.ext);\n\t}\n\n\tasync onKeypress(ev: KeyboardEvent) {\n\t\tif (ev.key === \"Enter\") {\n\t\t\tconst r = await this.createItem();\n\t\t\tif (r) POPUP.findPopupableParent(this).close(r);\n\t\t}\n\t}\n\n\tonCancelBtn(this: Button) {\n\t\tPOPUP.findPopupableParent(this).close();\n\t}\n\n\tasync onCreateBtn(this: HTMLElement) {\n\t\tconst r = await DOMSH.findHost<ItemCreator>(this).createItem();\n\t\tif (r) POPUP.findPopupableParent(this).close(r);\n\t}\n\n\tprotected buildCodeItem(name: string, ext: string) {\n\t\tthis.codeItem = name + ext;\n\t\tthis.evalCreatable();\n\t}\n}\n\nREG.reg.registerSkin('wsp-item-creator', 1, /* language=CSS */ `\n\t:host {\n\t\tmin-height: 10vh;\n\t}\n\n\t:host(.preview) {\n\t\tmin-height: 35vh;\n\t}\n\n\twsp-itemtypes-tree {\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tmargin-bottom: .5em;\n\t}\n\n\twsp-itemtypes-tree[hidden] {\n\t\tvisibility: hidden;\n\t\tmargin: 0;\n\t}\n\n\t#preview {\n\t\talign-self: center;\n\t\tmax-width: 60vw;\n\t\tmax-height: 15vh;\n\t\tmargin: 2px;\n\t}\n\n\t#space {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\talign-items: center;\n\t}\n\n\t#space,\n\t#airItem {\n\t\tmargin: .2em;\n\t}\n\n\t#codeItem {\n\t\tmargin: 1em;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\talign-items: center;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--focus-outline);\n\t}\n\n\t#spaceLabel {\n\t\tmargin: .5em;\n\t}\n\n\t#extPopup {\n\t\tdisplay: inline-flex;\n\t\tfont-weight: bold;\n\t\tmargin: 0;\n\t}\n\n\t#extPopup[hidden] {\n\t\tdisplay: none;\n\t}\n\n\t#codeInput {\n\t\tmargin-inline-start: .5em;\n\t\tfont-size: inherit;\n\t\tbackground-color: var(--form-bgcolor);\n\t\tcolor: var(--form-color);\n\t\tborder: 1px solid var(--border-color);\n\t}\n\n\t#msg {\n\t\tflex: 1;\n\t\tmargin: 0 .5em;\n\t\tjustify-content: start;\n\t}\n\n\tinput[readonly], #codeInput[readonly] {\n\t\tbackground-color: initial;\n\t\tborder-color: transparent;\n\t}\n\n`);\n\ncustomElements.define(\"wsp-item-creator\", ItemCreator);\n\nclass ExtAction extends Action<ItemCreator> {\n\tconstructor(ext: string) {\n\t\tsuper(ext);\n\t\tthis._label = ext;\n\t}\n\n\texecute(ctx: ItemCreator, ev?: Event) {\n\t\tctx.setExt(this._id);\n\t}\n}"]}