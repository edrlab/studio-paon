{"version":3,"sources":["/@back@/wsp/apps/wspBaseApp.tsx"],"names":["BaseElementAsync","BASIS","AppFrameDeskFeat","AccelKeyMgr","ActionMenuDep","REG","Desk","AutoMigrWspAction","CreateDrfWspAction","CreateDrvWspAction","DeleteWspAction","ExportWspAction","OpenPermsWspAction","OpenPropsWspAction","ScanFsUpdatesAction","DOM","JSX","ShadowJsx","WedSearchCoordinator","POPUP","AppHeader","VIEWS","WSPPACK","ButtonActions","ImportScar","OpenWspTrash","WspBaseApp","[object Object]","this","_wspTi","createElement","id","_wspIcon","_wspTypeTi","_headTitleBar","skin","init","pendingUi","sr","shadowRoot","clearContent","appendChild","universe","auth","currentUser","setStandardMsg","checkCompat","setCustomMsg","append","knownNavCompat","map","n","url","href","target","name","wsp","waitForAvailable","_lastWspMetaUi","wspMetaUi","e","console","log","wspTitle","isAccessDenied","infoWsp","openPropsWspOnError","infoWspError","status","isDeleted","act","ctx","reg","createSubReg","isAvailable","execute","codeApp","perm","env","uiRoot","place","newPlaceWsp","eventsMgr","on","onWspLiveStateChange","bind","infoBroker","wedSearchCoord","initRegExtPoints","injectInits","getList","lstn","result","Promise","hasPerm","appErrorStatus","accelKeyMgr","addEventListener","ev","handleKeyboardEvent","reset","initFromMapActions","getListAsMap","localName","focusListening","actionsMain","actionsMore","src","getIcon","textContent","buildWspDefTitle","wspType","short","lang","title","hasHeadTitleBar","appHeader","initialize","actionContext","î","actions","mainActions","moreActions","srcLabel","wspLabel","setTextContent","setAttr","_lastSrcLabel","_lastWspLabel","dispatchViewChange","initializedAsync","reloadApp","_refreshTitle","_refreshMigration","refresh","_PopupWspError","confirm","document","body","kind","cancelLbl","isIn","desk","gotoHome","isInError","executeIfAvailable","_lastMigrPopup","close","isMigrationNeeded","showNotifWarning","setLabel","onNextClose","then","list","action","sortKey","accel","inShortDescAccelKey","addToList","getId","prefixSub","addGlobalAction","setIcon","setActionLists","requireVisiblePerm","registerSkin"],"mappings":"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","sourcesContent":["import {BaseElementAsync, BASIS, MsgLabel, OSkinableInit} from \"back/commons/basis\";\nimport {AppFrameDeskFeat, IAppCtx} from \"back/core/appFrame\";\nimport {IWspUiEnv, Wsp} from \"lib/wsp/wsp\";\nimport {IInfoBroker} from \"lib/commons/infos\";\nimport {AccelKeyMgr, Action, ActionMenuDep} from \"lib/commons/actions\";\nimport {IReg, IRegPointer, REG} from \"lib/commons/registry\";\nimport {ChainUniverse, IChainEnv} from \"lib/wsp/chain\";\nimport {Desk} from \"lib/commons/desk\";\nimport {AutoMigrWspAction, CreateDrfWspAction, CreateDrvWspAction, DeleteWspAction, ExportWspAction, OpenPermsWspAction, OpenPropsWspAction, ScanFsUpdatesAction} from \"back/wsp/actions/wspActions\";\nimport {DOM, JSX, ShadowJsx} from \"lib/commons/xml/dom\";\nimport {IWedSearchCoordinatorPointer, WedSearchCoordinator} from \"back/edit/wed/features/searchBar\";\nimport {POPUP, PopupNotif} from \"back/commons/widgets/popups\";\nimport {AppHeader} from \"back/core/widgets/appHeader\";\nimport {VIEWS} from \"lib/commons/views\";\nimport {WSPPACK} from \"lib/wsp/pack\";\nimport {ButtonActions, OButtonActionsInit} from \"back/commons/widgets/buttons\";\nimport {ImportScar, OpenWspTrash} from \"back/wsp/actions/srcActions\";\nimport {WspMetaUi} from \"lib/wsp/wspMetaUi\";\n\nexport abstract class WspBaseApp extends BaseElementAsync {\n\n\treg: IReg<IWspUiEnv>;\n\tuniverse: ChainUniverse;\n\n\twsp: Wsp;\n\n\tinfoBroker: IInfoBroker;\n\n\taccelKeyMgr: AccelKeyMgr<IRegPointer<IWspUiEnv>>;\n\n\tappErrorStatus: 'accessDenied';\n\n\tappHeader: AppHeader<any>;\n\n\tprotected _config: IAppCtx<IChainEnv> & OSkinableInit;\n\n\tprotected _wspTi: HTMLElement = <div id=\"wspTi\"/>;\n\tprotected _wspIcon: HTMLImageElement = <img id=\"wspIcon\"/> as HTMLImageElement\n\tprotected _wspTypeTi: HTMLElement = <div id=\"wspTypeTi\"/>;\n\tprotected _headTitleBar: HTMLElement =<div id=\"wspHeader\"><ShadowJsx skin=\"wspBaseApp/headerBar\"/></div>\n\n\t/** mémoire des derniers labels utilisés pour le label de la view. */\n\tprotected _lastSrcLabel: string;\n\n\tprotected _lastWspLabel: string;\n\n\t/** mémoire du dernier wspMetaUi pour forcer un reload si différent. */\n\tprotected _lastWspMetaUi: WspMetaUi;\n\n\t/** @see IApp.getHeadTitleBar() */\n\tgetHeadTitleBar(): HTMLElement {\n\t\treturn this._headTitleBar;\n\t}\n\n\t/** Chargement de l'atelier */\n\tprotected async _initWsp(init: IAppCtx<IChainEnv> & OSkinableInit, pendingUi: MsgLabel) {\n\t\tconst sr = this.shadowRoot;\n\t\tBASIS.clearContent(sr);\n\t\tsr.appendChild(pendingUi);\n\t\tif (!this.universe.auth.currentUser) {\n\t\t\tpendingUi.setStandardMsg('needAuth');\n\t\t\treturn false; //throw Error(\"Auth required\");\n\t\t}\n\n\t\tif (!Desk.checkCompat('edit')) {\n\t\t\tpendingUi.setCustomMsg(\"\");\n\t\t\tpendingUi.append(\n\t\t\t\t<div>\n\t\t\t\t\t<p>Ce navigateur n'est pas compatible avec l'édition de texte riche.</p>\n\t\t\t\t\t<p>Vous pouvez utiliser un des navigateurs à jour suivants :</p>\n\t\t\t\t\t<ul>\n\t\t\t\t\t\t{Desk.knownNavCompat.map((n) => n.url ? <li><a href={n.url} target=\"_blank\">{n.name}</a></li> : <li>{n.name}</li>)}\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t);\n\t\t\treturn false;\n\t\t}\n\n\t\tpendingUi.setStandardMsg('loading');\n\n\t\t//Chargement de l'atelier\n\t\ttry {\n\t\t\tawait this.wsp.waitForAvailable(this);\n\t\t\tthis._lastWspMetaUi = this.wsp.wspMetaUi;\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t\tconst wspTitle = this.wsp.wspTitle;\n\t\t\tif (this.wsp.isAccessDenied) {\n\t\t\t\tpendingUi.setCustomMsg(wspTitle ? `Accès à l'atelier '${wspTitle}' non autorisé.` : `Accès non autorisé à l'atelier.`, \"error\");\n\t\t\t\treturn false;\n\t\t\t} else if (this.wsp.infoWsp && !this.wsp.wspMetaUi) {\n\t\t\t\tpendingUi.setCustomMsg(\"Échec au chargement du modèle documentaire de l'atelier.\", \"error\");\n\t\t\t\tif (!await this.openPropsWspOnError(init)) return false;\n\t\t\t} else if (this.wsp.infoWspError) {\n\t\t\t\tif (this.wsp.infoWspError.status === 'noWsp') {\n\t\t\t\t\tpendingUi.setCustomMsg(\"L'atelier n'est pas (ou plus) disponible.\", \"error\");\n\t\t\t\t\treturn false;\n\t\t\t\t} else {\n\t\t\t\t\tpendingUi.setCustomMsg(\"Échec au chargement de l'atelier.\", \"error\");\n\t\t\t\t\tif (!await this.openPropsWspOnError(init)) return false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tpendingUi.setStandardMsg('netError');\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tif (this.wsp.isDeleted) {\n\t\t\t//Ajouter un param pour autoriser la consultation du wsp dans trash ?\n\t\t\tpendingUi.setCustomMsg(\"L'atelier a été supprimé.\", \"error\");\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tprotected async openPropsWspOnError(init: IAppCtx<IChainEnv> & OSkinableInit) {\n\t\tconst act = new OpenPropsWspAction();\n\t\tconst ctx: IRegPointer<IWspUiEnv> = {reg: REG.createSubReg(init.reg, this.wsp.reg)}\n\t\tif (act.isAvailable(ctx)) {\n\t\t\tawait act.execute(ctx);\n\t\t\tawait this.wsp.waitForAvailable(this);\n\t\t\tthis._lastWspMetaUi = this.wsp.wspMetaUi;\n\t\t}\n\t\treturn this.wsp.isAvailable;\n\t}\n\n\t/** Init du registre et check perm. */\n\tprotected async _initReg(init: IAppCtx<IChainEnv>, codeApp: string, perm: string, pendingUi: MsgLabel) {\n\t\tconst reg = this.reg = REG.createSubReg(init.reg, this.wsp.reg);\n\t\treg.env.uiRoot = this;\n\t\treg.env.place = this.wsp.newPlaceWsp();\n\t\treg.env.place.eventsMgr.on(\"wspLiveStateChange\", this.onWspLiveStateChange.bind(this));\n\t\treg.env.infoBroker = this.infoBroker;\n\t\t(this.reg.env as IWedSearchCoordinatorPointer).wedSearchCoord = new WedSearchCoordinator();\n\n\t\tawait this.initRegExtPoints();\n\t\tif (this._lastWspMetaUi !== this.wsp.wspMetaUi) return false; //raceCond\n\n\t\t// Injection d'init avant construction du contenu.\n\t\tconst injectInits = reg.getList<(app: WspBaseApp) => void | Promise<void>>(`${codeApp}:init`);\n\t\tif (injectInits) for (const lstn of injectInits) {\n\t\t\tconst result = lstn(this);\n\t\t\tif (result instanceof Promise) {\n\t\t\t\tawait result;\n\t\t\t\tif (this._lastWspMetaUi !== this.wsp.wspMetaUi) return false; //raceCond\n\t\t\t}\n\t\t}\n\n\t\t//check perm pour cette ihm.\n\t\tif (!reg.hasPerm(perm)) {\n\t\t\tpendingUi.setStandardMsg('accessDenied');\n\t\t\tthis.appErrorStatus = 'accessDenied';\n\t\t\treturn false;\n\t\t}\n\n\t\t//AccelKeyMgr\n\t\tif (!this.accelKeyMgr) {\n\t\t\tthis.accelKeyMgr = new AccelKeyMgr();\n\t\t\tthis.addEventListener('keydown', function (this: WspBaseApp, ev: KeyboardEvent) {\n\t\t\t\tthis.accelKeyMgr.handleKeyboardEvent(ev, this)\n\t\t\t});\n\t\t} else {\n\t\t\tthis.accelKeyMgr.reset();\n\t\t}\n\t\tthis.accelKeyMgr.initFromMapActions(reg.getListAsMap(`accelkeys:${this.localName}:global`));\n\t\treturn true;\n\t}\n\n\tprotected _initAppHeader(init: IAppCtx<IChainEnv>, focusListening: HTMLElement[], actionsMain: string, actionsMore: string) {\n\t\tconst reg = this.reg;\n\t\tthis._wspIcon.src = this.wsp.wspMetaUi.getIcon() || \"/@skin@/wsp/objects/wsp/wsp.svg\";\n\t\tthis._wspTypeTi.textContent = null;\n\t\tthis._wspTypeTi.append(this._wspIcon, WSPPACK.buildWspDefTitle(this.wsp.infoWsp.wspType, {short: true, lang: true}));\n\t\tthis._wspTypeTi.title = WSPPACK.buildWspDefTitle(this.wsp.infoWsp.wspType); //complet avec détail version.\n\t\tif (init.hasHeadTitleBar) {\n\t\t\t// appHeader masqué, actions visibles dans la HeadTitleBar\n\t\t\tthis.appHeader = new AppHeader<WspBaseApp>().initialize({\n\t\t\t\treg,\n\t\t\t\tactionContext: this,\n\t\t\t\tfocusListening\n\t\t\t});\n\n\t\t\t//Version avec ButtonActions d'options à côté\n\t\t\tBASIS.clearContent(this._headTitleBar.shadowRoot);\n\t\t\tthis._headTitleBar.shadowRoot.appendChild(<ButtonActions id=\"wspActions\" î={{\n\t\t\t\tactions: reg.getList(actionsMain),\n\t\t\t\tactionContext: this,\n\t\t\t\t// icon: \"/@skin@/commons/icons/actions.svg\",\n\t\t\t\ttitle: \"Actions sur cet atelier\"\n\t\t\t} as OButtonActionsInit<WspBaseApp>}>\n\t\t\t\t<div>\n\t\t\t\t\t{this._wspTi}\n\t\t\t\t\t{this._wspTypeTi}\n\t\t\t\t</div>\n\t\t\t</ButtonActions>);\n\t\t} else {\n\t\t\t// appHeader visible\n\t\t\t// Ancienne approche - todo : graphisme à retravailler si nouvel usage...\n\t\t\tthis.appHeader = new AppHeader<WspBaseApp>().initialize({\n\t\t\t\treg,\n\t\t\t\tmainActions: reg.getList(actionsMain),\n\t\t\t\tmoreActions: reg.getList(actionsMore),\n\t\t\t\tactionContext: this,\n\t\t\t\tfocusListening\n\t\t\t});\n\t\t\tthis.appHeader.appendChild(<div id=\"wspHeader\"><ShadowJsx skin=\"wspBaseApp/headerBar\">\n\t\t\t\t{this._wspTi}\n\t\t\t\t{this._wspTypeTi}\n\t\t\t</ShadowJsx></div>);\n\t\t}\n\t}\n\n\tprotected _refreshTitle(srcLabel: string) {\n\t\tconst wspLabel = this.wsp.wspTitle || \"[Atelier non disponible]\";\n\t\tDOM.setTextContent(this._wspTi, wspLabel);\n\t\tDOM.setAttr(this._wspTi, \"title\", wspLabel);\n\t\tDOM.setAttr(this, \"label\", srcLabel ? srcLabel + \" - \" + wspLabel : wspLabel);\n\t\tif (this._lastSrcLabel !== srcLabel || this._lastWspLabel !== wspLabel) VIEWS.dispatchViewChange(this);\n\t\tthis._lastSrcLabel = srcLabel;\n\t\tthis._lastWspLabel = wspLabel;\n\t}\n\n\tprotected async onWspLiveStateChange(wsp: Wsp) {\n\t\tif (wsp !== this.wsp) return;\n\t\tif (this._lastWspMetaUi && this.wsp.wspMetaUi && this._lastWspMetaUi !== this.wsp.wspMetaUi) {\n\t\t\t//Changement des WspMetaUi, on reload\n\t\t\tawait this.initializedAsync; // on séquentialise des onWspLiveStateChange concurrents.\n\t\t\tthis.reloadApp();\n\t\t\treturn;\n\t\t}\n\t\tthis._refreshTitle(null);\n\t\tthis._refreshMigration();\n\t\tthis.appHeader.refresh();\n\t\tif (wsp.isDeleted === true) {\n\t\t\tif (this._PopupWspError) return;\n\t\t\tthis._PopupWspError = POPUP.confirm(\"L'atelier a été supprimé\", document.body, {kind: \"forbidden\", cancelLbl: null});\n\t\t\tawait this._PopupWspError;\n\t\t\tthis._PopupWspError = null;\n\t\t\tif (AppFrameDeskFeat.isIn(desk)) desk.gotoHome();\n\t\t} else if (wsp.isAccessDenied) {\n\t\t\tif (this._PopupWspError) return;\n\t\t\tthis._PopupWspError = POPUP.confirm(\"Vous ne disposez plus d'accès à cet atelier\", document.body, {kind: \"forbidden\", cancelLbl: null});\n\t\t\tawait this._PopupWspError;\n\t\t\tthis._PopupWspError = null;\n\t\t\tif (AppFrameDeskFeat.isIn(desk)) desk.gotoHome();\n\t\t} else if (wsp.isInError) {\n\t\t\tif (this._PopupWspError) return;\n\t\t\tthis._PopupWspError = POPUP.confirm(\"La configuration de l'atelier est en erreur. Veuillez vérifier ses propriétés.\", this, {kind: \"error\", cancelLbl: null});\n\t\t\tawait this._PopupWspError;\n\t\t\tthis._PopupWspError = null;\n\t\t\tif (AppFrameDeskFeat.isIn(desk)) desk.gotoHome();\n\t\t\tnew OpenPropsWspAction().executeIfAvailable({reg: REG.createSubReg(this.reg, this.wsp.reg)});\n\t\t}\n\t}\n\n\tabstract reloadApp(): void\n\n\tprotected _PopupWspError: Promise<boolean>\n\n\tprotected _refreshMigration() {\n\t\tif (this._lastMigrPopup) this._lastMigrPopup.close();\n\t\tif (this.wsp.infoWsp && this.wsp.infoWsp.isMigrationNeeded) {\n\t\t\tthis._lastMigrPopup = POPUP.showNotifWarning(<div>Migration des données de l'atelier nécessaire.</div>, this, {actions: [new AutoMigrWspAction().setLabel(\"Migrer\")], actionContext: this});\n\t\t\tthis._lastMigrPopup.onNextClose().then(() => {this._lastMigrPopup = null});\n\t\t}\n\t}\n\n\tprotected _lastMigrPopup: PopupNotif | null;\n\n\n\taddGlobalAction(list: string, action: Action<IRegPointer<IWspUiEnv>>, sortKey: number, accel?: string, inShortDescAccelKey?: boolean) {\n\t\tthis.reg.addToList(list, action.getId(), 1, action);\n\t\tif (accel) {\n\t\t\tthis.reg.addToList(`accelkeys:${this.localName}:global`, accel, 1, action);\n\t\t\tif (inShortDescAccelKey) {\n\t\t\t\t//Quand l'action peut être plus pertinente lorsqu'un IShortDescCtx est pris en compte.\n\t\t\t\tthis.reg.addToList(\"accelkeys:wsp:shortDesc\", accel, 1, action)\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected abstract initRegExtPoints(): Promise<void>;\n\n\tprotected addWspActionsMain(list: string, prefixSub: string) {\n\t\tthis.addGlobalAction(list, new AutoMigrWspAction().setLabel(\"Migration nécessaire...\").setIcon(\"/@skin@/wsp/apps/warning.svg\"), 0);\n\t\tthis.addGlobalAction(list, new ActionMenuDep('wspConfig').setActionLists(prefixSub + \":config\").setLabel(\"Configuration\"), 10);\n\t\tthis.addGlobalAction(list, new ActionMenuDep('wspContent').setActionLists(prefixSub + \":content\").setLabel(\"Contenu\"), 20);\n\t\tthis.addGlobalAction(list, new ActionMenuDep('wspLayers').setActionLists(prefixSub + \":layers\").setLabel(\"Sous-ateliers calques\"), 30);\n\t\tthis.addGlobalAction(list, new ActionMenuDep('wspHelp').setActionLists(prefixSub + \":help actions:wsp:help\").setLabel(\"Aide\"), 40);\n\t}\n\n\tprotected addWspActionsConfig(list: string) {\n\t\tthis.addGlobalAction(list, new OpenPropsWspAction(), 10);\n\t\tthis.addGlobalAction(list, new OpenPermsWspAction().requireVisiblePerm([\"ui.apps.set.perms.wsp\", \"admin.node.configRoles.byAdmin\"]), 20);\n\t\tthis.addGlobalAction(list, new DeleteWspAction().requireVisiblePerm(\"ui.apps.delete.wsp\"), 30);\n\t}\n\n\tprotected addWspActionsContent(list: string) {\n\t\tthis.addGlobalAction(list, new ScanFsUpdatesAction(), 5);\n\t\tthis.addGlobalAction(list, new OpenWspTrash(), 10);\n\t\tthis.addGlobalAction(list, new ExportWspAction(), 20);\n\t\tthis.addGlobalAction(list, new ImportScar(), 30);\n\t}\n\n\tprotected addWspActionsLayers(list: string) {\n\t\tthis.addGlobalAction(list, new CreateDrfWspAction().requireVisiblePerm(\"ui.apps.create.wsp.drf\"), 10);\n\t\tthis.addGlobalAction(list, new CreateDrvWspAction().requireVisiblePerm(\"ui.apps.create.wsp.drv\"), 20);\n\t}\n}\n\n\nREG.reg.registerSkin('wspBaseApp/headerBar', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\talign-items: center;\n\t\tfont-size: 1rem;\n\t\talign-self: stretch;\n\t\tjustify-content: start;\n\t}\n\n\t#wspTi, #wspTypeTi {\n\t\tdisplay: block;\n\t\tmax-width: 20em;\n\t\twhite-space: nowrap;\n\t\toverflow: hidden;\n\t\ttext-overflow: ellipsis;\n\t\ttext-align: start;\n\t}\n\n\t#wspTi {\n\t\tfont-weight: bold;\n\t\tpadding-bottom: .3em;\n\t}\n\n\t#wspTypeTi {\n\t\tfont-size: 80%;\n\t\tcolor: var(--fade-color);\n\t}\n\n\t#wspIcon {\n\t\theight: 1.5em;\n\t\tvertical-align: middle;\n\t\tmargin-inline-end: .5em;\n\t}\n\n\t#wspActions {\n\t\talign-self: stretch;\n\t\tpadding-inline-start: .3em;\n\t}\n`);"]}