{"version":3,"sources":["/@back@/wsp/apps/wspDocApp.tsx"],"names":["BASIS","MsgLabel","DeleteSrc","DuplicateSrc","FocusItemOrSpace","ShortDescCopy","Action","ActionMenu","InfoBrokerBasic","REG","VIEWS","ViewsContainer","DOM","JSX","DOMSH","InfoCurrentItem","InfoFocusItem","InfoFocusNodeInItem","InfoSelectUris","ITEM","SRC","WSP","LASTDATAS","FastFindItem","ReqFastFind","Toc","Generators","SRCDRAWER","SrcDrawerInline","ItemViewerSingle","SearchAnd","SearchItemModel","SearchLinkChildren","SearchLinkParents","SearchOccurencesSubExp","SearchPath","SearchRequest","SpaceTreeDataSearch","GridColTreeDef","CellBuilderSrcIconCodeTitle","Grid","ActionBtn","Button","ItemCreator","POPUP","ERROR","ItemEditInDialogInfoBroker","ItemXmlEd","LANG","Resizer","registerWspProtocolsActions","WspBaseApp","BarActions","WspDocApp","[object Object]","this","shortDescs","emitter","isDocFinderShown","_docFinder","hidden","init","_config","appDef","universe","reg","env","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","wsp","wspServer","wspsLive","findWsp","wspDoc","_initApp","infoBroker","WspDocAppInfoBroker","addConsumer","docViewer","sr","shadowRoot","pendingUi","_initWsp","wspMetaUi","getDocModels","Promise","resolve","then","OpenWspApp","execute","_initReg","clearContent","appendChild","FindDocItem","initialize","restrictions","setAttribute","_docToggle","createElement","class","onclick","onTogglePanel","_docHeader","id","ondblclick","_docRef","skin","tpl","itemCodeTpl","onSrcRefChange","add","onDocRefChanged","bind","buildButton","setLabel","requireVisiblePerm","setExecute","ctx","setDoc","style","î","actions","getList","actionContext","_docRoot","c-resizable","_toc","hideHeader","c-orient","_docMain","_supToggle","_supHeader","_supRef","onSupRefChanged","ui-context","role","label","selectSupport","createSupport","_supMain","_genToggle","_genHeader","_gen","_initAppHeader","insertBefore","appHeader","_refreshTitle","_refreshMigration","itemViewer","ld","lastDatas","docRef","doc","srcRef","src","supRef","sup","supEd","genCd","initDocAndSup","_lastWspMetaUi","closed","setDocPanelState","indexOf","setGenPanelState","undefined","injectLoads","lstn","result","onViewHidden","reinitializeStarted","setSrcRef","setRootSrcRef","initViewer","docView","openSrcRef","fetchPending","req","getShortDescDef","setWhere","supSds","fetchSearchJson","toXml","length","supSd","_clearSupEditor","_buildSupEditor","itModel","shortDesc","setSrc","initialized","injectClose","_a","_c","_b","place","closePlace","onContainerHidden","_d","_lastMigrPopup","close","_e","initializedAsync","visitor","options","onlyVisible","visible","_supEd","def","isAvailable","onAppDefChange","reloadApp","refresh","info","dispatchEvent","CustomEvent","bubbles","refetch","onInfo","parentLastDatas","buildLastDatas","codePub","pushIfDefined","classList","contains","join","setHidden","hideView","docSd","docModel","getItemType","getSupportModels","setTextContent","findFirstChild","n","className","hasGenerators","securityCtx","ev","me","findHost","btn","HTMLButtonElement","st","toggle","header","parentElement","flex","call","getElementById","open","srcSt","getRootSrcRef","sd","getSrcMainName","supSrc","setSup","configs","setSupPanelState","closeEditor","remove","supModel","supType","docType","supEditor","getSupportEditor","datasEditor","initItemReg","itemEd","addToList","SupItemHamburger","showNotifError","supportModels","supportModelsSet","Set","ct","emptyBody","itemCreator","setDefaultConfigFromReg","itemTypesTree","itemTypeReducer","acc","cur","has","getModel","push","newContentOptions","docShortDesc","showMenu","initHeight","viewPortY","titleBar","barLabel","onNextClose","e","log","openCreateItem","addShortDescAction","action","accelKey","sortKey","getId","SINGLETON","addWspActionsMain","addGlobalAction","addWspActionsConfig","addWspActionsContent","addWspActionsLayers","addBurgerItemAction","SupItemDelete","registerSkin","customElements","define","findReg","btnCreate","requireEnabledPerm","createItem","asSvg","viewBox","x","y","width","height","search","type","placeholder","spellcheck","onchange","onSearchChange","oninput","onkeydown","onKeydown","datasSearch","srcFilter","AIR_PREFIX","callbackSearching","request","initReq","initSpTrDataSearch","colDefs","setDefaultSort","setFlex","setSortable","setCellBuilder","srcUriItemsSortFn","grid","selType","columnDefs","dataHolder","hideHeaders","isInError","EMPTY_INERROR","cloneNode","searching","EMPTY_LOADING","EMPTY_NORESULT","selectBtn","disabled","i","getSelectedRow","onSelect","getRow","rowKey","infoBuilder","getSvc","infoPanel","insertInfoPanel","elt","append","Element","addEventListener","row","rowDatas","ch","uiEvents","on","key","viewShown","updateParams","fetchSearchStart","setDatas","state","super","onSearching","refreshEmptyBody","self","itTypes","getSrcUriType","srcUri","_label","_icon","desk","findAndOpenApp","u","code","c","view","longDesc","_groupOrder","getPref","_actionLists","wspDocApp","res","from","isInSupport","isInSupportEd","isInToc","mainViewCode","root","views","subReg","createSubReg","dispatchInfo","xpath","uiRoot","showDialog","closeButton","uiContext","initWidth","resizer","handled","HTMLElement","ed","findFlatParentEltOrSelf","parentNode","hide","onViewShown"],"mappings":"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","sourcesContent":["import {BASIS, MsgLabel, OSkinableInit} from \"back/commons/basis\";\nimport {AppFrameDeskFeat, IApp, IAppCtx} from \"back/core/appFrame\";\nimport {AppHeader} from \"back/core/widgets/appHeader\";\nimport {DeleteSrc, DuplicateSrc, FocusItemOrSpace, ShortDescCopy} from \"back/wsp/actions/srcActions\";\nimport {JWspAppDef, JWspDocAppDef} from \"back/wsp/plugins/wspsPlg\";\nimport \"back/wsp/views/views_Perms\";\nimport {Action, ActionMenu, IAccelKeyMgrPointer, IAction} from \"lib/commons/actions\";\nimport {IInfo, IInfoConsumer, IInfoProducer, InfoBrokerBasic} from \"lib/commons/infos\";\nimport {IReg, IRegPointer, REG} from 'lib/commons/registry';\nimport {IView, IViewApi, IViewsContainer, OViewVisitOptions, VIEWS, ViewsContainer} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IChainEnv} from \"lib/wsp/chain\";\nimport {InfoCurrentItem, InfoFocusItem, InfoFocusNodeInItem, InfoSelectUris, IShortDescCtx, ITEM} from \"lib/wsp/item\";\nimport {JSrcFields, JSrcFieldsTree, SRC, srcRef, srcUri} from \"lib/wsp/src\";\nimport {IWspEnv, IWspUiEnv, WSP} from \"lib/wsp/wsp\";\nimport {ILastDatasBuilder, JLastDatas, LASTDATAS} from \"lib/commons/lastDatas\";\nimport {IItemUiEnv, IItemViewer} from \"back/wsp/views/itemMain\";\nimport {FastFindItem, OFastFindItemsInit, ReqFastFind} from \"back/wsp/dialogs/fastFindItem\";\nimport {Toc} from \"back/wsp/views/toc\";\nimport {Generators} from \"back/wsp/views/generators\";\nimport {SRCDRAWER, SrcDrawer, SrcDrawerInline} from \"back/wsp/widgets/srcDrawer\";\nimport {ItemViewerSingle} from \"back/wsp/views/itemViewerSingle\";\nimport {SearchAnd, SearchItemModel, SearchLinkChildren, SearchLinkParents, SearchOccurencesSubExp, SearchPath, SearchRequest} from \"lib/wsp/search\";\nimport {SpaceTreeDataSearch} from \"back/wsp/views/spaceTree\";\nimport {GridColTreeDef} from \"back/commons/widgets/tree\";\nimport {CellBuilderSrcIconCodeTitle} from \"back/wsp/widgets/srcGridColumns\";\nimport {Grid} from \"back/commons/widgets/grid-tags\";\nimport {GridDataRowJson} from \"back/commons/widgets/grid-libs\";\nimport {ActionBtn, Button} from \"back/commons/widgets/buttons\";\nimport {ItemCreator} from \"back/wsp/dialogs/itemCreator\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {ItemType} from \"lib/wsp/wspMetaUi\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {ItemEditInDialogInfoBroker, ItemXmlEd} from \"back/wsp/views/item/itemXmlEd\";\nimport {LANG} from \"lib/commons/lang\";\nimport {IWedEditor} from \"back/edit/wed/wedEditor\";\nimport {Resizer} from \"back/commons/widgets/resizer\";\nimport {registerWspProtocolsActions} from \"back/wsp/actions/scProtocolActions\";\nimport \"back/wsp/apps/apps_Perms\";\nimport {WspBaseApp} from \"back/wsp/apps/wspBaseApp\";\nimport {BarActions, OBarActionsInit} from \"back/commons/widgets/bars\";\n\nexport interface OWspDocAppInit extends OSkinableInit, IAppCtx<IChainEnv> {\n\treg?: IReg<IChainEnv>\n\titemViewer?: IItemViewer\n\tappDef: JWspDocAppDef\n\tlastDatas?: JLDWspDoc\n}\n\n/** App d'accès complet à un atelier. */\nexport interface WspDocApp extends WspBaseApp {\n\tinitialize(init: OWspDocAppInit): this;\n}\n\nexport class WspDocApp extends WspBaseApp implements IApp<IWspEnv>, IViewsContainer, IInfoConsumer, IAccelKeyMgrPointer<IRegPointer<IWspUiEnv>>, ILastDatasBuilder {\n\n\tappDef: JWspDocAppDef;\n\n\tappHeader: AppHeader<WspDocApp>;\n\n\tdocViewer: IItemViewer;\n\n\tprotected _config: OWspDocAppInit;\n\n\tprotected _docFinder: FindDocItem;\n\n\tprotected _docHeader: HTMLElement;\n\tprotected _docToggle: HTMLElement;\n\tprotected _docRef: SrcDrawer;\n\tprotected _docRoot: HTMLElement;\n\tprotected _docMain: HTMLElement;\n\t_toc: Toc;\n\n\t//protected _supResizer: HTMLElement;\n\tprotected _supHeader: HTMLElement;\n\tprotected _supToggle: HTMLElement;\n\tprotected _supRef: SrcDrawer;\n\t_supMain: HTMLElement;\n\tprotected _supEd: ItemXmlEd;\n\n\n\tprotected _genHeader: HTMLElement;\n\tprotected _genToggle: HTMLElement;\n\tprotected _gen: Generators;\n\n\t/** Api IShortDesc */\n\tshortDescs: JSrcFields[] = [];\n\n\t/** Api IShortDesc */\n\tget emitter() {return this}\n\n\tget isDocFinderShown(): boolean {return !this._docFinder.hidden}\n\n\tprotected async _initialize(init: OWspDocAppInit): Promise<void> {\n\t\tthis._config = init;\n\t\tthis.appDef = init.appDef;\n\t\tthis.universe = init.reg.env.universe;\n\n\t\tthis.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tthis.wsp = this.universe.wspServer.wspsLive.findWsp(this.appDef.wspDoc, true);\n\t\treturn this._initApp(init);\n\t}\n\n\t/** Init ou RE-init de l'app. */\n\tprotected async _initApp(init: OWspDocAppInit) {\n\t\tthis.infoBroker = new WspDocAppInfoBroker(this);\n\t\tthis.infoBroker.addConsumer(this);\n\t\tthis.docViewer = null;\n\t\tconst sr = this.shadowRoot;\n\t\tconst pendingUi = new MsgLabel();\n\n\t\tif (!await this._initWsp(init, pendingUi)) return;\n\n\t\tif (!this.wsp.wspMetaUi.getDocModels()) {\n\t\t\t//Pas de vue de l'atelier par document disponible, on bascule sur la vue de l'atelier orienté \"explorateur\".\n\t\t\tPromise.resolve().then(() => new OpenWspApp().execute(this)); //en async pour finir l'init de cette App qui va ensuite être éliminée.\n\t\t\treturn;\n\t\t}\n\n\t\tif (!await this._initReg(init, \"wspDocApp\", \"ui.wspDocApp\", pendingUi)) return;\n\t\tconst reg = this.reg;\n\n\t\tBASIS.clearContent(sr);\n\n\t\tthis._docFinder = sr.appendChild(new FindDocItem().initialize({\n\t\t\treg,\n\t\t\trestrictions: new SearchItemModel(this.wsp.wspMetaUi.getDocModels())\n\t\t} as OFastFindItemsInit));\n\t\tthis._docFinder.setAttribute(\"hidden\", \"\");\n\n\t\tthis._docToggle = <button class=\"toggle\" onclick={this.onTogglePanel}><span class=\"headTi\">Contenu</span></button> as HTMLButtonElement;\n\t\tthis._docHeader = sr.appendChild(<div id=\"docHeader\" class=\"headPanel\" ondblclick={this.onTogglePanel}>\n\t\t\t<span class=\"countPanel\">1</span>{this._docToggle}\n\t\t</div>);\n\t\tthis._docRef = this._docHeader.appendChild(new SrcDrawerInline().initialize({\n\t\t\treg,\n\t\t\tskin: 'wsp-doc-app/srcptrInHead',\n\t\t\ttpl: SRCDRAWER.itemCodeTpl\n\t\t}));\n\t\tthis._docRef.onSrcRefChange.add(this.onDocRefChanged.bind(this));\n\n\t\tthis._docHeader.appendChild(ActionBtn.buildButton(new Action<IRegPointer<IWspUiEnv>>(\"docChange\")\n\t\t\t.setLabel(\"Changer de contenu...\")\n\t\t\t.requireVisiblePerm(\"ui.app.wspDoc.change.doc\")\n\t\t\t.setExecute((ctx) => {\n\t\t\t\tthis.setDoc(null);\n\t\t\t}), this, 'dialog'));\n\n\t\tthis._docHeader.appendChild(<span style=\"flex:1\"/>);\n\t\tthis._docHeader.appendChild(<BarActions id=\"docHeaderActions\" î={{\n\t\t\treg,\n\t\t\tactions: reg.getList(\"actions:wspDocApp:docHeader\"),\n\t\t\tactionContext: this\n\t\t} as OBarActionsInit<WspDocApp>}/>);\n\n\t\tthis._docRoot = sr.appendChild(<div id=\"docRoot\" c-resizable=\"\"/>);\n\t\tthis._toc = this._docRoot.appendChild(<Toc c-resizable=\"\" î={{\n\t\t\treg,\n\t\t\tinfoBroker: this.infoBroker,\n\t\t\thideHeader: true\n\t\t}}/> as Toc);\n\t\tthis._docRoot.appendChild(<c-resizer c-orient=\"row\"/>);\n\t\tthis._docMain = this._docRoot.appendChild(<div id=\"docMain\" c-resizable=\"\"/>);\n\n\t\t//this._supResizer = sr.appendChild(<c-resizer c-orient=\"column\"/>);\n\t\tthis._supToggle = <button class=\"toggle closed\" onclick={this.onTogglePanel}><span class=\"headTi\">Support</span></button> as HTMLButtonElement;\n\t\tthis._supHeader = sr.appendChild(<div id=\"supHeader\" class=\"headPanel\" hidden ondblclick={this.onTogglePanel}>\n\t\t\t<span class=\"countPanel\">2</span>{this._supToggle}\n\t\t</div>);\n\n\t\tthis._supRef = this._supHeader.appendChild(<SrcDrawerInline id=\"supRef\" î={{\n\t\t\treg,\n\t\t\tskin: 'wsp-doc-app/srcptrInHead',\n\t\t\ttpl: SRCDRAWER.itemCodeTpl\n\t\t}}/>) as SrcDrawerInline;\n\t\tthis._supRef.onSrcRefChange.add(this.onSupRefChanged.bind(this));\n\n\t\tthis._supHeader.appendChild(<c-button id=\"selectSup\" ui-context=\"dialog\" role=\"menu\" label=\"Sélectionner\" onclick={this.selectSupport}/>);\n\t\tthis._supHeader.appendChild(<c-button id=\"createSup\" ui-context=\"dialog\" label=\"Créer un support...\" onclick={this.createSupport}/>);\n\n\t\tthis._supMain = sr.appendChild(<div id=\"supMain\" c-resizable=\"\" hidden=\"\"/>);\n\n\t\tsr.appendChild(<c-resizer c-orient=\"column\"/>);\n\t\tthis._genToggle = <button class=\"toggle closed\" onclick={this.onTogglePanel}><span class=\"headTi\">Publications</span></button> as HTMLButtonElement;\n\t\tthis._genHeader = sr.appendChild(<div id=\"genHeader\" class=\"headPanel\" ondblclick={this.onTogglePanel}>\n\t\t\t<span class=\"countPanel\">3</span>{this._genToggle}\n\t\t</div>);\n\t\tthis._gen = sr.appendChild(<Generators c-resizable=\"\" hidden=\"\" î={{reg}}/> as Generators);\n\n\t\t//AppHeader (après les autres éléments pour déclarer les focusListening)\n\t\tthis._initAppHeader(init, [this._docRef, this._docFinder, this._toc, this._docMain, this._supRef, this._supMain, this._gen], \"actions:wspDocApp:main\", \"actions:wspDocApp:more\");\n\t\tsr.insertBefore(this.appHeader, this._docFinder);\n\n\t\t//\n\t\tthis._refreshTitle(null);\n\t\tthis._refreshMigration();\n\n\t\t//Construction de la mainView\n\t\tthis.docViewer = init.itemViewer || new ItemViewerSingle();\n\n\t\t//Chargement...\n\t\tlet ld = init.lastDatas;\n\t\tlet docRef = this.appDef.doc;\n\t\tif (docRef) {\n\t\t\tif (ld && ld.docRef !== docRef) ld = null;\n\t\t} else if (ld) {\n\t\t\tdocRef = ld.docRef;\n\t\t}\n\t\tlet srcRef = this.appDef.src;\n\t\tif (srcRef) {\n\t\t\tif (ld && ld.srcRef && ld.srcRef !== srcRef) ld = null;\n\t\t} else if (ld) {\n\t\t\tsrcRef = ld.srcRef;\n\t\t}\n\t\tlet supRef = this.appDef.sup;\n\t\tif (supRef) {\n\t\t\tif (ld && ld.supRef !== supRef) {\n\t\t\t\tld.supEd = null;\n\t\t\t\tld.genCd = null;\n\t\t\t}\n\t\t} else if (ld) {\n\t\t\tsupRef = ld.supRef;\n\t\t}\n\t\tawait this.initDocAndSup(docRef, supRef, srcRef, ld);\n\t\tif (this._lastWspMetaUi !== this.wsp.wspMetaUi) return; //raceCond\n\t\tif (ld && ld.closed) {\n\t\t\tthis.setDocPanelState(ld.closed.indexOf('d') < 0);\n\t\t\tthis.setGenPanelState(ld.closed.indexOf('g') < 0);\n\t\t}\n\t\tinit.lastDatas = undefined;\n\n\t\tconst injectLoads = this.reg.getList<(app: WspDocApp) => void | Promise<void>>(\"wspDocApp:load\");\n\t\tif (injectLoads) for (const lstn of injectLoads) {\n\t\t\tconst result = lstn(this);\n\t\t\tif (result instanceof Promise) await result;\n\t\t}\n\t}\n\n\treloadApp() {\n\t\tthis.onViewHidden(true);\n\t\tthis.reinitializeStarted(this._initApp(this._config));\n\t}\n\n\t/** Affecte un nouveau doc, reset le sup en conséquence. */\n\tsetDoc(srcRef: srcRef, src?: JSrcFields) {\n\t\tthis._docRef.setSrcRef(srcRef, src);\n\t\tthis._supRef.setSrcRef(null);\n\t}\n\n\t/** Affecte un nouveau support. ATTENTION : la compat avec le doc courant a dû être validé en amont. */\n\tsetSup(srcRef: srcRef, src?: JSrcFields) {\n\t\tthis._supRef.setSrcRef(srcRef, src);\n\t}\n\n\t/** (Re)Init simultannément le doc et son support avec contrôle de cohérence (et injection lastDatas). */\n\tasync initDocAndSup(docRef: srcRef, supRef: srcRef, srcRef: srcRef, lastDatas?: JLDWspDoc) {\n\t\tthis._toc.setRootSrcRef(docRef);\n\t\tif (!this.docViewer.reg) {\n\t\t\t//1er init\n\t\t\tawait this.docViewer.initViewer(this.reg, this._docMain, lastDatas && lastDatas.docView, srcRef || docRef);\n\t\t} else {\n\t\t\t//Déjà init\n\t\t\tawait this.docViewer.openSrcRef(srcRef || docRef);\n\t\t}\n\t\tif (this._lastWspMetaUi !== this.wsp.wspMetaUi) return; //raceCond\n\t\tthis._docRef.setSrcRef(docRef);\n\t\tif (this._docRef.fetchPending) await this._docRef.fetchPending;\n\t\tif (this._lastWspMetaUi !== this.wsp.wspMetaUi) return; //raceCond\n\t\tif (supRef) {\n\t\t\t//on fetch le shortdesc de supRef en s'assurant qu'il est bien un support du doc.\n\t\t\tconst req = new SearchRequest(this.wsp.getShortDescDef()).setWhere(\n\t\t\t\tnew SearchAnd(\n\t\t\t\t\tnew SearchPath(supRef),\n\t\t\t\t\tnew SearchOccurencesSubExp('gt', 0, new SearchAnd(\n\t\t\t\t\t\tnew SearchLinkChildren('.', 'support'),\n\t\t\t\t\t\tnew SearchPath(docRef))\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t\tconst supSds = await WSP.fetchSearchJson<JSrcFields>(this.wsp, this, req.toXml());\n\t\t\tif (this._lastWspMetaUi !== this.wsp.wspMetaUi) return; //raceCond\n\t\t\tif (supSds && supSds.length > 0) {\n\t\t\t\tconst supSd = supSds[0];\n\t\t\t\tthis._clearSupEditor();\n\t\t\t\tthis._buildSupEditor(supSd.itModel, this._docRef.shortDesc.itModel, SRC.srcRef(supSd), lastDatas && lastDatas.supEd);\n\t\t\t\tthis._supRef.setSrcRef(SRC.srcRef(supSd), supSd);\n\t\t\t\tthis._gen.setSrc(supSd, lastDatas && lastDatas.genCd);\n\t\t\t} else {\n\t\t\t\tthis._supRef.setSrcRef(null);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._supRef.setSrcRef(null);\n\t\t}\n\t}\n\n\tonViewHidden(closed?: boolean): void {\n\t\tif (this.initialized) {\n\t\t\tif (closed) {\n\t\t\t\tconst injectClose = this.reg?.getList<(app: WspDocApp) => void>(\"wspDocApp:close\");\n\t\t\t\tif (injectClose) for (const lstn of injectClose) lstn(this);\n\t\t\t\tthis.reg?.env.place?.closePlace();\n\t\t\t}\n\t\t\tVIEWS.onContainerHidden(this, closed);\n\t\t\tthis._lastMigrPopup?.close();\n\t\t\tif (closed) this.reg?.close();\n\t\t} else {\n\t\t\tthis.initializedAsync.then(() => this.onViewHidden(closed));\n\t\t}\n\t}\n\n\tvisitViews(visitor: (view: IViewApi) => any, options?: OViewVisitOptions): any {\n\t\tconst onlyVisible = options && options.visible;\n\t\tif (this._docFinder && (!onlyVisible || !this._docFinder.hidden)) visitor(this._docFinder);\n\t\tvisitor(this.docViewer);\n\t\tif (this._supEd && (!onlyVisible || !this._supEd.hidden)) visitor(this._supEd);\n\t\tif (this._toc && (!onlyVisible || !this._toc.hidden)) visitor(this._toc);\n\t\tif (this._gen && (!onlyVisible || !this._gen.hidden)) visitor(this._gen);\n\t}\n\n\tasync visitViewsAsync(visitor: (view: IViewApi) => Promise<any>, options?: OViewVisitOptions): Promise<any> {\n\t\tconst onlyVisible = options && options.visible;\n\t\tif (this._docFinder && (!onlyVisible || !this._docFinder.hidden)) await visitor(this._docFinder);\n\t\tawait visitor(this.docViewer);\n\t\tif (this._supEd && (!onlyVisible || !this._supEd.hidden)) await visitor(this._supEd);\n\t\tif (this._toc && (!onlyVisible || !this._toc.hidden)) await visitor(this._toc);\n\t\tif (this._gen && (!onlyVisible || !this._gen.hidden)) await visitor(this._gen);\n\t}\n\n\tupdateAppDef(def: JWspDocAppDef): boolean {\n\t\tif (this.appDef === def) return true; //chgt issu d'ici\n\t\t//Si changement d'atelier on remplace totalement cette app.\n\t\tif (!def.wspDoc || def.wspDoc !== this.appDef.wspDoc) return false;\n\t\tthis.appDef = def;\n\t\tif (this.initialized) {\n\t\t\tif (this.wsp && this.wsp.isAvailable) {\n\t\t\t\tthis.onAppDefChange();\n\t\t\t} else {\n\t\t\t\tthis.reloadApp();\n\t\t\t}\n\t\t} else {\n\t\t\tthis.initializedAsync.then(() => this.onAppDefChange());\n\t\t}\n\t\treturn true;\n\t}\n\n\tprotected async onAppDefChange() {\n\t\tawait this.initDocAndSup(this.appDef.doc, this.appDef.sup, this.appDef.src);\n\t\tthis.refresh();\n\t}\n\n\tonInfo(info: IInfo): void {\n\t\tif (this.initialized) {\n\t\t\tif (info instanceof InfoCurrentItem) {\n\t\t\t\t//this.setDocPanelState(true); pb à l'init contrecarre les lastDatas.\n\t\t\t\t//Changement de doc => dispatch c-appdef-change\n\t\t\t\tconst shortDesc = info.shortDesc;\n\t\t\t\tconst srcRef = shortDesc ? SRC.srcRef(shortDesc) : null;\n\t\t\t\tif (this.appDef.src ? srcRef !== this.appDef.src : srcRef !== this.appDef.doc) {\n\t\t\t\t\tthis.appDef.src = srcRef === this.appDef.doc ? undefined : srcRef;\n\t\t\t\t\tthis.dispatchEvent(new CustomEvent('c-appdef-change', {bubbles: true}));\n\t\t\t\t}\n\t\t\t} else if (info instanceof InfoSelectUris) {\n\t\t\t\tif (this.isDocFinderShown) {\n\t\t\t\t\tthis._docFinder.refetch();\n\t\t\t\t} // else... todo quand doc affiché ?\n\t\t\t}\n\t\t} else {\n\t\t\tthis.initializedAsync.then(() => this.onInfo(info));\n\t\t}\n\t}\n\n\tbuildLastDatas(parentLastDatas: JLDWspDoc): void {\n\t\tif (!this._docRef) return;\n\t\tparentLastDatas.docRef = this._docRef.srcRef;\n\t\tif (parentLastDatas.docRef) {\n\t\t\tparentLastDatas.docView = {};\n\t\t\tLASTDATAS.buildLastDatas(parentLastDatas.docView, this._docRoot);\n\t\t}\n\t\tparentLastDatas.supRef = this._supRef.srcRef;\n\t\tif (this._supEd) {\n\t\t\tparentLastDatas.supEd = {};\n\t\t\tLASTDATAS.buildLastDatas(parentLastDatas.supEd, this._supEd);\n\t\t}\n\t\tconst genCd = this._gen.codePub;\n\t\tif (genCd) parentLastDatas.genCd = genCd;\n\t\tconst closed = LANG.pushIfDefined<string>([], this._docToggle.classList.contains('closed') ? 'd' : undefined, this._supToggle.classList.contains('closed') ? 's' : undefined, this._genToggle.classList.contains('closed') ? 'g' : undefined)\n\t\tif (closed.length > 0) parentLastDatas.closed = closed.join('');\n\t}\n\n\tprotected _refresh() {\n\t\tif (!this._docRef) return; //init interrompu.\n\t\tif (!this._docRef.srcRef) {\n\t\t\t// Affichage de la recherche du doc\n\t\t\tDOM.setHidden(this._docHeader, true);\n\t\t\tDOM.setHidden(this._docRoot, true);\n\t\t\t//DOM.setHidden(this._supResizer, true);\n\t\t\tDOM.setHidden(this._supHeader, true);\n\t\t\tDOM.setHidden(this._supMain, true);\n\t\t\tDOM.setHidden(this._genHeader, true);\n\t\t\thideView(this._gen, true);\n\t\t\thideView(this._docFinder, false);\n\t\t\treturn;\n\t\t}\n\t\t//On a un doc\n\t\thideView(this._docFinder, true);\n\t\tDOM.setHidden(this._docHeader, false);\n\t\tDOM.setHidden(this._docRoot, this._docToggle.classList.contains(\"closed\"));\n\n\t\tconst docSd = this._docRef.shortDesc;\n\t\tconst docModel = this.wsp.wspMetaUi.getItemType(docSd.itModel);\n\t\tif (docModel.getSupportModels()) {\n\t\t\t//DOM.setHidden(this._supResizer, false);\n\t\t\tDOM.setHidden(this._supHeader, false);\n\t\t\tconst supSd = this._supRef.shortDesc;\n\t\t\tDOM.setHidden(this._supMain, !supSd || this._supToggle.classList.contains(\"closed\"));\n\t\t\t//if (supSd && this.wsp.wspMetaUi.getItemType(supSd.itModel).hasGenerators(this.reg.env.securityCtx)) { //On a des gen associés au support\n\t\t\tDOM.setTextContent(DOM.findFirstChild(this._genHeader, (n: Node): n is HTMLElement => (n as HTMLElement).className === \"countPanel\"), \"3\");\n\t\t\tDOM.setHidden(this._genHeader, false);\n\t\t\thideView(this._gen, this._genToggle.classList.contains(\"closed\"));\n\t\t\tif (this._gen.shortDesc !== supSd) this._gen.setSrc(supSd);\n\t\t\t// } else {\n\t\t\t// \tDOM.setHidden(this._genHeader, true);\n\t\t\t// \tDOM.setHidden(this._gen, true);\n\t\t\t// }\n\t\t} else {\n\t\t\t//DOM.setHidden(this._supResizer, true);\n\t\t\tDOM.setHidden(this._supHeader, true);\n\t\t\tDOM.setHidden(this._supMain, true);\n\t\t\tif (docSd && docModel.hasGenerators(this.reg.env.securityCtx)) {\n\t\t\t\t//On a des gen directement associés au doc\n\t\t\t\tDOM.setTextContent(DOM.findFirstChild(this._genHeader, (n: Node): n is HTMLElement => (n as HTMLElement).className === \"countPanel\"), \"2\");\n\t\t\t\tDOM.setHidden(this._genHeader, false);\n\t\t\t\thideView(this._gen, this._genToggle.classList.contains(\"closed\"));\n\t\t\t\tif (this._gen.shortDesc !== docSd) this._gen.setSrc(docSd);\n\t\t\t} else {\n\t\t\t\tDOM.setHidden(this._genHeader, true);\n\t\t\t\thideView(this._gen, true);\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected onTogglePanel(this: HTMLElement, ev?: MouseEvent) {\n\t\tconst me = DOMSH.findHost<WspDocApp>(this);\n\t\tconst btn = this instanceof HTMLButtonElement ? this : DOM.findFirstChild(this, (n: Node): n is HTMLElement => (n as HTMLElement).classList.contains('toggle'));\n\t\tconst st = btn.classList.toggle(\"closed\");\n\n\t\t// Doc et Support en opposition.\n\t\tconst header = btn.parentElement.id;\n\t\tif (header === \"docHeader\") {\n\t\t\tif (st) {\n\t\t\t\tme._supMain.style.flex = me._docRoot.style.flex;\n\t\t\t} else {\n\t\t\t\tme._docRoot.style.flex = me._supMain.style.flex;\n\t\t\t}\n\t\t\tme._supToggle.classList.toggle(\"closed\", !st);\n\t\t} else if (header === \"supHeader\") {\n\t\t\tif (st) {\n\t\t\t\tme._docRoot.style.flex = me._supMain.style.flex;\n\t\t\t} else {\n\t\t\t\tme._supMain.style.flex = me._docRoot.style.flex;\n\t\t\t}\n\t\t\tme._docToggle.classList.toggle(\"closed\", !st);\n\t\t}\n\n\t\tif (ev && !me._supHeader.hidden && !me._supRef.shortDesc && (!me._supToggle.classList.contains('closed') || !me._genToggle.classList.contains('closed'))) {\n\t\t\t//On a provoqué l'ouverture du panel support ou gen, et on a des supports, mais aucun support sel,\n\t\t\t// => on affiche la sel d'un support.\n\t\t\tme.selectSupport.call(me.shadowRoot.getElementById('selectSup'), ev);\n\t\t}\n\n\t\tme.refresh();\n\t}\n\n\tprotected setDocPanelState(open: boolean) {\n\t\tif (this._docToggle.classList.contains(\"closed\") === open) this.onTogglePanel.call(this._docToggle);\n\t}\n\n\tprotected setSupPanelState(open: boolean) {\n\t\tif (this._supToggle.classList.contains(\"closed\") === open) this.onTogglePanel.call(this._supToggle);\n\t}\n\n\tprotected setGenPanelState(open: boolean) {\n\t\tif (this._genToggle.classList.contains(\"closed\") === open) this.onTogglePanel.call(this._genToggle);\n\t}\n\n\tprotected onDocRefChanged() {\n\t\tconst docRef = this._docRef.srcRef;\n\t\tif (docRef && this._docRef.shortDesc.srcSt < 0) {\n\t\t\t//détection de la suppr de l'item.\n\t\t\tthis.setDoc(null);\n\t\t\treturn;\n\t\t}\n\t\tif (docRef && this.docViewer && this._toc.getRootSrcRef() === docRef) return;\n\t\tthis._toc.setRootSrcRef(docRef);\n\t\tthis.docViewer.openSrcRef(docRef);\n\t\tconst sd = this._docRef.shortDesc;\n\t\tthis.setDocPanelState(true);\n\t\tthis.refresh();\n\t\tthis._refreshTitle(sd ? ITEM.getSrcMainName(this.reg, sd, this.wsp.wspMetaUi) : null);\n\t\t//Changement de doc => dispatch c-appdef-change\n\t\tif (!docRef) {\n\t\t\tthis.appDef.doc = undefined;\n\t\t\tthis.appDef.src = undefined;\n\t\t\tthis.appDef.sup = undefined;\n\t\t} else {\n\t\t\tthis.appDef.doc = docRef;\n\t\t\tif (this.appDef.src === docRef) this.appDef.src = undefined;\n\t\t}\n\t\tthis.dispatchEvent(new CustomEvent('c-appdef-change', {bubbles: true}));\n\t}\n\n\tprotected onSupRefChanged() {\n\t\tconst supSrc = this._supRef.srcRef;\n\t\tif (supSrc && this._supRef.shortDesc.srcSt < 0) {\n\t\t\t//détection de la suppr de l'item.\n\t\t\tthis.setSup(null);\n\t\t\treturn;\n\t\t}\n\t\tif (supSrc && this._supEd && this._supEd.configs.srcRef === supSrc) return;\n\t\tthis._clearSupEditor();\n\t\tif (!supSrc) return;\n\t\tthis._buildSupEditor(this._supRef.shortDesc.itModel, this._docRef.shortDesc.itModel, supSrc);\n\t\tthis.setSupPanelState(true);\n\t\tthis.refresh();\n\t\t//Changement de doc => dispatch c-appdef-change\n\t\tthis.appDef.sup = supSrc;\n\t\tthis.dispatchEvent(new CustomEvent('c-appdef-change', {bubbles: true}));\n\t}\n\n\tprotected _clearSupEditor() {\n\t\tif (this._supEd) {\n\t\t\tthis._supEd.closeEditor();\n\t\t\tthis._supEd.remove();\n\t\t\tthis._supEd = null;\n\t\t}\n\t}\n\n\tprotected _buildSupEditor(supModel: string, docModel: string, supSrc: srcRef, lastDatas?: JLastDatas) {\n\t\tconst supType = this.wsp.wspMetaUi.getItemType(supModel);\n\t\tconst docType = this.wsp.wspMetaUi.getItemType(docModel);\n\t\tconst supEditor = docType.getSupportEditor(supType);\n\t\tif (supEditor) {\n\t\t\tthis._supEd = this._supMain.appendChild(new ItemXmlEd().initialize({\n\t\t\t\treg: this.reg,\n\t\t\t\tdatasEditor: supEditor,\n\t\t\t\tsrcRef: supSrc,\n\t\t\t\tinitItemReg: (reg: IReg<IItemUiEnv>, itemEd: ItemXmlEd) => {\n\t\t\t\t\treg.addToList(\"actions:wed:commonbar:end\", \"itemHamburger\", 1, new SupItemHamburger(itemEd), 101);\n\t\t\t\t},\n\t\t\t\tlastDatas\n\t\t\t}));\n\t\t} else {\n\t\t\tPOPUP.showNotifError(\"Aucun éditeur disponible pour ce support\", this);\n\t\t}\n\t}\n\n\t// getSupportCrit(docSd: JSrcFields): ISearchCrit[] {\n\t// \t// \tconst docModel = this.wsp.wspMetaUi.getItemType(docSd.itModel);\n\t// \t// \treturn [\n\t// \t// \t\tnew SearchLinkParents(this._docRef.srcRef, 'support'),\n\t// \t// \t\tnew SearchItemModel(docModel.getSupportModels())\n\t// \t// \t]\n\t// \t// }\n\t// \t//\n\t// \t// protected async fetchSupports(): Promise<JSrcFields[]> {\n\t// \t// \tconst docSd = this._docRef.shortDesc;\n\t// \t// \tconst search = new SearchRequest().addFieldColumns(...this.wsp.getShortDescFields()).setMax(2000).setWhere(new SearchAnd(...this.getSupportCrit(docSd)));\n\t// \t// \treturn WSP.fetchSearchJson<JSrcFields>(this.wsp, this, search.toXml());\n\t// \t// }\n\n\tprotected async selectSupport(this: HTMLButtonElement, ev: Event) {\n\t\ttry {\n\t\t\tconst me = DOMSH.findHost<WspDocApp>(this);\n\t\t\tconst docSd = me._docRef.shortDesc;\n\t\t\tif (!docSd) return;\n\t\t\tconst docModel = me.wsp.wspMetaUi.getItemType(docSd.itModel);\n\t\t\tconst supportModels = docModel.getSupportModels();\n\t\t\tconst supportModelsSet = new Set(supportModels);\n\t\t\tconst ct = new FastFindItem().initialize({\n\t\t\t\treg: me.reg,\n\t\t\t\trestrictions: new SearchAnd(\n\t\t\t\t\tnew SearchLinkParents(me._docRef.srcRef, 'support'),\n\t\t\t\t\tnew SearchItemModel(supportModels)\n\t\t\t\t),\n\t\t\t\temptyBody: () => <span>Aucun support disponible pour ce contenu</span>,\n\t\t\t\t// BUG close popups returnValue non retournée via await POPUP.showMenuFromEvent(ct, ev || me).onNextClose<JSrcFields>();\n\t\t\t\titemCreator: ItemCreator.setDefaultConfigFromReg(me.reg, {\n\t\t\t\t\titemTypesTree: {\n\t\t\t\t\t\titemTypeReducer: (acc: ItemType[], cur: ItemType) => {\n\t\t\t\t\t\t\tif (supportModelsSet.has(cur.getModel())) acc.push(cur);\n\t\t\t\t\t\t\treturn acc;\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tnewContentOptions: {docShortDesc: docSd}\n\t\t\t\t}),\n\t\t\t} as OFastFindItemsInit);\n\n\t\t\tconst supSd = await POPUP.showMenu<JSrcFields>(ct, {initHeight: \"15em\", viewPortY: \"middle\"}, this, {\n\t\t\t\ttitleBar: {barLabel: {label: \"Sélection du support\"}}\n\t\t\t}).onNextClose();\n\n\t\t\tif (supSd) me._supRef.setSrcRef(SRC.srcRef(supSd), supSd);\n\t\t} catch (e) {\n\t\t\tPOPUP.showNotifError(\"Échec à la recherche des supports disponibles\", this);\n\t\t\tERROR.log(e);\n\t\t}\n\t}\n\n\tprotected async createSupport(this: HTMLButtonElement, ev: Event) {\n\t\tconst me = DOMSH.findHost<WspDocApp>(this);\n\t\tconst docSd = me._docRef.shortDesc;\n\t\tconst docModel = me.wsp.wspMetaUi.getItemType(docSd.itModel);\n\t\tconst supportModelsSet = new Set(docModel.getSupportModels());\n\t\tconst supSd = await ItemCreator.openCreateItem({\n\t\t\treg: me.reg,\n\t\t\titemTypesTree: {\n\t\t\t\titemTypeReducer: (acc: ItemType[], cur: ItemType) => {\n\t\t\t\t\tif (supportModelsSet.has(cur.getModel())) acc.push(cur);\n\t\t\t\t\treturn acc;\n\t\t\t\t}\n\t\t\t},\n\t\t\tnewContentOptions: {\n\t\t\t\tdocShortDesc: docSd\n\t\t\t}\n\t\t}, \"Créer un support...\", this, ev).onNextClose();\n\t\tif (supSd) me._supRef.setSrcRef(SRC.srcRef(supSd), supSd);\n\t}\n\n\t/** Init des extPoints du registre de l'app. */\n\tprotected async initRegExtPoints() {\n\t\tconst reg = this.reg;\n\n\t\t//#### Actions transversales sur les IShortDescCtx.\n\t\tfunction addShortDescAction(action: IAction<IShortDescCtx>, accelKey?: string, sortKey?: number) {\n\t\t\treg.addToList(\"actions:wsp:shortDesc\", action.getId(), 1, action, sortKey);\n\t\t\tif (accelKey) reg.addToList(\"accelkeys:wsp:shortDesc\", accelKey, 1, action);\n\t\t}\n\n\t\taddShortDescAction(new FocusItemOrSpace(), \"F3\");\n\t\taddShortDescAction(ShortDescCopy.SINGLETON, \"c-accel\", -1);\n\n\t\tthis.addWspActionsMain(\"actions:wspDocApp:main\", \"actions:wspDocApp\");\n\t\tthis.addGlobalAction(\"actions:wspDocApp:main\", new OpenWspApp(), 70, \"F8\");\n\n\t\t//Config\n\t\tthis.addWspActionsConfig(\"actions:wspDocApp:config\");\n\n\t\t//Content\n\t\tthis.addWspActionsContent(\"actions:wspDocApp:content\");\n\n\t\t//Layers\n\t\tthis.addWspActionsLayers(\"actions:wspDocApp:layers\");\n\n\t\tfunction addBurgerItemAction(action: Action<IWedEditor | IShortDescCtx>) {\n\t\t\treg.addToList(\"actions:wspDocAppp:support:burger\", action.getId(), 1, action);\n\t\t}\n\n\t\taddBurgerItemAction(new DeleteSrc());\n\t\taddBurgerItemAction(new SupItemDelete(this));\n\n\t\tregisterWspProtocolsActions(reg);\n\t}\n}\n\nREG.reg.registerSkin('wsp-doc-app', 1, /* language=CSS */ `\n\t:host {\n\t  flex: 1;\n\t  display: flex;\n\t  min-height: 0;\n\t  min-width: 0;\n\t  flex-direction: column;\n  }\n\n  [hidden] {\n\t  display: none !important;\n  }\n\n  :focus-visible {\n\t  outline: var(--focus-outline);\n  }\n\n  #wspHeader {\n\t  flex: 1;\n\t  display: flex;\n\t  min-height: 0;\n\t  min-width: 0;\n\t  justify-content: center;\n\t  user-select: none;\n  }\n\n  #wspIcon {\n\t  height: 1.5rem;\n  }\n\n  #wspTi {\n\t  margin: 0 .5rem;\n\t  letter-spacing: .1rem;\n\t  text-align: center;\n\t  font-size: 1.2rem;\n  }\n\n  hr {\n\t  border-top: 1px solid var(--border-color);\n\t  border-inline-start: 1px solid var(--border-color);\n\t  border-inline-end: none;\n\t  border-bottom: none;\n\t  margin: 0;\n  }\n\n  #docRoot {\n\t  flex: 3;\n\t  display: flex;\n\t  min-height: 0;\n\t  min-width: 0;\n\t  overflow: hidden;\n  }\n\n  #docMain,\n  #supMain {\n\t  display: flex;\n\t  min-height: 0;\n\t  min-width: 0;\n\t  flex-direction: column;\n  }\n\n  #docMain {\n\t  flex: 4;\n  }\n\n  #supMain {\n\t  flex: 3;\n\t  overflow: hidden;\n  }\n\n  wsp-finddoc {\n\t  flex: 1;\n  }\n\n  .headPanel {\n  \tdisplay: flex;\n\t  background-color: var(--tabf-bgcolor);\n\t  color: var(--tabf-color);\n\t  --pressed-bgcolor: var(--inv-pressed-bgcolor);\n\t  padding: .3em;\n\t  font-weight: bold;\n\t  border-bottom: 2px solid var(--bgcolor);\n  }\n\n  .countPanel {\n\t  display: flex;\n\t  align-items: center;\n\t  user-select: none;\n  }\n\n  .toggle {\n\t  background: none;\n\t  border: none;\n\t  color: var(--tabf-color);\n\t  font-weight: bold;\n\t  user-select: none;\n  }\n\n  .toggle::before {\n\t  content: \"▼ \";\n  }\n\n  .toggle.closed::before {\n\t  content: \"▶ \";\n  }\n\n  .headTi {\n\t  margin-inline-end: 2rem;\n  }\n\n  c-button:not([hidden]), c-action:not([hidden]) {\n\t  display: inline-flex;\n  }\n\n  c-button, c-action {\n\t  font-weight: normal;\n\t  margin: 0 .5em;\n  }\n\n  c-resizer[c-orient=\"row\"] {\n\t  width: 1px;\n  }\n\n  c-resizer[c-orient=\"column\"] {\n\t  height: 1px;\n  }\n\n  wsp-generators {\n\t  min-height: 3em;\n  }\n\n  wsp-src-drawer-inline {\n\t  font-size: 1.2rem;\n  }\n`);\n\n\nREG.reg.registerSkin('wsp-doc-app/srcptrInHead', 1, /* language=CSS */ `\n\t:host {\n\t\twhite-space: nowrap;\n\t\toverflow: hidden;\n\t\ttext-overflow: ellipsis;\n\t\tuser-select: none;\n\t}\n\n\t:host(.empty) {\n\t\tdisplay: none;\n\t}\n\n\t.itemUri {\n\t\tcolor: var(--tabf-color);\n\t\tfont-weight: bold;\n\t}\n\n\t.icon {\n\t\tfilter: var(--filter);\n\t\tvertical-align: middle;\n\t}\n`);\n\ncustomElements.define('wsp-doc-app', WspDocApp);\n\n\nclass FindDocItem extends FastFindItem implements IView {\n\n\tselectBtn: Button;\n\n\tsearching?: boolean;\n\n\tprotected _initialize(init: OFastFindItemsInit) {\n\t\tthis.reg = this.findReg(init);\n\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\t//\n\t\tconst btnCreate = ActionBtn.buildButton(new Action<IRegPointer<IWspUiEnv>>(\"createItem\")\n\t\t\t.setLabel(\"Créer un contenu...\")\n\t\t\t.requireEnabledPerm(\"create.item\")\n\t\t\t.requireVisiblePerm(\"ui.app.wspDoc.create.doc\")\n\t\t\t.setExecute((ctx) => {\n\t\t\t\tthis.createItem.call(btnCreate);\n\t\t\t}), this, 'dialog');\n\t\tbtnCreate.appendChild(JSX.asSvg(() => <svg viewBox=\"0 0 16 16\" style=\"height: var(--icon-size); width: var(--icon-size); fill:var(--tabf-color)\">\n\t\t\t<rect x=\"6\" y=\"2\" width=\"4\" height=\"12\"/>\n\t\t\t<rect x=\"2\" y=\"6\" width=\"12\" height=\"4\"/>\n\t\t</svg>));\n\n\t\tsr.appendChild(\n\t\t\t<div id=\"title\">\n\t\t\t\t<span>Sélection du contenu</span>\n\t\t\t\t{btnCreate}\n\t\t\t</div>\n\t\t);\n\n\t\tthis.search = <input type=\"search\" placeholder=\"Filtrer...\" spellcheck=\"false\" onchange={this.onSearchChange} oninput={this.onSearchChange} onkeydown={this.onKeydown}/> as HTMLInputElement;\n\t\tthis.datasSearch = new SpaceTreeDataSearch(this.reg, '', false, init.srcFilter, [ITEM.AIR_PREFIX]);\n\t\tthis.datasSearch.callbackSearching = this;\n\t\tthis.request = new ReqFastFind(this.wsp).initReq(this.wsp.getShortDescDef(), '', init.restrictions);\n\t\tthis.datasSearch.initSpTrDataSearch(this.request, 20, 30);\n\n\t\tconst colDefs = [new GridColTreeDef('srcTree')\n\t\t\t.setDefaultSort(1, 'ascendant')\n\t\t\t.setFlex('1rem', 1, 1).setSortable(true)\n\t\t\t.setCellBuilder(new CellBuilderSrcIconCodeTitle(this.reg, this.wsp.wspMetaUi, false, this.wsp.srcUriItemsSortFn))];\n\n\t\tthis.grid = new Grid().initialize({\n\t\t\tselType: \"mono\",\n\t\t\tcolumnDefs: colDefs,\n\t\t\tdataHolder: this.datasSearch,\n\t\t\thideHeaders: true,\n\t\t\temptyBody: () => {\n\t\t\t\tif (this.wsp.isInError) {\n\t\t\t\t\treturn EMPTY_INERROR.cloneNode(true);\n\t\t\t\t} else if (this.searching || !this.wsp.isAvailable) {\n\t\t\t\t\treturn EMPTY_LOADING.cloneNode(true);\n\t\t\t\t}\n\t\t\t\treturn EMPTY_NORESULT.cloneNode(true);\n\t\t\t}\n\t\t});\n\n\t\tthis.selectBtn = <Button ui-context=\"dialog\" label=\"Sélectionner\" disabled=\"\" onclick={() => {\n\t\t\tconst i = this.grid.getSelectedRow();\n\t\t\tif (i >= 0) this.onSelect(this.grid.dataHolder.getRow(i).rowKey);\n\t\t}}/> as Button;\n\n\t\tconst infoBuilder = this.reg.getSvc<(findDoc: FindDocItem) => Element | Promise<Element>>(\"FindDocItem.infoPanel\");\n\t\tconst infoPanel = infoBuilder ? infoBuilder(this) : null;\n\t\tif (infoPanel) {\n\t\t\tsr.appendChild(<div id=\"infoCtn\">\n\t\t\t\t<div id=\"finderCtn\" c-resizable=\"\">\n\t\t\t\t\t<div id=\"search\">\n\t\t\t\t\t\t{this.search}\n\t\t\t\t\t</div>\n\t\t\t\t\t{this.grid}\n\t\t\t\t\t<div id=\"footer\">\n\t\t\t\t\t\t{this.selectBtn}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>);\n\n\t\t\tfunction insertInfoPanel(elt: Element) {\n\t\t\t\tif (elt) {\n\t\t\t\t\telt.setAttribute(\"c-resizable\", \"\");\n\t\t\t\t\tsr.getElementById(\"infoCtn\").append(\n\t\t\t\t\t\t<Resizer c-orient=\"row\"/>,\n\t\t\t\t\t\telt\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (infoPanel instanceof Element) {\n\t\t\t\tinsertInfoPanel(infoPanel);\n\t\t\t} else {\n\t\t\t\tinfoPanel.then(insertInfoPanel);\n\t\t\t}\n\t\t} else {\n\t\t\tsr.append(\n\t\t\t\t<div id=\"search\">\n\t\t\t\t\t{this.search}\n\t\t\t\t</div>,\n\t\t\t\tthis.grid,\n\t\t\t\t<div id=\"footer\">\n\t\t\t\t\t{this.selectBtn}\n\t\t\t\t</div>\n\t\t\t);\n\t\t}\n\t\tthis.grid.addEventListener(\"grid-select\", (ev: CustomEvent) => {\n\t\t\tconst row = this.grid.dataHolder.getRow(this.grid.getSelectedRow()) as GridDataRowJson<JSrcFieldsTree>;\n\t\t\tthis.selectBtn.disabled = !row || row.rowDatas.ch != null;\n\t\t});\n\t\tthis.grid.uiEvents.on(\"rowDblclick\", (row: GridDataRowJson<JSrcFieldsTree> | null, ev: MouseEvent) => {\n\t\t\tif (row) this.onSelect(row.rowDatas);\n\t\t});\n\n\t\tthis.grid.addEventListener('keypress', function (this: Grid, ev: KeyboardEvent) {\n\t\t\tif (ev.key === ' ' || ev.key === 'Enter') {\n\t\t\t\tconst row = this.dataHolder.getRow(this.getSelectedRow()) as GridDataRowJson<JSrcFieldsTree>;\n\t\t\t\tif (row) DOMSH.findHost<FastFindItem>(this).onSelect(row.rowDatas);\n\t\t\t}\n\t\t});\n\n\t}\n\n\tprotected viewShown: boolean;\n\n\tonViewShown() {\n\t\tif (this.viewShown) return;\n\t\tthis.viewShown = true;\n\t\tthis.searching = true;\n\t\tthis.request.updateParams(this);\n\t\tthis.datasSearch.fetchSearchStart();\n\t}\n\n\tonViewHidden(closed?: boolean): void {\n\t\tthis.viewShown = false;\n\t\tif (!closed) this.datasSearch.setDatas([]); //clear\n\t}\n\n\t/** cf SpaceTreeData.callbackSearching. */\n\tonSearching(state: 'searchInit' | 'searchNext' | 'searchInside' | 'searchEnd'): void {\n\t\tsuper.onSearching(state);\n\t\tthis.searching = state !== 'searchEnd';\n\t\tthis.grid.refreshEmptyBody();\n\t}\n\n\tprotected async createItem(this: Button) {\n\t\tconst self = DOMSH.findHost(this) as FastFindItem;\n\t\tconst itTypes = new Set(self.wsp.wspMetaUi.getDocModels());\n\t\tconst shortDesc = await ItemCreator.openCreateItem({\n\t\t\treg: self.reg,\n\t\t\titemTypesTree: {\n\t\t\t\titemTypeReducer: (acc: ItemType[], cur: ItemType) => {\n\t\t\t\t\tif (itTypes.has(cur.getModel())) acc.push(cur);\n\t\t\t\t\treturn acc;\n\t\t\t\t}\n\t\t\t}\n\t\t}, \"Créer un contenu...\", this).onNextClose();\n\t\tif (shortDesc) self.onSelect(shortDesc);\n\t}\n\n\tonSelect(src: JSrcFieldsTree) {\n\t\tif (!src || ITEM.getSrcUriType(src.srcUri) === \"space\") return;\n\t\tDOMSH.findHost<WspDocApp>(this).setDoc(SRC.srcRef(src), src);\n\t}\n}\n\nREG.reg.registerSkin('wsp-finddoc', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\t--row-inSel-unfocus-bgcolor: var(--row-inSel-bgcolor);\n\t}\n\n\n\t#title {\n\t\tbackground-color: var(--tabf-bgcolor);\n\t\tcolor: var(--tabf-color);\n\t\t--pressed-bgcolor: var(--inv-pressed-bgcolor);\n\t\tpadding: .3em;\n\t\tfont-weight: bold;\n\t\tuser-select: none;\n\t}\n\n\t#createItem:not([hidden]) {\n\t\tdisplay: inline-flex;\n\t}\n\n\t#createItem {\n\t\tfont-weight: normal;\n\t\tmargin: 0 1em;\n\t}\n\n\t#search {\n\t\tdisplay: flex;\n\t\tmin-height: min-content;\n\t\tmin-width: min-content;\n\t\tbackground: .1em / 1em no-repeat url(/@skin@/commons/icons/filter.svg) var(--form-search-bgcolor);\n\t\tpadding-inline-start: 1.2em;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t}\n\n\t#infoCtn {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: min-content;\n\t\tmin-width: min-content;\n\t  background-color: var(--row-bgcolor);\n\t}\n\n\t#finderCtn {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t  min-height: 0;\n\t  min-width: 0;\n\t  flex-direction: column;\n  }\n\n\tc-resizer {\n\t\tmin-width: 1px;\n\t}\n\n\tinput {\n\t\tflex: 1;\n\t\tbackground-color: var(--form-search-bgcolor);\n\t\tcolor: var(--form-color);\n\t\tborder: none;\n\t\tpadding: 2px;\n\t\tfont-size: inherit;\n\t}\n\n\tinput::placeholder {\n\t\tcolor: var(--fade-color);\n\t\tletter-spacing: 2px;\n\t\tfont-size: .8em;\n\t\tfont-style: italic;\n\t}\n\n\tinput:focus::placeholder {\n\t\tcolor: transparent;\n\t}\n\n\tc-grid {\n\t\tflex: 1 1 16em;\n\t\tborder: none;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t}\n\n\t#footer {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tjustify-content: flex-end;\n\t}\n`);\n\n\ncustomElements.define('wsp-finddoc', FindDocItem);\n\n//\nconst EMPTY_LOADING = <section style=\"font-style:italic; text-align:center;\">Chargement en cours...</section>;\nconst EMPTY_NORESULT = <section>\n\t<div style=\"font-style:italic; text-align:center;\">Aucun contenu trouvé</div>\n</section>;\nconst EMPTY_INERROR = <section>\n\t<div style=\"font-style:italic; text-align:center;\">Configuration de l&apos;atelier en erreur</div>\n</section>;\n\n//\n\n\ninterface JLDWspDoc extends JLastDatas {\n\tdocRef?: srcRef\n\tsrcRef?: srcRef\n\tdocView?: JLastDatas\n\tsupRef?: srcRef\n\tsupEd?: JLastDatas\n\tgenCd?: string\n\tclosed?: string /** \"dsg\" initiales des panels qui sont clos. */\n}\n\n\nclass OpenWspApp extends Action<WspDocApp> {\n\tconstructor() {\n\t\tsuper('openWsp');\n\t\tthis._label = \"Mode explorateur...\";\n\t\tthis._icon = \"/@skin@/wsp/views/spaceTree/tree.svg\";\n\t\tthis.requireVisiblePerm(\"ui.wspApp\");\n\t}\n\n\texecute(ctx: WspDocApp, ev?: Event): any | \"noPreventDefault\" {\n\t\t(desk as AppFrameDeskFeat).findAndOpenApp({u: ctx.universe.getId(), wsp: ctx.wsp.code, srcRef: ctx.appDef.doc} as JWspAppDef, ev);\n\t}\n}\n\n/**\n * Menu hamburger pour l'item support.\n * Les actions dans ce menu disposent d'un contexte qui implémente : IWedEditor & IShortDescCtx\n */\nclass SupItemHamburger extends ActionMenu<IWedEditor> {\n\n\tconstructor(itemEd: ItemXmlEd) {\n\t\tsuper(\"itemHamb\");\n\t\tthis._icon = \"/@skin@/commons/icons/hamburger.svg\";\n\t\tthis._label = \"Actions générales sur cet item support\";\n\t\t// On enrichi ItemXmlEd de l'api IShortDescCtx pour les actions sur l'item.\n\t\tconst c = itemEd.view as any as IWedEditor & IShortDescCtx;\n\t\tif (!c.shortDescs) c.shortDescs = [itemEd.reg.env.longDesc];\n\t\tif (!c.emitter) c.emitter = itemEd;\n\t\tthis._groupOrder = itemEd.reg.getPref(\"groupOrder.wsp.shortDesc\", \"\");\n\t\tthis._actionLists = \"actions:wspDocAppp:support:burger actions:wsp:shortDesc\";\n\t}\n}\n\nclass SupItemDelete extends DuplicateSrc<IShortDescCtx> {\n\n\tconstructor(public wspDocApp: WspDocApp) {\n\t\tsuper();\n\t}\n\n\tasync execute(ctx: IShortDescCtx, ev?: Event): Promise<srcUri[]> {\n\t\tconst res = await super.execute(ctx, ev);\n\t\tif (res && res.length > 0) this.wspDocApp.setSup(res[0]);\n\t\treturn res;\n\t}\n}\n\nclass WspDocAppInfoBroker extends InfoBrokerBasic {\n\n\tconstructor(public wspDocApp: WspDocApp) {\n\t\tsuper();\n\t}\n\n\tasync dispatchInfo(info: IInfo, from: IInfoProducer) {\n\t\t//console.log(info, from);\n\t\tif (info instanceof InfoFocusItem) {\n\t\t\tconst isInSupport = this.isInSupportEd(from);\n\t\t\tconst isInToc = this.wspDocApp._toc.isInToc(info.srcRef);\n\t\t\tif (isInSupport || !isInToc) {\n\t\t\t\tconst itemViewer = new ItemViewerSingle({mainViewCode: \":hideWspStruct:\"});\n\t\t\t\tconst root = <ViewsContainer î={{views: [itemViewer]}} style=\"flex:1;display:flex;min-height:0;min-width:0;flex-direction:column;\"/> as ViewsContainer;\n\t\t\t\tconst subReg = REG.createSubReg<IWspUiEnv>(this.wspDocApp.reg);\n\t\t\t\tsubReg.env.infoBroker = new ItemEditInDialogInfoBroker(this.wspDocApp.reg);\n\t\t\t\tawait itemViewer.initViewer(subReg, root, null, info.srcRef);\n\t\t\t\tif (info instanceof InfoFocusNodeInItem)\n\t\t\t\t\tsubReg.env.infoBroker.dispatchInfo(new InfoFocusNodeInItem(info.xpath, info.srcRef), this);\n\t\t\t\tsubReg.env.uiRoot = POPUP.showDialog(root, this.wspDocApp, {\n\t\t\t\t\ttitleBar: {barLabel: {label: isInSupport ? \"Paramétrage du support\" : \"Fragment du contenu\"}, closeButton: {uiContext: 'dialog', label: \"Fermer\"}},\n\t\t\t\t\tinitWidth: '90%',\n\t\t\t\t\tinitHeight: '90%',\n\t\t\t\t\tresizer: {}\n\t\t\t\t});\n\t\t\t\tinfo.handled = true;\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tsuper.dispatchInfo(info, from);\n\t}\n\n\tisInSupportEd(from: IInfoProducer): boolean {\n\t\tif (from instanceof HTMLElement) {\n\t\t\tconst ed = DOMSH.findFlatParentEltOrSelf(from, this.wspDocApp, (n: Node): n is ItemXmlEd => n instanceof ItemXmlEd);\n\t\t\tif (ed && ed.parentNode === this.wspDocApp._supMain) return true;\n\t\t}\n\t\treturn false;\n\t}\n}\n\nfunction hideView(view: IView, hide: boolean) {\n\tif (DOM.setHidden(view, hide)) {\n\t\tif (hide) VIEWS.onViewHidden(view);\n\t\telse VIEWS.onViewShown(view);\n\t}\n}"]}