{"version":3,"sources":["/@back@/wsp/views/itemViewerMulti.tsx"],"names":["POPUP","PopupTooltip","REG","VIEWS","DOM","JSX","InfoCurrentItem","InfoFocusItem","InfoFocusNodeInItem","InfoReqCurrentItem","InfoSrcUriMoved","ITEM","SRC","WSP","EWspChangesEvts","LASTDATAS","Tab","Tabs","SrcMain","ActionBtn","Button","ACTION","Action","ActionSeparator","BaseElementAsync","DOMSH","OpenFastFindItem","OpenSearchItems","Resizer","renderAppend","SRCDRAWER","SrcDrawer","ItemViewerMulti","[object Object]","this","itemTypesRegs","Map","reg","mainViewParent","lastDatas","select","console","error","infoBroker","env","addConsumer","mainLD","main","tabs","_initUi","_buildAreas","leftLD","left","_initLeftTabs","rightLD","right","_initRightTabs","mainAreas","root","appendChild","createElement","attachShadow","SHADOWDOM_INIT","installSkin","mainTabs","SrcTabs","initialize","areasContext","areas","lastDatasKey","backgroundPanels","getSvc","onWspUriChange","_onWspUriChange","bind","place","eventsMgr","on","leftAreas","leftTabs","parentNode","insertBefore","c-orient","_tabs","firstElementChild","hideTabs","rightAreas","rightTabs","ldTabs","uiCtx","srcRefs","tab","selectFound","map","t","srcRef","push","filter","isNewSrcUri","srcs","fetchShortDescs","wsp","results","k","i","s","length","ldTab","sd","srcUri","itModel","extractItModelFromNewSrcUri","srcSt","SrcArea","setPinned","pin","setShowTime","silent","openSrcRefInSrcTabs","info","focusNodeInItem","focusItem","handled","selectedTab","view","longDesc","shortDesc","onSrcMoved","openSrcRef","isSrcRefShown","initializedAsync","dispatchInfo","xpath","getTabBySrcRef","newSrcUri","oldSrcUri","tabLeft","_a","_b","tabRight","_c","_d","fetchLongDesc","isConnected","replaceTab","tabPos","showTabs","Error","getTabByCode","selectTab","srcRoles","securityCtx","fallbackOpenSrcRef","showNotifInfo","addTab","e","trace","get","itemType","wspMetaUi","getItemType","createSubRegMixed","set","onViewShown","floatings","closed","removeListener","onViewHidden","parentLastDatas","msg","from","type","r","getSrcUriType","closeItem","closeSpace","u","getOneTabForSrcRef","oldItModel","area","then","ld","refreshSrc","fetchShortDesc","itSt","rebuild","rebuildItemView","updateSrc","setHidden","tabsPos","nextElementSibling","hidden","previousElementSibling","registerSkin","itemViewer","_id","getRegItemType","_subArea","getSrcMainArea","p","pinned","showTime","ctx","getLabel","getIcon","getDescription","getGroup","getLastDatasKey","getSkin","getSkinOver","needAsync","loadBody","loadLibs","buildBody","getAttribute","_selectedTab","isMainTabs","super","silently","closeTab","spaceUri","visitTabs","isSubUriOrEqual","histo","size","del","delete","add","result","SrcTab","frozen","sort","t1","t2","init","_movable","_showOnDragOver","classList","setAttribute","style","flex","skin","cbOverflow","async","overflow","oldests","getOldestRemovableTabs","oldest","isOverflow","findReg","Set","append","slot","title","î","icon","onclick","onClickHisto","action","actionContext","accel","getAccelText","mainKey","accelKey","uiContext","shiftKey","menuActions","injectSepByGroup","getList","addEventListener","onNeedValid","_initialize","sr","shadowRoot","id","name","_mainSlot","_areas","forEach","_newTab","before","parentViewCtn","_initTab","Array","selected","code","buildLastDatas","Object","assign","getId","undefined","ev","target","parentElement","actions","src","SrcOpenFromHisto","setEnabled","setLabel","reverse","showPopupActionsFromEvent","findTabFromDesc","needValid","detail","customElements","define","contains","v","toggle","areaContext","addHisto","closeTabView","show","Date","now","willSelect","hide","refresh","updateSrcAndModel","wasShown","_shown","ctxMenuActions","_bodyElt","_iconElt","class","_labelElt","onPointerOver","remHisto","_onDragStart","resetShortDescTransferToDragSession","tt","tooltipOf","hoverAllowed","srcArea","drawer","tpl","detailsTpl","close","forwardPointerEnter","once","setShortDescTransferToDragSession","shortDescs","emitter","_closeElt","onPointerOut","closeAction","onpointerdown","stopPropagation","addToList","setIcon","setGroup","setVisible","setExecute","visitTabsAsync","OpenInTabs","pos","label","_label","_group","openSrcRefInTabs","isEnabled","isVisible"],"mappings":"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","sourcesContent":["import {POPUP, PopupFloating, PopupTooltip} from \"back/commons/widgets/popups\";\nimport \"back/wsp/views/itemMain\"; //on force l'import des tags ItemMain.\nimport {IInfo} from \"lib/commons/infos\";\nimport {IReg, REG} from 'lib/commons/registry';\nimport {VIEWS} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {InfoCurrentItem, InfoFocusItem, InfoFocusNodeInItem, InfoReqCurrentItem, InfoSrcUriMoved, ITEM} from \"lib/wsp/item\";\nimport {JSrcFields, SRC, srcRef, srcUri} from \"lib/wsp/src\";\nimport {IWspUiEnv, JWspUriChangeMsg, WSP} from \"lib/wsp/wsp\";\nimport {EWspChangesEvts, WspsLivePlace} from \"lib/wsp/wspsLive\";\nimport {JLastDatas, LASTDATAS} from \"lib/commons/lastDatas\";\nimport {OTabInit, OTabsInit, Tab, Tabs} from \"back/commons/widgets/tabs\";\nimport {IItemTypeUiEnv} from \"lib/wsp/wspMetaUi\";\nimport {IItemViewer, ISrcMainCtx, SrcMain} from \"back/wsp/views/itemMain\";\nimport {IArea} from \"lib/commons/areas\";\nimport {ActionBtn, Button, OActionBtnInit, OButtonInit} from \"back/commons/widgets/buttons\";\nimport {ACTION, Action, ActionSeparator, IAction} from \"lib/commons/actions\";\nimport {IContextMenuActions, IContextMenuActionsPointer} from \"back/commons/actionables\";\nimport {BaseElementAsync} from \"back/commons/basis\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {OpenFastFindItem, OpenSearchItems} from \"back/wsp/actions/srcActions\";\nimport {Resizer} from \"back/commons/widgets/resizer\";\nimport \"back/core/zones/webZones\";\nimport {renderAppend} from \"lib/commons/utils/htmlLit\";\nimport {SRCDRAWER, SrcDrawer} from \"back/wsp/widgets/srcDrawer\";\n\n/**\n * Gestionnaire de visualisation des items.\n * Implémentation en onglets principaux + slots à gauche et à droite + fenêtres flottantes.\n */\nexport class ItemViewerMulti implements IItemViewer {\n\n\treg: IReg<IWspUiEnv>;\n\n\tfallbackOpenSrcRef?: (srcRef: srcRef, longdesc: JSrcFields, silent?: boolean) => Promise<true | null>;\n\n\t/**\n\t * Ensemble des sources actuellement affichées par cet itemViewer\n\t * indexées par son srcUri.\n\t */\n\t//srcsByUri: Map<string, SrcHolder> = new Map();\n\n\t/**\n\t * Ensemble des sources actuellement affichées par cet itemViewer\n\t * indexées par son srcId.\n\t */\n\t//srcsById: Map<string, SrcHolder>;\n\n\t/** Nombre d'entrées dans la liste chainée des accès à SrcHolder. */\n\t//accessCount = 0;\n\n\t/** Cache des registres<IItemTypeUiEnv> indexés par l'itModel. */\n\titemTypesRegs: Map<string, IReg<IItemTypeUiEnv>> = new Map();\n\n\t/** Onglets principaux. */\n\tmainTabs: SrcTabs;\n\n\t/** Onglets latéraux gauche. */\n\tleftTabs: SrcTabs;\n\n\t/** Onglets latéraux droit. */\n\trightTabs: SrcTabs;\n\n\t/** Fenêtres flottantes ouvertes. */\n\tfloatings: PopupFloating[];\n\n\tprotected onWspUriChange: (msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') => void;\n\n\n\tasync initViewer(reg: IReg<IWspUiEnv>, mainViewParent: HTMLElement, lastDatas: JLastDatas, select: srcRef): Promise<any> {\n\t\tif (this.reg) console.error(\"ItemViewerMulti already inited\");\n\t\tthis.reg = reg;\n\t\tconst infoBroker = reg.env.infoBroker;\n\t\tif (infoBroker) infoBroker.addConsumer(this);\n\t\tif (lastDatas) {\n\t\t\tconst mainLD = (lastDatas as JLDItemViewerMulti).main;\n\t\t\tif (mainLD && mainLD.tabs) {\n\t\t\t\tthis._initUi(mainViewParent, await this._buildAreas(mainLD, select, mainViewParent), mainLD);\n\t\t\t} else if (select) {\n\t\t\t\tthis._initUi(mainViewParent, await this._buildAreas(null, select, mainViewParent));\n\t\t\t} else {\n\t\t\t\tthis._initUi(mainViewParent);\n\t\t\t}\n\t\t\tconst leftLD = (lastDatas as JLDItemViewerMulti).left;\n\t\t\tif (leftLD && leftLD.tabs) {\n\t\t\t\tthis._initLeftTabs(await this._buildAreas(leftLD, null, mainViewParent), leftLD);\n\t\t\t}\n\t\t\tconst rightLD = (lastDatas as JLDItemViewerMulti).right;\n\t\t\tif (rightLD && rightLD.tabs) {\n\t\t\t\tthis._initRightTabs(await this._buildAreas(rightLD, null, mainViewParent), rightLD);\n\t\t\t}\n\t\t} else if (select) {\n\t\t\tthis._initUi(mainViewParent, await this._buildAreas(null, select, mainViewParent));\n\t\t} else {\n\t\t\tthis._initUi(mainViewParent);\n\t\t}\n\t}\n\n\tprotected _initUi(mainViewParent: HTMLElement, mainAreas?: IArea<IItemViewer, SrcMain>[], mainLD?: JLDItemViewerMultiTabs) {\n\t\tconst root = mainViewParent.appendChild(<wsp-itemviewer-multi/>).attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"webzone:item\", root);\n\t\tthis.reg.installSkin(\"wsp-itemviewer-multi\", root);\n\t\tthis.mainTabs = root.appendChild(new SrcTabs().initialize({\n\t\t\treg: this.reg,\n\t\t\tareasContext: this,\n\t\t\tareas: mainAreas,\n\t\t\tlastDatasKey: 'main',\n\t\t\tlastDatas: mainLD,\n\t\t\tbackgroundPanels: this.reg.getSvc<(tabs: Tabs<ItemViewerMulti>) => Promise<HTMLElement>>(\"ItemViewerMulti.backgroundPanels\")\n\t\t}));\n\t\tthis.onWspUriChange = this._onWspUriChange.bind(this);\n\t\tthis.reg.env.place.eventsMgr.on(\"wspUriChange\", this.onWspUriChange);\n\t}\n\n\tprotected _initLeftTabs(leftAreas?: IArea<IItemViewer, SrcMain>[], leftLD?: JLDItemViewerMultiTabs) {\n\t\tif (this.leftTabs) return;\n\t\tconst mainTabs = this.mainTabs;\n\t\tthis.leftTabs = mainTabs.parentNode.insertBefore(new SrcTabs().initialize({\n\t\t\treg: this.reg,\n\t\t\tareasContext: this,\n\t\t\tareas: leftAreas,\n\t\t\tlastDatasKey: 'left',\n\t\t\tlastDatas: leftLD\n\t\t}), mainTabs);\n\t\tmainTabs.parentNode.insertBefore(<Resizer c-orient=\"row\"/>, mainTabs);\n\t\tif (!this.leftTabs._tabs.firstElementChild) this.hideTabs(this.leftTabs);\n\t}\n\n\tprotected _initRightTabs(rightAreas?: IArea<IItemViewer, SrcMain>[], rightLD?: JLDItemViewerMultiTabs) {\n\t\tif (this.rightTabs) return;\n\t\tconst mainTabs = this.mainTabs;\n\t\tmainTabs.parentNode.appendChild(<Resizer c-orient=\"row\"/>);\n\t\tthis.rightTabs = mainTabs.parentNode.appendChild(new SrcTabs().initialize({\n\t\t\treg: this.reg,\n\t\t\tareasContext: this,\n\t\t\tareas: rightAreas,\n\t\t\tlastDatasKey: 'right',\n\t\t\tlastDatas: rightLD\n\t\t}));\n\t\tif (!this.rightTabs._tabs.firstElementChild) this.hideTabs(this.rightTabs);\n\t}\n\n\tprotected async _buildAreas(ldTabs: JLDItemViewerMultiTabs, select: srcRef, uiCtx: HTMLElement): Promise<IArea<IItemViewer, SrcMain>[]> {\n\t\tlet srcRefs: srcRef[];\n\t\tif (select) {\n\t\t\tif (ldTabs) {\n\t\t\t\t//indépendamment des lastDatas, on impose la sel d'un item via les JWspAppDef (queryString de l'URL)\n\t\t\t\tldTabs.tab = select;\n\t\t\t\tlet selectFound: boolean;\n\t\t\t\tsrcRefs = ldTabs.tabs.map((t) => {\n\t\t\t\t\tif (select === t.srcRef) selectFound = true;\n\t\t\t\t\treturn t.srcRef;\n\t\t\t\t});\n\t\t\t\tif (!selectFound) {\n\t\t\t\t\t//cet item sélectionné par les JWspAppDef n'est pas présent dans les onglets à réafficher.\n\t\t\t\t\t//On ajoute un onglet pour afficher 'select'.\n\t\t\t\t\tsrcRefs.push(select);\n\t\t\t\t\tldTabs.tabs.push({srcRef: select});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t//pas de lastDatas, mais un select\n\t\t\t\tldTabs = {tabs: [{srcRef: select}]};\n\t\t\t\tsrcRefs = [select];\n\t\t\t}\n\t\t} else {\n\t\t\tsrcRefs = ldTabs.tabs.map(t => t.srcRef).filter((srcRef) => !SRC.isNewSrcUri(srcRef));\n\t\t}\n\t\tconst srcs = await WSP.fetchShortDescs(this.reg.env.wsp, uiCtx, ...srcRefs);\n\t\tconst results: SrcArea[] = [];\n\t\tlet k = 0;\n\t\tfor (let i = 0, s = ldTabs.tabs.length; i < s; i++) {\n\t\t\tconst ldTab = ldTabs.tabs[i];\n\t\t\tconst sd = SRC.isNewSrcUri(ldTab.srcRef) ? {srcUri: ldTab.srcRef, itModel: SRC.extractItModelFromNewSrcUri(ldTab.srcRef), srcSt: 1} : srcs[k++];\n\t\t\tif (sd.srcSt > 0 && sd.itModel != null) {\n\t\t\t\tresults.push(new SrcArea(this, sd, null, ldTab).setPinned(ldTab.pin).setShowTime(i));\n\t\t\t}\n\t\t}\n\t\treturn results;\n\t}\n\n\topenSrcRef(srcRef: srcRef, silent?: boolean, lastDatas?: JLastDatas): Promise<boolean | null> {\n\t\treturn this.openSrcRefInSrcTabs(this.mainTabs, srcRef, silent, lastDatas);\n\t}\n\n\tonInfo(info: IInfo): void {\n\t\tif (info instanceof InfoFocusItem) {\n\t\t\tif (info instanceof InfoFocusNodeInItem) {\n\t\t\t\tthis.focusNodeInItem(info);\n\t\t\t} else {\n\t\t\t\tthis.focusItem(info);\n\t\t\t}\n\t\t\tinfo.handled = true;\n\t\t} else if (info instanceof InfoReqCurrentItem) {\n\t\t\tif (this.mainTabs) {\n\t\t\t\tconst tab = this.mainTabs.selectedTab;\n\t\t\t\tif (tab && tab.view instanceof SrcMain) {\n\t\t\t\t\tconst longDesc = tab.view.reg.env.longDesc;\n\t\t\t\t\tif (longDesc) {\n\t\t\t\t\t\tinfo.srcUri = longDesc.srcUri;\n\t\t\t\t\t\tinfo.shortDesc = longDesc;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (info instanceof InfoSrcUriMoved) {\n\t\t\tthis.onSrcMoved(info);\n\t\t}\n\t}\n\n\tfocusItem(info: InfoFocusItem) {\n\t\tthis.openSrcRef(info.srcRef, false, info.lastDatas);\n\t}\n\n\tasync focusNodeInItem(info: InfoFocusNodeInItem) {\n\t\tif (this.isSrcRefShown(this.mainTabs, info.srcRef)) return; //item déjà chargé et affiché en 1er plan, il va gérer la partie \"inItem\".\n\t\tif (await this.openSrcRef(info.srcRef)) {\n\t\t\t//On redispatch la demande une fois l'item chargé.\n\t\t\tconst tab = this.mainTabs.selectedTab;\n\t\t\tif (tab.view instanceof BaseElementAsync) await tab.view.initializedAsync;\n\t\t\tthis.reg.env.infoBroker.dispatchInfo(new InfoFocusNodeInItem(info.xpath, info.srcRef), this);\n\t\t}\n\t}\n\n\t/**\n\t * Si l'ancienne uri est présente et la nouvelle uri est absente,\n\t * on remplace l'onglet avec la nouvelle uri.\n\t */\n\tasync onSrcMoved(info: InfoSrcUriMoved) {\n\t\tconst tab = !this.mainTabs.getTabBySrcRef(info.newSrcUri) ? this.mainTabs.getTabBySrcRef(info.oldSrcUri) : null;\n\t\tconst tabLeft = !this.leftTabs?.getTabBySrcRef(info.newSrcUri) ? this.leftTabs?.getTabBySrcRef(info.oldSrcUri) : null;\n\t\tconst tabRight = !this.leftTabs?.getTabBySrcRef(info.newSrcUri) ? this.rightTabs?.getTabBySrcRef(info.oldSrcUri) : null;\n\t\tif (tab || tabLeft || tabRight) {\n\t\t\tconst wsp = this.reg.env.wsp;\n\t\t\tconst longDesc = await wsp.fetchLongDesc(info.newSrcUri);\n\t\t\tif (longDesc.srcSt < 0 || longDesc.itModel == null) {\n\t\t\t\t// tab?.closeTabView(true);\n\t\t\t\t// tabLeft?.closeTabView(true);\n\t\t\t\t// tabRight?.closeTabView(true);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (tab && tab.isConnected) await this.mainTabs.replaceTab(tab, new SrcArea(this, longDesc, longDesc));\n\t\t\tif (tabLeft && tabLeft.isConnected) await this.leftTabs.replaceTab(tabLeft, new SrcArea(this, longDesc, longDesc));\n\t\t\tif (tabRight && tabRight.isConnected) await this.leftTabs.replaceTab(tabRight, new SrcArea(this, longDesc, longDesc));\n\t\t}\n\t\treturn true;\n\t}\n\n\topenSrcRefInTabs(tabPos: 'left' | 'main' | 'right', srcRef: srcRef, silent?: boolean): Promise<boolean> {\n\t\tswitch (tabPos) {\n\t\tcase 'main':\n\t\t\treturn this.openSrcRefInSrcTabs(this.mainTabs, srcRef, silent);\n\t\tcase 'left':\n\t\t\tif (!this.leftTabs) this._initLeftTabs();\n\t\t\tthis.showTabs(this.leftTabs);\n\t\t\treturn this.openSrcRefInSrcTabs(this.leftTabs, srcRef, silent);\n\t\tcase 'right':\n\t\t\tif (!this.rightTabs) this._initRightTabs();\n\t\t\tthis.showTabs(this.rightTabs);\n\t\t\treturn this.openSrcRefInSrcTabs(this.rightTabs, srcRef, silent);\n\t\t}\n\t\tthrow Error(tabPos);\n\t}\n\n\tisSrcRefShown(tabs: SrcTabs, srcRef: srcRef): boolean {\n\t\tconst tab = tabs.getTabByCode(srcRef);\n\t\tif (tab) return tabs.selectedTab === tab;\n\t\treturn false;\n\t}\n\n\tasync openSrcRefInSrcTabs(tabs: SrcTabs, srcRef: srcRef, silent?: boolean, lastDatas?: JLastDatas): Promise<boolean | null> {\n\t\ttry {\n\t\t\tconst tab = tabs.getTabByCode(srcRef);\n\t\t\tif (tab) return tabs.selectTab(tab);\n\t\t\tconst wsp = this.reg.env.wsp;\n\t\t\tconst longDesc =\n\t\t\t\tSRC.isNewSrcUri(srcRef) ?\n\t\t\t\t\t//Fake longDesc si contenu en création\n\t\t\t\t\t{srcUri: srcRef, itModel: SRC.extractItModelFromNewSrcUri(srcRef), srcSt: 1, srcRoles: this.reg.env.securityCtx.srcRoles} :\n\t\t\t\t\t//Fetch longDesc\n\t\t\t\t\tawait wsp.fetchLongDesc(srcRef);\n\t\t\tif (longDesc.srcSt < 0 || longDesc.itModel == null) {\n\t\t\t\tif (this.fallbackOpenSrcRef) {\n\t\t\t\t\treturn this.fallbackOpenSrcRef(srcRef, longDesc, silent);\n\t\t\t\t} else {\n\t\t\t\t\tif (!silent) POPUP.showNotifInfo(\"Ce contenu n'est plus disponible.\", tabs);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t}\n\t\t\tawait tabs.addTab(new SrcArea(this, longDesc, longDesc, lastDatas), {select: true});\n\t\t\treturn true;\n\t\t} catch (e) {\n\t\t\tconsole.trace(e);\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetRegItemType(itModel: string) {\n\t\tconst wsp = this.reg.env.wsp;\n\t\tlet reg = this.itemTypesRegs.get(itModel);\n\t\tif (!reg) {\n\t\t\tconst itemType = wsp.wspMetaUi.getItemType(itModel);\n\t\t\treg = REG.createSubRegMixed(this.reg, itemType.reg);\n\t\t\tthis.itemTypesRegs.set(itModel, reg);\n\t\t}\n\t\treturn reg;\n\t}\n\n\tonViewShown() {\n\t\t//this.app.reg.env.wsp.\n\t\tVIEWS.onViewShown(this.mainTabs);\n\t\tif (this.leftTabs) VIEWS.onViewShown(this.leftTabs);\n\t\tif (this.rightTabs) VIEWS.onViewShown(this.rightTabs);\n\t\tif (this.floatings) throw Error(\"TODO floatings...\");\n\t}\n\n\tonViewHidden(closed?: boolean) {\n\t\tif (closed) {\n\t\t\tthis.reg.env.place.eventsMgr.removeListener(\"wspUriChange\", this.onWspUriChange);\n\t\t\tVIEWS.onViewHidden(this.mainTabs, true);\n\t\t\tif (this.leftTabs) VIEWS.onViewHidden(this.leftTabs, true);\n\t\t\tif (this.rightTabs) VIEWS.onViewHidden(this.rightTabs, true);\n\t\t\tif (this.floatings) throw Error(\"TODO floatings...\");\n\t\t} else {\n\t\t\tVIEWS.onViewHidden(this.mainTabs, false);\n\t\t\tif (this.leftTabs) VIEWS.onViewHidden(this.leftTabs, false);\n\t\t\tif (this.rightTabs) VIEWS.onViewHidden(this.rightTabs, false);\n\t\t\tif (this.floatings) throw Error(\"TODO floatings...\");\n\t\t}\n\t}\n\n\tbuildLastDatas(parentLastDatas: JLDItemViewerMulti): void {\n\t\t//TODO buildLastDatas floatings.\n\t\t//Les lastDatas des onglets sont buildés naturellement par l'arbo DOM.\n\t}\n\n\tprotected _onWspUriChange(msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') {\n\t\tif (msg.type === EWspChangesEvts.r) {\n\t\t\t//Traitement du remove\n\t\t\tconst type = ITEM.getSrcUriType(msg.srcUri);\n\t\t\tif (type === 'item') {\n\t\t\t\t//Suppr de l'item\n\t\t\t\tconst srcRef = SRC.srcRef(msg);\n\t\t\t\tthis.mainTabs.closeItem(srcRef);\n\t\t\t\tif (this.leftTabs) this.leftTabs.closeItem(srcRef);\n\t\t\t\tif (this.rightTabs) this.rightTabs.closeItem(srcRef);\n\t\t\t} else if (type === 'space') {\n\t\t\t\t//Suppr d'un espace ancêtre de l'item\n\t\t\t\tthis.mainTabs.closeSpace(msg.srcUri);\n\t\t\t\tif (this.leftTabs) this.leftTabs.closeSpace(msg.srcUri);\n\t\t\t\tif (this.rightTabs) this.rightTabs.closeSpace(msg.srcUri);\n\t\t\t}\n\t\t} else if (msg.type === EWspChangesEvts.u) {\n\t\t\t//Traitement de l'update\n\t\t\tconst srcRef = SRC.srcRef(msg);\n\t\t\tconst tab = this.getOneTabForSrcRef(srcRef);\n\t\t\tif (tab && tab.view) {\n\t\t\t\t//item construit, faut détecter si l'itModel n'a pas été modifié\n\t\t\t\tconst oldItModel = (tab.area as SrcArea).shortDesc.itModel;\n\t\t\t\tthis.reg.env.wsp.fetchLongDesc(srcRef, this.mainTabs).then((ld: JSrcFields) => {\n\t\t\t\t\tthis.refreshSrc(ld, ld, oldItModel !== ld.itModel);\n\t\t\t\t});\n\t\t\t} else if (tab) {\n\t\t\t\t//item dans les onglets, mais non construit\n\t\t\t\tthis.reg.env.wsp.fetchShortDesc(srcRef, this.mainTabs).then((sd: JSrcFields) => {\n\t\t\t\t\tthis.refreshSrc(sd);\n\t\t\t\t});\n\t\t\t}\n\t\t} else if (msg.type === EWspChangesEvts.s) {\n\t\t\tconst srcRef = SRC.srcRef(msg);\n\t\t\tconst tab = this.getOneTabForSrcRef(srcRef);\n\t\t\tif (tab) {\n\t\t\t\tconst area = tab.area as SrcArea;\n\t\t\t\tif (area.longDesc) {\n\t\t\t\t\tarea.longDesc.itSt = msg.itSt;\n\t\t\t\t\tthis.refreshSrc(area.longDesc, area.longDesc);\n\t\t\t\t} else {\n\t\t\t\t\tarea.shortDesc.itSt = msg.itSt;\n\t\t\t\t\tthis.refreshSrc(area.shortDesc);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/** Retourne le 1er tab pour ce srcRef avec view construite, ou à défaut, sans view construite. */\n\tgetOneTabForSrcRef(srcRef: srcRef): SrcTab {\n\t\tlet tab = this.mainTabs.getTabBySrcRef(srcRef);\n\t\tif ((!tab || !tab.view) && this.leftTabs) tab = this.leftTabs.getTabBySrcRef(srcRef);\n\t\tif ((!tab || !tab.view) && this.rightTabs) tab = this.rightTabs.getTabBySrcRef(srcRef);\n\t\treturn tab;\n\t}\n\n\trefreshSrc(shortDesc: JSrcFields, longDesc?: JSrcFields, rebuild?: boolean) {\n\t\tconst srcRef = SRC.srcRef(shortDesc);\n\t\tlet tab = this.mainTabs.getTabBySrcRef(srcRef);\n\t\tif (tab) rebuild ? tab.rebuildItemView(this, longDesc) : tab.updateSrc(shortDesc, longDesc);\n\t\tif (this.leftTabs) {\n\t\t\ttab = this.leftTabs.getTabBySrcRef(srcRef);\n\t\t\tif (tab) rebuild ? tab.rebuildItemView(this, longDesc) : tab.updateSrc(shortDesc, longDesc);\n\t\t}\n\t\tif (this.rightTabs) {\n\t\t\ttab = this.rightTabs.getTabBySrcRef(srcRef);\n\t\t\tif (tab) rebuild ? tab.rebuildItemView(this, longDesc) : tab.updateSrc(shortDesc, longDesc);\n\t\t}\n\t}\n\n\t/** Masque un SrcTabs secondaire. */\n\thideTabs(tabs: SrcTabs) {\n\t\tif (DOM.setHidden(tabs, true)) {\n\t\t\tif (tabs.tabsPos === 'left') (tabs.nextElementSibling as Resizer).hidden = true;\n\t\t\telse (tabs.previousElementSibling as Resizer).hidden = true;\n\t\t}\n\t}\n\n\t/** Vérifie qu'un SrcTabs secondaire est visible. */\n\tshowTabs(tabs: SrcTabs) {\n\t\tif (DOM.setHidden(tabs, false)) {\n\t\t\tif (tabs.tabsPos === 'left') (tabs.nextElementSibling as Resizer).hidden = false;\n\t\t\telse (tabs.previousElementSibling as Resizer).hidden = false;\n\t\t}\n\t}\n}\n\n\nREG.reg.registerSkin('wsp-itemviewer-multi', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-width: 0;\n\t\tmin-height: 0;\n\t\tbackground-color: var(--bgcolor);\n\t\tcolor: var(--color);\n\t}\n\n\t[hidden] {\n\t\tdisplay: none;\n\t}\n\n\tc-resizer {\n\t\twidth: 1px;\n\t}\n\n\thr {\n\t\tborder: none;\n\t\tborder-inline-start: 1px solid var(--border-color);\n\t\tmargin: .2rem;\n\t\talign-self: stretch;\n\t}\n`);\n\n\n/**\n * Area d'un ItemMain dans le contexte du ItemViewerMulti.\n * Chaque instance d'area est spécifique à chaque src : SrcArea implémente ISrcMainCtx\n * pour servir de context à l'ItemMainArea fournit par l'itemType.\n */\nclass SrcArea implements IArea<IItemViewer, SrcMain>, ISrcMainCtx {\n\n\treg: IReg<IItemTypeUiEnv>;\n\tlongDesc: JSrcFields;\n\tshortDesc: JSrcFields;\n\n\tpinned: boolean;\n\tshowTime: number;\n\tlastDatas: JLastDatas;\n\n\tprotected _id: string;\n\n\t/** ItemMainArea issu de l'itemType. */\n\tprotected _subArea: IArea<ISrcMainCtx, SrcMain>;\n\n\tconstructor(itemViewer: ItemViewerMulti, shortDesc: JSrcFields, longDesc?: JSrcFields, lastDatas?: JLastDatas) {\n\t\tthis._id = SRC.srcRef(shortDesc);\n\t\tthis.shortDesc = shortDesc;\n\t\tthis.longDesc = longDesc;\n\t\tif (lastDatas) this.lastDatas = lastDatas;\n\t\tthis.reg = itemViewer.getRegItemType(shortDesc.itModel);\n\t\tthis._subArea = this.reg.env.itemType.getSrcMainArea(this);\n\t}\n\n\tsetPinned(p: boolean): this {\n\t\tthis.pinned = p === true;\n\t\treturn this;\n\t}\n\n\tsetShowTime(t: number): this {\n\t\tthis.showTime = t;\n\t\treturn this;\n\t}\n\n\tupdateSrcAndModel(itemViewer: ItemViewerMulti, ld: JSrcFields) {\n\t\tthis.shortDesc = ld;\n\t\tthis.longDesc = ld;\n\t\tthis.reg = itemViewer.getRegItemType(ld.itModel);\n\t\tthis._subArea = this.reg.env.itemType.getSrcMainArea(this);\n\t}\n\n\tgetId(): string {\n\t\treturn this._id;\n\t}\n\n\tgetLabel(ctx: ItemViewerMulti): string {\n\t\treturn this._subArea.getLabel(this);\n\t}\n\n\tgetIcon(ctx: ItemViewerMulti): string {\n\t\treturn this._subArea.getIcon(this);\n\t}\n\n\tgetDescription(ctx: ItemViewerMulti): string {\n\t\treturn this._subArea.getDescription(this);\n\t}\n\n\tgetGroup(ctx: ItemViewerMulti): string {\n\t\treturn this._subArea.getGroup(this);\n\t}\n\n\tgetLastDatasKey(ctx: ItemViewerMulti): string {\n\t\treturn this._subArea.getLastDatasKey(this);\n\t}\n\n\tgetSkin(ctx: ItemViewerMulti): string {\n\t\treturn this._subArea.getSkin(this);\n\t}\n\n\tgetSkinOver(ctx: ItemViewerMulti): string {\n\t\treturn this._subArea.getSkinOver(this);\n\t}\n\n\tisAvailable(ctx: ItemViewerMulti): boolean {return true}\n\n\tisEnabled(ctx: ItemViewerMulti): boolean {return true}\n\n\tisVisible(ctx: ItemViewerMulti): boolean {return true}\n\n\tisInstantiable(ctx: IItemViewer): boolean {return true}\n\n\tneedAsync(ctx: ItemViewerMulti): boolean {\n\t\treturn this._subArea.needAsync(this);\n\t}\n\n\tloadBody(ctx: ItemViewerMulti, lastDatas?: JLastDatas): Promise<SrcMain> {\n\t\treturn this._subArea.loadBody(this, lastDatas);\n\t}\n\n\tloadLibs(ctx: IItemViewer): Promise<void> {\n\t\treturn this._subArea.loadLibs(this);\n\t}\n\n\tbuildBody(ctx: ItemViewerMulti, lastDatas?: JLastDatas): SrcMain {\n\t\treturn this._subArea.buildBody(this, lastDatas);\n\t}\n}\n\n/** LastDatas dédiés. */\ninterface JLDItemViewerMulti extends JLastDatas {\n\tmain?: JLDItemViewerMultiTabs\n\tleft?: JLDItemViewerMultiTabs\n\tright?: JLDItemViewerMultiTabs\n\tfloatings?: JLastDatas[]\n}\n\ninterface JLDItemViewerMultiTabs extends JLastDatas {\n\ttab?: string\n\ttabs?: JLDItemViewerMultiTab[]\n\thisto?: string[]\n}\n\ninterface JLDItemViewerMultiTab extends JLastDatas {\n\tsrcRef: srcRef\n\tpin?: boolean\n}\n\n\n/** Regroupement d'onglets dédiés */\nexport class SrcTabs extends Tabs<ItemViewerMulti> {\n\n\treg: IReg<IWspUiEnv>;\n\n\tmenuActions: IAction<SrcTab>[];\n\n\thisto: Set<srcRef>;\n\n\tget tabsPos(): 'left' | 'main' | 'right' {return this.getAttribute('last-datas') as any}\n\n\tisMainTabs(): boolean {return this.areasContext.mainTabs === this}\n\n\tasync selectTab(tab: Tab<ItemViewerMulti>, lastDatas?: JLastDatas): Promise<boolean> {\n\t\tif (tab === this._selectedTab) {\n\t\t\t//On force un refocus (scrolls explorateur...)\n\t\t\tconst area = tab.area;\n\t\t\tif (area instanceof SrcArea && this.isMainTabs()) {\n\t\t\t\t//On est dans les onglets principaux et l'onglet affiché est de type item.\n\t\t\t\tconst infoBroker = this.areasContext.reg.env.infoBroker;\n\t\t\t\tif (infoBroker) infoBroker.dispatchInfo(new InfoCurrentItem(area.shortDesc.srcUri, area.shortDesc), this);\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\t\treturn super.selectTab(tab, lastDatas);\n\t}\n\n\tasync closeTab(tab: SrcTab, silently?: boolean): Promise<boolean> {\n\t\tif (!await super.closeTab(tab, silently, true)) return false;\n\t\tif (!this.isMainTabs() && !this._tabs.firstElementChild) {\n\t\t\t//Tabs secondaires et plus de tabs, on masque\n\t\t\tthis.areasContext.hideTabs(this);\n\t\t}\n\t\treturn true;\n\t}\n\n\tgetTabBySrcRef(srcRef: srcRef): SrcTab {\n\t\treturn this.getTabByCode(srcRef) as SrcTab;\n\t}\n\n\tcloseItem(srcRef: srcRef) {\n\t\tconst tab = this.getTabBySrcRef(srcRef);\n\t\tif (tab) this.closeTab(tab);\n\t}\n\n\tcloseSpace(spaceUri: srcUri) {\n\t\tthis.visitTabs((t) => {\n\t\t\tconst area = t.area;\n\t\t\tif (area instanceof SrcArea) {\n\t\t\t\tif (SRC.isSubUriOrEqual(spaceUri, area.shortDesc.srcUri)) this.closeTab(t as SrcTab);\n\t\t\t}\n\t\t})\n\t}\n\n\taddHisto(srcRef: srcRef) {\n\t\tif (this.histo.size > 12) {\n\t\t\tlet del = 0;\n\t\t\tfor (const s of this.histo) {\n\t\t\t\tthis.histo.delete(s);\n\t\t\t\tif (++del === 12) break;\n\t\t\t}\n\t\t}\n\t\tthis.histo.add(srcRef);\n\t}\n\n\tremHisto(srcRef: srcRef) {\n\t\tthis.histo.delete(srcRef);\n\t}\n\n\tgetOldestRemovableTabs(): SrcTab[] {\n\t\tconst result: SrcTab[] = [];\n\t\tlet tab = this._tabs.firstElementChild;\n\t\twhile (tab) {\n\t\t\tif (tab instanceof SrcTab && !tab.frozen && !tab.pinned) result.push(tab);\n\t\t\ttab = tab.nextElementSibling;\n\t\t}\n\t\tresult.sort((t1, t2) => t1.showTime - t2.showTime);\n\t\treturn result; //[this._tabs.firstElementChild as SrcTab]; //TODO\n\t}\n\n\tprotected _initialize(init: OTabsInit<ItemViewerMulti>): Promise<void> {\n\t\tthis._movable = true;\n\t\tthis._showOnDragOver = true;\n\t\tthis.classList.add(\"noBorder\");\n\t\tthis.setAttribute(\"c-resizable\", \"\");\n\t\tthis.style.flex = \"1\";\n\t\tinit.skin = \"c-tabs/wsp-src-tabs\";\n\t\tinit.cbOverflow = async (overflow: boolean) => {\n\t\t\tif (overflow) {\n\t\t\t\t//Tentavie de cleanup des anciens tabs.\n\t\t\t\tconst oldests = this.getOldestRemovableTabs();\n\t\t\t\tfor (let i = 0, s = oldests.length - 2; i < s; i++) {// -2 : on garde toujours au moins 2 onglets\n\t\t\t\t\tconst oldest = oldests[i];\n\t\t\t\t\tif (oldest.isConnected) {\n\t\t\t\t\t\tawait this.closeTab(oldest, true);\n\t\t\t\t\t\tif (!this._tabs.isOverflow) return;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tthis.reg = this.findReg(init);\n\n\t\tif (init.lastDatas && (init.lastDatas as JLDItemViewerMultiTabs).histo) this.histo = new Set((init.lastDatas as JLDItemViewerMultiTabs).histo);\n\t\telse this.histo = new Set();\n\t\tthis.append(\n\t\t\t<hr slot=\"tools-end\"/>,\n\t\t\t<Button slot=\"tools-end\" title=\"Historique des items affichés\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\ticon: \"/@skin@/wsp/views/itemViewerMulti/histo.svg\"\n\t\t\t} as OButtonInit} onclick={this.onClickHisto}/>,\n\t\t\t<ActionBtn slot=\"tools-end\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\taction: new OpenFastFindItem(),\n\t\t\t\tactionContext: this,\n\t\t\t\taccel: ACTION.getAccelText({mainKey: \"<\", accelKey: true}),\n\t\t\t\tuiContext: 'bar'\n\t\t\t} as OActionBtnInit<any>}/>,\n\t\t\t<ActionBtn slot=\"tools-end\" î={{\n\t\t\t\treg: this.reg,\n\t\t\t\taction: new OpenSearchItems(),\n\t\t\t\taccel: ACTION.getAccelText({mainKey: \"F\", accelKey: true, shiftKey: true}),\n\t\t\t\tactionContext: this,\n\t\t\t\tuiContext: 'bar'\n\t\t\t} as OActionBtnInit<any>}/>\n\t\t);\n\n\t\tthis.menuActions = ACTION.injectSepByGroup(this.reg.getList<IAction<SrcTab>>(\"actions:itemViewerMulti\"), \"tab * close\", null);\n\n\t\tthis.addEventListener(\"wsp-need-valid\", this.onNeedValid);\n\n\t\treturn super._initialize(init);\n\t}\n\n\t_initShadowRoot() {\n\t\t//Tabs en bas\n\t\tconst sr = this.shadowRoot;\n\t\tthis._tabs.id = 'tabs';\n\t\tsr.appendChild(<div id='head'>\n\t\t\t<slot name='tools-start'/>\n\t\t\t{this._tabs}\n\t\t\t<slot name='tools-end'/>\n\t\t</div>);\n\t\tsr.appendChild(<div id='panels'>{this._mainSlot}</div>);\n\t};\n\n\t_initTabs() {\n\t\tif (this._areas) this._areas.forEach((area: IArea<ItemViewerMulti>) => {\n\t\t\tthis._newTab(area);\n\t\t});\n\t}\n\n\t_newTab(area: IArea<ItemViewerMulti>, before?: Tab<ItemViewerMulti>): SrcTab {\n\t\tconst tab = new SrcTab().initialize({\n\t\t\tparentViewCtn: this,\n\t\t\tarea: area\n\t\t});\n\t\tthis._initTab(tab);\n\t\tthis._tabs.insertBefore(tab, before);\n\t\treturn tab;\n\t}\n\n\tbuildLastDatas(p: JLDItemViewerMulti) {\n\t\tconst k = this.getAttribute(\"last-datas\") as 'main' | 'left' | 'right';\n\t\tconst ld = {} as JLDItemViewerMultiTabs;\n\t\tld.histo = Array.from(this.histo);\n\t\tld.tabs = [] as JLDItemViewerMultiTab[];\n\t\tthis.visitTabs((t: SrcTab) => {\n\t\t\tif (!t.frozen && t.area instanceof SrcArea) {\n\t\t\t\tconst s = {} as JLDItemViewerMultiTab;\n\t\t\t\tif (t.selected) {\n\t\t\t\t\tld.tab = t.code;\n\t\t\t\t\tLASTDATAS.buildLastDatas(s, t.view, true);\n\t\t\t\t} else if (t.area.lastDatas) Object.assign(s, t.area.lastDatas);\n\t\t\t\ts.srcRef = t.area.getId();\n\t\t\t\ts.pin = t.pinned ? true : undefined;\n\t\t\t\tld.tabs.push(s);\n\t\t\t}\n\t\t});\n\t\tif (this.isMainTabs()) {\n\t\t\tp[k] = ld;\n\t\t\tthis.areasContext.buildLastDatas(p);//floating windows\n\t\t} else if (ld.tabs.length > 0) {\n\t\t\t//Onglets secondaires renseignés que si non vides.\n\t\t\tp[k] = ld;\n\t\t}\n\t}\n\n\tasync onClickHisto(this: Button, ev: Event) {\n\t\tconst target = ev.target as HTMLElement; //avant async\n\t\tconst tabs = this.parentElement as SrcTabs;\n\t\tconst actions: IAction<SrcTabs>[] = [];\n\t\tif (tabs.histo.size > 0) {\n\t\t\tconst wsp = tabs.reg.env.wsp;\n\t\t\tconst srcs = await WSP.fetchShortDescs(wsp, tabs, ...tabs.histo);\n\t\t\tfor (const src of srcs) {\n\t\t\t\tif (src && src.srcSt > 0 && src.itModel != null) actions.push(new SrcOpenFromHisto(tabs.areasContext, src));\n\t\t\t}\n\t\t}\n\t\tif (actions.length === 0) actions.push(new Action<SrcTabs>('none').setEnabled(false).setLabel(\"Historique vide\"));\n\t\telse actions.reverse();\n\t\tactions.push(\n\t\t\tnew ActionSeparator(),\n\t\t\tnew OpenFastFindItem().setLabel(\"Autre item...\")\n\t\t);\n\t\tPOPUP.showPopupActionsFromEvent({\n\t\t\treg: tabs.reg,\n\t\t\tactions,\n\t\t\tactionContext: tabs\n\t\t}, ev, target);\n\t}\n\n\n\tprotected onNeedValid(ev: CustomEvent) {\n\t\tconst tab = this.findTabFromDesc(ev.target as Node) as SrcTab;\n\t\tif (tab) tab.needValid = ev.detail as boolean;\n\t}\n}\n\n\nREG.reg.registerSkin('c-tabs/wsp-src-tabs', 1, /* language=CSS */ `\n\t#tabs > .selected {\n\t\tbackground-color: var(--page-bgcolor);\n\t}\n`);\n\ncustomElements.define(\"wsp-src-tabs\", SrcTabs);\n\n/** Onglet d'un item. */\nexport class SrcTab extends Tab<ItemViewerMulti> implements IContextMenuActionsPointer<SrcTab> {\n\n\tparentViewCtn: SrcTabs;\n\n\t/** Onglet épinglé par le user. */\n\tget pinned(): boolean {return this.classList.contains('pinned')};\n\n\tset pinned(v: boolean) {this.classList.toggle('pinned', v)};\n\n\t/** Onglet dont le contenu attend une action explicite de l'utilisateur de validation. */\n\tget needValid(): boolean {return this.classList.contains('needValid')};\n\n\tset needValid(v: boolean) {this.classList.toggle('needValid', v)};\n\n\t/** Onglet figé applicativement. Ne peut être supprimé par le user. */\n\tfrozen: boolean;\n\n\tshowTime: number;\n\n\t_bodyElt: HTMLElement;\n\t_closeElt: HTMLElement;\n\n\tisMainTabs(): boolean {return this.areaContext.mainTabs === this.parentViewCtn}\n\n\t/** Ne doit être appelé que par SrcTabs. */\n\tasync closeTabView(silently?: boolean): Promise<boolean> {\n\t\tif (this.area instanceof SrcArea) this.parentViewCtn.addHisto(SRC.srcRef(this.area.shortDesc));\n\t\tif (!await super.closeTabView(silently)) return false;\n\t\tif (this.selected && this.isMainTabs() && this.area instanceof SrcArea) {\n\t\t\t//On est dans les onglets principaux et l'onglet est sel, on dispatch la perte de la sel.\n\t\t\tconst infoBroker = this.parentViewCtn.areasContext.reg.env.infoBroker;\n\t\t\tif (infoBroker) infoBroker.dispatchInfo(new InfoCurrentItem(null), this);\n\t\t}\n\t\treturn true;\n\t}\n\n\tasync show(lastDatas?: JLastDatas): Promise<void> {\n\t\tconst area = this.area;\n\t\tawait super.show(area instanceof SrcArea ? area.lastDatas : lastDatas);\n\t\tthis.showTime = Date.now();\n\t\tif (this.isMainTabs() && area instanceof SrcArea) {\n\t\t\t//On est dans les onglets principaux et l'onglet affiché est de type item.\n\t\t\tconst view = this.view as SrcMain;\n\t\t\tif (!view) return;\n\t\t\tawait view.initializedAsync;\n\t\t\tarea.longDesc = area.shortDesc = view.reg.env.longDesc;\n\t\t\tconst infoBroker = this.parentViewCtn.areasContext.reg.env.infoBroker;\n\t\t\tif (infoBroker) infoBroker.dispatchInfo(new InfoCurrentItem(area.shortDesc.srcUri, area.shortDesc), this);\n\t\t}\n\t}\n\n\tasync hide(willSelect?: Tab<ItemViewerMulti>): Promise<boolean> {\n\t\tif (this.area instanceof SrcArea) this.area.lastDatas = LASTDATAS.buildLastDatas({}, this.view, true);\n\t\tconst hidden = await super.hide();\n\t\tif (hidden && willSelect == null && this.isMainTabs() && this.area instanceof SrcArea && this.area.longDesc) {\n\t\t\t//Pas de nouvel onglet à afficher (si willSelect non null, 2 events successifs et problème avec l'historique du navigateur)\n\t\t\t//On est dans les onglets principaux et l'onglet affiché est de type item.\n\t\t\t//=> on dispatch l'absence d'onglet sélectionné\n\t\t\tconst infoBroker = this.parentViewCtn.areasContext.reg.env.infoBroker;\n\t\t\tif (infoBroker) infoBroker.dispatchInfo(new InfoCurrentItem(null), this);\n\t\t}\n\t\treturn hidden;\n\t}\n\n\tupdateSrc(shortDesc: JSrcFields, longDesc?: JSrcFields) {\n\t\tif (this.area instanceof SrcArea) {\n\t\t\tthis.area.shortDesc = shortDesc;\n\t\t\tthis.area.longDesc = longDesc;\n\t\t\tthis.refresh();\n\t\t}\n\t}\n\n\tasync rebuildItemView(itemViewer: ItemViewerMulti, longDesc: JSrcFields) {\n\t\tif (this.area instanceof SrcArea) {\n\t\t\tthis.area.updateSrcAndModel(itemViewer, longDesc);\n\t\t\tconst wasShown = this._shown;\n\t\t\tthis._shown = false;\n\t\t\tthis.needValid = false;\n\t\t\tawait super.closeTabView(true);\n\t\t\tif (wasShown) super.show(this.area.lastDatas);\n\t\t\telse this.refresh();\n\t\t}\n\t}\n\n\tget ctxMenuActions(): IContextMenuActions<SrcTab> {\n\t\treturn {\n\t\t\tactions: this.parentViewCtn.menuActions,\n\t\t\tactionContext: this\n\t\t}\n\t}\n\n\tprotected _initialize(init: OTabInit<ItemViewerMulti>) {\n\t\tif (!init.skin) init.skin = \"wsp-src-tab\";\n\t\tsuper._initialize(init);\n\t\tthis._bodyElt = this.shadowRoot.appendChild(<div/>);\n\t\tthis._iconElt = this._bodyElt.appendChild(<span class='icon'/>);\n\t\tthis._labelElt = this._bodyElt.appendChild(<span class='label'/>);\n\t\tthis.addEventListener(\"pointerover\", this.onPointerOver); //btn close\n\t\tif (init.area instanceof SrcArea) {\n\t\t\tthis.parentViewCtn.remHisto(SRC.srcRef(init.area.shortDesc));\n\t\t\tthis.pinned = init.area.pinned === true;\n\t\t\tthis.showTime = init.area.showTime;\n\t\t\tthis.setAttribute(\"draggable\", \"true\");\n\t\t\tthis.addEventListener(\"dragstart\", this._onDragStart);\n\t\t\tthis.addEventListener('dragend', ITEM.resetShortDescTransferToDragSession);\n\t\t\tthis.addEventListener('pointerenter', function (this: SrcTab, ev) {\n\t\t\t\tconst tt = new PopupTooltip().initialize({\n\t\t\t\t\ttooltipOf: this,\n\t\t\t\t\thoverAllowed: true\n\t\t\t\t});\n\t\t\t\ttt.addEventListener('c-show', function (this: PopupTooltip, ev) {\n\t\t\t\t\tconst srcArea = (this.tooltipOf as SrcTab).area as SrcArea;\n\t\t\t\t\tconst drawer = this.view as SrcDrawer || this.appendChild(new SrcDrawer().initialize({skin: 'wsp-src-drawer/tooltip', tpl: SRCDRAWER.detailsTpl, reg: srcArea.reg}));\n\t\t\t\t\tconst itemType = srcArea.reg.env.itemType;\n\t\t\t\t\tconst tpl = itemType ? SRCDRAWER.detailsTpl(itemType, srcArea.shortDesc, drawer) : null;\n\t\t\t\t\tif (tpl) renderAppend(tpl, drawer.shadowRoot);\n\t\t\t\t\telse this.close();\n\t\t\t\t});\n\t\t\t\ttt.forwardPointerEnter(ev);\n\t\t\t}, {once: true});\n\t\t} else {\n\t\t\tthis.pinned = false;\n\t\t\tthis.showTime = 0;\n\t\t}\n\t\tthis.frozen = false;\n\t}\n\n\tprotected _onDragStart(ev: DragEvent) {\n\t\tif (this.area instanceof SrcArea) {\n\t\t\tITEM.setShortDescTransferToDragSession({\n\t\t\t\treg: this.area.reg,\n\t\t\t\tinfoBroker: this.area.reg.env.infoBroker,\n\t\t\t\tshortDescs: [this.area.shortDesc],\n\t\t\t\temitter: this\n\t\t\t}, ev, 'build');\n\t\t}\n\t}\n\n\t/** Affichage du bouton close. */\n\tprotected onPointerOver(ev: PointerEvent) {\n\t\tif (!this._closeElt) {\n\t\t\tthis.addEventListener(\"pointerout\", this.onPointerOut);\n\t\t\tthis._closeElt = this.shadowRoot.appendChild(<ActionBtn id=\"close\" î={{\n\t\t\t\taction: closeAction,\n\t\t\t\tactionContext: this,\n\t\t\t\tuiContext: 'bar'\n\t\t\t} as OActionBtnInit<SrcTab>}/>);\n\t\t\tthis._closeElt.onpointerdown = (ev: Event) => {ev.stopPropagation()}//bloque le click et le drag du tab.\n\t\t} else {\n\t\t\tDOM.setHidden(this._closeElt, false);\n\t\t}\n\t}\n\n\t/** Masquage du bouton close. */\n\tprotected onPointerOut(ev: PointerEvent) {\n\t\tif (this._closeElt) DOM.setHidden(this._closeElt, true);\n\t}\n\n}\n\nREG.reg.registerSkin('wsp-src-tab', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-width: min-content !important;\n\t\tuser-select: none;\n\t\tcursor: pointer;\n\t}\n\n\t:host(.pinned) > div {\n\t\tbackground: url(\"/@skin@/wsp/views/itemViewerMulti/pin.svg\") no-repeat top 2px right;\n\t\tbackground-size: .7em;\n\t\tpadding-inline-end: .7em !important;\n\t}\n\n\t:host(.needValid) {\n\t\tfont-weight: bold;\n\t}\n\n\t:host(.needValid) > * > .label::after {\n\t\tfont-weight: bold;\n\t\tcontent: \"*\";\n\t\tcolor: var(--valid-color);\n\t}\n\n\t:host(:hover) {\n\t\tposition: relative;\n\t}\n\n\t:host([hidden]) {\n\t\tdisplay: none;\n\t}\n\n\t:host([disabled]) {\n\t\topacity: 0.2;\n\t\tpointer-events: none;\n\t}\n\n\tdiv {\n\t\tdisplay: flex;\n\t\talign-items: flex-start;\n\t\tjustify-content: center;\n\t}\n\n\t.icon {\n\t\theight: var(--icon-size);\n\t\twidth: var(--icon-size);\n\t\tmin-height: var(--icon-size);\n\t\tmin-width: var(--icon-size);\n\t\tbackground: var(--icon-color) var(--icon-img) no-repeat center / contain;\n\t\tmargin-inline-start: 0.3em;\n\t\tfilter: var(--filter);\n\t}\n\n\t.label {\n\t\tfont-size: var(--label-size);\n\t\tmin-width: 3em;\n\t\ttext-align: start;\n\t}\n\n\t:host(:hover) > * > .icon {\n\t\tfilter: var(--hover-filter);\n\t}\n\n\t:host(:active) > * > .icon {\n\t\tfilter: var(--actve-filter);\n\t}\n\n\t:host(:hover), :host(.willBeShown) {\n\t\tbackground: var(--pressed-bgcolor);\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--focus-outline);\n\t\toutline-offset: -2px;\n\t}\n\n\t:host(:active) > div {\n\t\tbackground: var(--pressed-bgcolor);\n\t}\n\n\t#close {\n\t\tposition: absolute;\n\t\tright: 0; /* FIX RTL */\n\t\tbackground: radial-gradient(var(--bgcolor), transparent);\n\t}\n`);\ncustomElements.define(\"wsp-src-tab\", SrcTab);\n\n\nREG.reg.addToList(\"actions:itemViewerMulti\", \"pin\", 1, new Action<SrcTab>(\"pin\")\n\t.setIcon((ctx: SrcTab) => ctx.pinned ? \"/@skin@/wsp/views/itemViewerMulti/unpin.svg\" : \"/@skin@/wsp/views/itemViewerMulti/pin.svg\")\n\t.setLabel((ctx: SrcTab) => ctx.pinned ? \"Libérer l'onglet\" : \"Figer l'onglet\")\n\t.setGroup(\"tab\")\n\t.setVisible((ctx: SrcTab) => !ctx.frozen)\n\t.setExecute((ctx: SrcTab, ev?: Event) => {\n\t\tctx.pinned = !ctx.pinned;\n\t}));\n\nconst closeAction = new Action<SrcTab>(\"close\")\n\t.setIcon(\"/@skin@/commons/icons/close.svg\")\n\t.setLabel(\"Fermer\")\n\t.setGroup(\"close\")\n\t.setVisible((ctx: SrcTab) => !ctx.frozen)\n\t.setExecute((ctx: SrcTab, ev?: Event) => {\n\t\tif (ev) ev.stopPropagation(); //en btn dns le tab, block le select.\n\t\tctx.parentViewCtn.closeTab(ctx);\n\t});\nREG.reg.addToList(\"actions:itemViewerMulti\", \"close\", 1, closeAction);\n\nREG.reg.addToList(\"actions:itemViewerMulti\", \"closeAll\", 1, new Action<SrcTab>(\"closeAll\")\n\t//.setIcon(\"/@skin@/commons/icons/close.svg\")\n\t.setLabel(\"Tout fermer\")\n\t.setGroup(\"close\")\n\t.setVisible((ctx: SrcTab) => !ctx.frozen)\n\t.setExecute((ctx: SrcTab, ev?: Event) => {\n\t\tif (ctx.pinned) {\n\t\t\t//Ferme tout, y compris pinned\n\t\t\tctx.parentViewCtn.visitTabsAsync(async (t: Tab): Promise<any | 'stop'> => {\n\t\t\t\tif (t instanceof SrcTab && !t.frozen) if (!await t.parentViewCtn.closeTab(t)) return 'stop';\n\t\t\t});\n\t\t} else {\n\t\t\t//Ferme les onglets non pinned.\n\t\t\tctx.parentViewCtn.visitTabsAsync(async (t: Tab): Promise<any | 'stop'> => {\n\t\t\t\tif (t instanceof SrcTab && !t.frozen && !t.pinned) if (!await t.parentViewCtn.closeTab(t)) return 'stop';\n\t\t\t});\n\t\t}\n\t}));\n\nREG.reg.addToList(\"actions:itemViewerMulti\", \"closeOthers\", 1, new Action<SrcTab>(\"closeOthers\")\n\t//.setIcon(\"/@skin@/commons/icons/close.svg\")\n\t.setLabel(\"Fermer les autres\")\n\t.setGroup(\"close\")\n\t.setVisible((ctx: SrcTab) => !ctx.frozen)\n\t.setExecute((ctx: SrcTab, ev?: Event) => {\n\t\tif (ctx.pinned) {\n\t\t\t//Ferme les autres, y compris pinned\n\t\t\tctx.parentViewCtn.visitTabsAsync(async (t: Tab): Promise<any | 'stop'> => {\n\t\t\t\tif (t !== ctx && t instanceof SrcTab && !t.frozen) if (!await t.parentViewCtn.closeTab(t)) return 'stop';\n\t\t\t});\n\t\t} else {\n\t\t\t//Ferme les autres onglets non pinned.\n\t\t\tctx.parentViewCtn.visitTabsAsync(async (t: Tab): Promise<any | 'stop'> => {\n\t\t\t\tif (t !== ctx && t instanceof SrcTab && !t.frozen && !t.pinned) if (!await t.parentViewCtn.closeTab(t)) return 'stop';\n\t\t\t});\n\t\t}\n\t}));\n\nclass OpenInTabs extends Action<SrcTab> {\n\t_id: 'left' | 'main' | 'right';\n\n\tconstructor(pos: 'left' | 'main' | 'right', label: string) {\n\t\tsuper(pos);\n\t\tthis._label = label;\n\t\tthis._group = 'tab';\n\t}\n\n\tisVisible(ctx: SrcTab): boolean {\n\t\treturn ctx.parentViewCtn.tabsPos !== this._id;\n\t}\n\n\texecute(ctx: SrcTab, ev?: Event): any | \"noPreventDefault\" {\n\t\tctx.parentViewCtn.areasContext.openSrcRefInTabs(this._id, SRC.srcRef((ctx.area as SrcArea).shortDesc));\n\t}\n}\n\nREG.reg.addToList(\"actions:itemViewerMulti\", \"openLeft\", 1, new OpenInTabs(\"left\", \"Répliquer à gauche\"));\nREG.reg.addToList(\"actions:itemViewerMulti\", \"openMain\", 1, new OpenInTabs(\"main\", \"Répliquer au centre\"));\nREG.reg.addToList(\"actions:itemViewerMulti\", \"openRight\", 1, new OpenInTabs(\"right\", \"Répliquer à droite\"));\n\n\n/**\n * Action d'affichage d'un src issue de l'histo dans un SrcTabs.\n */\nclass SrcOpenFromHisto extends Action<SrcTabs> implements ISrcMainCtx {\n\n\treg: IReg<IItemTypeUiEnv>;\n\tshortDesc: JSrcFields;\n\n\tprotected _subArea: IArea<ISrcMainCtx, SrcMain>;\n\n\tconstructor(itemViewer: ItemViewerMulti, shortDesc: JSrcFields) {\n\t\tsuper(null);\n\t\tthis.shortDesc = shortDesc;\n\t\tthis.reg = itemViewer.getRegItemType(shortDesc.itModel);\n\t\tthis._subArea = this.reg.env.itemType.getSrcMainArea(this);\n\t}\n\n\tgetLabel(ctx: SrcTabs): string {\n\t\treturn this._subArea.getLabel(this);\n\t}\n\n\tgetIcon(ctx: SrcTabs): string {\n\t\treturn this._subArea.getIcon(this);\n\t}\n\n\tgetDescription(ctx: SrcTabs): string {\n\t\treturn this._subArea.getDescription(this);\n\t}\n\n\tgetGroup(ctx: SrcTabs): string {\n\t\treturn this._subArea.getGroup(this);\n\t}\n\n\tisEnabled(ctx: SrcTabs): boolean {\n\t\treturn this._subArea.isEnabled(this);\n\t}\n\n\tisVisible(ctx: SrcTabs): boolean {\n\t\treturn this._subArea.isVisible(this);\n\t}\n\n\texecute(ctx: SrcTabs, ev?: Event): any | \"noPreventDefault\" {\n\t\tctx.addTab(new SrcArea(ctx.areasContext, this.shortDesc), {select: true});\n\t}\n}\n"]}