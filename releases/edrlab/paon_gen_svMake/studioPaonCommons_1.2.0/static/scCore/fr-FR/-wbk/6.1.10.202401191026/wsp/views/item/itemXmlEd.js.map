{"version":3,"sources":["/@back@/wsp/views/item/itemXmlEd.tsx"],"names":["BaseElementAsync","BASIS","Button","POPUP","ShowOutlineAction","ShowPreviewAction","WED","WedEditorBox","boxTagsDefined","txtTagsDefined","InlLink","isItemUiEnv","SrcDrawer","SRCDRAWER","ptrItemTagsDefined","sgnPatternFromTxtElement","TxtPtrItemBlock","TxtPtrItemInline","WspDataTransferWedAnalyzer","Action","EHttpStatusCode","RespError","REG","SEC","VIEWS","ViewsContainer","XA","InfoFocusItem","InfoFocusNodeInItem","InfoHighlighItemSgn","ITEM","SRC","WSP","EWspWorkingSt","EItemTypeFamily","DOM","JSX","InsertScComment","InfoBrokerBasic","WEDLET","SearchItemSgnRegexp","TxtSelMgr","ItemViewerSingle","HistoEditAction","isHistoEditEnv","ItemXmlEd","[object Object]","this","view","leaveState","onViewHidden","configs","saveOnClose","isDirty","save","wedMgr","killEditor","reg","env","place","closePlace","setState","buildWspRef","wspCd","srcRef","super","_refresh","docHolder","isAvailable","setReadOnly","house","lockedBy","hasPerm","_writePermToCheck","refreshEditMode","rootWedlet","writePerms","_saveAct","execute","init","style","display","findReg","launchEditor","buildInitFromAtts","hasAttribute","extractAttr","editorKey","editorConfig","JSON","parse","wedMgrConfig","confReg","originalEnv","universe","wspServer","wspsLive","newPlace","wsp","chain","Error","getWsp","waitForAvailable","srcRefInContext","longDesc","_a","itemType","getFamily","res","targetUri","getMainXmlSrcUri","isSrcId","fetchSrcId","newDocHolder","createSubRegMixed","createSubReg","fetchLongDesc","securityCtx","createSub","srcRoles","srcRi","Object","assign","fetchContentThreshold","metaBarMode","dataTransferAnalyzer","SINGLETON","dataEditor","datasEditor","getEditor","help","import","initHelpOnEditor","initReg","overrideConfigs","initItemReg","parentDatas","lastDatas","lastDatasKey","addAsyncLib","mainEndP","getWed","mainWed","loadWedModel","then","wed","wedModel","outlineWed","outlineEndP","outlineWedModel","previewWed","altviewEndP","previewWedModel","lockBtn","LockAction","readOnlyCauses","concat","datas","readOnly","push","noNotifIfReadOnly","hasSystemRights","isHistoryOrTrashUri","srcUri","showNotifInfo","showNotifForbidden","houseLstn","on","refresh","bind","srcFields","SaveAction","addToList","infoBroker","histoEditPointsMgr","histoEditMgr","histoEditHolder","EditHolder","act","viewXmlAction","registerSvc","WspTxtSelMgr","initialize","initFromDocHolder","appendChild","wspRef","r","closed","onEditorLooseFocus","config","closeEditor","visitor","options","Promise","resolve","undefined","customElements","define","itemEditor","setIcon","setLabel","button","state","e","classList","toggle","response","status","forbidden","writeRangeToClipboard","newRangeAround","wedAnchor","autoHide","catch","abortChangesAndReload","showNotifError","saving","ctx","uiContext","parent","buttonNode","installSkin","shadowRoot","isVisible","isEnabled","ev","registerSkin","setDescription","getLockedBy","lock","account","_hideLabel","tabIndexCustom","setExecute","showDialog","noCleanup","initHeight","initWidth","titleBar","barLabel","label","resizer","previewAndItemCodeAndTitleTpl","itemCodeAndTitleTpl","detailsOrTypesTpl","detailsPreviewOrTypesTpl","itemTitleOrCodeTpl","wedItemInlULink","_wedItemInlULinkInited","promiseTooltip","owner","tooltip","btnShow","icon","onclick","wedAttributes","subItemId","extractSubItemId","dispatchInfo","extractSrcRef","close","btnEdit","isWritableWedlet","async","FastFindItem","sgnPattern","subSgnPattern","ct","restrictions","source","subItemsFind","subItemSgnPattern","sd","showMenuFromEvent","initMaxHeight","onNextClose","isConnected","newBatch","setAttr","append","srcRefSub","doBatch","srcDrawer","skin","tpl","detailsItemIconPreviewTpl","addEventListener","setSrcRef","preventDefault","createElement","skinOver","hoverAllowed","anchor","posFrom","fromX","marginX","notAvailableSpace","targetX","ch","findFirstChild","n","wedlet","wedEditor","dispatchHighlight","getSvc","previewOrItemTitleOrCodeTpl","tplOver","newEditLinkBtn","initSrcRef","class","ptrItem","previousSibling","editAction","executeIfAvailable","wedItemInlObject","wedItemTxtObject","elt","annot","wedAnnotDiff","diffLib","WedDiffTxtObj","initDiffTxtObj","diffTxtObj","srcDiff","skAnnots","find","d","type","start","txtObjDepth","foreignPtrItem","txtObj","tag","otherValue","prepend","removeChild","length","addAnnotForMetas","removeAnnotForMetas","from","content","itTypesReducer","uiCtx","ItemCreator","itemReg","root","newDomDoc","createElementNS","SCCORE_NS","SCITEM_TAG","ownerDocument","importNode","openCreateItem","setDefaultConfigFromReg","body","Blob","ser","itemTypesTree","itemTypeReducer","spaceUri","extractSpaceUri","ItemEditInDialogInfoBroker","info","shortDesc","fetchShortDesc","uiRoot","wspMetaUi","getItemType","itModel","subReg","itemViewer","mainViewCode","î","views","initViewer","xpath","popup","findPopupableParent","currentEd","firstElementChild","remove","newPopup","handled","_root","_infoBroker","onBlur","_highlightForLink","_highlightSgn","onSelChange","_sel","focusNode","inlLink","findParent","_oldSel","commonAncestorContainer","sgn","assigned","path","struct","getStruct","itSgnPattern","other","targetAddr","addr"],"mappings":"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","sourcesContent":["import {BaseElementAsync, BASIS} from \"back/commons/basis\";\nimport {ActionBtn, Button} from \"back/commons/widgets/buttons\";\nimport {POPUP, PopupTooltip} from \"back/commons/widgets/popups\";\nimport {ShowOutlineAction} from \"back/edit/wed/features/outlineBar\";\nimport {ShowPreviewAction} from \"back/edit/wed/features/previewBar\";\nimport {WED} from \"back/edit/wed/wedCore\";\nimport {IWedEditor, OWedManagerConfig} from \"back/edit/wed/wedEditor\";\nimport {OWedEditorBoxConfig, WedEditorBox} from \"back/edit/wed/wedEditorBox\";\nimport {boxTagsDefined} from \"back/edit/wed/wedlets/box/boxTags\";\nimport {ITxtAnnotDiff, ITxtRefresh, TxtRoot, txtTagsDefined} from \"back/edit/wed/wedlets/txt/txt\";\nimport {InlLink, TxtElement, TxtObject} from \"back/edit/wed/wedlets/txt/txtTags\";\nimport {IItemUiEnv, isItemUiEnv} from \"back/wsp/views/itemMain\";\nimport {SrcDrawer, SRCDRAWER} from \"back/wsp/widgets/srcDrawer\";\nimport {ptrItemTagsDefined, sgnPatternFromTxtElement, TxtPtrItem, TxtPtrItemBlock, TxtPtrItemInline, WspDataTransferWedAnalyzer} from \"back/wsp/widgets/wed/ptrItem\";\nimport {Action, EButtonUiContext} from \"lib/commons/actions\";\nimport {EHttpStatusCode, RespError} from \"lib/commons/io/io\";\nimport {JLastDatas} from \"lib/commons/lastDatas\";\nimport {IReg, IUiEnv, REG} from 'lib/commons/registry';\nimport {SEC} from 'lib/commons/security';\nimport {IView, IViewContainer, OViewVisitOptions, VIEWS, ViewsContainer} from \"lib/commons/views\";\nimport {XA} from \"lib/commons/xml/xAddr\";\nimport {IChainEnv} from \"lib/wsp/chain\";\nimport {InfoFocusItem, InfoFocusNodeInItem, InfoHighlighItemSgn, ITEM} from \"lib/wsp/item\";\nimport {JSrcFields, SRC, srcRef} from \"lib/wsp/src\";\nimport {IWspEnv, IWspUiEnv, WSP, wspCd} from \"lib/wsp/wsp\";\nimport {EWspWorkingSt, IPlaceDocHolder, IWspsLivePlacePointer} from \"lib/wsp/wspsLive\";\nimport {EItemTypeFamily, IDatasEditor, IItemTypeUiEnv, ItemType} from \"lib/wsp/wspMetaUi\";\nimport {ItemCreator} from \"back/wsp/dialogs/itemCreator\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {InsertScComment} from \"back/edit/wed/wedlets/box/boxScComment\";\nimport {IInfo, IInfoBroker, IInfoBrokerPointer, IInfoProducer, InfoBrokerBasic} from \"lib/commons/infos\";\nimport {IPopupable} from \"back/commons/widgets/popupable\";\nimport {WEDLET} from \"back/edit/wed/wedlets/wedlet\";\nimport {FastFindItem} from \"back/wsp/dialogs/fastFindItem\";\nimport {SearchItemSgnRegexp} from \"lib/wsp/search\";\nimport {TxtSelMgr} from \"back/edit/wed/features/txtSel\";\nimport {IPtrItemRule} from \"back/wsp/widgets/wed/schemaMetaWsp\";\nimport \"back/wsp/widgets/wed/itemEditorExt\";\nimport \"back/wsp/widgets/wed/wspSearchBar\";\nimport {IDiffAnnotValue, ISkDiffAnnot} from \"lib/edit/schema/diff\";\nimport {IWedDiffTxtObjCustom, WedDiffTxtObj} from \"back/edit/wed/wedlets/diff/diffTags\";\nimport {ItemViewerSingle} from \"back/wsp/views/itemViewerSingle\";\nimport {HistoEditAction, HistoEditPoint, IHistoEditEnv, IHistoEditHolder, isHistoEditEnv} from \"lib/edit/histoEditPoints\";\n\n/**\n * View d'édition d'un (et d'un seul) item.\n *\n * Peut-être utilisé dans de nombreux contextes. Le registre environnant doit être au minimum de type IChainEnv,\n * un sous-registre sera instancié automatiquement pour compléter la configuration.\n *\n * Config attributes:\n * - wsp --> wspCd\n * - src-ref --> srcRef\n * - editor-key --> editorKey\n * - editor-config (json) --> editorConfig\n * - wedmgr-config (json) --> wedMgrConfig\n */\nexport interface OItemXmlEdInit {\n\treg?: IReg<IChainEnv & IUiEnv> | IReg<IWspUiEnv> | IReg<IItemTypeUiEnv> | IReg<IItemUiEnv>\n\twspCd?: wspCd\n\tsrcRef?: srcRef\n\teditorKey?: string\n\teditorConfig?: OWedEditorBoxConfig\n\twedMgrConfig?: OWedManagerConfig\n\twritePerms?: string | string[]\n\tdatasEditor?: IDatasEditor\n\tnoNotifIfReadOnly?: boolean\n\tinitItemReg?: (reg: IReg<IItemUiEnv>, itemEditor: ItemXmlEd) => void\n\tsaveOnClose?: boolean\n\t/** lastDatas pour l'initialisation (la key est construite auto: \"ed:\"+srcRef). */\n\tlastDatas?: JLastDatas\n}\n\nexport interface ItemXmlEd extends BaseElementAsync {\n\tinitialize(init: OItemXmlEdInit): this;\n}\n\nexport class ItemXmlEd extends BaseElementAsync implements IView, IViewContainer {\n\n\t/**\n\t * L'env de l'éditeur doit être de niveau IItemUiEnv en particulier pour le securityCtx\n\t * et l'eval des perms qui pourraient être réalisées dans le wed.\n\t */\n\treg: IReg<IItemUiEnv>;\n\n\tconfigs: OItemXmlEdInit;\n\n\tview: WedEditorBox;\n\n\tprotected _saveAct: SaveAction;\n\n\tisClosed(): boolean {return !this.view}\n\n\t/**\n\t * @param leaveState Si la place est partagée (non instanciée dans l'itemEditor),\n\t *    passe l'item édité à l'état leaveState (généralement r(ead) ou l(isten)).\n\t */\n\tcloseEditor(leaveState?: EWspWorkingSt) {\n\t\tif (!this.view) return;\n\t\tVIEWS.onViewHidden(this.view, true);\n\t\tif (this.configs.saveOnClose && this.isDirty()) this.save();\n\t\tthis.view.wedMgr.killEditor();\n\t\tif ((this.configs.reg.env as IWspsLivePlacePointer).place !== this.reg.env.place) {\n\t\t\t//On a créé notre place en interne.\n\t\t\tthis.reg.env.place.closePlace();\n\t\t\tthis.reg.env.place = null;\n\t\t} else {\n\t\t\t//place partagée.\n\t\t\tif (leaveState != null) this.reg.env.place.setState(WSP.buildWspRef(this.configs.wspCd, this.configs.srcRef), leaveState);\n\t\t}\n\t\tthis.view = null;\n\t}\n\n\t_refresh() {\n\t\tsuper._refresh();\n\t\tif (this.view) {\n\t\t\tconst wedMgr = this.view.wedMgr;\n\t\t\tconst docHolder = wedMgr.docHolder as IPlaceDocHolder;\n\t\t\tif (docHolder.isAvailable) {\n\t\t\t\tif (!wedMgr.setReadOnly('locked', docHolder.house.lockedBy != null, 'perms', !this.reg.hasPerm(this._writePermToCheck()))) {\n\t\t\t\t\t//Le Refresh peut être dû à un chgt de roles qui peuvent avoir un impact uniquement au sein de l'éditeur\n\t\t\t\t\tWEDLET.refreshEditMode(wedMgr.rootWedlet);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected _writePermToCheck() {\n\t\treturn this.configs.writePerms || \"action.itemXmlEd#edit\";\n\t}\n\n\tisDirty(): boolean {\n\t\treturn this.view ? this.view.wedMgr.docHolder.house.isDirty : false;\n\t}\n\n\tasync save(): Promise<void> {\n\t\treturn this._saveAct.execute(this.view);\n\t}\n\n\tprotected _initialize(init: OItemXmlEdInit): Promise<void> {\n\t\tthis.style.display = \"contents\";\n\t\tthis.configs = init || {};\n\t\tif (!this.configs.reg) this.configs.reg = this.findReg(init);\n\t\treturn this.launchEditor();\n\t}\n\n\tbuildInitFromAtts(init: OItemXmlEdInit): OItemXmlEdInit {\n\t\tinit = super.buildInitFromAtts(init);\n\t\tif (this.hasAttribute('wsp')) init.wspCd = BASIS.extractAttr(this, 'wsp');\n\t\tif (this.hasAttribute('src-ref')) init.srcRef = BASIS.extractAttr(this, 'src-ref');\n\t\tif (this.hasAttribute('editor-key')) init.editorKey = BASIS.extractAttr(this, 'editor-key');\n\t\tif (this.hasAttribute('editor-config')) init.editorConfig = JSON.parse(BASIS.extractAttr(this, 'editor-config'));\n\t\tif (this.hasAttribute('wedmgr-config')) init.wedMgrConfig = JSON.parse(BASIS.extractAttr(this, 'wedmgr-config'));\n\t\treturn init;\n\t}\n\n\tprotected async launchEditor(): Promise<void> {\n\t\tlet confReg = this.configs.reg as IReg<IItemUiEnv>; //On va compléter confReg pour obtenir un IReg<IItemUiEnv>\n\t\tconst originalEnv = confReg.env as IItemUiEnv;\n\n\t\tconst place = originalEnv.place || originalEnv.universe.wspServer.wspsLive.newPlace();\n\n\t\tlet wsp = originalEnv.wsp;\n\t\tif (!wsp) {\n\t\t\tconst chain = originalEnv.universe;\n\t\t\tif (!chain || !this.configs.wspCd) throw Error(\"Universe or wspCd not found\");\n\t\t\twsp = await place.getWsp(this.configs.wspCd).waitForAvailable(this);\n\t\t} else if (!wsp.isAvailable) {\n\t\t\tawait wsp.waitForAvailable(this);\n\t\t}\n\n\t\tlet srcRef: srcRef = this.configs.srcRef;\n\t\tif (!srcRef) {\n\t\t\tsrcRef = ITEM.srcRefInContext(originalEnv.longDesc);\n\t\t\tif (originalEnv.itemType?.getFamily() === EItemTypeFamily.res) {\n\t\t\t\t//Edition des metas d'un item.\n\t\t\t\tlet targetUri = originalEnv.itemType.getMainXmlSrcUri(originalEnv.longDesc);\n\t\t\t\tif (SRC.isSrcId(srcRef)) {\n\t\t\t\t\t//On est en contexte db hors cas spéciaux (cf srcRefInContext), on tente de récupérer l'id\n\t\t\t\t\tsrcRef = (await WSP.fetchSrcId(originalEnv.wsp, this, targetUri, true)) || targetUri;\n\t\t\t\t} else {\n\t\t\t\t\tsrcRef = targetUri;\n\t\t\t\t}\n\t\t\t\t//console.log(\":::srcRef::::\", srcRef);\n\t\t\t}\n\t\t}\n\n\t\tconst docHolder = await place.newDocHolder(wsp, srcRef);\n\t\tif (!docHolder) throw Error(\"Source not found\");\n\n\t\tconst itemType = originalEnv.itemType || docHolder.house.itemType;\n\n\t\tif (confReg.env.wsp !== wsp) confReg = REG.createSubRegMixed(confReg, wsp.reg);\n\t\tif (confReg.env.itemType !== itemType) confReg = REG.createSubRegMixed(confReg, itemType.reg);\n\n\t\t//Reg final de niveau IItemUiEnv\n\t\tthis.reg = REG.createSubReg(confReg);\n\t\tthis.reg.env.place = place;\n\t\tif (!this.reg.env.longDesc) {\n\t\t\tconst longDesc = this.reg.env.longDesc = await wsp.fetchLongDesc(srcRef);\n\t\t\tthis.reg.env.securityCtx = SEC.createSub(wsp.reg.env.securityCtx, longDesc.srcRoles, longDesc.srcRi, longDesc);\n\t\t}\n\n\t\tconst editorConfig = Object.assign({}, this.configs.editorConfig) as OWedEditorBoxConfig;\n\t\tconst wedMgrConfig = Object.assign({}, this.configs.wedMgrConfig) as OWedManagerConfig;\n\n\t\tif (!wedMgrConfig.fetchContentThreshold) wedMgrConfig.fetchContentThreshold = 6000;\n\n\t\tif (!editorConfig.metaBarMode) editorConfig.metaBarMode = 'available';\n\n\t\tif (!wedMgrConfig.dataTransferAnalyzer) wedMgrConfig.dataTransferAnalyzer = WspDataTransferWedAnalyzer.SINGLETON;\n\n\t\tconst dataEditor = this.configs.datasEditor || itemType.getEditor(this.configs.editorKey);\n\t\tif (!dataEditor) throw Error(\"No editor found: \" + this.configs.editorKey);\n\n\t\tthis.view = new WedEditorBox();\n\n\t\tif (dataEditor.help) (await import(\"back/edit/wed/features/helpBar.js\")).initHelpOnEditor(dataEditor.help, this.reg, editorConfig, wedMgrConfig, this.view)\n\n\t\tif (dataEditor.initReg) await dataEditor.initReg(this.reg, this.view);\n\t\tif (dataEditor.overrideConfigs) await dataEditor.overrideConfigs(editorConfig, wedMgrConfig, this.view);\n\t\tif (this.configs.initItemReg) this.configs.initItemReg(this.reg, this);\n\n\t\teditorConfig.reg = this.reg;\n\t\tconst parentDatas = this.configs.lastDatas;\n\t\teditorConfig.lastDatasKey = \"ed:\" + srcRef;\n\t\tconst lastDatas = parentDatas && parentDatas[editorConfig.lastDatasKey];\n\t\tif (lastDatas) {\n\t\t\teditorConfig.lastDatas = lastDatas;\n\t\t\tparentDatas[editorConfig.lastDatasKey] = null; //on tue les lastDatas de cet éditeur en cas d'une fermeture et d'une réouverture dans cette session.\n\t\t}\n\n\t\t//chargement asynchrone en // des librairies standard wed et des wedModels\n\t\tthis.view.addAsyncLib(boxTagsDefined);\n\t\tthis.view.addAsyncLib(txtTagsDefined);\n\t\tthis.view.addAsyncLib(ptrItemTagsDefined);\n\t\tconst mainEndP = itemType.getWed(dataEditor.mainWed);\n\t\tthis.view.addAsyncLib(WED.loadWedModel(mainEndP, mainEndP).then((wed) => this.view.wedModel = wed));\n\t\tif (dataEditor.outlineWed) {\n\t\t\tconst outlineEndP = itemType.getWed(dataEditor.outlineWed);\n\t\t\tthis.view.addAsyncLib(WED.loadWedModel(outlineEndP, outlineEndP).then((wed) => this.view.outlineWedModel = wed));\n\t\t}\n\t\tif (dataEditor.previewWed) {\n\t\t\tconst altviewEndP = itemType.getWed(dataEditor.previewWed);\n\t\t\tthis.view.addAsyncLib(WED.loadWedModel(altviewEndP, altviewEndP).then((wed) => this.view.previewWedModel = wed));\n\t\t}\n\n\t\t//Gestion graphique du lock et de l'absence de droit en écriture\n\t\tconst lockBtn = new LockAction();\n\n\t\twedMgrConfig.readOnlyCauses = wedMgrConfig.readOnlyCauses ? wedMgrConfig.readOnlyCauses.concat() : [];\n\t\tif (itemType.datas.readOnly) wedMgrConfig.readOnlyCauses.push(\"itemType\");\n\t\tif (docHolder.house.lockedBy) wedMgrConfig.readOnlyCauses.push(\"locked\");\n\t\telse if (!this.reg.hasPerm(this._writePermToCheck())) {\n\t\t\tif (!this.configs.noNotifIfReadOnly) {\n\t\t\t\tif (!this.reg.hasSystemRights(this._writePermToCheck())) {\n\t\t\t\t\tif (!ITEM.isHistoryOrTrashUri(this.reg.env.longDesc.srcUri)) {\n\t\t\t\t\t\tPOPUP.showNotifInfo(\"Ce contenu n'est pas éditable.\", this);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tPOPUP.showNotifForbidden(\"Vous ne disposez pas des droits pour modifier ce contenu.\", this);\n\t\t\t\t}\n\t\t\t}\n\t\t\twedMgrConfig.readOnlyCauses.push(\"perms\");\n\t\t}\n\t\tdocHolder.houseLstn.on(\"onLock\", this.refresh.bind(this));\n\t\tdocHolder.houseLstn.on(\"onPermChange\", (house) => {\n\t\t\tthis.reg.env.securityCtx = SEC.createSub(wsp.reg.env.securityCtx, house.srcFields.srcRoles, house.srcFields.srcRi, house.srcFields);\n\t\t\tthis.refresh();\n\t\t});\n\n\t\tthis._saveAct = new SaveAction(this, docHolder);\n\t\tthis.reg.addToList(\"actions:wed:commonbar:start\", \"save\", 1, this._saveAct, 0);\n\t\tthis.reg.addToList(\"actions:wed:commonbar:start\", \"lock\", 1, lockBtn);\n\n\t\tif (isHistoEditEnv(originalEnv) && originalEnv.infoBroker) {\n\t\t\twedMgrConfig.histoEditPointsMgr = originalEnv.histoEditMgr;\n\t\t\twedMgrConfig.histoEditHolder = new EditHolder(SRC.srcRef(this.reg.env.longDesc), originalEnv.infoBroker);\n\t\t\tconst act = new HistoEditAction(originalEnv.histoEditMgr);\n\t\t\tthis.reg.addToList(\"actions:wed:commonbar:start\", \"histoEdit\", 1, act, 55);\n\t\t\tthis.reg.addToList(\"accelKeys:wed:global\", \"q-accel-shift\", 1, act);\n\t\t}\n\n\t\tthis.reg.addToList(\"accelKeys:wed:global\", \"s-accel\", 1, this._saveAct);\n\t\tthis.reg.addToList(\"accelKeys:wed:global\", \"i-accel-alt-shift\", 1, viewXmlAction);\n\n\n\t\tthis.reg.addToList(\"actions:wed:commonbar:end\", \"outline\", 1, new ShowOutlineAction(), 51);\n\t\tthis.reg.addToList(\"actions:wed:commonbar:end\", \"preview\", 1, new ShowPreviewAction(), 61);\n\t\t//this.reg.addToList(\"actions:wed:commonbar:end\", \"metaBar\", 1, new ShowMetaBarAction());\n\n\t\tthis.reg.registerSvc(\"wedTxtSelMgrClass\", 1, WspTxtSelMgr);\n\n\t\tthis.view.initialize(editorConfig);\n\t\tif (await this.view.initFromDocHolder(docHolder, wedMgrConfig)) {\n\t\t\tthis.appendChild(this.view);\n\t\t\tplace.setState(docHolder.house.wspRef, EWspWorkingSt.r); //Toujours visible.\n\t\t} else {\n\t\t\tthis.view = null;\n\t\t\tthis._saveAct = null;\n\t\t\tthrow Error(\"Init editor failed\");\n\t\t}\n\t}\n\n\tonViewHidden(closed?: boolean) {\n\t\tif (this.view && this.reg) (this.reg.env as IHistoEditEnv).histoEditMgr?.onEditorLooseFocus(this.view.wedMgr.config.histoEditHolder);\n\t\tif (closed) this.closeEditor();\n\t\telse VIEWS.onViewHidden(this.view, closed);\n\t}\n\n\tvisitViews(visitor: (view: IView) => any): any {\n\t\tif (this.view) return visitor(this.view);\n\t}\n\n\tvisitViewsAsync(visitor: (view: IView) => Promise<any>, options?: OViewVisitOptions): Promise<any> {\n\t\treturn this.view ? visitor(this.view) : Promise.resolve(undefined);\n\t}\n\n}\n\ncustomElements.define(\"wsp-item-xmled\", ItemXmlEd);\n\n\nclass SaveAction extends Action<IWedEditor> {\n\n\tsaving: boolean;\n\n\tbutton: ActionBtn<IWedEditor>;\n\n\tconstructor(readonly itemEditor: ItemXmlEd, docHolder: IPlaceDocHolder) {\n\t\tsuper('save');\n\t\tthis.setIcon(\"/@skin@/edit/wed/save.svg\");\n\t\tthis.setLabel(\"Enregistrer\");\n\t\tdocHolder.houseLstn.on('dirtyChange', () => {if (this.button) this.button.refresh()});\n\t\tdocHolder.houseLstn.on('onSave', (state: 'saving' | 'saved' | 'saveFailed', e?: any): void | Promise<void> => {\n\t\t\tif (!this.button) return;\n\t\t\tthis.button.classList.toggle('saving', state === 'saving');\n\t\t\tif (state === 'saveFailed') {\n\t\t\t\tif (e instanceof RespError && e.response.status === EHttpStatusCode.forbidden) {\n\t\t\t\t\tconst wedMgr = itemEditor.view.wedMgr;\n\t\t\t\t\twedMgr.writeRangeToClipboard(XA.newRangeAround(wedMgr.rootWedlet.wedAnchor)).then(() => {\n\t\t\t\t\t\tPOPUP.showNotifForbidden(\"Vous ne disposez plus des droits en édition, vos modifications annulées ont été copiées dans le presse-papier.\", itemEditor, {autoHide: 20000});\n\t\t\t\t\t}).catch(() => {\n\t\t\t\t\t\tPOPUP.showNotifForbidden(\"Vous ne disposez plus des droits en édition, vos modifications ont dû être annulées.\", itemEditor, {autoHide: 20000});\n\t\t\t\t\t});\n\t\t\t\t\treturn docHolder.place.abortChangesAndReload(docHolder.house);\n\t\t\t\t} else {\n\t\t\t\t\tPOPUP.showNotifError(\"Échec à l'enregistrement, connexion au serveur impossible. Attention, vous risquez de perdre vos modifications.\", itemEditor);\n\t\t\t\t}\n\t\t\t\tthis.saving = false; //pour que le refresh du bouton prenne en compte l'état dirty dû à l'échec cf isEnabled(ctx: IWedEditor)\n\t\t\t}\n\t\t})\n\t}\n\n\t/** Pas de bouton save pour les sous-editeurs. */\n\tbuildCustomButton(ctx: IWedEditor, uiContext: EButtonUiContext, parent?: Element): Element | null | undefined {\n\t\treturn this.button ? null : undefined;\n\t}\n\n\tinitButtonNode(buttonNode: ActionBtn<IWedEditor>, ctx: IWedEditor) {\n\t\tthis.button = buttonNode;\n\t\tthis.itemEditor.reg.installSkin(\"wsp-item-xmled/saveBtn\", buttonNode.shadowRoot);\n\t}\n\n\tisVisible(ctx: IWedEditor): boolean {\n\t\tif (ctx.wedMgr.readOnly) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tisEnabled(ctx: IWedEditor): boolean {\n\t\tif (this.saving) return false;\n\t\treturn super.isEnabled(ctx) && ctx.wedMgr.docHolder.house.isDirty;\n\t}\n\n\tasync execute(ctx: IWedEditor, ev?: Event) {\n\t\tconst docHolder = ctx.wedMgr.docHolder as IPlaceDocHolder;\n\t\tif (!docHolder.save) return; //Pas un IPlaceDocHolder : cas d'un DocHolder local détaché de l'item : metas en création => abandon ddu ctrl+S.\n\t\ttry {\n\t\t\tthis.saving = true;\n\t\t\tawait docHolder.save();\n\t\t} finally {\n\t\t\tthis.saving = false;\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin(\"wsp-item-xmled/saveBtn\", 1, /* language=CSS */ `\n\t:host(.saving) {\n\t\t--icon-color: red;\n\t}\n`);\n\n\nclass LockAction extends Action<IWedEditor> {\n\n\tconstructor() {\n\t\tsuper('lock');\n\t\tthis.setIcon(\"/@skin@/wsp/widgets/itemEditor/editing.svg\");\n\t\tthis.setDescription(\"Ce contenu n'est pas éditable car il est actuellement en cours d'édition.\");\n\t}\n\n\tisVisible(ctx: IWedEditor): boolean {\n\t\treturn this.getLockedBy(ctx) != null;\n\t}\n\n\tgetLabel(ctx: IWedEditor) {\n\t\tconst lock = this.getLockedBy(ctx);\n\t\treturn lock ? \"Édité par \" + lock.account : null;\n\t}\n\n\tinitButtonNode(buttonNode: ActionBtn<IWedEditor>, ctx: IWedEditor) {\n\t\tbuttonNode._hideLabel = false;\n\t\tbuttonNode.tabIndexCustom = -2;\n\t}\n\n\tgetLockedBy(ctx: IWedEditor) {\n\t\treturn (ctx.wedMgr.docHolder as IPlaceDocHolder).house.lockedBy;\n\t}\n}\n\nconst viewXmlAction = new Action<IWedEditor>()\n\t.setExecute(\n\t\t(ctx: IWedEditor, ev?: Event): any => {\n\t\t\tPOPUP.showDialog(\n\t\t\t\tnew ItemXmlEd().initialize({\n\t\t\t\t\treg: ctx.reg as IReg<IItemUiEnv>,\n\t\t\t\t\tdatasEditor: {mainWed: \"rawXml\"},\n\t\t\t\t\twedMgrConfig: {\n\t\t\t\t\t\t//readOnlyCauses: [\"rawXml\"],\n\t\t\t\t\t\tnoCleanup: true\n\t\t\t\t\t},\n\t\t\t\t\tnoNotifIfReadOnly: true\n\t\t\t\t}), ctx, {initHeight: \"90%\", initWidth: \"90%\", titleBar: {barLabel: {label: \"Source XML\"}}, resizer: {}});\n\t\t});\n\nREG.reg.addToList(\"actions:wed:box\", \"scComment\", 1, new InsertScComment(\"scComment\"));\n\nREG.reg.registerSvc(\"wedItemBlock\", 1, SRCDRAWER.previewAndItemCodeAndTitleTpl);\nREG.reg.registerSvc(\"wedItemBlockCompact\", 1, SRCDRAWER.itemCodeAndTitleTpl);\nREG.reg.registerSvc(\"wedItemBlockOver\", 1, SRCDRAWER.detailsOrTypesTpl);\nREG.reg.registerSvc(\"wedItemBlockOverCompact\", 1, SRCDRAWER.detailsPreviewOrTypesTpl);\nREG.reg.registerSvc(\"wedItemInline\", 1, SRCDRAWER.itemTitleOrCodeTpl);\nREG.reg.registerSvc(\"wedItemInlineOver\", 1, SRCDRAWER.detailsPreviewOrTypesTpl);\n\nREG.reg.registerSvc(\"wedItemInlULink\", 1, function wedItemInlULink(this: TxtElement) {\n\tif (!(this as any)._wedItemInlULinkInited) {\n\t\t(this as any)._wedItemInlULinkInited = true;\n\t\tPOPUP.promiseTooltip(this, (owner: HTMLElement, tooltip: PopupTooltip): IView | null => {\n\t\t\t\tconst reg = this.wedMgr.reg;\n\t\t\t\tconst infoBroker = reg.env.infoBroker;\n\n\t\t\t\tconst btnShow = infoBroker ? new Button().initialize({reg, label: \"Afficher l'item lié\", icon: \"/@skin@/wsp/actions/showItem.svg\", uiContext: \"dialog\"}) : undefined;\n\t\t\t\tif (btnShow) btnShow.onclick = () => {\n\t\t\t\t\tconst srcRef = this.wedAttributes[\"sc:refUri\"] as srcRef;\n\t\t\t\t\tif (srcRef) {\n\t\t\t\t\t\tconst subItemId = ITEM.extractSubItemId(srcRef);\n\t\t\t\t\t\tif (subItemId) {\n\t\t\t\t\t\t\tinfoBroker.dispatchInfo(new InfoFocusNodeInItem(`//*[@xml:id='${subItemId}']`, ITEM.extractSrcRef(srcRef, subItemId)), this);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tinfoBroker.dispatchInfo(new InfoFocusItem(srcRef), this);\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttooltip.close();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst btnEdit = WEDLET.isWritableWedlet(this) ? new Button().initialize({reg, label: \"Changer d'item lié\", icon: \"/@skin@/wsp/actions/fastFind.svg\", uiContext: \"dialog\"}) : undefined;\n\t\t\t\tif (btnEdit) btnEdit.onclick = async (ev: MouseEvent) => {\n\t\t\t\t\ttooltip.close();\n\t\t\t\t\t//Chargement asynch du fastFind\n\t\t\t\t\tconst {FastFindItem} = await import(\"back/wsp/dialogs/fastFindItem.js\");\n\t\t\t\t\tconst sgnPattern = sgnPatternFromTxtElement(this);\n\t\t\t\t\tconst subSgnPattern = sgnPatternFromTxtElement(this, true);\n\t\t\t\t\tconst ct = new FastFindItem().initialize({\n\t\t\t\t\t\treg,\n\t\t\t\t\t\trestrictions: sgnPattern ? new SearchItemSgnRegexp(sgnPattern.source) : null,\n\t\t\t\t\t\tsubItemsFind: subSgnPattern ? {subItemSgnPattern: subSgnPattern} : undefined\n\t\t\t\t\t});\n\t\t\t\t\tconst sd = await POPUP.showMenuFromEvent<JSrcFields | null>(ct, ev, this, null, {initMaxHeight: '50vh'}).onNextClose();\n\t\t\t\t\tif (sd && this.isConnected) {\n\t\t\t\t\t\tthis.wedMgr.docHolder.newBatch().setAttr(XA.append(this.wedAnchor, \"sc:refUri\"), ITEM.srcRefSub(sd)).doBatch();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst srcDrawer = new SrcDrawer().initialize({reg, skin: 'wsp-src-drawer/tooltip', tpl: SRCDRAWER.detailsItemIconPreviewTpl});\n\t\t\t\ttooltip.addEventListener('c-show', (ev: CustomEvent) => {\n\t\t\t\t\tconst srcRef = this.wedAttributes[\"sc:refUri\"] as srcRef;\n\t\t\t\t\tif (srcRef) srcDrawer.setSrcRef(srcRef, null);//Pas de listener, on force le rechargement du srcRef\n\t\t\t\t\telse ev.preventDefault();\n\t\t\t\t});\n\t\t\t\treturn <div>{btnShow}{btnEdit}{srcDrawer}</div>;\n\t\t\t},\n\t\t\t{skinOver: 'wsp-src-drawer/tooltip', hoverAllowed: true, anchor: {posFrom: this, fromX: 'end', marginX: -1, notAvailableSpace: {posFrom: this, fromX: 'start', targetX: 'end', marginX: 1}}}\n\t\t);\n\t}\n} as ITxtRefresh);\n\nREG.reg.registerSvc(\"wedItemInlImg\", 1, function wedItemInlULink(this: TxtElement) {\n\tlet ch = DOM.findFirstChild(this, (n): n is TxtPtrItemInline => n instanceof TxtPtrItemInline);\n\tif (!ch) {\n\t\tconst reg = REG.findReg<IWspUiEnv>(this.wedlet.wedMgr.wedEditor);\n\t\tch = this.appendChild(new TxtPtrItemInline().initialize({\n\t\t\treg: reg,\n\t\t\tplace: reg.env.place,\n\t\t\tdispatchHighlight: true,\n\t\t\ttpl: reg.getSvc(\"wedItemInlImgTpl\") || SRCDRAWER.previewOrItemTitleOrCodeTpl,\n\t\t\ttplOver: reg.getSvc(\"wedItemInlImgTplOver\", SRCDRAWER.detailsOrTypesTpl)\n\t\t}));\n\t\tthis.appendChild(newEditLinkBtn());\n\t}\n\t(ch as TxtPtrItem).initSrcRef(this.wedAttributes[\"sc:refUri\"]);\n} as ITxtRefresh);\n\nfunction newEditLinkBtn() {\n\treturn <span class=\"editLnk\" onclick={function (this: HTMLSpanElement, ev: MouseEvent) {\n\t\tconst ptrItem = this.previousSibling as TxtPtrItemInline;\n\t\tptrItem?.editAction?.executeIfAvailable(ptrItem, ev)\n\t}}/>;\n}\n\nREG.reg.registerSvc(\"wedItemInlObject\", 1, function wedItemInlObject(this: TxtElement) {\n\tlet ch = DOM.findFirstChild(this, (n): n is TxtPtrItemInline => n instanceof TxtPtrItemInline);\n\tif (!ch) {\n\t\tconst reg = REG.findReg<IWspUiEnv>(this.wedlet.wedMgr.wedEditor);\n\t\tch = this.appendChild(new TxtPtrItemInline().initialize({\n\t\t\treg: reg,\n\t\t\tplace: reg.env.place,\n\t\t\tdispatchHighlight: true,\n\t\t\ttpl: reg.getSvc(\"wedItemInlObjectTpl\") || SRCDRAWER.itemTitleOrCodeTpl,\n\t\t\ttplOver: reg.getSvc(\"wedItemInlObjectTplOver\", SRCDRAWER.detailsPreviewOrTypesTpl)\n\t\t}));\n\t\tthis.appendChild(newEditLinkBtn());\n\t}\n\t(ch as TxtPtrItem).initSrcRef(this.wedAttributes[\"sc:refUri\"]);\n} as ITxtRefresh);\n\nREG.reg.registerSvc(\"wedItemTxtObject\", 1, function wedItemTxtObject(this: TxtElement) {\n\tlet ch = DOM.findFirstChild(this, (n): n is TxtPtrItemBlock => n instanceof TxtPtrItemBlock);\n\tif (!ch) {\n\t\tconst reg = REG.findReg<IWspUiEnv>(this.wedlet.wedMgr.wedEditor);\n\t\tch = this.appendChild(new TxtPtrItemBlock().initialize({\n\t\t\treg: reg,\n\t\t\tplace: reg.env.place,\n\t\t\tdispatchHighlight: true,\n\t\t\ttpl: reg.getSvc(\"wedItemTxtObjectTpl\") || SRCDRAWER.previewAndItemCodeAndTitleTpl,\n\t\t\ttplOver: reg.getSvc(\"wedItemTxtObjectTplOver\", SRCDRAWER.detailsOrTypesTpl)\n\t\t}));\n\t\tthis.appendChild(newEditLinkBtn());\n\t}\n\tch.initSrcRef(this.wedAttributes[\"sc:refUri\"]);\n} as ITxtRefresh);\n\nREG.reg.registerSvc(\"wedItemTxtObjectDiff\", 1, {\n\taddDiff(elt: TxtObject, annot: ISkDiffAnnot) {\n\t\t//console.log(\"wedItemTxtObjectDiff:::addDiff::\", annot);\n\t\tif (!elt.wedAnnotDiff) new WEDLET.diffLib.WedDiffTxtObj().initDiffTxtObj(elt, annot, {\n\t\t\tredrawDiff(diffTxtObj: ItemWedDiffTxtObj) {\n\t\t\t\t//Refresh du widget de diff\n\t\t\t\tconst srcDiff = diffTxtObj.skAnnots.find((d) => d.type === \"diffValue\" && d.start[diffTxtObj.txtObjDepth] === \"sc:refUri\") as IDiffAnnotValue;\n\t\t\t\tif (srcDiff) {\n\t\t\t\t\t//On a une modif de la src de l'item\n\t\t\t\t\tif (!diffTxtObj.foreignPtrItem) {\n\t\t\t\t\t\tconst reg = diffTxtObj.txtObj.wedMgr.reg;\n\t\t\t\t\t\tconst tag = new TxtPtrItemBlock().initialize({\n\t\t\t\t\t\t\treg: reg,\n\t\t\t\t\t\t\tplace: reg.env.place,\n\t\t\t\t\t\t\tdispatchHighlight: true,\n\t\t\t\t\t\t\ttpl: reg.getSvc(\"wedItemTxtObjectTpl\") || SRCDRAWER.previewAndItemCodeAndTitleTpl,\n\t\t\t\t\t\t\ttplOver: reg.getSvc(\"wedItemTxtObjectTplOver\", SRCDRAWER.detailsOrTypesTpl)\n\t\t\t\t\t\t});\n\t\t\t\t\t\ttag.initSrcRef(srcDiff.otherValue);\n\t\t\t\t\t\tdiffTxtObj.foreignPtrItem = <div style=\"background-color:var(--edit-diff-bgcolor)\">{tag}</div>;\n\t\t\t\t\t\tdiffTxtObj.txtObj.prepend(diffTxtObj.foreignPtrItem);\n\t\t\t\t\t}\n\t\t\t\t} else if (diffTxtObj.foreignPtrItem) {\n\t\t\t\t\t//Pas de modif de la src, on clean on avait un widget\n\t\t\t\t\tdiffTxtObj.txtObj.removeChild(diffTxtObj.foreignPtrItem);\n\t\t\t\t\tdiffTxtObj.foreignPtrItem = null;\n\t\t\t\t}\n\t\t\t\t//Si au moins une diff dans les metas, on ajoute une class diffInMeta\n\t\t\t\tdiffTxtObj.txtObj.classList.toggle(\"diffInMeta\", diffTxtObj.skAnnots.length > (srcDiff ? 1 : 0));\n\t\t\t}\n\t\t} as IWedDiffTxtObjCustom);\n\t\telse elt.wedAnnotDiff.addAnnotForMetas(annot);\n\t},\n\tremoveDiff(elt: TxtObject, annot: ISkDiffAnnot) {\n\t\t//console.log(\"wedItemTxtObjectDiff:::removeDiff::\", annot);\n\t\tif (elt.wedAnnotDiff) elt.wedAnnotDiff.removeAnnotForMetas(annot);\n\t}\n} as ITxtAnnotDiff);\n\ninterface ItemWedDiffTxtObj extends WedDiffTxtObj {\n\tforeignPtrItem: HTMLElement\n}\n\n\nREG.reg.registerSvc(\"wedItemTxtEmptyDiff\", 1, {\n\taddDiff(elt: TxtObject, annot: ISkDiffAnnot) {\n\t\t//console.log(\"wedItemTxtObjectDiff:::addDiff::\", annot);\n\t\tif (!elt.wedAnnotDiff) new WEDLET.diffLib.WedDiffTxtObj().initDiffTxtObj(elt, annot, {\n\t\t\tredrawDiff(diffTxtObj: ItemWedDiffTxtObj) {\n\t\t\t\tdiffTxtObj.txtObj.classList.toggle(\"diffInMeta\", diffTxtObj.skAnnots.length > 0);\n\t\t\t}\n\t\t} as IWedDiffTxtObjCustom);\n\t\telse elt.wedAnnotDiff.addAnnotForMetas(annot);\n\t},\n\tremoveDiff(elt: TxtObject, annot: ISkDiffAnnot) {\n\t\t//console.log(\"wedItemTxtObjectDiff:::removeDiff::\", annot);\n\t\tif (elt.wedAnnotDiff) elt.wedAnnotDiff.removeAnnotForMetas(annot);\n\t}\n} as ITxtAnnotDiff);\n\n/** Service d'externalisation d'un contenu vers un item. */\nREG.reg.registerSvc<(from: IReg<IWspEnv>, content: Element, itTypesReducer: (acc: ItemType[], cur: ItemType, idx?: number, src?: ItemType[]) => ItemType[], uiCtx?: HTMLElement) => Promise<JSrcFields | null>>(\"wedExternalizeItem\", 1,\n\tasync function (from: IReg<IWspEnv>, content: Element, itTypesReducer: (acc: ItemType[], cur: ItemType, idx?: number, src?: ItemType[]) => ItemType[], uiCtx?: HTMLElement): Promise<JSrcFields | null> {\n\t\tconst {ItemCreator} = await import(\"back/wsp/dialogs/itemCreator.js\");\n\t\tconst itemReg = REG.findReg(uiCtx);\n\t\tconst root = DOM.newDomDoc().createElementNS(DOM.SCCORE_NS, DOM.SCITEM_TAG);\n\t\troot.appendChild(root.ownerDocument.importNode(content, true));\n\t\treturn ItemCreator.openCreateItem(ItemCreator.setDefaultConfigFromReg(from, {\n\t\t\tbody: new Blob([DOM.ser(root, true)], {type: 'text/xml'}),\n\t\t\titemTypesTree: {itemTypeReducer: itTypesReducer},\n\t\t\tspaceUri: isItemUiEnv(itemReg.env) ? ITEM.extractSpaceUri(itemReg.env.longDesc.srcUri) : null\n\t\t}), \"Externaliser le contenu vers un item...\", uiCtx).onNextClose();\n\t});\n\n\n/** InfoBorker qui capte l'ouverture d'un item pour afficher son éditeur par défaut dans un dialogue \"cul de sac\". */\nexport class ItemEditInDialogInfoBroker extends InfoBrokerBasic {\n\n\tconstructor(public reg: IReg<IWspUiEnv>) {\n\t\tsuper();\n\t}\n\n\tasync dispatchInfo(info: IInfo, from: IInfoProducer) {\n\t\t//console.log(info, from);\n\t\tif (info instanceof InfoFocusItem) {\n\t\t\tconst shortDesc = info.shortDesc || await this.reg.env.wsp.fetchShortDesc(info.srcRef, this.reg.env.uiRoot);\n\t\t\tconst itemType = this.reg.env.wsp.wspMetaUi.getItemType(shortDesc.itModel);\n\n\t\t\tconst subReg = REG.createSubRegMixed(this.reg, itemType.reg);\n\t\t\tsubReg.env.infoBroker = new InfoBrokerBasic();\n\n\t\t\tconst itemViewer = new ItemViewerSingle({mainViewCode: \":hideWspStruct:\"});\n\t\t\tconst root = <ViewsContainer î={{views: [itemViewer]}} style=\"flex:1;display:flex;min-height:0;min-width:0;flex-direction:column;\"/> as ViewsContainer;\n\t\t\tawait itemViewer.initViewer(subReg, root, null, info.srcRef);\n\n\t\t\tif (info instanceof InfoFocusNodeInItem) {\n\t\t\t\tsubReg.env.infoBroker.dispatchInfo(new InfoFocusNodeInItem(info.xpath, info.srcRef), this);\n\t\t\t}\n\n\t\t\tconst popup = POPUP.findPopupableParent(from) as IPopupable & IInfoBrokerPointer;\n\t\t\tif (popup && popup.infoBroker === this) {\n\t\t\t\t//Reéntrance dans le popup.\n\t\t\t\tconst currentEd = popup.firstElementChild as ItemXmlEd;\n\t\t\t\tif (currentEd.configs.srcRef === info.srcRef) return; //XXX Pb résolution des refs ?\n\t\t\t\tVIEWS.onViewHidden(currentEd, true);\n\t\t\t\tpopup.firstElementChild.remove();\n\t\t\t\tpopup.appendChild(root);\n\t\t\t} else {\n\t\t\t\tconst newPopup = POPUP.showDialog(root, this.reg.env.uiRoot, {\n\t\t\t\t\ttitleBar: {barLabel: {label: \"Sous-item\"}},\n\t\t\t\t\tinitWidth: '90%',\n\t\t\t\t\tinitHeight: '90%',\n\t\t\t\t\tresizer: {}\n\t\t\t\t}) as IInfoBrokerPointer;\n\t\t\t\tnewPopup.infoBroker = this; //Pour la réentrance\n\t\t\t}\n\t\t\tinfo.handled = true;\n\t\t\treturn;\n\t\t}\n\t\tsuper.dispatchInfo(info, from);\n\t}\n}\n\n\nclass WspTxtSelMgr extends TxtSelMgr {\n\n\tprotected _infoBroker: IInfoBroker;\n\n\tprotected _highlightForLink: InlLink;\n\tprotected _highlightSgn: RegExp;\n\n\tconstructor(root: TxtRoot) {\n\t\tsuper(root);\n\t\t//si accès synchrone, on va pouvoir dispatcher l'info InfoHighlighItemSgn en fonction de la sel.\n\t\tif (this._root.wedMgr.docHolder) this._infoBroker = this._root.wedMgr.reg.env.infoBroker;\n\t}\n\n\tonBlur(ev: FocusEvent) {\n\t\tsuper.onBlur(ev);\n\t\tif (this._highlightForLink) {\n\t\t\tthis._highlightForLink = null;\n\t\t\tif (this._highlightSgn) {\n\t\t\t\tthis._highlightSgn = null;\n\t\t\t\tthis._infoBroker.dispatchInfo(new InfoHighlighItemSgn(null), this);\n\t\t\t}\n\t\t}\n\t}\n\n\tonSelChange() {\n\t\tsuper.onSelChange();\n\t\tif (this._sel.focusNode && this._infoBroker) {\n\t\t\t//Highlight des items compatibles avec l'inlLink courant.\n\t\t\tconst inlLink = DOM.findParent(this._oldSel.commonAncestorContainer, this._root, (n: Node): n is InlLink => n instanceof InlLink);\n\t\t\tif (this._highlightForLink !== inlLink) {\n\t\t\t\tthis._highlightForLink = inlLink;\n\t\t\t\tlet sgn: RegExp = null;\n\t\t\t\tlet assigned: srcRef;\n\t\t\t\tif (inlLink) {\n\t\t\t\t\tconst path = inlLink.wedAnchor;\n\t\t\t\t\tpath.push(\"sc:refUri\");\n\t\t\t\t\tassigned = inlLink.wedAttributes && inlLink.wedAttributes[\"sc:refUri\"];\n\t\t\t\t\tconst struct = this._root.wedMgr.docHolder.getStruct(path, assigned !== undefined ? null : [\"@\"]);\n\t\t\t\t\t//console.log(\"struct.itSgnPattern::::\", struct ? (struct as IPtrItemRule).itSgnPattern : null);\n\t\t\t\t\tsgn = struct && (struct as IPtrItemRule).itSgnPattern;\n\t\t\t\t}\n\t\t\t\tif (this._highlightSgn !== sgn) {\n\t\t\t\t\tthis._highlightSgn = sgn;\n\t\t\t\t\tthis._infoBroker.dispatchInfo(new InfoHighlighItemSgn(sgn, assigned), this);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nclass EditHolder implements IHistoEditHolder {\n\tconstructor(public srcRef: srcRef, public infoBroker: IInfoBroker) {}\n\n\tisSame(other: IHistoEditHolder): boolean {\n\t\treturn (other as EditHolder).srcRef === this.srcRef;\n\t}\n\n\tgoTo(targetAddr: HistoEditPoint): boolean {\n\t\tthis.infoBroker.dispatchInfo(new InfoFocusNodeInItem(targetAddr.addr, this.srcRef), this);\n\t\treturn true;\n\t}\n}"]}