{"version":3,"sources":["/@back@/wsp/dialogs/srcNewCode.tsx"],"names":["BaseElement","Button","POPUP","REG","DOM","JSX","DOMSH","FolderEntries","ITEM","SrcNewCode","wsp","this","reg","env","[object Object]","init","findReg","config","sr","attachShadow","SHADOWDOM_INIT","installSkin","_initAndInstallSkin","localName","parentFolder","folderEntries","setFolderUri","currentCode","idx","targetSrcUriType","lastIndexOf","suffix","substring","currentName","main","appendChild","createElement","for","inputLabel","ctn","class","val","defaultCode","nameInput","id","autocomplete","spellcheck","oninput","onNameInput","value","pos","indexOf","setSelectionRange","length","footer","msgArea","doAllBtnLabel","selAllArea","type","doBtn","ui-context","onclick","onDoBtn","cancelBtn","onCancelBtn","onkeydown","onKeyDown","focus","evalDoable","doAllSelected","firstElementChild","checked","newVal","refreshConfigOnClose","findPopupableParent","close","msg","st","doBtnLabel","cancelBtnLabel","code","r","isValidCode","loading","then","getChildStateNow","doBtnReplaceLabel","cancelBtnReplaceLabel","textContent","label","disabled","setHidden","ev","itemCreator","findHost","key","validAndDo","preventDefault","stopImmediatePropagation","registerSkin","customElements","define"],"mappings":"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","sourcesContent":["import {BaseElement, OSkinableInit} from \"back/commons/basis\";\nimport {Button} from \"back/commons/widgets/buttons\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {IReg, IUiEnv, REG} from \"lib/commons/registry\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IWspEnv, Wsp} from \"lib/wsp/wsp\";\nimport {FolderEntries, ITEM} from \"lib/wsp/item\";\n\n/**\n * Dialogue d'édition d'un nom d'une source utilisée pour :\n * - créer un espace\n * - renommer un espace ou un item\n * - dupliquer un espace ou un item.\n * - NON CODé: créer un item dont on connaitrait déjà le type d'item et l'extension (ihm simplifiée) =>(ajouter init.defaultCode)\n *\n * L'écran contrôle l'absence du nom cible dans l'arbre si on est dans un espace.\n *\n * Le résultat retourné est le nouveau nom (extension incluse) ou null si abandonné.\n */\n\nexport interface SrcNewCode extends BaseElement {\n\tinitialize(init: OSrcNewCodeInit): this\n}\n\nexport interface OSrcNewCodeInit extends OSkinableInit {\n\n\t/** Si airItem, null. */\n\tparentFolder: string;\n\n\t/** Pour renommage (extension incluse), null si création. */\n\tcurrentCode?: string\n\n\t/** Si création, nom par défaut (extension incluse si item). */\n\tdefaultCode?: string\n\n\t/** */\n\ttargetSrcUriType?: 'item' | 'space' | 'res'\n\n\tinputLabel?: string\n\n\tdoBtnLabel?: string\n\n\tcancelBtnLabel?: string\n\n\t/** Si renseigné autorise le remplacement d'un contenu existant. */\n\tdoBtnReplaceLabel?: string\n\n\tcancelBtnReplaceLabel?: string\n\n\t/** Case à cocher supplémentaire pour tout remplacer/ignorer. */\n\tdoAllBtnLabel?: string\n\n\t/** Output. */\n\tdoAllSelected?: boolean\n}\n\nexport class SrcNewCode extends BaseElement {\n\n\t/** Contexte */\n\treg: IReg<IWspEnv & IUiEnv>;\n\n\tget wsp(): Wsp {return this.reg.env.wsp};\n\n\t/** extension incluant le '.' */\n\tsuffix: string;\n\n\t/** code de l'espace ou name de l'item (ie code sans extension). */\n\tcurrentName: string;\n\n\tconfig: OSrcNewCodeInit;\n\n\tnameInput: HTMLInputElement;\n\tdoBtn: Button;\n\tcancelBtn: Button;\n\tmsgArea: HTMLElement;\n\tselAllArea?: HTMLLabelElement;\n\n\t/** Controle de l'existance des noms. */\n\tfolderEntries: FolderEntries;\n\n\tprotected _initialize(init: OSrcNewCodeInit) {\n\t\tthis.reg = this.findReg(init);\n\t\tthis.config = init;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"webzone:panel\", sr);\n\t\tthis.reg.installSkin(\"standard-dialog\", sr);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tif (init.parentFolder != null) {\n\t\t\tthis.folderEntries = new FolderEntries(this.wsp, this);\n\t\t\tthis.folderEntries.setFolderUri(init.parentFolder);\n\t\t}\n\n\t\tif (init.currentCode) {\n\t\t\t//Fixation du suffixe que si item.\n\t\t\tconst idx = init.targetSrcUriType !== 'item' ? -1 : init.currentCode.lastIndexOf('.');\n\t\t\tif (idx > 0) this.suffix = init.currentCode.substring(idx);\n\t\t\tthis.currentName = idx > 0 ? init.currentCode.substring(0, idx) : init.currentCode;\n\t\t}\n\n\t\tconst main = sr.appendChild(<main/>);\n\t\tmain.appendChild(<label for=\"name\">{init.inputLabel || \"Code\"}</label>);\n\t\tconst ctn = main.appendChild(<div class=\"input\"/>);\n\t\tconst val = this.currentName || init.defaultCode;\n\t\tthis.nameInput = ctn.appendChild(<input id=\"name\" autocomplete=\"off\" spellcheck=\"false\" class={this.suffix ? 'file' : 'folder'} oninput={this.onNameInput} value={val}/>) as HTMLInputElement;\n\t\tif (this.suffix) ctn.appendChild(<span class=\"ext\">{this.suffix}</span>);\n\t\tif(val) {\n\t\t\tconst pos = val.indexOf('.'); //On essaye de se placer avant le 1er '.'\n\t\t\tthis.nameInput.setSelectionRange(0, pos > 0 ? pos : val.length);\n\t\t}\n\n\t\tconst footer = sr.appendChild(<div id=\"footer\"/>);\n\t\tthis.msgArea = footer.appendChild(<div id=\"msg\"/>);\n\t\tif (init.doAllBtnLabel) {\n\t\t\tthis.selAllArea = footer.appendChild(<label class=\"option\"><input type=\"checkbox\"/>{init.doAllBtnLabel}</label>) as HTMLLabelElement;\n\t\t}\n\t\tthis.doBtn = footer.appendChild(<Button id=\"do\" class=\"default\" ui-context=\"dialog\" onclick={this.onDoBtn}/>) as Button;\n\t\tthis.cancelBtn = footer.appendChild(<Button id=\"cancel\" ui-context=\"dialog\" onclick={this.onCancelBtn}/>) as Button;\n\n\t\tthis.onkeydown = this.onKeyDown;\n\n\t\tthis.nameInput.focus();\n\t\tthis.evalDoable();\n\t}\n\n\tprivate refreshConfigOnClose() {\n\t\tif (this.selAllArea) this.config.doAllSelected = (this.selAllArea.firstElementChild as HTMLInputElement).checked;\n\t}\n\n\tvalidAndDo() {\n\t\tif (this.evalDoable() !== 'do') return;\n\t\tconst newVal = this.nameInput.value;\n\t\tthis.refreshConfigOnClose();\n\t\tPOPUP.findPopupableParent(this).close(this.suffix ? newVal + this.suffix : newVal);\n\t}\n\n\tevalDoable(): 'no' | 'do' | 'working' {\n\t\tconst newVal = this.nameInput.value;\n\t\tlet msg: string = null;\n\t\tlet st: 'do' | 'working' = 'do';\n\t\tlet doBtnLabel = this.config.doBtnLabel || \"Créer\";\n\t\tlet cancelBtnLabel = this.config.cancelBtnLabel || \"Annuler\";\n\n\t\tif (!newVal) {\n\t\t\tmsg = \"Saisissez un code\";\n\t\t} else if (newVal === this.currentName) {\n\t\t\tmsg = \"Saisissez un nouveau code\";\n\t\t} else {\n\t\t\tconst code = this.suffix ? newVal + this.suffix : newVal;\n\t\t\tconst r = ITEM.isValidCode(this.config.targetSrcUriType, code);\n\t\t\tif (r !== true) msg = r;\n\t\t\tif (this.config.parentFolder != null) {\n\t\t\t\t//on n'est pas en airItem\n\t\t\t\tif (this.folderEntries.loading) {\n\t\t\t\t\tst = 'working';\n\t\t\t\t\tthis.folderEntries.loading.then(() => {this.evalDoable()});\n\t\t\t\t} else {\n\t\t\t\t\tif (this.folderEntries.getChildStateNow(code) === \"used\") {\n\t\t\t\t\t\tif (this.config.doBtnReplaceLabel) {\n\t\t\t\t\t\t\tdoBtnLabel = this.config.doBtnReplaceLabel;\n\t\t\t\t\t\t\tcancelBtnLabel = this.config.cancelBtnReplaceLabel || \"Ignorer\";\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tmsg = \"Ce code existe déjà.\";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.msgArea.textContent = msg;\n\t\tthis.cancelBtn.label = cancelBtnLabel;\n\t\tthis.doBtn.label = doBtnLabel;\n\t\tthis.doBtn.disabled = msg !== null || st !== 'do';\n\t\tif (this.selAllArea) {\n\t\t\tDOM.setHidden(this.msgArea, !msg);\n\t\t\tDOM.setHidden(this.selAllArea, msg != null || newVal !== this.config.defaultCode);\n\t\t}\n\t\treturn msg ? 'no' : st;\n\t}\n\n\tonNameInput(this: HTMLInputElement, ev: Event) {\n\t\tconst itemCreator = DOMSH.findHost(this) as SrcNewCode;\n\t\titemCreator.evalDoable();\n\t}\n\n\tonKeyDown(ev: KeyboardEvent) {\n\t\tif (ev.key === 'Enter') {\n\t\t\tthis.validAndDo();\n\t\t\tev.preventDefault();\n\t\t\tev.stopImmediatePropagation();\n\t\t}\n\t}\n\n\tonCancelBtn(this: Button) {\n\t\t(DOMSH.findHost(this) as SrcNewCode).refreshConfigOnClose();\n\t\tPOPUP.findPopupableParent(this).close();\n\t}\n\n\tonDoBtn(this: Button) {\n\t\t(DOMSH.findHost(this) as SrcNewCode).validAndDo();\n\t}\n}\n\nREG.reg.registerSkin('wsp-src-newcode', 1, /* language=CSS */ `\n\t:host {\n\t\tmin-width: 35em;\n\t\tmin-height: 8em;\n\t}\n\n  :focus-visible {\n\t\toutline: var(--focus-outline);\n\t}\n\n\tmain {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\tjustify-content: center;\n\t\tpadding: .5em;\n\t}\n\n\t.option {\n\t\tdisplay: flex;\n\t}\n\n\t.input {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\talign-items: center;\n\t}\n\n\tinput {\n\t\tflex: 1;\n\t\tfont-size: inherit;\n\t}\n\n\t#msg {\n\t\tflex: 1;\n\t\tmargin: 0 .5em;\n\t\tmin-width: 15em;\n\t}\n\n\tc-button {\n\t\tmin-width: 6em;\n\t}\n`);\n\ncustomElements.define(\"wsp-src-newcode\", SrcNewCode);\n"]}