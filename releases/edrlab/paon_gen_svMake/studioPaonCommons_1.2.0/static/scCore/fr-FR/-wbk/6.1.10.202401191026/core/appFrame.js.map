{"version":3,"sources":["/@back@/core/appFrame.tsx"],"names":["BASIS","MsgLabel","Actionables","POPUP","LoggedUser","Action","ACTION","Desk","UrlHashObjDeskFeat","LASTDATAS","REG","VIEWS","JSX","ShadowJsx","LastDatasDeskFeat","ERROR","CDM","DOMSH","GFX","Button","ButtonToggle","isApp","tag","AppFrameDeskFeat","[object Object]","desk","options","this","isIn","add","ContextMenuDeskFeat","assignProps","d","_appBuilders","initialTitle","document","title","ldSession","location","search","substr","bcSessions","BroadcastChannel","pathname","rand","Math","random","onmessage","ev","data","req","postMessage","resp","session","r","onLdSessionConflict","ondragenter","ondragover","ondrop","dataTransfer","dropEffect","preventDefault","reg","addToList","LC_init","_auth","env","universe","auth","fetchUser","LC_load","body","buildLastDatas","p","_app","appDef","appLD","getParentLastDatas","forChild","ld","lastDatas","textContent","installSkin","actions","createElement","id","group-order","ui-context","portalTi","collapseActions","icon","onclick","toggleOn","hidden","appBar","mainBar","skin","skinOver","gotoHome","src","iconUrl","appName","header","appendChild","getSvc","î","authReg","mainCtn","addEventListener","target","parentElement","refreshTitle","updateUrlHash","detail","revertable","fullscreenEnabled","append","requestFullscreen","onUrlHashChange","setMainAppFromHash","LIST_accelKeys","setExecute","c","listeners","on","async","oldUser","newUser","closeMainApp","setUrlHash","loginAct","execute","refreshTree","shadowRoot","user","canHideView","then","canClose","undefined","config","anonymousUser","currentUser","setMainApp","url","URL","httpFrames","web","execFrameUrl","hostname","isServerLocal","window","refreshOffline","accelKeys","handleKeyboardEvent","_b","_a","accelKeyMgr","appBuilder","push","_defaultAppBuilder","s","round","toString","ws","lcListeners","code","setServerOff","msgListeners","onLiaiseMsg","m","type","msg","opType","setMaintenanceMsg","until","off","isServerOff","maintenanceMsg","refreshErr","now","Date","delay","maintenanceMsgUntil","setTimeout","setHeadband","navigator","onLine","level","_headband","class","isConnected","insertBefore","setCustomMsg","remove","bd","isAppDefMatch","loadBody","hasHeadTitleBar","useLD","_updtHashFromHere","getUrlHash","updateAppDef","fbApp","setMainAppDef","e","log","nmAppDef","Object","assign","normalizeAppDef","MouseEvent","KeyboardEvent","isAccelPressed","href","hash","stringify","open","app","fAppIniting","finally","setMainAppChained","anonymousAllowed","oldApp","hideMainApp","onViewShown","initializedAsync","appErrorStatus","ok","replace","force","wasAlive","closeAllPopup","onViewHidden","console","findAndOpenApp","text","showNotif","appTitle","getLabel","getHeadTitleBar","bar","firstElementChild","electron","origin","exitButton","initialize","uiContext","label","notif","showNotifInfo","viewPortY","close","exitFullscreen","once","registerSkin","contextMenuCustom","mode","setContextMenuCustom","showContextMenu","call","univ","currentAuthenticatedUser","getUserData","button","shiftKey","node","findDeepActiveElement","findDocumentOrShadowRoot","menu","ctxMenuActions","length","anchor","which","initX","rect","bound","left","pageX","right","initY","top","pageY","bottom","focused","posFrom","intersectWith","findFlatParentElt","n","HTMLElement","scrollHeight","clientHeight","from","misspelledWord","actionContext","spellcheckSymbol","dictionarySuggestions","showPopupActions","restoreFocus","findParentElt","SecFetchDeskFeat","secFetchAware","checkSecFetchSiteAware","showErrorInfo","getNoNetworkMsg","getNoSecFetchMsg","Error","isSecFetchSiteAware","elt","knownNavCompat","map","v","name","currentMaintenanceDialog","registerSvc","showDialog","style","findPopupableParent","titleBar","barLabel","onNextClose"],"mappings":"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","sourcesContent":["import {BASIS, IEltInitableAsync, MsgLabel} from \"back/commons/basis\";\nimport {Actionables} from \"back/commons/widgets/bars\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {LoggedUser} from \"back/core/widgets/loggedUser\";\nimport {AccelKeyMgr, Action, ACTION, IAccelKeyMgrPointer} from \"lib/commons/actions\";\nimport {Area} from \"lib/commons/areas\";\nimport {Desk, UrlHashObjDeskFeat} from \"lib/commons/desk\";\nimport {ILastDatasBuilder, ILastDatasHolder, JLastDatas, LASTDATAS,} from \"lib/commons/lastDatas\";\nimport {IReg, IRegPointer, IUiEnv, REG} from 'lib/commons/registry';\nimport {IView, VIEWS} from \"lib/commons/views\";\nimport {JSX, ShadowJsx} from \"lib/commons/xml/dom\";\nimport {LastDatasDeskFeat} from \"lib/core/lastDatas\";\nimport {BasicUniverse, IBasicUniversePointer, IMaintenanceCb, IUniverseEnv, IWsExecFrame} from \"lib/core/universe\";\nimport {AuthSrv, JUser} from \"lib/core/user\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {CDM} from \"lib/commons/utils/cdm\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IContextMenuActionsPointer} from \"back/commons/actionables\";\nimport {IPopupable, OPopupAnchor} from \"back/commons/widgets/popupable\";\nimport {GFX} from \"lib/commons/utils/gfx\";\nimport {Button, ButtonToggle, OButtonInit} from \"back/commons/widgets/buttons\";\nimport \"back/core/zones/webZones\";\n\n/**\n * Constructeur d'apps.\n */\nexport interface IAppBuilder<ENVIN, ENVOUT> extends Area<IAppCtx<ENVIN>, IApp<ENVOUT>> {\n\n\t/**\n\t * Cet appBuilder peut-il fournir une app avec cette définition (généralement json issu du hash d'une url).\n\t */\n\tisAppDefMatch(data: JAppDef): boolean\n\n\t/**\n\t * retourne les params au juste nécessaire\n\t * Remarque : modifie l'objet passé en paramètre\n\t */\n\tnormalizeAppDef?(data: JAppDef): void\n\n\t/**\n\t * Construit une app.\n\t * Note : une IApp ne doit pas dépendre de son contexte DOM parent (repositionnement libre)\n\t */\n\tbuildBody(ctx: IAppCtx<ENVIN>, lastDatas?: JLastDatas): IApp<ENVOUT>\n\n\tloadBody(ctx: IAppCtx<ENVIN>, lastDatas?: JLastDatas): Promise<IApp<ENVOUT>>\n\n}\n\n/** Contexte pour la construction d'une App. */\nexport interface IAppCtx<ENVIN> extends IRegPointer<ENVIN> {\n\n\t/** Données issues du hash de l'URL ou d'une autre source pour créer cette app. */\n\tappDef: JAppDef\n\n\t/** Donnée de restauration de la app selon son dernier état enregistré. */\n\tlastDatas?: JLastDatas\n\n\t/**\n\t * Informe l'app à sa construction qu'elle dispose d'une barre de titre riche\n\t * qu'elle pourra exploiter lorsque le contexte appellera IApp.getHeadTitleBar()\n\t * (juste après son initialisation). Au cours de la vie d'une même app IApp.getHeadTitleBar()\n\t * pourra être appelé plusieurs fois et peut retourner toujours le même élément.\n\t * La app peut garder une ref à cet élément pour des mises à jour dynamiques.\n\t */\n\thasHeadTitleBar?: boolean\n}\n\n/**\n * Propriétés json de définition d'une app. Ces données permettent\n * - d'identifier la app à construire. Exemple app=wsp, app=dynGen, app=editDepot, app=userAdmin...\n * - de fournir les données minimale pour reconstruire une vue équivalente dans une nouvelle\n *   fenetre. Exemple pour une app d'affichage\n *     - d'un atelier chain : wspRef.\n *     - d'un dynGen sur un item : wspRef + genCode + skin\n *\n * Ces propriétés ne contiennent pas l'URL du serveur (univers) ni du user courant qui relèvent de l'appFrame.\n */\nexport type JAppDef = {\n\t/** app fallback appelée en cas d'impossibilité d'afficher cette app\n\t * Note : exploité uniquement lors du traitement de l'URL du hash\n\t */\n\tfbApp?: JAppDef\n}\n\n/**\n * Représente une App instanciée sous forme d'un Custom Element DOM.\n */\nexport interface IApp<ENV> extends IView, ILastDatasBuilder, IRegPointer<ENV & IUiEnv>, IEltInitableAsync, IAccelKeyMgrPointer<IApp<ENV>> {\n\n\t/** Raison de l'échec de l'app\n\t * Note : renseigné SSi l'app est chargée */\n\tappErrorStatus?: 'accessDenied' | string\n\n\t/** Si cette app peut-etre affichée sans user connecté. */\n\tanonymousAllowed?: boolean\n\n\t/**\n\t * Définition de l'état courant de la app. Peut-être utilisé pour construire le hash d'une url\n\t * et réobtenir cette app avec les mêmes principales données chargées.\n\t */\n\treadonly appDef: JAppDef\n\n\t/**\n\t * Met à jour la définition de cette app du fait d'un event extérieur, par exemple dû à une\n\t * modification de hash de l'URL.\n\t *\n\t * Inversement, si la app met à jour sa propre définition, un DOM event \"c-appdef-change\" (bubbles=true)\n\t * doit être généré pour notifier l'appFrame. Si la app ne peut revenir dans l'état précédent, une\n\t * propriété 'revertable' doit être mise à false dans les CustomEvent.detail : {bubbles: true, detail: {revertable:false}}\n\t *\n\t * @return true si cette app est toujours valide avec cette nouvelle définition, false si l'appFrame\n\t * appelant devrait repasser par ses IAppBuilder pour remplacement de l'app.\n\t */\n\tupdateAppDef(def: JAppDef): boolean\n\n\n\t/**\n\t * Offre la possibilité à l'app d'injecter une structure html plus riche que son simple titre IApp.getLabel().\n\t * Exemple : ajout d'un menu d'options, etc.\n\t * Ce contenu fournit par la App doit se conformer à un espace de type barre de titre.\n\t * Cette méthode sera appelée par le contexte applicatif (si il dispose de cette possbilité) ; à l'init\n\t * de la app, elle saura qu'elle aura cette possibilité via la propriété IAppCtx.hasHeadTitleBar=true.\n\t */\n\tgetHeadTitleBar?(): HTMLElement\n\n\t/**\n\t * Offre la possibilité à l'app de capter des events claviers globaux au niveau de la window,\n\t * (même si la app ne détient pas le focus) si le container le permet\n\t */\n\taccelKeyMgr?: AccelKeyMgr<IApp<ENV>>\n\n\t// /** Entête standard d'une app, optionnel */\n\t// readonly appHeader?: AppHeader<IApp<ENV>>\n}\n\nexport function isApp<ENV>(tag: HTMLElement): tag is IApp<ENV> {return tag && ('appDef' in tag)}\n\n/**\n * Feature du Desk pour constituer un cadre graphique pour UNE SEULE app simultannée.\n * Se constitue de :\n * - 1 header (toolbar : appframe:header:toolbar)\n * - 1 zone main à populer\n * - 1 footer : zone info, user\n *\n * Gère l'authentification initiale de la page fondé sur REG.reg.env.universe.\n * Un menu \"Options\" ajouté par défaut en fin de toolbar du header (masqué automatiqument si vide).\n *\n * TODO dériver un AppFrameMultiDeskFeat pour un concept de bureau avec plusieurs apps lancées simultannément et une barre en bas...\n *\n */\nexport class AppFrameDeskFeat extends Desk {\n\n\tstatic add(desk: Desk, options?: OAppFrameDeskFeatOptions & OAppFrameOptions): AppFrameDeskFeat {\n\t\tif (this.isIn(desk)) return desk;\n\t\tLastDatasDeskFeat.add(desk);\n\t\tContextMenuDeskFeat.add(desk);\n\t\tdesk.assignProps(this);\n\t\tconst d = desk as AppFrameDeskFeat & LastDatasDeskFeat;\n\t\td._appBuilders = [];\n\t\td.initialTitle = document.title;\n\n\t\t//Construction d'un id de session unique dans le navigateur.\n\t\td.ldSession = location.search.substr(1);\n\t\tconst bcSessions = new BroadcastChannel(location.pathname);\n\t\tconst rand = Math.random();\n\t\tbcSessions.onmessage = (ev: MessageEvent) => {\n\t\t\tif (ev.data.req === \"getSessions\") {\n\t\t\t\t//un autre onglet demande les sessions en cours, on lui répond.\n\t\t\t\tbcSessions.postMessage({resp: 'getSessions', session: d.ldSession, r: ev.data.r});\n\t\t\t} else if (ev.data.resp === \"getSessions\" && ev.data.r === rand) {\n\t\t\t\t//réponse à notre requête.\n\t\t\t\tif (ev.data.session === d.ldSession) d.onLdSessionConflict();\n\t\t\t}\n\t\t};\n\t\tbcSessions.postMessage({req: 'getSessions', r: rand});\n\n\t\t//Bloque tout drop natif dans la page.\n\t\tdocument.ondragenter = document.ondragover = document.ondrop = (ev: DragEvent) => {\n\t\t\tev.dataTransfer.dropEffect = 'none';\n\t\t\tev.preventDefault();\n\t\t};\n\n\t\t//Le plus tôt possible : chargement du user authentifié courant\n\t\tREG.reg.addToList(Desk.LC_init, 'loadUser', 1, () => {\n\t\t\td._auth = (REG.reg.env as IBasicUniversePointer).universe.auth;\n\t\t\treturn d._auth.fetchUser();\n\t\t}, -1000);\n\n\t\t//En fin de chargement : construction de l'ihm root (remplaçant l'ihm d'attente)\n\t\tREG.reg.addToList(Desk.LC_load, 'buildUi', 1, () => {\n\t\t\tconst body = document.body as HTMLElement & ILastDatasBuilder & ILastDatasHolder;\n\n\t\t\t//LastDatas\n\t\t\tbody.buildLastDatas = (p: JLDAppFrame) => {\n\t\t\t\tif (d._app) {\n\t\t\t\t\tp.appDef = d._app.appDef;\n\t\t\t\t\tp.appLD = LASTDATAS.buildLastDatas({}, d._app, true);\n\t\t\t\t}\n\t\t\t};\n\t\t\tbody.getParentLastDatas = (forChild: HTMLElement): JLastDatas | null => {\n\t\t\t\tconst ld = (desk as LastDatasDeskFeat).lastDatas as JLDAppFrame;\n\t\t\t\treturn ld ? ld.appLD : null;\n\t\t\t};\n\n\t\t\t//Construction du body\n\t\t\tbody.textContent = null;\n\t\t\tREG.reg.installSkin('appFrame');\n\n\t\t\tconst actions = <Actionables id=\"headerActions\" actions=\"appframe:header:toolbar\" group-order=\"*\" ui-context=\"dialog\"/>;\n\t\t\tconst portalTi = <span id=\"portalTi\">{document.title}</span>;\n\t\t\tconst collapseActions = <ButtonToggle id=\"collapseActions\" title=\"Masquer\" icon=\"/@skin@/core/widgets/appFrame/collapse.svg\" onclick={function (this: ButtonToggle) {\n\t\t\t\tthis.toggleOn = portalTi.hidden = actions.hidden = !this.toggleOn;\n\t\t\t\tthis.title = this.toggleOn ? \"Afficher\" : \"Masquer\";\n\t\t\t}}/>;\n\t\t\td.appBar = <span id=\"appBar\"/>;\n\t\t\td.mainBar = <div id=\"mainBar\">\n\t\t\t\t<ShadowJsx skin=\"appFrame/mainBar\" skinOver=\"webzone:invert\">\n\t\t\t\t\t<Button id=\"home\" onclick={() => {(desk as AppFrameDeskFeat).gotoHome()}}>\n\t\t\t\t\t\t<div id=\"logo\"><img src={options && options.iconUrl || \"/@skin@/core/logoSC.svg\"} title={options.appName}/></div>\n\t\t\t\t\t\t{portalTi}\n\t\t\t\t\t</Button>\n\t\t\t\t\t{actions}\n\t\t\t\t\t{collapseActions}\n\t\t\t\t</ShadowJsx>\n\t\t\t</div>;\n\t\t\td.header = body.appendChild(\n\t\t\t\tREG.reg.getSvc('appFrameHeader') as HTMLElement ||\n\t\t  <header>\n\t\t\t\t\t\t{d.mainBar}\n\t\t\t\t\t\t{d.appBar}\n\t\t\t  <div id=\"loggedUserBox\"><LoggedUser î={{icon: \"--user-icon\", reg: (options && options.authReg) || REG.reg}}/></div>\n\t\t  </header>\n\t\t\t) as HTMLElement;\n\n\t\t\t//body.appendChild(<hr/>);\n\n\t\t\td.mainCtn = body.appendChild(REG.reg.getSvc('appFrameMain') as Element || <main/>) as HTMLElement;\n\t\t\td.mainCtn.addEventListener(\"c-view-change\", function (this: HTMLElement, ev: CustomEvent) {\n\t\t\t\tif ((ev.target as Element).parentElement === this) (desk as AppFrameDeskFeat).refreshTitle();\n\t\t\t})\n\t\t\td.mainCtn.addEventListener(\"c-appdef-change\", function (this: HTMLElement, ev: CustomEvent) {\n\t\t\t\tif ((ev.target as Element).parentElement === this) (desk as AppFrameDeskFeat).updateUrlHash(ev.detail && ev.detail.revertable === false);\n\t\t\t});\n\n\t\t\t//Masquage du header en mode fullscreen\n\t\t\tif (document.fullscreenEnabled) {\n\t\t\t\td.header.append(<Button id=\"fullscreen\" î={{reg: REG.reg, icon: \"/@skin@/core/actions/portalbar/fullscreen.svg\", title: \"Contenu en plein écran\"} as OButtonInit} onclick={AppFrameDeskFeat.requestFullscreen}/>);\n\t\t\t}\n\n\t\t\tif (UrlHashObjDeskFeat.isIn(d)) d.onUrlHashChange.add(() => d.setMainAppFromHash());\n\n\t\t\t//On tue le racourcis ctrl+S du navigateur qui n'a pas de sens dans un appFrame.\n\t\t\tREG.reg.addToList(Desk.LIST_accelKeys, \"s-accel\", 1, new Action<any>('killCtrlS').setExecute(function (c, ev) {ev.preventDefault()}));\n\t\t\tREG.reg.addToList(Desk.LIST_accelKeys, \"F1\", 1, new Action<any>('killF1').setExecute(function (c, ev) {ev.preventDefault()}));\n\n\t\t\td._auth.listeners.on('loggedUserChanged', async (oldUser: JUser, newUser: JUser) => {\n\t\t\t\t//on clos l'app actuelle\n\t\t\t\tawait d.closeMainApp(true);\n\n\t\t\t\tif (oldUser && !newUser) {\n\t\t\t\t\t//Déconnexion, on efface l'état courant dans le hash\n\t\t\t\t\tif (UrlHashObjDeskFeat.isIn(d)) await d.setUrlHash(null);\n\t\t\t\t}\n\n\t\t\t\tif (newUser) {\n\t\t\t\t\t//on recharge à partir du hash et des (nouveaux) lastDatas\n\t\t\t\t\tawait d.setMainAppFromHash((desk as LastDatasDeskFeat).lastDatas);\n\t\t\t\t} else {\n\t\t\t\t\t// Plus de user car anonymous interdit.\n\t\t\t\t\t// on force l'affichage du login.\n\t\t\t\t\tconst loginAct = REG.reg.getSvc('userLogin') as Action<Element>;\n\t\t\t\t\tloginAct.execute(body);\n\t\t\t\t}\n\t\t\t\t//On refresh les bars.\n\n\t\t\t\tBASIS.refreshTree(d.mainBar.shadowRoot);\n\t\t\t\tBASIS.refreshTree(d.header);\n\t\t\t\t//if (d.footer) BASIS.refreshTree(d.footer);\n\t\t\t}, 100); //La reconstruction de la page devrait intervenir en dernier, après les rechargements, lastDaats, userDatas...\n\n\t\t\t/** On controle qu'on peut clore l'app courante avant logOut. */\n\t\t\td._auth.listeners.on('beforeLogout', (user: JUser): void | 'stop' | Promise<void | 'stop'> => {\n\t\t\t\tif (d._app) return VIEWS.canHideView(d._app).then((canClose: boolean) => (canClose ? undefined : 'stop') as void | 'stop');\n\t\t\t});\n\n\t\t\tif (!d._auth.config.anonymousUser) {\n\t\t\t\t//Si anoymous pas autorisé, affichage de l'écran de log au chargement de la page.\n\t\t\t\tif (d._auth.currentUser == null) {\n\t\t\t\t\tconst loginAct = REG.reg.getSvc('userLogin') as Action<Element>;\n\t\t\t\t\tloginAct.execute(body);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//Lancement de la app si forcé\n\t\t\tif (d._app) d.setMainApp(d._app);\n\t\t\t//Sinon on tente de la lancer à partir du hash et des lastDatas.\n\t\t\telse d.setMainAppFromHash((desk as LastDatasDeskFeat).lastDatas);\n\t\t}, 1000);\n\n\t\t//Gestion des erreurs de connexion réseau\n\t\tREG.reg.addToList(Desk.LC_load, 'netError', 1, () => {\n\t\t\tconst universe = (REG.reg.env as IBasicUniversePointer).universe;\n\t\t\tconst url = new URL(universe.httpFrames.web.config.execFrameUrl.url);\n\t\t\tif (url.hostname !== 'localhost' && url.hostname !== '127.0.0.1') {\n\t\t\t\td.isServerLocal = false;\n\t\t\t\t//Par l'écoute de l'evt \"offline\" on détecte une coupure réseau.\n\t\t\t\twindow.addEventListener('offline', refreshOffline);\n\t\t\t\twindow.addEventListener('online', refreshOffline);\n\t\t\t\trefreshOffline();\n\t\t\t} else d.isServerLocal = true;\n\t\t}, 1010);\n\t\treturn d;\n\t}\n\n\tstatic isIn(desk: Desk): desk is AppFrameDeskFeat {return 'setMainAppFromHash' in desk}\n\n\tprotected onGloablKeyDown(this: void, ev: KeyboardEvent) {\n\t\tif (window.desk.accelKeys.handleKeyboardEvent(ev, window) === 0) {\n\t\t\t(window.desk as AppFrameDeskFeat)._app?.accelKeyMgr?.handleKeyboardEvent(ev, (window.desk as AppFrameDeskFeat)._app);\n\t\t}\n\t}\n\n\t/**\n\t * Ajout d'un appBuilder dans cet appFrame\n\t */\n\taddAppBuilder(appBuilder: IAppBuilder<any, any>) {\n\t\tthis._appBuilders.push(appBuilder);\n\t}\n\n\t/**\n\t * App construite par défaut, si aucune autre app disponible.\n\t * Initialisé avec le REG.reg racine et l'appDef issu du hash\n\t * pour indiquer une éventuelle erreur dans le hash.\n\t */\n\tsetDefaultAppBuilder(appBuilder: IAppBuilder<any, any>) {\n\t\tthis._defaultAppBuilder = appBuilder;\n\t}\n\n\t/**\n\t * Gestionnaire de conflit d'id de session.\n\t * La version actuelle génère un id aléatoire, un prompt au user pourrait aussi être envisagé.\n\t */\n\tonLdSessionConflict() {\n\t\tconst s = (desk as LastDatasDeskFeat).ldSession = (Math.round(Math.random() * 9999999)).toString(36);\n\t\t//On ajoute un ~ pour repérer que c'est une session random, donc un code non signifiant\n\t\t//pour le user, à remplacer par un n° dans l'ihm de gestion des sessions.\n\t\tlocation.search = \"?~\" + s;\n\t}\n\n\t/** Surveillance d'une connexion webSocket d'un univers pour notifier une iterruption d'accès au serveur. */\n\tsurveyWsConnexion(ws: IWsExecFrame) {\n\t\t//Par l'écoute de la connection WS, on détecte l'arret du serveur.\n\t\tws.lcListeners.on(\"closed\", function (code: number) {\n\t\t\tif (code !== 1000) (desk as AppFrameDeskFeat).setServerOff(true);\n\t\t\telse {\n\t\t\t\t//cloture sur user inactif.\n\t\t\t\t//plus de ws pour détecter un arrêt serveur, on écoute les erreurs de connection ?\n\t\t\t\t//XXX écouter les erreurs fetch ? window.addEventListener('error', onWindowError);\n\t\t\t}\n\t\t});\n\t\tws.lcListeners.on(\"opened\", function () {\n\t\t\t//XXX écouter les erreurs fetch ? window.removeEventListener('error', onWindowError);\n\t\t\t(desk as AppFrameDeskFeat).setServerOff(false);\n\t\t});\n\t\tws.msgListeners.on(\"liaise\", this.onLiaiseMsg);\n\t}\n\n\tonLiaiseMsg(this: void, m: JMaintenanceMsg) {\n\t\t//console.log(\"liaise:::::::::::\", m);\n\t\tif (m.type !== \"maintenance\") return;\n\t\tif (!m.msg && m.opType) {\n\t\t\t//COMPAT XUL\n\t\t\tswitch (m.opType) {\n\t\t\tcase \"update\" :\n\t\t\t\tm.msg = \"ATTENTION, une mise à jour du serveur est imminente\";\n\t\t\t\tbreak;\n\t\t\tcase \"restart\":\n\t\t\t\tm.msg = \"ATTENTION, un redémarrage du serveur est imminent\";\n\t\t\t\tbreak;\n\t\t\tcase \"shutdown\":\n\t\t\t\tm.msg = \"ATTENTION, l'arrêt du serveur est imminent\";\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t(desk as AppFrameDeskFeat).setMaintenanceMsg(m.msg, m.until);\n\t}\n\n\t/** Détection de l'état du serveur. */\n\tisServerOff: boolean;\n\n\t/** Le serveur est-il sur le net ou local (localhost). */\n\tisServerLocal: boolean;\n\n\tsetServerOff(off: boolean) {\n\t\tthis.isServerOff = off;\n\t\tthis.maintenanceMsg = null; //pour ne pas afficher un msg si relancé plus tot que le until.\n\t\tthis.refreshErr();\n\t}\n\n\tmaintenanceMsg?: string;\n\tmaintenanceMsgUntil?: number;\n\n\t/** Affiche un message de maintenance. */\n\tsetMaintenanceMsg(msg: string, until?: number) {\n\t\tconst now = Date.now();\n\t\tif (!until) until = now + 30000; //msg affiché 30s par défaut.\n\t\tconst delay = until - now;\n\t\tif (delay > 500) {\n\t\t\tthis.maintenanceMsgUntil = until;\n\t\t\tthis.maintenanceMsg = msg;\n\t\t\tthis.refreshErr();\n\t\t\tsetTimeout(() => {\n\t\t\t\tif (this.maintenanceMsg === msg) {\n\t\t\t\t\t//msg pas modifié entre temps, on reset\n\t\t\t\t\tthis.maintenanceMsg = null;\n\t\t\t\t\tthis.refreshErr();\n\t\t\t\t}\n\t\t\t}, delay);\n\t\t}\n\t}\n\n\trefreshErr() {\n\t\tif (this.isServerOff) {\n\t\t\tthis.setHeadband(\"Votre connexion au serveur est interrompue ou instable\", \"error\");\n\t\t} else if (!this.isServerLocal && !navigator.onLine) {\n\t\t\tthis.setHeadband(\"Vous n'êtes pas connecté·e au réseau, accès impossible au serveur.\", \"error\");\n\t\t} else if (this.maintenanceMsg) {\n\t\t\tthis.setHeadband(this.maintenanceMsg, \"warning\");\n\t\t} else {\n\t\t\tthis.setHeadband(null);\n\t\t}\n\t}\n\n\tsetHeadband(msg: string, level?: 'info' | 'error' | 'warning', icon?: string) {\n\t\tif (msg) {\n\t\t\tif (!this._headband) this._headband = <MsgLabel class=\"headband\"/> as MsgLabel;\n\t\t\tif (!this._headband.isConnected) document.body.insertBefore(this._headband, this.mainCtn);\n\t\t\tthis._headband.setCustomMsg(msg, level, icon);\n\t\t} else {\n\t\t\tif (this._headband && this._headband.isConnected) this._headband.remove();\n\t\t}\n\t}\n\n\tprotected _headband: MsgLabel;\n\n\t/** */\n\tasync setMainAppDef(appDef: JAppDef): Promise<boolean> {\n\t\tfor (const bd of this._appBuilders) {\n\t\t\tif (bd.isAppDefMatch(appDef)) {\n\t\t\t\treturn this.setMainApp(await bd.loadBody({reg: REG.reg, appDef, hasHeadTitleBar: true}));\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tasync setMainAppFromHash(useLD?: JLDAppFrame): Promise<void> {\n\t\tif (this._updtHashFromHere) return; //bloque réentrance quand la modif vient de nous.\n\t\tconst appDef = UrlHashObjDeskFeat.isIn(this) ? this.getUrlHash() : useLD && useLD.appDef;\n\t\ttry {\n\t\t\tif (appDef) {\n\t\t\t\t//L'app actuelle peut-elle prendre en charge cet appDef.\n\t\t\t\tif (this._app && this._app.updateAppDef(appDef)) return;\n\t\t\t\t//On cherche un appBuilder compatible\n\t\t\t\tfor (const bd of this._appBuilders) {\n\t\t\t\t\tif (bd.isAppDefMatch(appDef)) {\n\t\t\t\t\t\tif (!await this.setMainApp(await bd.loadBody({\n\t\t\t\t\t\t\treg: REG.reg,\n\t\t\t\t\t\t\tappDef,\n\t\t\t\t\t\t\tlastDatas: useLD && useLD.appDef && bd.isAppDefMatch(useLD.appDef) ? useLD.appLD : null,\n\t\t\t\t\t\t\thasHeadTitleBar: true\n\t\t\t\t\t\t}))) {\n\t\t\t\t\t\t\tlet fbApp = appDef.fbApp;\n\t\t\t\t\t\t\twhile (fbApp) {\n\t\t\t\t\t\t\t\tif (await this.setMainAppDef(fbApp))\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\tfbApp = fbApp.fbApp;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthrow \"\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (useLD && useLD.appDef) {\n\t\t\t\t\t//Pas trouvé, on recherche la app des lastDatas\n\t\t\t\t\tfor (const bd of this._appBuilders) {\n\t\t\t\t\t\tif (bd.isAppDefMatch(useLD.appDef)) {\n\t\t\t\t\t\t\tif (!await this.setMainApp(await bd.loadBody({\n\t\t\t\t\t\t\t\treg: REG.reg,\n\t\t\t\t\t\t\t\tappDef: useLD.appDef,\n\t\t\t\t\t\t\t\tlastDatas: useLD.appLD,\n\t\t\t\t\t\t\t\thasHeadTitleBar: true\n\t\t\t\t\t\t\t}))) throw \"\";\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t//Rien trouvé, on tente la defaultAppBuilder.\n\t\t\tif (this._defaultAppBuilder) {\n\t\t\t\tif (!await this.setMainApp(await this._defaultAppBuilder.loadBody({\n\t\t\t\t\treg: REG.reg,\n\t\t\t\t\tappDef: appDef || {},\n\t\t\t\t\thasHeadTitleBar: true\n\t\t\t\t}))) throw \"\";\n\t\t\t} else {\n\t\t\t\tif (await this.closeMainApp() === false) throw \"\";\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t//Echec à la mise à jour de l'app => on restaure le précédent hash\n\t\t\tawait ERROR.log(\"Failed to load app\", e);\n\t\t\tthis.updateUrlHash();\n\t\t}\n\t}\n\n\t/**\n\t * Méthode publique commune à Tout AppFrameXxxDeskFeat.\n\t * Permet d'adapter l'ouverture de l'app en fonction de l'AppFrame.\n\t *\n\t * @param options Options d'affichage\n\t */\n\tasync findAndOpenApp(appDef: JAppDef, ev?: Event, options?: any): Promise<boolean> {\n\t\tfor (const bd of this._appBuilders) {\n\t\t\tif (bd.isAppDefMatch(appDef)) {\n\t\t\t\tconst nmAppDef: JAppDef = {};\n\t\t\t\tObject.assign(nmAppDef, appDef);\n\t\t\t\tif (\"normalizeAppDef\" in bd) bd.normalizeAppDef(nmAppDef);\n\t\t\t\tif ((ev instanceof MouseEvent || ev instanceof KeyboardEvent) && ACTION.isAccelPressed(ev)) {\n\t\t\t\t\tconst url = new URL(document.location.href);\n\t\t\t\t\turl.hash = CDM.stringify(nmAppDef);\n\t\t\t\t\twindow.open(url.href, \"_blank\");\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tawait this.setMainApp(await bd.loadBody({reg: REG.reg, appDef: nmAppDef, hasHeadTitleBar: true}));\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Méthode publique commune à Tout AppFrameXxxDeskFeat.\n\t *\n\t * @param options Options d'affichage\n\t */\n\tasync openApp(appBuilder: IAppBuilder<any, any>, appDef: JAppDef, options?: any) {\n\t\tawait this.setMainApp(await appBuilder.loadBody({reg: REG.reg, appDef, hasHeadTitleBar: true}));\n\t}\n\n\tprotected fAppIniting: Promise<boolean>;\n\n\tprotected async setMainApp<ENV>(app: IApp<ENV>): Promise<boolean> {\n\t\tif (this.fAppIniting) this.fAppIniting = (this.fAppIniting as any).finally(() => this.fAppIniting = this.setMainAppChained(app));\n\t\telse this.fAppIniting = this.setMainAppChained(app);\n\t\treturn this.fAppIniting;\n\t}\n\n\tprotected async setMainAppChained<ENV>(app: IApp<ENV>): Promise<boolean> {\n\t\tif (this.mainCtn && (this._auth.currentUser || app.anonymousAllowed)) {\n\t\t\tconst oldApp = this._app;\n\t\t\tif (oldApp && await (oldApp === app ? this.hideMainApp() : this.closeMainApp()) === false) return false;\n\t\t\tthis._app = this.mainCtn.appendChild(app);\n\t\t\tVIEWS.onViewShown(app);\n\t\t\tawait this._app.initializedAsync;\n\t\t\tthis.refreshTitle();\n\t\t\tthis.updateUrlHash();\n\t\t\tif (this._app !== app || this._app.appErrorStatus != null) return false;\n\t\t} else {\n\t\t\tthis._app = app; //en attente...\n\t\t}\n\t\treturn true;\n\t}\n\n\tasync gotoHome(): Promise<boolean> {\n\t\tif (this._defaultAppBuilder) {\n\t\t\treturn this.setMainApp(await this._defaultAppBuilder.loadBody({reg: REG.reg, appDef: {}, hasHeadTitleBar: true}));\n\t\t} else {\n\t\t\tconst ok = await this.closeMainApp();\n\t\t\tif (ok) this.updateUrlHash();\n\t\t\treturn ok;\n\t\t}\n\t}\n\n\t/**\n\t * @param replace Pas d'historique. cf https://developer.mozilla.org/en-US/docs/Web/API/Location/replace\n\t */\n\tprotected updateUrlHash(replace?: boolean) {\n\t\tif (UrlHashObjDeskFeat.isIn(desk)) {\n\t\t\ttry {\n\t\t\t\tthis._updtHashFromHere = true;\n\t\t\t\tdesk.setUrlHash(this._app ? this._app.appDef : null, replace);\n\t\t\t} finally {\n\t\t\t\tthis._updtHashFromHere = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected _updtHashFromHere: boolean;\n\n\tisMainAppAvailable() {return this._app != null}\n\n\t/** Masque l'app courante SANS la clore. */\n\tasync hideMainApp(force?: boolean): Promise<boolean | undefined> {\n\t\tconst app = this._app;\n\t\tconst wasAlive = app && app.isConnected;\n\t\tif (wasAlive && !force && !(await VIEWS.canHideView(app))) return false;\n\t\tif (!await POPUP.closeAllPopup(app)) return false;\n\t\tif (this._app !== app) return undefined; //race cond, autre app affectée entre temps.\n\t\tthis.mainCtn.textContent = null;\n\t\tif (wasAlive) VIEWS.onViewHidden(app);\n\t\treturn true;\n\t}\n\n\t/** Retourne l'app courante. */\n\tpublic getMainApp(): IApp<any> | null {\n\t\treturn this._app;\n\t}\n\n\t/**\n\t * Clos l'app courante. Attention, url non mise à jour.\n\t * @return true si plus d'app courante. false si refus. undefined si race condition.\n\t */\n\tprotected async closeMainApp(force?: boolean): Promise<boolean | undefined> {\n\t\tconst app = this._app;\n\t\tif (app) {\n\t\t\ttry {\n\t\t\t\tif (!force && app.isConnected && !(await VIEWS.canHideView(app))) return false;\n\t\t\t\tif (!await POPUP.closeAllPopup(app)) return false;\n\t\t\t\tif (this._app !== app) return undefined; //race cond, autre app affectée entre temps.\n\t\t\t\tthis._app = null;\n\t\t\t\tthis.mainCtn.textContent = null;\n\t\t\t\tVIEWS.onViewHidden(app, true);\n\t\t\t\tthis.refreshTitle();\n\t\t\t} catch (e) {\n\t\t\t\t//pour ne pas bloquer l'ouverture d'une autre app.\n\t\t\t\tconsole.log(e);\n\t\t\t}\n\t\t} else {\n\t\t\tthis.mainCtn.textContent = null;\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Recharge l'app courante (changement de contexte, de pref user...)\n\t */\n\tasync reloadMainApp(force?: boolean): Promise<boolean> {\n\t\tconst appDef = this._app?.appDef;\n\t\tif (appDef && await this.closeMainApp(force)) return this.findAndOpenApp(appDef);\n\t\treturn false;\n\t}\n\n\tshowInfo(text: string) {\n\t\t// if (this.statusBar) {\n\t\t// \tthis.statusBar.setStatus(text);\n\t\t// } else {\n\t\tPOPUP.showNotif(text, document.body);\n\t\t//}\n\t}\n\n\trefreshTitle() {\n\t\tconst appTitle = this._app ? VIEWS.getLabel(this._app) : null;\n\t\tdocument.title = appTitle ? appTitle + \" - \" + this.initialTitle : this.initialTitle;\n\t\tif (typeof this._app?.getHeadTitleBar === \"function\") {\n\t\t\tconst bar = this._app.getHeadTitleBar();\n\t\t\tif (this.appBar.firstElementChild !== bar) {\n\t\t\t\tthis.appBar.textContent = null;\n\t\t\t\tif (bar) this.appBar.appendChild(bar);\n\t\t\t}\n\t\t} else {\n\t\t\tthis.appBar.textContent = null;\n\t\t\tthis.appBar.append(<div class=\"appTitle\">{appTitle}</div>);\n\t\t}\n\t\tif (Desk.electron) window.postMessage({type: \"client:server:refreshTitle\", appTitle, initialTitle: this.initialTitle}, location.origin);\n\t}\n\n\tstatic async requestFullscreen() {\n\t\tif (Desk.electron) {\n\t\t\tconst exitButton = new Button().initialize({ uiContext: \"dialog\", label: \"Quitter le mode plein-écran (Échap)\" });\n\t\t\tconst notif = POPUP.showNotifInfo(<p><span>L'application est désormais en mode plein écran.</span>{exitButton}</p>, document.body, null, {viewPortY: \"top\"});\n\t\t\texitButton.addEventListener('click', async () => {\n\t\t\t\tnotif.close();\n\t\t\t\tawait document.exitFullscreen();\n\t\t\t}, { once: true });\n\t\t}\n\t\tawait document.body.requestFullscreen();\n\t}\n\n\tinitialTitle: string;\n\n\tprotected header: HTMLElement;\n\tprotected mainBar: HTMLElement;\n\tprotected appBar: HTMLElement;\n\tprotected mainCtn: HTMLElement;\n\n\tprotected _appBuilders: IAppBuilder<any, any>[];\n\tprotected _defaultAppBuilder: IAppBuilder<any, any>;\n\n\tprotected _auth: AuthSrv;\n\n\t/** app courante (affichée ou non) */\n\tprotected _app: IApp<any> | null;\n}\n\nfunction refreshOffline() {(window.desk as AppFrameDeskFeat).refreshErr()}\n\n/** Options de AppFrameDeskFeat. */\ninterface OAppFrameDeskFeatOptions {\n\ticonUrl?: string,\n\tauthReg: IReg<IUniverseEnv>\n}\n\n/** Options de AppDesk. */\ninterface OAppFrameOptions {\n\tappName?: string\n}\n\ninterface JLDAppFrame {\n\tappDef: JAppDef\n\tappLD: JLastDatas\n}\n\nexport interface JMaintenanceMsg {\n\tsvc: \"liaise\"\n\ttype: \"maintenance\"\n\tmsg?: string\n\tuntil?: number\n\topType?: \"update\" | \"shutdown\" | \"restart\" /* Compat XUL */\n}\n\n\nREG.reg.registerSkin('appFrame', 1, /* language=CSS */ `\n\tbody {\n\t\tmargin: 0;\n\t\tpadding: 0;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\theight: 100vh;\n\t\toverflow: hidden;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--focus-outline);\n\t}\n\n\theader {\n\t\tdisplay: flex;\n\t\tmin-height: auto;\n\t\tmin-width: 0;\n\t\tflex-wrap: wrap;\n\t\talign-items: center;\n\t\tbackground-color: var(--page-bgcolor);\n\t\tbox-shadow: 0 3px 3px rgba(0, 0, 0, 0.2);\n\t\tz-index: 1;\n\t}\n\n\t#appBar {\n\t\tflex: 1 0 auto;\n\t\talign-self: stretch;\n\t\tdisplay: flex;\n\t\tmin-width: 0;\n\t\tmin-height: 0;\n\t\talign-items: center;\n\t}\n\n\t.appTitle {\n\t\tfont-weight: bold;\n\t\tmargin-inline: .3em;\n\t\tuser-select: none;\n\t}\n\n\t#fullscreen {\n\t\tmin-width: max-content;\n\t\tborder: none;\n\t\tborder-radius: 0;\n\t\tmargin: 0 .3em;\n\t\t--bgcolor: transparent;\n\t\talign-self: stretch;\n\t\tfont-size: 80%;\n\t}\n\n\tc-loggeduser {\n\t\t--label-size: 1rem;\n\t\tmargin: 0 .3em;\n\t\t--user-icon: url('/@skin@/core/actions/portalbar/user.svg');\n\t}\n\n\t#loggedUserBox {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\talign-self: stretch;\n\t}\n\n\t.headband {\n\t\twhite-space: pre;\n\t}\n\n\tmain {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\tbody:fullscreen {\n\t\tbackground-color: var(--bgcolor);\n\t}\n\n\tbody:fullscreen > header, body:fullscreen > hr {\n\t\tdisplay: none;\n\t}\n`);\n\n\nREG.reg.registerSkin('appFrame/mainBar', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: auto;\n\t\tmin-width: 0;\n\t\tflex-wrap: wrap;\n\t\talign-items: center;\n\t\talign-self: stretch;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--focus-outline);\n\t}\n\n\t[hidden] {\n\t\tdisplay: none !important;\n\t}\n\n\t#home {\n\t\talign-self: stretch;\n\t\tfont-size: 1rem;\n\t}\n\n\t#logo {\n\t\tflex: 0 0 auto;\n\t\tdisplay: flex;\n\t\tmin-width: fit-content;\n\t\tmin-height: auto;\n\t\talign-items: center;\n\t\tmargin-inline-end: .5em;\n\t\tpadding: .1em;\n\t\tborder-radius: .3em;\n\t\tbackground-color: #FFF;\n\t}\n\n\t#logo > img {\n\t\tmax-height: 2em;\n\t}\n\n\t#portalTi {\n\t\tflex: 0 0 auto;\n\t\tdisplay: flex;\n\t\tmin-width: 0;\n\t\tmin-height: 0;\n\t\tfont-weight: bold;\n\t}\n\n\t#headerActions {\n\t\tdisplay: flex;\n\t\tmin-height: min-content;\n\t\tmin-width: 0;\n\t\tflex-flow: wrap;\n\t\talign-self: stretch;\n\t\tborder-inline: 1px solid var(--border-color);\n\t}\n\n\t#headerActions > c-action {\n\t\tmin-width: max-content;\n\t\tborder: none;\n\t\tborder-radius: 0;\n\t\tmargin: 0 .3em;\n\t\talign-self: stretch;\n\t\tfont-size: 80%;\n\t}\n\n\t#collapseActions {\n\t\talign-self: stretch;\n\t\tpadding: 0;\n\t\tborder: none;\n\t}\n\n  #collapseActions[aria-pressed=\"true\"],\n  #collapseActions:lang(ar) {\n\t  transform: scaleX(-1);\n\t  background-color: unset;\n  }\n\n  #collapseActions[aria-pressed=\"false\"]:lang(ar) {\n\t  transform: none;\n  }\n\n  hr {\n\t  border-top: 1px solid var(--border-color);\n\t  border-inline-start: 1px solid var(--border-color);\n\t  border-inline-end: none;\n\t  border-bottom: none;\n\t  margin: .2rem;\n\t  align-self: stretch;\n  }\n`);\n\n/**\n * Feature du desk pour le choix entre le menu contextuel custom (applicatif) vs le menu du navigateur.\n * main : le menu applicatif est affiché en 1er, le menu du navigateur en secondaire accessible via shift + click droit par ex.\n * secondary : le menu du navigateur est affiché en 1er\n */\nexport class ContextMenuDeskFeat extends Desk {\n\n\tstatic add(desk: Desk, mode?: \"main\" | \"secondary\", reg: IReg<IBasicUniversePointer> = REG.reg): ContextMenuDeskFeat {\n\t\tif (this.isIn(desk)) return desk;\n\t\tconst d = desk as ContextMenuDeskFeat;\n\t\tdesk.assignProps(this);\n\t\td.setContextMenuCustom(mode);\n\n\t\tdocument.body.addEventListener(Desk.electron ? \"c-contextmenu\" : \"contextmenu\", d.showContextMenu);\n\t\tREG.reg.addToList(Desk.LIST_accelKeys, \" -accel\", 1, new Action<any>('contextMenu').setExecute(function (c, ev) {\n\t\t\td.showContextMenu.call(document.body, ev);\n\t\t}));\n\n\t\tREG.reg.addToList(Desk.LC_init, 'contextMenu', 1, () => {\n\t\t\t//Recherche du AuthServer\n\t\t\tconst univ = reg.env.universe;\n\t\t\tconst auth = univ ? univ.auth : null;\n\t\t\tif (auth) {\n\t\t\t\tif (auth.currentAuthenticatedUser) d.setContextMenuCustom(reg.getUserData(\"contextMenu\"));\n\t\t\t\tauth.listeners.on(\"loggedUserChanged\", () => {\n\t\t\t\t\td.setContextMenuCustom(reg.getUserData(\"contextMenu\"));\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\t// Désactivation du comportement par défaut du shift+clic droit qui augmente la sélection textuelle jusqu'au curseur et empêche la correction orthographique\n\t\tdocument.body.addEventListener(\"mousedown\", (ev) => {\n\t\t\tif (ev.button == 2 && ev.shiftKey) ev.preventDefault();\n\t\t});\n\t\treturn d;\n\t}\n\n\tstatic isIn(desk: Desk): desk is ContextMenuDeskFeat {return 'contextMenuCustom' in desk}\n\n\tcontextMenuCustom: \"main\" | \"secondary\" = \"main\";\n\n\tsetContextMenuCustom(mode?: \"main\" | \"secondary\") {\n\t\tthis.contextMenuCustom = mode !== \"secondary\" || Desk.electron ? \"main\" : mode;\n\t}\n\n\t/** Appelé sur les events \"contextmenu\" (XXX à revoir : et \"keydown\"). */\n\tshowContextMenu(this: HTMLElement, ev: MouseEvent & CustomEvent) {\n\t\tif (ev instanceof MouseEvent) {\n\t\t\tif ((desk as ContextMenuDeskFeat).contextMenuCustom === \"main\") {\n\t\t\t\t//On laisse le menu contextuel natif sur shift + clickDroit\n\t\t\t\tif (ev.shiftKey) return;\n\t\t\t} else {\n\t\t\t\t//On affiche notre menu que sur shift + clickDroit\n\t\t\t\tif (!ev.shiftKey) return;\n\t\t\t}\n\t\t\tev.preventDefault();\n\t\t}\n\t\tlet node = DOMSH.findDeepActiveElement(DOMSH.findDocumentOrShadowRoot(this));\n\t\twhile (node && node !== this) {\n\t\t\tif ('ctxMenuActions' in node) {\n\t\t\t\tconst menu = (node as IContextMenuActionsPointer<any>).ctxMenuActions;\n\t\t\t\tif (menu && menu.actions && menu.actions.length > 0) {\n\t\t\t\t\tlet anchor: OPopupAnchor;\n\t\t\t\t\tif ('pageX' in ev && ev.which > 0/* bloque si menu contextuel par clavier*/) {\n\t\t\t\t\t\tanchor = {\n\t\t\t\t\t\t\tinitX: menu.rect ? GFX.bound(menu.rect.left, ev.pageX, menu.rect.right) : ev.pageX,\n\t\t\t\t\t\t\tinitY: menu.rect ? GFX.bound(menu.rect.top, ev.pageY, menu.rect.bottom) : ev.pageY\n\t\t\t\t\t\t};\n\t\t\t\t\t} else if (menu.rect) {\n\t\t\t\t\t\tanchor = {\n\t\t\t\t\t\t\tinitX: menu.rect.left,\n\t\t\t\t\t\t\tinitY: menu.rect.bottom\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst focused = DOMSH.findDeepActiveElement() || ev.target as Element;\n\t\t\t\t\t\tanchor = {\n\t\t\t\t\t\t\tposFrom: focused, intersectWith: DOMSH.findFlatParentElt(focused, null, (n: Node): n is HTMLElement => {\n\t\t\t\t\t\t\t\t//FIXME pas satisfaisant\n\t\t\t\t\t\t\t\treturn n instanceof HTMLElement ? n.scrollHeight > n.clientHeight : false;\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\t//console.log(\"here::::::::::::::::::\", anchor, menu.rect, ev);\n\t\t\t\t\tconst from = DOMSH.findDeepActiveElement() as HTMLElement;\n\n\t\t\t\t\tif (Desk.electron) {\n\t\t\t\t\t\t// Enrichissement du actionContext par les informations de corrections ortho dans l'event c-contextmenu spécifique à Electron\n\t\t\t\t\t\tif (ev.detail && ev.detail.misspelledWord) {\n\t\t\t\t\t\t\tmenu.actionContext[ACTION.spellcheckSymbol] = {\n\t\t\t\t\t\t\t\tmisspelledWord: ev.detail.misspelledWord,\n\t\t\t\t\t\t\t\tdictionarySuggestions: ev.detail.dictionarySuggestions,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdelete menu.actionContext[ACTION.spellcheckSymbol];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn POPUP.showPopupActions({\n\t\t\t\t\t\tactions: menu.actions,\n\t\t\t\t\t\tactionContext: menu.actionContext,\n\t\t\t\t\t\trestoreFocus: from\n\t\t\t\t\t}, anchor, from || ev.target as Node);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tnode = DOMSH.findParentElt(node);\n\t\t}\n\t}\n}\n\n\n/**\n * Ajoute la feature d'eval en amont du chargement de l'application si le navigateur implémente le standard Sec-Fetch-*.\n * Si le standard n'est pas implémenté:\n * - affiche un message d'erreur à l'utilisateur dans la page principale (comportement surchargeable),\n * - interrompt le processus d'init de la page.\n */\nexport class SecFetchDeskFeat extends Desk {\n\n\t/** Peut être ajouté après desk.launch(). */\n\tstatic add(desk: Desk): SecFetchDeskFeat {\n\t\tif (this.isIn(desk)) return desk;\n\t\tdesk.assignProps(this);\n\t\tconst d = desk as SecFetchDeskFeat;\n\n\t\t//En 1er : check de sécurité si le navigateur implémente Sec-Fetch-*\n\t\tREG.reg.addToList(Desk.LC_init, 'checkSecFetch', 1, async () => {\n\t\t\tlet secFetchAware: boolean;\n\t\t\ttry {\n\t\t\t\tsecFetchAware = await d.checkSecFetchSiteAware();\n\t\t\t} catch (e) {\n\t\t\t\t//Accès au serveur impossible\n\t\t\t\td.showErrorInfo(d.getNoNetworkMsg());\n\t\t\t\t//On interrompt le processus de téléchargement.\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t\tif (!secFetchAware) {\n\t\t\t\td.showErrorInfo(d.getNoSecFetchMsg());\n\t\t\t\t//On interrompt le processus de téléchargement.\n\t\t\t\tthrow Error(\"Sec-Fetch standard not available in this browser\");\n\t\t\t}\n\t\t}, -100000);\n\t\treturn d;\n\t}\n\n\tstatic isIn(desk: Desk): desk is SecFetchDeskFeat {return 'checkSecFetchSiteAware' in desk}\n\n\tasync checkSecFetchSiteAware(): Promise<boolean> {\n\t\treturn (REG.reg.env as IBasicUniversePointer).universe.isSecFetchSiteAware();\n\t}\n\n\tshowErrorInfo(elt: HTMLElement) {\n\t\tdocument.body.textContent = null;\n\t\tdocument.body.append(elt);\n\t}\n\n\tgetNoSecFetchMsg() {\n\t\treturn <main>\n\t\t\t<h2>Votre navigateur est incompatible avec ce service</h2>\n\t\t\t<p>Votre navigateur n'assume pas une fonction nécessaire à la sécurité de ce service : <a href=\"https://w3c.github.io/webappsec-fetch-metadata\">Fetch Metadata Request Headers</a></p>\n\t\t\t<p>Voici une liste de navigateurs connus qui dans leurs dernières versions sont compatibles avec ce service :</p>\n\t\t\t<ul>\n\t\t\t\t{Desk.knownNavCompat.map((v) => v.url ? <li><a href={v.url}>{v.name}</a></li> : <li>{v.name}</li>)}\n\t\t\t</ul>\n\t\t</main>;\n\t}\n\n\tgetNoNetworkMsg() {\n\t\treturn <main>\n\t\t\t<h2>Serveur inaccessible</h2>\n\t\t\t<p>Le serveur ne semble pas accessible. Vérifiez votre connexion et essayez ultérieurement.</p>\n\t\t</main>;\n\t}\n}\n\n/** IHM par défaut en cas d'opération de maintenance en cours des serveurs. */\nlet currentMaintenanceDialog: IPopupable;\nREG.reg.registerSvc(\"maintenanceCb\", 1, function (universe: BasicUniverse, msg: { lang: string, label: string }[]) {\n\tif (!currentMaintenanceDialog) {\n\t\tcurrentMaintenanceDialog = POPUP.showDialog(<section style=\"margin:.5em\">\n\t\t\t<p>{msg[0].label}</p>\n\t\t\t<Button î={{label: \"Fermer\", uiContext: \"dialog\"} as OButtonInit} onclick={function (this: Button) {POPUP.findPopupableParent(this).close()}}/>\n\t\t</section>, document.body, {titleBar: {barLabel: {label: \"Opérations de maintenance en cours\"}}});\n\t\tcurrentMaintenanceDialog.onNextClose().then(() => {\n\t\t\tcurrentMaintenanceDialog = null;\n\t\t});\n\t}\n} as IMaintenanceCb);"]}