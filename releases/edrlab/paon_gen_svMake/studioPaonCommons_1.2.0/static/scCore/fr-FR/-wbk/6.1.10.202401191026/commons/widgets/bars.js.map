{"version":3,"sources":["/@back@/commons/widgets/bars.tsx"],"names":["ActionableList","ACTIONABLES","IS_Actionable","IS_ActionableEnabled","BaseElement","BASIS","isEltRefreshable","ActionBtn","ActionSeparator","REG","isRefreshHook","DOM","JSX","DOMSH","Actionables","[object Object]","action","buildButton","this","_actionContext","uiContext","customElements","define","BarActions","vertical","classList","contains","init","super","_initialize","sr","attachShadow","SHADOWDOM_INIT","ctn","appendChild","createElement","addEventListener","onKeydown","overrideButtonsElts","disableFullOverlay","_initAndInstallSkin","onMouseDown","onMouseEnter","onMouseLeave","onFocusIn","onFocusOut","btn","slot","ch","lastElementChild","offsetWidth","offsetLeft","addClass","offsetHeight","offsetTop","ev","target","stopImmediatePropagation","preventDefault","isLogicalFlatAncestor","findHost","findDeepActiveElement","removeClass","evalShowFull","shadowRoot","querySelector","relatedTarget","blur","removeEventListener","key","moveFocus","forward","composedPath","parentNode","next","findNextSibling","findPreviousSibling","focus","reg","registerSkin","BarShared","actionContext","startActions","endActions","focusListening","localName","_startBar","id","length","_createEndBar","_requestIdleBinded","_requestIdle","bind","buildInitFromAtts","findReg","hasAttribute","getList","extractAttr","getSvc","connectedCallback","add","elt","lstn","_onEventsBinded","_onEvents","Array","isArray","rem","_refreshPlanned","window","requestIdleCallback","CustomEvent","focusActionables","detail","planRefresh","type","node","deadline","timeRemaining","refresh","barShared","textContent","onRefreshCycle","nextTag","firstElementChild","i","nextElementSibling","b","_createButton","insertBefore","actionable","toRem","remove","cleanupDoubleSep","_endBar","BarStatus","_textCtn","document","status"],"mappings":"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","sourcesContent":["import {ActionableList, ACTIONABLES, IActionable, IFocusActionables, IS_Actionable, IS_ActionableEnabled, OActionableListInit} from \"back/commons/actionables\";\nimport {BaseElement, BASIS, isEltRefreshable, OSkinableInit} from \"back/commons/basis\";\nimport {ActionBtn} from \"back/commons/widgets/buttons\";\nimport {Action, ActionSeparator, IAction} from \"lib/commons/actions\";\nimport {REG} from 'lib/commons/registry';\nimport {isRefreshHook} from \"lib/commons/utils/signboard\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\n\n/**\n * List actions, ie toolbar d'actions sans shadow-dom, sans gestion d'overflow.\n */\nexport interface Actionables<C> extends ActionableList<C> {\n\tinitialize(init: OActionableListInit<C>): this;\n}\n\nexport class Actionables<C> extends ActionableList<C> {\n\tprotected _createButton(action: IAction<C>): Element {\n\t\treturn ActionBtn.buildButton(action, this._actionContext, this.uiContext, this);\n\t}\n}\n\ncustomElements.define('c-actionables', Actionables);\n\n\n/**\n * Toolbar simple d'actions.\n *\n * Attributes : cf ActionableList +\n * - Config init attribute : \"ui-context\" -> OBarActionsInit.uiContext\n * - class=\"vertical\"\n */\nexport interface BarActions<C> extends ActionableList<C> {\n\tinitialize(init: OBarActionsInit<C>): this;\n}\n\nexport interface OBarActionsInit<C> extends OActionableListInit<C> {\n\tdisableFullOverlay?: boolean\n\toverrideButtonsElts?: (button: Element) => void\n}\n\nexport class BarActions<C> extends ActionableList<C> {\n\n\tget vertical(): boolean {return this.classList.contains(\"vertical\")}\n\n\toverrideButtonsElts?: (button: Element) => void\n\n\tprotected _initialize(init: OBarActionsInit<C>) {\n\t\tsuper._initialize(init);\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tconst ctn = sr.appendChild(<slot/>);\n\t\tthis.addEventListener('keydown', this.onKeydown);\n\t\tthis.overrideButtonsElts = init.overrideButtonsElts;\n\t\tif (init.disableFullOverlay) {\n\t\t\tthis._initAndInstallSkin('c-bar-actions/disableFullOverlay', init);\n\t\t} else {\n\t\t\tctn.addEventListener('mousedown', this.onMouseDown);\n\t\t\tctn.addEventListener('mouseenter', this.onMouseEnter);\n\t\t\tctn.addEventListener('mouseleave', this.onMouseLeave);\n\t\t\tthis.addEventListener('focusin', this.onFocusIn);\n\t\t\tthis.addEventListener('focusout', this.onFocusOut);\n\t\t\tthis._initAndInstallSkin('c-bar-actions', init);\n\t\t}\n\t}\n\n\tprotected _createButton(action: Action): Element {\n\t\tconst btn = ActionBtn.buildButton(action, this._actionContext, this.uiContext, this);\n\t\tif (btn && this.overrideButtonsElts) this.overrideButtonsElts(btn);\n\t\treturn btn;\n\t}\n\n\tprotected evalShowFull(slot: HTMLSlotElement, ch = this.lastElementChild as HTMLElement) {\n\t\tif (this.vertical) {\n\t\t\tif (ch && this.offsetWidth < ch.offsetLeft + ch.offsetWidth - 2) DOM.addClass(slot, 'show');\n\t\t} else {\n\t\t\tif (ch && this.offsetHeight < ch.offsetTop + ch.offsetHeight - 2) DOM.addClass(slot, 'show');\n\t\t}\n\t}\n\n\tprotected onMouseDown(this: HTMLSlotElement, ev: MouseEvent) {\n\t\tif (this === ev.target) {\n\t\t\t//Evite de perdre le focus de la toolbar si click à coté d'un bouton.\n\t\t\tev.stopImmediatePropagation();\n\t\t\tev.preventDefault();\n\t\t}\n\t}\n\n\tprotected onMouseLeave(this: HTMLSlotElement) {\n\t\t//Si le focus est dans notre descendance logique, on garde la barre étendue: C'est le blur qui la refermera.\n\t\tif (DOMSH.isLogicalFlatAncestor(DOMSH.findHost(this), DOMSH.findDeepActiveElement())) return;\n\t\tDOM.removeClass(this, 'show');\n\t}\n\n\tprotected onMouseEnter(this: HTMLSlotElement) {\n\t\t(DOMSH.findHost(this) as BarActions<C>).evalShowFull(this);\n\t}\n\n\tprotected onFocusIn(ev: FocusEvent) {\n\t\tthis.evalShowFull(this.shadowRoot.querySelector('slot') as HTMLSlotElement /*, ev.target as HTMLElement on passe en mode 'show' quelquesoit le btn fosusé. */);\n\t}\n\n\tprotected onFocusOut(ev: FocusEvent) {\n\t\tif (ev.relatedTarget && DOMSH.isLogicalFlatAncestor(this, ev.relatedTarget as Node)) {\n\t\t\t//Focus dans un widget interne à cette barre, on transfert l'écoute du blur.\n\t\t\tconst blur = (ev: FocusEvent) => {\n\t\t\t\tev.target.removeEventListener('blur', blur);\n\t\t\t\tthis.onFocusOut(ev);\n\t\t\t};\n\t\t\tev.relatedTarget.addEventListener('blur', blur);\n\t\t\treturn;\n\t\t}\n\t\tDOM.removeClass(this.shadowRoot.querySelector('slot'), 'show');\n\t}\n\n\tprotected onKeydown(ev: KeyboardEvent) {\n\t\tif (this.vertical) {\n\t\t\tswitch (ev.key) {\n\t\t\tcase 'ArrowUp':\n\t\t\t\tthis.moveFocus(ev, false);\n\t\t\t\tbreak;\n\t\t\tcase 'ArrowDown':\n\t\t\t\tthis.moveFocus(ev, true);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\t//TODO  RTL ?\n\t\t\tswitch (ev.key) {\n\t\t\tcase 'ArrowLeft':\n\t\t\t\tthis.moveFocus(ev, false);\n\t\t\t\tbreak;\n\t\t\tcase 'ArrowRight':\n\t\t\t\tthis.moveFocus(ev, true);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected moveFocus(ev: KeyboardEvent, forward: boolean) {\n\t\tconst target = ev.composedPath()[0] as Node;\n\t\tif (target.parentNode === this) {\n\t\t\tconst next = forward ? DOM.findNextSibling(target, IS_ActionableEnabled) : DOM.findPreviousSibling(target, IS_ActionableEnabled);\n\t\t\tif (next) {\n\t\t\t\tev.stopImmediatePropagation();\n\t\t\t\tnext.focus();\n\t\t\t}\n\t\t}\n\t}\n\n}\n\nREG.reg.registerSkin('c-bar-actions', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: calc(6px + var(--icon-size));\n\t\tmin-width: 0;\n\t\talign-items: center;\n\t\tposition: relative;\n\t}\n\n\t:host(.vertical) {\n\t\tmin-width: calc(6px + var(--icon-size));\n\t\tmin-height: 0;\n\t\tflex-direction: column;\n\t}\n\n\tslot {\n\t\tposition: relative;\n\t\toverflow: hidden;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tmax-height: calc(6px + var(--icon-size));\n\t\tflex-wrap: wrap;\n\t\tflex: 1;\n\t}\n\n\t:host(.vertical) > slot {\n\t  flex-direction: column;\n\t  max-height: unset;\n\t  max-width: calc(6px + var(--icon-size));\n  }\n\n  slot.show {\n\t  position: absolute;\n\t  top: 0;\n\t  left: 0;\n\t  overflow: visible;\n\t  bottom: unset;\n\t  z-index: 100;\n\t  max-height: unset;\n\t  background-color: var(--bgcolor); /* on doit écraser ce qui est en dessous. */\n\t  border: 1px solid var(--border-color);\n\t  box-shadow: 1px 1px 6px var(--fade-color);\n  }\n\n  ::slotted(hr) {\n\t  border-top: 1px solid var(--border-color);\n\t  border-inline-start: 1px solid var(--border-color);\n\t  border-inline-end: none;\n\t  border-bottom: none;\n\t  margin: .2rem;\n\t  align-self: stretch;\n  }\n`);\n\n\nREG.reg.registerSkin('c-bar-actions/disableFullOverlay', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: calc(6px + var(--icon-size));\n\t\tmin-width: 0;\n\t\tflex-wrap: wrap;\n\t\talign-items: center;\n\t}\n\n\t:host(.vertical) {\n\t\tflex-direction: column;\n\t\tmin-height: 0;\n\t\tmin-width: calc(6px + var(--icon-size));\n\t}\n\n\t::slotted(hr) {\n\t\tborder-top: 1px solid var(--border-color);\n\t\tborder-inline-start: 1px solid var(--border-color);\n\t\tborder-inline-end: none;\n\t\tborder-bottom: none;\n\t\tmargin: .2em;\n\t\talign-self: stretch;\n\t}\n`);\n\ncustomElements.define('c-bar-actions', BarActions);\n\n\n/**\n * Barre d'outils partagée comportant :\n * - une liste d'actions \"fixes\" au début,\n * - une liste d'actions contextuelles liées au focus courant. Placés à la suite de la 1ère liste,\n *    les dernières actions sont masquées par défaut en cas d'espace insuffisant.\n * - une liste d'actions \"fixes\" à la fin, utilisés pour mettre un bouton d'otions et/ou un bouton \"close\". Ces\n *    actions sont prioritaires sur l'affichage des 2 précédentes listes.\n *\n * La liste d'actions contextuelles est obtenue via l'écoute d'events DOM sur un ou plusieurs autres éléments DOM.\n * ATTENTION : La BarShared DOIT se trouver dans le même arbre DOM que le(s) noeud(s) écouté(s) (ie pas dans un shadow).\n * Trois events sont écoutés :\n * - 'focusin' : partant du target de l'event, un élément ancêtre fournissant une liste de boutons via OFocusActionables est recherché.\n * - 'c-focus-actions' : CustomEvent permetant de forcer un refresh des focus-actions de la barre. CustomEvent.detail doit être un OFocusActionables\n *      ou null pour forcer un effacement.\n * - 'focusout' : reset les focus-actions jusqu'au prochain 'focusin' ou 'c-focus-actions'.\n *\n * Attributes : cf BaseElement +\n * Config init attributes: start-actions, end-actions, action-context\n */\nexport interface BarShared<C> extends BaseElement {\n\tinitialize(init?: OBarSharedInit<C>): this\n}\n\nexport interface OBarSharedInit<C> extends OSkinableInit {\n\t/** List des actions fixes au début. */\n\tstartActions?: Action<C>[]\n\n\t/** List des actions fixes en fin de toolbar. */\n\tendActions?: Action<C>[]\n\n\t/** ActionContext pour les actions fixes en début et fin. */\n\tactionContext?: C\n\n\t/** Noeuds racines sur lesquels écouter les events 'focusin', 'focusout' et 'c-focus-actions'. */\n\tfocusListening?: HTMLElement | HTMLElement[]\n}\n\nexport class BarShared<C> extends BaseElement {\n\tstartActions: Action<C>[];\n\n\tendActions: Action<C>[];\n\n\tactionContext: C;\n\n\tfocusListening?: HTMLElement | HTMLElement[];\n\n\t/** Boutons à afficher au focus. */\n\tfocusActionables: IActionable<any>[];\n\n\tprotected _startBar: HTMLElement;\n\tprotected _endBar: HTMLElement;\n\n\tprotected _initialize(init: OBarSharedInit<C>) {\n\t\tthis.actionContext = init.actionContext;\n\t\tif (init.startActions) this.startActions = init.startActions;\n\t\tif (init.endActions) this.endActions = init.endActions;\n\t\tif (init.focusListening) this.focusListening = init.focusListening;\n\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tthis._startBar = sr.appendChild(<div id=\"start\"/>);\n\t\tif (this.endActions && this.endActions.length > 0) this._createEndBar();\n\n\t\tthis._startBar.addEventListener('mousedown', this.onMouseDown);\n\t\tthis._startBar.addEventListener('mouseenter', this.onMouseEnter);\n\t\tthis._startBar.addEventListener('mouseleave', this.onMouseLeave);\n\t\tthis._startBar.addEventListener('focusin', this.onFocusIn);\n\t\tthis._startBar.addEventListener('focusout', this.onFocusOut);\n\n\t\tthis._requestIdleBinded = this._requestIdle.bind(this);\n\t}\n\n\tbuildInitFromAtts(init?: OBarSharedInit<C>): OBarSharedInit<C> {\n\t\tinit = super.buildInitFromAtts(init);\n\t\tconst reg = this.findReg(init);\n\t\tif (this.hasAttribute('start-actions')) init.startActions = reg.getList(BASIS.extractAttr(this, 'start-actions'));\n\t\tif (this.hasAttribute('end-actions')) init.endActions = reg.getList(BASIS.extractAttr(this, 'end-actions'));\n\t\tif (this.hasAttribute('action-context')) init.actionContext = reg.getSvc(BASIS.extractAttr(this, 'action-context'));\n\t\treturn init;\n\t}\n\n\tconnectedCallback() {\n\t\tsuper.connectedCallback();\n\t\tif (this.focusListening) {\n\t\t\tfunction add(elt: HTMLElement, lstn: (this: BarShared<C>, ev: CustomEvent) => void) {\n\t\t\t\telt.addEventListener('focusin', lstn);\n\t\t\t\telt.addEventListener('c-focus-actions', lstn);\n\t\t\t\telt.addEventListener('focusout', lstn);\n\t\t\t}\n\n\t\t\tthis._onEventsBinded = this._onEvents.bind(this);\n\t\t\tif (Array.isArray(this.focusListening)) for (const elt of this.focusListening) add(elt, this._onEventsBinded);\n\t\t\telse add(this.focusListening, this._onEventsBinded);\n\t\t}\n\t}\n\n\tdisconnectedCallback() {\n\t\tif (this.focusListening) {\n\t\t\tfunction rem(elt: HTMLElement, lstn: (this: BarShared<C>, ev: CustomEvent) => void) {\n\t\t\t\telt.removeEventListener('focusin', lstn);\n\t\t\t\telt.removeEventListener('c-focus-actions', lstn);\n\t\t\t\telt.removeEventListener('focusout', lstn);\n\t\t\t}\n\n\t\t\tif (Array.isArray(this.focusListening)) for (const elt of this.focusListening) rem(elt, this._onEventsBinded);\n\t\t\telse rem(this.focusListening, this._onEventsBinded);\n\t\t\tthis._onEventsBinded = null;\n\t\t}\n\t}\n\n\tplanRefresh() {\n\t\tif (!this._refreshPlanned) this._refreshPlanned = window.requestIdleCallback(this._requestIdleBinded);\n\t}\n\n\tprotected _onEventsBinded: (this: BarShared<C>, ev: CustomEvent) => void;\n\n\tprotected _onEvents(ev: CustomEvent | FocusEvent) {\n\t\tif (ev instanceof CustomEvent) {\n\t\t\t//event c-focus-actions\n\t\t\tthis.focusActionables = ev.detail ? (ev.detail as IFocusActionables<any>).focusActionables : null;\n\t\t\tthis.planRefresh();\n\t\t} else if (ev.type === 'focusin') {\n\t\t\tfor (const node of ev.composedPath()) {\n\t\t\t\tif ('focusActionables' in node) {\n\t\t\t\t\tthis.focusActionables = (node as IFocusActionables<any>).focusActionables;\n\t\t\t\t\tthis.planRefresh();\n\t\t\t\t\treturn;\n\t\t\t\t} else if (node === this) {\n\t\t\t\t\tif (this.focusActionables) {\n\t\t\t\t\t\tthis.focusActionables = null;\n\t\t\t\t\t\tthis.planRefresh();\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (ev.type === 'focusout') {\n\t\t\tif (ev.relatedTarget && DOMSH.isLogicalFlatAncestor(this, ev.relatedTarget as Node)) return;\n\t\t\tthis.focusActionables = null;\n\t\t\tthis.planRefresh();\n\t\t}\n\t}\n\n\t/** gestion des cycles de refresh. */\n\tprotected _refreshPlanned: number;\n\tprotected _requestIdleBinded: (deadline: RequestIdleDeadline) => void;\n\n\tprotected _requestIdle(this: BarShared<C>, deadline: RequestIdleDeadline) {\n\t\tif (deadline.timeRemaining() < 5) {\n\t\t\tthis._refreshPlanned = window.requestIdleCallback(this._requestIdleBinded);\n\t\t\treturn;\n\t\t}\n\t\tthis._refreshPlanned = null;\n\t\tthis.refresh();\n\t}\n\n\tprotected evalShowFull(ch = this._startBar.lastElementChild as HTMLElement) {\n\t\tif (ch && this.offsetHeight < ch.offsetTop + ch.offsetHeight) DOM.addClass(this._startBar, 'show');\n\t}\n\n\tprotected onMouseDown(this: HTMLElement, ev: MouseEvent) {\n\t\tif (this === ev.target) {\n\t\t\t//Evite de perdre le focus de la toolbar si click à coté d'un bouton.\n\t\t\tev.stopImmediatePropagation();\n\t\t\tev.preventDefault();\n\t\t}\n\t}\n\n\tprotected onMouseLeave(this: HTMLElement) {\n\t\t//Si le focus est dans notre descendance logique, on garde la barre étendue: C'est le blur qui la refermera.\n\t\tif (DOMSH.isLogicalFlatAncestor(DOMSH.findHost(this), DOMSH.findDeepActiveElement())) return;\n\t\tDOM.removeClass(this, 'show');\n\t}\n\n\tprotected onMouseEnter(this: HTMLElement) {\n\t\t(DOMSH.findHost(this) as BarShared<C>).evalShowFull();\n\t}\n\n\tprotected onFocusIn(this: HTMLElement, ev: FocusEvent) {\n\t\t(DOMSH.findHost(this) as BarShared<C>).evalShowFull(/*ev.target as HTMLElement on passe en mode 'show' quelquesoit le btn fosusé. */);\n\t}\n\n\tprotected onFocusOut(this: HTMLElement, ev: FocusEvent) {\n\t\tconst barShared = this instanceof BarShared ? this : DOMSH.findHost(this) as BarShared<C>;\n\t\tif (ev.relatedTarget && DOMSH.isLogicalFlatAncestor(barShared._startBar, ev.relatedTarget as Node)) {\n\t\t\t//Focus dans un widget interne à cette barre, on transfert l'écoute du blur.\n\t\t\tconst blur = (ev: FocusEvent) => {\n\t\t\t\tev.target.removeEventListener('blur', blur);\n\t\t\t\tbarShared.onFocusOut(ev);\n\t\t\t};\n\t\t\tev.relatedTarget.addEventListener('blur', blur);\n\t\t\treturn;\n\t\t}\n\t\tDOM.removeClass(barShared._startBar, 'show');\n\t\tbarShared.focusActionables = null;\n\t\tbarShared.planRefresh();\n\t}\n\n\tprotected _refresh() {\n\t\tif (!this.actionContext) {\n\t\t\tthis.textContent = null;\n\t\t\treturn;\n\t\t}\n\t\tif (isRefreshHook(this.actionContext) && this.actionContext.onRefreshCycle(true) === 'stop') return;\n\t\ttry {\n\t\t\t//this.textContent = null; //désactivation refresh par diff\n\n\t\t\t// fixed start actions.\n\t\t\tlet nextTag = this._startBar.firstElementChild;\n\t\t\tif (this.startActions) for (let i = 0; i < this.startActions.length; i++) {\n\t\t\t\tconst action = this.startActions[i];\n\t\t\t\tif (IS_Actionable(nextTag) && nextTag.action === action) {\n\t\t\t\t\tif (isEltRefreshable(nextTag)) nextTag.refresh();\n\t\t\t\t\tnextTag = nextTag.nextElementSibling;\n\t\t\t\t} else {\n\t\t\t\t\tconst b = this._createButton(action);\n\t\t\t\t\tif (b) this._startBar.insertBefore(b, nextTag);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// focus actionables.\n\t\t\tif (this.focusActionables && this.focusActionables.length > 0) {\n\t\t\t\t//Separator\n\t\t\t\tif (IS_Actionable(nextTag) && nextTag.action instanceof ActionSeparator) {\n\t\t\t\t\tif (isEltRefreshable(nextTag)) nextTag.refresh();\n\t\t\t\t\tnextTag = nextTag.nextElementSibling;\n\t\t\t\t} else {\n\t\t\t\t\tthis._startBar.insertBefore(this._createButton(new ActionSeparator()), nextTag);\n\t\t\t\t}\n\t\t\t\t// focus actionables.\n\t\t\t\tfor (let i = 0; i < this.focusActionables.length; i++) {\n\t\t\t\t\tconst actionable = this.focusActionables[i];\n\t\t\t\t\tif (IS_Actionable(nextTag) && nextTag.action === actionable.action) {\n\t\t\t\t\t\tif (isEltRefreshable(nextTag)) nextTag.refresh();\n\t\t\t\t\t\tnextTag = nextTag.nextElementSibling;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._startBar.insertBefore(actionable, nextTag);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// cleanup startBar\n\t\t\twhile (nextTag) {\n\t\t\t\tconst toRem = nextTag;\n\t\t\t\tnextTag = nextTag.nextElementSibling;\n\t\t\t\ttoRem.remove();\n\t\t\t}\n\t\t\tACTIONABLES.cleanupDoubleSep(this._startBar);\n\n\t\t\t// fixed end actions.\n\t\t\tif (this.endActions && this.endActions.length > 0) {\n\t\t\t\tif (!this._endBar) this._createEndBar();\n\t\t\t\tnextTag = this._endBar.firstElementChild;\n\t\t\t\tfor (let i = 0; i < this.endActions.length; i++) {\n\t\t\t\t\tconst action = this.endActions[i];\n\t\t\t\t\tif (IS_Actionable(nextTag) && nextTag.action === action) {\n\t\t\t\t\t\tif (isEltRefreshable(nextTag)) nextTag.refresh();\n\t\t\t\t\t\tnextTag = nextTag.nextElementSibling;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst b = this._createButton(action);\n\t\t\t\t\t\tif (b) this._endBar.insertBefore(b, nextTag);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// cleanup endBar\n\t\t\t\twhile (nextTag) {\n\t\t\t\t\tconst toRem = nextTag;\n\t\t\t\t\tnextTag = nextTag.nextElementSibling;\n\t\t\t\t\ttoRem.remove();\n\t\t\t\t}\n\t\t\t\tACTIONABLES.cleanupDoubleSep(this._endBar);\n\t\t\t} else if (this._endBar) this._endBar.textContent = null;\n\n\t\t} finally {\n\t\t\tif (isRefreshHook(this.actionContext)) this.actionContext.onRefreshCycle(false);\n\t\t}\n\t}\n\n\tprotected _createEndBar(): HTMLElement {\n\t\tthis.shadowRoot.appendChild(<hr/>);\n\t\treturn (this._endBar = this.shadowRoot.appendChild(<div id=\"end\"/>));\n\t}\n\n\tprotected _createButton(action: Action): Element {\n\t\treturn ActionBtn.buildButton(action, this.actionContext, 'bar', this);\n\t}\n}\n\nREG.reg.registerSkin('c-bar-shared', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: 1.7em;\n\t\tmin-width: 0;\n\t\tflex: 1;\n\t\talign-items: center;\n\t\tjustify-content: flex-end;\n\t\tposition: relative;\n  }\n\n  :host([vertical]) {\n\t  flex-direction: column;\n\t  min-height: 0;\n\t  min-width: 1.7em;\n\t  justify-content: unset;\n  }\n\n  #end {\n\t  display: flex;\n\t  min-height: 0;\n\t  min-width: 0;\n  }\n\n  #start {\n\t  position: relative;\n\t  overflow: hidden;\n\t  display: flex;\n\t  min-width: 0;\n\t  min-height: calc(6px + var(--icon-size));\n\t  flex-wrap: wrap;\n\t  flex: 1;\n  }\n\n  :host([vertical]) #start {\n\t  flex-direction: column;\n\t  min-height: unset;\n\t  min-width: calc(6px + var(--icon-size));\n  }\n\n  #start.show {\n\t  position: absolute;\n\t  top: 0;\n\t  left: 0;\n\t  overflow: visible;\n\t  bottom: unset;\n\t  z-index: 100;\n\t  max-height: unset;\n\t  border: 1px solid var(--border-color);\n\t  box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.5);\n\t  background-color: var(--bgcolor);\n  }\n\n  hr {\n\t  border-top: 1px solid var(--border-color);\n\t  border-inline-start: 1px solid var(--border-color);\n\t  border-inline-end: none;\n\t  border-bottom: none;\n\t  margin: .2em;\n\t  align-self: stretch;\n  }\n`);\n\ncustomElements.define('c-bar-shared', BarShared);\n\n\n/**\n * Barre d'information.\n */\nexport class BarStatus extends BaseElement {\n\n\tprotected _textCtn: HTMLElement;\n\n\tprotected _initialize(init: OSkinableInit) {\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tthis._textCtn = sr.appendChild(document.createElement('div'));\n\t}\n\n\tsetStatus(status: string) {\n\t\tthis._textCtn.textContent = status;\n\t}\n}\n\nREG.reg.registerSkin('c-bar-status', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex: 1;\n\t\tpadding: 2px;\n\t}\n\n\tdiv {\n\t\tflex: 1;\n\t\tjustify-content: start;\n\t\toverflow: hidden;\n\t\twhite-space: nowrap;\n\t\ttext-overflow: ellipsis;\n\t\tfont-size: small;\n\t}\n`);\n\ncustomElements.define('c-bar-status', BarStatus);\n"]}