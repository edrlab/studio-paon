{"version":3,"sources":["/@back@/wsp/apps/itemEdApp.tsx"],"names":["BaseElementAsync","MsgLabel","ItemEditInDialogInfoBroker","ItemXmlEd","REG","VIEWS","JSX","AppHeader","DOMSH","Desk","SRC","WSP","EWspChangesEvts","ItemEdApp","[object Object]","init","this","reg","findReg","appDef","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","checkCompat","msg","appendChild","createElement","knownNavCompat","map","n","url","href","target","name","root","style","insertBefore","initialize","mainActions","getList","actionContext","focusListening","initEditor","subInit","Object","create","def","itemEd","wspCd","srcRef","editorKey","initItemReg","env","infoBroker","findWspReg","itemEditor","initializedAsync","currentModel","longDesc","itModel","place","eventsMgr","on","from","wsp","code","type","r","isSubUriOrEqual","srcUri","showFailure","u","fetchShortDesc","then","sd","itemType","wspMetaUi","getItemType","getEditor","closeEditor","remove","catch","e","shadowRoot","label","closed","onViewHidden","registerSkin","customElements","define"],"mappings":"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","sourcesContent":["import {BaseElement, BaseElementAsync, MsgLabel, OSkinableInit} from \"back/commons/basis\";\nimport {IApp, IAppCtx} from \"back/core/appFrame\";\nimport {JItemEdAppDef} from \"back/wsp/plugins/itemEdPlg\";\nimport {ItemEditInDialogInfoBroker, ItemXmlEd, OItemXmlEdInit} from \"back/wsp/views/item/itemXmlEd\";\nimport {IReg, IUiEnv, REG} from 'lib/commons/registry';\nimport {IView, VIEWS} from \"lib/commons/views\";\nimport {JSX} from \"lib/commons/xml/dom\";\nimport {IChainEnv} from \"lib/wsp/chain\";\nimport {AppHeader} from \"back/core/widgets/appHeader\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {Desk} from \"lib/commons/desk\";\nimport {SRC} from \"lib/wsp/src\";\nimport {JWspUriChangeMsg, WSP} from \"lib/wsp/wsp\";\nimport {EWspChangesEvts, WspsLivePlace} from \"lib/wsp/wspsLive\";\n\n/** App affichant un éditeur d'un item. */\nexport interface ItemEdApp extends BaseElement, IView {\n\tinitialize(init: IAppCtx<IChainEnv> & OSkinableInit): this;\n}\n\nexport class ItemEdApp extends BaseElementAsync implements IApp<IChainEnv> {\n\n\tappDef: JItemEdAppDef;\n\n\treg: IReg<IChainEnv & IUiEnv>;\n\n\titemEditor: ItemXmlEd;\n\n\tprotected async _initialize(init: IAppCtx<IChainEnv> & OItemXmlEdInit) {\n\t\tthis.reg = this.findReg(init);\n\t\tthis.appDef = init.appDef as JItemEdAppDef;\n\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tif (!Desk.checkCompat('edit')) {\n\t\t\tconst msg = sr.appendChild(<div>\n\t\t\t\t<p>Ce navigateur n'est pas compatible avec l'édition de texte riche.</p>\n\t\t\t\t<p>Vous pouvez utiliser un des navigateurs à jour suivants :</p>\n\t\t\t\t<ul>\n\t\t\t\t\t{Desk.knownNavCompat.map((n) => n.url ? <li><a href={n.url} target=\"_blank\">{n.name}</a></li> : <li>{n.name}</li>)}\n\t\t\t\t</ul>\n\t\t\t</div>);\n\t\t\treturn;\n\t\t}\n\n\t\tconst root = sr.appendChild(<div style=\"display:contents\"/>);\n\n\t\t//AppHeader (après le itemEditor car on le référence dans le appHeader)\n\t\tsr.insertBefore(new AppHeader<ItemEdApp>().initialize({\n\t\t\treg: this.reg,\n\t\t\tmainActions: this.reg.getList(\"actions:itemEdApp:bar:main\"),\n\t\t\tactionContext: this,\n\t\t\tfocusListening: root\n\t\t}), root);\n\t\treturn this.initEditor(root, init);\n\t}\n\n\tasync initEditor(root: HTMLElement, init: IAppCtx<IChainEnv> & OItemXmlEdInit) {\n\t\ttry {\n\t\t\tconst subInit = Object.create(init) as OItemXmlEdInit;\n\t\t\tconst def = this.appDef.itemEd;\n\t\t\tsubInit.reg = this.reg;\n\t\t\tsubInit.wspCd = def.wspCd;\n\t\t\tsubInit.srcRef = def.srcRef;\n\t\t\tsubInit.editorKey = def.editorKey;\n\t\t\tsubInit.initItemReg = (reg) => {\n\t\t\t\treg.env.infoBroker = new ItemEditInDialogInfoBroker(WSP.findWspReg(reg));\n\t\t\t};\n\t\t\tthis.itemEditor = root.appendChild(new ItemXmlEd().initialize(subInit));\n\t\t\tawait this.itemEditor.initializedAsync;\n\t\t\tconst currentModel = this.itemEditor.reg.env.longDesc.itModel;\n\t\t\tthis.itemEditor.reg.env.place.eventsMgr.on(\"wspUriChange\", (msg: JWspUriChangeMsg, from: WspsLivePlace | 'local' | 'server') => {\n\t\t\t\tif (msg.wspCd !== this.itemEditor.reg.env.wsp.code) return;\n\t\t\t\tif (msg.type === EWspChangesEvts.r && SRC.isSubUriOrEqual(msg.srcUri, this.itemEditor.reg.env.longDesc.srcUri)) {\n\t\t\t\t\tif (this.itemEditor) this.showFailure(\"Cet item a été supprimé.\");\n\t\t\t\t} else if (msg.type === EWspChangesEvts.u && msg.srcUri === this.itemEditor.reg.env.longDesc.srcUri) {\n\t\t\t\t\t//check chgt de model\n\t\t\t\t\tthis.itemEditor.reg.env.wsp.fetchShortDesc(SRC.srcRef(msg)).then((sd) => {\n\t\t\t\t\t\tif (currentModel !== sd.itModel && this.itemEditor) {\n\t\t\t\t\t\t\tconst itemType = this.itemEditor.reg.env.wsp.wspMetaUi.getItemType(sd.itModel);\n\t\t\t\t\t\t\tif (itemType && itemType.getEditor(subInit.editorKey)) {\n\t\t\t\t\t\t\t\tthis.itemEditor.closeEditor();\n\t\t\t\t\t\t\t\tthis.itemEditor.remove();\n\t\t\t\t\t\t\t\tthis.itemEditor = null;\n\t\t\t\t\t\t\t\treturn this.initEditor(root, init);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.showFailure(\"Une modification externe de cet item ne permet plus son affichage dans ce contexte.\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}).catch(() => {\n\t\t\t\t\t\tthis.showFailure(\"Échec à l'affichage de cet item suite à une modification externe.\");\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\t\t} catch (e) {\n\t\t\tthis.showFailure(\"Échec à l'affichage de cet item.\");\n\t\t}\n\t}\n\n\tshowFailure(msg: string) {\n\t\tif (this.itemEditor) this.itemEditor.remove();\n\t\tthis.itemEditor = null;\n\t\tthis.shadowRoot.appendChild(new MsgLabel().initialize({\n\t\t\treg: this.reg,\n\t\t\tlabel: msg\n\t\t}));\n\t}\n\n\tonViewHidden(closed?: boolean) {\n\t\tif (this.itemEditor) {\n\t\t\tif (closed) {\n\t\t\t\tthis.itemEditor.closeEditor();\n\t\t\t} else {\n\t\t\t\tVIEWS.onViewHidden(this.itemEditor, closed);\n\t\t\t}\n\t\t}\n\t}\n\n\tupdateAppDef(def: JItemEdAppDef): boolean {\n\t\treturn false;\n\t}\n}\n\nREG.reg.registerSkin('wsp-item-ed-app', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t  min-width: 0;\n\t  flex-direction: column;\n  }\n\n  wsp-item-ed-app {\n\t  flex: 1;\n  }\n\n  hr {\n\t  border-top: 1px solid var(--border-color);\n\t  border-inline-start: 1px solid var(--border-color);\n\t  border-inline-end: none;\n\t  border-bottom: none;\n\t  margin: 0;\n  }\n`);\n\ncustomElements.define('wsp-item-ed-app', ItemEdApp);\n"]}