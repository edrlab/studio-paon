{"version":3,"sources":["/@back@/edit/wed/features/helpBar.tsx"],"names":["REG","DOM","Action","DOMSH","XA","HelpViews","BASIS","IS_EltWedlet","WEDLET","initHelpOnEditor","helpInit","reg","editorConfig","wedMgrConfig","editor","addToList","ToggleHelpAction","ShowHelpFromSelAction","WedHelpBar","HTMLElement","[object Object]","super","this","id","HELPBAR_ID","wedEditor","setAttribute","sr","attachShadow","SHADOWDOM_INIT","installSkin","localName","view","appendChild","initialize","newInit","barLayout","showBar","initializedAsync","show","setHidden","onHideBar","visitor","options","visible","hidden","registerSkin","customElements","define","_label","_icon","api","ctx","bar","getBar","ev","getOrCreateHelpBar","showLiveHelpId","findHelpFromLastFocus","wedMgr","async","initHelpBar","listeners","on","showLiveHelpFromSel","findHelpFromSel","sel","getCurrentSel","xa","startInText","up","start","findHelpFromXa","docHolder","virtualPath","elt","lastFocus","isConnected","wedlet","_a","findFlatParentEltOrSelf","rootNode","wedAnchor","buildVirtualPath","helpId","getStruct","length","_b"],"mappings":"OACcA,QAAI;OACVC,QAAI;OACJC,WAAsB;OAGtBC,UAAM;OACEC,OAAG;OAEXC,cAA0B;OAC1BC,UAAM;OAINC,aAAcC,WAAO;OAavB,SAAUC,iBAAiBC,SAA0BC,IAA6BC,aAAmCC,aAAiCC,QAC3JH,IAAII,UAAU,4BAA6B,OAAQ,EAAG,IAAIC,iBAAiBN,UAAW;AACtFC,IAAII,UAAU,uBAAwB,KAAM,EAAG,IAAIE,sBAAsBP,WAG1E,MAAMQ,mBAAmBC,YAKxBC,cACCC;AACAC,KAAKC,GAAKC,WAGXJ,kBAAkBK,UAA2Bf,UAC5CY,KAAKG,UAAYA;AACjBH,KAAKI,aAAa,QAAS;AAC3B,MAAMC,GAAKL,KAAKM,aAAazB,MAAM0B;AACnCJ,UAAUd,IAAImB,YAAYR,KAAKS,UAAWJ;AAC1CL,KAAKU,KAAOL,GAAGM,aAAY,IAAI5B,WAAY6B,WAAW5B,MAAM6B,QAAQzB,SAAUe,UAAUd;AACxFc,UAAUW,UAAUC,QAAQf;MACtBA,KAAKU,KAAKM;AAChB,OAAOhB,KAGRF,QAAQmB,MACP,GAAIA,KAAM,CACT,GAAItC,IAAIuC,UAAUlB,KAAM,OAAQA,KAAKG,UAAUW,UAAUC,QAAQf,WAC3D,GAAIrB,IAAIuC,UAAUlB,KAAM,MAAO,CACrCA,KAAKG,UAAUW,UAAUK,UAAUnB,OAIrCF,WAAWsB,QAA+BC,SACzC,IAAIA,UAAO,MAAPA,eAAO,OAAA,EAAPA,QAASC,UAAWtB,KAAKuB,OAAQ;AACrC,OAAOH,QAAQpB,KAAKU,MAGrBZ,gBAAgBsB,QAAwCC,SACvD,IAAIA,UAAO,MAAPA,eAAO,OAAA,EAAPA,QAASC,UAAWtB,KAAKuB,OAAQ;AACrC,OAAOH,QAAQpB,KAAKU,OAItBhC,IAAIW,IAAImC,aAAa,cAAe,EAAoB;AAUxDC,eAAeC,OAAO,cAAe9B;OAE/B,MAAOF,yBAAyBd,OAErCkB,YAAmBV,UAClBW,MAAM;AADYC,KAAAZ,SAAAA;AAElBY,KAAK2B,OAAS;AACd3B,KAAK4B,MAAQ,iCAGd9B,WAAmD,OAAO,KAE1DA,SAAS+B,IAAeC,KACvB,MAAMC,IAAMD,IAAIhB,UAAUkB,OAAO9B;AACjC,OAAO6B,MAAQA,IAAIR,OAGpBzB,QAAQgC,IAAqBG,IAC5B,MAAMF,IAAkBD,IAAIhB,UAAUkB,OAAO9B;AAC7C,GAAI6B,IAAK,CACRA,IAAIhB,QAAQgB,IAAIR,aACVW,mBAAmBJ,IAAK9B,KAAKZ,kBAKhC,MAAOO,8BAA8Bf,OAE1CkB,YAAmBV,UAClBW,MAAM;AADYC,KAAAZ,SAAAA,SAInBU,cAAcgC,IAAqBG,IAClC,aAAcC,mBAAmBJ,IAAK9B,KAAKZ,WAAWsB,KAAKyB,eAAeC,sBAAsBN,IAAIO,QAAS,OAI/GC,eAAeJ,mBAAmB1C,OAAwBJ,UACzD,IAAI2C,IAAMvC,OAAOsB,UAAUkB,OAAO9B;AAClC,IAAK6B,IAAK,CACTA,UAAY,IAAInC,YAAa2C,YAAY/C,OAAQJ;AAEjDI,OAAO6C,OAAOG,UAAUC,GAAG,WAAaJ,SACvCN,IAAIrB,KAAKgC,oBAAoB,IAAMN,sBAAsBC,gBAEpDN,IAAIhB,QAAQ;AACnB,OAAOgB,IAIR,SAASY,gBAAgBN,QACxB,MAAMO,IAAMP,OAAOQ;AACnB,GAAID,IAAK,CACR,IAAIE,GAAKF,IAAIG,YAAcjE,GAAGkE,GAAGJ,IAAIK,OAASL,IAAIK;AAClD,OAAOC,eAAeb,OAAOc,UAAWL,GAAIF,IAAIQ,cAKlD,SAAShB,sBAAsBC;AAC9B,MAAMgB,IAAMhB,OAAOiB;AACnB,GAAID,MAAG,MAAHA,WAAG,OAAA,EAAHA,IAAKE,YAAa,CACrB,MAAMC,QAASC,GAAA5E,MAAM6E,wBAAwBL,IAAKhB,OAAOlC,UAAUwD,SAAU1E,iBAAa,MAAAwE,UAAA,OAAA,EAAAA,GAAED;AAC5F,GAAIA,OAAQ,OAAON,eAAeb,OAAOc,UAAWK,OAAOI,UAAW1E,OAAO2E,iBAAiBL,UAIhG,SAASN,eAAeC,UAA2BL,GAAYM;AAC9D,IAAIU,QAASL,GAACN,UAAUY,UAAUjB,GAAIM,gBAAuC,MAAAK,UAAA,OAAA,EAAAA,GAAEK;AAC/E,OAAQA,OAAQ,CACf,GAAIhB,GAAGkB,OAAS,EAAGlB,GAAKhE,GAAGkE,GAAGF;KACzB;AACL,IAAIM,cAAW,MAAXA,mBAAW,OAAA,EAAXA,YAAaY,QAAS,EAAGZ,YAAYY;AACzCF,QAASG,GAACd,UAAUY,UAAUjB,GAAIM,gBAAuC,MAAAa,UAAA,OAAA,EAAAA,GAAEH,OAE5E,OAAOA,OAGR,MAAM5D,WAAa","sourcesContent":["import {IWedEdBar, IWedEditorMain, OWedManagerConfig, WedMgr} from \"back/edit/wed/wedEditor\";\nimport {IReg, REG} from \"lib/commons/registry\";\nimport {DOM} from \"lib/commons/xml/dom\";\nimport {Action, IActionToggle} from \"lib/commons/actions\";\nimport {OWedEditorBoxConfig, WedEditorBox} from \"back/edit/wed/wedEditorBox\";\nimport {IResolverPointer} from \"lib/commons/io/io\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IXAddr, XA} from \"lib/commons/xml/xAddr\";\nimport {SkRuleAttr, SkRuleElt} from \"lib/edit/schema/schemaPatterns\";\nimport {HelpViews, OHelpViewsInit} from \"back/help/views/helpViews\";\nimport {BASIS} from \"back/commons/basis\";\nimport {IView, IViewContainer, OViewVisitOptions} from \"lib/commons/views\";\nimport {IJmlObj} from \"lib/commons/xml/jml\";\nimport {IDocHolderSync} from \"lib/edit/docHolder\";\nimport {IS_EltWedlet, WEDLET} from \"back/edit/wed/wedlets/wedlet\";\nimport {helpId} from \"back/help/helpApi\";\n\n/**\n * Initialisation dynamique de la feature d'aide\n *\n * @param rootHelpId Racine d'aide associé à l'éditeur de ce contenu\n * @param helpDb Db d'aide à charger et interroger.\n * @param reg Reg qui va être associé à editorConfig. ATTENTION ce reg va être surchargé, il DOIT DEJA être dédié à cet éditeur.\n * @param editorConfig\n * @param wedMgrConfig\n * @param editor editor qui va être initialisé avec editorConfig et wedMgrConfig\n */\nexport function initHelpOnEditor(helpInit: OHelpViewsInit, reg: IReg<IResolverPointer>, editorConfig: OWedEditorBoxConfig, wedMgrConfig: OWedManagerConfig, editor: WedEditorBox) {\n\treg.addToList(\"actions:wed:commonbar:end\", \"help\", 1, new ToggleHelpAction(helpInit), 101);\n\treg.addToList(\"accelKeys:wed:global\", \"F1\", 1, new ShowHelpFromSelAction(helpInit));\n}\n\nclass WedHelpBar extends HTMLElement implements CustomElement, IWedEdBar, IViewContainer {\n\n\twedEditor: IWedEditorMain;\n\tview: HelpViews;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.id = HELPBAR_ID;\n\t}\n\n\tasync initHelpBar(wedEditor: IWedEditorMain, helpInit: OHelpViewsInit): Promise<this> {\n\t\tthis.wedEditor = wedEditor;\n\t\tthis.setAttribute(\"label\", \"Aide\"); //api View\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\twedEditor.reg.installSkin(this.localName, sr);\n\t\tthis.view = sr.appendChild(new HelpViews().initialize(BASIS.newInit(helpInit, wedEditor.reg)));\n\t\twedEditor.barLayout.showBar(this);\n\t\tawait this.view.initializedAsync;\n\t\treturn this;\n\t}\n\n\tshowBar(show: boolean) {\n\t\tif (show) {\n\t\t\tif (DOM.setHidden(this, false)) this.wedEditor.barLayout.showBar(this);\n\t\t} else if (DOM.setHidden(this, true)) {\n\t\t\tthis.wedEditor.barLayout.onHideBar(this);\n\t\t}\n\t}\n\n\tvisitViews(visitor: (view: IView) => any, options?: OViewVisitOptions): any {\n\t\tif (options?.visible && this.hidden) return;\n\t\treturn visitor(this.view);\n\t}\n\n\tvisitViewsAsync(visitor: (view: IView) => Promise<any>, options?: OViewVisitOptions): Promise<any> {\n\t\tif (options?.visible && this.hidden) return;\n\t\treturn visitor(this.view);\n\t}\n}\n\nREG.reg.registerSkin(\"wed-helpbar\", 1, /*language=CSS*/ `\n\t:host {\n\t\tflex: 1 1 30%;\n\t\tdisplay: flex;\n\t\tmin-height: 100px;\n\t\tmin-width: 100px;\n\t\tflex-direction: column;\n\t}\n`);\n\ncustomElements.define('wed-helpbar', WedHelpBar);\n\nexport class ToggleHelpAction extends Action<IWedEditorMain> implements IActionToggle<IWedEditorMain> {\n\n\tconstructor(public helpInit: OHelpViewsInit) {\n\t\tsuper(\"help\");\n\t\tthis._label = \"Aide\";\n\t\tthis._icon = \"/@skin@/edit/wed/help/help.svg\";\n\t}\n\n\tisToggle(): this is IActionToggle<IWedEditorMain> {return true}\n\n\tgetDatas(api: 'toggle', ctx: IWedEditorMain): boolean | null {\n\t\tconst bar = ctx.barLayout.getBar(HELPBAR_ID);\n\t\treturn bar && !bar.hidden;\n\t}\n\n\texecute(ctx: IWedEditorMain, ev?: Event): any | 'noPreventDefault' {\n\t\tconst bar: WedHelpBar = ctx.barLayout.getBar(HELPBAR_ID) as WedHelpBar;\n\t\tif (bar) {\n\t\t\tbar.showBar(bar.hidden);\n\t\t} else getOrCreateHelpBar(ctx, this.helpInit);\n\t}\n}\n\n/** Appelé sur accelKey F1 */\nexport class ShowHelpFromSelAction extends Action<IWedEditorMain> implements IActionToggle<IWedEditorMain> {\n\n\tconstructor(public helpInit: OHelpViewsInit) {\n\t\tsuper(\"help\");\n\t}\n\n\tasync execute(ctx: IWedEditorMain, ev?: Event) {\n\t\treturn (await getOrCreateHelpBar(ctx, this.helpInit)).view.showLiveHelpId(findHelpFromLastFocus(ctx.wedMgr), true);\n\t}\n}\n\nasync function getOrCreateHelpBar(editor: IWedEditorMain, helpInit: OHelpViewsInit): Promise<WedHelpBar> {\n\tlet bar = editor.barLayout.getBar(HELPBAR_ID) as WedHelpBar;\n\tif (!bar) {\n\t\tbar = await new WedHelpBar().initHelpBar(editor, helpInit);\n\t\t//Activation dynamique par rapport à le sel\n\t\teditor.wedMgr.listeners.on(\"getFocus\", (wedMgr: WedMgr) => {\n\t\t\tbar.view.showLiveHelpFromSel(() => findHelpFromLastFocus(wedMgr))\n\t\t});\n\t} else bar.showBar(true);\n\treturn bar;\n}\n\n/** Approche 1 : dépend la sel courante : permet l'aide contextuelle dans la textPrim. */\nfunction findHelpFromSel(wedMgr: WedMgr): helpId | undefined {\n\tconst sel = wedMgr.getCurrentSel();\n\tif (sel) {\n\t\tlet xa = sel.startInText ? XA.up(sel.start) : sel.start;\n\t\treturn findHelpFromXa(wedMgr.docHolder, xa, sel.virtualPath);\n\t}\n}\n\n/** Approche 2 : dépend du lastFocus : plus stable, exclus l'aide contextuelle dans la textPrim. */\nfunction findHelpFromLastFocus(wedMgr: WedMgr): helpId | undefined {\n\tconst elt = wedMgr.lastFocus;\n\tif (elt?.isConnected) {\n\t\tconst wedlet = DOMSH.findFlatParentEltOrSelf(elt, wedMgr.wedEditor.rootNode, IS_EltWedlet)?.wedlet;\n\t\tif (wedlet) return findHelpFromXa(wedMgr.docHolder, wedlet.wedAnchor, WEDLET.buildVirtualPath(wedlet));\n\t}\n}\n\nfunction findHelpFromXa(docHolder: IDocHolderSync, xa: IXAddr, virtualPath: Array<IJmlObj | '#' | '@'> | null): helpId {\n\tlet helpId = (docHolder.getStruct(xa, virtualPath) as SkRuleElt | SkRuleAttr)?.helpId;\n\twhile (!helpId) {\n\t\tif (xa.length > 1) xa = XA.up(xa);\n\t\telse break;\n\t\tif (virtualPath?.length > 0) virtualPath.length--;\n\t\thelpId = (docHolder.getStruct(xa, virtualPath) as SkRuleElt | SkRuleAttr)?.helpId;\n\t}\n\treturn helpId;\n}\n\nconst HELPBAR_ID = \"helpBar\";"]}