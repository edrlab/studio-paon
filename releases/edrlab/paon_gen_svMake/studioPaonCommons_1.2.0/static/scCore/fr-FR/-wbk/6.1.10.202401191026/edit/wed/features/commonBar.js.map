{"version":3,"sources":["/@back@/edit/wed/features/commonBar.tsx"],"names":["IS_ActionableEnabled","BarActions","ACTION","REG","DOM","JSX","DOMSH","isEltBoxSelection","AgCommonBarEditor","cls","proto","prototype","superInit","initialize","config","call","this","hideCommonBar","commonBar","attachSubEditor","barLayout","WedCommonBar","[object Object]","editor","rootBar","createElement","id","style","showBar","wedMgr","hookFct","docHolderAsync","textContent","stableStartBar","stableEndBar","listeners","on","planRefreshFull","planRefreshStableBar","onFocus","onSelChange","wedEditor","killBar","addEventListener","onKeydown","bind","_requestIdleCallback","requestIdleCallback","_redrawPlanned","window","cancelIdleCallback","_nextRefreshStableBar","_nextFocusBar","focusBar","reg","actionContext","actions","getList","flexShrink","flexGrow","appendChild","endActions","refreshContent","remove","focused","focusedElt","isConnected","setStyle","insertBefore","restoreFocusTarget","findDeepActiveElement","focusable","findFlatFirstChild","IS_focusable","focus","isWedFocusBarPointer","h","focusElt","planChangeFocusBar","sel","findParentOrSelf","focusNode","IS_element","eltBoxCtn","findFlatParentEltOrSelf","rootNode","selMode","focusBarPointer","ev","key","isAccelPressed","stopImmediatePropagation","HTMLElement","isAncestor","target","next","findLastChild","findFirstChild","deadline","timeRemaining","redraw","addSvcToList"],"mappings":"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","sourcesContent":["import {IS_ActionableEnabled} from \"back/commons/actionables\";\nimport {BarActions} from \"back/commons/widgets/bars\";\nimport {IWedEditor, IWedEditorMain, OWedEditorMainConfig, WedMgr} from \"back/edit/wed/wedEditor\";\nimport {ACTION, Action} from \"lib/commons/actions\";\nimport {REG} from 'lib/commons/registry';\nimport {DOM, INodeFilter, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IWedletActionCtx} from \"back/edit/wed/wedlets/wedlet\";\nimport {isEltBoxSelection} from \"back/edit/wed/features/boxSel\";\n\n\nexport interface OWedEditorCommonBarConfig extends OWedEditorMainConfig {\n\t/** Désactive cette commonBar. */\n\thideCommonBar?: boolean;\n\n\t/** WedCommonBar pré-existante déjà associée à un autre éditeur maitre. */\n\tcommonBar?: WedCommonBar;\n}\n\nexport interface IWedEditorCommonBar extends IWedEditorMain {\n\tcommonBar?: WedCommonBar;\n}\n\nexport function AgCommonBarEditor(cls: any): any {\n\tconst proto = cls.prototype as IWedEditorCommonBar;\n\tconst superInit = proto.initialize;\n\tproto.initialize = function (this: IWedEditorCommonBar, config: OWedEditorCommonBarConfig) {\n\t\tsuperInit.call(this, config);\n\t\tif (!config.hideCommonBar) {\n\t\t\tif (config.commonBar) {\n\t\t\t\tconfig.commonBar.attachSubEditor(this);\n\t\t\t} else if (this.barLayout) {\n\t\t\t\tthis.commonBar = new WedCommonBar(this, config);\n\t\t\t}\n\t\t\t//A revoir : Actuellement affichage du menu contextuel géré par ContextMenuDeskFeat. A réactiver si ContextMenuDeskFeat.isIn(desk) === false ?\n\t\t\t//this.wedMgr.accelKeyMgr.addAccelKey(\" \", 'accel', new Action<IWedEditorCommonBar>('menuBar').setExecute((ctx: IWedEditorCommonBar) => {ctx.commonBar.acquireFocus()}));\n\t\t}\n\t\treturn this;\n\t};\n\treturn cls;\n}\n\nexport class WedCommonBar {\n\n\t/** toolbar stable, certaines actions peuvent dépendre du focus courant de l'éditeur, de l'état de la house... */\n\tstableStartBar: BarActions<IWedEditor>;\n\tstableEndBar: BarActions<IWedEditor>;\n\n\t/** toolbar dynamique en fonction du focus de l'éditeur. */\n\tfocusBar: BarActions<IWedletActionCtx>;\n\n\trootBar: HTMLElement;\n\n\t/** Données à rafraichir au prochain cycle. */\n\tprotected _nextRefreshStableBar: boolean;\n\tprotected _nextFocusBar: BarActions<IWedletActionCtx>;\n\n\t/** gestion des cycles de refresh. */\n\t_redrawPlanned: number;\n\t_requestIdleCallback: (deadline: RequestIdleDeadline) => void;\n\n\tconstructor(public editor: IWedEditorCommonBar, config: OWedEditorCommonBarConfig) {\n\t\tthis.rootBar = <div id=\"commonBar\" style=\"display:flex;\"/>;\n\t\teditor.barLayout.showBar(this.rootBar);\n\t\teditor.wedMgr.hookFct('detachDocHolder', () => {\n\t\t\t// En cas d'association à un nouveau docHoler, on suppr la stableBar pour forcer une reconstruction\n\t\t\t// car les btns de la stableBar peuvent être liés à la house (dirty, histo).\n\t\t\tif (this.editor.wedMgr.docHolderAsync) {\n\t\t\t\tthis.rootBar.textContent = null;\n\t\t\t\tthis.stableStartBar = null;\n\t\t\t\tthis.stableEndBar = null;\n\t\t\t}\n\t\t}, true);\n\t\teditor.wedMgr.listeners\n\t\t\t.on(\"redrawBeforeFetch\", planRefreshFull)\n\t\t\t.on(\"redrawAtEnd\", planRefreshFull)\n\t\t\t.on(\"readOnlyChangeAfter\", planRefreshFull)\n\t\t\t.on(\"layoutBarChange\", planRefreshStableBar)\n\t\t\t.on(\"getFocus\", onFocus)\n\t\t\t.on(\"selection\", onSelChange)\n\t\t\t.on(\"killEditor\", function (this: void, wedMgr: WedMgr) {\n\t\t\t\t(wedMgr.wedEditor as IWedEditorCommonBar).commonBar.killBar();\n\t\t\t});\n\t\tthis.rootBar.addEventListener(\"keydown\", onKeydown.bind(editor));\n\t\tthis._requestIdleCallback = requestIdleCallback.bind(this);\n\t}\n\n\tkillBar() {\n\t\tif (this._redrawPlanned) window.cancelIdleCallback(this._redrawPlanned);\n\t}\n\n\t/** Si WedCommonBar pré-existante déjà associée à un autre éditeur maitre. */\n\tattachSubEditor(editor: IWedEditorCommonBar) {\n\t\teditor.commonBar = this;\n\t\teditor.wedMgr.listeners\n\t\t\t.on(\"getFocus\", onFocus)\n\t\t\t.on(\"selection\", onSelChange);\n\t}\n\n\t/** Planification d'un redessinement des 2 bars. */\n\tplanRefreshFull() {\n\t\tthis._nextRefreshStableBar = true;\n\t\tthis._nextFocusBar = null;\n\t\tif (!this._redrawPlanned) this._redrawPlanned = window.requestIdleCallback(this._requestIdleCallback);\n\t}\n\n\tplanRefreshStableBar() {\n\t\tthis._nextRefreshStableBar = true;\n\t\tif (!this._redrawPlanned) this._redrawPlanned = window.requestIdleCallback(this._requestIdleCallback);\n\t}\n\n\t/** Planification d'un redessinement de la focus bar. */\n\tplanChangeFocusBar(focusBar: BarActions<IWedletActionCtx>) {\n\t\t//console.trace(\"planChangeFocusBar:::\", focusBar)\n\t\tthis._nextFocusBar = focusBar;\n\t\tif (!this._redrawPlanned) this._redrawPlanned = window.requestIdleCallback(this._requestIdleCallback);\n\t}\n\n\t/** Execute le redessinement. */\n\tredraw() {\n\t\tif (!this.stableStartBar) {\n\t\t\t//stableBar pas encore dessinée ou effacée quite à un detachDocHolder()\n\t\t\tconst reg = this.editor.wedMgr.reg;\n\t\t\tthis.stableStartBar = new BarActions<IWedEditor>().initialize({\n\t\t\t\tactionContext: this.editor,\n\t\t\t\tactions: reg.getList(\"actions:wed:commonbar:start\") as Action<IWedEditor>[]\n\t\t\t});\n\t\t\tthis.stableStartBar.style.flexShrink = \"0\";\n\t\t\tthis.stableStartBar.style.flexGrow = \"1\";\n\t\t\tthis.rootBar.appendChild(this.stableStartBar);\n\t\t\tconst endActions = reg.getList(\"actions:wed:commonbar:end\") as Action<IWedEditor>[];\n\t\t\tif (endActions) {\n\t\t\t\tthis.stableEndBar = new BarActions<IWedEditor>().initialize({\n\t\t\t\t\tactionContext: this.editor,\n\t\t\t\t\tactions: endActions\n\t\t\t\t});\n\t\t\t\tthis.stableEndBar.style.flexShrink = \"0\";\n\t\t\t\tthis.rootBar.appendChild(this.stableEndBar);\n\t\t\t}\n\t\t\tthis._nextRefreshStableBar = false;\n\t\t} else if (this._nextRefreshStableBar) {\n\t\t\tthis.stableStartBar.refreshContent();\n\t\t\tif (this.stableEndBar) this.stableEndBar.refreshContent();\n\t\t\tthis._nextRefreshStableBar = false;\n\t\t}\n\t\tif (this.focusBar === this._nextFocusBar) {\n\t\t\tif (this.focusBar) this.focusBar.refreshContent();\n\t\t} else {\n\t\t\tif (this.focusBar) {\n\t\t\t\tthis.focusBar.remove();\n\t\t\t\tthis.focusBar = null;\n\t\t\t}\n\t\t\tif (this._nextFocusBar) {\n\t\t\t\tconst focused = this._nextFocusBar.actionContext.focusedElt;\n\t\t\t\tif (focused && focused.isConnected) { //race cond si l'elt focusé a été déconnecté (appelé en requestIdleCallback)\n\t\t\t\t\tthis.focusBar = this._nextFocusBar;\n\t\t\t\t\tDOM.setStyle(this.focusBar, \"flex-grow\", \"1000\");\n\t\t\t\t\tDOM.setStyle(this.focusBar, \"border-inline-start\", this.stableStartBar ? \"1px solid var(--border-color)\" : null);\n\t\t\t\t\tDOM.setStyle(this.focusBar, \"border-inline-end\", this.stableEndBar ? \"1px solid var(--border-color)\" : null);\n\t\t\t\t\tthis.rootBar.insertBefore(this.focusBar, this.stableEndBar);\n\t\t\t\t\t//this.focusBar.refresh(); appelé dans connectedCallback()\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\trestoreFocusTarget: Element;\n\n\tacquireFocus() {\n\t\tthis.restoreFocusTarget = DOMSH.findDeepActiveElement();\n\t\tif (this.focusBar) {\n\t\t\tconst focusable = DOMSH.findFlatFirstChild(this.focusBar, DOM.IS_focusable);\n\t\t\tif (focusable) {\n\t\t\t\tfocusable.focus();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tif (this.stableStartBar) {\n\t\t\tconst focusable = DOMSH.findFlatFirstChild(this.stableStartBar, DOM.IS_focusable);\n\t\t\tif (focusable) {\n\t\t\t\tfocusable.focus();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n}\n\n/**\n * Les widgets qui veulent afficher une toolbar lorsque le focus est dans leur descendance doivent\n * implémenter cette interface.\n */\nexport interface IWedFocusBarPointer extends HTMLElement {\n\tfocusBar?: BarActions<IWedletActionCtx>;\n}\n\nconst isWedFocusBarPointer: INodeFilter<IWedFocusBarPointer> = function (h: any): h is IWedFocusBarPointer {return h.focusBar != null};\n\nfunction onFocus(this: void, wedMgr: WedMgr, focusElt: Element) {\n\t(wedMgr.wedEditor as IWedEditorCommonBar).commonBar.planChangeFocusBar((focusElt as IWedFocusBarPointer).focusBar);\n}\n\nfunction onSelChange(wedMgr: WedMgr, sel: Selection | null): undefined | true {\n\tconst editor = wedMgr.wedEditor as IWedEditorCommonBar;\n\t//console.log(\"commonBar:onSelChange:::\", sel);\n\tif (sel == null) {\n\t\teditor.commonBar.planChangeFocusBar(null);\n\t\treturn;\n\t}\n\tconst focus = DOM.findParentOrSelf(sel.focusNode, null, DOM.IS_element);\n\tif (!focus) return;\n\tconst eltBoxCtn = DOMSH.findFlatParentEltOrSelf(focus, editor.rootNode, isEltBoxSelection);\n\tif (eltBoxCtn?.selMode === \"caret\") {\n\t\t//on est bien dans un widget avec sel au caret, sinon on va activer la barre du parent du box sélectionné!\n\t\tconst focusBarPointer = DOMSH.findFlatParentEltOrSelf(focus, editor.rootNode, isWedFocusBarPointer);\n\t\teditor.commonBar.planChangeFocusBar(focusBarPointer ? focusBarPointer.focusBar : null);\n\t}\n}\n\nfunction onKeydown(this: IWedEditorCommonBar, ev: KeyboardEvent) {\n\tswitch (ev.key) {\n\tcase ' ':\n\t\tif (!ACTION.isAccelPressed(ev)) break;\n\tcase 'Escape':\n\t\t//Retour du focus à l'éditeur\n\t\tev.stopImmediatePropagation();\n\t\tif (this.commonBar.restoreFocusTarget instanceof HTMLElement) this.commonBar.restoreFocusTarget.focus();\n\t\tbreak;\n\tcase 'ArrowLeft':\n\t\t// focusBar -> stableBar\n\t\t//FIXME RTL ?\n\t\tif (this.commonBar.focusBar && this.commonBar.stableStartBar && DOM.isAncestor(this.commonBar.focusBar, ev.target as Node)) {\n\t\t\tconst next = DOM.findLastChild(this.commonBar.stableStartBar, IS_ActionableEnabled);\n\t\t\tif (next) {\n\t\t\t\tev.stopImmediatePropagation();\n\t\t\t\tnext.focus();\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase 'ArrowRight':\n\t\t// stableBar -> focusBar\n\t\t//FIXME RTL ?\n\t\tif (this.commonBar.focusBar && this.commonBar.stableStartBar && DOM.isAncestor(this.commonBar.stableStartBar, ev.target as Node)) {\n\t\t\tconst next = DOM.findFirstChild(this.commonBar.focusBar, IS_ActionableEnabled);\n\t\t\tif (next) {\n\t\t\t\tev.stopImmediatePropagation();\n\t\t\t\tnext.focus();\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n}\n\nfunction planRefreshFull(wedMgr: WedMgr) {\n\t(wedMgr.wedEditor as IWedEditorCommonBar).commonBar.planRefreshFull();\n}\n\nfunction planRefreshStableBar(wedMgr: WedMgr) {\n\t(wedMgr.wedEditor as IWedEditorCommonBar).commonBar.planRefreshStableBar();\n}\n\n\nfunction requestIdleCallback(this: WedCommonBar, deadline: RequestIdleDeadline) {\n\tif (deadline.timeRemaining() < 5) {\n\t\tthis._redrawPlanned = window.requestIdleCallback(this._requestIdleCallback);\n\t\treturn;\n\t}\n\tthis._redrawPlanned = null;\n\tthis.redraw();\n}\n\nREG.reg.addSvcToList(\"actions:wed:commonbar:start\", \"undo\", 1, \"wedEditorUndoAction\", 50);\nREG.reg.addSvcToList(\"actions:wed:commonbar:start\", \"redo\", 1, \"wedEditorRedoAction\", 51);\n"]}