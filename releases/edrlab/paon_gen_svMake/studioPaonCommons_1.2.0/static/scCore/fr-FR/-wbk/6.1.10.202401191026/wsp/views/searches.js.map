{"version":3,"sources":["/@back@/wsp/views/searches.tsx"],"names":["REG","BaseAreaView","DOM","JSX","DOMSH","WSP","Tabs","SimpleTagArea","Button","FocusItem","SearchRequest","UiCritBool","BarActions","SrcGrid","BASIS","POPUP","AccelKeyMgr","Action","ActionMenuDep","IO","ERROR","ExportResultCsv_item","ExportResultCsv_task","ExportResultItems","Searches","[object Object]","this","srcDt","search","available","_fetchSearches","promise","_addOrUpdateTab","whereCrit","Element","id","title","description","_saveSearches","searchId","searchLabel","searchDescription","persist","select","tab","tabs","getTabByCode","area","setWhereCrit","setLabel","refresh","view","selectTab","newId","currentTabId","_a","selectedTab","persistTabs","findTabs","SearchResultPersistArea","addTab","resultsOptions","setDescription","position","length","newTab","addClass","SearchResultArea","_tabs","childElementCount","confirm","okLbl","closeTab","Math","abs","random","toString","init","super","_initialize","wsp","reg","env","criterions","results","privateUri","kind","sr","attachShadow","SHADOWDOM_INIT","_initAndInstallSkin","localName","appendChild","createElement","î","areasContext","skinOver","_initTab","movable","onclick","_onClickTab","_createLabel","_labelElt","ondblclick","areaContext","onDblclickTab","shadowRoot","_newDelButton","slot","Object","assign","actionContext","uiContext","barActionsInit","onRemoveTab","tabindex-custom","icon","ui-context","ev","preventDefault","stopImmediatePropagation","findHost","editSearch","deleteSearch","code","getWhereCrit","isAvailable","waitForAvailable","orderedTabs","areas","resp","wspServer","config","privateFolderUrl","fetch","qs","status","JSON","parse","headers","get","savedSearch","asJson","searches","doc","parseDomValid","whereXml","push","documentElement","forEach","entry","getId","reorderTabs","e","log","getLabel","ser","fields","fetchJson","method","body","stringify","Content-Type","universe","wsFrames","ws","postMsg","svc","type","uri","showNotifError","visitor","options","visitViews","visitViewsAsync","closed","_shown","msgListeners","removeListener","_onLiaiseMsg","place","eventsMgr","_onConnRenewed","onLiaiseMsg","bind","on","onConnRenewed","m","onSyncLost","registerSkin","customElements","define","conf","max","ctx","lastDatas","elt","newElt","initialize","ovrLabel","_label","SearchResult","editable","installSkin","head","_abstract","onEdit","disabled","_found","_bar","actions","barActions","initGrid","newInit","srcGrid","skinScroll","undefined","_grid","_refresh","nodeEquals","_currentWhere","textContent","descTxt","getDescription","desc","AREA_AND_ROOT","buildAbstract","doSearch","srcGridDatas","setDatas","currentWhere","buildWhereXml","_searchColumns","Map","fillSearchColumns","req","setMax","setWhereXml","fetchSearchJson","toXml","count","msgs","resultsEmpty","_b","resultsOne","_c","resultsMore","_d","resultsCount","console","warn","coord","wedSearchCoord","setParamsOnce","buildWedSearch","me","FocusItemSetWedSearch","searchRes","setWedSearch","execute","async","from","SearchItems","import","TplRequestsMenu","forcedSearchRequest","getPersist","addToList","makeFromSearchPersistLists","ct","showMainView","mergeLists","accelKeyMgr","initFromMapActions","mergeListsAsMap","appHeader","mainActions","APPBAR_MAIN_ACTIONS","searchStore","canEditTitle","initSearchRequest","searchTitle","showDialog","titleBar","barLabel","label","closeButton","resizer","viewPortX","viewPortY","initWidth","initHeight","setIcon","setExecute","setActionLists","setGroup","requireVisiblePerm"],"mappings":"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","sourcesContent":["import {IReg, IRegPointer, REG} from 'lib/commons/registry';\nimport {BaseAreaView, IView, IViewsContainer, OBaseAreaViewInit, OViewVisitOptions} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IWspUiEnv, WSP, Wsp} from \"lib/wsp/wsp\";\nimport {OTabsInit, Tab, Tabs} from \"back/commons/widgets/tabs\";\nimport {SimpleTagArea} from \"lib/commons/areas\";\nimport {Button} from \"back/commons/widgets/buttons\";\nimport {FocusItem} from \"back/wsp/actions/srcActions\";\nimport {ISearchFunc, ISearchPersist, ISearchStore, ISearchViewResult, SearchRequest} from \"lib/wsp/search\";\nimport {IUiCritArea, OUiCritInit, UiCritBool} from \"back/wsp/widgets/search/uiCrit\";\nimport {BarActions, OBarActionsInit} from \"back/commons/widgets/bars\";\nimport {OSrcGridInit, SrcGrid} from \"back/wsp/widgets/srcGrid\";\nimport {BASIS, PickInit} from \"back/commons/basis\";\nimport {OSearchItemsInit, SearchItems} from \"back/wsp/dialogs/searchItems\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {AccelKeyMgr, Action, ActionMenuDep, IAction} from \"lib/commons/actions\";\n//déclaration des Area pour l'abstract.\nimport \"back/wsp/widgets/search/itemCrit\";\nimport \"back/wsp/widgets/search/taskCrit\";\nimport {IO} from \"lib/commons/io/io\";\nimport {JSrcFields, srcUri} from \"lib/wsp/src\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {IWedSearchCoordinatorPointer} from \"back/edit/wed/features/searchBar\";\nimport {ExportResultCsv_item, ExportResultCsv_task, ExportResultItems} from \"back/wsp/actions/searchesActions\";\nimport \"back/wsp/views/views_Perms\";\nimport {OAppHeaderInit} from \"back/core/widgets/appHeader\";\nimport {JLastDatas} from \"lib/commons/lastDatas\";\n\n/**\n */\nexport interface Searches extends BaseAreaView<IRegPointer<IWspUiEnv>> {\n\tinitialize(init: OSearchesInit): this\n}\n\nexport interface OSearchesInit extends OBaseAreaViewInit<IRegPointer<IWspUiEnv>>,\n\tPickInit<Searches, 'criterions' | 'privateUri' | 'kind'> {\n\n\t/** Init personnalisé de la barre d'actions principale de cette vue de recherche  */\n\tbarActionsInit?: OBarActionsInit<Searches>\n\n\tresults?: OSearchResultOptions\n}\n\n/**\n * View d'une recherche\n *\n * <br> Déclaration de 'recherches' dans la biibliothèque via des objets\n *  de type {@link ISearchPersist} sur la liste associée à `actionsSearchPersistLists`\n * Exemple :\n * <pre>\n * REG.reg.addToList(\"requests:item\", \"test1\", 1, {\n * \t\ttitle : \"Requete prédéfinie 1\",\n * \t\twhereCrit: <where><exp type=\"Items\" exclude=\"/~annot/;/~air/;/~ext/\" uiCrit=\"wsp-itemcrit-fullwsp\"/><and><exp type=\"FullText\" textSearch=\"11\" options=\";c;\" uiCrit=\"wsp-itemcrit-fulltext\"/></and></where>\n * \t} as ISearchPersist);\n * </pre>\n *\n */\nexport class Searches extends BaseAreaView<IRegPointer<IWspUiEnv>> implements ISearchStore, IViewsContainer, ISearchViewResult {\n\treg: IReg<IWspUiEnv>;\n\twsp: Wsp;\n\tcriterions: Dict<IUiCritArea>;\n\tprivateUri: srcUri;\n\tresultsOptions: OSearchResultOptions;\n\n\tkind: 'item' | 'task'\n\n\t/** Date de dernière modif des requetes enregistrées. */\n\tsrcDt = -1;\n\n\ttabs: Tabs;\n\n\t/**\n\t * Promesse résolue lorsque les requêtes persistante ont été chargées.\n\t * note : on ne peut pas utiliser un BaseAreaViewAsync car le chargement est lazy sur le 1er onShown.\n\t */\n\tavailable: Promise<void>;\n\n\t/** Appelé par le dialogue d'édition des requêtes. */\n\tasync persistSearch(search: ISearchPersist): Promise<void> {\n\t\tif (!this.available) this.available = this._fetchSearches();\n\t\tawait this.available;\n\t\tconst promise = this._addOrUpdateTab(search.whereCrit instanceof Element ? search.whereCrit : search.whereCrit(this), search.id, search.title, search.description, true, true);\n\t\tthis._saveSearches();\n\t\treturn promise;\n\t}\n\n\t/** Visualisation d'une recherche dans un onglet */\n\tprotected async _addOrUpdateTab(whereCrit: Element, searchId?: string, searchLabel?: string, searchDescription?: string, persist = false, select = false): Promise<void> {\n\t\tconst tab = searchId ? this.tabs.getTabByCode(searchId) : null;\n\t\tif (tab) {\n\t\t\t(tab.area as SearchResultArea).setWhereCrit(whereCrit);\n\t\t\t(tab.area as SearchResultArea).setLabel(searchLabel);\n\t\t\ttab.refresh();\n\t\t\tif (tab.view) (tab.view as SearchResult).refresh();\n\t\t\tif (select) await this.tabs.selectTab(tab);\n\t\t} else {\n\t\t\tif (!searchId) searchId = this.newId();\n\t\t\tconst currentTabId = this.tabs.selectedTab?.id;\n\t\t\t// Ordre des tabs : persistants, puis non persistants\n\t\t\tif (persist) {\n\t\t\t\tlet persistTabs = this.tabs.findTabs((tab) => tab.area instanceof SearchResultPersistArea) || [];\n\t\t\t\tawait this.tabs.addTab(new SearchResultPersistArea({title: searchLabel, whereCrit, id: searchId}, this.resultsOptions).setDescription(searchDescription), {select, position: persistTabs.length});\n\t\t\t\tconst newTab = this.tabs.getTabByCode(searchId);\n\t\t\t\tDOM.addClass(newTab, 'reqPersistant');\n\t\t\t} else\n\t\t\t\tawait this.tabs.addTab(new SearchResultArea(searchId, this.resultsOptions).setLabel(searchLabel).setDescription(searchDescription).setWhereCrit(whereCrit), {select, position: this.tabs._tabs.childElementCount});\n\t\t}\n\t}\n\n\tasync viewSearch(whereCrit: Element, searchId?: string, searchLabel?: string, searchDescription?: string): Promise<string> {\n\t\tif (!searchId) searchId = this.newId();\n\t\tawait this._addOrUpdateTab(whereCrit, searchId, searchLabel, searchDescription, false, true);\n\t\treturn searchId;\n\t}\n\n\tasync deleteSearch(id: string): Promise<boolean> {\n\t\tconst tab = this.tabs.getTabByCode(id);\n\t\tif (!tab) return false;\n\t\tif (!(tab.area instanceof SearchResultPersistArea) || await POPUP.confirm(\"Confirmez la suppression de cette recherche\", this, {okLbl: \"Supprimer\"})) {\n\t\t\tif (await this.tabs.closeTab(tab, true, true)) await this._saveSearches();\n\t\t}\n\t\treturn true;\n\t}\n\n\tprotected newId() {\n\t\tlet id;\n\t\tdo {\n\t\t\tid = Math.abs(Math.random() * 99999).toString(36);\n\t\t} while (this.tabs.getTabByCode(id) != null);\n\t\treturn id;\n\t}\n\n\tprotected _initialize(init: OSearchesInit) {\n\t\tsuper._initialize(init); //init this.reg, this.area, this.areaContext\n\t\tthis.wsp = this.reg.env.wsp;\n\t\tthis.criterions = init.criterions;\n\t\tthis.resultsOptions = init.results;\n\t\tthis.privateUri = init.privateUri;\n\t\tthis.kind = init.kind || 'item';\n\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tthis.tabs = sr.appendChild(<Tabs id=\"tabs\" î={{\n\t\t\treg: this.reg,\n\t\t\tareasContext: this,\n\t\t\tskinOver: \"wsp-searches/tabs\"\n\t\t} as OTabsInit<Searches>}/>) as Tabs;\n\n\t\tthis.tabs._initTab = function (tab: Tab<Searches>) {\n\t\t\ttab.movable = this.movable;\n\t\t\ttab.onclick = this._onClickTab;\n\t\t\ttab._createLabel();\n\t\t\ttab._labelElt.ondblclick = tab.areaContext.onDblclickTab;\n\t\t\ttab.shadowRoot.appendChild(tab.areaContext._newDelButton());\n\t\t};\n\n\t\tthis.tabs.appendChild(<BarActions slot=\"tools-end\" î={Object.assign({\n\t\t\treg: this.reg,\n\t\t\tactionContext: this,\n\t\t\tuiContext: \"bar\"\n\t\t} as OBarActionsInit<Searches>, init.barActionsInit)}/> as BarActions<Searches>);\n\n\t}\n\n\t_newDelButton(): Button {\n\t\treturn <Button onclick={this.onRemoveTab} tabindex-custom=\"-1\" icon=\"/@skin@/commons/icons/close.svg\" ui-context=\"bar\" title=\"Supprimer cette recherche\"/> as Button;\n\t}\n\n\tprotected onDblclickTab(this: HTMLElement, ev: MouseEvent) {\n\t\tev.preventDefault();\n\t\tev.stopImmediatePropagation();\n\t\tconst tab = DOMSH.findHost<Tab<Searches>>(this);\n\t\teditSearch(tab.area as SearchResultArea, tab.areaContext, tab, tab.areaContext.kind);\n\t}\n\n\tprotected onRemoveTab(this: Button, ev: MouseEvent) {\n\t\tev.preventDefault();\n\t\tev.stopImmediatePropagation();\n\t\tconst tab = DOMSH.findHost<Tab<Searches>>(this);\n\t\ttab.areaContext.deleteSearch(tab.code);\n\t}\n\n\tbuildWhereXml(): Element {\n\t\treturn (this.tabs.selectedTab?.area as SearchResultArea).getWhereCrit(this);\n\t}\n\n\tasync _fetchSearches() {\n\t\ttry {\n\t\t\tif (!this.wsp.isAvailable) await this.wsp.waitForAvailable(this);\n\t\t\t//console.log(\"_fetchSearches:::\" + this.privateUri);\n\t\t\tconst orderedTabs = this.tabs.areas && this.tabs.areas.length > 0 ? [] as string[] : null;\n\t\t\tconst resp = await this.wsp.wspServer.config.privateFolderUrl.fetch(IO.qs(\"cdaction\", \"GetSrc\", \"format\", \"stream\", \"fields\", \"srcDt\", \"param\", this.wsp.code, \"refUri\", \"\", \"privateUri\", this.privateUri), 'json');\n\t\t\tif (resp.status === 200) {\n\t\t\t\tthis.srcDt = (JSON.parse(resp.headers.get(\"X-SCFIELDS\")) as JSrcFields).srcDt;\n\t\t\t\tconst savedSearch = resp.asJson as JSearchesDatas;\n\t\t\t\t//console.log(\"savedSearch::::::::\", this.srcDt, savedSearch);\n\t\t\t\tif (savedSearch && savedSearch.searches) for (const search of savedSearch.searches) {\n\t\t\t\t\tif (!search) continue;\n\t\t\t\t\tconst doc = DOM.parseDomValid(search.whereXml);\n\t\t\t\t\tif (!doc) continue;\n\t\t\t\t\tif (orderedTabs) orderedTabs.push(search.id);\n\t\t\t\t\tthis._addOrUpdateTab(doc.documentElement, search.id, search.title, null, true, false);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.srcDt = -1;\n\t\t\t}\n\t\t\t//Gestion de l'ordonnancement des tabs et du cleanup des recherches supprimées.\n\t\t\tif (orderedTabs) {\n\t\t\t\t// On récupère les tabs 'custom' (non mémorisées) ouvertes\n\t\t\t\tthis.tabs.areas.forEach((entry) => {\n\t\t\t\t\tif (!(entry instanceof SearchResultPersistArea)) orderedTabs.push(entry.getId());\n\t\t\t\t});\n\t\t\t\tthis.tabs.reorderTabs(true, ...orderedTabs);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tthis.srcDt = -1;\n\t\t\tERROR.log(\"fetchSearches failed\", e);\n\t\t}\n\t}\n\n\tasync _saveSearches() {\n\t\ttry {\n\t\t\tconst searches: JSearchDatas[] = [];\n\t\t\tthis.tabs.areas.forEach((area: SearchResultPersistArea | SearchResultArea) => {\n\t\t\t\tif (area instanceof SearchResultPersistArea)\n\t\t\t\t\tsearches.push({id: area.getId(), title: area.getLabel(this), whereXml: DOM.ser(area.getWhereCrit(this))});\n\t\t\t});\n\t\t\tconst fields = await this.wsp.wspServer.config.privateFolderUrl.fetchJson<JSrcFields>(IO.qs(\"cdaction\", \"PutSrc\", \"format\", \"JSON\", \"fields\", \"srcDt\", \"param\", this.wsp.code, \"refUri\", \"\", \"privateUri\", this.privateUri), {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\tbody: JSON.stringify({searches}),\n\t\t\t\theaders: {\"Content-Type\": \"application/json\"}\n\t\t\t});\n\t\t\tthis.srcDt = fields.srcDt;\n\t\t\tthis.reg.env.universe.wsFrames.ws.postMsg({svc: 'liaise', type: \"searches.saved\", uri: this.privateUri})\n\t\t} catch (e) {\n\t\t\tERROR.log(`Save searches to '${this.privateUri}' failed`, e);\n\t\t\tPOPUP.showNotifError(\"Les modifications de votre liste de recherches n'ont pas pu être enregistrées.\", this);\n\t\t}\n\t}\n\n\tvisitViews(visitor: (view: IView) => any, options?: OViewVisitOptions): any {\n\t\tthis.tabs.visitViews(visitor, options);\n\t}\n\n\tvisitViewsAsync(visitor: (view: IView) => Promise<any>, options?: OViewVisitOptions): Promise<any> {\n\t\treturn this.tabs.visitViewsAsync(visitor, options);\n\t}\n\n\t_shown: boolean;\n\n\tonViewHidden(closed?: boolean): void {\n\t\tthis._shown = false;\n\t\tif (closed) {\n\t\t\tthis.reg.env.universe.wsFrames.ws.msgListeners.removeListener('liaise', this._onLiaiseMsg);\n\t\t\tthis.reg.env.place.eventsMgr.removeListener(\"onConnectionRenewed\", this._onConnRenewed);\n\t\t}\n\t}\n\n\tonViewShown() {\n\t\tthis._shown = true;\n\t\tif (!this._onLiaiseMsg) {\n\t\t\tthis._onLiaiseMsg = this.onLiaiseMsg.bind(this);\n\t\t\tthis.reg.env.universe.wsFrames.ws.msgListeners.on('liaise', this._onLiaiseMsg);\n\t\t}\n\t\tif (!this._onConnRenewed) {\n\t\t\tthis._onConnRenewed = this.onConnRenewed.bind(this);\n\t\t\tthis.reg.env.place.eventsMgr.on(\"onConnectionRenewed\", this._onConnRenewed);\n\t\t}\n\t\tif (!this.available) this.available = this._fetchSearches();\n\t}\n\n\tprotected onSyncLost() {\n\t\tif (this._shown) {\n\t\t\t//On est visible, on refresh\n\t\t\tthis.available = this._fetchSearches();\n\t\t} else {\n\t\t\t//On est masqué, on marque l'état invalide.\n\t\t\tthis.available = null;\n\t\t}\n\t}\n\n\t/** Détection d'une écriture concurente via le service de liaise. */\n\tprotected _onLiaiseMsg: (m: Jsonisable) => void;\n\n\tprotected onLiaiseMsg(m: Jsonisable) {\n\t\tif (m.type === 'searches.saved' && m.uri === this.privateUri) this.onSyncLost();\n\t}\n\n\tprotected _onConnRenewed: () => void;\n\n\tprotected async onConnRenewed() {\n\t\tconst resp = await this.wsp.wspServer.config.privateFolderUrl.fetch(IO.qs(\"cdaction\", \"GetSrc\", \"format\", \"JSON\", \"fields\", \"srcDt\", \"param\", this.wsp.code, \"refUri\", \"\", \"privateUri\", this.privateUri), 'json');\n\t\tif (resp.status === 200 ? this.srcDt !== resp.asJson.srcDt : resp.status === 404 && this.srcDt !== -1) this.onSyncLost();\n\t}\n\n}\n\nREG.reg.registerSkin(\"wsp-searches\", 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\t#tabs {\n\t\tflex: 1;\n\t}\n`);\n\nREG.reg.registerSkin(\"wsp-searches/tabs\", 1, /* language=CSS */ `\n\t#panels {\n\t\tborder-inline-start: none;\n\t\tborder-inline-end: none;\n\t\tborder-bottom: none;\n\t}\n\n\tc-tab {\n\t\tfont-size: var(--label-size);\n\t}\n\n\t#head {\n\t\tmin-height: 2em;\n\t}\n\n\tc-tab:not(.reqPersistant) {\n\t\tfont-style: italic;\n\t}\n`);\n\ncustomElements.define(\"wsp-searches\", Searches);\n\n/** Schéma json d'enregistrement des requetes. */\ninterface JSearchesDatas {\n\tsearches: JSearchDatas[]\n}\n\ninterface JSearchDatas {\n\tid: string\n\ttitle: string\n\twhereXml: string\n}\n\n\n/**\n * Config de l'affichage des résultats d'une requete.\n */\ninterface OSearchResultOptions {\n\t/** Nb max d'items retournés. */\n\tmax?: number\n\t/** Init de la liste des résultats. */\n\tsrcGrid?: OSrcGridInit\n\t/** Actions de la toolbar. */\n\tbarActions?: IAction<SearchResult>[]\n\tmsgs?: JSearchResultL10nMsgs\n}\n\n/**\n * Area de résultat de recherche SANS persistance\n */\nexport class SearchResultArea extends SimpleTagArea<ISearchResultCtx, SearchResult> {\n\toptions: OSearchResultOptions;\n\tconf: OSearchResultInit;\n\twhereCrit?: Element | ((ctx: IRegPointer<IWspUiEnv>) => Element);\n\n\tconstructor(id?: string, options?: OSearchResultOptions, init?: OSearchResultInit) {\n\t\tsuper('wsp-search-result', null, id);\n\t\tthis.conf = init || {};\n\t\tthis.options = options || {};\n\t\tif (!this.options.max) this.options.max = 2000;\n\t}\n\n\tsetWhereCrit(whereCrit?: Element | ((ctx: IRegPointer<IWspUiEnv>) => Element)): this {\n\t\tthis.whereCrit = whereCrit;\n\t\treturn this;\n\t}\n\n\tgetWhereCrit(ctx: IRegPointer<IWspUiEnv>): Element {\n\t\treturn this.whereCrit instanceof Element ? this.whereCrit : this.whereCrit(ctx);\n\t}\n\n\tprotected newElt(ctx: ISearchResultCtx, lastDatas?: JLastDatas): SearchResult {\n\t\tconst elt = super.newElt(ctx, lastDatas);\n\t\telt.initialize(Object.assign({\n\t\t\treg: ctx.reg,\n\t\t\tarea: this,\n\t\t\tareaContext: ctx,\n\t\t}, this.conf));\n\t\treturn elt;\n\t}\n\n}\n\n/**\n * Area de résultat de recherche AVEC persistance\n */\nexport class SearchResultPersistArea extends SearchResultArea {\n\tconstructor(protected persist: ISearchPersist, options: OSearchResultOptions) {\n\t\tsuper(persist.id);\n\t\tthis.options = options;\n\t\tif (!this.options.max) this.options.max = 2000;\n\t\tthis.whereCrit = persist.whereCrit;\n\t}\n\n\tgetLabel(ctx: ISearchResultCtx): string {\n\t\tconst ovrLabel = (typeof this._label === 'function') ? this._label(ctx, this) : this._label;\n\t\treturn ovrLabel || this.persist.title || \"...\";\n\t}\n\n\tgetPersist(ctx: ISearchResultCtx): ISearchPersist {\n\t\tthis.persist.whereCrit = this.whereCrit;\n\t\tthis.persist.title = this.getLabel(ctx);\n\t\treturn this.persist;\n\t}\n}\n\n\nexport interface ISearchResultCtx extends OUiCritInit, ISearchStore {\n}\n\n\n/**\n * View d'affichage d'une requête.\n * Prévue pour être aussi utilisable en dehors du widget container Searches.\n */\nexport interface SearchResult extends BaseAreaView<ISearchResultCtx>, ISearchViewResult {\n\tinitialize(init: OSearchResultInit): this\n}\n\nexport interface OSearchResultInit extends OBaseAreaViewInit<ISearchResultCtx> {\n\t/** true par défaut */\n\teditable?: boolean\n}\n\nexport interface JSearchResultL10nMsgs {\n\t/** vars : 'max' */\n\tresultsMore?: (max: number) => string\n\tresultsEmpty?: string\n\tresultsOne?: string\n\tresultsCount?: (count: number) => string\n}\n\nexport class SearchResult extends BaseAreaView<ISearchResultCtx> implements ISearchViewResult {\n\treg: IReg<IWspUiEnv>;\n\tarea: SearchResultPersistArea | SearchResultArea;\n\twsp: Wsp;\n\n\tprotected _grid: SrcGrid;\n\tprotected _abstract: Button | HTMLDivElement;\n\tprotected _found: HTMLElement;\n\tprotected _bar: BarActions<SearchResult>;\n\n\tprotected _searchColumns: Map<string, string | ISearchFunc>;\n\n\tprotected _currentWhere: Element;\n\n\tprotected _initialize(init: OSearchResultInit) {\n\t\tconst conf = Object.assign({\n\t\t\teditable: true,\n\t\t}, init)\n\t\tsuper._initialize(conf); //init this.reg, this.area, this.areaContext\n\t\tthis.wsp = this.reg.env.wsp;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\t//sr.appendChild(<div>{DOM.ser(this.area.persist.whereCrit)}</div>);\n\t\tthis.reg.installSkin(\"scroll/small\", sr);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tconst head = sr.appendChild(<div id=\"header\"/>);\n\t\tthis._abstract = head.appendChild(<Button id=\"abstract\" onclick={this.onEdit}/> as Button);\n\t\tthis._abstract.disabled = !conf.editable;\n\t\tthis._found = head.appendChild(<span id=\"found\"/>);\n\t\tthis._bar = head.appendChild(<BarActions id=\"bar\" î={{\n\t\t\treg: this.reg,\n\t\t\tactionContext: this,\n\t\t\tactions: this.area.options.barActions,\n\t\t} as OBarActionsInit<SearchResult>}/> as BarActions<SearchResult>);\n\t\tconst initGrid = BASIS.newInit(this.area.options.srcGrid, this.reg);\n\t\tif (initGrid.skinScroll === undefined) initGrid.skinScroll = 'scroll/small';\n\t\tthis._grid = sr.appendChild(new SrcGrid().initialize(initGrid));\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tif (!DOM.nodeEquals(this._currentWhere, this.area.getWhereCrit(this.areaContext))) {\n\t\t\tthis._abstract.textContent = null;\n\t\t\tconst descTxt = this.area.getDescription(this.areaContext);\n\t\t\tif (descTxt)\n\t\t\t\tthis._abstract.textContent = descTxt;\n\t\t\telse {\n\t\t\t\tconst desc = UiCritBool.AREA_AND_ROOT.buildAbstract(this.area.getWhereCrit(this.areaContext), this.areaContext);\n\t\t\t\tif (desc) this._abstract.appendChild(desc);\n\t\t\t}\n\t\t\tthis._grid.refresh();// indispensble pour terminer d'initialiser le tree (def des colonnes, ...)\n\t\t\tthis._bar.refresh();\n\t\t\tthis.doSearch();\n\t\t}\n\t}\n\n\tasync doSearch() {\n\t\t//console.log(\"doSearch:::\", this.area.persist.whereCrit);\n\t\tthis._grid.srcGridDatas.setDatas([]);\n\t\tthis._found.textContent = \"En cours...\";\n\t\tconst currentWhere = this.buildWhereXml();\n\t\ttry {\n\t\t\tif (!this._searchColumns) {\n\t\t\t\tthis._searchColumns = new Map();\n\t\t\t\tthis._grid.fillSearchColumns(this._searchColumns);\n\t\t\t}\n\t\t\tconst req = new SearchRequest(this._searchColumns).setMax(this.area.options.max + 1).setWhereXml(currentWhere);\n\t\t\tconst results = await WSP.fetchSearchJson(this.wsp, this, req.toXml());\n\t\t\tconst count = results.length;\n\t\t\tconst max = this.area.options.max;\n\t\t\t//console.log(\"results::::\", results);\n\t\t\tthis._grid.srcGridDatas.setDatas(results);\n\t\t\tif (results.length === 0) this._found.textContent = this.area.options.msgs?.resultsEmpty ? this.area.options.msgs.resultsEmpty : \"Aucun item trouvé\";\n\t\t\telse if (results.length === 1) this._found.textContent = this.area.options.msgs?.resultsOne ? this.area.options.msgs.resultsOne : \"1 item trouvé\";\n\t\t\telse if (results.length > this.area.options.max) this._found.textContent = this.area.options.msgs?.resultsMore ? this.area.options.msgs.resultsMore(max) : `Plus de ${max} items trouvés`;\n\t\t\telse this._found.textContent = this.area.options.msgs?.resultsCount ? this.area.options.msgs.resultsCount(count) : `${count} items trouvés`;\n\t\t\tthis._currentWhere = currentWhere;\n\t\t} catch (e) {\n\t\t\tthis._found.textContent = \"Échec\";\n\t\t\tERROR.log(`Do search failed: ${DOM.ser(currentWhere)}`, e);\n\t\t}\n\t}\n\n\tbuildWhereXml(): Element {\n\t\treturn this.area.getWhereCrit(this.areaContext);\n\t}\n\n\tasync viewSearch(whereCrit: Element, searchId: string | null, searchLabel?: string, searchDescription?: string): Promise<string> {\n\t\tconsole.warn('not implemented');\n\t\treturn undefined;\n\t}\n\n\tsetWedSearch() {\n\t\tconst coord = (this.reg.env as IWedSearchCoordinatorPointer).wedSearchCoord;\n\t\tif (coord && this._currentWhere) {\n\t\t\tcoord.setParamsOnce(UiCritBool.AREA_AND_ROOT.buildWedSearch(this._currentWhere, this.areaContext.criterions) || null);\n\t\t}\n\t}\n\n\tonEdit(this: Button) {\n\t\tif (this.disabled) return;\n\t\tconst me = DOMSH.findHost<SearchResult>(this);\n\t\teditSearch(me.area, me.areaContext, me, (me.areaContext as Searches).kind);\n\t}\n}\n\n/** */\nexport class FocusItemSetWedSearch extends FocusItem {\n\n\texecute(ctx: SrcGrid, ev?: Event) {\n\t\tconst searchRes = DOMSH.findHost<SearchResult>(ctx);\n\t\tsearchRes.setWedSearch();\n\t\tsuper.execute(ctx, ev);\n\t}\n}\n\n\nREG.reg.registerSkin(\"wsp-search-result\", 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\t#header {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\talign-items: center;\n\t}\n\n\t#abstract {\n\t\tflex: 1;\n\t\toverflow: auto;\n\t\tmax-height: 2.6em;\n\t\talign-items: start;\n\t\tfont-size: var(--label-size);\n\t}\n\n\t#found {\n\t\tfont-weight: bold;\n\t\tborder-inline-start: 1px solid var(--border-color);\n\t\tborder-inline-end: 1px solid var(--border-color);\n\t\tpadding: 0 .5em;\n\t}\n\n\twsp-src-grid {\n\t\tflex: 1;\n\t}\n\n\t.boolOp, .boolBracket {\n\t\tcolor: var(--alt1-color);\n\t}\n\n\t.critVal {\n\t\tfont-weight: bold;\n\t}\n\n`);\n\ncustomElements.define(\"wsp-search-result\", SearchResult);\n\nasync function editSearch(search: SearchResultPersistArea | SearchResultArea, ctx: ISearchResultCtx, from: HTMLElement, kind: 'item' | 'task' = 'item') {\n\tconst {SearchItems} = await import(\"back/wsp/dialogs/searchItems.js\");\n\tconst {TplRequestsMenu} = await import(\"back/wsp/actions/searchesActions.js\");\n\n\tconst forcedSearchRequest = search instanceof SearchResultPersistArea ? search.getPersist(ctx) : search.getWhereCrit(ctx);\n\tif (!forcedSearchRequest)\n\t\tif (kind === 'item')\n\t\t\tctx.reg.addToList(\"actions:searchItems:bar:item\", \"tplRequestsMenu\", 1, TplRequestsMenu.makeFromSearchPersistLists(ctx, \"requests:item\", \"requests:item:searchItems:item\"));\n\t\telse\n\t\t\tctx.reg.addToList(\"actions:searchItems:bar:task\", \"tplRequestsMenu\", 1, TplRequestsMenu.makeFromSearchPersistLists(ctx, \"requests:task\", \"requests:item:searchItems:task\"));\n\n\tconst ct = new SearchItems().initialize({\n\t\treg: ctx.reg,\n\t\tshowMainView: true,\n\t\tsrcGrid: {\n\t\t\tactions: kind === 'item' ?\n\t\t\t\tctx.reg.mergeLists(\"actions:wsp:shortDesc\", \"actions:searchItem:shortDesc:item\")\n\t\t\t\t: ctx.reg.mergeLists(\"actions:wsp:shortDesc:task\", \"actions:searchItem:shortDesc:task\"),\n\t\t\taccelKeyMgr: new AccelKeyMgr().initFromMapActions(kind === 'item' ?\n\t\t\t\tctx.reg.mergeListsAsMap(\"accelkeys:searchItem:shortDesc\", \"accelkeys:wsp:shortDesc:item\")\n\t\t\t\t: ctx.reg.mergeListsAsMap(\"accelkeys:wsp:shortDesc:task\", \"accelkeys:wsp:shortDesc:task\")),\n\t\t},\n\t\tcriterions: ctx.criterions,\n\t\tappHeader: {\n\t\t\tmainActions: ctx.reg.mergeLists(SearchItems.APPBAR_MAIN_ACTIONS, kind === 'item' ? \"actions:searchItems:bar:item\" : \"actions:searchItems:bar:task\"),\n\t\t} as OAppHeaderInit<any>,\n\t\tsearchStore: search instanceof SearchResultPersistArea ? ctx : null,\n\t\tmsgs: kind === 'item' ? undefined : {\n\t\t\tresultsMore: max => `Plus de ${max} tâches trouvées`,\n\t\t\tresultsEmpty: 'Aucune tâche trouvée',\n\t\t\tresultsOne: '1 tâche trouvée',\n\t\t\tresultsCount: count => `${count} tâches trouvées`,\n\t\t},\n\t\tcanEditTitle: search instanceof SearchResultPersistArea ? true : false,\n\t\tinitSearchRequest: forcedSearchRequest,\n\t} as OSearchItemsInit);\n\tconst searchTitle = search.getLabel(ctx);\n\n\tPOPUP.showDialog(ct, from, {\n\t\ttitleBar: {\n\t\t\tbarLabel: {\n\t\t\t\tlabel: kind === 'item'\n\t\t\t\t\t? (searchTitle ? `Édition de la recherche d'items '${searchTitle}'` : \"Édition de la recherche d'items\")\n\t\t\t\t\t: (searchTitle ? `Édition de la recherche de tâches '${searchTitle}'` : \"Édition de la recherche de tâches\")\n\t\t\t}, closeButton: {}\n\t\t},\n\t\tresizer: {},\n\t\tviewPortX: \"middle\",\n\t\tviewPortY: \"middle\",\n\t\tinitWidth: \"90vw\",\n\t\tinitHeight: \"90vh\"\n\t});\n}\n\nREG.reg.addToList(\"actions:wspApp:searches\", \"refresh\", 1, new Action<SearchResult>('refresh')\n\t.setLabel(\"Recommencer la recherche\")\n\t.setIcon(\"/@skin@/commons/icons/refresh.svg\")\n\t.setExecute((ctx: SearchResult) => {\n\t\tctx.doSearch();\n\t}), 10);\n\nREG.reg.addToList(\"actions:wspApp:searches:item\", \"mainburger\", 1, new ActionMenuDep<SearchResult>('mainburger')\n\t.setLabel(\"Actions complémentaires sur la recherche\")\n\t.setIcon(\"/@skin@/commons/icons/hamburger.svg\")\n\t.setActionLists('actions:wspApp:searches:item:mainburger')\n\t.setGroup(\"burger\"), 10000);\nREG.reg.addToList(\"actions:wspApp:searches:item:mainburger\", \"actionExportResultItems\", 1, new ExportResultItems().requireVisiblePerm(\"ui.searches.export.items\"));\nREG.reg.addToList(\"actions:wspApp:searches:item:mainburger\", \"actionExportResultCsv\", 1, new ExportResultCsv_item().requireVisiblePerm(\"ui.searches.export.props\"));\n\nREG.reg.addToList(\"actions:wspApp:searches:task\", \"mainburger\", 1, new ActionMenuDep<SearchResult>('mainburger')\n\t.setLabel(\"Actions complémentaires sur la recherche\")\n\t.setIcon(\"/@skin@/commons/icons/hamburger.svg\")\n\t.setActionLists('actions:wspApp:searches:task:mainburger'), 1);\nREG.reg.addToList(\"actions:wspApp:searches:task:mainburger\", \"actionExportResultCsv\", 1, new ExportResultCsv_task().requireVisiblePerm(\"ui.searches.export.props\"));\n\n\nREG.reg.addToList(\"actions:wspApp:searches\", \"del\", 1, new Action<SearchResult>('del')\n\t.setLabel(\"Supprimer\")\n\t.setIcon(\"/@skin@/commons/icons/delete.svg\")\n\t.setExecute((ctx: SearchResult) => {\n\t\tconst searches = DOMSH.findHost<Searches>(ctx);\n\t\tsearches.deleteSearch(ctx.area.getId());\n\t}), 9999);\n"]}