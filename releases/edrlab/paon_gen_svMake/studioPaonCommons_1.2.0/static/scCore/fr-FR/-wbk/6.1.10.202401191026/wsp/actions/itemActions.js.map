{"version":3,"sources":["/@back@/wsp/actions/itemActions.ts"],"names":["SRC","ITEM","WSP","SrcAction","EItemTypeFamily","ERROR","LANG","POPUP","ActionMenuDep","ImportRes","[object Object]","id","super","this","_group","_label","exactOne","families","res","_enablePerms","ctx","ev","shortDesc","shortDescs","env","reg","input","document","createElement","type","itemType","wsp","wspMetaUi","getItemType","itModel","exts","getExtensions","accept","Array","isArray","join","click","file","Promise","resolve","onchange","files","length","progress","showProgress","emitter","update","srcUri","progressCallback","close","e","report","SINGLETON","_S","ImportFolder","folder","setAttribute","fileDone","promisesMap","async","relPath","webkitRelativePath","substr","indexOf","onProgress","ExportRes","noFamilies","_enableSrcPerms","link","href","getStreamUrl","getMainStreamSrcUri","url","download","extractLeafFromUri","ItemsSetResonsabilities","setVisible","hasFeature","hasResps","requireVisiblePerm","list","listResps","forEach","resp","push","ItemsSetResponsability","code","name","_description","desc","atLeastOne","isEnabled","sd","getResp","SrcEditResp","import","nb","itemsTitle","getItemUriLabel","repName","showDialog","initialize","uiRoot","titleBar","barLabel","label","closeButton","resizer","initWidth","initHeight","onNextClose"],"mappings":"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","sourcesContent":["import {SRC} from \"lib/wsp/src\";\nimport {IShortDescCtx, ITEM} from \"lib/wsp/item\";\nimport {WSP} from \"lib/wsp/wsp\";\nimport {SrcAction} from \"back/wsp/actions/srcActions\";\nimport {EItemTypeFamily, IDatasResp} from \"lib/wsp/wspMetaUi\";\nimport {ERROR} from \"lib/core/errorReport\";\nimport {LANG} from \"lib/commons/lang\";\nimport \"back/wsp/actions/actions_Perms\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {ActionMenuDep, IAction} from \"lib/commons/actions\";\n\n/**\n * Remplace le contenu d'une ressource par un fichier sélectionné sur le système de fichier\n */\nexport class ImportRes<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tstatic SINGLETON = () => ImportRes._S || (ImportRes._S = new ImportRes());\n\tprivate static _S: ImportRes<IShortDescCtx>;\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"importSrc\");\n\t\tthis._group = \"importExport\";\n\t\tthis._label = \"Remplacer...\"; //On garde le mot \"Importer\" pour les actions d'imports qui aboutissent à des créations (voire des remplacement mais après double confirmation).\n\t\tthis.exactOne = true;\n\t\tthis.families = [EItemTypeFamily.res /* A trancher : , EItemTypeFamily.xml*/];\n\t\tthis._enablePerms = \"action.item#import.resFile\";\n\t}\n\n\t/** Ouvre la boîte de dialogue de sélection de fichier et lance l'upload */\n\tasync execute(ctx: C, ev?: Event): Promise<void> {\n\t\tconst [shortDesc] = ctx.shortDescs;\n\t\tif (!shortDesc) return;\n\t\tconst {env} = ctx.reg;\n\n\t\tconst input = document.createElement('input');\n\t\tinput.type = \"file\";\n\t\tconst itemType = env.wsp.wspMetaUi.getItemType(shortDesc.itModel);\n\t\tconst exts = itemType.getExtensions();\n\t\tinput.accept = Array.isArray(exts) ? exts.join(',') : exts;\n\t\tinput.click();\n\t\tconst file = await new Promise<File>((resolve) => {\n\t\t\tinput.onchange = function (this: HTMLInputElement) {\n\t\t\t\tresolve(this.files.length ? this.files[0] : null);\n\t\t\t}\n\t\t});\n\t\tif (!file) return;\n\t\tconst progress = POPUP.showProgress(ctx.emitter, \"Import en cours...\");\n\t\ttry {\n\t\t\tawait ITEM.update(env.wsp, ctx.emitter, ctx.shortDescs[0].srcUri, file, progress.progressCallback);\n\t\t\tprogress.close();\n\t\t} catch (e) {\n\t\t\tprogress.close();\n\t\t\tawait ERROR.report(\"Une erreur est survenue lors de l'import de la ressource.\", e, ctx);\n\t\t}\n\t}\n}\n\n/**\n * Remplace le contenu d'une ressource de type dossier par un dossier sélectionné sur le système de fichier\n */\nexport class ImportFolder<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tstatic SINGLETON = () => ImportFolder._S || (ImportFolder._S = new ImportFolder());\n\tprivate static _S: ImportFolder<IShortDescCtx>;\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"importSrc\");\n\t\tthis._group = \"importExport\";\n\t\tthis._label = \"Importer un dossier...\";\n\t\tthis.exactOne = true;\n\t\tthis.families = [EItemTypeFamily.folder];\n\t}\n\n\t/** Ouvre la boîte de dialogue de sélection de fichier et lance l'upload */\n\tasync execute(ctx: IShortDescCtx, ev?: Event): Promise<void> {\n\t\tconst [shortDesc] = ctx.shortDescs;\n\t\tif (!shortDesc) return;\n\t\tconst {env} = ctx.reg;\n\n\t\tconst input = document.createElement('input');\n\t\tinput.type = \"file\";\n\t\tinput.setAttribute('webkitdirectory', '');\n\t\tinput.setAttribute('directory', '');\n\t\tinput.click();\n\t\tconst files = await new Promise<FileList>((resolve) => {\n\t\t\tinput.onchange = function (this: HTMLInputElement) {\n\t\t\t\tresolve(this.files);\n\t\t\t}\n\t\t});\n\t\tif (!files.length) return;\n\t\tconst progress = POPUP.showProgress(ctx.emitter, \"Import en cours...\");\n\t\tlet fileDone = 0;\n\t\ttry {\n\t\t\tawait LANG.promisesMap(files, async (file) => {\n\t\t\t\tconst relPath = file.webkitRelativePath.substr(file.webkitRelativePath.indexOf('/') + 1);\n\t\t\t\tawait ITEM.update(env.wsp, ctx.emitter, `${ctx.shortDescs[0].srcUri}/${relPath}`, file);\n\t\t\t\tprogress.onProgress(++fileDone, files.length + 1);\n\t\t\t}, 4);\n\t\t\tprogress.close();\n\t\t} catch (e) {\n\t\t\tprogress.close();\n\t\t\tawait ERROR.report(\"Une erreur est survenue lors de l'import du dossier.\", e, ctx);\n\t\t}\n\t}\n}\n\n/**\n * Démarre le téléchargement d'une ressource vers le système de fichier\n */\nexport class ExportRes<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tstatic SINGLETON = () => ExportRes._S || (ExportRes._S = new ExportRes());\n\tprivate static _S: ExportRes<IShortDescCtx>;\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"downloadSrc\");\n\t\tthis._group = \"importExport\";\n\t\tthis._label = \"Exporter vers un fichier...\";\n\t\tthis.exactOne = true;\n\t\tthis.noFamilies = [EItemTypeFamily.folder];\n\t\tthis._enableSrcPerms = [\"read.node.export\"];\n\t}\n\n\t/** Ouvre la boîte de dialogue de sélection de fichier et lance l'upload */\n\tasync execute(ctx: C, ev?: Event): Promise<void> {\n\t\tconst [shortDesc] = ctx.shortDescs;\n\t\tif (!shortDesc) return;\n\t\tconst {env} = ctx.reg;\n\t\tconst link = document.createElement('a');\n\t\tconst itemType = env.wsp.wspMetaUi.getItemType(shortDesc.itModel);\n\t\tlink.href = WSP.getStreamUrl(env.wsp, itemType.getMainStreamSrcUri(shortDesc)).url;\n\t\tlink.download = SRC.extractLeafFromUri(shortDesc.srcUri);\n\t\tlink.click();\n\t}\n}\n\n\n/**\n * Affecte des responsabilités sur un ensemble d'items\n */\nexport class ItemsSetResonsabilities<C extends IShortDescCtx> extends ActionMenuDep<C> {\n\n\tstatic SINGLETON = () => ItemsSetResonsabilities._S || (ItemsSetResonsabilities._S = new ItemsSetResonsabilities());\n\tprivate static _S: ItemsSetResonsabilities<IShortDescCtx>;\n\n\tconstructor(id?: string) {\n\t\tsuper(id || 'setResonsability');\n\t\tthis._label = \"Modifier les responsabilités...\";\n\t\tthis._group = \"edit\";\n\t\tthis.setVisible((ctx) => ctx.reg.env.wsp.hasFeature(\"resp\") && ctx.reg.env.wsp.wspMetaUi.hasResps);\n\t\tthis.requireVisiblePerm(\"action.item#set.resps\");\n\t}\n\n\tgetActions(ctx: C): IAction<C>[] {\n\t\tconst list: ItemsSetResponsability<C>[] = [];\n\t\tctx.reg.env.wsp.wspMetaUi.listResps('item').forEach((resp) => list.push(new ItemsSetResponsability(resp)));\n\t\treturn list;\n\t}\n\n}\n\n\n/**\n * Action d'une resp sur un ensemble d'items\n */\nexport class ItemsSetResponsability<C extends IShortDescCtx> extends SrcAction<C> {\n\n\tconstructor(public resp: IDatasResp) {\n\t\tsuper(resp.code);\n\t\tthis._label = resp.name;\n\t\tthis._description = resp.desc;\n\t\tthis.atLeastOne = true;\n\t\tthis.setVisible((ctx) => ctx.reg.env.wsp.hasFeature(\"resp\") && ctx.reg.env.wsp.wspMetaUi.hasResps);\n\t\tthis.requireVisiblePerm(\"action.item#set.resps\");\n\t}\n\n\tisEnabled(ctx: C): boolean {\n\t\tif (!super.isEnabled(ctx)) return false;\n\t\tfor (const sd of ctx.shortDescs) {\n\t\t\tconst itemType = ctx.reg.env.wsp.wspMetaUi.getItemType(sd.itModel);\n\t\t\tif (!itemType.getResp(this.resp.code)) return false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tasync execute(ctx: C, ev?: Event) {\n\t\tconst reg = ctx.reg;\n\t\tconst {SrcEditResp} = await import(\"back/wsp/dialogs/srcEditResp.js\");\n\t\tconst nb = ctx.shortDescs.length;\n\t\tlet itemsTitle = \"\";\n\t\tif (nb == 1) {\n\t\t\titemsTitle = ITEM.getItemUriLabel(ctx.shortDescs[0].srcUri, ctx.shortDescs[0]);\n\t\t} else\n\t\t\titemsTitle = `${nb} items`;\n\t\tconst repName = this.resp.name;\n\n\t\tawait POPUP.showDialog(new SrcEditResp().initialize({\n\t\t\treg: ctx.reg,\n\t\t\tresp: this.resp,\n\t\t\tshortDescs: ctx.shortDescs,\n\t\t}), ctx.reg.env.uiRoot, {\n\t\t\ttitleBar: {barLabel: {label: `Responsabilité '${repName}' sur ${itemsTitle}`}, closeButton: {}},\n\t\t\tresizer: {},\n\t\t\tinitWidth: \"min(40vw,30em)\",\n\t\t\tinitHeight: \"20vh\"\n\t\t}).onNextClose();\n\n\t}\n}\n\n\n"]}