{"version":3,"sources":["/@back@/wsp/widgets/ribbon/ribbon.tsx"],"names":["BaseElement","MsgLabel","REG","DOMSH","DOM","JSX","ShadowJsx","renderAppend","xhtml","RESPS","SRC","POPUP","WSP","EItResp","InfoRefreshItemDisplays","ITEM","ViewsContainer","SrcGrid","FocusItemSelRef","ETaskStage","LIFECYCLE","BarActions","Tasks","AccelKeyMgr","ACTION","LANG","LOCALE","RespEditField","DynGen","RibbonBase","shortDescCtx","findHost","this","ribbonMode","getAttribute","mode","setAttr","tabIndex","onkeypress","onKeyPress","[object Object]","factory","findFocusableOnShown","onclick","promiseTooltip","owner","tooltip","addEventListener","focusbale","findFlatNext","firstElementChild","IS_focusable","focus","hoverAllowed","skin","skinOver","onblur","ev","popupTooltip","relatedTarget","isAncestor","close","popup","showFloating","popupFloating","closeOnBlur","mouseOverRetarderCaller","click","init","reg","findReg","sr","attachShadow","SHADOWDOM_INIT","installSkin","_initAndInstallSkin","localName","_a","env","infoBroker","addConsumer","in","key","isAnyControlPressed","stopImmediatePropagation","preventDefault","super","_refresh","closed","_b","removeConsumer","info","initialized","srcRef","currentSrcRef","longDesc","refresh","registerSkin","RibbonItemInfo","_initialize","setAttribute","template","getSvc","_template","templateTt","_templateTt","longDescChange","add","onLongDescChange","bind","setTooltip","_tooltip","ondragstart","setShortDescTransferToDragSession","shortDescs","emitter","ondragend","resetShortDescTransferToDragSession","root","createElement","id","shadowRoot","rib","type","wsp","wspMetaUi","getItemType","itModel","isExtItem","srcUri","itTi","getIcon","extractLeafFromUri","getTitle","dt","Date","srcDt","foreignActions","undefined","icon","title","extractWspCdFromWspRef","itFullUriInOwnerWsp","extractSrcRefFromWspRef","toLocaleDateString","toLocaleTimeString","srcUser","nickOrAccount","getPref","getItemUriLabel","ldNew","ldOld","customElements","define","RibbonTabs","itemTabs","tabs","parent","getElementById","ctn","appendChild","style","minWidth","computeWidth","IntersectionObserver","cb","intersectionRatio","setHidden","parentElement","threshold","rootMargin","observe","min","max","getComputedStyle","direction","lastElementChild","offsetLeft","clientWidth","tab","nextElementSibling","RibbonRefs","_noFetch","conf","Object","assign","refsListCode","DEFAULT_REFS_LIST","isHistoryOrTrashUri","hidden","confs","mergeLists","filter","entry","isVisible","call","setFloating","_details","setTimeout","async","fetchSrcList","result","total","length","defaultConf","tpl","shortViewRefs","entriesMsg","description","label","grid","initialize","hideHeaders","autoSelOnFocus","itemHandlingReact","defaultAction","SINGLETON","actions","accelKeyMgr","initFromMapActions","mergeListsAsMap","emptyBody","_currentDetailsConf","emptyGridMsg","confTitle","class","innerText","select","onchange","pos","Number","parseInt","value","items","srcGridDatas","setDatas","redrawShortView","forEach","fetch","then","resp","registerSvc","ctx","ascs","fetchSrcNetJson","getShortDescDef","lnks","map","src","nb","addSvcToList","addToList","RibbonLc","lcState","getLcStateOrUnknown","lcSt","getLcName","iconUrl","name","î","listAllTransitionActions","actionContext","uiContext","groupOrder","getLcTransitionsGroupOrder","disableFullOverlay","ld","lcDt","setTextContent","formatDateDigitsToSec","format","lcBy","isHistoryUri","hasLcOnItem","RibbonDynGen","dynGen","autoResize","w","code","r","onViewShown","RibbonBarActions","barActions","overrideButtonsElts","btn","addClass","RibbonResp","rspUsrs","toRespsList","itemType","resps","count","hasMore","datas","nbUsers","keyElt","desc","values","hasResps","level","isInError","inptELt","rspSt","errors","setAttrBool","RibbonTasks","hasTasks","_fetch","counts","fetchSrc","pending","tkPendingCount","forthcoming","tkForthcomingCount","tasks","ephemeralView","refreshCb","visibleStage","toString","views"],"mappings":"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","sourcesContent":["import {BaseElement, MsgLabel, OMsgLabelInit, OSkinableInit} from \"back/commons/basis\";\nimport {IReg, IRegPointer, REG} from \"lib/commons/registry\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IItemUiEnv, SrcMain} from \"back/wsp/views/itemMain\";\nimport {DOM, JSX, ShadowJsx} from \"lib/commons/xml/dom\";\nimport {renderAppend, TemplateResult, xhtml} from \"lib/commons/utils/htmlLit\";\nimport {JSrcFields, RESPS, SRC} from \"lib/wsp/src\";\nimport {ITooltipPointer, POPUP, PopupFloating, PopupTooltip} from \"back/commons/widgets/popups\";\nimport {WSP} from \"lib/wsp/wsp\";\nimport {EItResp, InfoRefreshItemDisplays, IShortDescCtx, ITEM} from \"lib/wsp/item\";\nimport {IView, OViewsContainerInit, ViewsContainer} from \"lib/commons/views\";\nimport {SrcGrid} from \"back/wsp/widgets/srcGrid\";\nimport {FocusItemSelRef} from \"back/wsp/actions/srcActions\";\nimport {ETaskStage, LIFECYCLE} from \"lib/wsp/lcTask\";\nimport {BarActions, OBarActionsInit} from \"back/commons/widgets/bars\";\nimport {Tasks} from \"back/wsp/views/tasks\";\nimport {AccelKeyMgr, ACTION} from \"lib/commons/actions\";\nimport {LANG, LOCALE} from \"lib/commons/lang\";\nimport {OUserRefInit} from \"back/core/widgets/userRef\";\nimport {Button, OButtonInit} from \"back/commons/widgets/buttons\";\nimport {IOpenForeignItemSvc} from \"back/wsp/actions/wspActions\";\nimport {ORespEditFieldInit, RespEditField} from \"back/wsp/widgets/resps/respEdit\";\nimport {Tab, Tabs} from \"back/commons/widgets/tabs\";\nimport {IInfo, IInfoConsumer} from \"lib/commons/infos\";\nimport {DynGen, ODynGenInit} from \"back/wsp/views/dynGen\";\n\nexport interface IRibbonAreaContext extends IRegPointer<IItemUiEnv> {\n}\n\nexport class RibbonBase extends BaseElement implements ITooltipPointer, IInfoConsumer {\n\n\treg: IReg<IItemUiEnv>;\n\n\tget shortDescCtx(): IShortDescCtx {return DOMSH.findHost<SrcMain>(this)}\n\n\tget ribbonMode(): 'static' | 'hover' | 'button' {return (this.getAttribute('role') as 'static' | 'hover' | 'button' | null) || 'static'}\n\n\tset ribbonMode(mode: 'static' | 'hover' | 'button') {\n\t\tif (this.ribbonMode === mode) return;\n\t\tDOM.setAttr(this, 'mode', mode);\n\t\tif (mode === 'static') {\n\t\t\tDOM.setAttr(this, 'role', null);\n\t\t\tthis.tabIndex = -1;\n\t\t\tthis.onkeypress = null;\n\t\t\t//if(this.matches(':focus')) this.blur(); utile ?\n\t\t} else {\n\t\t\tDOM.setAttr(this, 'role', mode);\n\t\t\tthis.tabIndex = 0;\n\t\t\tthis.onkeypress = this.onKeyPress;\n\t\t}\n\t}\n\n\t/** Associe un tooltip à ce ribbon. */\n\tprotected setTooltip(factory: (owner: HTMLElement, tooltip: PopupTooltip) => IView | null, findFocusableOnShown?: boolean) {\n\t\tif (!factory) return;\n\n\t\tthis.ribbonMode = 'hover';\n\n\t\tthis.onclick = POPUP.promiseTooltip(this, findFocusableOnShown ?\n\t\t\t\t(owner: HTMLElement, tooltip: PopupTooltip): IView | null => {\n\t\t\t\t\ttooltip.addEventListener('c-shown', () => {\n\t\t\t\t\t\tconst focusbale = DOMSH.findFlatNext(tooltip.firstElementChild, tooltip, DOM.IS_focusable);\n\t\t\t\t\t\tif (focusbale) focusbale.focus();\n\t\t\t\t\t});\n\t\t\t\t\treturn factory(owner, tooltip);\n\t\t\t\t}\n\t\t\t\t: factory,\n\t\t\t{hoverAllowed: true, skin: \"c-popup-floating\", skinOver: \"ribbon/tooltip\"});\n\t\tthis.onblur = (ev: FocusEvent) => {\n\t\t\tif (this.popupTooltip && ev.relatedTarget && !DOM.isAncestor(this.popupTooltip, ev.relatedTarget as HTMLElement)) this.popupTooltip.close();\n\t\t}\n\t}\n\n\tpopupTooltip?: PopupTooltip;\n\n\t/** Associe une floating window à ce ribbon. */\n\tprotected setFloating(factory: (ribbon: RibbonBase, popup: PopupFloating) => IView | null, findFocusableOnShown?: boolean) {\n\t\tif (!factory) return;\n\t\tthis.ribbonMode = 'button';\n\t\tthis.onclick = () => {\n\t\t\tconst popup = POPUP.showFloating((popup: PopupFloating) => {\n\t\t\t\tif (findFocusableOnShown) {\n\t\t\t\t\tpopup.addEventListener('c-shown', () => {\n\t\t\t\t\t\tconst focusbale = DOMSH.findFlatNext(popup.firstElementChild, popup, DOM.IS_focusable);\n\t\t\t\t\t\tif (focusbale) focusbale.focus();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tthis.popupFloating = popup;\n\t\t\t\tpopup.addEventListener('c-close', () => {\n\t\t\t\t\tthis.popupFloating = null;\n\t\t\t\t});\n\t\t\t\treturn factory(this, popup);\n\t\t\t}, this, this, {closeOnBlur: true, skin: \"c-popup-floating\", skinOver: \"ribbon/floating scroll/small\"});\n\t\t}\n\t}\n\n\tpopupFloating?: PopupFloating;\n\n\n\t/**\n\t * Si pas de tooltip via setTooltip() ni de setFloating(), mais affichage d'un menu par ex, appelle this.click() après\n\t * un temps de stabilisation de la souris au dessus du ribbon.\n\t */\n\tprotected callClickOnMouseover() {\n\t\tthis.ribbonMode = 'button';\n\t\tPOPUP.mouseOverRetarderCaller(this, false, () => this.click());\n\t}\n\n\tprotected _initialize(init: any): void {\n\t\tthis.reg = this.findReg(init);\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"scroll/small\", sr);\n\t\tthis.reg.installSkin(\"wsp-rib\", sr);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\t\tthis.reg.env.infoBroker?.addConsumer(this);\n\t}\n\n\t/** Ribbon clickable. */\n\tonKeyPress(ev: KeyboardEvent) {\n\t\tif (LANG.in(ev.key, \"Enter\", \" \") && !ACTION.isAnyControlPressed(ev)) {\n\t\t\tev.stopImmediatePropagation();\n\t\t\tev.preventDefault();\n\t\t\tthis.click();\n\t\t}\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tif (this.popupTooltip) this.popupTooltip.close();\n\t}\n\n\tonViewHidden(closed?: boolean) {\n\t\tif (closed) this.reg?.env.infoBroker?.removeConsumer(this);\n\t\tif (this.popupTooltip) this.popupTooltip.close();\n\t\tif (this.popupFloating) this.popupFloating.close();\n\t}\n\n\tonInfo(info: IInfo): void {\n\t\tif (this.initialized) {\n\t\t\tif (info instanceof InfoRefreshItemDisplays) {\n\t\t\t\tconst srcRef = info.srcRef;\n\t\t\t\tconst currentSrcRef = SRC.srcRef(this.reg.env.longDesc);\n\t\t\t\tif (srcRef == currentSrcRef) this.refresh();\n\t\t\t}\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 0 1 auto;\n\t\tdisplay: block;\n\t\tpadding: 2px;\n\t\tmax-height: 4em;\n\t\ttext-align: center;\n\t\tfont-size: var(--label-size);\n\t\toverflow: hidden;\n\t\tuser-select: none;\n\t}\n\n\t:host([mode=button]) {\n\t\tcursor: pointer;\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--focus-outline);\n\t\toutline-offset: -1px;\n\t}\n\n\t.smallTi {\n\t\tcolor: var(--fade-color);\n\t\tfont-style: italic;\n\t\tfont-size: 85%;\n\t}\n`);\n\nREG.reg.registerSkin(\"ribbon/tooltip\", 1, /* language=CSS */ `\n\t#content {\n\t\tdisplay: block;\n\t\tpadding: .2em;\n\t\tz-index: 101;\n\t}\n`);\n\nREG.reg.registerSkin(\"ribbon/floating\", 1, /* language=CSS */ `\n\t#content {\n\t\tmax-width: 40vw;\n\t}\n`);\n\n\n/**\n *\n */\nexport class RibbonItemInfo extends RibbonBase {\n\n\ttemplate: (rib: RibbonItemInfo) => TemplateResult;\n\ttemplateTt: (rib: RibbonItemInfo) => TemplateResult;\n\n\tprotected _initialize(init: any): void {\n\t\tsuper._initialize(init);\n\t\tthis.setAttribute(\"c-resizable\", \"\");\n\n\t\tthis.template = this.reg.getSvc(\"ribbon.item.info.tpl\") || RibbonItemInfo._template;\n\t\tthis.templateTt = this.reg.getSvc(\"ribbon.item.info.tplTt\") || RibbonItemInfo._templateTt;\n\n\t\tthis.reg.env.longDescChange.add(this.onLongDescChange.bind(this));\n\t\tthis.setTooltip(this._tooltip);\n\t\tthis.setAttribute(\"draggable\", \"\");\n\t\tthis.ondragstart = (ev: DragEvent) => ITEM.setShortDescTransferToDragSession({\n\t\t\tshortDescs: [this.reg.env.longDesc],\n\t\t\temitter: this,\n\t\t\treg: this.reg\n\t\t}, ev, 'native');\n\t\tthis.ondragend = ITEM.resetShortDescTransferToDragSession;\n\t}\n\n\t_tooltip(this: void, owner: RibbonItemInfo, tooltip: PopupTooltip) {\n\t\tconst root = <div id=\"ttRoot\"/> as HTMLElement;\n\t\towner.reg.installSkin(owner.localName, root.attachShadow(DOMSH.SHADOWDOM_INIT));\n\t\ttooltip.addEventListener('c-show', (ev: CustomEvent) => {\n\t\t\trenderAppend(owner.templateTt(owner), root.shadowRoot);\n\t\t});\n\t\treturn root;\n\t}\n\n\tstatic _template(this: void, rib: RibbonItemInfo) {\n\t\tconst longDesc = rib.reg.env.longDesc;\n\t\tconst type = rib.reg.env.wsp.wspMetaUi.getItemType(longDesc.itModel);\n\t\tif (ITEM.isExtItem(longDesc.srcUri)) {\n\t\t\treturn xhtml`<div>\n<div id=\"itTi\">${longDesc.itTi}</div>\n<img align=\"center\" src=\"${type.getIcon(longDesc)}\"/><span id=\"srcCd\">${SRC.extractLeafFromUri(longDesc.srcUri)}</span>\n<span id=\"foreignItem\"> (item étranger)</span>\n<span id=\"itModel\">${type.getTitle(longDesc)}</span></div>`;\n\t\t} else {\n\t\t\treturn xhtml`<div>\n<div id=\"itTi\">${longDesc.itTi}</div>\n<img align=\"center\" src=\"${type.getIcon(longDesc)}\"/><span id=\"srcCd\">${SRC.extractLeafFromUri(longDesc.srcUri)}</span>\n<span id=\"itModel\">${type.getTitle(longDesc)}</span></div>`;\n\t\t}\n\t}\n\n\tstatic _templateTt(this: void, rib: RibbonItemInfo) {\n\t\tconst longDesc = rib.reg.env.longDesc;\n\t\tconst dt = new Date(longDesc.srcDt);\n\t\tconst foreignActions = !ITEM.isExtItem(longDesc.srcUri) ? undefined :\n\t\t\txhtml`<div id=\"actions\">\n\t\t\t\t<c-button class=\"inline\" i.=\"${{reg: rib.reg, icon: \"/@skin@/wsp/actions/openItem.svg\", title: \"Ouvrir cet item étranger dans son atelier\"} as OButtonInit}\" e.click=\"${function (this: Button) {\n\t\t\t\trib.reg.getSvc<IOpenForeignItemSvc>(\"openForeignItem\")(rib.reg, WSP.extractWspCdFromWspRef(longDesc.itFullUriInOwnerWsp), WSP.extractSrcRefFromWspRef(longDesc.itFullUriInOwnerWsp));\n\t\t\t}}\"/>\n\t\t\t</div>`;\n\t\treturn xhtml`${foreignActions}<div id=\"srcDt\">modifié le <span class=\"val\">${dt.toLocaleDateString(\"fr\")} à ${dt.toLocaleTimeString(\"fr\")}</span></div>\n<div id=\"srcUser\" b.hidden=\"${!longDesc.srcUser}\">par <c-userref class=\"inline\" i.=\"${{reg: rib.reg, nickOrAccount: longDesc.srcUser} as OUserRefInit}\"/></div>\n${rib.reg.getPref(\"wsp.hideWspStruct\") ? undefined : xhtml`<div id=\"path\">${ITEM.getItemUriLabel(longDesc.srcUri, longDesc)}</div>`}`;\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\trenderAppend(this.template(this), this.shadowRoot);\n\t}\n\n\tonLongDescChange(ldNew: JSrcFields, ldOld: JSrcFields) {\n\t\tthis.refresh();\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib-info', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1 1 auto;\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tjustify-content: center;\n\t\ttext-align: start;\n\t\tpadding: 0 .5em;\n\t}\n\n\t#itModel {\n\t\tmargin-inline-end: 1em;\n\t\tfont-style: italic;\n\t}\n\n\t#itModel::before {\n\t\tcontent: \"· \";\n\t}\n\n\t#itTi {\n\t\tcolor: var(--alt1-color);\n\t\tfont-weight: bold;\n\t}\n\n\timg {\n\t\tcursor: grab;\n\t\tfilter: var(--filter);\n\t}\n\n\t.val {\n\t\tcolor: var(--alt1-color);\n\t\tfont-weight: bold;\n\t}\n\n\t#path {\n\t\tcolor: var(--fade-color);\n\t}\n\n\t#foreignItem {\n\t\tcolor: var(--alt1-color);\n\t\tfont-weight: bold;\n\t\tfont-style: italic;\n\t}\n\n\t:host(#ttRoot) {\n\t\tpadding: .3em;\n\t\tfont-size: var(--label-size);\n\t}\n`);\n\ncustomElements.define('wsp-rib-info', RibbonItemInfo);\n\n\n/**\n *\n */\nexport class RibbonTabs extends RibbonBase {\n\n\titemTabs: Tabs<SrcMain>\n\n\tprotected _initialize(init: any) {\n\t\tsuper._initialize(init);\n\t\tthis.reg.env.longDescChange.add(this.onLongDescChange.bind(this));\n\t\tthis.itemTabs = DOMSH.findHost<SrcMain>(this)?.tabs;\n\t\tif (this.itemTabs) {\n\t\t\tconst parent = this.itemTabs.shadowRoot.getElementById(\"tabs\");\n\t\t\tconst ctn = this.shadowRoot.appendChild(<div id=\"ctn\"/>);\n\t\t\t//console.log(\"parentTabss:::\",parent);\n\t\t\tctn.style.minWidth = this.computeWidth(parent);\n\t\t\tnew IntersectionObserver(cb => {\n\t\t\t\t\t//console.log(\"cb[0].intersectionRatio:::\", cb[0].intersectionRatio);\n\t\t\t\t\tif (cb[0].intersectionRatio > .9) {\n\t\t\t\t\t\t//On peut insérer les onglets\n\t\t\t\t\t\twhile (parent.firstElementChild) ctn.appendChild(parent.firstElementChild);\n\t\t\t\t\t\tDOM.setHidden(parent.parentElement, true);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t//Place insuffisante, on replace dans l'emplacement d'origine\n\t\t\t\t\t\twhile (ctn.firstElementChild) parent.appendChild(ctn.firstElementChild);\n\t\t\t\t\t\tDOM.setHidden(parent.parentElement, false);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t// [.8, 1] et margin V 10px pour éviter erreur d'arrondis si zoom du nav et instabilité ou bloquage.\n\t\t\t\t{root: this, threshold: [.8, 1], rootMargin: \"10px 0px\"}).observe(ctn);\n\t\t}\n\t}\n\n\tprotected computeWidth(parent: HTMLElement) {\n\t\tlet min: number, max: number;\n\t\tif (getComputedStyle(this).direction === \"rtl\") {\n\t\t\tmin = (parent.lastElementChild as HTMLElement).offsetLeft;\n\t\t\tmax = (parent.firstElementChild as HTMLElement).offsetLeft + parent.firstElementChild.clientWidth;\n\t\t} else {\n\t\t\tmin = (parent.firstElementChild as HTMLElement).offsetLeft;\n\t\t\tmax = (parent.lastElementChild as HTMLElement).offsetLeft + parent.lastElementChild.clientWidth;\n\t\t}\n\t\treturn ((max - min) * 1.1) + \"px\";\n\t}\n\n\tprotected onLongDescChange() {\n\t\tconst ctn = this.shadowRoot.getElementById(\"ctn\");\n\t\tif(!ctn) return;\n\t\tif (ctn.firstElementChild) {\n\t\t\t//Les onglets sont ici, dans le ribbon, on les refresh (visibilité perms)\n\t\t\tfor (let tab = ctn.firstElementChild as Tab; tab; tab = tab.nextElementSibling as Tab) {\n\t\t\t\ttab.refresh();\n\t\t\t}\n\t\t\tctn.style.minWidth = this.computeWidth(ctn);\n\t\t} else {\n\t\t\t//Les onglets sont à leur place initiale.\n\t\t\tctn.style.minWidth = this.computeWidth(this.itemTabs.shadowRoot.getElementById(\"tabs\"));\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib-tabs', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 100 100 0;\n\t\tdisplay: flex;\n\t\tmin-width: 0;\n\t\tmin-height: 0;\n\t\tjustify-content: center;\n\t\talign-items: flex-end;\n\t\toverflow: visible;\n\t\tpadding: 0;\n\t}\n\n\t#ctn {\n\t\tdisplay: flex;\n\t\tmin-width: 0;\n\t\tmin-height: 0;\n\t\tjustify-content: center;\n\t\tborder-top: 1px solid transparent;\n\t}\n\n\tc-tab {\n\t\tflex-direction: column;\n\t\tmin-width: var(--tab-size, 6em);\n\t\tborder-bottom: solid 2px transparent;\n\t}\n\n\t.selected {\n\t\tborder-color: var(--tabl-select-color);\n\t\tcolor: var(--tabl-select-color);\n\t\t-webkit-text-stroke: .5px var(--tabl-select-color);\n\t}\n`);\n\ncustomElements.define('wsp-rib-tabs', RibbonTabs);\n\n\n/**\n * Items référençant cet item.\n */\n\n/** Configuration de liste de liens */\nexport interface JRibbonRefsConf {\n\n\tlabel: string\n\n\tdescription?: string\n\n\tentriesMsg?: (nb: number | undefined) => string\n\n\temptyGridMsg?: string\n\n\tshortViewRefs?: (this: HTMLElement, ctx: IRegPointer<IItemUiEnv>, result: JSrcFields[]) => TemplateResult\n\n\tfetchSrcList: (this: HTMLElement, ctx: IRegPointer<IItemUiEnv>) => Promise<JSrcFields[]>\n\n\tisVisible?: (this: HTMLElement, ctx: IRegPointer<IItemUiEnv>) => boolean\n\n}\n\nexport interface ORibbonRefsInit extends OSkinableInit {\n\t/** Code de la liste fournissant les refs à exploiter dans ce ribon. valeur par défaut : ribbon.item.refs.details\n\t *\t\tLa **première** entrée visible de la liste est celle qui alimente le total (forme repliée))\n\t */\n\trefsListCode: string\n}\n\nexport class RibbonRefs extends RibbonBase {\n\n\tconfs: JRibbonRefsConf[];\n\n\tprivate conf: ORibbonRefsInit;\n\n\tprivate _noFetch = true;\n\n\tprivate _currentDetailsConf: JRibbonRefsConf;\n\n\tstatic DEFAULT_REFS_LIST = 'ribbon.item.refs.confs';\n\n\tprivate _total: number;\n\n\tprotected _initialize(init: ORibbonRefsInit): void {\n\t\tthis.conf = Object.assign({\n\t\t\trefsListCode: RibbonRefs.DEFAULT_REFS_LIST,\n\t\t}, init);\n\t\tsuper._initialize(this.conf);\n\n\t\tif (ITEM.isHistoryOrTrashUri(this.reg.env.longDesc.srcUri)) {\n\t\t\tthis.hidden = true;\n\t\t\treturn;\n\t\t}\n\n\t\tthis.confs = this.reg.mergeLists(this.conf.refsListCode);\n\t\tthis.confs = this.confs?.filter(entry => !entry.isVisible || entry.isVisible.call(this, this));\n\t\tthis.setFloating(this.reg.getSvc(\"ribbon.item.refs.details\") || this._details);\n\n\t\t// Load retardé pour donner la priorité au contenu\n\t\tsetTimeout(async () => {\n\t\t\tthis._noFetch = false;\n\t\t\tthis.refresh();\n\t\t}, 500);\n\t}\n\n\tasync fetch(this: void, rib: RibbonRefs): Promise<JSrcFields[]> {\n\t\treturn await rib.confs[0].fetchSrcList.call(rib, rib);\n\t}\n\n\tprivate redrawShortView(result?: JSrcFields[]): void {\n\t\tconst total = result ? result.length : undefined;\n\t\tconst defaultConf = this.confs[0];\n\t\tconst tpl = defaultConf.shortViewRefs\n\t\t\t? defaultConf.shortViewRefs.call(this, this, result)\n\t\t\t: xhtml`<div id=\"total\" title=\"${(defaultConf.entriesMsg ? defaultConf.entriesMsg(total) : null) || defaultConf.description || defaultConf.label}\">${total !== undefined ? total : '...'}</div><div id=\"label\">réf.</div>`;\n\t\trenderAppend(tpl, this.shadowRoot);\n\t}\n\n\t_details(this: void, rib: RibbonRefs, popup: PopupFloating): IView | null {\n\n\t\tconst grid = new SrcGrid().initialize({\n\t\t\treg: rib.reg,\n\t\t\thideHeaders: true,\n\t\t\tautoSelOnFocus: \"first\",\n\t\t\titemHandlingReact: rib.reg.env.infoBroker,\n\t\t\tdefaultAction: FocusItemSelRef.SINGLETON,\n\t\t\tactions: rib.reg.mergeLists(\"actions:ribbonRef:shortDesc\", \"actions:wsp:shortDesc\"),\n\t\t\taccelKeyMgr: new AccelKeyMgr().initFromMapActions(rib.reg.mergeListsAsMap(\"accelkeys:ribbonRef:shortDesc\", \"accelkeys:wsp:shortDesc\")),\n\t\t\temptyBody: () => <span>{rib._currentDetailsConf?.emptyGridMsg || 'Aucun item'}</span>\n\t\t});\n\n\t\tlet confTitle = <div class=\"title\"/> as HTMLDivElement;\n\n\t\tpopup.addEventListener('c-show', async (ev: CustomEvent) => {\n\t\t\t//grid.dataHolder.setDatas([]);\n\t\t\tconst wsp = rib.reg.env.wsp;\n\t\t\tconfTitle.innerText = \"\";\n\t\t\t//grid.srcGridDatas.setDatas([]); flash UI\n\n\t\t\tif (rib.confs.length === 1) {\n\t\t\t\trib._currentDetailsConf = rib.confs[0];\n\t\t\t\tconfTitle.appendChild(<div>{rib._currentDetailsConf.label}</div>);\n\t\t\t} else {\n\t\t\t\tconst select = confTitle.appendChild(<select onchange={async () => {\n\t\t\t\t\t//grid.srcGridDatas.setDatas([]); flash UI\n\t\t\t\t\tconst pos = Number.parseInt(select.value);\n\t\t\t\t\trib._currentDetailsConf = rib.confs[pos];\n\t\t\t\t\tconst items = await rib._currentDetailsConf.fetchSrcList.call(rib, rib);\n\t\t\t\t\tgrid.srcGridDatas.setDatas(items);\n\t\t\t\t\tgrid.focus();\n\t\t\t\t\tif (pos === 0) rib.redrawShortView(items);\n\t\t\t\t}}/>) as HTMLSelectElement;\n\t\t\t\trib.confs.forEach((entry, pos) => {\n\t\t\t\t\tselect.appendChild(<option value={pos} label={entry.label} title={entry.description}/>);\n\t\t\t\t});\n\t\t\t}\n\t\t\trib._currentDetailsConf = rib.confs[0];\n\t\t\tconst items = await rib._currentDetailsConf.fetchSrcList.call(rib, rib);\n\t\t\tgrid.srcGridDatas.setDatas(items);\n\t\t\trib.redrawShortView(items);\n\t\t\tgrid.focus();\n\t\t});\n\n\t\treturn <div>\n\t\t\t<ShadowJsx skin=\"wsp-rib-refs\" reg={rib.reg}>\n\t\t\t\t{confTitle}\n\t\t\t\t{grid}\n\t\t\t</ShadowJsx>\n\t\t</div>;\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tif (!this.hidden) {\n\t\t\tif (!this._noFetch)\n\t\t\t\tthis.fetch(this).then((resp) => this.redrawShortView(resp));\n\t\t\telse\n\t\t\t\tthis.redrawShortView();\n\t\t}\n\n\t}\n}\n\n/*\nTrop proche de 'ribbonRef.conf.revlinks.item'. La différence est subtile => on laisse 'ribbonRef.conf.revlinks.item', le plus complet\nREG.reg.registerSvc('ribbonRef.conf.items', 1, {\n\tlabel: \"Items référençants\",\n\tfetchSrcList: (ctx)=>WSP.fetchSearchJson(\n\t\tctx.reg.env.wsp,\n\t\tthis,\n\t\tnew SearchRequest().addFieldColumns(...ctx.reg.env.wsp.getShortDescFields()).setWhere(new SearchLinkParents(SRC.srcRef(ctx.reg.env.longDesc))).toXml()\n\t),\n} as JRibbonRefsConf);\nREG.reg.addSvcToList(RibbonRefs.DEFAULT_REFS_LIST, 'items', 1, 'ribbonRef.conf.items');\n */\n\nREG.reg.registerSvc('ribbonRef.conf.revlinks.item', 1, {\n\tlabel: \"Références à cet item\",\n\tfetchSrcList: async (ctx) => {\n\t\tconst ascs = await ITEM.fetchSrcNetJson(ctx.reg.env.wsp, this, SRC.srcRef(ctx.reg.env.longDesc), ctx.reg.env.wsp.getShortDescDef(),\n\t\t\t\"asc\", true, null, null, 100, 1, null, 'itemOnly');\n\t\treturn ascs?.lnks?.map(entry => entry.src);\n\t},\n\tentriesMsg: (nb) => nb != undefined ? `${nb} référence(s) à cet item` : null,\n\temptyGridMsg: \"Aucune\",\n} as JRibbonRefsConf);\nREG.reg.addSvcToList(RibbonRefs.DEFAULT_REFS_LIST, 'revlinks.item', 1, 'ribbonRef.conf.revlinks.item', -1);\n\nREG.reg.registerSvc('ribbonRef.conf.revlinks.all', 1, {\n\tlabel: \"Références à cet item ou à ses ancres\",\n\tfetchSrcList: async (ctx) => {\n\t\tconst ascs = await ITEM.fetchSrcNetJson(ctx.reg.env.wsp, this, SRC.srcRef(ctx.reg.env.longDesc), ctx.reg.env.wsp.getShortDescDef(),\n\t\t\t\"asc\", true, null, null, 100, 1, null);\n\t\treturn ascs?.lnks?.map(entry => entry.src);\n\t},\n\tentriesMsg: (nb) => nb != undefined ? `${nb} référence(s) à cet item ou à ses ancres` : null,\n\temptyGridMsg: \"Aucune\",\n} as JRibbonRefsConf);\n// Ajouté SSi subItem dans le reg par modeling\n//REG.reg.addSvcToList(RibbonRefs.DEFAULT_REFS_LIST, 'revlinks.all', 1, 'ribbonRef.conf.revlinks.all');\n\nREG.reg.registerSkin('wsp-rib-refs', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 0 1 auto;\n\t\tmin-width: 2rem;\n\t\t--row-bgcolor: var(--bgcolor);\n\t}\n\n\t#total {\n\t\tcolor: var(--alt1-color);\n\t\tfont-weight: bold;\n\t}\n\n\t#label {\n\t\twhite-space: nowrap;\n\t\tfont-style: italic;\n\t\tcolor: var(--fade-color);\n\t}\n\n\t.title {\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tfont-size: var(--label-size);\n\t\tpadding: .2em;\n\t\tcolor: var(--fade-color);\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\ttext-align: center;\n\t\tmin-width: 12em;\n\t\tjustify-content: center;\n\t}\n\n\tselect {\n\t\tflex: 1;\n\t\tmin-width: 0;\n\t\tbackground-color: var(--form-bgcolor);\n\t\tcolor: var(--form-color);\n\t\tborder: 1px solid var(--border-color);\n\t\ttext-overflow: ellipsis;\n\t\tfont-size: inherit;\n\t}\n\n\twsp-src-grid {\n\t\tborder: none;\n\t}\n\n`);\n\n\nREG.reg.addToList(\"actions:ribbonRef:shortDesc\", \"focusItem\", 1, FocusItemSelRef.SINGLETON);\ncustomElements.define('wsp-rib-refs', RibbonRefs);\n\n\n/**\n * Life-cyle de l'item.\n */\nexport class RibbonLc extends RibbonBase {\n\n\ttemplate: (rib: RibbonLc) => TemplateResult;\n\n\tprotected _initialize(init: any): void {\n\t\tsuper._initialize(init);\n\t\tthis.reg.env.longDescChange.add(this.refresh.bind(this));\n\t\tthis.template = this.reg.getSvc(\"ribbon.item.lc.tpl\") || RibbonLc._template;\n\t\tthis.setTooltip(RibbonLc._tooltip, true);\n\t\t//this.callClickOnMouseover();\n\t\t//this.onclick = (ev: MouseEvent) => {\n\t\t// \tPOPUP.showPopupActions({\n\t\t// \t\treg: this.reg,\n\t\t// \t\tactions: LIFECYCLE.listAllTransitionActions(this.reg.env.wsp.wspMetaUi),\n\t\t// \t\tactionContext: this.shortDescCtx,\n\t\t//\t\tgroupOrder: this.reg.env.wsp.wspMetaUi.getLcTransitionsGroupOrder(),\n\t\t// \t\theadBuilder: (root: HTMLElement) => {\n\t\t// \t\t\troot.append(\"Changé par \", <c-user>xx</c-user>, \" le \", SRCDRAWER.dateFormatter.format(this.reg.env.longDesc.lcDt),\n\t\t// \t\t\t\t<div>Changer d'état :</div>)\n\t\t// \t\t}\n\t\t// \t}, this, this);\n\t\t// }\n\t}\n\n\tstatic _template(this: void, rib: RibbonLc): TemplateResult {\n\t\tconst longDesc = rib.reg.env.longDesc;\n\t\tconst lcState = rib.reg.env.wsp.wspMetaUi.getLcStateOrUnknown(longDesc.lcSt);\n\t\treturn xhtml`<div class=\"smallTi\">${rib.reg.env.wsp.wspMetaUi.getLcName()}</div><div id=\"lcSt\"><img src=\"${lcState.iconUrl || \"\"}\"/>${lcState.name}</div>`;\n\t}\n\n\tstatic _tooltip(this: void, rib: RibbonLc, tooltip: PopupTooltip): IView | null {\n\t\tconst tpl = <div id=\"ttRoot\">\n\t\t\t<ShadowJsx skin={rib.localName} reg={rib.reg}>\n\t\t\t\t<div id=\"last\">\n\t\t\t\t\t<div>Changé le <span id=\"lastDt\"/></div>\n\t\t\t\t\t<div>par <c-user id=\"lastUser\"/></div>\n\t\t\t\t</div>\n\t\t\t\t<BarActions class=\"vertical\" î={{\n\t\t\t\t\treg: rib.reg,\n\t\t\t\t\tactions: LIFECYCLE.listAllTransitionActions(rib.reg.env.wsp.wspMetaUi),\n\t\t\t\t\tactionContext: rib.shortDescCtx,\n\t\t\t\t\tuiContext: \"dialog\",\n\t\t\t\t\tgroupOrder: rib.reg.env.wsp.wspMetaUi.getLcTransitionsGroupOrder(),\n\t\t\t\t\tdisableFullOverlay: true\n\t\t\t\t} as OBarActionsInit<IShortDescCtx>}/>\n\t\t\t</ShadowJsx>\n\t\t</div>;\n\t\ttooltip.addEventListener('c-show', () => {\n\t\t\tconst ld = rib.reg.env.longDesc;\n\t\t\tif (ld.lcDt > 0) {\n\t\t\t\tDOM.setHidden(tpl.shadowRoot.getElementById(\"last\"), false);\n\t\t\t\tDOM.setTextContent(tpl.shadowRoot.getElementById(\"lastDt\"), LOCALE.formatDateDigitsToSec.format(ld.lcDt));\n\t\t\t\tDOM.setTextContent(tpl.shadowRoot.getElementById(\"lastUser\"), ld.lcBy);\n\t\t\t} else {\n\t\t\t\tDOM.setHidden(tpl.shadowRoot.getElementById(\"last\"), true);\n\t\t\t}\n\t\t});\n\t\treturn tpl;\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\tif (ITEM.isHistoryUri(longDesc.srcUri) || !LIFECYCLE.hasLcOnItem(longDesc, this.reg.env.wsp.wspMetaUi)) {\n\t\t\tDOM.setHidden(this, true);\n\t\t} else {\n\t\t\tDOM.setHidden(this, false);\n\t\t\trenderAppend(this.template(this), this.shadowRoot);\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib-lc', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 0 1 auto;\n\t\tmin-width: 5em;\n\t\tfont-size: var(--label-size);\n\t}\n\n\t#lcSt {\n\t\tcolor: var(--alt2-color);\n\t\tfont-weight: bold;\n\t\tpadding: 0 .3em;\n\t}\n\n\t#lcSt > img {\n\t\twidth: 1em;\n\t\theight: 1em;\n\t\tmargin-inline-end: 0.2em;\n\t}\n\n\t:host(#ttRoot) {\n\t\tpadding: .3em;\n\t}\n\n\t#last {\n\t\tpadding: .3em 0;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t}\n\n\t#lastUser,\n\t#lastDt {\n\t\tcolor: var(--alt1-color);\n\t\tfont-weight: bold;\n\t}\n`);\n\ncustomElements.define('wsp-rib-lc', RibbonLc);\n\n\n/**\n * dynGen de l'item.\n */\n\nexport interface ORibbonDynGenInit extends OSkinableInit {\n\tdynGen: ODynGenInit,\n\tlabel?: string;\n}\n\nexport class RibbonDynGen extends RibbonBase {\n\n\ttemplate: (rib: RibbonDynGen) => TemplateResult;\n\n\tprotected conf: ORibbonDynGenInit\n\n\tprotected _initialize(init: ORibbonDynGenInit): void {\n\t\tsuper._initialize(init);\n\t\tthis.conf = init;\n\t\tif (!this.conf.dynGen) this.conf.dynGen = {} as any;\n\t\tif (!(\"reg\" in this.conf.dynGen)) this.conf.dynGen.reg = this.reg;\n\t\tif (!(\"autoResize\" in this.conf.dynGen)) this.conf.dynGen.autoResize = true;\n\t\tif (!(\"w\" in this.conf.dynGen)) this.conf.dynGen.w = this.reg.env.wsp.code;\n\t\tif (!(\"r\" in this.conf.dynGen)) this.conf.dynGen.r = SRC.srcRef(this.reg.env.longDesc);\n\n\t\tthis.reg.env.longDescChange.add(this.refresh.bind(this));\n\t\tthis.template = this.reg.getSvc(\"ribbon.item.dynGen.tpl\") || RibbonDynGen._template;\n\t}\n\n\tstatic _template(this: void, rib: RibbonDynGen): TemplateResult {\n\t\tconst longDesc = rib.reg.env.longDesc;\n\t\tconst dynGen = new DynGen().initialize(rib.conf.dynGen);\n\t\tdynGen.onViewShown();\n\t\treturn xhtml`${dynGen}<div id=\"label\">${rib.conf.label}</div>`;\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\tif (ITEM.isHistoryUri(longDesc.srcUri)) {\n\t\t\tDOM.setHidden(this, true);\n\t\t} else {\n\t\t\tDOM.setHidden(this, false);\n\t\t\trenderAppend(this.template(this), this.shadowRoot);\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib-dyngen', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 0 1 auto;\n\t\tmin-width: 5em;\n\t\tfont-size: var(--label-size);\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\n\twsp-dyngen {\n\t\toverflow: auto;\n\t}\n\n\t#label {\n\t\twhite-space: nowrap;\n\t\tfont-style: italic;\n\t\tcolor: var(--fade-color);\n\t}\n\n`);\n\ncustomElements.define('wsp-rib-dyngen', RibbonDynGen);\n\n/**\n * Ribbon d'actions\n */\n\nexport interface ORibbonBarActionsInit extends OSkinableInit {\n\tbarActions: OBarActionsInit<IShortDescCtx>,\n\tlabel?: string;\n}\n\nexport class RibbonBarActions extends RibbonBase {\n\n\ttemplate: (rib: RibbonBarActions) => TemplateResult;\n\n\tprotected conf: ORibbonBarActionsInit\n\n\tprotected _initialize(init: ORibbonBarActionsInit): void {\n\t\tsuper._initialize(init);\n\t\tthis.conf = init;\n\t\tthis.reg.env.longDescChange.add(this.refresh.bind(this));\n\t\tthis.template = this.reg.getSvc(\"ribbon.item.actions.tpl\") || RibbonBarActions._template;\n\t}\n\n\tstatic _template(this: void, rib: RibbonBarActions): TemplateResult {\n\t\tconst longDesc = rib.reg.env.longDesc;\n\t\tconst barActions = new BarActions().initialize(\n\t\t\tObject.assign({\n\t\t\t\t\tuiContext: \"custom\",\n\t\t\t\t\tdisableFullOverlay: true,\n\t\t\t\t\toverrideButtonsElts: (btn) => DOM.addClass(btn, \"vertical\")\n\t\t\t\t} as OBarActionsInit<IShortDescCtx>,\n\t\t\t\trib.conf.barActions, {\n\t\t\t\t\tactionContext: rib.shortDescCtx\n\t\t\t\t} as OBarActionsInit<IShortDescCtx>));\n\t\treturn xhtml`${barActions}<div id=\"label\">${rib.conf.label}</div>`;\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\tif (ITEM.isHistoryUri(longDesc.srcUri)) {\n\t\t\tDOM.setHidden(this, true);\n\t\t} else {\n\t\t\tDOM.setHidden(this, false);\n\t\t\trenderAppend(this.template(this), this.shadowRoot);\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib-baractions', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 0 1 auto;\n\t\tfont-size: var(--label-size);\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t}\n\n\t#label {\n\t\twhite-space: nowrap;\n\t\tfont-style: italic;\n\t\tcolor: var(--fade-color);\n\t}\n\n`);\n\ncustomElements.define('wsp-rib-baractions', RibbonBarActions);\n\n/**\n * Responsabilities de l'item.\n */\nexport class RibbonResp extends RibbonBase {\n\n\ttemplate: (rib: RibbonResp) => TemplateResult;\n\n\tprotected _initialize(init: any): void {\n\t\tsuper._initialize(init);\n\t\tthis.reg.env.longDescChange.add(this.refresh.bind(this));\n\t\tthis.template = this.reg.getSvc(\"ribbon.item.resp.tpl\") || RibbonResp._template;\n\t\tthis.setFloating(this.reg.getSvc(\"ribbon.item.resp.details\") || RibbonResp._details, true);\n\t}\n\n\tstatic _template(this: void, rib: RibbonResp): TemplateResult {\n\t\tconst longDesc = rib.reg.env.longDesc;\n\t\tconst rspUsrs = RESPS.toRespsList(longDesc.rspUsrs);\n\t\tconst itemType = rib.reg.env.wsp.wspMetaUi.getItemType(longDesc.itModel);\n\t\tlet resps = <div class=\"list\"/>;\n\n\t\tlet count = 0;\n\t\tlet hasMore = false;\n\t\tfor (const resp of itemType.datas.resps) {//.sort((e1, e2) => e2.required === e1.required ? 0 : (e2.required ? 1 : -1))\n\t\t\tlet nbUsers = rspUsrs[resp.code]?.length;\n\t\t\tif (rspUsrs[resp.code] && nbUsers > 0) {\n\t\t\t\t/*if (count >= 2) {\n\t\t\t\t\thasMore = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}*/\n\t\t\t\tconst keyElt = resps.appendChild(<div class=\"key\">{resp.name}</div>);\n\t\t\t\tif (resp.desc) keyElt.title = resp.desc;\n\t\t\t\tconst values = resps.appendChild(<div class=\"values\"/>);\n\t\t\t\tvalues.appendChild(<c-userref class=\"inline\" î={{reg: rib.reg, nickOrAccount: rspUsrs[resp.code][0]} as OUserRefInit}/>);\n\t\t\t\tif (--nbUsers > 0)\n\t\t\t\t\tvalues.appendChild(<span class=\"moreUsers\">+{nbUsers}</span>)\n\t\t\t\t/*rspUsrs[resp.code].forEach((user) => {\n\t\t\t\t\tvalues.appendChild(<c-userref class=\"inline\" î={{reg: rib.reg, nickOrAccount: user} as OUserRefInit}/>);\n\t\t\t\t});*/\n\t\t\t\tcount++;\n\t\t\t}\n\t\t}\n\n\t\tif (count == 0 && itemType.hasResps())\n\t\t\tresps.appendChild(<MsgLabel id=\"noRespLabel\" î={{label: \"Responsabilités non définies\", level: rib.isInError() ? \"error\" : \"info\"} as OMsgLabelInit}/>);\n\n\t\treturn xhtml`${resps}`;//${hasMore ? <MsgLabel class=\"more\" î={{label: \"...\"} as OMsgLabelInit}/> : \"\"}\n\t}\n\n\tstatic _details(this: void, rib: RibbonResp, popup: PopupFloating): IView | null {\n\t\tconst longDesc = rib.reg.env.longDesc;\n\t\tconst rspUsrs = RESPS.toRespsList(longDesc.rspUsrs);\n\t\tconst itemType = rib.reg.env.wsp.wspMetaUi.getItemType(longDesc.itModel);\n\t\tlet resps = <div class=\"list\"/>;\n\t\titemType.datas.resps.forEach((resp) => {\n\t\t\t// FIXME : afficher ici les resps inconnues de l'item ? A réévaluer...\n\t\t\tconst keyElt = resps.appendChild(<div class=\"key\">{resp.name}</div>);\n\t\t\tif (resp.desc) keyElt.title = resp.desc;\n\t\t\tconst inptELt = resps.appendChild(<RespEditField class=\"values\" î={{\n\t\t\t\treg: rib.reg,\n\t\t\t\tresp: resp.code,\n\t\t\t} as ORespEditFieldInit}/>);\n\t\t});\n\t\treturn <div>\n\t\t\t<ShadowJsx skin=\"wsp-rib-resp/details\" reg={rib.reg}>\n\t\t\t\t<div class=\"title\">Responsabilités</div>\n\t\t\t\t{resps}\n\t\t\t</ShadowJsx>\n\t\t</div>;\n\t}\n\n\tprotected isInError(): boolean {\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\treturn longDesc.rspSt === EItResp.errors\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tconst longDesc = this.reg.env.longDesc;\n\t\tconst itemType = this.reg.env.wsp.wspMetaUi.getItemType(longDesc.itModel);\n\t\tif (ITEM.isHistoryOrTrashUri(longDesc.srcUri) || !itemType.hasResps()) {\n\t\t\tDOM.setHidden(this, true);\n\t\t} else {\n\t\t\tDOM.setHidden(this, false);\n\t\t\tDOM.setAttrBool(this, \"data-error\", this.isInError());\n\t\t\trenderAppend(this.template(this), this.shadowRoot);\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib-resp', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 0 1 auto;\n\t\tmin-width: 5em;\n\t\tfont-size: var(--label-size);\n\t\tdisplay: flex;\n\t}\n\n\t:host(#ttRoot) {\n\t\tpadding: .3em;\n\t}\n\n\t:host([data-error]) {\n\t\tbox-shadow: inset 0 0 5px var(--error-color);\n\t}\n\n\t.list {\n\t\toverflow: auto;\n\t\tpadding: 2px;\n\t\tdisplay: grid;\n\t\tgrid-template-columns: auto 1.5fr;\n\t\tgrid-column-gap: .5em;\n\t\tgrid-row-gap: .2em;\n\t\talign-items: center;\n\t}\n\n\t.key {\n\t\ttext-align: start;\n\t\talign-self: start;\n\t}\n\n\t.values {\n\t\ttext-align: end;\n\t\talign-self: start;\n\t}\n\n\t.moreUsers {\n\t\tcolor: var(--alt1-color);\n\t\tfont-style: italic;\n\t}\n\n\t.moreUsers::before {\n\t\tcontent: \", \";\n\t}\n\n\t.values > c-userref + c-userref {\n\t\tmargin-inline-start: 1em;\n\t}\n\n\t#noRespLabel {\n\t\tgrid-column-start: 0;\n\t\tgrid-column-end: 1;\n\t}\n\n`);\n\nREG.reg.registerSkin('wsp-rib-resp/details', 1, /* language=CSS */ `\n\t:host {\n\t\t/*min-width: 20em;*/\n\t\twidth: 30em;\n\t\tmax-width: 100%;\n\t}\n\n\t.title {\n\t\tfont-size: var(--label-size);\n\t\tpadding: .2em;\n\t\tcolor: var(--fade-color);\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\ttext-align: center;\n\t}\n\n\t.list {\n\t\tpadding: .2em;\n\t\tdisplay: grid;\n\t\tgrid-template-columns: auto 1fr;\n\t\tgrid-column-gap: .5em;\n\t\tgrid-row-gap: .5em;\n\t\talign-items: center;\n\t}\n\n\t.key {\n\t\ttext-align: start;\n\t}\n\n\t.values {\n\t\ttext-align: end;\n\t\tmin-width: 10em;\n\t}\n`);\ncustomElements.define('wsp-rib-resp', RibbonResp);\n\n\n/**\n * Tâches associées à l'item.\n */\nexport class RibbonTasks extends RibbonBase {\n\n\ttemplate: (rib: RibbonTasks) => TemplateResult;\n\n\tfetch: (rib: RibbonTasks) => Promise<void>;\n\n\tpending: number;\n\tforthcoming: number;\n\n\tprivate _noFetch = true;\n\n\tprotected _initialize(init: any): void {\n\t\tsuper._initialize(init);\n\t\tif (!this.reg.env.wsp.wspMetaUi.hasTasks) {\n\t\t\tthis.hidden = true;\n\t\t\treturn;\n\t\t}\n\t\tthis.fetch = this.reg.getSvc(\"ribbon.item.tasks.fetch\") || this._fetch;\n\t\tthis.template = this.reg.getSvc(\"ribbon.item.tasks.tpl\") || RibbonTasks._template;\n\t\tthis.setFloating(this.reg.getSvc(\"ribbon.item.tasks.details\") || RibbonTasks._details);\n\n\t\t//on retarde l'affichage des infos du ribbon pour laisser la priorité au contenu de l'item.\n\t\tsetTimeout(async () => {\n\t\t\tthis._noFetch = false;\n\t\t\tthis.refresh();\n\t\t}, 300);\n\t}\n\n\tasync _fetch(this: void, rib: RibbonTasks) {\n\t\tconst counts = await WSP.fetchSrc(rib.reg.env.wsp, rib, SRC.srcRef(rib.reg.env.longDesc), [\"tkPendingCount\", \"tkForthcomingCount\"]);\n\t\trib.pending = counts.tkPendingCount || 0;\n\t\trib.forthcoming = counts.tkForthcomingCount || 0;\n\t}\n\n\tstatic _template(this: void, rib: RibbonTasks): TemplateResult {\n\t\tconst pending = rib.pending;\n\t\tconst forthcoming = rib.forthcoming;\n\t\treturn xhtml`<div><span id=\"pending\" title=\"Tâches en cours\">${pending !== undefined ? pending : '...'}</span>\n<span id=\"forthcoming\" title=\"Tâches à venir\">${forthcoming !== undefined ? `(${forthcoming})` : '...'}</span></div>\n<div id=\"label\">tâches</div>`;\n\t}\n\n\tstatic _details(this: void, rib: RibbonTasks, popup: PopupFloating): IView | null {\n\t\tconst tasks = new Tasks().initialize({\n\t\t\treg: rib.reg,\n\t\t\tephemeralView: true,\n\t\t\trefreshCb: (visibleStage: ETaskStage, tasks: JSrcFields[]) => {\n\t\t\t\tif (visibleStage === ETaskStage.pending) DOM.setTextContent(rib.shadowRoot.getElementById('pending'), tasks.length.toString());\n\t\t\t\telse if (visibleStage === ETaskStage.forthcoming) DOM.setTextContent(rib.shadowRoot.getElementById('forthcoming'), `(${tasks.length.toString()})`);\n\t\t\t}\n\t\t});\n\n\t\treturn <ViewsContainer î={{views: [tasks]} as OViewsContainerInit}>\n\t\t\t<ShadowJsx skin=\"wsp-rib-tasks/details\" reg={rib.reg}>\n\t\t\t\t<div class=\"title\">Tâches liées à cet item</div>\n\t\t\t\t{tasks}\n\t\t\t</ShadowJsx>\n\t\t</ViewsContainer>;\n\t}\n\n\tprotected _refresh() {\n\t\tsuper._refresh();\n\t\tif (!this.hidden) {\n\t\t\tif (!this._noFetch)\n\t\t\t\tthis.fetch(this).then(() => renderAppend(this.template(this), this.shadowRoot));\n\t\t\telse\n\t\t\t\trenderAppend(this.template(this), this.shadowRoot)\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('wsp-rib-tasks', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 0 1 auto;\n\t\tmin-width: 3em;\n\t\t--row-bgcolor: var(--bgcolor);\n\t}\n\n\t#pending {\n\t\tcolor: var(--alt1-color);\n\t\tfont-weight: bold;\n\t}\n\n\t#forthcoming {\n\t\tcolor: var(--alt2-color);\n\t\tfont-weight: bold;\n\t\tfont-size: .8em;\n\t}\n\n\t#label {\n\t\twhite-space: nowrap;\n\t\tfont-style: italic;\n\t\tcolor: var(--fade-color);\n\t}\n`);\n\nREG.reg.registerSkin('wsp-rib-tasks/details', 1, /* language=CSS */ `\n\t:host {\n\t\tmin-width: 40em;\n\t}\n\n\t.title {\n\t\tfont-size: var(--label-size);\n\t\tpadding: .2em;\n\t\tcolor: var(--fade-color);\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\ttext-align: center;\n\t}\n`);\n\ncustomElements.define('wsp-rib-tasks', RibbonTasks);\n\n\nREG.reg.addToList(\"ribbon:item\", \"info\", 1, RibbonItemInfo, 10);\nREG.reg.addToList(\"ribbon:item\", \"tabs\", 1, RibbonTabs, 15);\nREG.reg.addToList(\"ribbon:item\", \"refs\", 1, RibbonRefs, 500);\n\n"]}