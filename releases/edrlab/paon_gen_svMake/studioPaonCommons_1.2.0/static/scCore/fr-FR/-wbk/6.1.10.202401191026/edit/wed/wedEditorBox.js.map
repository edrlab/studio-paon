{"version":3,"sources":["/@back@/edit/wed/wedEditorBox.tsx"],"names":["AgBoxErrBarEditor","AgBoxSelEditor","AgCommonBarEditor","AgInsSelEditor","AgMetaBarEditor","AgOutlineBarEditor","AgPreviewBarEditor","AgTxtSelEditor","WED","WedEditorBase","WedPanelBar","WED_SELECTOR_BOX","REG","VIEWS","DOM","JSX","DOMSH","RelaxNgSchemaBuilder","Resizer","AgSearchBarEditor","AgDiffBarEditor","WedEditorBox","scrollContainer","this","shadowRoot","getElementById","[object Object]","init","attachShadow","SHADOWDOM_INIT","barLayout","FullLayout","initLayout","reg","disableDefaultAccelKeys","customAccelKeysList","wedMgr","accelKeyMgr","initFromMapActions","mergeListsAsMap","getListAsMap","lib","_loadings","_inSync","push","inSync","Promise","all","resolve","endPoint","resolver","addAsyncLib","loadWedModel","then","wedModel","skMetaLib","buildRelaxNgFromUrl","rngSchema","schema","docHolder","config","rootNode","innerHTML","Error","wedRootModelSelector","initWedMgr","errMsg","error","alert","location","reload","mainBranch","includeVirtuals","registerSkin","customElements","define","WedEditorFrag","crossNav","undefined","super","initialize","editor","sr","installSkin","createElement","id","withoutScrolls","class","c-resizable","appendChild","hidden","listeners","on","lastDatas","wedEditor","endBox","lytEndBox","style","flexBasis","lytMetaBox","otl","lytOtl","prv","lytPrv","panel","bar","ctn","parentNode","insertBefore","firstChild","outlinePanel","findHost","î","barBody","setHidden","refreshEndBox","previewPanel","metaPanel","c-orient","previousElementSibling","prev","parentElement","nextSibling","unknownBar","rowBox","setAttribute","console","warn","onViewShown","emit","onViewHidden","remove","ch","firstElementChild","nextElementSibling","resizer","prevVisible","next","editorBoxDefined"],"mappings":"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","sourcesContent":["import {OSkinableInit} from \"back/commons/basis\";\nimport {AgBoxErrBarEditor, OWedEditorErrBarConfig} from \"back/edit/wed/features/boxErrBar\";\nimport {AgBoxSelEditor, IWedEditorBoxSel} from \"back/edit/wed/features/boxSel\";\nimport {AgCommonBarEditor, IWedEditorCommonBar, OWedEditorCommonBarConfig} from \"back/edit/wed/features/commonBar\";\nimport {AgInsSelEditor} from \"back/edit/wed/features/insMgr\";\nimport {AgMetaBarEditor, IWedEditorMetaBar, OWedEditorMetaConfig} from \"back/edit/wed/features/metaBar\";\nimport {AgOutlineBarEditor, IWedEditorOutlineBar, OWedEditorOutlineConfig} from \"back/edit/wed/features/outlineBar\";\nimport {AgPreviewBarEditor, IWedEditorPreviewBar, OWedEditorPreviewConfig} from \"back/edit/wed/features/previewBar\";\nimport {AgTxtSelEditor} from \"back/edit/wed/features/txtSel\";\nimport {WED} from \"back/edit/wed/wedCore\";\nimport {IWedEdBar, IWedEditor, IWedEditorBarLayout, IWedEditorMain, OWedEditorConfig, OWedManagerConfig, WedEditorBase, WedMgr, WedPanelBar} from \"back/edit/wed/wedEditor\";\nimport {WED_SELECTOR_BOX} from \"back/edit/wed/wedlets/box/box\";\nimport {Action} from \"lib/commons/actions\";\nimport {IEndPoint, IPathResolver} from \"lib/commons/io/io\";\nimport {ILastDatasBuilder, JLastDatas} from \"lib/commons/lastDatas\";\nimport {IReg, IRegPointer, IUiEnv, REG} from 'lib/commons/registry';\nimport {VIEWS} from \"lib/commons/views\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IDocHolder} from \"lib/edit/docHolder\";\nimport {ErrorMsg} from \"lib/edit/ot/urban\";\nimport {Schema} from \"lib/edit/schema/schema\";\nimport {RelaxNgSchemaBuilder} from \"lib/edit/schema/schemaBuilder\";\nimport {SkMetaLib} from \"lib/edit/schema/schemaMeta\";\nimport {Resizer} from \"back/commons/widgets/resizer\";\nimport {AgSearchBarEditor} from \"back/edit/wed/features/searchBar\";\nimport {AgDiffBarEditor} from \"back/edit/wed/features/diffBar\";\n\n\nexport interface OWedEditorBoxConfig extends OWedEditorPreviewConfig, OWedEditorOutlineConfig, OWedEditorMetaConfig, OWedEditorCommonBarConfig, OWedEditorErrBarConfig, OSkinableInit {\n\treg?: IReg<IUiEnv>\n\tdisableBoxSelection?: boolean\n\tdisableVirtuals?: boolean\n\tdisableDefaultAccelKeys?: boolean\n\tcustomAccelKeysList?: string\n}\n\n//Pour les méthodes ajoutées en Agrégations.\nexport interface WedEditorBox extends IWedEditorPreviewBar, IWedEditorOutlineBar, IWedEditorCommonBar, IWedEditorMetaBar {\n\n\treg: IReg<IUiEnv>;\n\n\tinitialize(init: OWedEditorBoxConfig): this\n}\n\nexport class WedEditorBox extends WedEditorBase implements IWedEditorBoxSel, IWedEditorPreviewBar, IWedEditorOutlineBar, IWedEditorCommonBar, IWedEditorMetaBar, ILastDatasBuilder {\n\n\tconfig: OWedEditorBoxConfig;\n\n\tschema: Schema;\n\n\tbarLayout: IWedEditorBarLayout;\n\n\t// @ts-ignore\n\tget scrollContainer() {return (this.shadowRoot.getElementById(\"scrollBox\")) as HTMLElement}\n\n\tprotected _loadings: Promise<any>[];\n\tprotected _inSync: Promise<any>;\n\n\tprotected initUi(init: OWedEditorBoxConfig) {\n\t\tthis.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.barLayout = init.barLayout || new FullLayout();\n\t\tthis.barLayout.initLayout(this, this.reg);\n\t\tif (!init.disableDefaultAccelKeys) {\n\t\t\tif (init.customAccelKeysList) {\n\t\t\t\tthis.wedMgr.accelKeyMgr.initFromMapActions(this.reg.mergeListsAsMap<Action<IWedEditor>>(init.customAccelKeysList, \"accelKeys:wed:global\"));\n\t\t\t} else {\n\t\t\t\tthis.wedMgr.accelKeyMgr.initFromMapActions(this.reg.getListAsMap<Action<IWedEditor>>(\"accelKeys:wed:global\"));\n\t\t\t}\n\t\t} else if (init.customAccelKeysList) {\n\t\t\tthis.wedMgr.accelKeyMgr.initFromMapActions(this.reg.getListAsMap<Action<IWedEditor>>(init.customAccelKeysList));\n\t\t}\n\t}\n\n\t/**\n\t * Permet de déclarer une librairie de composants qui se charge en asynchrone.\n\t * L'éditeur ne sera effectivement construit que lorsque ces librairies seront chargées.\n\t */\n\taddAsyncLib(lib: Promise<any>): Promise<any> {\n\t\tif (this._loadings == null) {\n\t\t\tthis._loadings = [];\n\t\t\tthis._inSync = null;\n\t\t}\n\t\tthis._loadings.push(lib);\n\t\treturn lib;\n\t}\n\n\t/** Promise résolue lorsque les différents processus d'initialisation préalablement initiés sont achevés.*/\n\tget inSync(): Promise<any> {\n\t\tif (!this._inSync) {\n\t\t\tthis._inSync = this._loadings ? Promise.all(this._loadings) : Promise.resolve();\n\t\t}\n\t\treturn this._inSync;\n\t}\n\n\t/** Configuration du WedModel. */\n\tsetWedModelEndPoint(endPoint: IEndPoint, resolver?: IPathResolver): Promise<any> {\n\t\treturn this.addAsyncLib(\n\t\t\tWED.loadWedModel(endPoint, resolver).then(wedModel => {this.wedModel = wedModel;})\n\t\t);\n\t}\n\n\t/** Configuration du Schéma RelaxNg. */\n\tsetRelaxNG(endPoint: IEndPoint, init?: RequestInit, skMetaLib?: SkMetaLib): Promise<any> {\n\t\treturn this.addAsyncLib(\n\t\t\t//TODO regsitre static central des RNG ?\n\t\t\tnew RelaxNgSchemaBuilder(skMetaLib).buildRelaxNgFromUrl(endPoint, init).then(rngSchema => {this.schema = rngSchema})\n\t\t);\n\t}\n\n\t// async initFromEndPoint(endPoint: IEndPoint, init?: RequestInit, config?: OWedManagerConfig): Promise<boolean> {\n\t// \treturn this.initFromDocument(await endPoint.fetchDom(\"\", init), config);\n\t// }\n\t//\n\t// initFromXml(xml: string, config?: OWedManagerConfig, baseUrl?: IEndPoint): Promise<boolean> {\n\t// \treturn this.initFromDocument(DOM.parseDom(xml, baseUrl), config);\n\t// }\n\n\t// initFromDocument(doc: Document, config?: OWedManagerConfig): Promise<boolean> {\n\t// \treturn this.inSync.then(() => {\n\t// \t\tif (!this.schema) throw Error(\"No Schema declared\");\n\t// \t\treturn this.initFromDocHolder(createDocHolderLocal(this.schema, DOM.cleanupDom(doc, true, false, true), {autoMutate: true, autoComplete: true, autoNormXml: true, autoNormChars: true, genAnnots: true}), config);\n\t// \t});\n\t// }\n\n\tinitFromDocHolder(docHolder: IDocHolder, config: OWedManagerConfig = {}): Promise<boolean> {\n\t\tthis.rootNode.innerHTML = null;\n\t\treturn this.inSync.then(() => {\n\t\t\tif (!this.wedModel) throw Error(\"No wedModel declared\");\n\t\t\tif (!config.wedRootModelSelector) config.wedRootModelSelector = WED_SELECTOR_BOX;\n\t\t\treturn this.wedMgr.initWedMgr(this.wedModel, docHolder, config);\n\t\t});\n\t}\n\n\tonMsgError(errMsg: ErrorMsg): 'redraw' | void {\n\t\tif (errMsg.error === 'masterDoorClosed') {\n\t\t\t//FIXME\n\t\t\talert(\"Connexion avec le serveur intérrompue\");\n\t\t\tlocation.reload();\n\t\t} else {\n\t\t\treturn 'redraw';\n\t\t}\n\t}\n}\n\nAgBoxSelEditor(AgTxtSelEditor(AgCommonBarEditor(AgMetaBarEditor(AgOutlineBarEditor(AgPreviewBarEditor(AgBoxErrBarEditor(AgDiffBarEditor(AgSearchBarEditor(WedEditorBox)))))))));\nAgInsSelEditor(WedEditorBox, {mainBranch: true, includeVirtuals: true});\n\nREG.reg.registerSkin('box-editor/full', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\t[hidden] {\n\t\tdisplay: none !important;\n\t}\n\n\t.v {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t}\n\n\t.h {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t  min-width: 0;\n\t  flex-direction: row;\n  }\n\n  c-resizer[c-orient=row] {\n\t  width: 1px;\n  }\n\n  c-resizer[c-orient=column] {\n\t  height: 1px;\n  }\n\n  .ctn {\n\t  background-color: var(--edit-bgcolor);\n\t  color: var(--edit-color);\n  }\n\n  #endBox {\n\t  flex: 1 1 30%;\n\t  min-width: 10%;\n  }\n\n  #metaBox {\n\t  flex: 1 1 70%;\n\t  min-width: 10%;\n  }\n\n  #previewPanel,\n  #outlinePanel {\n\t  flex: 1 1 50%;\n\t  overflow: auto;\n  }\n\n  #scrollBox {\n\t  flex: 1 1 80%;\n\t  min-width: 10%;\n\t  overflow-y: auto;\n\t  scrollbar-gutter: stable;\n\t  min-height: 3em;\n\t  scroll-behavior: smooth;\n  }\n\n  #metaPanel {\n\t  flex: 1 1 20%;\n\t  min-width: 10%;\n  }\n\n  #commonBar,\n  #diffBar {\n\t  border-bottom: 1px solid var(--border-color);\n\t  min-height: 1.8em;\n  }\n\n  #txtStackBar,\n  #searchBar,\n  #unknownBar {\n\t  border-top: 1px solid var(--border-color);\n  }\n\n  #errorBar {\n\t  border-inline-start: 1px solid var(--border-color);\n  }\n`);\n\ncustomElements.define('box-editor', WedEditorBox);\n\n/**\n * Sous box editor pour la visualisation de fragments décrochés de l'arbre principal :\n * - BoxScExclude\n * - WedDiffForeign\n *\n * La gestion de la sélection Box et Txt sont activées notamment pour pouvoir copier du contenu.\n */\nexport class WedEditorFrag extends WedEditorBase implements CustomElement, IWedEdBar {\n\tinitialize(init: OWedEditorConfig): this {\n\t\tif (init.crossNav === undefined) init.crossNav = true;\n\t\tsuper.initialize(init);\n\t\treturn this;\n\t}\n}\n\nAgBoxSelEditor(AgTxtSelEditor(AgCommonBarEditor(WedEditorFrag)));\n\ncustomElements.define(\"box-editor-frag\", WedEditorFrag);\n\n/**\n * Layout par défaut gérant le positionnement des bars:\n * - commonBar\n * - errorBar\n * - outlineBar\n * - previewBar\n * - metaBar\n */\nclass FullLayout implements IWedEditorBarLayout {\n\teditor: IWedEditorMain;\n\n\tinitLayout(editor: IWedEditorMain, reg: IReg<IUiEnv>): void {\n\t\tthis.editor = editor;\n\t\t//editor.style.overflow = \"hidden\"; //obligatoire pour que le scroll horizontal fonctionne bien. cf https://stackoverflow.com/a/35609992/8691603\n\t\tconst sr = editor.shadowRoot;\n\t\treg.installSkin('box-editor/full', sr);\n\t\treg.installSkin('scroll/large', sr);\n\t\teditor.rootNode = <div id={editor.config.withoutScrolls ? \"rootBox\" : \"scrollBox\"} class=\"ctn\" c-resizable=\"\"/> as HTMLElement & IRegPointer<any>;\n\t\tsr.appendChild(<div id=\"colBox\" class=\"v\">\n\t\t\t<div id=\"rowBox\" class=\"h\">\n\t\t\t\t<div id=\"metaBox\" class=\"v\" c-resizable=\"\">\n\t\t\t\t\t{editor.rootNode}\n\t\t\t\t</div>\n\t\t\t\t<div id=\"endBox\" class=\"v\" hidden c-resizable=\"\"/>\n\t\t\t</div>\n\t\t</div>);\n\t\teditor.wedMgr.listeners.on(\"buildLastDatas\", function (this: void, wedMgr: WedMgr, lastDatas: JLastDatas) {\n\t\t\tconst sr = wedMgr.wedEditor.shadowRoot;\n\t\t\tconst endBox = sr.getElementById('endBox');\n\t\t\tif (!endBox.hidden) {\n\t\t\t\tlastDatas.lytEndBox = endBox.style.flexBasis;\n\t\t\t\tlastDatas.lytMetaBox = sr.getElementById('metaBox').style.flexBasis;\n\t\t\t\tconst otl = sr.getElementById('outlinePanel');\n\t\t\t\tif (otl && !otl.hidden) lastDatas.lytOtl = otl.style.flexBasis;\n\t\t\t\tconst prv = sr.getElementById('previewPanel');\n\t\t\t\tif (prv && !prv.hidden) lastDatas.lytPrv = prv.style.flexBasis;\n\t\t\t}\n\t\t});\n\t\teditor.wedMgr.listeners.on(\"initLastDatas\", function (this: void, wedMgr: WedMgr, lastDatas: JLastDatas) {\n\t\t\tconst sr = wedMgr.wedEditor.shadowRoot;\n\t\t\tif (lastDatas.lytEndBox) {\n\t\t\t\tsr.getElementById('endBox').style.flexBasis = lastDatas.lytEndBox;\n\t\t\t\tif (lastDatas.lytMetaBox) sr.getElementById('metaBox').style.flexBasis = lastDatas.lytMetaBox;\n\t\t\t\tif (lastDatas.lytOtl) {\n\t\t\t\t\tconst panel = sr.getElementById('outlinePanel');\n\t\t\t\t\tif (panel) panel.style.flexBasis = lastDatas.lytOtl;\n\t\t\t\t}\n\t\t\t\tif (lastDatas.lytPrv) {\n\t\t\t\t\tconst panel = sr.getElementById('previewPanel');\n\t\t\t\t\tif (panel) panel.style.flexBasis = lastDatas.lytPrv;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tgetBar(id: string): IWedEdBar {\n\t\treturn this.editor.shadowRoot.getElementById(id);\n\t}\n\n\tshowBar(bar: IWedEdBar): boolean {\n\t\tlet ctn: HTMLElement;\n\t\tswitch (bar.id) {\n\t\tcase 'commonBar' :\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"colBox\");\n\t\t\tif (bar.parentNode !== ctn) ctn.insertBefore(bar, ctn.firstChild);\n\t\t\tbreak;\n\t\tcase 'errorBar' :\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"rowBox\");\n\t\t\tif (bar.parentNode !== ctn) ctn.appendChild(bar);\n\t\t\tbreak;\n\t\tcase 'outlineBar' :\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"endBox\");\n\t\t\tlet outlinePanel = DOMSH.findHost(bar) as WedPanelBar;\n\t\t\tif (!outlinePanel) outlinePanel = ctn.insertBefore(<WedPanelBar î={{barBody: bar}} id=\"outlinePanel\" c-resizable=\"\"/>, ctn.firstChild) as WedPanelBar;\n\t\t\telse DOM.setHidden(outlinePanel, false);\n\t\t\tthis.refreshEndBox(ctn);\n\t\t\tbreak;\n\t\tcase 'previewBar' :\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"endBox\");\n\t\t\tlet previewPanel = DOMSH.findHost(bar) as WedPanelBar;\n\t\t\tif (!previewPanel) previewPanel = ctn.appendChild(<WedPanelBar î={{barBody: bar}} id=\"previewPanel\" c-resizable=\"\"/>) as WedPanelBar;\n\t\t\telse DOM.setHidden(previewPanel, false);\n\t\t\tthis.refreshEndBox(ctn);\n\t\t\tbreak;\n\t\tcase 'metaBar' :\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"metaBox\");\n\t\t\tlet metaPanel = DOMSH.findHost(bar) as WedPanelBar;\n\t\t\tif (!metaPanel) {\n\t\t\t\tctn.appendChild(<c-resizer c-orient=\"column\"/>);\n\t\t\t\tmetaPanel = ctn.appendChild(<WedPanelBar î={{barBody: bar}} id=\"metaPanel\" c-resizable=\"\"/>) as WedPanelBar;\n\t\t\t} else {\n\t\t\t\tDOM.setHidden(metaPanel, false);\n\t\t\t\tDOM.setHidden(metaPanel.previousElementSibling, false); //show c-resizer\n\t\t\t}\n\t\t\tthis.refreshEndBox(ctn);\n\t\t\tbreak;\n\t\tcase 'txtStackBar':\n\t\t\t//1ère barre en dessous de la zone principale (rowBox)\n\t\t\tconst prev = this.editor.shadowRoot.getElementById(\"rowBox\");\n\t\t\tctn = prev.parentElement;\n\t\t\tif (bar.parentNode !== ctn) ctn.insertBefore(bar, prev ? prev.nextSibling : null);\n\t\t\tbreak;\n\t\tcase 'searchBar':\n\t\t\t//barre sous txtStackBar mais au dessus de unknownBar\n\t\t\tconst unknownBar = this.editor.shadowRoot.getElementById(\"unknownBar\");\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"colBox\");\n\t\t\tif (bar.parentNode !== ctn) ctn.insertBefore(bar, unknownBar && unknownBar.parentNode === ctn ? unknownBar : null);\n\t\t\tbreak;\n\t\tcase 'diffBar':\n\t\t\t//barre sous commonBar\n\t\t\tconst rowBox = this.editor.shadowRoot.getElementById(\"rowBox\");\n\t\t\tctn = rowBox.parentElement;\n\t\t\tif (bar.parentNode !== ctn) ctn.insertBefore(bar, rowBox);\n\t\t\tbreak;\n\t\tcase 'unknownBar':\n\t\t\t//Barre d'alerte d'éléments inconnus (associée à la boxErrBar).\n\t\t\t//Dernière barre en dessous de la zone principale\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"colBox\");\n\t\t\tif (bar.parentNode !== ctn) ctn.appendChild(bar);\n\t\t\tbreak;\n\t\tcase 'helpBar' :\n\t\t\tctn = this.editor.shadowRoot.getElementById(\"rowBox\");\n\t\t\tif (bar.parentNode !== ctn) {\n\t\t\t\tctn.appendChild(<c-resizer c-orient=\"row\"/>);\n\t\t\t\tbar.setAttribute(\"c-resizable\", \"\");\n\t\t\t\tctn.appendChild(bar);\n\t\t\t} else {\n\t\t\t\tDOM.setHidden(bar.previousElementSibling, false); //show c-resizer\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tconsole.warn(\"Bar unknown by this FullLayout!\", this, bar);\n\t\t\treturn false;\n\t\t}\n\t\tVIEWS.onViewShown(bar);\n\t\tthis.editor.wedMgr.listeners.emit(\"layoutBarChange\", this.editor.wedMgr, bar);\n\t\treturn true;\n\t}\n\n\tonHideBar(bar: IWedEdBar): void {\n\t\tconst panel = DOMSH.findHost(bar);\n\t\tif (panel instanceof WedPanelBar && DOM.setHidden(panel, true)) {\n\t\t\tconst ctn = panel.parentElement;\n\t\t\tif (!ctn) return;\n\t\t\tif (ctn.id === \"endBox\") this.refreshEndBox(ctn);\n\t\t\telse if (bar.id === \"metaBar\") DOM.setHidden(panel.previousElementSibling, true); //hide c-resizer\n\t\t\tVIEWS.onViewHidden(bar);\n\t\t} else if (bar.id === \"helpBar\") {\n\t\t\tDOM.setHidden(bar.previousElementSibling, true); //hide c-resizer\n\t\t}\n\t\tthis.editor.wedMgr.listeners.emit(\"layoutBarChange\", this.editor.wedMgr, bar);\n\t}\n\n\tremoveBar(bar: IWedEdBar): void {\n\t\tif (bar.id === 'unknownBar') {\n\t\t\tif (bar.parentNode) bar.remove();\n\t\t\treturn;\n\t\t} else if (bar.id === 'helpBar') {\n\t\t\tif (bar.parentNode) {\n\t\t\t\tbar.previousElementSibling.remove(); //remove c-resizer\n\t\t\t\tbar.remove();\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tconst panel = DOMSH.findHost(bar);\n\t\tif (panel instanceof WedPanelBar) {\n\t\t\tconst ctn = panel.parentElement;\n\t\t\tif (ctn) {\n\t\t\t\tif (bar.id === \"metaBar\") panel.previousElementSibling.remove(); //suppr c-resizer\n\t\t\t\tpanel.remove();\n\t\t\t\tif (ctn.id === \"endBox\") this.refreshEndBox(ctn);\n\t\t\t\tVIEWS.onViewHidden(bar, true);\n\t\t\t\tthis.editor.wedMgr.listeners.emit(\"layoutBarChange\", this.editor.wedMgr, bar);\n\t\t\t}\n\t\t}\n\t}\n\n\t/** Réévalue l'affichage du endBox et de son resizer et ajuste les resizers dans le endBox. */\n\tprotected refreshEndBox(endBox: HTMLElement) {\n\t\tlet hidden = true;\n\t\tfor (let ch = endBox.firstElementChild as HTMLElement; ch; ch = ch.nextElementSibling as HTMLElement) {\n\t\t\tif (!ch.hidden) {\n\t\t\t\thidden = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (DOM.setHidden(endBox, hidden)) {\n\t\t\t//resizer du endBox\n\t\t\tconst prev = endBox.previousElementSibling;\n\t\t\tif (prev) {\n\t\t\t\tlet resizer = prev;\n\t\t\t\tif (!(resizer instanceof Resizer)) resizer = endBox.parentElement.insertBefore(<c-resizer c-orient=\"row\"/>, endBox);\n\t\t\t\tDOM.setHidden(resizer, hidden);\n\t\t\t}\n\t\t}\n\t\tif (!hidden) {\n\t\t\t//adjust c-resizer entre les bars dans le endBox.\n\t\t\tlet ch = endBox.firstElementChild;\n\t\t\tlet prevVisible = false;\n\t\t\twhile (ch) {\n\t\t\t\tif (!(ch as HTMLElement).hidden) prevVisible = true;\n\t\t\t\tconst next = ch.nextElementSibling;\n\t\t\t\tif (next instanceof Resizer) {\n\t\t\t\t\tch = next.nextElementSibling;\n\t\t\t\t\tDOM.setHidden(next, !prevVisible || (ch as HTMLElement).hidden);\n\t\t\t\t\tprevVisible = false;\n\t\t\t\t\tcontinue;\n\t\t\t\t} else if (next) {\n\t\t\t\t\tconst resizer = endBox.insertBefore(<c-resizer c-orient=\"column\"/>, next);\n\t\t\t\t\tif (!prevVisible || (next as HTMLElement).hidden) resizer.hidden = true;\n\t\t\t\t}\n\t\t\t\tprevVisible = false;\n\t\t\t\tch = next;\n\t\t\t}\n\t\t}\n\t}\n\n}\n\n\nexport const editorBoxDefined = Promise.resolve();\n\n\n"]}