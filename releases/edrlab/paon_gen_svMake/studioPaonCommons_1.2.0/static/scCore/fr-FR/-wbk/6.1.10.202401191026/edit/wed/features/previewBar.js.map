{"version":3,"sources":["/@back@/edit/wed/features/previewBar.tsx"],"names":["AgBoxSelEditor","AgCommonBarEditor","AgTxtSelEditor","WedEditorBase","Action","DOM","AgPreviewBarEditor","cls","proto","prototype","showPreview","show","this","previewWedModel","previewBar","init","Object","create","config","commonBar","hideCommonBar","lastDatasKey","lastDatas","disableBoxSelection","disableVirtuals","wedMgr","reg","getPref","PreviewBar","initialize","initPreview","hidden","barLayout","showBar","setHidden","onHideBar","initLastDatasHooks","push","prv","rootWedlet","listeners","once","buildLastDatasHooks","buildLastDatas","[object Object]","super","id","setAttribute","mainEditor","mainWedMgr","wedModel","hookFct","clearEditor","detachDocHolder","redrawPreview","wedMgrConfig","xaRoot","readOnlyCauses","Array","from","noFocus","initFromDocHolder","docHolderAsync","cloneDocHolder","on","drawn","customElements","define","ShowPreviewAction","_label","_icon","ctx","api","ev"],"mappings":"OAAQA,mBAAe;OACfC,sBAAkE;OAClEC,mBAAe;OAEiEC,kBAAc;OAC9FC,WAAsB;OAEtBC,QAAS;OAeX,SAAUC,mBAAmBC,KAClC,MAAMC,MAAQD,IAAIE;AAElBD,MAAME,YAAc,SAA4DC,MAC/E,GAAIA,KAAM,CACT,IAAKC,KAAKC,gBAAiB;AAC3B,IAAKD,KAAKE,WAAY,CACrB,MAAMC,KAAOC,OAAOC,OAAOL,KAAKM;AAChC,GAAIN,KAAKO,UAAW,CACnBJ,KAAKI,UAAYP,KAAKO,cAChB,CACNJ,KAAKK,cAAgB,KAEtBL,KAAKM,aAAe;AACpBN,KAAKO,UAAYV,KAAKM,OAAOI,WAAaV,KAAKM,OAAOI,UAAUP,KAAKM;AACrEN,KAAKQ,oBAAsB;AAC3BR,KAAKS,gBAAkBZ,KAAKa,OAAOC,IAAIC,QAAQ,iCAAkC;AACjFf,KAAKE,YAAa,IAAIc,YAAaC,WAAWd,MAAMe,YAAYlB,WAC1DA,KAAKE,WAAWiB,OAAS;AAChCnB,KAAKoB,UAAUC,QAAQrB,KAAKE,iBACtB,GAAIF,KAAKE,WAAY,CAC3B,GAAIT,IAAI6B,UAAUtB,KAAKE,WAAY,MAAOF,KAAKoB,UAAUG,UAAUvB,KAAKE;AAI1E,IAAKN,MAAM4B,mBAAoB5B,MAAM4B,mBAAqB;AAC1D5B,MAAM4B,mBAAmBC,MAAK,SAAsCf,WACnE,GAAIA,UAAUgB,IAAK,CAClB,GAAI1B,KAAKa,OAAOc,WAAY,CAC3B3B,KAAKF,YAAY,UACX,CACNE,KAAKa,OAAOe,UAAUC,KAAK,cAAe,KAAO7B,KAAKF,YAAY;AAKrE,IAAKF,MAAMkC,oBAAqBlC,MAAMkC,oBAAsB;AAC5DlC,MAAMkC,oBAAoBL,MAAK,SAAsCf,WACpE,GAAIV,KAAKE,aAAeF,KAAKE,WAAWiB,OAAQnB,KAAKE,WAAW6B,eAAerB;AAGhF,OAAOf,IAGR,MAAMqB,mBAAmBzB,cAGxByC,cACCC;AACAjC,KAAKkC,GAAK;AACVlC,KAAKmC,aAAa,QAAS,WAG5BH,YAAYI,YACXpC,KAAKoC,WAAaA;AAClB,MAAMC,WAAarC,KAAKoC,WAAWvB;AACnCb,KAAKsC,SAAWtC,KAAKoC,WAAWnC,iBAAmBoC,WAAWC;AAC9DD,WAAWE,QAAQ,cAAe,KAAOvC,KAAKa,OAAO2B;AACrDH,WAAWE,QAAQ,kBAAmB,KAAOvC,KAAKa,OAAO4B;AACzD,MAAMC,cAAgB,KAErB1C,KAAKa,OAAO4B;AACZ,MAAME,aAAe;AACrBA,aAAaC,OAASP,WAAW/B,OAAOsC;AACxCD,aAAaE,eAAiBC,MAAMC,KAAKV,WAAWQ;AACpDF,aAAaK,QAAU;AACvBhD,KAAKiD,kBAAkBZ,WAAWa,eAAeC,iBAAkBR;AAEpEN,WAAWT,UAAUwB,GAAG,cAAeV;AACvC,GAAIL,WAAWgB,MAAOX;AACtB,OAAO1C,MAITZ,eAAeE,eAAeD,kBAAkB2B;AAEhDsC,eAAeC,OAAO,kBAAmBvC;OAEnC,MAAOwC,0BAA0BhE,OAEtCwC,cACCC,MAAM;AACNjC,KAAKyD,OAAS;AACdzD,KAAK0D,MAAQ,kCAId1B,UAAU2B,KACT,OAAOA,IAAI1D,iBAAmB,KAG/B+B,WAAsE,OAAO,KAE7EA,SAAS4B,IAAeD,KACvB,OAAOA,IAAIzD,YAAc,OAASyD,IAAIzD,WAAWiB,OAGlDa,QAAQ2B,IAAwCE,IAC/CF,IAAI7D,aAAa6D,IAAIzD,YAAcyD,IAAIzD,WAAWiB","sourcesContent":["import {AgBoxSelEditor} from \"back/edit/wed/features/boxSel\";\nimport {AgCommonBarEditor, IWedEditorCommonBar, OWedEditorCommonBarConfig} from \"back/edit/wed/features/commonBar\";\nimport {AgTxtSelEditor} from \"back/edit/wed/features/txtSel\";\nimport {WedModel} from \"back/edit/wed/wedCore\";\nimport {IWedEdBar, IWedEditor, IWedEditorMain, OWedEditorMainConfig, OWedManagerConfig, WedEditorBase} from \"back/edit/wed/wedEditor\";\nimport {Action, IActionToggle} from \"lib/commons/actions\";\nimport {JLastDatas} from \"lib/commons/lastDatas\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {OWedEditorBoxConfig} from \"back/edit/wed/wedEditorBox\";\n\n/** Config de l'editor dédié à l'affichage du panel de rendu. */\nexport interface OWedEditorPreviewConfig extends OWedEditorMainConfig {\n}\n\n/** Enrichissements de l'éditor principal pour gérer l'editor de preview. */\nexport interface IWedEditorPreviewBar extends IWedEditorMain {\n\tpreviewBar?: PreviewBar\n\tpreviewWedModel?: WedModel\n\n\tshowPreview(show: boolean): void\n}\n\nexport function AgPreviewBarEditor(cls: any): any {\n\tconst proto = cls.prototype as IWedEditorPreviewBar;\n\n\tproto.showPreview = function (this: IWedEditorPreviewBar & IWedEditorCommonBar, show: boolean) {\n\t\tif (show) {\n\t\t\tif (!this.previewWedModel) return;\n\t\t\tif (!this.previewBar) {\n\t\t\t\tconst init = Object.create(this.config) as OWedEditorCommonBarConfig & OWedEditorBoxConfig;\n\t\t\t\tif (this.commonBar) {\n\t\t\t\t\tinit.commonBar = this.commonBar;\n\t\t\t\t} else {\n\t\t\t\t\tinit.hideCommonBar = true;\n\t\t\t\t}\n\t\t\t\tinit.lastDatasKey = \"prv\";\n\t\t\t\tinit.lastDatas = this.config.lastDatas && this.config.lastDatas[init.lastDatasKey];\n\t\t\t\tinit.disableBoxSelection = true;\n\t\t\t\tinit.disableVirtuals = this.wedMgr.reg.getPref(\"wed.previewBar.disableVirtuals\", true);\n\t\t\t\tthis.previewBar = new PreviewBar().initialize(init).initPreview(this);\n\t\t\t} else this.previewBar.hidden = false;\n\t\t\tthis.barLayout.showBar(this.previewBar)\n\t\t} else if (this.previewBar) {\n\t\t\tif (DOM.setHidden(this.previewBar, true)) this.barLayout.onHideBar(this.previewBar);\n\t\t}\n\t};\n\n\tif (!proto.initLastDatasHooks) proto.initLastDatasHooks = [];\n\tproto.initLastDatasHooks.push(function (this: IWedEditorPreviewBar, lastDatas: JLastDatas) {\n\t\tif (lastDatas.prv) {\n\t\t\tif (this.wedMgr.rootWedlet) {\n\t\t\t\tthis.showPreview(true);\n\t\t\t} else {\n\t\t\t\tthis.wedMgr.listeners.once(\"redrawAtEnd\", () => {this.showPreview(true)});\n\t\t\t}\n\t\t}\n\t});\n\n\tif (!proto.buildLastDatasHooks) proto.buildLastDatasHooks = [];\n\tproto.buildLastDatasHooks.push(function (this: IWedEditorPreviewBar, lastDatas: JLastDatas) {\n\t\tif (this.previewBar && !this.previewBar.hidden) this.previewBar.buildLastDatas(lastDatas);\n\t});\n\n\treturn cls;\n}\n\nclass PreviewBar extends WedEditorBase implements CustomElement, IWedEdBar {\n\tmainEditor: IWedEditorPreviewBar;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.id = \"previewBar\";\n\t\tthis.setAttribute(\"label\", \"Rendu\");\n\t}\n\n\tinitPreview(mainEditor: IWedEditorPreviewBar): this {\n\t\tthis.mainEditor = mainEditor;\n\t\tconst mainWedMgr = this.mainEditor.wedMgr;\n\t\tthis.wedModel = this.mainEditor.previewWedModel || mainWedMgr.wedModel;\n\t\tmainWedMgr.hookFct(\"clearEditor\", () => {this.wedMgr.clearEditor()});\n\t\tmainWedMgr.hookFct(\"detachDocHolder\", () => {this.wedMgr.detachDocHolder()});\n\t\tconst redrawPreview = () => {\n\t\t\t//init de l'editor de l'outline au redraw de l'editor principal.\n\t\t\tthis.wedMgr.detachDocHolder(); //en cas d'un redraw suite à un echec / coupure réseau.\n\t\t\tconst wedMgrConfig = {} as OWedManagerConfig;\n\t\t\twedMgrConfig.xaRoot = mainWedMgr.config.xaRoot;\n\t\t\twedMgrConfig.readOnlyCauses = Array.from(mainWedMgr.readOnlyCauses);\n\t\t\twedMgrConfig.noFocus = true;\n\t\t\tthis.initFromDocHolder(mainWedMgr.docHolderAsync.cloneDocHolder(), wedMgrConfig);\n\t\t};\n\t\tmainWedMgr.listeners.on(\"redrawAtEnd\", redrawPreview); //futures (re)contrcuxtion\n\t\tif (mainWedMgr.drawn) redrawPreview(); //construction si le mainWedMgr est déjà actif.\n\t\treturn this;\n\t}\n}\n\nAgBoxSelEditor(AgTxtSelEditor(AgCommonBarEditor(PreviewBar)));\n\ncustomElements.define(\"wed-preview-bar\", PreviewBar);\n\nexport class ShowPreviewAction extends Action<IWedEditor & IWedEditorPreviewBar> implements IActionToggle<IWedEditor & IWedEditorPreviewBar> {\n\n\tconstructor() {\n\t\tsuper(\"preview\");\n\t\tthis._label = \"Rendu\";\n\t\tthis._icon = \"/@skin@/edit/wed/previewBtn.svg\";\n\n\t}\n\n\tisVisible(ctx: IWedEditor & IWedEditorPreviewBar) {\n\t\treturn ctx.previewWedModel != null;\n\t}\n\n\tisToggle(): this is IActionToggle<IWedEditor & IWedEditorPreviewBar> {return true}\n\n\tgetDatas(api: 'toggle', ctx: IWedEditor & IWedEditorPreviewBar): boolean | null {\n\t\treturn ctx.previewBar != null && !ctx.previewBar.hidden;\n\t}\n\n\texecute(ctx: IWedEditor & IWedEditorPreviewBar, ev?: Event): any | 'noPreventDefault' {\n\t\tctx.showPreview(!ctx.previewBar || ctx.previewBar.hidden);\n\t}\n\n}"]}