{"version":3,"sources":["/@back@/wsp/dialogs/srcEditResp.tsx"],"names":["BaseElementAsync","Button","POPUP","REG","DOM","JSX","DOMSH","RESPS","WSP","ITEM","InputUserPanel","EUserType","ERROR","SrcEditResp","wsp","this","reg","env","[object Object]","init","findReg","conf","sr","attachShadow","SHADOWDOM_INIT","installSkin","_initAndInstallSkin","localName","refUris","shortDescs","forEach","entry","push","srcUri","longDescs","fetchLongDescs","_iniValues","Set","shortDesc","respList","toRespsList","rspUsrs","resp","code","account","add","main","appendChild","createElement","id","class","name","_inptElt","î","Object","assign","userCard","required","selectWithConfirm","usersGridInit","usersSrv","universe","useUsers","filterGroups","usersSelection","restrictFromGroups","filterType","userType","group","user","confInput","length","value","Array","from","size","forcedIniUsers","nickNames","isUnknown","iniUsers","getUserSet","then","addEventListener","async","refreshUi","footer","_doBtn","disabled","label","doBtnLabel","ui-context","onclick","onDoBtn","onCancelBtn","focus","isDirty","computeDiffs","setAttrBool","diffs","srcUris","fetchUpdateRespByRespSingle","single","fetchUpdateRespByRespMulti","adds","removes","findPopupableParent","close","e","report","findHost","validAndDo","result","has","_a","find","_b","val","registerSkin","customElements","define"],"mappings":"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","sourcesContent":["import {BaseElement, BaseElementAsync, OSkinableInit} from \"back/commons/basis\";\nimport {Button} from \"back/commons/widgets/buttons\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {IReg, IUiEnv, REG} from \"lib/commons/registry\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {JSrcFields, RESPS} from \"lib/wsp/src\";\nimport {IWspEnv, WSP, Wsp} from \"lib/wsp/wsp\";\nimport {ITEM} from \"lib/wsp/item\";\nimport {IDatasResp} from \"lib/wsp/wspMetaUi\";\nimport {InputUserPanel, OInputUserInit} from \"back/core/widgets/inputs\";\nimport {EUserType, JUser} from \"lib/core/user\";\nimport {ERROR} from \"lib/core/errorReport\";\n\n\n/**\n * Dialogue d'affectation d'une responsabilité sur un ou plusieurs items\n */\n\nexport interface SrcEditResp extends BaseElement {\n\tinitialize(init: OSrcEditRespInit): this\n}\n\nexport interface OSrcEditRespInit extends OSkinableInit {\n\tshortDescs: JSrcFields[],\n\tresp: IDatasResp,\n\tdoBtnLabel?: string\n\tconfInput?: OInputUserInit<any>,\n}\n\nexport class SrcEditResp extends BaseElementAsync {\n\n\t/** Contexte */\n\treg: IReg<IWspEnv & IUiEnv>;\n\n\tlongDescs: JSrcFields[];\n\n\tprotected _inptElt: InputUserPanel<any>;\n\tprotected _doBtn: Button;\n\n\tprivate _iniValues: Set<string>;\n\n\tget wsp(): Wsp {return this.reg.env.wsp};\n\n\tconf: OSrcEditRespInit;\n\n\tprotected async _initialize(init: OSrcEditRespInit) {\n\t\tthis.reg = this.findReg(init);\n\t\tthis.conf = init;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(\"webzone:panel\", sr);\n\t\tthis.reg.installSkin(\"standard-dialog\", sr);\n\t\tthis._initAndInstallSkin(this.localName, init);\n\n\t\tconst refUris: string[] = [];\n\t\tthis.conf.shortDescs.forEach((entry) => refUris.push(entry.srcUri))\n\t\tthis.longDescs = await WSP.fetchLongDescs(this.wsp, this, ...refUris);\n\n\t\tthis._iniValues = new Set();\n\t\tthis.longDescs.forEach((shortDesc) => {\n\t\t\tconst respList = RESPS.toRespsList(shortDesc.rspUsrs);\n\t\t\tif (respList && respList[this.conf.resp.code])\n\t\t\t\trespList[this.conf.resp.code].forEach((account) => this._iniValues.add(account))\n\t\t});\n\n\t\tconst main = sr.appendChild(<div id=\"main\">\n\t\t\t<div class=\"key\">{this.conf.resp.name}</div>\n\t\t</div>);\n\t\tthis._inptElt = main.appendChild(<InputUserPanel î={Object.assign({\n\t\t\treg: this.reg,\n\t\t\tuserCard: this.conf.resp.userCard,\n\t\t\trequired: false,\n\t\t\tselectWithConfirm: false,\n\t\t\tusersGridInit: {\n\t\t\t\tusersSrv: init.reg.env.universe.useUsers,\n\t\t\t\tfilterGroups: this.conf.resp.usersSelection.restrictFromGroups,\n\t\t\t\tfilterType: this.conf.resp.usersSelection.userType === 'groups' ? EUserType.group : (this.conf.resp.usersSelection.userType === 'users' ? EUserType.user : null),\n\t\t\t}\n\t\t} as OInputUserInit<any>, this.conf.confInput)}/> as InputUserPanel<any>) as InputUserPanel<any>;\n\t\tif (this.longDescs.length === 1) {\n\t\t\tthis._inptElt.value = Array.from(this._iniValues);\n\t\t} else {\n\t\t\tif (this.conf.resp.userCard === \"single\") {\n\t\t\t\t// On ne met la valeur initiale QUE si elle est homogène\n\t\t\t\tif (this._iniValues.size === 1)\n\t\t\t\t\tthis._inptElt.value = Array.from(this._iniValues);\n\t\t\t\telse if (this._iniValues.size > 1)\n\t\t\t\t\tthis._inptElt.forcedIniUsers = [{account: '-', nickNames: ['Valeurs hétérogènes'], isUnknown: true} as JUser];\n\t\t\t} else {\n\t\t\t\tconst iniUsers = this.reg.env.universe.useUsers.getUserSet(Array.from(this._iniValues), true);\n\t\t\t\tiniUsers.then((resp) => {\n\t\t\t\t\tthis._inptElt.forcedIniUsers = resp;\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\n\t\tthis._inptElt.addEventListener(\"input\", async () => {\n\t\t\tthis.refreshUi();\n\t\t});\n\n\t\tconst footer = sr.appendChild(<div id=\"footer\"/>);\n\t\tthis._doBtn = footer.appendChild(<Button id=\"do\" disabled class=\"default\" label={this.conf.doBtnLabel || 'Enregistrer'} ui-context=\"dialog\" onclick={this.onDoBtn}/>) as Button;\n\t\tfooter.appendChild(<Button id=\"cancel\" label=\"Annuler\" ui-context=\"dialog\" onclick={this.onCancelBtn}/>);\n\n\t\tthis._inptElt.focus();\n\t}\n\n\tprivate refreshUi() {\n\t\tconst isDirty = this.computeDiffs() != null;\n\t\tDOM.setAttrBool(this._doBtn, 'disabled', !isDirty);\n\t}\n\n\tprivate async validAndDo() {\n\t\ttry {\n\t\t\tconst diffs: { adds?: string[], removes?: string[] } | { single: string } | null = this.computeDiffs();\n\t\t\tif (diffs) {\n\t\t\t\tconst srcUris: string[] = [];\n\t\t\t\tthis.longDescs.forEach((shortDesc) => srcUris.push(shortDesc.srcUri));\n\t\t\t\tif (\"single\" in diffs)\n\t\t\t\t\tawait ITEM.fetchUpdateRespByRespSingle(this.reg.env.wsp, this, srcUris, this.conf.resp.code, (diffs as any).single);\n\t\t\t\telse\n\t\t\t\t\tawait ITEM.fetchUpdateRespByRespMulti(this.reg.env.wsp, this, srcUris, this.conf.resp.code, (diffs as any).adds, (diffs as any).removes);\n\t\t\t\tPOPUP.findPopupableParent(this).close(true);\n\t\t\t}\n\t\t\tPOPUP.findPopupableParent(this).close(false);\n\t\t} catch (e) {\n\t\t\tconst resp = this.conf.resp.name;\n\t\t\tawait ERROR.report(`Échec lors de la mise à jour de la responsabilité '${resp}'`, e);\n\t\t\tPOPUP.findPopupableParent(this).close(null);\n\t\t}\n\t}\n\n\tprivate onCancelBtn(this: Button) {\n\t\tPOPUP.findPopupableParent(this).close();\n\t}\n\n\tprivate onDoBtn(this: Button) {\n\t\tif (!this.disabled)\n\t\t\t(DOMSH.findHost(this) as SrcEditResp).validAndDo();\n\t}\n\n\t/**\n\t * Calcul les directives d'affectation des reps\n\t * @return null si aucune action à exécuter\n\t * @private\n\t */\n\tprivate computeDiffs(): { adds?: string[], removes?: string[] } | { single: string } | null {\n\t\tconst result: { adds?: string[], removes?: string[], single?: string } = {};\n\n\t\tconst srcUris: string[] = [];\n\t\tthis.longDescs.forEach((shortDesc) => srcUris.push(shortDesc.srcUri));\n\t\tif (this.conf.resp.userCard === 'single') {\n\t\t\tif (this._inptElt.value && this._inptElt.value[0]) {\n\t\t\t\tif (!this._iniValues || this._iniValues.size != 1 || !this._iniValues.has(this._inptElt.value[0])) {\n\t\t\t\t\tresult.single = this._inptElt.value[0];\n\t\t\t\t\treturn result;\n\t\t\t\t}\n\t\t\t} else if (this._iniValues && this._iniValues.size > 0 && (!this._inptElt.forcedIniUsers || this._inptElt.forcedIniUsers.length == 0)) {\n\t\t\t\tresult.removes = Array.from(this._iniValues);\n\t\t\t\treturn result;\n\t\t\t}\n\t\t} else if (this.conf.resp.userCard === 'multi') {\n\t\t\tresult.adds = [];\n\t\t\tresult.removes = [];\n\t\t\t// Recherche des valeurs supprimées\n\t\t\tif (this._iniValues) {\n\t\t\t\tthis._iniValues.forEach((account) => {\n\t\t\t\t\tif (!this._inptElt.forcedIniUsers?.find((user) => user.account === account) && !this._inptElt.value?.find((val) => account === val))\n\t\t\t\t\t\tresult.removes.push(account);\n\t\t\t\t})\n\t\t\t}\n\t\t\t// Valeurs ajoutées\n\t\t\tthis._inptElt.value?.forEach((account) => {\n\t\t\t\tresult.adds.push(account);\n\t\t\t});\n\t\t\tif (result.adds.length > 0 || result.removes.length > 0)\n\t\t\t\treturn result;\n\t\t}\n\t\treturn null;\n\t}\n}\n\nREG.reg.registerSkin('wsp-src-editresp', 1, /* language=CSS */ `\n\t:focus-visible {\n\t\toutline: var(--focus-outline);\n\t}\n\n\t.key {\n\t\tmargin-inline-end: 1em;\n\t}\n\n\t#main {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: row;\n\t\talign-items: center;\n\t\tpadding: .5em;\n\t}\n\n\tc-input-users-panel {\n\t\tflex: 1;\n\t}\n\n\tc-button {\n\t\tmin-width: 8em;\n\t}\n`);\n\ncustomElements.define(\"wsp-src-editresp\", SrcEditResp);\n"]}