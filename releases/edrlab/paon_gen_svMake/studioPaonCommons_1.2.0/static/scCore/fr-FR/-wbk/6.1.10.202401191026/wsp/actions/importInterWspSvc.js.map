{"version":3,"sources":["/@back@/wsp/actions/importInterWspSvc.tsx"],"names":["ITEM","WSP","ESrcSt","SRC","POPUP","SrcNewCode","IO","DOM","JSX","ShadowJsx","WspImportInterWsp","[object Object]","wspFrom","srcFrom","options","reg","uiCtx","this","transientCache","canPrx","canCopy","canExt","countChoices","ct","createElement","id","appendChild","name","value","type","transient","getTransient","srcId","class","refExtItemAcceptable","uriParentFrozen","isAirItem","srcUri","uri","getItemUriLabel","disabled","î","shortDesc","firstOpt","findNext","elt","HTMLInputElement","checked","result","showDialog","skinOver","onkeypress","onKeypress","ev","key","preventDefault","stopImmediatePropagation","shadowRoot","getElementById","click","label","ui-context","onclick","findPopupableParent","close","elements","namedItem","titleBar","onNextClose","env","wsp","fetchShortDesc","buildTansientUri","code","doPrx","doCopy","isPublic","showNotifForbidden","isExtItem","universe","config","backEnd","hasPerm","hasPermission","srcRoles","auth","currentUser","isSuperAdmin","srcRi","getSrcUriType","srcSt","none","confirm","okLbl","srcRestore","initialize","parentFolder","defaultUriParent","defaultCode","extractLeafFromUri","targetSrcUriType","doBtnReplaceLabel","allowReplace","undefined","inputLabel","doBtnLabel","newCode","barLabel","newUri","addLeafToUri","srcMove","showNotifInfo","extractSpaceLabel","fetchSrcId","parentUri","URI_ROOT","targetWsp","isAvailable","waitForAvailable","targetUri","wsps","exportUrl","fetchVoid","qs","method"],"mappings":"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","sourcesContent":["import {IImportInterWspSvc, ITEM, OImportInterWspOptions} from \"lib/wsp/item\";\nimport {IWspUiEnv, WSP, Wsp} from \"lib/wsp/wsp\";\nimport {ESrcSt, JSrcFields, SRC} from \"lib/wsp/src\";\nimport {IReg} from \"lib/commons/registry\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {SrcNewCode} from \"back/wsp/dialogs/srcNewCode\";\nimport {IO} from \"lib/commons/io/io\";\nimport {DOM, JSX, ShadowJsx} from \"lib/commons/xml/dom\";\nimport {OSrcDrawerInit} from \"back/wsp/widgets/srcDrawer\";\nimport {Button} from \"back/commons/widgets/buttons\";\nimport \"lib/wsp/wsp_Perms\";\n\nexport class WspImportInterWsp implements IImportInterWspSvc {\n\n\tprotected transientCache: JSrcFields;\n\n\tasync importSrc(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tthis.transientCache = null; //reset\n\t\tconst canPrx = this.canPrx(wspFrom, srcFrom, options, reg, uiCtx);\n\t\tconst canCopy = this.canCopy(wspFrom, srcFrom, options, reg, uiCtx);\n\t\tconst canExt = this.canExt(wspFrom, srcFrom, options, reg, uiCtx);\n\t\tconst countChoices = ((canCopy ? 1 : 0) + (canExt ? 1 : 0) + (canPrx ? 1 : 0));\n\n\t\t//Actuellement, la compat est déjà évaluée en amont, mais c'est imparfait (modèles doc !=).\n\t\t//if (countChoices > 0 && !await this.isTargetCompat(wspFrom, srcFrom, options, reg, uiCtx)) return null;\n\n\t\tif (countChoices > 1) {\n\t\t\tconst ct = <form id=\"main\"/> as HTMLFormElement;\n\t\t\tif (canExt) {\n\t\t\t\tct.appendChild(<label><input name=\"choice\" value=\"ext\" type=\"radio\"/>Lier directement cet item étranger</label>)\n\t\t\t}\n\t\t\tif (canPrx) {\n\t\t\t\tconst transient = await this.getTransient(wspFrom, srcFrom, options, reg, uiCtx);\n\t\t\t\tif (!transient.srcId) {\n\t\t\t\t\t//Prx pas encore existant\n\t\t\t\t\tct.appendChild(<label class=\"ctrlLbl\"><input name=\"choice\" value=\"prx\" type=\"radio\"/>Créer une réplique locale de cet item étranger</label>)\n\t\t\t\t} else if (options.refExtItemAcceptable) {\n\t\t\t\t\tct.appendChild(<label class=\"ctrlLbl\"><input name=\"choice\" value=\"prx\" type=\"radio\"/>Lier la réplique locale (déjà créée) de cet item étranger</label>)\n\t\t\t\t} else if (options.uriParentFrozen && ITEM.isAirItem(transient.srcUri)) {\n\t\t\t\t\tct.appendChild(<label class=\"ctrlLbl\"><input name=\"choice\" value=\"prx\" type=\"radio\"/>Ancrer dans cet espace la réplique locale (déjà créée) de cet item étranger</label>)\n\t\t\t\t} else {\n\t\t\t\t\t//prx déjà ancré, option désactivée\n\t\t\t\t\tconst uri = ITEM.getItemUriLabel(transient.srcUri);\n\t\t\t\t\tct.appendChild(<label>\n\t\t\t\t\t\t<input name=\"choice\" value=\"prx\" disabled=\"\" type=\"radio\"/>{`Une réplique de cet item étranger existe déjà :`}\n\t\t\t\t\t\t<wsp-src-drawer-inline î={{reg, shortDesc: transient} as OSrcDrawerInit}/>\n\t\t\t\t\t</label>);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (canCopy) {\n\t\t\t\tct.appendChild(<label><input name=\"choice\" value=\"copy\" type=\"radio\"/>Dupliquer ce contenu étranger dans l'atelier</label>)\n\t\t\t}\n\n\t\t\tconst firstOpt = DOM.findNext(ct, ct, (elt): elt is HTMLInputElement => elt instanceof HTMLInputElement && !elt.disabled);\n\t\t\tif (firstOpt) firstOpt.checked = true;\n\n\t\t\tconst result = await POPUP.showDialog<'ext' | 'prx' | 'copy'>(<c-box skinOver=\"webzone:panel form-control-areas standard-dialog\" onkeypress={function onKeypress(this: HTMLElement, ev: KeyboardEvent) {\n\t\t\t\tif (ev.key === 'Enter') {\n\t\t\t\t\tev.preventDefault();\n\t\t\t\t\tev.stopImmediatePropagation();\n\t\t\t\t\tthis.shadowRoot.getElementById(\"ok\").click();\n\t\t\t\t}\n\t\t\t}}>\n\t\t\t\t<ShadowJsx>\n\t\t\t\t\t{ct}\n\t\t\t\t\t<div id=\"footer\">\n\t\t\t\t\t\t<c-button id=\"ok\" label=\"Valider\" class=\"default\" ui-context=\"dialog\" onclick={function (this: Button) {POPUP.findPopupableParent(this).close((ct.elements.namedItem(\"choice\") as RadioNodeList).value)}}/>\n\t\t\t\t\t\t<c-button label=\"Annuler\" ui-context=\"dialog\" onclick={function (this: Button) {POPUP.findPopupableParent(this).close(null)}}/>\n\t\t\t\t\t</div>\n\t\t\t\t</ShadowJsx>\n\t\t\t</c-box>, uiCtx, {titleBar: \"Contenu issu d'un autre atelier...\"}).onNextClose();\n\t\t\tswitch (result) {\n\t\t\tcase \"ext\":\n\t\t\t\treturn reg.env.wsp.fetchShortDesc(ITEM.buildTansientUri(wspFrom.code, srcFrom.srcUri), uiCtx);\n\t\t\tcase \"prx\":\n\t\t\t\treturn this.doPrx(wspFrom, srcFrom, options, reg, uiCtx);\n\t\t\tcase \"copy\":\n\t\t\t\treturn this.doCopy(wspFrom, srcFrom, options, reg, uiCtx);\n\t\t\t}\n\t\t\treturn null;\n\t\t} else if (canExt) {\n\t\t\treturn reg.env.wsp.fetchShortDesc(ITEM.buildTansientUri(wspFrom.code, srcFrom.srcUri), uiCtx);\n\t\t} else if (canCopy) {\n\t\t\treturn this.doCopy(wspFrom, srcFrom, options, reg, uiCtx);\n\t\t} else if (canPrx) {\n\t\t\treturn this.doPrx(wspFrom, srcFrom, options, reg, uiCtx);\n\t\t} else if (options.refExtItemAcceptable) {\n\t\t\tif (!wspFrom.isPublic) {\n\t\t\t\tPOPUP.showNotifForbidden(\"L'atelier auquel appartiennent les items issus du presse-papier n'est pas déclaré 'public', les items ne peuvent pas être directement référencés.\", uiCtx);\n\t\t\t} else if (reg.env.wsp.isExtItem) {\n\t\t\t\tPOPUP.showNotifForbidden(\"Cet atelier n'est pas configuré pour pouvoir référencer des items issus d'autres ateliers.\", uiCtx);\n\t\t\t} else {\n\t\t\t\tPOPUP.showNotifForbidden(\"Impossible de copier des contenus issus d'un autre atelier.\", uiCtx);\n\t\t\t}\n\t\t} else {\n\t\t\tPOPUP.showNotifForbidden(\"Impossible de copier des contenus issus d'un autre atelier.\", uiCtx);\n\t\t}\n\t\treturn null\n\t}\n\n\t/**\n\t * Retourne srcFrom, idéalement traduit dans le contexte de l'atelier cible, sans être encore réellement importé.\n\t * Ok en DB, en FS, c'est imparfait, on retourne simplement srcFrom.\n\t */\n\tprotected async getTransient(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields> {\n\t\tif (!this.transientCache) {\n\t\t\tthis.transientCache = reg.env.universe.config.backEnd === \"odb\" ? await WSP.fetchShortDesc(reg.env.wsp, uiCtx, \"/~transient/\" + wspFrom.code + srcFrom.srcUri) : srcFrom;\n\t\t}\n\t\treturn this.transientCache;\n\t}\n\n\tcanCopy(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): boolean {\n\t\t//return false; //todo\n\t\t//Si on cherche des items (refExtItemAcceptable) on restreint.\n\t\tif (!wspFrom.reg.hasPerm(\"read.node.copyFrom.interWsp\")) return false;\n\t\tif (!wspFrom.reg.hasPermission(\"write.node.duplicate\", srcFrom.srcRoles, reg.env.universe.auth.currentUser.isSuperAdmin, srcFrom.srcRi))\n\t\t\treturn false;\n\t\t// La cible est inconnue à ce stade => cette perm 'write.node.copyTo' ne peut etre vérifiée ici\n\t\t//if(!reg.hasPerm([\"write.node.copyTo\"])) return false;// évalué par approximation sur l'atelier\n\t\treturn options.refExtItemAcceptable ? ITEM.getSrcUriType(srcFrom.srcUri) === \"item\" : true;\n\t}\n\n\tcanPrx(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): boolean {\n\t\treturn false; //todo\n\t\t//return reg.env.wsp.isPrxItem && ITEM.getSrcUriType(srcFrom.srcUri) === \"item\";\n\t}\n\n\tcanExt(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): boolean {\n\t\treturn options.refExtItemAcceptable && wspFrom.isPublic && reg.env.wsp.isExtItem;\n\t}\n\n\t// async isTargetCompat(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions & OImportItemOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<boolean> {\n\t// \tif (options.sgnPattern) {\n\t// \t\t//Note : en FS, l'eval de compat est imparfaite, on prend l'itModel de l'autre atelier.\n\t// \t\tconst transient = await this.getTransient(wspFrom, srcFrom, options, reg, uiCtx);\n\t// \t\tif (!options.sgnPattern.test(transient.itModel)) {\n\t// \t\t\tPOPUP.showNotifInfo(\"Cet item n'est pas autorisé dans ce contexte d'usage.\", uiCtx);\n\t// \t\t\treturn false;\n\t// \t\t}\n\t// \t}\n\t// \treturn true;\n\t// }\n\n\tasync doPrx(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tconst transient = await this.getTransient(wspFrom, srcFrom, options, reg, uiCtx);\n\t\t//console.log(\"transient:::\", transient);\n\t\tif (transient.srcId) {\n\t\t\t//Proxy déjà existant.\n\t\t\tif (transient.srcSt === ESrcSt.none) {\n\t\t\t\t//Mais en corbeille, on va proposer de le restaurer\n\t\t\t\tif (await POPUP.confirm(\"Une réplique de cet item étranger existe déjà dans cet atelier, mais est en corbeille. Voulez-vous la restaurer ?\", uiCtx, {okLbl: \"Restaurer\"})) {\n\t\t\t\t\tawait WSP.srcRestore(reg.env.wsp, uiCtx, [transient.srcId]);\n\t\t\t\t} else return null;\n\t\t\t}\n\t\t\tif (options.uriParentFrozen) {\n\t\t\t\tif (ITEM.getSrcUriType(transient.srcUri) === \"item\" && ITEM.isAirItem(transient.srcUri)) {\n\t\t\t\t\t//Le prx est en airItem, on propose de l'ancrer à options.defaultUriParent.\n\t\t\t\t\tconst ct = new SrcNewCode().initialize({\n\t\t\t\t\t\treg: reg,\n\t\t\t\t\t\tparentFolder: options.defaultUriParent,\n\t\t\t\t\t\tdefaultCode: SRC.extractLeafFromUri(transient.srcUri),\n\t\t\t\t\t\ttargetSrcUriType: ITEM.getSrcUriType(transient.srcUri),\n\t\t\t\t\t\tdoBtnReplaceLabel: options.allowReplace ? \"Remplacer le contenu existant\" : undefined,\n\t\t\t\t\t\tinputLabel: \"Une réplique de cet item étranger existe déjà sous forme d'un item flottant. Voulez-vous l'ancrer dans cet espace ?\",\n\t\t\t\t\t\tdoBtnLabel: \"Ancrer\"\n\t\t\t\t\t});\n\t\t\t\t\tconst newCode = await POPUP.showDialog<string>(ct, uiCtx, {titleBar: {barLabel: {label: \"Ancrer la réplique de cet item étranger...\"}}}).onNextClose();\n\t\t\t\t\tif (newCode) {\n\t\t\t\t\t\tconst newUri = SRC.addLeafToUri(options.defaultUriParent, newCode);\n\t\t\t\t\t\tawait WSP.srcMove(reg.env.wsp, uiCtx, transient.srcId, newUri);\n\t\t\t\t\t\treturn WSP.fetchShortDesc(reg.env.wsp, uiCtx, newUri);\n\t\t\t\t\t}\n\t\t\t\t\treturn null;\n\t\t\t\t} else {\n\t\t\t\t\t//Le proxy est déjà ancré dans un espace\n\t\t\t\t\t//XXX proposer déplacement dans options.defaultUriParent avec un SrcNewCode ?\n\t\t\t\t\tconst uri = ITEM.getItemUriLabel(transient.srcUri);\n\t\t\t\t\tPOPUP.showNotifInfo(`Une réplique de cet item étranger existe déjà : ${uri}`, uiCtx);\n\t\t\t\t\treturn transient; //on le retourne simplement (pour sélection auto), même si pas dans options.defaultUriParent.\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn transient; //prx dispo\n\t\t}\n\t\t//On va créer le proxy\n\t\tif (options.uriParentFrozen) {\n\t\t\t//Et l'ancrer\n\t\t\tconst uri = ITEM.extractSpaceLabel(options.defaultUriParent);\n\t\t\tconst ct = new SrcNewCode().initialize({\n\t\t\t\treg: reg,\n\t\t\t\tparentFolder: options.defaultUriParent,\n\t\t\t\tdefaultCode: SRC.extractLeafFromUri(transient.srcUri),\n\t\t\t\ttargetSrcUriType: ITEM.getSrcUriType(transient.srcUri),\n\t\t\t\t//doBtnReplaceLabel: options.allowReplace ? \"Remplacer le contenu existant\" : undefined, todo java config ITEB\n\t\t\t\tinputLabel: `Code de cette réplique dans l'espace : ${uri}`,\n\t\t\t\tdoBtnLabel: \"Créer\"\n\t\t\t});\n\t\t\tconst newCode = await POPUP.showDialog<string>(ct, uiCtx, {titleBar: {barLabel: {label: \"Créer la réplique de cet item étranger...\"}}}).onNextClose();\n\t\t\tif (newCode) {\n\t\t\t\tconst srcId = await WSP.fetchSrcId(reg.env.wsp, uiCtx, transient.srcUri, true);\n\t\t\t\tconst newUri = SRC.addLeafToUri(options.defaultUriParent, newCode);\n\t\t\t\tawait WSP.srcMove(reg.env.wsp, uiCtx, srcId, newUri);\n\t\t\t\treturn WSP.fetchShortDesc(reg.env.wsp, uiCtx, newUri);\n\t\t\t}\n\t\t} else if (await POPUP.confirm(\"Créer une réplique de cet item étranger dans cet atelier ?\", uiCtx)) {\n\t\t\tconst srcId = await WSP.fetchSrcId(reg.env.wsp, uiCtx, transient.srcUri, true);\n\t\t\treturn WSP.fetchShortDesc(reg.env.wsp, uiCtx, srcId);\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync doCopy(wspFrom: Wsp, srcFrom: JSrcFields, options: OImportInterWspOptions, reg: IReg<IWspUiEnv>, uiCtx: HTMLElement): Promise<JSrcFields | null> {\n\t\tconst parentUri = options.defaultUriParent || SRC.URI_ROOT;\n\t\tconst uri = options.defaultUriParent || \"[Racine de l'atelier]\";\n\t\tconst ct = new SrcNewCode().initialize({\n\t\t\treg: reg,\n\t\t\tparentFolder: parentUri, //Si options.defaultUriParent==null select espace avant ?\n\t\t\tdefaultCode: SRC.extractLeafFromUri(srcFrom.srcUri),\n\t\t\ttargetSrcUriType: ITEM.getSrcUriType(srcFrom.srcUri),\n\t\t\t//doBtnReplaceLabel: options.allowReplace ? \"Remplacer le contenu existant\" : undefined, todo java config ITEB\n\t\t\tinputLabel: `Code dans : ${uri}`,\n\t\t\tdoBtnLabel: \"Dupliquer\"\n\t\t});\n\t\tconst newCode = await POPUP.showDialog<string>(ct, uiCtx, {titleBar: {barLabel: {label: \"Dupliquer ce contenu étranger...\"}}}).onNextClose();\n\t\tif (newCode) {\n\t\t\tconst targetWsp = reg.env.wsp;\n\t\t\tif (!targetWsp.isAvailable) await targetWsp.waitForAvailable(uiCtx);\n\t\t\tconst targetUri = SRC.addLeafToUri(parentUri, newCode);\n\t\t\tawait reg.env.universe.config.wsps.exportUrl.fetchVoid(IO.qs(\"cdaction\", \"Copy\",\n\t\t\t\t\"param\", wspFrom.code, \"refUris\", srcFrom.srcUri,\n\t\t\t\t\"wspTarget\", targetWsp.code, \"srcRefTarget\", targetUri), {method: \"POST\"});\n\t\t\treturn WSP.fetchShortDesc(targetWsp, uiCtx, targetUri);\n\t\t}\n\t\treturn null;\n\t}\n}"]}