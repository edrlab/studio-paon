{"version":3,"sources":["/@back@/core/apps/frameApp.tsx"],"names":["BaseElementAsync","REG","JSX","FontSizeDeskFeat","UiThemeDeskFeat","captureScenariProtocol","IO","POPUP","DOMSH","FrameApp","[object Object]","init","this","appDef","reg","findReg","anonymousAllowed","name","setAttribute","iframe","createElement","id","src","url","isIn","desk","injectTheme","addEventListener","onLoadedPage","_attach","localName","frameApp","findHost","win","contentWindow","winLoc","location","href","e","initParentFrame","super","buildInitFromAtts","getAttribute","shadowRoot","getElementById","def","closed","_themeLstn","onThemeChange","delete","injectThemeInSubFrame","getFrame","injectFontSizeInSubFrame","perm","libPath","findScPermLibPath","env","resolver","import","resolvePath","hasPerm","registerSkin","customElements","define","ShowApp","_a","show","alias","aliasUrls","_b","confirm","uiRoot","cancelLbl","_c","isRedirectValid","whiteDomains","skin","_initialize"],"mappings":"OAAqBA,qBAAgC;OAE/BC,QAAI;OAElBC,QAAI;OACJC,iBAA+BC,oBAAgB;OAC/CC,2BAAuB;OAEvBC,OAAqB;OACrBC,UAAM;OACNC,UAAM;OAkBR,MAAOC,iBAAiBT,iBAQnBU,kBAAkBC,MAC3BC,KAAKC,OAASF,KAAKE;AACnBD,KAAKE,IAAMF,KAAKG,QAAQJ;AACxBC,KAAKI,iBAAmBL,KAAKK;AAC7B,GAAIL,KAAKM,KAAML,KAAKM,aAAa,QAASP,KAAKM;AAC/C,MAAME,OAASjB,IAAAkB,cAAA,SAAA,CAAQC,GAAG,OAAOC,IAAKX,KAAKY;AAG3C,GAAInB,gBAAgBoB,KAAKC,MAAQN,OAAeO,YAActB,gBAAgBsB;AAE9EP,OAAOQ,iBAAiB,OAAQf,KAAKgB;AACrChB,KAAKiB,QAAQjB,KAAKkB,UAAWnB,KAAMQ,QAK1BT,qBACT,MAAMqB,SAAWvB,MAAMwB,SAASpB;AAChC,MAAMqB,IAAMrB,KAAKsB;AACjB,IAAIC;AACJ,IAECA,OAASF,IAAIG,SAASC,KACrB,MAAOC,IACT,IAAKH,QAAUA,SAAW,cAAe,CAExC,OAID,GAAIF,IAAIM,gBAAiBN,IAAIM,gBAAgBR;AAE7C1B,uBAAuBO,KAAMmB,SAASjB,KAGvCJ,kBAAkBC,MACjBA,KAAO6B,MAAMC,kBAAkB9B;AAC/BA,KAAKY,IAAMX,KAAK8B,aAAa;AAC7B,OAAO/B,KAGRD,WAA+B,OAAOE,KAAK+B,WAAWC,eAAe,QAKrElC,aAAamC,KACZ,OAAO,MAGRnC,aAAaoC,QACZ,GAAIA,QAAUlC,KAAKmC,YAAc3C,gBAAgBoB,KAAKC,MAAO,CAC5DA,KAAKuB,cAAcC,OAAOrC,KAAKmC;AAC/BnC,KAAKmC,WAAa,MAIpBrC,cACC,GAAIN,gBAAgBoB,KAAKC,MAAOA,KAAKyB,sBAAsBtC,KAAKuC;AAChE,GAAIhD,iBAAiBqB,KAAKC,MAAOA,KAAK2B,yBAAyBxC,KAAKuC,YAGrEzC,cAAc2C,MACb,MAAMC,cAAgBrD,IAAIsD,kBAAkBF;AAC5C,GAAIzC,KAAKE,IAAI0C,IAAIC,UAAYH,cACtBI,OAAO9C,KAAKE,IAAI0C,IAAIC,SAASE,YAAYL;AAChD,OAAO1C,KAAKE,IAAI8C,QAAQP,OAI1BpD,IAAIa,IAAI+C,aAAa,cAAe,EAAsB;AAiB1DC,eAAeC,OAAO,cAAetD;OA2C/B,MAAOuD,gBAAgBvD,SAMlBC,YAAYC;AACrB,IAAIsD,GAAAtD,KAAKE,OAAOqD,QAAI,MAAAD,UAAA,OAAA,EAAAA,GAAEE,MAAO,CAC5B,GAAIxD,KAAKyD,UACRzD,KAAKY,IAAMZ,KAAKyD,UAAUzD,KAAKE,OAAOqD,KAAKC;AAC5C,IAAKxD,KAAKY,IAAK,CACd,MAAM4C,OAAQE,GAAA1D,KAAKE,OAAOqD,QAAI,MAAAG,UAAA,OAAA,EAAAA,GAAEF;AAChC5D,MAAM+D,QAAQ,8CAA8CH,SAAUxD,KAAKG,IAAI0C,IAAIe,OAAQ,CAACC,UAAW;AACvG7D,KAAKY,IAAM,mBAEN,CACNZ,KAAKY,KAAMkD,GAAA9D,KAAKE,OAAOqD,QAAI,MAAAO,UAAA,OAAA,EAAAA,GAAElD;AAC7B,IAAKjB,GAAGoE,gBAAgB/D,KAAKY,IAAKZ,KAAKgE,cAAgB,MAAO,CAC7D,MAAMpD,IAAMZ,KAAKY;AACjBhB,MAAM+D,QAAQ,8CAA8C/C,OAAQZ,KAAKG,IAAI0C,IAAIe,OAAQ,CAACC,UAAW;AACrG7D,KAAKY,IAAM,eAGbZ,KAAKiE,KAAO;AACZ,OAAOpC,MAAMqC,YAAYlE,OAI3BmD,eAAeC,OAAO,WAAYC","sourcesContent":["import {BaseElement, BaseElementAsync, OSkinableInit} from \"back/commons/basis\";\nimport {IApp, IAppCtx, JAppDef} from \"back/core/appFrame\";\nimport {IReg, IUiEnv, REG} from 'lib/commons/registry';\nimport {IView} from \"lib/commons/views\";\nimport {JSX} from \"lib/commons/xml/dom\";\nimport {FontSizeDeskFeat, ThemeAction, UiThemeDeskFeat} from \"back/core/plugins/optionsPlg\";\nimport {captureScenariProtocol} from \"lib/core/scenariProtocol\";\nimport {JShowAppDef} from \"back/core/plugins/showPlg\";\nimport {IO, IResolverPointer} from \"lib/commons/io/io\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\n\n/**\n * App constituée d'une simple iframe dont l'URL n'est pas spécifiable en paramètre de l'app mais par le code.\n *\n * @see ShowApp\n */\nexport interface FrameApp extends BaseElement, IView {\n\tinitialize(init: OFrameAppInit): this;\n}\n\nexport interface OFrameAppInit extends OSkinableInit, IAppCtx<IUiEnv> {\n\treg: IReg<IUiEnv>\n\turl: string\n\tanonymousAllowed: boolean;\n\tname?: string\n}\n\nexport class FrameApp extends BaseElementAsync implements IApp<IUiEnv>, IFrameAppParentFrame {\n\n\tanonymousAllowed: boolean;\n\n\treg: IReg<IUiEnv & IResolverPointer>;\n\n\tappDef: JAppDef;\n\n\tprotected async _initialize(init: OFrameAppInit) {\n\t\tthis.appDef = init.appDef;\n\t\tthis.reg = this.findReg(init) as IReg<IUiEnv>;\n\t\tthis.anonymousAllowed = init.anonymousAllowed;\n\t\tif (init.name) this.setAttribute(\"label\", init.name);\n\t\tconst iframe = <iframe id=\"ifrm\" src={init.url}/> as HTMLIFrameElement;\n\n\t\t/** @deprecated laissé pour compat asc. Passer plutot par {@link IWindowFrameApp.initParentFrame} */\n\t\tif (UiThemeDeskFeat.isIn(desk)) (iframe as any).injectTheme = UiThemeDeskFeat.injectTheme;\n\n\t\tiframe.addEventListener(\"load\", this.onLoadedPage);\n\t\tthis._attach(this.localName, init, iframe);\n\t}\n\n\n\t/** Chargement d'une nouvelle page. */\n\tprotected async onLoadedPage(this: HTMLIFrameElement) {\n\t\tconst frameApp = DOMSH.findHost(this) as FrameApp;\n\t\tconst win = this.contentWindow as IWindowFrameApp;\n\t\tlet winLoc;\n\t\ttry {\n\t\t\t// Une exception est lancé si bloqué par la sécurité\n\t\t\twinLoc = win.location.href;\n\t\t} catch (e) {}\n\t\tif (!winLoc || winLoc === \"about:blank\") {\n\t\t\t//chargement intial de l'iframe ou reset de la page.\n\t\t\treturn;\n\t\t}\n\n\t\t//déclaration du contexte parent.\n\t\tif (win.initParentFrame) win.initParentFrame(frameApp);\n\n\t\tcaptureScenariProtocol(this, frameApp.reg);\n\t}\n\n\tbuildInitFromAtts(init?: OFrameAppInit): any {\n\t\tinit = super.buildInitFromAtts(init);\n\t\tinit.url = this.getAttribute(\"url\");\n\t\treturn init;\n\t}\n\n\tgetFrame(): HTMLIFrameElement {return this.shadowRoot.getElementById(\"ifrm\") as HTMLIFrameElement}\n\n\tprotected _randomId: string;\n\tprotected _themeLstn: (theme: ThemeAction) => void;\n\n\tupdateAppDef(def: JAppDef): boolean {\n\t\treturn false;\n\t}\n\n\tonViewHidden(closed?: boolean): void {\n\t\tif (closed && this._themeLstn && UiThemeDeskFeat.isIn(desk)) {\n\t\t\tdesk.onThemeChange.delete(this._themeLstn);\n\t\t\tthis._themeLstn = null;\n\t\t}\n\t}\n\n\tinjectTheme(): void {\n\t\tif (UiThemeDeskFeat.isIn(desk)) desk.injectThemeInSubFrame(this.getFrame());\n\t\tif (FontSizeDeskFeat.isIn(desk)) desk.injectFontSizeInSubFrame(this.getFrame());\n\t}\n\n\tasync hasPerm(perm: string): Promise<boolean> {\n\t\tconst libPath = await REG.findScPermLibPath(perm);\n\t\tif (this.reg.env.resolver && libPath)\n\t\t\tawait import(this.reg.env.resolver.resolvePath(libPath));\n\t\treturn this.reg.hasPerm(perm);\n\t}\n}\n\nREG.reg.registerSkin('c-frame-app', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\n\tiframe {\n\t\tflex: 1;\n\t\twidth: 100%;\n\t\theight: 100%;\n\t\tborder: none;\n\t\t/*background: white;*/\n\t}\n`);\n\ncustomElements.define('c-frame-app', FrameApp);\n\n/**\n * API implémentable par les pages affichées dans ce contexte FrameApp\n */\nexport interface IWindowFrameApp extends Window {\n\n\t/** Appelé sur le onLoad de la page web */\n\tinitParentFrame?(parentFrame: IFrameAppParentFrame): void\n}\n\n/**\n * Contexte parent des pages de l frameApp, fournit à la page du dynGen\n * via IWindowFrameApp.initParentFrame(parentFrame: IFrameAppParentFrame)\n */\nexport interface IFrameAppParentFrame {\n\n\t/** Injecte le thème courant dans la page */\n\tinjectTheme(): void\n\n\t/** Evalue une permission donnée sur le contexte reg courant */\n\thasPerm(perm: string): Promise<boolean>\n\n}\n\n\n/**\n * App constituée d'une simple iframe dont l'URL est spécifiée\n * \t- en paramètre direct de l'app. Dans ce cas, l'URL **DOIT** passer la couche de contrôle {@link IO.isRedirectValid} pour des questions de sécurité ;\n *\t- en exploitant une URL déclarée via son id ;\n */\nexport interface ShowApp extends FrameApp {\n\tinitialize(init: OShowAppInit): this;\n}\n\nexport interface OShowAppInit extends OFrameAppInit {\n\tappDef: JShowAppDef,\n\t/** Liste blanche des domaines autorisés */\n\twhiteDomains?: string[]\n\t/** URLs préenregistrée, référençables par ID. Syntaxe : id:url */\n\taliasUrls?: Dict<string>\n}\n\nexport class ShowApp extends FrameApp {\n\n\tappDef: JShowAppDef;\n\n\tview: FrameApp;\n\n\tprotected _initialize(init: OShowAppInit): Promise<void> {\n\t\tif (init.appDef.show?.alias) {\n\t\t\tif (init.aliasUrls)\n\t\t\t\tinit.url = init.aliasUrls[init.appDef.show.alias]\n\t\t\tif (!init.url) {\n\t\t\t\tconst alias = init.appDef.show?.alias;\n\t\t\t\tPOPUP.confirm(`La configuration de la vue est invalide : ${alias}`, init.reg.env.uiRoot, {cancelLbl: null});\n\t\t\t\tinit.url = \"about:blank\";\n\t\t\t}\n\t\t} else {\n\t\t\tinit.url = init.appDef.show?.url;\n\t\t\tif (!IO.isRedirectValid(init.url, init.whiteDomains || true)) {\n\t\t\t\tconst url = init.url;\n\t\t\t\tPOPUP.confirm(`La configuration de la vue est invalide : ${url}`, init.reg.env.uiRoot, {cancelLbl: null});\n\t\t\t\tinit.url = \"about:blank\";\n\t\t\t}\n\t\t}\n\t\tinit.skin = \"c-frame-app\";\n\t\treturn super._initialize(init);\n\t}\n}\n\ncustomElements.define('show-app', ShowApp);"]}