{"version":3,"sources":["/@back@/edit/wed/wedlets/decor/decorPreviewIFrame.tsx"],"names":["WedletFork","JSX","REG","DOMSH","XA","FontSizeDeskFeat","UiThemeDeskFeat","captureScenariProtocol","registerEditProtocolsActions","DecorPreviewIFrame","HTMLElement","[object Object]","this","href","tpl","wedlet","DecorPreviewIframeWedlet","getAttribute","reg","wedMgr","sr","attachShadow","SHADOWDOM_INIT","installSkin","localName","previewFrame","appendChild","createElement","addEventListener","onLoadedPage","val","children","redraw","win","contentWindow","reloadPage","getNodeContent","src","decorPreviewIFrame","findHost","initParentFrame","isIn","desk","injectThemeInSubFrame","injectFontSizeInSubFrame","findDomLast","wedAnchor","docHolder","getDocument","registerSkin","window","customElements","define","elt","mainWedlet","super","futureTask","msg"],"mappings":"OAAiCA,eAAW;OAEpCC,QAAI;OACUC,QAAI;OAClBC,UAAM;OACNC,OAAG;OAEHC,iBAAkBC,oBAAgB;OAClCC,2BAAuB;OACvBC,iCAA6B;OAQ/B,MAAOC,2BAA2BC,YAAxCC;AAQSC,KAAAC,KAAe,cAEvBF,gBAAgBG,IAAcC,QAC7BH,KAAKG,OAAS,IAAIC,yBAAyBJ,KAAMG;AACjDH,KAAKC,KAAOD,KAAKK,aAAa;AAC9BL,KAAKM,IAAMH,OAAOI,OAAOD;AACzB,MAAME,GAAKR,KAAKS,aAAalB,MAAMmB;AACnCV,KAAKM,IAAIK,YAAYX,KAAKY,UAAWJ;AACrCR,KAAKa,aAAeL,GAAGM,YAAYzB,IAAA0B,cAAA,SAAA;AACnCf,KAAKa,aAAaG,iBAAiB,OAAQhB,KAAKiB;AAChDrB,6BAA6BI,KAAKM;AAClCX,uBAAuBK,KAAKa,aAAcb,KAAKM,KAGhDP,iBAAiBmB,IAA+BC,UAC/CnB,KAAKoB,SAGNrB,SACC,MAAMsB,IAAMrB,KAAKa,aAAaS;AAC9B,GAAID,MAAG,MAAHA,WAAG,OAAA,EAAHA,IAAKE,WAAYF,IAAIE,WAAWvB,KAAKwB;KACpCxB,KAAKa,aAAaY,IAAMzB,KAAKC,KAIzBF,qBACT,MAAM2B,mBAAqBnC,MAAMoC,SAAS3B;AAC1C,MAAMqB,IAAMrB,KAAKsB;AACjB,GAAID,IAAIO,gBAAiBP,IAAIO,gBAAgBF;AAC7C/B,uBAAuBK,KAAM0B,mBAAmBpB,KAIjDP,cACC,GAAIL,gBAAgBmC,KAAKC,MAAOA,KAAKC,sBAAsB/B,KAAKa;AAChE,GAAIpB,iBAAiBoC,KAAKC,MAAOA,KAAKE,yBAAyBhC,KAAKa,cAGrEd,iBACC,OAAOP,GAAGyC,YAAYjC,KAAKG,OAAO+B,UAAWlC,KAAKG,OAAOI,OAAO4B,UAAUC,eAG3ErC,iBACC,OAAOC,KAAKG,OAAOI,OAAO4B,UAAUC,eAKtC9C,IAAIgB,IAAI+B,aAAa,uBAAwB,EAAsB;AAenEC,OAAOC,eAAeC,OAAO,uBAAwB3C;OAE/C,MAAOO,iCAAiChB,WAI7CW,YAAmB0C,IAAyBC,YAAsBC,MAAMD;AAArD1C,KAAAyC,IAAAA;AAFnBzC,KAAA4C,WAAa,EAIb7C,oBAAoB8C,KACnB7C,KAAKyC,IAAIrB","sourcesContent":["import {IElementWedlet, IWedlet, WedletFork} from \"back/edit/wed/wedlets/wedlet\";\nimport {IXmlMsg} from \"lib/edit/ot/xmlHouse\";\nimport {JSX} from \"lib/commons/xml/dom\";\nimport {IReg, IUiEnv, REG} from \"lib/commons/registry\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {XA} from \"lib/commons/xml/xAddr\";\nimport {IJmlNode, IJmlSubSet} from \"lib/commons/xml/jml\";\nimport {FontSizeDeskFeat, UiThemeDeskFeat} from \"back/core/plugins/optionsPlg\";\nimport {captureScenariProtocol} from \"lib/core/scenariProtocol\";\nimport {registerEditProtocolsActions} from \"back/edit/actions/scProtocolActions\";\n\n/**\n * Widget d'affichage d'une zone de previsualisation libre sous forme HTML.\n *\n * Attributs :\n * \thref=\"xxx.xhtml\"\n */\nexport class DecorPreviewIFrame extends HTMLElement implements IElementWedlet, IDecorPreviewFragParentFrame {\n\n\twedlet: DecorPreviewIframeWedlet;\n\n\tpreviewFrame: HTMLIFrameElement;\n\n\tprotected reg: IReg<IUiEnv>;\n\n\tprivate href: string = \"about:blank\";\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet): void {\n\t\tthis.wedlet = new DecorPreviewIframeWedlet(this, wedlet);\n\t\tthis.href = this.getAttribute(\"href\");\n\t\tthis.reg = wedlet.wedMgr.reg;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tthis.reg.installSkin(this.localName, sr);\n\t\tthis.previewFrame = sr.appendChild(<iframe/>) as HTMLIFrameElement;\n\t\tthis.previewFrame.addEventListener(\"load\", this.onLoadedPage);\n\t\tregisterEditProtocolsActions(this.reg);\n\t\tcaptureScenariProtocol(this.previewFrame, this.reg);\n\t}\n\n\trefreshBindValue(val: IJmlNode | string | null, children?: IJmlSubSet) {\n\t\tthis.redraw();\n\t}\n\n\tredraw() {\n\t\tconst win = this.previewFrame.contentWindow as IWindowPreviewFrag;\n\t\tif (win?.reloadPage) win.reloadPage(this.getNodeContent());\n\t\telse this.previewFrame.src = this.href;\n\t}\n\n\t/** Chargement d'une nouvelle page du decorPreviewIFrame. */\n\tprotected async onLoadedPage(this: HTMLIFrameElement) {\n\t\tconst decorPreviewIFrame = DOMSH.findHost(this) as DecorPreviewIFrame;\n\t\tconst win = this.contentWindow as IWindowPreviewFrag;\n\t\tif (win.initParentFrame) win.initParentFrame(decorPreviewIFrame);\n\t\tcaptureScenariProtocol(this, decorPreviewIFrame.reg);\n\t}\n\n\t/** @link IDecorPreviewFragParentFrame */\n\tinjectTheme() {\n\t\tif (UiThemeDeskFeat.isIn(desk)) desk.injectThemeInSubFrame(this.previewFrame);\n\t\tif (FontSizeDeskFeat.isIn(desk)) desk.injectFontSizeInSubFrame(this.previewFrame);\n\t}\n\n\tgetNodeContent(): Node | Attr {\n\t\treturn XA.findDomLast(this.wedlet.wedAnchor, this.wedlet.wedMgr.docHolder.getDocument());\n\t}\n\n\tgetRootContent(): Document {\n\t\treturn this.wedlet.wedMgr.docHolder.getDocument();\n\t}\n\n}\n\nREG.reg.registerSkin('decor-preview-iframe', 1, /* language=CSS */ `\n\t:host {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t}\n\n\tiframe {\n\t\tflex: 1 1 15em;\n\t\tborder: none;\n\t\tuser-select: none;\n\t}\n`);\n\nwindow.customElements.define(\"decor-preview-iframe\", DecorPreviewIFrame);\n\nexport class DecorPreviewIframeWedlet extends WedletFork {\n\n\tfutureTask = 0;\n\n\tconstructor(public elt: DecorPreviewIFrame, mainWedlet: IWedlet) {super(mainWedlet)}\n\n\tupdateInDescendants(msg: IXmlMsg) {\n\t\tthis.elt.redraw();\n\t}\n\n}\n\n\n/**\n * Contexte parent des pages du decorPreviewIFrame, fournit à la page du decorPreviewIFrame\n * via IWindowPreviewFrag.initParentFrame(parentFrame: IWindowPreviewFrag)\n */\nexport interface IDecorPreviewFragParentFrame {\n\n\t/** Injecte le thème courant dans la page du decorPreviewIFrame. */\n\tinjectTheme(): void\n\n\t/** Retourne le noeud XML (et sa descendance) en cours d'édition */\n\tgetNodeContent(): Node | Attr\n\n\t/** Retourne le document complet en cours d'édition */\n\tgetRootContent(): Document\n\n}\n\n/**\n * API à implémenter par les pages fournies par le decorPreviewIFrame.\n */\nexport interface IWindowPreviewFrag extends Window {\n\n\t/** Appelé sur le onLoad de la page web du decorPreviewIFrame. */\n\tinitParentFrame?(parentFrame: IDecorPreviewFragParentFrame): void\n\n\t/** Appelé lors d'une détection d'un changement d'un item impliqué dans la construction de cette page. */\n\treloadPage?(val?: Node | Attr): void\n\n}"]}