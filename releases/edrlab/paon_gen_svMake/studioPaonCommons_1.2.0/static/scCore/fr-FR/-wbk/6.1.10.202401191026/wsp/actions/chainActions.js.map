{"version":3,"sources":["/@back@/wsp/actions/chainActions.tsx"],"names":["Action","Desk","POPUP","ChainAction","[object Object]","ctx","this","checkCompatKey","checkCompat","reg","env","universe","super","isEnabled","isBackendDb","config","backEnd","isBackendFs","isVisible","getDescription","newWsp","openWspAfterCreate","getUserData","hasPerm","desk","findAndOpenApp","u","getId","wspDoc","code","wsp","CreateWspAction","id","_description","_label","_group","setIcon","requireEnabledPerm","ev","WspCreateProps","import","showDialog","initialize","uiRoot","titleBar","barLabel","label","closeButton","resizer","initWidth","initHeight","viewPortX","viewPortY","onNextClose","SINGLETON","ImportWspAction","WspCreateFromScwspProps","fixSize","ManageWspsAction","WspsMgr","closeOnCtrlEnter"],"mappings":"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","sourcesContent":["import {IRegPointer} from \"lib/commons/registry\";\nimport {IChainEnv} from \"lib/wsp/chain\";\nimport {Action} from \"lib/commons/actions\";\nimport {Desk} from \"lib/commons/desk\";\nimport {ICreateWspCtx, IWspActionCtx} from \"back/wsp/actions/wspActions\";\nimport {IWspUiEnv, Wsp} from \"lib/wsp/wsp\";\nimport {AppFrameDeskFeat} from \"back/core/appFrame\";\nimport {POPUP} from \"back/commons/widgets/popups\";\nimport {JWspAppDef, JWspDocAppDef} from \"back/wsp/plugins/wspsPlg\";\n\n\n/**\n * Actions de l'univers chain (niveau entrepot)\n */\nexport abstract class ChainAction<E extends IRegPointer<IChainEnv>> extends Action<E> {\n\tisBackendDb?: boolean;\n\tisBackendFs?: boolean;\n\tcheckCompatKey?: string | null;\n\n\tisEnabled(ctx: E): boolean {\n\t\tif (this.checkCompatKey && !Desk.checkCompat(this.checkCompatKey)) return false;\n\t\tif (!ctx.reg || !ctx.reg.env || !ctx.reg.env.universe) return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\tisVisible(ctx: E): boolean {\n\t\tif (this.isBackendDb && ctx.reg.env.universe.config.backEnd === \"fs\") return false;\n\t\tif (this.isBackendFs && ctx.reg.env.universe.config.backEnd === \"odb\") return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n\tgetDescription(ctx: E): string {\n\t\tif (this.checkCompatKey && !Desk.checkCompat(this.checkCompatKey)) return \"Ce navigateur n'est pas compatible avec cette fonction\";\n\t\treturn super.getDescription(ctx);\n\t}\n\n\t/** Fct mutualisée de l'ouverture d'un wsp après création. */\n\tprotected openWspAfterCreate(ctx: IWspActionCtx & ICreateWspCtx, newWsp: Wsp | null) {\n\t\tif (newWsp && ctx.openWspAfterCreate !== false) {\n\t\t\t// Ouverture de l'atelier\n\t\t\t// Remarque : wspDoc et wsp ouvriront l'écran des propriétés du wsp si celui-ci est en erreur => non géré ici\n\t\t\tconst reg = ctx.reg;\n\t\t\tif (!reg.getUserData(\"wspAppPrefered\") && reg.hasPerm(\"ui.wspDocApp\")) {\n\t\t\t\t(desk as AppFrameDeskFeat).findAndOpenApp({u: reg.env.universe.getId(), wspDoc: newWsp.code} as JWspDocAppDef);\n\t\t\t} else if (reg.hasPerm(\"ui.wspApp\")) {\n\t\t\t\t(desk as AppFrameDeskFeat).findAndOpenApp({u: reg.env.universe.getId(), wsp: newWsp.code} as JWspAppDef);\n\t\t\t}\n\t\t}\n\t}\n}\n\n/** Création d'un atelier\n *\t\tIRegPointer<IWspUiEnv> permet de créer un atelier en se basant sur les propriétés existantes d'un autre atelier\n * */\nexport class CreateWspAction extends ChainAction<IRegPointer<IWspUiEnv>> {\n\tstatic SINGLETON = new CreateWspAction();\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"createWsp\");\n\t\tthis.checkCompatKey = \"formElt\";\n\t\tthis._description = this._label = \"Créer un atelier...\";\n\t\tthis._group = \"add\";\n\t\tthis.setIcon(\"/@skin@/wsp/actions/wspCreate.svg\");\n\t\tthis.requireEnabledPerm(\"action.chain#create.wsp\");\n\t}\n\n\tasync execute(ctx: IRegPointer<IWspUiEnv> & ICreateWspCtx, ev?: Event): Promise<Wsp | null> {\n\t\tconst reg = ctx.reg;\n\t\tconst {WspCreateProps} = await import(\"back/wsp/dialogs/wspProps.js\");\n\t\tconst wsp = await POPUP.showDialog<Wsp | null>(new WspCreateProps().initialize({\n\t\t\treg: reg.env.universe.reg,\n\t\t}), ctx.reg.env.uiRoot, {\n\t\t\ttitleBar: {barLabel: {label: \"Création d'un atelier\"}, closeButton: {}},\n\t\t\tresizer: {},\n\t\t\tinitWidth: '45em',\n\t\t\tinitHeight: '70vh',\n\t\t\tviewPortX: \"middle\",\n\t\t\tviewPortY: \"middle\"\n\t\t}).onNextClose();\n\t\tthis.openWspAfterCreate(ctx, wsp);\n\t\treturn wsp;\n\t}\n}\n\n/** Import d'un atelier */\nexport class ImportWspAction extends ChainAction<IRegPointer<IChainEnv>> {\n\tstatic SINGLETON = new ImportWspAction();\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"importWsp\");\n\t\tthis.checkCompatKey = \"formElt\";\n\t\tthis._label = \"Importer un atelier...\";\n\t\tthis._description = \"Import d'un atelier à partir d'une archive (.scwsp, .scar)\";\n\t\tthis._group = \"add\";\n\t\tthis.setIcon(\"/@skin@/wsp/actions/wspImport.svg\");\n\t\tthis.requireEnabledPerm(\"action.chain#import.wsp\")\n\t}\n\n\tasync execute(ctx: IRegPointer<IWspUiEnv>, ev?: Event): Promise<Wsp | null> {\n\t\tconst reg = ctx.reg;\n\t\tconst {WspCreateFromScwspProps} = await import(\"back/wsp/dialogs/wspProps.js\");\n\t\tconst wsp = await POPUP.showDialog<Wsp | null>(new WspCreateFromScwspProps().initialize({\n\t\t\treg: ctx.reg,\n\t\t}), ctx.reg.env.uiRoot, {\n\t\t\ttitleBar: {barLabel: {label: \"Import d'un atelier à partir d'une archive\"}, closeButton: {}},\n\t\t\tresizer: {},\n\t\t\tviewPortX: \"middle\",\n\t\t\tviewPortY: \"middle\",\n\t\t\tfixSize: false\n\t\t}).onNextClose();\n\t\tthis.openWspAfterCreate(ctx, wsp);\n\t\treturn wsp;\n\t}\n}\n\n/** Gestion d'un atelier */\nexport class ManageWspsAction extends ChainAction<IRegPointer<IChainEnv>> {\n\n\tconstructor(id?: string) {\n\t\tsuper(id || \"manageWsps\");\n\t\tthis.checkCompatKey = \"formElt\";\n\t\tthis._label = \"Gérer les ateliers...\";\n\t\tthis._group = \"manage\";\n\t\tthis.requireEnabledPerm(\"action.chain#manage.wsps\");\n\t}\n\n\tasync execute(ctx: IRegPointer<IWspUiEnv>, ev?: Event): Promise<void> {\n\t\tconst {WspsMgr} = await import(\"back/wsp/dialogs/wspsMgr.js\");\n\t\tawait POPUP.showDialog(new WspsMgr().initialize({\n\t\t\treg: ctx.reg,\n\t\t}), ctx.reg.env.uiRoot, {\n\t\t\tcloseOnCtrlEnter: true,\n\t\t\ttitleBar: {barLabel: {label: \"Gestion des ateliers\"}, closeButton: {}},\n\t\t\tresizer: {},\n\t\t\tinitWidth: \"min(90vw,60em)\",\n\t\t\tinitHeight: \"90vh\"\n\t\t}).onNextClose();\n\t}\n}"]}