{"version":3,"sources":["/@back@/edit/wed/wedlets/box/boxTags.tsx"],"names":["Button","RadioBtnsActionable","IS_Popupable","POPUP","PopupActions","AgEltBoxSelection","isEltBoxSelection","AgEltBoxInsertDrawerBox","EWedletEditMode","EWedletEditModeLabel","findElementWedlet","IS_EltWedlet","WedAnnotErr","WedAnnotSearch","WEDLET","WEDLET_SINGLEELT","ACTION","Action","ActionMenu","ActionSeparator","LANG","REG","DOM","ENodeType","JSX","DOMSH","JML","XA","isXmlMsg","EAnnotLevel","isSkAnnotDrawer","isSkAnnotMissing","SkAnnotAttrUnknown","SkAnnotEltUnknown","SkAnnotTextForbidden","isSkSearchAnnot","BaseElement","BASIS","PublicEndPoint","InputUserPanel","EUserType","BoxContainer","HTMLElement","[object Object]","elt","childrenElts","this","wedlet","model","delegatedHost","dispatchEvent","Event","bubbles","composed","tpl","subEltWedlets","cloneWedletContent","parentNode","config","val","children","classList","toggle","isVirtual","i","length","refreshBindValue","clearAnnots","sub","onChildWedletsChange","from","chars","msg","insertChars","len","deleteChars","replaceChars","mode","setAttr","setEditMode","reassessPerms","isEmpty","annot","drawAnnot","type","TYPE","add","findFirstChild","n","structDef","structMatch","nodeType","wedNodeName","nodeName","element","insertAnnot","eraseAnnot","remove","removeAnnot","BoxHost","setDelegatedHost","super","configWedletElt","window","customElements","define","BoxStatic","BoxCtn","getAttribute","hvAuto","first","elementHost","findNextSibling","selMode","actionsLists","BoxCollaps","onkeydown","onKeyDown","collapsed","hasAttribute","state","setAttrBool","_doCollapse","_doUncollapse","CustomEvent","skinCollaps","skinUncollaps","atInit","removeSkin","shadowRoot","skinOver","wedMgr","reg","installSkin","skinCollOver","collapser","getElementById","underMode","head","querySelector","btn","document","createElement","id","title","onclick","onDblClick","appendChild","addEventListener","onPointerBody","insertBefore","firstChild","body","scrollTop","refreshEditMode","wedEditor","boxSelMgr","hideSel","selectWedlet","decollapser","skinUncoOver","removeEventListener","sh","attachShadow","SHADOWDOM_INIT","installSkins","ondblclick","onDblClickInShadow","ev","me","findHost","stopPropagation","preventDefault","target","stopImmediatePropagation","focus","key","isAccelPressed","in","isAnyControlPressed","BoxCtnInput","input","findBoxInput","matches","focusableElement","handleEventFromContainer","composedPath","ensureVisible","scrollContainer","findStandardInput","findFlatNext","getComputedStyle","display","HTMLInputElement","HTMLTextAreaElement","HTMLSelectElement","BoxCreate","tabIndex","setAttribute","sr","localName","jml","defaultContent","JSON","parse","KeyboardEvent","keyCode","isWritableWedlet","eltWedlet","clearSel","insertDatasFromDisplay","registerSkin","BoxInput","multiline","webValue","value","isCaretInput","trimOnBlur","dispatchMode","_createShadow","_initListeners","_initReadOnly","oldWebChars","offset","setSelectionRange","oldXmlChars","selectionStart","selectionEnd","xa","wedAnchor","start","end","freeze","append","setAtDepth","readOnly","write","batchDone","jmlNode2value","setWebValue","xml2webChars","currentMsg","docHolderAsync","isMsgFromUs","isAncOrEquals","setCaretAt","removeAnnots","stringInsert","stringDelete","isReadOnly","dispatchValue","boxInput","inputType","dispatchDiff","trim","newC","web2xmlChars","oldC","thisXa","wedParent","onChildEmptied","subXa","isEquals","docHolder","newBatch","deleteSequence","doBatch","reselectOnVirtualizing","setText","minLen","Math","min","startDiff","charCodeAt","endDiff","maxEndDiff","oldLast","newLast","sumSame","spliceSequence","substr","insertText","writeRangeToClipboard","getSelRange","clipboardData","then","doc","isConnected","deleteRange","txStamp","impCtx","sel","virtualPath","buildVirtualPath","targetHint","imports","tryPaste","showNotifWarning","doImport","async","importer","needAsyncBuild","buildContentToImport","batch","actions","map","imp","setLabel","getLabel","setExecute","showPopupActions","clone","cloneNode","otherValue","hasChildNodes","cloneSimpleContent","onInput","onBlurTrim","onChange","onBlur","onBeforeInput","onKeyPress","onCopy","onCut","onPaste","replace","AgEltBoxInputAnnotable","BoxInputCtEdit","placeholder","spellcheck","style","whiteSpace","contentEditable","t","textContent","substring","removeAttribute","read","fixSel","endsWith","getSelection","setPosition","lastChild","focusOffset","rg","getRangeAt","startOffset","endOffset","collapse","webRg","BoxInputRaw","prototype","call","txt","getData","xaRange","isCollapsed","setSelAfterSeq","BoxInputDate","re","test","editPending","contains","removeClass","validity","valid","addClass","BoxInputNumber","BoxInputUser","multiUsersSeparator","_a","filter","entry","join","initialize","userCard","required","selectWithConfirm","hideRemButton","emptySelectionMsg","usersGridInit","usersSrv","env","universe","useUsers","filterGroups","split","filterType","group","user","valArray","stringify","addUser","BoxInputRange","previewValueElement","disabled","BoxInputColor","defaultColor","onKeydown","colorPattern","navigator","clipboard","writeText","color","readText","e","BoxInputEnum","valPrefix","valSuffix","WedEnumProvider","initProviderFromTpl","role","skin","onClick","bind","popup","provider","getActions","show","action","getAction","getKey","refreshFreeze","normaliseValue","label","icon","getIcon","refresh","open","Promise","div","act","_labelElt","_iconElt","iconUrl","setProperty","startsWith","labelIconBox","class","nextSibling","_createPopup","restoreFocus","actionContext","detail","actionable","isToggle","isEnabled","isSelected","getId","replaceValue","connectedCallback","onEnumChange","_lstn","delete","BoxInputRadio","childNodes","node","importNode","actionnableList","Ã®","uiContext","redrawActionnableList","_redrawActionnableListPendig","refreshContent","boxError","fill","iconElt","rootEnum","_actions","buildActions","widget","enumProvider","svcCd","svc","getSvc","console","warn","url","WedEnumProviderFromUrl","shareEnumProvForTpl","entries","ctx","isMenu","r","findEntry","getDatas","prov","result","ch","firstElementChild","nextElementSibling","k","a","BoxEnumEntry","setIcon","setDescription","_nullAction","push","_b","setActions","BoxEnumMenu","_c","regexp","list","subList","filterActions","getDescription","splice","RegExp","escape4RegexpFuzzy","credentials","setEnabled","fetching","fetchEnum","baseURI","fetchDom","documentElement","api","_id","isKeyEnabled","isKeyVisible","isVisible","BoxLabel","userSelect","nodeLabel","BoxValue","transform","Function","customize","v","toString","prefix","suffix","getFlatParentElt","insertDiffMark","parent","initDiffAnnot","defaultInject","insertDiffValue","initDiffValue","makeInputForDiff","insertDiffForeign","insBeforeWedlet","findWedletChild","VISITOPTIONS_mainBranch","undefined","initDiffForeign","createForeignHouse","injectForeignChild","foreignNode","insertDiffReplace","margin","foreignParent","foreignElt","foreign","attribute","level","weight","error","wedAnnotErr","addAnnot","initAnnot","wedAnnotSearch","initSearchAnnot","diffLib","isDiffAnnot","getDiffSession","diffSession","getWedletDepth","wedAnnotDiff","skAnnot","removeDiffWidget","d","_d","removeAll","cls","proto","boxTagsDefined","resolve"],"mappings":"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","sourcesContent":["import {Button, RadioBtnsActionable} from \"back/commons/widgets/buttons\";\nimport {IPopupable, IS_Popupable} from \"back/commons/widgets/popupable\";\nimport {POPUP, PopupActions} from \"back/commons/widgets/popups\";\nimport {AgEltBoxSelection, IEltBoxSelection, isEltBoxSelection, IWedEditorBoxSel, IWedletBoxSelection} from \"back/edit/wed/features/boxSel\";\nimport {AgEltBoxInsertDrawerBox} from \"back/edit/wed/features/insMgr\";\nimport {IWedChildrenElt, IWedSelector} from \"back/edit/wed/wedCore\";\nimport {BoxModel, BoxWedlet} from \"back/edit/wed/wedlets/box/box\";\nimport {\n\tEWedletEditMode,\n\tEWedletEditModeLabel,\n\tfindElementWedlet,\n\tICharsUpdate,\n\tIElementWedlet,\n\tIParentWedlet,\n\tIS_EltWedlet,\n\tIVirtualisableWedlet,\n\tIWedAnnotPointer,\n\tIWedlet,\n\tWedAnnotErr,\n\tWedAnnotSearch,\n\tWEDLET\n} from \"back/edit/wed/wedlets/wedlet\";\nimport {IWedletSingleElt, WEDLET_SINGLEELT} from \"back/edit/wed/wedlets/wedletSingleElt\";\nimport {ACTION, Action, ActionMenu, ActionSeparator, IAction, IActionToggle} from \"lib/commons/actions\";\nimport {LANG} from \"lib/commons/lang\";\nimport {IReg, IUiEnv, REG} from \"lib/commons/registry\";\nimport {DOM, ENodeType, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IJmlNode, IJmlObj, IJmlSet, IJmlSubSet, JML} from \"lib/commons/xml/jml\";\nimport {IXAddr, IXAddrRange, XA} from \"lib/commons/xml/xAddr\";\nimport {isXmlMsg, IXmlMsg} from \"lib/edit/ot/xmlHouse\";\nimport {EAnnotLevel, ISkAnnot, ISkAnnotDrawer, isSkAnnotDrawer, isSkAnnotMissing, SkAnnotAttrUnknown, SkAnnotEltUnknown, SkAnnotTextForbidden} from \"lib/edit/schema/schemaAnnots\";\nimport {ISkImporter, OSkPasteContext} from \"lib/edit/schema/schemaMeta\";\nimport {IActionable, IActionableList, OActionableListInit} from \"back/commons/actionables\";\nimport {isSkSearchAnnot} from \"lib/edit/schema/schemaSearch\";\nimport {IDiffAnnotForeign, IDiffAnnotMark, IDiffAnnotReplace, IDiffAnnotValue} from \"lib/edit/schema/diff\";\nimport {WedDiffForeign, WedDiffMark, WedDiffValue} from \"back/edit/wed/wedlets/diff/diffTags\";\nimport {BaseElement, BASIS} from \"back/commons/basis\";\nimport {IResolverPointer, PublicEndPoint} from \"lib/commons/io/io\";\nimport {EventMgr} from \"lib/commons/events\";\nimport \"back/edit/wed/wedlets/box/boxGeneric\";\nimport {InputUserPanel, OInputUserInit} from \"back/core/widgets/inputs\";\nimport {EUserType} from \"lib/core/user\";\n\n\nexport interface IBoxElement extends IElementWedlet {\n\t/**\n\t * Liste des Ã©lÃ©ments shadow de ce container qui implÃ©mentent IElementWedlet et qui doivent\n\t * Ãªtre informÃ©s des diffÃ©rents events issus du wedlet de ce noeud.\n\t * XXX Ã  Ã©valuer le gain/perte par rapport au parcours du shadowTree pour retrouver ces noeuds.\n\t */\n\tsubEltWedlets?: IElementWedlet[];\n}\n\nexport abstract class BoxContainer extends HTMLElement implements CustomElement, IBoxElement, ISkAnnotDrawer {\n\n\t/**\n\t * @see {IWedSelectorFactory}\n\t */\n\tstatic buildWedSelector(elt: Element): IWedSelector {return null}\n\n\twedlet: IParentWedlet & IWedletSingleElt;\n\n\tget childrenElts(): IWedChildrenElt[] {return (this.wedlet.model as BoxModel).childrenElts}\n\n\tdelegatedHost?: HTMLElement;\n\n\t/**\n\t * Liste des Ã©lÃ©ments shadow de ce container qui implÃ©mentent IElementWedlet et qui doivent\n\t * Ãªtre informÃ©s des diffÃ©rents events issus du wedlet de ce noeud.\n\t * XXX Ã  Ã©valuer le gain/perte par rapport au parcours du shadowTree pour retrouver ces noeuds.\n\t */\n\tsubEltWedlets?: IElementWedlet[];\n\n\tsetDelegatedHost(delegatedHost: HTMLElement) {\n\t\t//non pas si dans mÃªme slot\n\t\t// let childrenElts = this.childrenElts;\n\t\t// if (childrenElts && childrenElts.length > 1) throw Error(\"Delegate host feature can't be used in wedlets with multiple <wed:children/>: \" + DOM.debug(this.wedlet.model.config));\n\t\tthis.delegatedHost = delegatedHost;\n\t}\n\n\tconnectedCallback() {\n\t\tif (this.delegatedHost) this.dispatchEvent(new Event('delegate-host', {bubbles: true, composed: true}));\n\t}\n\n\t// undelegate-host : pas d'usage.\n\t// disconnectedCallback() {\n\t// \tif (this.delegatedHost) this.dispatchEvent(new Event('undelegate-host', {bubbles: true, composed: true}));\n\t// }\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet as IParentWedlet & IWedletSingleElt;\n\t\tthis.subEltWedlets = WEDLET.cloneWedletContent(this, tpl, wedlet as IWedletSingleElt, tpl.parentNode === wedlet.model.config);\n\t}\n\n\trefreshBindValue(val: IJmlNode, children?: IJmlSubSet) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tthis.subEltWedlets[i].refreshBindValue(val, children);\n\t\t}\n\t\tWEDLET.clearAnnots(this);\n\t}\n\n\tonChildWedletsChange() {\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst sub = this.subEltWedlets[i];\n\t\t\tif (sub.onChildWedletsChange) sub.onChildWedletsChange();\n\t\t}\n\t}\n\n\tinsertChars(from: number, chars: string, msg: IXmlMsg) {\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif ('insertChars' in elt) elt.insertChars(from, chars, msg);\n\t\t}\n\t}\n\n\tdeleteChars(from: number, len: number, msg: IXmlMsg) {\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif ('deleteChars' in elt) elt.deleteChars(from, len, msg);\n\t\t}\n\t}\n\n\treplaceChars(chars: string, msg: IXmlMsg) {\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif ('replaceChars' in elt) elt.replaceChars(chars, msg);\n\t\t}\n\t}\n\n\tsetEditMode(mode: EWedletEditMode): void {\n\t\tDOM.setAttr(this, \"edit-mode\", EWedletEditModeLabel[mode]);\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif ('setEditMode' in elt) elt.setEditMode(mode);\n\t\t}\n\t}\n\n\treassessPerms() {\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif ('reassessPerms' in elt) elt.reassessPerms();\n\t\t}\n\t}\n\n\tisEmpty(): boolean {\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif (('isEmpty' in elt) && !elt.isEmpty()) return false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tdrawAnnot(annot: ISkAnnot): boolean {\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif (isSkAnnotDrawer(elt)) if (elt.drawAnnot(annot)) return true;\n\t\t}\n\t\t//pas trouvÃ© de widget interne pour afficher l'erreur, on cherche dans les widgets fils\n\t\tif (annot.type === SkAnnotEltUnknown.TYPE || annot.type === SkAnnotAttrUnknown.TYPE) this.classList.add(\"forbidden\");\n\t\telse if (isSkAnnotMissing(annot)) {\n\t\t\tif (DOM.findFirstChild(this, (n: Node): n is Node => {\n\t\t\t\tif (isSkAnnotDrawer(n) && IS_EltWedlet(n) && annot.structDef.structMatch(n.wedlet.model.nodeType, n.wedlet.wedNodeName || n.wedlet.model.nodeName)) {\n\t\t\t\t\tn.drawAnnot(annot);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t})) return true;\n\t\t}\n\t\tif (this === this.wedlet.element) {\n\t\t\tinsertAnnot(this, annot);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\teraseAnnot(annot: ISkAnnot): boolean {\n\t\tif (!this.wedlet) return false; //raceCond\n\t\tif (this.subEltWedlets) for (let i = 0; i < this.subEltWedlets.length; i++) {\n\t\t\tconst elt = this.subEltWedlets[i];\n\t\t\tif (isSkAnnotDrawer(elt)) if (elt.eraseAnnot(annot)) return true;\n\t\t}\n\t\tif (annot.type === SkAnnotEltUnknown.TYPE || annot.type === SkAnnotAttrUnknown.TYPE) this.classList.remove(\"forbidden\");\n\t\telse if (DOM.findFirstChild(this, (n: Node): n is Node => isSkAnnotDrawer(n) ? n.eraseAnnot(annot) : false)) return true;\n\t\tif (this === this.wedlet.element) return removeAnnot(this, annot);\n\t\treturn false;\n\t}\n\n}\n\nAgEltBoxInsertDrawerBox(BoxContainer);\n\nexport class BoxHost extends BoxContainer {\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\t(wedlet as IWedletSingleElt).element.setDelegatedHost(this);\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t}\n}\n\nwindow.customElements.define(\"box-host\", BoxHost);\n\nclass BoxStatic extends BoxContainer {\n}\n\nwindow.customElements.define(\"box-static\", BoxStatic);\n\n\n/** box-ctn = container sÃ©lectionnable. */\nclass BoxCtn extends BoxContainer implements IEltBoxSelection {\n\n\t/** Switch en vertical si ce container contient plus de 1 wedlet fils. */\n\thvAuto: boolean;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t\tif (tpl.getAttribute(\"hv\") === \"auto\") this.hvAuto = true;\n\t}\n\n\tonChildWedletsChange() {\n\t\tsuper.onChildWedletsChange();\n\t\tif (this.hvAuto) {\n\t\t\tconst first = DOM.findFirstChild(this.wedlet.elementHost, IS_EltWedlet);\n\t\t\tif (first && DOM.findNextSibling(first, IS_EltWedlet)) {\n\t\t\t\t//Plus de 1 wedlet\n\t\t\t\tif (this.classList.toggle(\"v\", true)) this.classList.remove(\"h\");\n\t\t\t} else {\n\t\t\t\tif (this.classList.toggle(\"h\", true)) this.classList.remove(\"v\");\n\t\t\t}\n\t\t}\n\t}\n}\n\nAgEltBoxSelection(BoxCtn, {selMode: 'box', actionsLists: ['actions:wed:box-ctn', 'actions:wed:box']});\nwindow.customElements.define(\"box-ctn\", BoxCtn);\n\n/**\n * Container collapsable.\n * Contraintes sur la structuration interne du contenu :\n * - un elt .head : dÃ©tection du double click, ajout d'un button decollapse en firstChild avec id=\"decollapser\"\n * - un elt .body : contenu dÃ©sactivÃ©.\n *\n * Si @collapsMode=\"start\" (par dÃ©faut)\n * - Le button est ajoutÃ© en premier fils du head UNIQUEMENT pour dÃ©collapser\n *\n * Si @collapsMode=\"start-switch\"\n * - Le button est ajoutÃ© en premier fils du head pour dÃ©collapser ET collapser\n *\n * Si @collapsMode=\"under\"\n * - Le button est ajoutÃ© en dernier fils du shadowRoot.\n *\n * Si @collapsDefault=\"ifVirtual\" l'Ã©tat\n *\n * Attributs :\n * - skinCollaps : nom du skin du reg Ã  injecter en Ã©tat collapsed. Valeur par dÃ©faut : \"box-collaps/collapsed\" ou \"box-collaps/collapsed_under\"\n * - skinCollapsOver : nom du skin du reg Ã  injecter en Ã©tat collapsed en sus de @skinCollaps.\n *\n * Attributs spÃ©cifiques au mode @collapsMode=\"start-switch\" :\n * - skinUncollaps : nom du skin du reg Ã  injecter en Ã©tat uncollapsed. Valeur par dÃ©faut : \"box-collaps/uncollapsed\"\n * - skinUncollapsOver : nom du skin du reg Ã  injecter en Ã©tat uncollapsed en sus de @skinUncollaps.\n */\nclass BoxCollaps extends BoxContainer {\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.onkeydown = this.onKeyDown;\n\t}\n\n\tget collapsed(): boolean {return this.hasAttribute('collapsed')}\n\n\tset collapsed(state: boolean) {\n\t\tif (DOM.setAttrBool(this, 'collapsed', state)) {\n\t\t\tif (state) this._doCollapse();\n\t\t\telse this._doUncollapse();\n\t\t\t//Aucune modif du contenu redraw du wed : \"wed-resized\" permet notifier Ã  la boxErrBar par exemple de se recalculer.\n\t\t\tthis.dispatchEvent(new CustomEvent(\"wed-resized\", {bubbles: true, composed: true}));\n\t\t}\n\t}\n\n\tprotected get skinCollaps(): string {return this.getAttribute(\"skinCollaps\") || (this.getAttribute(\"collapsMode\") === \"under\" ? \"box-collaps/collapsed_under\" : \"box-collaps/collapsed\")}\n\n\tprotected get skinUncollaps(): string {return this.getAttribute(\"collapsMode\") === \"start-switch\" ? \"box-collaps/uncollapsed\" : null}\n\n\tprotected _doCollapse(atInit?: boolean) {\n\t\tif (!atInit) {\n\t\t\tconst skinUncollaps = this.skinUncollaps;\n\t\t\tif (skinUncollaps) REG.removeSkin(skinUncollaps, this.shadowRoot);\n\t\t\tconst skinOver = this.getAttribute(\"skinUncollapsOver\");\n\t\t\tif (skinOver) REG.removeSkin(skinOver, this.shadowRoot);\n\t\t}\n\t\tconst wedMgr = this.wedlet.wedMgr;\n\t\twedMgr.reg.installSkin(this.skinCollaps, this.shadowRoot);\n\t\tconst skinCollOver = this.getAttribute(\"skinCollapsOver\");\n\t\tif (skinCollOver) wedMgr.reg.installSkin(skinCollOver, this.shadowRoot);\n\n\t\tconst collapser = this.shadowRoot.getElementById(\"collapser\");\n\t\tif (collapser) collapser.remove();\n\t\tconst underMode = this.getAttribute(\"collapsMode\") === \"under\";\n\t\tconst head = this.shadowRoot.querySelector(\".head\");\n\t\tif (head || underMode) {\n\t\t\tconst btn = document.createElement(\"span\");\n\t\t\tbtn.id = \"decollapser\";\n\t\t\tbtn.title = \"DÃ©ployer ce bloc\";\n\t\t\tbtn.onclick = this.onDblClick;\n\t\t\tif (underMode) {\n\t\t\t\tthis.shadowRoot.appendChild(btn);\n\t\t\t\tif (head) {\n\t\t\t\t\thead.addEventListener('pointerdown', this.onPointerBody, true);\n\t\t\t\t\thead.addEventListener('dblclick', this.onDblClick, true);\n\t\t\t\t\thead.addEventListener('focusin', this.onDblClick, true);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\thead.insertBefore(btn, head.firstChild);\n\t\t\t}\n\t\t}\n\t\tconst body = this.shadowRoot.querySelector(\".body\");\n\t\tif (body) {\n\t\t\tbody.addEventListener('pointerdown', this.onPointerBody, true);\n\t\t\tbody.addEventListener('dblclick', this.onDblClick, true);\n\t\t\tbody.addEventListener('focusin', this.onDblClick, true); // cas du ctrl+tab qui sel le dernier field\n\t\t\tbody.scrollTop = 0; //supprime une mÃ©moire d'un scrollTop lors du prÃ©cÃ©dent collapse suite Ã  un focus interne avant.\n\t\t}\n\t\tif (!atInit) {\n\t\t\tWEDLET.refreshEditMode(this.wedlet);\n\t\t\t//recalcul les btns d'insertion atts et child et rÃ©soud un pb de sÃ©lection curieux du contenu textuel dans le bloc dÃ©collapsÃ©\n\t\t\t(wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.hideSel();\n\t\t\t(wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.selectWedlet(this.wedlet as any as IWedletBoxSelection);\n\t\t}\n\t}\n\n\tprotected _doUncollapse(atInit?: boolean) {\n\t\tif (!atInit) {\n\t\t\tREG.removeSkin(this.skinCollaps, this.shadowRoot);\n\t\t\tconst skinOver = this.getAttribute(\"skinCollapsOver\");\n\t\t\tif (skinOver) REG.removeSkin(skinOver, this.shadowRoot);\n\n\t\t\tconst decollapser = this.shadowRoot.getElementById(\"decollapser\");\n\t\t\tif (decollapser) decollapser.remove();\n\t\t}\n\t\tconst wedMgr = this.wedlet.wedMgr;\n\n\t\tconst skinUncollaps = this.skinUncollaps;\n\t\tif (skinUncollaps) wedMgr.reg.installSkin(skinUncollaps, this.shadowRoot);\n\t\tconst skinUncoOver = this.getAttribute(\"skinUncollapsOver\");\n\t\tif (skinUncoOver) wedMgr.reg.installSkin(skinUncoOver, this.shadowRoot);\n\n\t\tconst head = this.shadowRoot.querySelector(\".head\");\n\t\tif (head) {\n\t\t\tconst mode = this.getAttribute(\"collapsMode\");\n\t\t\tif (mode === \"start-switch\") {\n\t\t\t\tconst btn = document.createElement(\"span\");\n\t\t\t\tbtn.id = \"collapser\";\n\t\t\t\tbtn.title = \"Replier ce bloc\";\n\t\t\t\tbtn.onclick = this.onDblClick;\n\t\t\t\thead.insertBefore(btn, head.firstChild);\n\t\t\t} else if (mode === \"under\") {\n\t\t\t\thead.removeEventListener('pointerdown', this.onPointerBody, true);\n\t\t\t\thead.removeEventListener('dblclick', this.onDblClick, true);\n\t\t\t\thead.removeEventListener('focusin', this.onDblClick, true);\n\t\t\t}\n\t\t}\n\n\t\tif (!atInit) {\n\t\t\tconst body = this.shadowRoot.querySelector(\".body\");\n\t\t\tif (body) {\n\t\t\t\tbody.removeEventListener('pointerdown', this.onPointerBody, true);\n\t\t\t\tbody.removeEventListener('dblclick', this.onDblClick, true);\n\t\t\t\tbody.removeEventListener('focusin', this.onDblClick, true);\n\t\t\t}\n\t\t\tWEDLET.refreshEditMode(this.wedlet);\n\t\t\t//recalcul les btns d'insertion atts et child et rÃ©soud un pb de sÃ©lection curieux du contenu textuel dans le bloc dÃ©collapsÃ©\n\t\t\t(wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.hideSel();\n\t\t\t(wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.selectWedlet(this.wedlet as any as IWedletBoxSelection);\n\t\t}\n\t}\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet as IParentWedlet & IWedletSingleElt;\n\t\tconst sh = this.shadowRoot || this.attachShadow(DOMSH.SHADOWDOM_INIT); //On force la crÃ©ation du shdaow, indispensable pour le collaps.\n\t\tWEDLET.installSkins(tpl, sh, wedlet);\n\t\tthis.subEltWedlets = WEDLET.cloneWedletContent(this, tpl, wedlet as IWedletSingleElt, true);\n\t\tconst head = this.shadowRoot.querySelector<HTMLElement>(\".head\");\n\t\tif (head) head.ondblclick = this.onDblClickInShadow;\n\t\tif (this.collapsed) this._doCollapse(true);\n\t\telse if (this.getAttribute(\"collapsMode\") === \"start-switch\") this._doUncollapse(true);\n\t}\n\n\trefreshBindValue(val: IJmlObj | string, children?: IJmlSubSet) {\n\t\tsuper.refreshBindValue(val, children);\n\t\tif (this.getAttribute(\"collapsDefault\") === \"ifVirtual\") {\n\t\t\tthis.collapsed = this.wedlet.isVirtual();\n\t\t}\n\t}\n\n\tonDblClick(this: HTMLElement, ev: MouseEvent) {\n\t\tconst me = DOMSH.findHost<BoxCollaps>(this);\n\t\tme.collapsed = !me.collapsed;\n\t\tev.stopPropagation(); //pour bloquer le collapse de box-collaps en dessous lors d'un dblclick sur la zone body.\n\t\tev.preventDefault();\n\t}\n\n\tonDblClickInShadow(this: HTMLElement, ev: MouseEvent) {\n\t\tconst me = DOMSH.findHost<BoxCollaps>(this);\n\t\tif (DOMSH.findHost<BoxCollaps>(ev.target as Node) === me) {\n\t\t\tme.collapsed = !me.collapsed;\n\t\t\tev.stopPropagation();\n\t\t\tev.preventDefault();\n\t\t}\n\t}\n\n\tonPointerBody(this: HTMLElement, ev: Event) {\n\t\tev.stopImmediatePropagation();\n\t\tev.preventDefault();\n\t\tDOMSH.findHost<BoxCollaps>(this).focus();\n\t}\n\n\tonKeyDown(ev: KeyboardEvent) {\n\t\tif (ev.target !== this) return;\n\t\tif (ev.key === 'ArrowRight' || ev.key === 'Tab') {\n\t\t\tif (!ACTION.isAccelPressed(ev) && this.collapsed) this.collapsed = false;\n\t\t} else if (LANG.in(ev.key, 'Enter', ' ') && !ACTION.isAnyControlPressed(ev)) {\n\t\t\tthis.collapsed = !this.collapsed;\n\t\t\tev.stopImmediatePropagation();\n\t\t\tev.preventDefault();\n\t\t}\n\t}\n}\n\nAgEltBoxSelection(BoxCollaps, {selMode: 'box', actionsLists: ['actions:wed:box-ctn', 'actions:wed:box']});\nwindow.customElements.define(\"box-collaps\", BoxCollaps);\n\n/**\n * Container d'un input enrichi par exemple un libellÃ©.\n * L'input contenu doit implÃ©menter IEltBoxSelection.\n * ConcrÃ¨tement :\n * - Cette enveloppe permet d'assurer la navigation par bloc sans entrer dans les inputs avec caret incompatible avec cette nav.\n * - Focus l'input contenu au double-click sur ce container.\n * - Lorsque ce container a le focus, entre dans l'input Ã  la 1Ã¨re frappe du clavier\n * ou sur la touche Enter.\n */\nclass BoxCtnInput extends BoxCtn {\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.ondblclick = this.onDblClick;\n\t\tthis.onkeydown = this.onKeyDown;\n\t}\n\n\tonDblClick(ev: MouseEvent) {\n\t\tconst input = this.findBoxInput();\n\t\tif (input) {\n\t\t\tif (input.matches(\":focus-within\")) return;\n\t\t\t(input.focusableElement || input).focus();\n\t\t\tif (typeof input.handleEventFromContainer === \"function\") input.handleEventFromContainer(ev);\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\t\t}\n\t}\n\n\tonKeyDown(ev: KeyboardEvent) {\n\t\tif (ACTION.isAnyControlPressed(ev) || ev.composedPath()[0] !== this) return;\n\t\tif (ev.key.length === 1 || LANG.in(ev.key, 'Enter')) {\n\t\t\tconst input = this.findBoxInput();\n\t\t\tif (input) {\n\t\t\t\tBASIS.ensureVisible(input, this.wedlet.wedMgr.wedEditor.scrollContainer, \"nearest\");\n\t\t\t\t(input.focusableElement || input).focus();\n\t\t\t\tif (typeof input.handleEventFromContainer === \"function\") input.handleEventFromContainer(ev);\n\t\t\t\tev.preventDefault();\n\t\t\t\tev.stopPropagation();\n\t\t\t} else {\n\t\t\t\tconst input = this.findStandardInput();\n\t\t\t\tif (input) {\n\t\t\t\t\tBASIS.ensureVisible(input, this.wedlet.wedMgr.wedEditor.scrollContainer, \"nearest\");\n\t\t\t\t\tinput.focus();\n\t\t\t\t\tev.preventDefault();\n\t\t\t\t\tev.stopPropagation();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tfindBoxInput(): IEltBoxSelection {\n\t\treturn DOMSH.findFlatNext(this, this,\n\t\t\t(elt: any): elt is IEltBoxSelection => isEltBoxSelection(elt) && LANG.in(elt.selMode, 'input', 'caret') && getComputedStyle(elt).display !== 'none'\n\t\t);\n\t}\n\n\tfindStandardInput(): HTMLElement {\n\t\treturn DOMSH.findFlatNext(this, this,\n\t\t\t(elt: any): elt is HTMLElement => (elt instanceof HTMLInputElement || elt instanceof HTMLTextAreaElement || elt instanceof HTMLSelectElement) && getComputedStyle(elt).display !== 'none'\n\t\t);\n\t}\n}\n\nwindow.customElements.define(\"box-ctn-input\", BoxCtnInput);\n\n/** box-create = Bouton dans contexte virtuel qui crÃ©Ã©e le noeud correspondant. */\nexport class BoxCreate extends HTMLElement implements IElementWedlet, IEltBoxSelection {\n\twedlet: IWedlet;\n\n\tdefaultContent?: IJmlSet;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet;\n\t\tthis.addEventListener(\"click\", this);\n\t\tthis.addEventListener(\"keydown\", this);\n\t\tthis.tabIndex = 0;\n\t\tthis.setAttribute(\"role\", \"button\");\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tWEDLET.installSkins(tpl, sr, wedlet, this.localName);\n\t\tsr.appendChild(document.createElement('slot'));\n\t\tconst jml = tpl.getAttribute(\"content-jml\");\n\t\tif (jml) this.defaultContent = JSON.parse(jml);\n\t\tWEDLET.cloneWedletContent(this, tpl, this.wedlet as IWedletSingleElt, false);\n\t}\n\n\tsetEditMode(mode: EWedletEditMode) {\n\t\tDOM.setAttr(this, \"edit-mode\", EWedletEditModeLabel[mode]);\n\t}\n\n\trefreshBindValue(val: IJmlNode | string, children?: IJmlSubSet) {\n\t}\n\n\thandleEvent(this: BoxCreate, ev: Event) {\n\t\tif (ev.type === 'click' || (ev instanceof KeyboardEvent && (ev.keyCode == 13 || ev.keyCode == 32))) {\n\t\t\tif (!WEDLET.isWritableWedlet(this.wedlet)) return;\n\t\t\tconst eltWedlet = findElementWedlet(this);\n\t\t\t//hack : rebuild de l'elt mais le boxSelMgr garde le wedlet en lastFocus, => force le clear\n\t\t\t//A suppr si boxSelMgr venait Ã  Ã©couter le blur par exemple...\n\t\t\t(eltWedlet.wedlet.wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.clearSel();\n\t\t\tthis.remove(); // Pour le cas auto IVirtualisableWedlet.switchToRecursiveVirtualButton()\n\t\t\tWEDLET.insertDatasFromDisplay(eltWedlet.wedlet as IVirtualisableWedlet, null, this.defaultContent);\n\t\t\tev.preventDefault();\n\t\t\tev.stopImmediatePropagation();\n\t\t}\n\t}\n}\n\nAgEltBoxSelection(BoxCreate, {selMode: 'box'});\n\nREG.reg.registerSkin('box-create', 1, /* language=CSS */ `\n\t:host {\n\t\tcursor: pointer;\n\t\talign-self: start;\n\t\tjustify-self: start;\n\t\tbackground-color: var(--edit-btn-bgcolor);\n\t\tcolor: var(--edit-btn-color);\n\t\tpadding: .2em .3em;\n\t\tborder-radius: .3em;\n\t\tuser-select: none;\n\t}\n\n\t:host(:hover) {\n\t\tbackground: linear-gradient(rgb(153, 153, 153, 0.1), rgb(153, 153, 153, 0.1)), var(--edit-btn-bgcolor);\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--focus-outline);\n\t}\n\n\t:host([edit-mode^=r]),\n\t:host([edit-mode=h]) {\n\t\tdisplay: none;\n\t}\n`);\n\n/** Stylage pour le bouton injectÃ© automatiquement en cas de contexte virtuel rÃ©cursif. Cf BoxWedlet.switchToRecursiveVirtualButton() */\nREG.reg.registerSkin('box-create/recursive', 1, /* language=CSS */ `\n\t:host {\n\t\tborder-radius: .2em;\n\t\tborder: 1px solid var(--border-color);\n\t\tpadding: 2px;\n\t\tcolor: var(--fade-color);\n\t}\n\n\t:host::after {\n\t\tcontent: '...';\n\t}\n`);\n\nwindow.customElements.define(\"box-create\", BoxCreate);\n\n\n/**\n * box-ctn-inputwrapper : container dont le focus = celui de son input, mais avec gestion des boutons d'insertion avant / aprÃ¨s.\n * Le rÃ©el input est dans le shadow root via IWedletSingleElt.elementHost et l'usage de box-host / txt-root*.\n *\n * Usage pour un input (attention box-host):\n *  <wed:bind label=\"Str\" eltName=\"sp:str\" wedlet=\"Box\">\n *   <box-ctn-input skin=\"box/head-body\" class=\"h\" wed-name=\"sp:str#\">\n *    <div class=\"head\"><box-label/></div>\n *    <box-host class=\"body\">\n *     <wed:children>\n *      <wed:display nodeType=\"text\" wedlet=\"Box\">\n *       <box-input/>\n *      </wed:display>\n *     </wed:children>\n *    </box-host>\n *   </box-ctn-input>\n *  </wed:bind>\n *\n * Usage pour un txt-root-inline (txt-root-inline joue le role du box-host):\n *  <wed:bind label=\"Txt-root-inline\" eltName=\"sp:strTxt\" wedlet=\"Box\">\n *   <box-ctn-input skin=\"box/head-body\" class=\"h\" wed-name=\"sp:strTxt#\">\n *    <div class=\"head\"><box-label/></div>\n *    <div class=\"body\">\n *     <txt-root-inline adjust-virtuals=\"no\">\n *      <wed:children defaultDisplay=\"#\"/>\n *     </txt-root-inline>\n *    </div>\n *   </box-ctn-input>\n *  </wed:bind>\n *\n * TODO Ã  finir cf pointerdown notamment.\n */\n\t// class BoxCtnInputWrapper extends BoxContainer implements IEltBoxSelection {\n\t// \tconstructor() {\n\t// \t\tsuper();\n\t// \t\tthis.addEventListener('pointerdown', this.onPointerDown);\n\t// \t}\n\t//\n\t// \tget selMode(): 'box' | 'input' | 'caret' {return this.focusableElement.selMode}\n\t//\n\t// \tget focusableElement(): HTMLElement & IEltBoxSelection {return this.wedlet.elementHost as HTMLElement & IEltBoxSelection}\n\t//\n\t// \tonPointerDown(ev: UIEvent) {\n\t// \t\t//TODO exclure si on est dans l'input\n\t// \t\tif (ev.target === this && focusIn(this)) ev.preventDefault();\n\t// \t}\n\t// }\n\t//\n\t// AgEltBoxSelection(BoxCtnInputWrapper, {tabIndex: -1});\n\t//\n\t// window.customElements.define(\"box-ctn-inputwrapper\", BoxCtnInputWrapper);\n\nexport interface IBoxInputDiffMaker {\n\tmakeInputForDiff?(annot: IDiffAnnotValue): HTMLElement\n}\n\n/** box-input pour saisie de texte monoline ou multiline. */\nexport class BoxInput extends HTMLElement implements IElementWedlet, IEltBoxSelection, IBoxInputDiffMaker {\n\n\twedlet: IWedlet;\n\n\t/** Dispatch les changements Ã  chaque input, chaque event change ou uniquement au blur du champ. */\n\tdispatchMode: 'input' | 'change' | 'blur';\n\toldXmlChars: string;\n\toldWebChars: string;\n\tfocusableElement: HTMLElement;\n\tbatchDone: boolean;\n\n\tget multiline(): boolean {return this.getAttribute('aria-multiline') === 'true'}\n\n\tget webValue(): string {return (this.focusableElement as HTMLInputElement | HTMLTextAreaElement).value}\n\n\tget selMode(): 'box' | 'input' | 'caret' {return this.isCaretInput() ? 'caret' : 'input'}\n\n\tget trimOnBlur(): boolean {return this.isCaretInput() && this.getAttribute('trim-onblur') !== 'false'}\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet;\n\t\tthis.ondblclick = this.onDblClick;\n\t\tif (!this.dispatchMode) this.dispatchMode = this.getAttribute(\"dispatch-mode\") as any || 'input';\n\t\tthis._createShadow(tpl);\n\t\tthis._initListeners();\n\t\tthis._initReadOnly();\n\t}\n\n\tonDblClick(ev: MouseEvent) {\n\t\tev.preventDefault();\n\t\tev.stopPropagation();\n\t}\n\n\tprotected setWebValue(val: string | undefined /*virtual*/) {\n\t\tconst input = this.focusableElement as HTMLInputElement | HTMLTextAreaElement;\n\t\tif (input.value !== val) {\n\t\t\tthis.oldWebChars = val;\n\t\t\tinput.value = val || \"\";\n\t\t}\n\t}\n\n\tsetCaretAt(offset: number) {\n\t\t(this.focusableElement as HTMLInputElement | HTMLTextAreaElement).setSelectionRange(offset, offset);\n\t}\n\n\tgetXmlText() {return this.oldXmlChars}\n\n\tgetSel(): [number, number] {\n\t\tif (this.isCaretInput()) {\n\t\t\tconst input = this.focusableElement as HTMLInputElement | HTMLTextAreaElement;\n\t\t\treturn [input.selectionStart, input.selectionEnd];\n\t\t} else {\n\t\t\treturn [0, this.oldXmlChars.length];\n\t\t}\n\t}\n\n\tgetSelRange(): IXAddrRange {\n\t\tconst xa = this.wedlet.wedAnchor;\n\t\tif (this.isCaretInput()) {\n\t\t\tconst input = this.focusableElement as HTMLInputElement | HTMLTextAreaElement;\n\t\t\tconst start = input.selectionStart;\n\t\t\tconst end = input.selectionEnd;\n\t\t\tif (start !== end) return {start: XA.freeze(XA.append(xa, start)), end: XA.setAtDepth(xa, -1, end)};\n\t\t\treturn {start: XA.append(xa, start)};\n\t\t} else {\n\t\t\treturn {start: XA.freeze(XA.append(xa, 0)), end: XA.setAtDepth(xa, -1, this.oldXmlChars.length)};\n\t\t}\n\t}\n\n\tsetEditMode(mode: EWedletEditMode) {\n\t\t(this.focusableElement as HTMLInputElement | HTMLTextAreaElement).readOnly = mode !== EWedletEditMode.write;\n\t\tDOM.setAttr(this, \"edit-mode\", EWedletEditModeLabel[mode]);\n\t}\n\n\tisReadOnly() { return (this.focusableElement as HTMLInputElement | HTMLTextAreaElement).readOnly}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.batchDone = true;\n\t\tconst isVirtual = this.wedlet.isVirtual();\n\t\t//if (this.wedlet.isVirtual()) DOM.addClass(this, \"virtual\"); else DOM.removeClass(this, \"virtual\");\n\t\tthis.oldXmlChars = JML.jmlNode2value(val) || \"\";\n\t\tthis.setWebValue(this.xml2webChars(this.oldXmlChars));\n\t\t//Pb si insertion d'un box complet avec des inputs : le setCaretAt provoque le focus de l'input (ex: part dans compoPrim ScBd)\n\t\tif (this.isCaretInput() && !isVirtual) {\n\t\t\t//gestion du caret\n\t\t\tconst wedMgr = this.wedlet.wedMgr;\n\t\t\tconst msg = wedMgr.currentMsg;\n\t\t\tif (msg && isXmlMsg(msg) && wedMgr.docHolderAsync.isMsgFromUs(msg) && XA.isAncOrEquals(this.wedlet.wedAnchor, msg.xa)) {\n\t\t\t\t//modif issu de notre widget (mÃªme xa) provoquant un refresh = saisie ou collage dans un ctx virtuel, on se dÃ©place Ã  la fin.\n\t\t\t\tthis.setCaretAt(this.oldXmlChars.length);\n\t\t\t}\n\t\t}\n\t\tif (isVirtual) removeAnnots(this);\n\t}\n\n\tinsertChars(from: number, chars: string, msg: IXmlMsg) {\n\t\ttry {\n\t\t\tthis.oldXmlChars = LANG.stringInsert(this.oldXmlChars, from, chars);\n\n\t\t\tthis.setWebValue(this.xml2webChars(this.oldXmlChars));\n\t\t\tif (this.batchDone && this.isCaretInput() && this.wedlet.wedMgr.docHolderAsync.isMsgFromUs(msg)) {\n\t\t\t\t//on avait le focus, mais pas un batch issu de notre widget,\n\t\t\t\t// => probablement un msg d'une action de coller, on dÃ©place Ã  la fin du collage.\n\t\t\t\tthis.setCaretAt(from + this.xml2webChars(chars).length);\n\t\t\t}\n\t\t\t//console.log(this.oldXmlChars+\"::::::::::::\"+Array.prototype.map.call(this.oldXmlChars, c => c.charCodeAt(0)));\n\t\t} finally {\n\t\t\tthis.batchDone = true;\n\t\t}\n\t}\n\n\tdeleteChars(from: number, len: number, msg: IXmlMsg) {\n\t\ttry {\n\t\t\tthis.oldXmlChars = LANG.stringDelete(this.oldXmlChars, from, len);\n\t\t\tthis.setWebValue(this.xml2webChars(this.oldXmlChars));\n\t\t\tif (this.batchDone && this.isCaretInput() && this.wedlet.wedMgr.docHolderAsync.isMsgFromUs(msg)) {\n\t\t\t\t//on avait le focus, probablement un msg d'une action de couper, on dÃ©place Ã  la fin du collage.\n\t\t\t\tthis.setCaretAt(from);\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.batchDone = true;\n\t\t}\n\t}\n\n\treplaceChars(chars: string, msg: IXmlMsg) {\n\t\tthis.batchDone = true;\n\t\tthis.oldXmlChars = chars;\n\t\tthis.setWebValue(this.xml2webChars(this.oldXmlChars));\n\t}\n\n\tisEmpty(): boolean {return this.oldXmlChars.length === 0}\n\n\thandleEventFromContainer(ev: KeyboardEvent | MouseEvent) {\n\t\tif (this.isCaretInput() && !this.isReadOnly() && ev instanceof KeyboardEvent && ev.key.length === 1) {\n\t\t\tthis.setWebValue(ev.key);\n\t\t\tthis.dispatchValue();\n\t\t\tthis.setCaretAt(1);\n\t\t}\n\t}\n\n\tonBeforeInput(this: HTMLInputElement | HTMLTextAreaElement, ev: InputEvent) {\n\t\tconst boxInput = DOMSH.findHost<BoxInput>(this);\n\t\tswitch (ev.inputType) {\n\t\tcase 'historyUndo':\n\t\tcase 'historyRedo':\n\t\t\tif (boxInput.dispatchMode === 'blur') {\n\t\t\t\t//on laisse le comportement standard interne Ã  l'input et on bloque l'event pour que Wed ne prenne pas la main.\n\t\t\t\tev.stopPropagation();\n\t\t\t} else {\n\t\t\t\t//on bloque le comportement standard et on laise framework Wed gÃ©rer.\n\t\t\t\tev.preventDefault();\n\t\t\t}\n\t\t\tbreak;\n\t\t\t// case 'insertText':\n\t\t\t// \tif (!ev.isComposing && !boxInput.wedlet.isVirtual()) {\n\t\t\t// \t\t//Traitement de l'insertion de texte via les infos de InputEvent, avant l'algo par diff :\n\t\t\t// \t\t//par diff pb d'imprÃ©cision amenant Ã  un mauvais placement du caret en sortie : \"a|bb\" insert \"b\" -> \"abbb|\"\n\t\t\t// \t\tif (this.selectionStart !== this.selectionEnd) {\n\t\t\t// \t\t\tboxInput.wedlet.wedMgr.docHolder.newBatch().spliceSequence(XA.append(boxInput.wedlet.wedAnchor, this.selectionStart), this.selectionEnd - this.selectionStart, ev.data).doBatch();\n\t\t\t// \t\t} else {\n\t\t\t// \t\t\tboxInput.wedlet.wedMgr.docHolder.newBatch().insertText(XA.append(boxInput.wedlet.wedAnchor, this.selectionStart), ev.data).doBatch();\n\t\t\t// \t\t}\n\t\t\t// \t\tev.preventDefault();\n\t\t\t// \t}\n\t\t\t// \tbreak;\n\t\t\t// case 'deleteContentBackward':\n\t\t\t// case 'deleteContentForward':\n\t\t\t// \tif (!ev.isComposing && !boxInput.wedlet.isVirtual()) {\n\t\t\t// \t\t//Traitement de l'insertion de texte via les infos de InputEvent, avant l'algo par diff pas assez prÃ©cis, cf insertText\n\t\t\t// \t\tif (this.selectionStart !== this.selectionEnd) {\n\t\t\t// \t\t\tboxInput.wedlet.wedMgr.docHolder.newBatch().spliceSequence(XA.append(boxInput.wedlet.wedAnchor, this.selectionStart), this.selectionEnd - this.selectionStart, ev.data).doBatch();\n\t\t\t// \t\t} else {\n\t\t\t// \t\t\tboxInput.wedlet.wedMgr.docHolder.newBatch().dele(XA.append(boxInput.wedlet.wedAnchor, this.selectionStart), ev.data).doBatch();\n\t\t\t// \t\t}\n\t\t\t// \t\tev.preventDefault();\n\t\t\t// \t}\n\t\t\t// \tbreak;\n\t\t\t// default:\n\t\t\t// \tconsole.log(\"onBeforeInput:::\",ev);\n\t\t}\n\t}\n\n\tonInput(this: HTMLElement, ev: InputEvent) {\n\t\tDOMSH.findHost<BoxInput>(this).dispatchDiff();\n\t}\n\n\tonBlur(this: HTMLElement, ev: Event) {\n\t\tconst me = DOMSH.findHost<BoxInput>(this);\n\t\tif (me.isReadOnly()) return;\n\t\tif (me.trimOnBlur) {\n\t\t\tconst val = me.webValue;\n\t\t\tconst trim = val.trim();\n\t\t\tif (val != trim) me.setWebValue(trim);\n\t\t}\n\t\tme.dispatchValue();\n\t}\n\n\tonChange(this: HTMLElement, ev: Event) {\n\t\tDOMSH.findHost<BoxInput>(this).dispatchValue();\n\t}\n\n\tonBlurTrim(this: HTMLElement, ev: Event) {\n\t\tconst me = DOMSH.findHost<BoxInput>(this);\n\t\tif (me.isReadOnly()) return;\n\t\tconst val = me.webValue;\n\t\tconst trim = val.trim();\n\t\tif (val != trim) {\n\t\t\tme.setWebValue(trim);\n\t\t\tme.dispatchValue();\n\t\t}\n\t}\n\n\tdispatchValue() {\n\t\ttry {\n\t\t\tthis.batchDone = false;\n\t\t\tconst wedlet = this.wedlet;\n\t\t\tconst newC = this.web2xmlChars(this.webValue);\n\t\t\tif (wedlet.isVirtual()) {\n\t\t\t\tif (newC) WEDLET.insertDatasFromDisplay(wedlet as IVirtualisableWedlet, null, newC);\n\t\t\t\telse this.batchDone = true;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst oldC = this.oldXmlChars;\n\t\t\tif (oldC === newC) {\n\t\t\t\t//possible notamment si dispatchMode=blur.\n\t\t\t\tthis.batchDone = true;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst thisXa = wedlet.wedAnchor;\n\t\t\tif (!newC && 'onChildEmptied' in wedlet.wedParent) {\n\t\t\t\t//Noeud texte vide.\n\t\t\t\tconst xa = wedlet.wedParent.onChildEmptied((subXa: IXAddr) => XA.isEquals(thisXa, subXa));\n\t\t\t\tif (xa) {\n\t\t\t\t\t//on supprime un contexet ancÃªtre\n\t\t\t\t\twedlet.wedMgr.docHolder.newBatch().deleteSequence(xa, 1).doBatch();\n\t\t\t\t\tWEDLET_SINGLEELT.reselectOnVirtualizing(this);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\twedlet.wedMgr.docHolder.newBatch().setText(XA.append(thisXa), newC).doBatch();\n\t\t} finally {\n\t\t\t//Si la transac est asynchrone ou si elle a Ã©tÃ© killed, on reforce l'ancienne val.\n\t\t\tif (!this.batchDone) this.setWebValue(this.oldWebChars);\n\t\t}\n\t}\n\n\t/** Evalue le delta entre l'ancienne et la nouvelle chaine XML et dispatch la diffÃ©rence. */\n\tdispatchDiff() {\n\t\ttry {\n\t\t\tthis.batchDone = false;\n\t\t\tconst wedlet = this.wedlet;\n\t\t\tconst newC = this.web2xmlChars(this.webValue);\n\t\t\tif (wedlet.isVirtual()) {\n\t\t\t\tif (newC) WEDLET.insertDatasFromDisplay(wedlet as IVirtualisableWedlet, null, newC);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst oldC = this.oldXmlChars;\n\t\t\tif (oldC === newC) {\n\t\t\t\t//possible notamment si dispatchMode=blur.\n\t\t\t\tthis.batchDone = true;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst minLen = Math.min(oldC.length, newC.length);\n\t\t\tlet startDiff = 0;\n\t\t\twhile (startDiff < minLen) {\n\t\t\t\tif (oldC.charCodeAt(startDiff) !== newC.charCodeAt(startDiff)) {\n\t\t\t\t\t//console.log(oldC.charCodeAt(startDiff) + \" !== \" + newC.charCodeAt(startDiff));\n\t\t\t\t\tbreak;\n\t\t\t\t} else startDiff++;\n\t\t\t}\n\t\t\tlet endDiff = 0;\n\t\t\tconst maxEndDiff = minLen - startDiff;\n\t\t\tconst oldLast = oldC.length - 1;\n\t\t\tconst newLast = newC.length - 1;\n\t\t\twhile (endDiff < maxEndDiff) {\n\t\t\t\tif (oldC.charCodeAt(oldLast - endDiff) !== newC.charCodeAt(newLast - endDiff)) {\n\t\t\t\t\t//console.log(oldC.charCodeAt(oldLast - endDiff) + \" !== \" + newC.charCodeAt(newLast - endDiff));\n\t\t\t\t\tbreak;\n\t\t\t\t} else endDiff++;\n\t\t\t}\n\t\t\tconst sumSame = startDiff + endDiff;\n\t\t\tif (oldC.length > sumSame) {\n\t\t\t\tif (newC.length > sumSame) {\n\t\t\t\t\twedlet.wedMgr.docHolder.newBatch().spliceSequence(XA.append(wedlet.wedAnchor, startDiff), oldC.length - sumSame, newC.substr(startDiff, newC.length - sumSame)).doBatch();\n\t\t\t\t} else {\n\t\t\t\t\tconst thisXa = wedlet.wedAnchor;\n\t\t\t\t\tlet xa;\n\t\t\t\t\tif (startDiff === 0 && sumSame === 0 && 'onChildEmptied' in wedlet.wedParent) {\n\t\t\t\t\t\t//Noeud texte vide.\n\t\t\t\t\t\txa = wedlet.wedParent.onChildEmptied((subXa: IXAddr) => XA.isEquals(thisXa, subXa));\n\t\t\t\t\t\tif (xa) {\n\t\t\t\t\t\t\twedlet.wedMgr.docHolder.newBatch().deleteSequence(xa, 1).doBatch();\n\t\t\t\t\t\t\tWEDLET_SINGLEELT.reselectOnVirtualizing(this);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\twedlet.wedMgr.docHolder.newBatch().deleteSequence(XA.append(thisXa, startDiff), oldC.length - sumSame).doBatch();\n\t\t\t\t}\n\t\t\t} else if (newC.length > sumSame) {\n\t\t\t\twedlet.wedMgr.docHolder.newBatch().insertText(XA.append(wedlet.wedAnchor, startDiff), newC.substr(startDiff, newC.length - sumSame)).doBatch();\n\t\t\t}\n\t\t} finally {\n\t\t\t//Si la transac est asynchrone ou si elle a Ã©tÃ© killed, on reforce l'ancienne val.\n\t\t\tif (!this.batchDone) this.setWebValue(this.oldWebChars);\n\t\t}\n\t}\n\n\tonCopy(this: HTMLInputElement | HTMLTextAreaElement, ev: ClipboardEvent) {\n\t\tev.stopImmediatePropagation();\n\t\t//Si dispatch au blur, on laisse le comportement standard interne Ã  l'input.\n\t\tif ((DOMSH.findHost(this) as BoxInput).dispatchMode === 'blur') return;\n\t\tev.preventDefault();\n\t\tconst boxInput = DOMSH.findHost(this) as BoxInput;\n\t\tboxInput.wedlet.wedMgr.writeRangeToClipboard(boxInput.getSelRange(), ev.clipboardData);\n\t}\n\n\tonCut(this: HTMLInputElement | HTMLTextAreaElement, ev: ClipboardEvent) {\n\t\tev.stopImmediatePropagation();\n\t\t//Si dispatch au blur, on laisse le comportement standard interne Ã  l'input.\n\t\tif ((DOMSH.findHost(this) as BoxInput).dispatchMode === 'blur') return;\n\t\tev.preventDefault();\n\t\tconst boxInput = DOMSH.findHost(this) as BoxInput;\n\t\tboxInput.wedlet.wedMgr.writeRangeToClipboard(boxInput.getSelRange(), ev.clipboardData).then(() => {\n\t\t\tconst doc = boxInput.wedlet.wedMgr.docHolder;\n\t\t\tif (doc && this.isConnected) {\n\t\t\t\tif (this.selectionStart === 0 && this.selectionEnd === this.value.length) {\n\t\t\t\t\t//Suppr complet du champ\n\t\t\t\t\tconst thisXa = boxInput.wedlet.wedAnchor;\n\t\t\t\t\tconst xa = boxInput.wedlet.wedParent.onChildEmptied((subXa: IXAddr) => XA.isEquals(thisXa, subXa));\n\t\t\t\t\tif (xa) {\n\t\t\t\t\t\t//Suppr du contexte parent\n\t\t\t\t\t\tboxInput.wedlet.wedMgr.docHolder.newBatch().deleteSequence(xa, 1).doBatch();\n\t\t\t\t\t\tWEDLET_SINGLEELT.reselectOnVirtualizing(boxInput);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdoc.newBatch().deleteRange(boxInput.getSelRange()).doBatch();\n\t\t\t}\n\t\t});\n\t}\n\n\tasync onPaste(this: HTMLInputElement | HTMLTextAreaElement, ev: ClipboardEvent) {\n\t\tev.stopImmediatePropagation();\n\t\tconst boxInput = DOMSH.findHost(this) as BoxInput;\n\t\t//Si pas un champs de saisie standard, on laisse le comportement natif interne Ã  l'input.\n\t\tif (boxInput.dispatchMode !== 'input' || !boxInput.isCaretInput()) return;\n\t\tev.preventDefault();\n\t\tconst wedMgr = boxInput.wedlet.wedMgr;\n\t\tconst txStamp = wedMgr.txStamp;\n\t\tlet impCtx: OSkPasteContext = {sel: boxInput.getSelRange(), virtualPath: WEDLET.buildVirtualPath(boxInput.wedlet), targetHint: \"text\"};\n\t\tconst imports = await wedMgr.tryPaste(impCtx, {}, ev.clipboardData);\n\t\tif (!imports || imports.length === 0) {\n\t\t\tPOPUP.showNotifWarning(\"Aucun contenu du presse-papier n'a pu Ãªtre importÃ©.\", this);\n\t\t} else {\n\t\t\tconst doImport = async (importer: ISkImporter) => {\n\t\t\t\tif (importer.needAsyncBuild && await importer.buildContentToImport(this) === 'stop') return;\n\t\t\t\tif (boxInput.isConnected) {\n\t\t\t\t\t//on est toujours connectÃ©\n\t\t\t\t\tif (txStamp !== wedMgr.txStamp) {\n\t\t\t\t\t\t//des modif concurentes ont eu lieu (pendant l'async de tryPaste() et buildContentToImport())\n\t\t\t\t\t\t// => on reset le contexte pour forcer le recalcul.\n\t\t\t\t\t\timpCtx = {sel: boxInput.getSelRange(), virtualPath: WEDLET.buildVirtualPath(boxInput.wedlet)};\n\t\t\t\t\t}\n\t\t\t\t\tconst batch = wedMgr.docHolder.newBatch();\n\t\t\t\t\timporter.doImport(impCtx, batch);\n\t\t\t\t\tbatch.doBatch();\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (imports.length === 1) {\n\t\t\t\tdoImport(imports[0]);\n\t\t\t} else {\n\t\t\t\tconst actions = imports.map((imp) => new Action().setLabel(imp.getLabel()).setExecute(doImport));\n\t\t\t\tPOPUP.showPopupActions({actions}, boxInput, this);\n\t\t\t}\n\t\t}\n\t}\n\n\tmakeInputForDiff(annot: IDiffAnnotValue): HTMLElement {\n\t\tconst clone = this.focusableElement.cloneNode(true) as HTMLInputElement | HTMLTextAreaElement;\n\t\tclone.readOnly = true;\n\t\tclone.value = annot.otherValue;\n\t\treturn clone;\n\t}\n\n\tonKeyPress(this: HTMLInputElement | HTMLTextAreaElement, ev: KeyboardEvent) {\n\t\tif (ev.key === 'Enter') {\n\t\t\tconst boxInput = DOMSH.findHost<BoxInput>(this);\n\t\t\tif (!boxInput.multiline && boxInput.isCaretInput()) ev.preventDefault(); //mono-line -> pas de saut de ligne.\n\t\t}\n\t}\n\n\tonKeyDown(this: HTMLInputElement | HTMLTextAreaElement, ev: KeyboardEvent) {\n\t\tconst boxInput = DOMSH.findHost(this) as BoxInput;\n\t\tif (boxInput.dispatchMode === 'blur') {\n\t\t\tif (ev.key === 'Escape' || ev.key === 'Tab' || ACTION.isAccelPressed(ev)) {\n\t\t\t\t// On force le dispatch avant le blur car s'il est rÃ©alisÃ© dans le blur, le focus reste dans le champ !\n\t\t\t\t// Les actions avec Ctrl+ sont synchronisÃ© (pour l'enregistrement par exemple)\n\t\t\t\tboxInput.dispatchValue();\n\t\t\t} else {\n\t\t\t\t// On stop la synchro du dispatch de la valeur sur les frappes classiques\n\t\t\t\tev.stopPropagation();\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected _createShadow(tpl: Element) {\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tWEDLET.installSkins(tpl, sr, this.wedlet, this.localName);\n\t\tif (tpl.hasChildNodes()) {\n\t\t\tWEDLET.cloneSimpleContent(sr, tpl);\n\t\t\tthis.focusableElement = this.shadowRoot.querySelector(\"input,textarea,.input\");\n\t\t}\n\t\tif (!this.focusableElement) this.focusableElement = sr.appendChild(document.createElement(this.multiline ? 'textarea' : 'input'));\n\t\tif (this.isCaretInput()) this.setAttribute(\"edit-mode\", \"caret\");\n\t}\n\n\tprotected _initListeners() {\n\t\tswitch (this.dispatchMode) {\n\t\tcase 'input':\n\t\t\tthis.focusableElement.addEventListener(\"input\", this.onInput);\n\t\t\tif (this.trimOnBlur) this.focusableElement.addEventListener(\"blur\", this.onBlurTrim);\n\t\t\tbreak;\n\t\tcase 'change':\n\t\t\tthis.focusableElement.addEventListener(\"change\", this.onChange);\n\t\t\tbreak;\n\t\tcase 'blur':\n\t\t\tthis.focusableElement.addEventListener(\"blur\", this.onBlur);\n\t\t\tbreak;\n\t\t}\n\t\tthis.focusableElement.addEventListener(\"beforeinput\", this.onBeforeInput);\n\t\tthis.focusableElement.addEventListener(\"keydown\", this.onKeyDown);\n\t\tthis.focusableElement.addEventListener(\"keypress\", this.onKeyPress);\n\t\tthis.focusableElement.addEventListener(\"copy\", this.onCopy);\n\t\tthis.focusableElement.addEventListener(\"cut\", this.onCut);\n\t\tthis.focusableElement.addEventListener(\"paste\", this.onPaste);\n\t}\n\n\tprotected _initReadOnly() {\n\t\t(this.focusableElement as HTMLInputElement | HTMLTextAreaElement).readOnly = !WEDLET.isWritableWedlet(this.wedlet);\n\t}\n\n\t/** l'input est-il de textuel, ie avec gestion d'un caret et d'une sÃ©lection. */\n\tprotected isCaretInput(): boolean {\n\t\tswitch ((this.focusableElement as HTMLInputElement | HTMLTextAreaElement).type) {\n\t\tcase 'text':\n\t\tcase 'textarea':\n\t\tcase 'url':\n\t\tcase 'email':\n\t\tcase 'tel':\n\t\tcase 'password':\n\t\tcase 'search':\n\t\t\t//case 'number': non : The input element's type ('number') does not support selection (chrome 70).\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Important : si le nb de caractÃ¨res diffÃ©re entre les chaines XML et web, les\n\t * mÃ©thodes insertChars() et deleteChars() doivent Ãªtre surchargÃ©es.\n\t * AppelÃ© sur des fragments de la chaine.\n\t * Ne doit pas Ãªtre utilisÃ© pour ajouter des prefixe ou suffixe Ã  la chaine complÃ¨te.\n\t */\n\tprotected xml2webChars(chars: string): string {\n\t\treturn this.multiline ? chars : chars.replace(/[\\n\\r]/g, ' ');\n\t}\n\n\t/**\n\t * AppelÃ© sur des fragments de la chaine.\n\t * Ne doit pas Ãªtre utilisÃ© pour ajouter des prefixe ou suffixe Ã  la chaine complÃ¨te.\n\t */\n\tprotected web2xmlChars(chars: string): string {\n\t\treturn chars;\n\t}\n}\n\nAgEltBoxInsertDrawerBox(AgEltBoxSelection(AgEltBoxInputAnnotable(BoxInput), {}));\n\nREG.reg.registerSkin('box-input', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: block;\n\t}\n\n\tinput, textarea {\n\t\t-webkit-appearance: none;\n\t\tdisplay: block;\n\t\tbackground: unset;\n\t\tcolor: unset;\n\t\tmargin: 0;\n\t\twidth: 100%;\n\t\tborder: none;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tfont-size: inherit;\n\t}\n\n\tinput[type=time],\n\tinput[type=month],\n\tinput[type=week] {\n\t\twidth: unset;\n\t}\n\n\tinput {\n\t\ttext-overflow: ellipsis;\n\t}\n\n\tinput[readonly] {\n\t\tcursor: pointer;\n\t}\n\n\ttextarea {\n\t\tresize: vertical;\n\t\tborder: 1px solid var(--border-color);\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-input-focus);\n\t}\n\n\t:host([edit-mode=caret]) :focus-visible {\n\t\toutline: var(--edit-caret-focus);\n\t}\n\n\t::selection {\n\t\tcolor: currentColor;\n\t\tbackground-color: var(--edit-seltext-bgcolor);\n\t}\n`);\n\nwindow.customElements.define(\"box-input\", BoxInput);\n\n/**\n * Input de saisie qui s'adapate en largeur Ã  la longueur du texte (et en hauteur en multiline).\n * UtilisÃ© notamment pour les attributs de l'Ã©diteur XML gÃ©nÃ©rique.\n * Exploite le contentEditable=true et non une balise input pour permettre cet ajustement auto (impossible en <input/>).\n * UtilisÃ© aussi pour les commentaires.\n */\nexport class BoxInputCtEdit extends BoxInput {\n\n\tprotected placeholder?: string;\n\n\t/**\n\t * Corrections de Chromium en fonction du display du container contentEditable.\n\t * Note : mode inline abandonnÃ© en raison de https://bugs.chromium.org/p/chromium/issues/detail?id=1232341\n\t */\n\tget display(): 'inline' | 'block' {return 'block'}\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.placeholder = tpl.getAttribute('placeholder');\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t}\n\n\tprotected _createShadow(tpl: Element) {\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tWEDLET.installSkins(tpl, sr, this.wedlet, this.localName);\n\t\tif (tpl.hasChildNodes()) {\n\t\t\tWEDLET.cloneSimpleContent(sr, tpl);\n\t\t\tthis.focusableElement = this.shadowRoot.querySelector(\"[content-editable]\");\n\t\t}\n\t\tif (!this.focusableElement) this.focusableElement = sr.appendChild(document.createElement(\"span\"));\n\t\tthis.focusableElement.setAttribute(\"part\", \"focusable\");\n\t\tthis.focusableElement.spellcheck = this.spellcheck;\n\t\tthis.focusableElement.style.whiteSpace = \"pre-wrap\"; //obligatoire sinon le navigateur trafique les espaces (32) et les espaces insÃ©ccables (160).\n\t\tif (this.placeholder) this.focusableElement.setAttribute(\"placeholder\", this.placeholder);\n\t}\n\n\tprotected _initReadOnly() {\n\t\tthis.focusableElement.contentEditable = WEDLET.isWritableWedlet(this.wedlet) ? 'true' : 'false';\n\t}\n\n\tsetEditMode(mode: EWedletEditMode) {\n\t\tthis.focusableElement.contentEditable = mode === EWedletEditMode.write ? 'true' : 'false';\n\t\tDOM.setAttr(this, \"edit-mode\", EWedletEditModeLabel[mode]);\n\t}\n\n\tisReadOnly(): boolean {return this.focusableElement.contentEditable !== \"true\"}\n\n\tget webValue(): string {\n\t\tconst t = this.focusableElement.textContent;\n\t\treturn t.substring(0, t.length - 1);\n\t}\n\n\tprotected setWebValue(val: string) {\n\t\tthis.oldWebChars = val;\n\t\tthis.focusableElement.textContent = val + \"\\n\";\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tsuper.refreshBindValue(val);\n\t}\n\n\tmakeInputForDiff(annot: IDiffAnnotValue): HTMLElement {\n\t\tconst clone = this.focusableElement.cloneNode(true) as HTMLSpanElement;\n\t\tclone.spellcheck = false;\n\t\tclone.contentEditable = 'false';\n\t\tclone.removeAttribute(\"tabindex\");\n\t\tDOM.setAttr(this, \"edit-mode\", EWedletEditModeLabel[EWedletEditMode.read]);\n\t\tclone.textContent = annot.otherValue + \"\\n\";\n\t\treturn clone;\n\t}\n\n\tonInput(this: HTMLElement, ev: InputEvent) {\n\t\tconst me = DOMSH.findHost<BoxInputCtEdit>(this);\n\t\tlet fixSel: number;\n\t\tif (me.display === \"block\") {\n\t\t\tconst t = this.textContent;\n\t\t\tif (!this.textContent.endsWith('\\n')) {\n\t\t\t\t//Chrome vire le \\n de fin, on le force\n\t\t\t\tfixSel = t.length;\n\t\t\t\tthis.textContent = t + '\\n';\n\t\t\t}\n\t\t\t//console.log(\"onInput:::\", `'${encodeURIComponent(this.textContent)}'`);\n\t\t} else {\n\t\t\tif (!this.textContent) {\n\t\t\t\t//Ne devrait jamais arriver, car il devrait toujours y avoir un \"\\n\"\n\t\t\t\t//mais arrive sur rÃ©pÃ©tition multiple de touche Back => on restore.\n\t\t\t\tthis.textContent = me.oldWebChars + \"\\n\";\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tme.dispatchDiff();\n\t\tif (fixSel >= 0) me.shadowRoot.getSelection().setPosition(this.lastChild, fixSel);\n\t}\n\n\tonKeyPress(this: HTMLInputElement | HTMLTextAreaElement, ev: KeyboardEvent) {\n\t\tif (ev.key === \"Enter\") {\n\t\t\tconst input = DOMSH.findHost(this) as BoxInput;\n\t\t\tif (input.multiline) {\n\t\t\t\t//En multiline (et donc conteneur en display:block) le comportement de chromium est buggÃ©, ajoute 2 \\n si en fin de saisie sur Enter\n\t\t\t\t//mais l'usage de backspace peut amÃ¨ner Ã  revenir Ã  un seul backspace avec exactement le mÃªme retour graphique\n\t\t\t\t// ce qui devient ingÃ©rable... Manifestement il gÃ¨re des Ã©tats internes non visibles\n\t\t\t\tif (WEDLET.isWritableWedlet(input.wedlet)) {\n\t\t\t\t\tconst sel = input.shadowRoot.getSelection();\n\t\t\t\t\tif (sel.type === 'Caret') {\n\t\t\t\t\t\tinput.wedlet.wedMgr.docHolder.newBatch().insertText(XA.append(input.wedlet.wedAnchor, sel.focusOffset), \"\\n\").doBatch();\n\t\t\t\t\t} else if (sel.type === 'Range') {\n\t\t\t\t\t\tconst rg = sel.getRangeAt(0);\n\t\t\t\t\t\tinput.wedlet.wedMgr.docHolder.newBatch().spliceSequence(XA.append(input.wedlet.wedAnchor, rg.startOffset), rg.endOffset - rg.startOffset, \"\\n\").doBatch();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tev.preventDefault();\n\t\t}\n\t\t//console.log(\"keypress::::\", ev);\n\t}\n\n\tsetCaretAt(offset: number) {\n\t\tconst sel = this.shadowRoot.getSelection();\n\t\tsel.collapse(this.focusableElement.firstChild, offset);\n\t}\n\n\tprotected isCaretInput(): boolean {return true}\n\n\tgetSel(): [number, number] {\n\t\tconst sel = this.shadowRoot.getSelection();\n\t\tif (sel.type === 'Range') {\n\t\t\tconst webRg = sel.getRangeAt(0);\n\t\t\treturn [webRg.startOffset, webRg.endOffset];\n\t\t}\n\t\treturn [sel.focusOffset || 0, sel.focusOffset || 0];\n\t}\n\n\tgetSelRange(): IXAddrRange {\n\t\tconst sel = this.shadowRoot.getSelection();\n\t\tconst xa = this.wedlet.wedAnchor;\n\t\tif (sel.type === 'Range') {\n\t\t\tconst webRg = sel.getRangeAt(0);\n\t\t\treturn {start: XA.freeze(XA.append(xa, webRg.startOffset)), end: XA.setAtDepth(xa, -1, webRg.endOffset)};\n\t\t}\n\t\treturn {start: XA.append(xa, sel.focusOffset || 0)};\n\t}\n}\n\nREG.reg.registerSkin('box-input-ctedit', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t}\n\n\t:host([aria-multiline='true']) {\n\t\tborder: 1px solid var(--border-color);\n\t}\n\n\t:host > span {\n\t\tpadding-inline: .2em;\n\t\tdisplay: block;\n\t}\n\n\t:host(.virtual) > span[contenteditable][placeholder]:not(:focus):before {\n\t\tcontent: attr(placeholder);\n\t\tcolor: var(--fade-color);\n\t\tcursor: text;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-caret-focus);\n\t}\n\n\t::selection {\n\t\tcolor: currentColor;\n\t\tbackground-color: var(--edit-seltext-bgcolor);\n\t}\n`);\n\nwindow.customElements.define(\"box-input-ctedit\", BoxInputCtEdit);\n\n\nexport class BoxInputRaw extends BoxInputCtEdit {\n\n\tonKeyDown(ev: KeyboardEvent) {\n\t\tconst input = DOMSH.findHost(this) as BoxInput;\n\t\tif (ev.key === 'Tab' && !ACTION.isAnyControlPressed(ev)) {\n\t\t\t//Insertion d'une tabulation\n\t\t\tconst sel = input.shadowRoot.getSelection();\n\t\t\tif (sel.type === 'Caret') {\n\t\t\t\tinput.wedlet.wedMgr.docHolder.newBatch().insertText(XA.append(input.wedlet.wedAnchor, sel.focusOffset), \"\\t\").doBatch();\n\t\t\t} else if (sel.type === 'Range') {\n\t\t\t\tconst rg = sel.getRangeAt(0);\n\t\t\t\tinput.wedlet.wedMgr.docHolder.newBatch().spliceSequence(XA.append(input.wedlet.wedAnchor, rg.startOffset), rg.endOffset - rg.startOffset, \"\\t\").doBatch();\n\t\t\t}\n\t\t\tev.preventDefault();\n\t\t} else {\n\t\t\tBoxInput.prototype.onKeyDown.call(this, ev);\n\t\t}\n\t}\n\n\tonPaste(this: HTMLInputElement | HTMLTextAreaElement, ev: ClipboardEvent): Promise<void> {\n\t\tev.stopImmediatePropagation();\n\t\tev.preventDefault();\n\n\t\tconst txt = ev.clipboardData.getData(\"text/plain\");\n\t\tif (!txt) return;\n\n\t\tconst boxInput = DOMSH.findHost<BoxInputRaw>(this);\n\t\tif (boxInput.wedlet.isVirtual()) {\n\t\t\tWEDLET.insertDatasFromDisplay(boxInput.wedlet, null, txt);\n\t\t} else {\n\t\t\tconst xaRange = boxInput.getSelRange();\n\t\t\tconst batch = boxInput.wedlet.wedMgr.docHolder.newBatch(xaRange);\n\t\t\tif (!XA.isCollapsed(xaRange)) batch.deleteRange(xaRange);\n\t\t\tbatch.insertText(xaRange.start, txt);\n\t\t\tbatch.setSelAfterSeq(xaRange.start, txt.length);\n\t\t\tbatch.doBatch();\n\t\t}\n\t\treturn null;\n\t}\n}\n\nREG.reg.registerSkin('box-input-raw', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: block;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t}\n\n\t:host([aria-multiline='true']) {\n\t\tborder: 1px solid var(--border-color);\n\t}\n\n\t:host > div {\n\t\tpadding: .2em;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-caret-focus);\n\t}\n`);\nwindow.customElements.define(\"box-input-raw\", BoxInputRaw);\n\n\n/**\n * Input de date.\n */\nexport class BoxInputDate extends BoxInput {\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.dispatchMode = 'change';\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t\tconst input = this.focusableElement;\n\t\tif (!LANG.in(input.getAttribute(\"type\"), \"date\", \"datetime-local\")) input.setAttribute(\"type\", \"date\");\n\t\tthis.focusableElement.addEventListener(\"blur\", this.onBlur);\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tsuper.refreshBindValue(val);\n\t}\n\n\tprotected setWebValue(val: string) {\n\t\tconst input = this.focusableElement as HTMLInputElement | HTMLTextAreaElement;\n\t\tif (input.value !== val) {\n\t\t\tthis.oldWebChars = val;\n\t\t\tconst re = this.getAttribute(\"type\") === \"date\" ? /^\\d\\d\\d\\d-\\d\\d-\\d\\d$/ : /^\\d\\d\\d\\d-\\d\\d-\\d\\d(T\\d\\d:\\d\\d)?$/;\n\t\t\tif (!re.test(val)) input.value = null; //format invalide Ã©vite un warning, chrome 70.\n\t\t\telse input.value = val;\n\t\t}\n\t}\n\n\tget editPending(): boolean {return this.focusableElement.classList.contains('editError')}\n\n\tonBlur(this: HTMLInputElement | HTMLTextAreaElement, ev: Event) {\n\t\tconst boxInput = (DOMSH.findHost(this) as BoxInputDate);\n\t\tif (boxInput.editPending) {\n\t\t\t//On annule l'Ã©dition en cours\n\t\t\tboxInput.setWebValue(boxInput.xml2webChars(boxInput.oldXmlChars));\n\t\t\tDOM.removeClass(this, 'editError');\n\t\t}\n\t}\n\n\tonChange(this: HTMLInputElement | HTMLTextAreaElement, ev: Event) {\n\t\tconst boxInput = (DOMSH.findHost(this) as BoxInputDate);\n\t\tif (this.validity.valid) {\n\t\t\t//Valide on dispatch\n\t\t\tDOM.removeClass(this, 'editError');\n\t\t\tboxInput.dispatchValue();\n\t\t} else {\n\t\t\tDOM.addClass(this, 'editError');\n\t\t}\n\t}\n\n}\n\nREG.reg.registerSkin('box-input-date', 1, /* language=CSS */ `\n\t:host {\n\t\tjustify-self: start;\n\t\talign-self: start;\n\t}\n\n\tinput {\n\t\t-webkit-appearance: none;\n\t\tdisplay: block;\n\t\tbackground: unset;\n\t\tcolor: unset;\n\t\tmargin: 0;\n\t\tborder: none;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tmax-width: 12em;\n\t\ttext-align: end;\n\t}\n\n\tinput.editError {\n\t\t-webkit-appearance: none;\n\t\tbackground-color: rgba(216, 1, 0, 0.16);\n\t}\n\n\t:host(.virtual) > input::-webkit-datetime-edit-fields-wrapper {\n\t\topacity: .4;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-input-focus);\n\t}\n`);\n\nwindow.customElements.define(\"box-input-date\", BoxInputDate);\n\n/**\n * Input de nombre.\n */\nexport class BoxInputNumber extends BoxInput {\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.dispatchMode = 'input';\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t\tthis.focusableElement.setAttribute(\"type\", \"number\");\n\t\tthis.focusableElement.addEventListener(\"blur\", this.onBlur);\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tsuper.refreshBindValue(val);\n\t}\n\n\t/**\n\t * L'input number ne permet d'accÃ©der Ã  la sÃ©lection, mais rÃ©agit Ã  window.selection.removeAllRange() (chrome70)!!!!\n\t * Donc vu de l'extÃ©rieur on le considÃ¨re comme un input avec caret.\n\t * Sinon : au focus du widget, boxSel appelle window.selection.removeAllRange()\n\t */\n\tget selMode(): 'box' | 'input' | 'caret' {return 'caret'}\n\n\t// setWebValue(val: string) {\n\t// \tlet input = this.focusableElement as HTMLInputElement | HTMLTextAreaElement;\n\t// \tif (input.value !== val) {\n\t// \t\tthis.oldWebChars = val;\n\t// \t\tif (!/\\d\\d\\d\\d-\\d\\d-\\d\\d/.test(val)) input.value = null; //format invalide Ã©vite un warning, chrome 70.\n\t// \t\telse input.value = val;\n\t// \t}\n\t// }\n\n\tget editPending(): boolean {return this.focusableElement.classList.contains('editError')}\n\n\tonBlur(this: HTMLInputElement | HTMLTextAreaElement, ev: Event) {\n\t\tconst boxInput = (DOMSH.findHost(this) as BoxInputNumber);\n\t\tif (boxInput.editPending) {\n\t\t\t//On annule l'Ã©dition en cours\n\t\t\tboxInput.setWebValue(boxInput.xml2webChars(boxInput.oldXmlChars));\n\t\t\tDOM.removeClass(this, 'editError');\n\t\t}\n\t}\n\n\tonInput(this: HTMLInputElement | HTMLTextAreaElement, ev: InputEvent) {\n\t\tconst boxInput = (DOMSH.findHost(this) as BoxInputNumber);\n\t\tif (this.validity.valid) {\n\t\t\t//Valide on dispatch\n\t\t\tDOM.removeClass(this, 'editError');\n\t\t\tboxInput.dispatchValue();\n\t\t} else {\n\t\t\tDOM.addClass(this, 'editError');\n\t\t}\n\t}\n\n\tonCut(this: HTMLInputElement | HTMLTextAreaElement, ev: ClipboardEvent) {\n\t\tev.stopImmediatePropagation();\n\t\t//Comportement natif du widget.\n\t}\n\n\tonCopy(ev: ClipboardEvent) {\n\t\tev.stopImmediatePropagation();\n\t\t//Comportement natif du widget.\n\t}\n}\n\nREG.reg.registerSkin('box-input-number', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tjustify-self: start;\n\t\talign-self: start;\n\t}\n\n\tinput {\n\t\t-webkit-appearance: none;\n\t\tdisplay: block;\n\t\tbackground: unset;\n\t\tcolor: unset;\n\t\tmargin: 0;\n\t\tborder: none;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tmax-width: 12em;\n\t\ttext-align: end;\n\t}\n\n\tinput.editError {\n\t\t-webkit-appearance: none;\n\t\tbackground-color: rgba(216, 1, 0, 0.16);\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-input-focus);\n\t}\n`);\n\nwindow.customElements.define(\"box-input-number\", BoxInputNumber);\n\n/**\n * Input d'un user\n * <box-input-user\n * \t\tplaceholder?=\"User...\"\n * \t\tmultiUsersSeparator?=\",\"//si non dÃ©fini, sÃ©lection d'un seul user\n * \t\tfilterGroups?=\"aaa bbb ccc\"\n * \t\tfilterType?=\"groups|users\"\n * />\n */\n\nexport class BoxInputUser extends BoxInput {\n\n\tfocusableElement: InputUserPanel<any>;\n\n\tmultiUsersSeparator: string | null = null;\n\n\tget webValue(): string {return this.focusableElement.value?.filter(entry => entry != null).join(this.multiUsersSeparator)}\n\n\tget selMode(): 'box' | 'input' | 'caret' {return 'input'}\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.dispatchMode = 'input';\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t\tthis.focusableElement.initialize({\n\t\t\treg: wedlet.wedMgr.reg,\n\t\t\tuserCard: this.multiUsersSeparator ? \"multi\" : \"single\",\n\t\t\trequired: false,\n\t\t\tselectWithConfirm: false,\n\t\t\thideRemButton: !this.multiUsersSeparator,\n\t\t\temptySelectionMsg: tpl.getAttribute(\"placeholder\"),\n\t\t\tskinOver: \"box-input-user/input\",\n\t\t\tusersGridInit: {\n\t\t\t\tusersSrv: wedlet.wedMgr.reg.env.universe.useUsers,\n\t\t\t\tfilterGroups: tpl.getAttribute(\"filterGroups\")?.split(\" \"),\n\t\t\t\tfilterType: tpl.getAttribute(\"filterType\") === 'groups' ? EUserType.group : (tpl.getAttribute(\"filterType\") === 'users' ? EUserType.user : null),\n\t\t\t}\n\t\t} as OInputUserInit<any>);\n\t\tthis.focusableElement.addEventListener(\"blur\", this.onBlur);//TODO\n\t}\n\n\tprotected _createShadow(tpl: Element) {\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tWEDLET.installSkins(tpl, sr, this.wedlet, this.localName);\n\t\tif (!this.focusableElement) this.focusableElement = sr.appendChild(<InputUserPanel/>) as InputUserPanel<any>;\n\t}\n\n\tsetWebValue(val: string) {\n\t\tconst valArray = val ? val.split(this.multiUsersSeparator) : [];\n\t\tif (JSON.stringify(this.focusableElement.value) != JSON.stringify(valArray)) {\n\t\t\tthis.oldWebChars = val;\n\t\t\tthis.focusableElement.value = valArray;\n\t\t}\n\t}\n\n\tonKeyPress(this: HTMLInputElement | HTMLTextAreaElement, ev: KeyboardEvent) {\n\t\tif (ev.key === \"Enter\") {\n\t\t\tconst input = DOMSH.findHost(this) as BoxInputUser;\n\t\t\tif (WEDLET.isWritableWedlet(input.wedlet)) {\n\t\t\t\tinput.focusableElement?.addUser()\n\t\t\t}\n\t\t\tev.preventDefault();\n\t\t}\n\t}\n}\n\nREG.reg.registerSkin('box-input-user/input', 1, /* language=CSS */ `\n\t.inputBox {\n\t\tbackground-color: unset;\n\t\tborder: unset;\n\t}\n`);\n\nREG.reg.registerSkin('box-input-user', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tjustify-self: start;\n\t\talign-self: start;\n\t\tmin-height: min-content;\n\t\tmin-width: 5em;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tpadding-top: 2px;\n\t\tpadding-bottom: 2px;\n\t\tcursor: pointer;\n\t}\n\n\tc-input-users-panel.editError {\n\t\t-webkit-appearance: none;\n\t\tborder: 1px solid var(--error-color);\n\t\tbox-shadow: 0 0 2px var(--error-color);\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-input-focus);\n\t}\n\n\t:host(.virtual) > input {\n\t\topacity: .4;\n\t}\n`);\n\nwindow.customElements.define(\"box-input-user\", BoxInputUser);\n\n\n/**\n * Input de nombre : range\n */\nclass BoxInputRange extends BoxInput {\n\tprotected previewValueElement: HTMLInputElement;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.dispatchMode = 'input';\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t\tthis.focusableElement.setAttribute(\"type\", \"range\");\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tsuper.refreshBindValue(val);\n\t}\n\n\tprotected _createShadow(tpl: Element) {\n\t\tsuper._createShadow(tpl);\n\t\tconst sr = this.shadowRoot;\n\t\tif (tpl.hasChildNodes()) {\n\t\t\tthis.previewValueElement = this.shadowRoot.querySelector(\".preview\");\n\t\t}\n\t\t//if (!this.previewValueElement) this.previewValueElement = sr.appendChild(<div class=\"preview\"/>) as HTMLDivElement;\n\t\tif (!this.previewValueElement) this.previewValueElement = sr.appendChild(this.focusableElement.cloneNode(true)) as HTMLInputElement;\n\t\tthis.previewValueElement.setAttribute(\"type\", \"number\");\n\t\tthis.previewValueElement.disabled = true;\n\t\tDOM.addClass(this.previewValueElement, \"preview\");\n\t}\n\n\tprotected setWebValue(val: string) {\n\t\tsuper.setWebValue(val);\n\t\tif (this.previewValueElement) this.previewValueElement.value = val;\n\t}\n\n}\n\nREG.reg.registerSkin('box-input-range', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tjustify-self: start;\n\t\talign-self: start;\n\t}\n\n\tinput:not(.preview) {\n\t\tdisplay: block;\n\t\tbackground: unset;\n\t\tcolor: unset;\n\t\tmargin: 0;\n\t\tborder: none;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tmax-width: 12em;\n\t\ttext-align: end;\n\t\tcursor: pointer;\n\t}\n\n\t.preview {\n\t\tdisplay: block;\n\t\tbackground: unset;\n\t\tcolor: unset;\n\t\tmargin: 0;\n\t\tborder: none;\n\t\tfont-style: italic;\n\t\tmax-width: 5em;\n\t\ttext-align: end;\n\t\tfont-size: .8em;\n\t}\n\n\tinput.editError {\n\t\t-webkit-appearance: none;\n\t\tbackground-color: rgba(216, 1, 0, 0.16);\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-input-focus);\n\t}\n\n\t:host(.virtual) > * {\n\t\topacity: .4;\n\t}\n\n\t::-webkit-slider-runnable-track {\n\t}\n\n\t::-webkit-slider-thumb {\n\t}\n`);\n\nwindow.customElements.define(\"box-input-range\", BoxInputRange);\n\n/**\n * Input color.\n * \t@defaultcolor\n */\nclass BoxInputColor extends BoxInput {\n\n\tstatic colorPattern: RegExp = /^#([A-F0-9]{6}|[A-F0-9]{3})$/i;\n\n\t/** Couleur affichÃ© en cas de value null ou invalide. */\n\tprotected defaultColor?: string;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.dispatchMode = 'change';\n\t\tthis.defaultColor = tpl.getAttribute('defaultcolor');\n\t\tsuper.configWedletElt(tpl, wedlet);\n\t\tDOM.setAttr(this.focusableElement, \"type\", \"color\");\n\t\tthis.focusableElement.addEventListener(\"blur\", this.onBlur);\n\t\tthis.focusableElement.addEventListener(\"keydown\", this.onKeydown);\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tsuper.refreshBindValue(val);\n\t}\n\n\tprotected setWebValue(val: string) {\n\t\tconst input = this.focusableElement as HTMLInputElement;\n\t\tif (input.value !== val) {\n\t\t\tthis.oldWebChars = val;\n\t\t\tif (!BoxInputColor.colorPattern.test(val)) input.value = this.defaultColor; //format invalide Ã©vite un warning, chrome 70.\n\t\t\telse input.value = val;\n\t\t}\n\t}\n\n\tget editPending(): boolean {return this.focusableElement.classList.contains('editError')}\n\n\tonBlur(this: HTMLInputElement | HTMLTextAreaElement, ev: Event) {\n\t\tconst boxInput = DOMSH.findHost<BoxInputColor>(this);\n\t\tif (boxInput.editPending) {\n\t\t\t//On annule l'Ã©dition en cours\n\t\t\tboxInput.setWebValue(boxInput.xml2webChars(boxInput.oldXmlChars));\n\t\t\tDOM.removeClass(this, 'editError');\n\t\t}\n\t}\n\n\tonChange(this: HTMLInputElement | HTMLTextAreaElement, ev: Event) {\n\t\tconst boxInput = DOMSH.findHost<BoxInputColor>(this);\n\t\tif (this.validity.valid) {\n\t\t\t//Valide on dispatch\n\t\t\tDOM.removeClass(this, 'editError');\n\t\t\tboxInput.dispatchValue();\n\t\t} else {\n\t\t\tDOM.addClass(this, 'editError');\n\t\t}\n\t}\n\n\tasync onKeydown(this: HTMLInputElement, ev: KeyboardEvent) {\n\t\tif (!ACTION.isAccelPressed(ev)) return;\n\t\ttry {\n\t\t\tif (ev.key === \"c\") {\n\t\t\t\tnavigator.clipboard.writeText(this.value);\n\t\t\t} else if (ev.key === \"v\") {\n\t\t\t\tconst color = await navigator.clipboard.readText();\n\t\t\t\tif (BoxInputColor.colorPattern.test(color)) {\n\t\t\t\t\tthis.value = color;\n\t\t\t\t\tDOMSH.findHost<BoxInputColor>(this).dispatchValue();\n\t\t\t\t}\n\t\t\t} else if (ev.key === \"x\") {\n\t\t\t\tnavigator.clipboard.writeText(this.value);\n\t\t\t\tconst boxInput = DOMSH.findHost<BoxInputColor>(this);\n\t\t\t\tthis.value = boxInput.defaultColor;\n\t\t\t\tDOMSH.findHost<BoxInputColor>(this).dispatchValue();\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t//nav pas compat\n\t\t}\n\t}\n\n}\n\nREG.reg.registerSkin('box-input-color', 1, /* language=CSS */ `\n\t:host {\n\t\tjustify-self: start;\n\t\talign-self: start;\n\t}\n\n\tinput {\n\t\t-webkit-appearance: none;\n\t\tdisplay: block;\n\t\tbackground: unset;\n\t\tcolor: unset;\n\t\tmargin: 0;\n\t\tborder: none;\n\t\tmax-width: 12em;\n\t\ttext-align: end;\n\t\tcursor: pointer;\n\t}\n\n\tinput.editError {\n\t\t-webkit-appearance: none;\n\t\tbackground-color: rgba(216, 1, 0, 0.16);\n\t}\n\n\t:host(.virtual) > input::-webkit-color-swatch-wrapper {\n\t\topacity: .4;\n\t}\n\n\t:focus-visible {\n\t\toutline: var(--edit-input-focus);\n\t}\n`);\n\nwindow.customElements.define(\"box-input-color\", BoxInputColor);\n\n/**\n * Api Widget d'enum pour IBoxEnumProvider.\n * Le widget peut Ãªtre mono valuÃ© ou multi-valuÃ©.\n */\nexport interface IBoxEnumEltWedlet extends IElementWedlet {\n\t/** Cette clÃ© est-elle sÃ©lectionnÃ©e. */\n\tisSelected(key: string | null): boolean\n\n\t/** Fournisseur d'enum */\n\tprovider: IBoxEnumProvider;\n}\n\n/**\n * Fournisseur des valeurs d'une Ã©numÃ©ration pour les widgets IBoxEnumEltWedlet.\n */\nexport interface IBoxEnumProvider {\n\n\t/**\n\t * Retourne une liste d'actions reprÃ©sentant l'Ã©numÃ©ration :\n\t * - Chaque entrÃ©e est une action, en principe implÃ©mentant IActionToggle pour matÃ©rialiser la valeur courante.\n\t *   La key de la valeur de l'enum est Action.getId()\n\t *   L'action peut utiliser toutes les propriÃ©tÃ©s : label, icon, enabled pour gÃ©rer l'affichage dans le menu.\n\t * - Une sous-liste est gÃ©rÃ©e par une action implÃ©mentant IActionMenu.\n\t * - Une sous-liste aussi sÃ©lectionnable doit implÃ©menter IActionMenu et IActionToggle, MAIS ATTENTION tous les widgets ne le gÃ¨rent pas.\n\t * - Les sÃ©parateurs sont insÃ©rÃ©s avec une action ActionSeparator.\n\t *\n\t * La liste des actions est affichÃ©e telle quelle, c'est au provider de gÃ©rer l'ordonnancement et le regroupement etc. des actions.\n\t * L'action doit exploiter IBoxEnumEltWedlet.isSelected(key) pour gÃ©rer sa propriÃ©tÃ© toggle.\n\t *\n\t * L'action ne doit rien exÃ©cuter, c'est le widget qui effectue les modifications.\n\t */\n\tgetActions(widget: IBoxEnumEltWedlet, filter?: string): IAction<IBoxEnumEltWedlet>[] | Promise<IAction<IBoxEnumEltWedlet>[]>\n\n\t/**\n\t * Retourne l'action correspondant Ã  `key` pour affichage.\n\t * Retourne null si cette key n'existe pas dans l'Ã©numÃ©ration.\n\t */\n\tgetAction(key: string, widget: IBoxEnumEltWedlet): IAction<IBoxEnumEltWedlet> | null | Promise<IAction<IBoxEnumEltWedlet> | null>\n\n\t/**\n\t * Si le provider implÃ©mente cet eventMgr, le widget devrait s'y abonner pour dÃ©tÃ©cter les changements\n\t * dynamiques des valeurs de l'Ã©numÃ©ration et rafraichir sa valeur courante (existance de la key, label, icon...).\n\t */\n\tonEnumChange?: EventMgr<() => void>;\n\n\t/** Cette clÃ© est-elle active dans ce contexte : Ã©valuÃ© lors de chaque construction de la liste des actions */\n\tisKeyEnabled?(key: string | null): boolean\n\n\t/** Cette clÃ© est-elle visible dans ce contexte : Ã©valuÃ© lors de chaque construction de la liste des actions */\n\tisKeyVisible?(key: string | null): boolean\n}\n\n/**\n * box-input-enum pour un popup d'enumÃ©rations.\n *\n * Attention : ne gÃ¨re pas les \"eList\", ie les dossiers directement sÃ©lectionnables car ergonomiquement\n * trop subtile pour diffÃ©rencier la demande d'affichage des fils et la sÃ©lection du dossier lui-mÃªme.\n * cf box-enum-large pour impl des eList par exemple.\n * <box-input-enum prefix?=\"\" suffix?=\"\">\n *\t\t<e v=\"\"/>\n *\t\t...\n * </box-input-enum>\n */\nexport class BoxInputEnum extends Button implements IBoxEnumEltWedlet, IEltBoxSelection, IBoxInputDiffMaker {\n\n\twedlet: IWedlet;\n\n\t/** Valeur sÃ©lectionnÃ©e en cours. */\n\tprotected key: string;\n\n\t/** PrÃ©fix affichÃ© si valeur non nulle */\n\tprotected valPrefix?: string;\n\n\t/** Suffix affichÃ© si valeur non nulle */\n\tprotected valSuffix?: string;\n\n\t/** Texte affichÃ© en cas de key null et en l'absence d'une action associÃ©e */\n\tprotected placeholder?: string;\n\n\t/** MÃ©moire du listener pour delete. */\n\tprotected _lstn: any;\n\n\tprovider: IBoxEnumProvider;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet;\n\t\tthis.disabled = !WEDLET.isWritableWedlet(wedlet);\n\n\t\tthis.placeholder = tpl.getAttribute('placeholder');\n\n\t\tthis.valPrefix = tpl.getAttribute('prefix');\n\n\t\tthis.valSuffix = tpl.getAttribute('suffix');\n\n\t\tWedEnumProvider.initProviderFromTpl(tpl, this);\n\t\tthis.initialize({reg: wedlet.wedMgr.reg, role: 'menu', skin: tpl.getAttribute('skin') || 'box-input-enum', skinOver: tpl.getAttribute('skinOver')});\n\n\t\tthis.onclick = this.onClick.bind(this);\n\t}\n\n\tasync open() {\n\t\tconst popup = this.popup;\n\t\tif (popup) {\n\t\t\tif (!popup.actions) popup.actions = await this.provider.getActions(this);\n\t\t\tpopup.show(this, this);\n\t\t}\n\t}\n\n\tasync onClick(this: BoxInputEnum, ev: MouseEvent) {\n\t\tconst popup = this.popup;\n\t\tif (popup && !popup.contains(ev.target as Node)) {\n\t\t\tif (!popup.actions) popup.actions = await this.provider.getActions(this);\n\t\t\tpopup.show(this, this);\n\t\t}\n\t}\n\n\tgetKey(): string | null {return this.key}\n\n\tisSelected(key: string | null): boolean {\n\t\treturn this.key == null ? !key : this.key === key;\n\t}\n\n\tsetEditMode(mode: EWedletEditMode) {\n\t\tthis.disabled = mode !== EWedletEditMode.write;\n\t\tDOM.setAttr(this, \"edit-mode\", EWedletEditModeLabel[mode]);\n\t}\n\n\tasync refreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tthis.key = val as string;\n\t\tif (this.wedlet.isVirtual()) removeAnnots(this);\n\t\tconst action = await this.provider.getAction(this.getKey(), this);\n\t\tthis.refreshFreeze(1);\n\t\ttry {\n\t\t\tfunction normaliseValue(this: BoxInputEnum, val: String): String {\n\t\t\t\tif (val && (this.valPrefix || this.valSuffix))\n\t\t\t\t\treturn this.valPrefix + val + this.valSuffix;\n\t\t\t\telse\n\t\t\t\t\treturn val\n\t\t\t}\n\n\t\t\tthis.label = action ? normaliseValue.call(this, action.getLabel(this)) : this.placeholder || normaliseValue.call(this, this.key) || \"\\u00A0\";\n\t\t\tthis.icon = action ? action.getIcon(this) : null;\n\t\t} finally {\n\t\t\tthis.refreshFreeze(-1);\n\t\t\tthis.refresh();\n\t\t}\n\t}\n\n\n\tinsertChars(from: number, chars: string, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(LANG.stringInsert(this.key, from, chars));\n\t}\n\n\tdeleteChars(from: number, len: number, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(LANG.stringDelete(this.key, from, len));\n\t}\n\n\treplaceChars(chars: string, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(chars);\n\t}\n\n\thandleEventFromContainer(ev: KeyboardEvent | MouseEvent) {\n\t\tif (!(ev instanceof KeyboardEvent) || ev.key === ' ' || ev.key === 'Enter') {\n\t\t\tthis.open();\n\t\t\tev.preventDefault();\n\t\t\tev.stopPropagation();\n\t\t}\n\t}\n\n\tisEmpty(): boolean {return !this.key}\n\n\tmakeInputForDiff(annot: IDiffAnnotValue): HTMLElement {\n\t\tconst action = this.provider.getAction(annot.otherValue, this);\n\t\tif (action instanceof Promise) {\n\t\t\tconst div = document.createElement(\"div\");\n\t\t\taction.then((act) => {\n\t\t\t\tconst label = div.appendChild(this._labelElt.cloneNode(true));\n\t\t\t\tlabel.textContent = act ? act.getLabel(this) : annot.otherValue || \"\\u00A0\";\n\t\t\t\tif (this._iconElt && act) {\n\t\t\t\t\tconst iconUrl = act.getIcon(this);\n\t\t\t\t\tif (iconUrl) {\n\t\t\t\t\t\tconst icon = this._iconElt.cloneNode(true);\n\t\t\t\t\t\ticon.style.setProperty('--icon-img', iconUrl.startsWith('--') ? `var(${iconUrl})` : `url(\"${iconUrl}\")`);\n\t\t\t\t\t\tdiv.appendChild(icon);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn div;\n\t\t}\n\t\tconst label = this._labelElt.cloneNode(true);\n\t\tlabel.textContent = action ? action.getLabel(this) : annot.otherValue || \"\\u00A0\";\n\t\tif (this._iconElt && action) {\n\t\t\tconst iconUrl = action.getIcon(this);\n\t\t\tif (iconUrl) {\n\t\t\t\tconst icon = this._iconElt.cloneNode(true);\n\t\t\t\ticon.style.setProperty('--icon-img', iconUrl.startsWith('--') ? `var(${iconUrl})` : `url(\"${iconUrl}\")`);\n\t\t\t\tconst div = document.createElement(\"div\");\n\t\t\t\tdiv.append(label, icon);\n\t\t\t\treturn div;\n\t\t\t}\n\t\t}\n\t\treturn label;\n\t}\n\n\t_createIcon() {\n\t\tlet labelIconBox = (this.shadowRoot || this).querySelector(\".labelIconBox\")\n\t\tif (!labelIconBox)\n\t\t\tlabelIconBox = (this.shadowRoot || this).appendChild(<div class=\"labelIconBox\"/>);\n\t\tthis._iconElt = labelIconBox.insertBefore(<span class='icon'/>, this._labelElt);\n\t}\n\n\t_createLabel() {\n\t\tlet labelIconBox = (this.shadowRoot || this).querySelector(\".labelIconBox\")\n\t\tif (!labelIconBox)\n\t\t\tlabelIconBox = (this.shadowRoot || this).appendChild(<div class=\"labelIconBox\"/>);\n\t\tthis._labelElt = labelIconBox.insertBefore(<span class='label'/>, this._iconElt ? this._iconElt.nextSibling : null);\n\t}\n\n\tget popup(): IPopupable & IActionableList<IBoxEnumEltWedlet> {\n\t\tconst popup = DOM.findFirstChild(this, IS_Popupable) as IPopupable & IActionableList<IBoxEnumEltWedlet> || this._createPopup();\n\t\tif (!('restoreFocus' in popup)) (popup as PopupActions<IBoxEnumEltWedlet>).restoreFocus = this;\n\t\treturn popup;\n\t}\n\n\tprotected _createPopup(): IPopupable & IActionableList<IBoxEnumEltWedlet> {\n\t\tconst popup = new PopupActions<IBoxEnumEltWedlet>().initialize({actionContext: this});\n\t\tpopup.classList.add(\"hideIcons\");\n\t\tpopup.addEventListener(\"c-actioned\", function (this: PopupActions<IBoxEnumEltWedlet>, ev: CustomEvent) {\n\t\t\tconst {actionContext, action} = ev.detail.actionable as IActionable<BoxInputEnum>;\n\t\t\tif (action.isToggle(actionContext) && action.isEnabled(actionContext) && !actionContext.isSelected(action.getId())) {\n\t\t\t\tWEDLET.replaceValue(actionContext.wedlet, actionContext.key, action.getId());\n\t\t\t}\n\t\t});\n\t\treturn this.appendChild(popup);\n\t}\n\n\tconnectedCallback() {\n\t\tsuper.connectedCallback();\n\t\tif (this.provider.onEnumChange) {\n\t\t\tthis._lstn = () => {this.refreshBindValue(this.key)};\n\t\t\tthis.provider.onEnumChange.add(this._lstn);\n\t\t}\n\t}\n\n\tdisconnectedCallback() {\n\t\tif (this.provider.onEnumChange) this.provider.onEnumChange.delete(this._lstn);\n\t}\n}\n\nAgEltBoxSelection(AgEltBoxInputAnnotable(BoxInputEnum), {selMode: 'input'});\n\nREG.reg.registerSkin('box-input-enum', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tmin-height: min-content;\n\t\tmin-width: 5em;\n\t\tborder-bottom: 1px solid var(--border-color);\n\t\tmargin: 0;\n\t\tuser-select: none;\n\t\tcursor: pointer;\n\t\tcolor: var(--color);\n\t\talign-self: start;\n\t\t/*padding-top: 2px;*/\n\t\t/*padding-bottom: 2px;*/\n\t\tpadding-inline-start: 1.2em;\n\t\tbackground: var(--dropdown-url) no-repeat left / 1em;\n\t}\n\n\t:host(.virtual) > div {\n\t\topacity: .4;\n\t}\n\n\t:host([hidden]) {\n\t\tdisplay: none;\n\t}\n\n\t:host([disabled]) {\n\t\tbackground: none;\n\t\tpointer-events: none;\n\t}\n\n\t.labelIconBox {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmin-height: min-content;\n\t\tmin-width: 0;\n\t\tflex: 1;\n\t}\n\n\t.icon {\n\t\theight: var(--icon-size);\n\t\twidth: var(--icon-size);\n\t\tmin-height: var(--icon-size);\n\t\tmin-width: var(--icon-size);\n\t\tbackground: var(--icon-color) var(--icon-img) no-repeat center / contain;\n\t}\n\n\t.icon:not([hidden]) + .label {\n\t\tmargin-inline-start: 0.3em;\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--edit-input-focus);\n\t}\n`);\n\nwindow.customElements.define(\"box-input-enum\", BoxInputEnum);\n\n/** box-input-radio pour une Ã©numÃ©ration avec valeur unique sÃ©lectionnÃ©e (logique \"radiobutton\"\n * \t\tLes n premiers tags fils <style/> sont injectÃ©s dans le shadow\n * */\nexport class BoxInputRadio extends BaseElement implements IBoxEnumEltWedlet, IEltBoxSelection, IBoxInputDiffMaker {\n\n\twedlet: IWedlet;\n\n\tprotected key: string;\n\n\tprovider: IBoxEnumProvider;\n\n\tprotected actionnableList: RadioBtnsActionable<IBoxEnumEltWedlet>;\n\n\t/** MÃ©moire du listener pour delete. */\n\tprotected _lstn: any;\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet;\n\t\tWEDLET.installSkins(tpl, this.attachShadow(DOMSH.SHADOWDOM_INIT), wedlet, this.localName);\n\t\tconst sr = this.shadowRoot;\n\n\t\t// Styles dÃ©clarÃ©s directement\n\t\tif (tpl.childNodes) {\n\t\t\tfor (let node of tpl.childNodes) {\n\t\t\t\tif (node.nodeName === \"style\")\n\t\t\t\t\tsr.appendChild(document.importNode(node, true));\n\t\t\t\telse\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tWedEnumProvider.initProviderFromTpl(tpl, this);\n\n\t\tthis.actionnableList = sr.appendChild(<RadioBtnsActionable class=\"actionsList\" Ã®={{\n\t\t\tactionContext: this,\n\t\t\tuiContext: \"custom\",\n\t\t} as OActionableListInit<IBoxEnumEltWedlet>}/>) as RadioBtnsActionable<IBoxEnumEltWedlet>;\n\t\tthis.actionnableList.addEventListener(\"c-actioned\", function (this: OActionableListInit<IBoxEnumEltWedlet>, ev: CustomEvent) {\n\t\t\tconst {actionContext, action} = ev.detail.actionable as IActionable<BoxInputRadio>;\n\t\t\tif (action.isToggle(actionContext) && action.isEnabled(actionContext) && !actionContext.isSelected(action.getId())) {\n\n\t\t\t\tWEDLET.replaceValue(actionContext.wedlet, actionContext.key, action.getId());\n\t\t\t}\n\t\t});\n\t\tthis.actionnableList.disabled = !WEDLET.isWritableWedlet(wedlet);\n\t\tthis.redrawActionnableList();\n\t}\n\n\tprivate async redrawActionnableList() {\n\t\tif (this._redrawActionnableListPendig) return;\n\t\tthis._redrawActionnableListPendig = true;\n\t\ttry {\n\t\t\tconst actions = this.provider.getActions(this);\n\t\t\tif (actions instanceof Promise) {\n\t\t\t\t//Dessinement async QUE si nÃ©cessaire (Ã©vite un saut graphique)\n\t\t\t\tthis.actionnableList.actions = await actions;\n\t\t\t} else {\n\t\t\t\tthis.actionnableList.actions = actions;\n\t\t\t}\n\t\t} finally {\n\t\t\tthis._redrawActionnableListPendig = false;\n\t\t}\n\t}\n\n\tprivate _redrawActionnableListPendig: boolean;\n\n\tgetKey(): string | null {return this.key}\n\n\tisSelected(key: string | null): boolean {\n\t\treturn this.key == null ? !key : this.key === key;\n\t}\n\n\tsetEditMode(mode: EWedletEditMode) {\n\t\tthis.actionnableList.disabled = mode !== EWedletEditMode.write;\n\t\tDOM.setAttr(this, \"edit-mode\", EWedletEditModeLabel[mode]);\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tthis.key = val as string;\n\t\tif (this.wedlet.isVirtual()) removeAnnots(this);\n\t\tthis.actionnableList.refreshContent();\n\t\t//Affichage valeur erronnÃ©e Ã  revoir : Ã  injecter au refresh dans actionnableList\n\t\t// let action = this.provider.getAction(this.getKey(), this);\n\t\t// if (action instanceof Promise) action = await action;\n\t\t// if (this.key && !action) {\n\t\t// \t// valeur inconnue\n\t\t// \tlet entry = this.actionnableList._createButton(new Action(\"_unknown\").setLabel(this.key).setDescription(\"Valeur inconnue\").setEnabled(false));\n\t\t// \tDOM.addClass(entry, \"unknownValue\");\n\t\t// \tthis.actionnableList.insertBefore(entry, this.actionnableList.firstElementChild);\n\t\t// }\n\t}\n\n\tinsertChars(from: number, chars: string, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(LANG.stringInsert(this.key, from, chars));\n\t}\n\n\tdeleteChars(from: number, len: number, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(LANG.stringDelete(this.key, from, len));\n\t}\n\n\treplaceChars(chars: string, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(chars);\n\t}\n\n\tisEmpty(): boolean {return !this.key}\n\n\tmakeInputForDiff(annot: IDiffAnnotValue): HTMLElement {\n\t\tconst action = this.provider.getAction(annot.otherValue, this);\n\t\tlet boxError = <div class=\"diffBlock\"/>;\n\t\tconst fill = (act: IAction<IBoxEnumEltWedlet> | null) => {\n\t\t\tif (act && act.getIcon(this)) {\n\t\t\t\tconst iconUrl = act.getIcon(this);\n\t\t\t\tconst iconElt = boxError.appendChild(<span class='icon'/>);\n\t\t\t\ticonElt.style.setProperty('--icon-img', iconUrl.startsWith('--') ? `var(${iconUrl})` : `url(\"${iconUrl}\")`);\n\t\t\t}\n\t\t\tboxError.appendChild(<span class='label'>{act ? act.getLabel(this) : annot.otherValue || \"\\u00A0\"}</span>);\n\t\t}\n\t\tif (action instanceof Promise) {\n\t\t\taction.then(fill);\n\t\t} else {\n\t\t\tfill(action);\n\t\t}\n\t\treturn boxError;\n\t}\n\n\tconnectedCallback() {\n\t\tsuper.connectedCallback();\n\t\tif (this.provider.onEnumChange) {\n\t\t\tthis._lstn = this.redrawActionnableList.bind(this);\n\t\t\tthis.provider.onEnumChange.add(this._lstn);\n\t\t}\n\t}\n\n\tdisconnectedCallback() {\n\t\tif (this.provider.onEnumChange) this.provider.onEnumChange.delete(this._lstn);\n\t}\n\n}\n\nAgEltBoxSelection(AgEltBoxInputAnnotable(BoxInputRadio), {selMode: 'input'});\n\nREG.reg.registerSkin('box-input-radio', 1, /* language=CSS */ `\n\t:host {\n\t\tdisplay: flex;\n\t\tmin-height: min-content;\n\t\tmin-width: 5em;\n\t\tuser-select: none;\n\t\tcolor: var(--color);\n\t\tpadding-top: 2px;\n\t\tpadding-bottom: 2px;\n\t\tborder-inline-start: 1px solid var(--border-color);\n\t}\n\n\t.actionsList {\n\t\tdisplay: flex;\n\t\talign-items: start;\n\t\tflex-wrap: wrap;\n\t}\n\n\t.radioBox > .actionsList {\n\t\tmargin-inline-start: 1em;\n\t\tborder-inline-start: 1px solid var(--border-color);\n\t}\n\n\tc-action {\n\t\tmin-width: 4em;\n\t}\n\n\tc-action:not(:last-child),\n\t.radioBox:not(:last-child),\n\thr:not(:last-child) {\n\t\tmargin-inline-end: 1em;\n\t}\n\n\t.radioBox, c-action {\n\t\tmargin-block: .2em 0;\n\t\tmargin-inline: 0;\n\t}\n\n\t.diffBlock {\n\t\tdisplay: inline-flex;\n\t\talign-items: center;\n\t}\n\n\t.icon {\n\t\theight: var(--icon-size);\n\t\twidth: var(--icon-size);\n\t\tmin-height: var(--icon-size);\n\t\tmin-width: var(--icon-size);\n\t\tfilter: var(--filter);\n\t}\n\n\t.icoLabel {\n\t\tdisplay: flex;\n\t\tflex: 0;\n\t\twidth: fit-content;\n\t\tbackground-color: var(--alt1-bgcolor);\n\t\tpadding: 0 2px;\n\t}\n\n\t:host(.virtual) {\n\t\topacity: .4;\n\t}\n\n\t:host([hidden]) {\n\t\tdisplay: none;\n\t}\n\n\t:host([disabled]) {\n\t\tbackground: none;\n\t\tpointer-events: none;\n\t}\n\n\t.labelIconBox {\n\t\tdisplay: flex;\n\t\tflex-direction: row;\n\t\tmin-height: min-content;\n\t\tmin-width: 0;\n\t\tflex: 1;\n\t}\n\n\t.icon {\n\t\theight: var(--icon-size);\n\t\twidth: var(--icon-size);\n\t\tmin-height: var(--icon-size);\n\t\tmin-width: var(--icon-size);\n\t\tbackground: var(--icon-color) var(--icon-img) no-repeat center / contain;\n\t}\n\n\t.icon:not([hidden]) + .label {\n\t\tmargin-inline-start: 0.3em;\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--edit-input-focus);\n\t}\n`);\n\nwindow.customElements.define(\"box-input-radio\", BoxInputRadio);\n\n\n/**\n * ImplÃ©mentation par dÃ©faut construisant l'Ã©numÃ©ration Ã  partir d'un contenu XML issu du wed.\n * schÃ©ma :\n * <{any}>\n *   <e v=\"label\" src=\"icon\"/> <!-- pas de @k pour valeur null. -->\n *   <e k=\"key\" v=\"label\" src=\"icon\" d=\"Description/dÃ©tail\"/>\n *   <sep/>\n *   <subList v=\"label\" src=\"icon\"> <!-- Ce container n'est pas sÃ©lectionnable. -->\n *     <e k=\"key\" v=\"label\"/>\n *     <e k=\"key\"/> <!-- Le label affichÃ© est la key. -->\n *   </subList>\n *   <eList k=\"key\" v=\"label\"> <!-- Ce container est sÃ©lectionnable. Attention tous les widgets ne gÃ¨rent pas ce double statut entrÃ©e ET menu -->\n *     <e k=\"key\" v=\"label\"/>\n *   </eList>\n * </{any}>\n */\nexport class WedEnumProvider implements IBoxEnumProvider {\n\n\t/** Recherche le provider Ã  partir du template du wedlet. */\n\tstatic initProviderFromTpl(tpl: Element, widget: IBoxEnumEltWedlet) {\n\t\twidget.provider = (tpl as any).enumProvider;\n\t\tif (!widget.provider) {\n\t\t\tif (tpl.hasAttribute(\"enumSvc\")) {\n\t\t\t\tconst svcCd = tpl.getAttribute(\"enumSvc\");\n\t\t\t\tconst svc: (tpl: Element, widget: IBoxEnumEltWedlet) => IBoxEnumProvider = widget.wedlet.wedMgr.reg.getSvc(svcCd);\n\t\t\t\tif (svc) {\n\t\t\t\t\twidget.provider = svc(tpl, widget);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.warn(\"Enum svc not found: \" + svcCd);\n\t\t\t\t}\n\t\t\t\t//WedEnumProvider.shareEnumProvForTpl(tpl, widget.provider);  //NON A gÃ©rer en fonction de chaque SVC : si l'enum dÃ©pend du contexte\n\t\t\t\t// de l'Ã©diteur (wsp...), l'enum ne peut pas Ãªtre mutualisÃ©e au niveau du tpl.\n\t\t\t} else {\n\t\t\t\tconst url = tpl.getAttribute(\"src\");\n\t\t\t\tif (url) {\n\t\t\t\t\twidget.provider = new WedEnumProviderFromUrl(widget.wedlet.wedMgr.reg, url, tpl.getAttribute(\"credentials\") as RequestCredentials);\n\t\t\t\t} else {\n\t\t\t\t\twidget.provider = new WedEnumProvider(tpl);\n\t\t\t\t}\n\t\t\t\tWedEnumProvider.shareEnumProvForTpl(tpl, widget.provider); //Mutualisation\n\t\t\t}\n\t\t}\n\t}\n\n\t/** Mutualisation d'un provider pour tous les wedlets de tous les Ã©diteurs qui utilisent le tpl de ce wed. */\n\tstatic shareEnumProvForTpl(tpl: Element, provider: IBoxEnumProvider) {\n\t\t(tpl as any).enumProvider = provider;\n\t}\n\n\n\t/** Recherche l'action d'une key. Cette function est gÃ©nÃ©rique et peut Ãªtre exploitÃ© par tout provider. */\n\tstatic findEntry(entries: IAction<IBoxEnumEltWedlet>[], key: string, ctx: IBoxEnumEltWedlet): IAction<IBoxEnumEltWedlet> {\n\t\tfor (const e of entries) {\n\t\t\tif (e.getId() === key && e.isToggle(ctx)) return e;\n\t\t\tif (e.isMenu(ctx)) {\n\t\t\t\tconst r = WedEnumProvider.findEntry(e.getDatas('menu', ctx), key, ctx);\n\t\t\t\tif (r) return r;\n\t\t\t}\n\t\t}\n\t}\n\n\t/** Construit les actions selon le schÃ©ma xml. */\n\tstatic buildActions(rootEnum: Element, prov?: WedEnumProvider): Action<IBoxEnumEltWedlet>[] {\n\t\tconst result = [] as Action<IBoxEnumEltWedlet>[];\n\t\tfor (let ch = rootEnum.firstElementChild; ch; ch = ch.nextElementSibling) {\n\t\t\tconst k = ch.getAttribute('k');\n\t\t\tswitch (ch.localName) {\n\t\t\tcase 'e' :\n\t\t\t\tconst a = new BoxEnumEntry(k)\n\t\t\t\t\t.setLabel(ch.getAttribute('v') ?? k)\n\t\t\t\t\t.setIcon(ch.getAttribute('src'))\n\t\t\t\t\t.setDescription(ch.getAttribute('d'));\n\t\t\t\tif (k === null) {\n\t\t\t\t\tif (prov) prov._nullAction = a;\n\t\t\t\t} else result.push(a);\n\t\t\t\tbreak;\n\t\t\tcase 'sep' :\n\t\t\t\tresult.push(new ActionSeparator());\n\t\t\t\tbreak;\n\t\t\tcase 'subList':\n\t\t\t\tresult.push(new ActionMenu<IBoxEnumEltWedlet>(k)\n\t\t\t\t\t.setLabel(ch.getAttribute('v') ?? k)\n\t\t\t\t\t.setIcon(ch.getAttribute('src'))\n\t\t\t\t\t.setDescription(ch.getAttribute('d'))\n\t\t\t\t\t.setActions(WedEnumProvider.buildActions(ch)));\n\t\t\t\tbreak;\n\t\t\tcase 'eList':\n\t\t\t\tresult.push(new BoxEnumMenu(k)\n\t\t\t\t\t.setLabel(ch.getAttribute('v') ?? k)\n\t\t\t\t\t.setIcon(ch.getAttribute('src'))\n\t\t\t\t\t.setDescription(ch.getAttribute('d'))\n\t\t\t\t\t.setActions(WedEnumProvider.buildActions(ch)));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tprotected static filterActions(actions: IAction<IBoxEnumEltWedlet>[], regexp: RegExp, widget: IBoxEnumEltWedlet): IAction<IBoxEnumEltWedlet>[] {\n\t\tconst list: IAction<IBoxEnumEltWedlet>[] = [];\n\t\tfor (const a of actions) {\n\t\t\tif (a instanceof ActionSeparator) {\n\t\t\t\tif (!(list[list.length - 2] instanceof ActionSeparator)) list.push(a);\n\t\t\t} else if (a.isMenu(widget)) {\n\t\t\t\t//Recherche dans les fils\n\t\t\t\tconst subList = WedEnumProvider.filterActions(a.getDatas('menu', widget), regexp, widget);\n\t\t\t\tif (subList.length > 0) {\n\t\t\t\t\tif (a.getId() === \"?\") {\n\t\t\t\t\t\tlist.push(new ActionMenu(a.getId())\n\t\t\t\t\t\t\t.setLabel(a.getLabel(widget))\n\t\t\t\t\t\t\t.setDescription(a.getDescription(widget))\n\t\t\t\t\t\t\t.setIcon(a.getIcon(widget))\n\t\t\t\t\t\t\t.setActions(subList));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlist.push(new BoxEnumMenu(a.getId())\n\t\t\t\t\t\t\t.setLabel(a.getLabel(widget))\n\t\t\t\t\t\t\t.setDescription(a.getDescription(widget))\n\t\t\t\t\t\t\t.setIcon(a.getIcon(widget))\n\t\t\t\t\t\t\t.setActions(subList));\n\t\t\t\t\t}\n\t\t\t\t} else if (a.isToggle(widget) && (regexp.test(a.getLabel(widget)) || regexp.test(a.getDescription(widget) || \"\"))) {\n\t\t\t\t\tlist.push(new BoxEnumEntry(a.getId())\n\t\t\t\t\t\t.setLabel(a.getLabel(widget))\n\t\t\t\t\t\t.setDescription(a.getDescription(widget))\n\t\t\t\t\t\t.setIcon(a.getIcon(widget)));\n\t\t\t\t}\n\t\t\t} else if (regexp.test(a.getLabel(widget)) || regexp.test(a.getDescription(widget) || \"\")) {\n\t\t\t\tlist.push(a);\n\t\t\t}\n\t\t}\n\t\t//cleanup SEPARATOR\n\t\tif (list[list.length - 1] instanceof ActionSeparator) list.length--;\n\t\tif (list[0] instanceof ActionSeparator) list.splice(0, 1);\n\t\treturn list;\n\t}\n\n\tprotected _actions: Action<IBoxEnumEltWedlet>[];\n\n\tprotected _nullAction: Action<IBoxEnumEltWedlet>;\n\n\tconstructor(rootEnum: Element) {\n\t\tthis._actions = rootEnum ? WedEnumProvider.buildActions(rootEnum, this) : null;\n\t}\n\n\tgetActions(widget: IBoxEnumEltWedlet, filter?: string): IAction<IBoxEnumEltWedlet>[] | Promise<IAction<IBoxEnumEltWedlet>[]> {\n\t\tif (!this._actions) return null;\n\t\tif (filter) {\n\t\t\tconst regexp = new RegExp(LANG.escape4RegexpFuzzy(filter), 'i');\n\t\t\treturn WedEnumProvider.filterActions(this._actions, regexp, widget);\n\t\t}\n\t\treturn this._actions;\n\t}\n\n\tgetAction(key: string, widget: IBoxEnumEltWedlet): IAction<IBoxEnumEltWedlet> | null | Promise<IAction<IBoxEnumEltWedlet> | null> {\n\t\tif (key === null) return this._nullAction;\n\t\tif (!this._actions) return null;\n\t\treturn WedEnumProvider.findEntry(this._actions, key, widget);\n\t}\n}\n\n/**\n * Fournisseur d'enum issu d'un fichier xml selon la mÃªme dtd que WedEnumProvider.\n */\nexport class WedEnumProviderFromUrl extends WedEnumProvider {\n\tfetching: Promise<void>;\n\n\tconstructor(reg: IReg<IUiEnv & IResolverPointer>, url: string, credentials?: RequestCredentials) {\n\t\tsuper(null);\n\t\tthis._actions = [new BoxEnumEntry(null).setEnabled(false).setLabel(\"Chargement en cours...\")];\n\t\tthis.fetching = this.fetchEnum(reg, url, credentials);\n\t}\n\n\tasync fetchEnum(reg: IReg<IUiEnv & IResolverPointer>, url: string, credentials?: RequestCredentials) {\n\t\ttry {\n\t\t\tconst doc = await new PublicEndPoint(document.baseURI, credentials).fetchDom(url);\n\t\t\tthis.fetching = null;\n\t\t\tthis._actions = doc ? WedEnumProvider.buildActions(doc.documentElement, this) : [];\n\t\t} catch (e) {\n\t\t\tthis.fetching = null;\n\t\t\tthis._actions = [new BoxEnumEntry(null).setEnabled(false).setLabel(\"Chargement des valeurs en Ã©chec\")];\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tasync getActions(widget: IBoxEnumEltWedlet, filter?: string): Promise<IAction<IBoxEnumEltWedlet>[]> {\n\t\tif (this.fetching) await this.fetching;\n\t\treturn super.getActions(widget, filter);\n\t}\n\n\tgetAction(key: string, widget: IBoxEnumEltWedlet): IAction<IBoxEnumEltWedlet> | null | Promise<IAction<IBoxEnumEltWedlet> | null> {\n\t\tif (this.fetching) return this.fetching.then(() => super.getAction(key, widget));\n\t\treturn super.getAction(key, widget);\n\t}\n}\n\n/**\n * Action de base pour reprÃ©senter une entrÃ©e d'une Ã©numÃ©ration.\n * Peut Ãªtre utilisÃ© par tout IBoxEnumProvider\n */\nexport class BoxEnumEntry extends Action<IBoxEnumEltWedlet> implements IActionToggle<IBoxEnumEltWedlet> {\n\n\tisToggle(ctx: IBoxEnumEltWedlet): this is IActionToggle<IBoxEnumEltWedlet> {return true}\n\n\t/** null pour l'Ã©tat 'mixed'. */\n\tgetDatas(api: 'toggle', ctx: IBoxEnumEltWedlet): boolean | null {\n\t\treturn ctx.isSelected(this._id);\n\t}\n\n\tisEnabled(ctx: IBoxEnumEltWedlet): boolean {\n\t\tif (ctx.provider.isKeyEnabled && ctx.provider.isKeyEnabled(this._id) === false) return false;\n\t\treturn super.isEnabled(ctx);\n\t}\n\n\tisVisible(ctx: IBoxEnumEltWedlet): boolean {\n\t\tif (ctx.provider.isKeyEnabled && ctx.provider.isKeyVisible(this._id) === false) return false;\n\t\treturn super.isVisible(ctx);\n\t}\n\n}\n\n/**\n * Action de base pour reprÃ©senter une entrÃ©e d'une Ã©numÃ©ration qui fait aussi de menu, ie container d'autres entrÃ©es.\n * Peut Ãªtre utilisÃ© par tout IBoxEnumProvider\n */\nexport class BoxEnumMenu extends ActionMenu<IBoxEnumEltWedlet> implements IActionToggle<IBoxEnumEltWedlet> {\n\n\tisToggle(ctx: IBoxEnumEltWedlet): this is IActionToggle<IBoxEnumEltWedlet> {return true}\n\n\t/** null pour l'Ã©tat 'mixed'. */\n\tgetDatas(api: 'menu' | 'toggle' | string, ctx: IBoxEnumEltWedlet): any {\n\t\treturn api === 'menu' ? super.getDatas(api, ctx) : ctx.isSelected(this._id);\n\t}\n}\n\nexport class BoxLabel extends HTMLElement implements IElementWedlet {\n\n\twedlet: IWedlet;\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.style.userSelect = \"none\";\n\t}\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet;\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tif (!this.hasChildNodes()) {\n\t\t\t//donnÃ©e statique, construction uniquement au 1er init.\n\t\t\tthis.textContent = this.wedlet.model.nodeLabel || this.wedlet.model.nodeName; //|| this.wedlet.wedNodeName; non widget utilisable que si statique.\n\t\t}\n\t}\n\n\t// drawAnnot(annot: ISkAnnot) {\n\t// \tif (annot.type === SkAnnotTextForbidden.TYPE || annot.type === SkAnnotAttrUnknown.TYPE) {\n\t// \t\tthis.classList.add(\"forbidden\");\n\t// \t\treturn false;\n\t// \t}\n\t// \tinsertError(this, annot);\n\t// \treturn true;\n\t// }\n\t//\n\t// eraseAnnot(annot: ISkAnnot) {\n\t// \tif (annot.type === SkAnnotTextForbidden.TYPE || annot.type === SkAnnotAttrUnknown.TYPE) {\n\t// \t\tthis.classList.remove(\"forbidden\");\n\t// \t\treturn false;\n\t// \t}\n\t// \treturn removeError(this, annot);\n\t// }\n}\n\nwindow.customElements.define(\"box-label\", BoxLabel);\n\n/**\n * Affichage static de la valeur du noeud (en noeud text ou en title sur l'Ã©lement parent)\n * Attributs :\n * transform : Body d'une fonction de transformation de la valeur : (this: BoxValue, val: IJmlNode | null) => string\n * prefix : ajoute un prÃ©fixe\n * suffixe : ajoute un suffixe\n * asTitle : si existe la valeur string rÃ©sultante est placÃ©e en title sur l'Ã©lement parent et non en textContent\n * customize : Body d'une fonction de customisation de l'elt lui-mÃªme, un ancÃªtre... (chgt style, class...) : (this: BoxValue, val: IJmlNode | null) => void\n */\nexport class BoxValue extends HTMLElement implements IElementWedlet, ICharsUpdate {\n\n\twedlet: IWedlet;\n\n\ttransform?: (this: BoxValue, val: IJmlNode | null) => string\n\tcustomize?: (this: BoxValue, val: IJmlNode | null) => void\n\n\tconfigWedletElt(tpl: Element, wedlet: IWedlet) {\n\t\tthis.wedlet = wedlet;\n\t\tif (tpl.hasAttribute(\"transform\")) this.transform = new Function('val', tpl.getAttribute(\"transform\")) as (val: IJmlNode) => string;\n\t\tif (tpl.hasAttribute(\"customize\")) this.customize = new Function('val', tpl.getAttribute(\"customize\")) as (val: IJmlNode) => void;\n\t}\n\n\trefreshBindValue(val: IJmlNode) {\n\t\tthis.classList.toggle(\"virtual\", this.wedlet.isVirtual());\n\t\tlet v = this.transform?.call(this, val) || val?.toString() || \"\";\n\t\tconst prefix = this.getAttribute(\"prefix\");\n\t\tif (prefix) v = prefix + v;\n\t\tconst suffix = this.getAttribute(\"suffix\");\n\t\tif (suffix) v = v + suffix;\n\t\tif (this.hasAttribute(\"asTitle\")) {\n\t\t\t//Affichage de la value en title de l'elt parent.\n\t\t\t(DOMSH.getFlatParentElt(this) as HTMLElement).title = v;\n\t\t} else {\n\t\t\tthis.textContent = v;\n\t\t}\n\t\tthis.customize?.call(this, val);\n\t}\n\n\tinsertChars(from: number, chars: string, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(LANG.stringInsert(this.textContent, from, chars));\n\t}\n\n\tdeleteChars(from: number, len: number, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(LANG.stringDelete(this.textContent, from, len));\n\t}\n\n\treplaceChars(chars: string, msg: IXmlMsg) {\n\t\tthis.refreshBindValue(chars);\n\t}\n}\n\nwindow.customElements.define(\"box-value\", BoxValue);\n\n\nfunction insertDiffMark(parent: IElementWedlet & IWedAnnotPointer, annot: IDiffAnnotMark) {\n\t(document.createElement(\"wed-diff-mark\") as WedDiffMark).initDiffAnnot(parent, annot, parent.wedlet).defaultInject();\n}\n\nfunction insertDiffValue(parent: IElementWedlet & IWedAnnotPointer, annot: IDiffAnnotValue) {\n\t(document.createElement(\"wed-diff-value\") as WedDiffValue).initDiffValue(annot, parent, parent.wedlet.wedMgr, (parent as IBoxInputDiffMaker).makeInputForDiff?.call(parent, annot));\n}\n\nfunction insertDiffForeign(parent: IElementWedlet & IWedAnnotPointer, annot: IDiffAnnotForeign) {\n\tconst wedlet = parent.wedlet as BoxWedlet & IParentWedlet;\n\tconst insBeforeWedlet = typeof annot.offset === \"number\" ? wedlet.findWedletChild(annot.offset, WEDLET.VISITOPTIONS_mainBranch) as any as IWedletSingleElt : undefined;\n\tconst elt = (document.createElement(\"wed-diff-foreign\") as WedDiffForeign).initDiffForeign(annot, annot.createForeignHouse(), wedlet);\n\twedlet.injectForeignChild(annot.foreignNode, elt, insBeforeWedlet);\n}\n\nfunction insertDiffReplace(parent: IElementWedlet & IWedAnnotPointer, annot: IDiffAnnotReplace) {\n\tconst wedlet = parent.wedlet as BoxWedlet & IParentWedlet;\n\tconst margin = (document.createElement(\"wed-diff-mark\") as WedDiffMark);\n\t//Le foreign s'insÃ¨re en frÃ¨re du wedlet courant.\n\tconst foreignParent = wedlet.wedParent as BoxWedlet & IParentWedlet;\n\tconst foreignElt = (document.createElement(\"wed-diff-foreign\") as WedDiffForeign);\n\tforeignElt.initDiffForeign(annot.foreign, annot.foreign.createForeignHouse(), foreignParent, margin);\n\tmargin.initDiffAnnot(parent, annot, wedlet, foreignElt).defaultInject();\n\tif (wedlet.model.nodeType === ENodeType.attribute) {\n\t\t//Cas particulier si le wedlet en cours est un attribut, on place le contenu Ã©tranger aprÃ¨s.\n\t\tforeignParent.injectForeignChild(annot.foreign.foreignNode, foreignElt, null, wedlet);\n\t} else {\n\t\tforeignParent.injectForeignChild(annot.foreign.foreignNode, foreignElt, wedlet);\n\t}\n}\n\nexport function insertAnnot(parent: IElementWedlet & IWedAnnotPointer, annot: ISkAnnot) {\n\tif (annot.level.weight <= EAnnotLevel.error.weight && annot.level.weight > 0) {\n\t\tif (parent.wedAnnotErr) {\n\t\t\tparent.wedAnnotErr.addAnnot(annot, false);\n\t\t} else {\n\t\t\tnew WedAnnotErr().initAnnot(parent, annot, parent.wedlet, false);\n\t\t}\n\t} else if (isSkSearchAnnot(annot)) {\n\t\tif (parent.wedAnnotSearch) parent.wedAnnotSearch.addAnnot(annot);\n\t\telse new WedAnnotSearch().initSearchAnnot(parent, parent.wedlet).addAnnot(annot);\n\t} else if (WEDLET.diffLib?.isDiffAnnot(annot)) {\n\t\tif (parent.wedlet.wedMgr.docHolder?.getDiffSession() === annot.diffSession) {\n\t\t\tif (annot.type === \"diffMark\") {\n\t\t\t\tif (WEDLET.getWedletDepth(parent.wedlet) === annot.start.length) insertDiffMark(parent, annot as IDiffAnnotMark);\n\t\t\t} else if (annot.type === \"diffValue\") {\n\t\t\t\tif (WEDLET.getWedletDepth(parent.wedlet) === annot.start.length) insertDiffValue(parent, annot as IDiffAnnotValue);\n\t\t\t} else if (annot.type === \"diffForeign\") {\n\t\t\t\tif (WEDLET.getWedletDepth(parent.wedlet) + 1 === annot.start.length) insertDiffForeign(parent, annot as IDiffAnnotForeign);\n\t\t\t} else if (annot.type === \"diffReplace\") {\n\t\t\t\tif (WEDLET.getWedletDepth(parent.wedlet) === annot.start.length) insertDiffReplace(parent, annot as IDiffAnnotReplace);\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport function removeAnnot(parent: IElementWedlet & IWedAnnotPointer, annot: ISkAnnot): boolean {\n\tif (annot.level.weight <= EAnnotLevel.error.weight && annot.level.weight > 0) {\n\t\treturn parent.wedAnnotErr ? parent.wedAnnotErr.removeAnnot(annot) : false;\n\t} else if (isSkSearchAnnot(annot)) {\n\t\treturn parent.wedAnnotSearch ? parent.wedAnnotSearch.removeAnnot(annot) : false;\n\t} else if (WEDLET.diffLib?.isDiffAnnot(annot)) {\n\t\tif (annot.type === \"diffMark\" || annot.type === \"diffValue\") {\n\t\t\tif (parent.wedAnnotDiff?.skAnnot === annot) {\n\t\t\t\tparent.wedAnnotDiff.removeDiffWidget();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} else if (annot.type === \"diffForeign\") {\n\t\t\tconst d = DOM.findFirstChild((parent.wedlet as BoxWedlet).elementHost, (n: Node): n is Element => n.localName === \"wed-diff-foreign\" && (n as WedDiffForeign).skAnnot === annot);\n\t\t\tif (d) {\n\t\t\t\td.remove();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t} else if (annot.type === \"diffReplace\") {\n\t\t\tif (parent.wedAnnotDiff?.skAnnot === annot) {\n\t\t\t\tparent.wedAnnotDiff.removeDiffWidget();\n\t\t\t\tDOM.findFirstChild((parent.wedlet.wedParent as BoxWedlet).elementHost, (n: Node): n is Element => n.localName === \"wed-diff-foreign\" && (n as WedDiffForeign).skAnnot === (annot as IDiffAnnotReplace).foreign)?.remove();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t}\n\treturn false;\n}\n\n/**\n * Doit Ãªtre appelÃ© lorsque le wedlet repasse en \"virtuel\" pour Ã©liminer les annotations prÃ©cÃ©dentes.\n * dans IElementWedlet.refreshBindValue().\n */\nexport function removeAnnots(parent: HTMLElement & IWedAnnotPointer) {\n\tif (parent.wedAnnotErr) parent.wedAnnotErr.removeAll();\n}\n\nexport function AgEltBoxInputAnnotable(cls: any): any {\n\tconst proto = cls.prototype as ISkAnnotDrawer;\n\tproto.drawAnnot = drawAnnot;\n\tproto.eraseAnnot = eraseAnnot;\n\treturn cls;\n}\n\nfunction drawAnnot(this: IElementWedlet, annot: ISkAnnot) {\n\tif (annot.type === SkAnnotTextForbidden.TYPE || annot.type === SkAnnotAttrUnknown.TYPE) {\n\t\tthis.classList.add(\"forbidden\");\n\t\treturn false;\n\t}\n\tinsertAnnot(this, annot);\n\treturn true;\n}\n\nfunction eraseAnnot(this: IElementWedlet, annot: ISkAnnot) {\n\tif (annot.type === SkAnnotTextForbidden.TYPE || annot.type === SkAnnotAttrUnknown.TYPE) {\n\t\tthis.classList.remove(\"forbidden\");\n\t\treturn false;\n\t}\n\treturn removeAnnot(this, annot);\n}\n\nexport const boxTagsDefined = Promise.resolve();\n"]}