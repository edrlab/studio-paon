{"version":3,"sources":["/@back@/edit/wed/wedlets/box/boxScExclude.tsx"],"names":["AgEltBoxSelection","EWedletEditMode","WEDLET","REG","DOM","JSX","DOMSH","DocHolder","WedEditorFrag","ACTION","Action","ActionHackCtx","XA","LANG","POPUP","BoxScExclude","HTMLElement","[object Object]","tpl","wedlet","this","setAttribute","title","parentWedMgr","wedMgr","btn","createElement","id","onclick","onClick","sr","attachShadow","SHADOWDOM_INIT","installSkins","localName","append","cmtHouse","then","async","cmtH","cmtDoc","subEditor","initialize","reg","commonBar","wedEditor","wedModel","exclModel","wedParent","model","buildModelForFragment","appendChild","onkeydown","onKeyDownSubEditor","stopBoxSelection","addEventListener","ev","relatedTarget","listeners","emit","scrollContainer","style","minHeight","Math","ceil","scrollHeight","passive","initFromDocHolder","noAnnots","readOnlyCauses","xaRoot","rootModel","overrideReg","addToList","IncludeInSubEditor","includeAction","focusedElt","collapsed","_doCollapse","ondblclick","toggle","onKeyDown","hasAttribute","state","setAttrBool","dispatchEvent","CustomEvent","bubbles","composed","stopImmediatePropagation","preventDefault","st","hidden","mode","val","children","findHost","target","key","isAccelPressed","in","isAnyControlPressed","selMode","actionsLists","registerSkin","window","customElements","define","setLabel","setIcon","setVisible","ctx","boxSelMgr","isSingleSel","setEnabled","resolveEditMode","write","setExecute","box","excludedRoot","getDocument","documentElement","toInsertFrag","house","exportFragment","start","fromNode","firstChild","end","incrAtDepth","lastChild","doc","docHolder","doReinsert","node","sel","addRemExclude","impCtx","cache","importers","schemaDom","tryPasteNodes","isConnected","length","importer","malus","batch","newBatch","doImport","doBatch","toInsertRoot","ownerDocument","createElementNS","SCCORE_NS","SCFRAGMENT_TAG","newRangeAround","wedAnchor","xaParent","datas","originalDom","tryImport","impPos","importPos","insertOffsetMin","_a","replaceChildren","needAdjustForNextAdds","deleteSequence","insertOffsetMax","showNotifInfo","sub","super"],"mappings":"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","sourcesContent":["import {AgEltBoxSelection, IBoxStopSelection, IEltBoxSelection, IWedEditorBoxSel} from \"back/edit/wed/features/boxSel\";\nimport {BoxCommentWedlet} from \"back/edit/wed/wedlets/box/box\";\nimport {EWedletEditMode, IElementWedlet, IWedletActionCtx, WEDLET} from \"back/edit/wed/wedlets/wedlet\";\nimport {IReg, REG} from \"lib/commons/registry\";\nimport {DOM, JSX} from \"lib/commons/xml/dom\";\nimport {DOMSH} from \"lib/commons/xml/domsh\";\nimport {IJmlNode, IJmlSubSet} from \"lib/commons/xml/jml\";\nimport {DocHolder, IDocHolderSync} from \"lib/edit/docHolder\";\nimport {WedEditorFrag} from \"back/edit/wed/wedEditorBox\";\nimport {IWedEditorCommonBar} from \"back/edit/wed/features/commonBar\";\nimport {ACTION, Action, ActionHackCtx, IAction} from \"lib/commons/actions\";\nimport {IXAddrRange, XA} from \"lib/commons/xml/xAddr\";\nimport {LANG} from \"lib/commons/lang\";\nimport {OSkImportDatas, OSkPasteContext, OSkPasteSearchContext} from \"lib/edit/schema/schemaMeta\";\nimport {POPUP} from \"back/commons/widgets/popups\";\n\n/**\n * Exclusion de fragments mis en commentaires.\n */\nexport class BoxScExclude extends HTMLElement implements IElementWedlet, IEltBoxSelection {\n\n\twedlet: BoxCommentWedlet;\n\n\tbtn: HTMLElement;\n\n\tcmtDoc: IDocHolderSync;\n\tsubEditor: WedEditorFrag | null;\n\n\tconfigWedletElt(tpl: Element, wedlet: BoxCommentWedlet) {\n\t\tthis.setAttribute(\"sc-comments\", \"no\");\n\t\tthis.title = \"Contenu exclu\"\n\t\tconst parentWedMgr = wedlet.wedMgr;\n\t\tthis.wedlet = wedlet;\n\t\tthis.btn = <div id=\"btn\" onclick={this.onClick}/>;\n\t\tconst sr = this.attachShadow(DOMSH.SHADOWDOM_INIT);\n\t\tWEDLET.installSkins(tpl, sr, wedlet, this.localName);\n\t\tsr.append(this.btn);\n\t\tif (wedlet.cmtHouse != null) {\n\t\t\twedlet.cmtHouse.then(async (cmtH) => {\n\t\t\t\tthis.cmtDoc = new DocHolder(cmtH);\n\t\t\t\tthis.subEditor = new WedEditorFrag().initialize({reg: parentWedMgr.reg, commonBar: (parentWedMgr.wedEditor as IWedEditorCommonBar).commonBar} as IWedEditorCommonBar);\n\t\t\t\tthis.subEditor.wedModel = parentWedMgr.wedModel;\n\t\t\t\tconst exclModel = wedlet.wedParent.model.buildModelForFragment(wedlet.wedParent);\n\t\t\t\tsr.appendChild(this.subEditor);\n\t\t\t\tthis.subEditor.onkeydown = this.onKeyDownSubEditor;\n\t\t\t\t(this.subEditor as IBoxStopSelection).stopBoxSelection = true;\n\t\t\t\tthis.subEditor.addEventListener(\"focusout\", (ev: FocusEvent) => {\n\t\t\t\t\tif (ev.relatedTarget === this) {\n\t\t\t\t\t\t//On redonne le focus au container: pas d'event focus dans ce cas.\n\t\t\t\t\t\tparentWedMgr.listeners.emit(\"getFocus\", parentWedMgr, this);\n\t\t\t\t\t}\n\t\t\t\t}, true);\n\t\t\t\tthis.subEditor.scrollContainer.addEventListener(\"scroll\", function (ev) {\n\t\t\t\t\t//Cas d'un affichage en absolu qui déborde : BoxPane...\n\t\t\t\t\tthis.style.minHeight = Math.ceil(this.scrollHeight) + 'px';\n\t\t\t\t}, {passive: true});\n\t\t\t\tawait this.subEditor.initFromDocHolder(this.cmtDoc, {\n\t\t\t\t\tnoAnnots: true,\n\t\t\t\t\treadOnlyCauses: [\"excludeCtx\"],\n\t\t\t\t\txaRoot: [0],\n\t\t\t\t\trootModel: exclModel,\n\t\t\t\t\toverrideReg: (reg: IReg<any>) => {\n\t\t\t\t\t\treg.addToList(\"actions:wed:global\", \"include\", 1, new IncludeInSubEditor(includeAction, {\n\t\t\t\t\t\t\twedMgr: parentWedMgr,\n\t\t\t\t\t\t\tfocusedElt: this,\n\t\t\t\t\t\t\twedlet\n\t\t\t\t\t\t}), -999);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tif (this.collapsed) this._doCollapse(true);\n\t\t\t});\n\t\t}\n\t\tthis.ondblclick = this.toggle;\n\t\tthis.onkeydown = this.onKeyDown;\n\t}\n\n\tget collapsed(): boolean {return this.hasAttribute('collapsed')}\n\n\tset collapsed(state: boolean) {\n\t\tif (DOM.setAttrBool(this, 'collapsed', state)) {\n\t\t\tthis._doCollapse(state)\n\t\t\t//Aucune modif du contenu redraw du wed : \"wed-resized\" permet notifier à la boxErrBar par exemple de se recalculer.\n\t\t\tthis.dispatchEvent(new CustomEvent(\"wed-resized\", {bubbles: true, composed: true}));\n\t\t}\n\t}\n\n\ttoggle(ev?: Event) {\n\t\tev?.stopImmediatePropagation();\n\t\tev?.preventDefault();\n\t\tthis.collapsed = !this.collapsed\n\t}\n\n\tprotected _doCollapse(st: boolean) {\n\t\tif (this.subEditor) {\n\t\t\tthis.subEditor.hidden = st;\n\t\t\tif (!st) this.subEditor.scrollContainer.style.minHeight = null; //reset d'une hauteur forcée précédemment (via event scroll)\n\t\t}\n\t}\n\n\tsetEditMode(mode: EWedletEditMode): void {\n\t\t//toujours readonly\n\t}\n\n\trefreshBindValue(val: IJmlNode | string, children?: IJmlSubSet): void {\n\t}\n\n\tonClick(this: HTMLElement) {\n\t\tDOMSH.findHost<BoxScExclude>(this).toggle();\n\t}\n\n\tonKeyDown(ev: KeyboardEvent) {\n\t\tif (ev.target !== this) return;\n\t\tif (ev.key === 'ArrowRight' || ev.key === 'Tab') {\n\t\t\tif (!ACTION.isAccelPressed(ev) && this.collapsed) this.collapsed = false;\n\t\t} else if (LANG.in(ev.key, 'Enter', ' ') && !ACTION.isAnyControlPressed(ev)) {\n\t\t\tthis.toggle(ev);\n\t\t}\n\t}\n\n\tonKeyDownSubEditor(this: WedEditorFrag, ev: KeyboardEvent) {\n\t\tif (ev.key === 'Backspace' || ev.key === 'Delete') {\n\t\t\tev.stopImmediatePropagation();\n\t\t\tev.preventDefault();\n\t\t}\n\t}\n}\n\nAgEltBoxSelection(BoxScExclude, {selMode: \"box\", actionsLists: ['actions:wed:box-scexclude', 'actions:wed:box']});\n\nREG.reg.registerSkin('box-scexclude', 1, /* language=CSS */ `\n\t:host {\n\t\tbackground-color: var(--edit-exclude-bgcolor, #eaeaea);\n\t\tbackground-image: linear-gradient(rgba(0, 0, 0, .03), rgba(0, 0, 0, .03));\n\t\tdisplay: flex;\n\t\tmin-height: 0;\n\t\tmin-width: 0;\n\t\tflex-direction: column;\n\t\tmargin: .5em;\n\t\tbox-shadow: .1em .1em .5em .1em var(--edit-exclude-shadow-color, #b6b6b6);\n\t\tclear: both;\n\t\tpadding: 0 .5em .5em .5em;\n\t}\n\n\t:host(:focus) {\n\t\toutline: var(--edit-box-focus);\n\t}\n\n\t#btn {\n\t\talign-self: start;\n\t\tmin-width: 1em;\n\t\tmin-height: 1em;\n\t\tbackground: no-repeat top / contain url(/@skin@/edit/wed/box/collapse.svg);\n\t\tcursor: pointer;\n\t}\n\n\t:host([collapsed]) {\n\t\tbackground-image: repeating-linear-gradient(-30deg, rgba(0, 0, 0, .03), rgba(0, 0, 0, .03) 5px, rgba(255, 255, 255, .03) 5px, rgba(255, 255, 255, .03) 10px);\n\t}\n\n\t:host([collapsed]) > #btn {\n\t\tbackground: no-repeat top / contain url(/@skin@/edit/wed/box/uncollapse.svg);\n\t}\n\n\tbox-editor-frag {\n\t\tflex: 1;\n\t\topacity: .6;\n\t\tfont-size: .8em;\n\t\tbackground-color: var(--edit-exclude-bgcolor, #eaeaea);\n\t\tbackground-image: repeating-linear-gradient(-30deg, rgba(0, 0, 0, .03), rgba(0, 0, 0, .03) 5px, rgba(255, 255, 255, .03) 5px, rgba(255, 255, 255, .03) 10px);\n\t\tborder: 1px solid var(--edit-exclude-bgcolor, #eaeaea);\n\t}\n`);\n\nwindow.customElements.define(\"box-scexclude\", BoxScExclude);\n\nconst includeAction = new Action<IWedletActionCtx>(\"wedBoxInclude\")\n\t.setLabel(\"Réinclure\")\n\t.setIcon(\"/@skin@/edit/wed/box/includeTag.svg\")\n\t.setVisible((ctx) => {\n\t\treturn (ctx.wedMgr.wedEditor as IWedEditorBoxSel).boxSelMgr.isSingleSel();\n\t})\n\t.setEnabled((ctx) => {\n\t\treturn WEDLET.resolveEditMode(ctx.wedlet.wedParent) === EWedletEditMode.write\n\t})\n\t.setExecute(async (ctx) => {\n\t\t//console.log(\"ctx:::::::\", ctx);\n\t\tconst box = ctx.focusedElt as BoxScExclude;\n\t\tconst excludedRoot = box.cmtDoc.getDocument().documentElement;\n\t\tconst toInsertFrag = box.cmtDoc.house.exportFragment({start: XA.fromNode(excludedRoot.firstChild), end: XA.incrAtDepth(XA.fromNode(excludedRoot.lastChild), -1, 1)});\n\t\tconst doc = ctx.wedMgr.docHolder;\n\n\t\t//On réinsert les éléments 1 par 1 car le schéma pourrait imposer de fragmenter la séquence\n\t\t//si des éléments optionnels intermédiaires étaient absents au moment de l'exclusion.\n\n\n\t\tasync function doReinsert(node: Node, sel: IXAddrRange, addRemExclude?: boolean): Promise<boolean> {\n\t\t\tconst impCtx: OSkPasteContext = {sel};\n\t\t\tconst cache: OSkImportDatas = {};\n\t\t\tconst importers = await doc.house.schemaDom.tryPasteNodes(impCtx, node, cache);\n\t\t\tif (!box.isConnected) return; //racecond\n\t\t\tif (importers?.length > 0) {\n\t\t\t\t//TODO user select importer si plusieurs ?\n\t\t\t\tconst importer = importers[0];\n\t\t\t\tif (importer.malus === 0) {\n\t\t\t\t\tconst batch = doc.newBatch();\n\t\t\t\t\t//console.log(\"importer:::\", importer, sel);\n\t\t\t\t\timporter.doImport(impCtx, batch);\n\t\t\t\t\t//if (addRemExclude) batch.needAdjustForNextAdds().deleteSequence(box.wedlet.wedAnchor, 1);\n\t\t\t\t\tbatch.doBatch();\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\n\t\t//Tentative de remplacement simple en une seule étape\n\t\tconst toInsertRoot = toInsertFrag.ownerDocument.createElementNS(DOM.SCCORE_NS, DOM.SCFRAGMENT_TAG);\n\t\ttoInsertRoot.appendChild(toInsertFrag);\n\t\tif (!await doReinsert(toInsertRoot, XA.newRangeAround(ctx.wedlet.wedAnchor))) {\n\t\t\t//Echec au remplacement simple du contenu exclu\n\t\t\t//Recherche d'un point d'insertion\n\t\t\tif (!box.isConnected) return; //racecond\n\t\t\tconst impCtx: OSkPasteSearchContext = {xaParent: ctx.wedlet.wedParent.wedAnchor};\n\t\t\tconst datas: OSkImportDatas = {originalDom: toInsertRoot}\n\t\t\tconst importers = await doc.house.schemaDom.tryImport(impCtx, datas);\n\t\t\tif (!box.isConnected) return; //racecond\n\t\t\tif (importers?.length > 0) {\n\t\t\t\tconst importer = importers[0];\n\t\t\t\tconst impPos = importer.importPos;\n\t\t\t\tif (impPos.insertOffsetMin == null && impPos.replaceChildren?.length === 1) {\n\t\t\t\t\t//On a trouvé un point précis de remplacement\n\t\t\t\t\tconst batch = doc.newBatch();\n\t\t\t\t\timporter.doImport({sel: XA.newRangeAround(XA.append(box.wedlet.wedParent.wedAnchor, impPos.replaceChildren[0] as number))}, batch);\n\t\t\t\t\tbatch.needAdjustForNextAdds().deleteSequence(box.wedlet.wedAnchor, 1);\n\t\t\t\t\tbatch.doBatch();\n\t\t\t\t} else if (!impPos.replaceChildren && impPos.insertOffsetMin === impPos.insertOffsetMax) {\n\t\t\t\t\t//On a trouvé un point précis d'insertion\n\t\t\t\t\tconst batch = doc.newBatch();\n\t\t\t\t\timporter.doImport({sel: {start: XA.append(box.wedlet.wedParent.wedAnchor, impPos.insertOffsetMin)}}, batch);\n\t\t\t\t\tbatch.needAdjustForNextAdds().deleteSequence(box.wedlet.wedAnchor, 1);\n\t\t\t\t\tbatch.doBatch();\n\t\t\t\t} else {\n\t\t\t\t\tPOPUP.showNotifInfo(\"Ce contenu exclu n'a pas pu être réintroduit simplement. Réintégrez-le par des actions de copier et coller.\", box)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n\n/** Action de réinclusion dans le subEditor */\nclass IncludeInSubEditor extends ActionHackCtx<IWedletActionCtx, IWedletActionCtx> {\n\tconstructor(sub: IAction<IWedletActionCtx>, public ctx: IWedletActionCtx) {super(sub)}\n\n\tgetGroup(ctx: IWedletActionCtx): string {return \"UP\"}\n\n\twrapCtx(ctx: IWedletActionCtx): IWedletActionCtx {return this.ctx}\n}\n\nREG.reg.addToList(\"actions:wed:box-scexclude\", \"include\", 1, includeAction, 10);\n\nREG.reg.addToList(\"actions:wed:box-scexclude\", \"exclude\", 1, null); //élimine l'action d'exclusion issue de la liste \"actions:wed:global\""]}